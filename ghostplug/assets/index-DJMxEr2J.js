var _s=Object.defineProperty;var Us=(l,e,t)=>e in l?_s(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var U=(l,e,t)=>Us(l,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();class Ns{constructor({ConfigurationService:e,LoggerFactory:t,AppFactory:n,EnvironmentName:s}){this.ConfigurationService=e,this.LoggerFactory=t,this.AppFactory=n,this.EnvironmentName=s}async StartAsync(){try{const e=await this.ConfigurationService.LoadAsync(this.EnvironmentName),t=this.LoggerFactory.CreateFromConfiguration(e);t.LogFlowStart("Bootstrap.Start",{EnvironmentName:this.EnvironmentName}),await this.AppFactory({Configuration:e,Logger:t}).StartAsync(),t.LogFlowEnd("Bootstrap.Start",{Success:!0})}catch(e){console.error("Bootstrap failed",e)}}}class Bs{Merge(e,t){if(e==null)return this.CloneValue(t);if(t==null)return this.CloneValue(e);if(Array.isArray(e)||Array.isArray(t))return this.CloneValue(t);if(typeof e=="object"&&typeof t=="object"){const n={...e};return Object.keys(t).forEach(s=>{n[s]=this.Merge(e[s],t[s])}),n}return this.CloneValue(t)}CloneValue(e){return e==null?e:JSON.parse(JSON.stringify(e))}}class Fs{constructor({Fetch:e,Logger:t,Paths:n}){this.Fetch=e,this.Logger=t,this.Paths=n,this.Merger=new Bs}async LoadAsync(e){this.Logger.LogFlowStart("Configuration.Load",{EnvironmentName:e});const t=await this.FetchJsonAsync(this.Paths.GetDefaultPath(),!1),n=await this.FetchJsonAsync(this.Paths.GetEnvironmentPath(e),!0),s=this.Merger.Merge(t,n),i={...s,Attachments:s.Attachments??{}};return this.Logger.LogFlowEnd("Configuration.Load",{EnvironmentName:e,HasOverrides:!!n}),i}async FetchJsonAsync(e,t){const n=await this.Fetch(e);if(!n.ok){if(t)return this.Logger.LogWarning("Configuration.Load.Missing",{Path:e}),null;throw this.Logger.LogError("Configuration.Load.Failed",{Path:e,Status:n.status}),new Error(`Configuration fetch failed for ${e}`)}return await n.json()}}class zs{constructor({RootPath:e="config",DefaultFileName:t="default.json",EnvironmentPrefix:n="env."}={}){this.RootPath=e,this.DefaultFileName=t,this.EnvironmentPrefix=n}GetDefaultPath(){return`${this.RootPath}/${this.DefaultFileName}`}GetEnvironmentPath(e){return`${this.RootPath}/${this.EnvironmentPrefix}${e}.json`}}const Xe=Object.freeze({Trace:0,Debug:1,Information:2,Warning:3,Error:4,Critical:5}),W=Object.freeze({Trace:"Trace",Debug:"Debug",Information:"Information",Warning:"Warning",Error:"Error",Critical:"Critical"}),J=Object.freeze({App:"App",Logging:"Logging",Storage:"Storage",Providers:"Providers",Chat:"Chat",Ui:"Ui",Pwa:"Pwa",Attachments:"Attachments"}),Dn=Object.freeze({Name:"Name",Version:"Version",Environment:"Environment"}),et=Object.freeze({MinimumLevel:"MinimumLevel",EnableDebug:"EnableDebug",MaxPayloadLength:"MaxPayloadLength",ObjectLogging:"ObjectLogging",TextLogging:"TextLogging"}),$n=Object.freeze({Requests:"Requests",ProviderOverrides:"ProviderOverrides"}),Ve=Object.freeze({TimeoutMs:"TimeoutMs",MaxRetries:"MaxRetries",BackoffMs:"BackoffMs",MaxOutputTokens:"MaxOutputTokens"}),We=Object.freeze({SupportsAttachments:"SupportsAttachments",MaxAttachments:"MaxAttachments",MaxFileSizeMb:"MaxFileSizeMb",AllowedMimeTypes:"AllowedMimeTypes",RetentionDays:"RetentionDays"}),Hs=Object.freeze({Trace:"trace",Debug:"debug",Information:"info",Warning:"warn",Error:"error",Critical:"error"});class Gs{constructor(e){const t=e[J.Logging]??{};this.MinimumLevelName=t[et.MinimumLevel]??W.Information,this.EnableDebug=t[et.EnableDebug]??!1,this.MaxPayloadLength=t[et.MaxPayloadLength]??4096,this.TextLogging=t[et.TextLogging]??"off",this.ObjectLogging=t[et.ObjectLogging]??!1,this.MinimumLevel=Xe[this.MinimumLevelName]??Xe.Information}LogFlowStart(e,t){this.Log(W.Information,"Flow.Start",{FlowName:e,Parameters:t}),this.IsEnabled(W.Trace,Xe.Trace)&&this.Log(W.Trace,"Flow.Start",{FlowName:e,Parameters:t})}LogFlowEnd(e,t){this.Log(W.Information,"Flow.End",{FlowName:e,Result:t}),this.IsEnabled(W.Trace,Xe.Trace)&&this.Log(W.Trace,"Flow.End",{FlowName:e,Result:t})}LogBranch(e,t,n){this.Log(W.Debug,"Flow.Branch",{FlowName:e,Branch:t,Details:n})}LogTrace(e,t){this.Log(W.Trace,e,t)}LogDebug(e,t){this.Log(W.Debug,e,t)}LogInformation(e,t){this.Log(W.Information,e,t)}LogWarning(e,t){this.Log(W.Warning,e,t)}LogError(e,t){this.Log(W.Error,e,t)}LogCritical(e,t){this.Log(W.Critical,e,t)}LogAttachmentEvent(e,t){this.Log(W.Information,`Attachments.${e}`,t)}Log(e,t,n){const s=Xe[e];if(!this.IsEnabled(e,s))return;const i=this.EnrichPayload(n,e),r={Timestamp:new Date().toISOString(),Level:e,Message:t,Payload:this.TruncatePayload(i)},o=Hs[e]??"log";this.ObjectLogging!==!1&&console[o](r);const c=this.NormalizeTextLoggingMode(this.TextLogging);c!=="off"&&this.EmitTextEntry(o,{...r,Payload:i},c)}IsEnabled(e,t){return!this.EnableDebug&&(e===W.Debug||e===W.Trace)?!1:t>=this.MinimumLevel}TruncatePayload(e){if(e==null)return e;const t=this.SafeStringify(e,{Pretty:!1});return t===null?{Truncated:!0,Value:"[Unserializable payload]"}:t.length<=this.MaxPayloadLength?e:{Truncated:!0,Value:`${t.slice(0,this.MaxPayloadLength)}...`}}FormatTextEntry(e,t){const n=`${e.Timestamp} [${e.Level}] ${e.Message}`;if(t==="simple"){const s=this.FormatPayloadSummary(e.Payload);return s?`${n} ${s}`:n}if(t==="comprehensive"){const s=this.SafeStringify(e.Payload,{Pretty:!0});return s?`${n}
${this.TruncateText(s)}`:n}return n}EmitTextEntry(e,t,n){if(n!=="comprehensive"){console[e](this.FormatTextEntry(t,n));return}const s=`${t.Timestamp} [${t.Level}] ${t.Message}`;console[e](s);const i=this.SafeStringify(t.Payload,{Pretty:!0});i&&console[e](this.TruncateText(i))}EnrichPayload(e,t){if(t!==W.Trace&&t!==W.Debug)return e;const n=this.BuildStack();return!e||typeof e!="object"?{Value:e,Stack:n}:{...e,Stack:n}}BuildStack(){return(new Error().stack??"").split(`
`).slice(2).join(`
`).trim()}NormalizeTextLoggingMode(e){const t=(e??"off").toString().toLowerCase();return t==="off"||t==="simple"||t==="comprehensive"?t:t==="full"||t==="all"||t==="verbose"?"comprehensive":"simple"}FormatPayloadSummary(e){if(!e||typeof e!="object")return e==null?"":`payload=${this.FormatValue(e)}`;const t=this.FormatFlowSummary(e);if(t)return t;if(e.Truncated&&e.Value)return`payload=${this.FormatValue(e.Value)}`;if(Array.isArray(e))return`payload=Array(${e.length})`;const n=Object.entries(e);if(n.length===0)return"";const s=n.slice(0,8).map(([i,r])=>`${i}=${this.FormatValue(r)}`);return n.length>8&&s.push(`+${n.length-8} more`),s.join(" ")}FormatFlowSummary(e){const t=e.FlowName??null;if(!t)return"";const n=[`FlowName=${t}`],s=e.Parameters??e.Result??null;if(s&&typeof s=="object"){const i=s.ProviderId??s.Provider??null,r=s.ModelId??s.Model??null,o=s.Stream??null,a=s.Length??null,c=s.AttachmentCount??null;i&&n.push(`ProviderId=${i}`),r&&n.push(`ModelId=${r}`),typeof o=="boolean"&&n.push(`Stream=${o}`),typeof c=="number"&&n.push(`AttachmentCount=${c}`),typeof a=="number"&&n.push(`Length=${a}`)}return n.join(" ")}FormatValue(e){if(e==null)return"null";const t=typeof e;return t==="string"?e:t==="number"||t==="boolean"?`${e}`:Array.isArray(e)?`Array(${e.length})`:t==="object"?"{...}":String(e)}SafeStringify(e,{Pretty:t}={}){const n=new Set;try{return JSON.stringify(e,(s,i)=>{if(typeof i=="object"&&i!==null){if(n.has(i))return"[Circular]";n.add(i)}return typeof i=="function"?"[Function]":typeof i=="bigint"?`${i}n`:i},t?2:0)}catch{return null}}TruncateText(e){return!e||e.length<=this.MaxPayloadLength?e:`${e.slice(0,this.MaxPayloadLength)}...`}}class Ks{FormatEntry(e,t,n){const s=`${new Date().toISOString()} [${e}] ${t}`,i=this.FormatPayloadSummary(n);return i?`${s} ${i}`:s}FormatPayloadSummary(e){if(!e||typeof e!="object")return e==null?"":`payload=${this.FormatValue(e)}`;const t=this.FormatFlowSummary(e);if(t)return t;if(Array.isArray(e))return`payload=Array(${e.length})`;const n=Object.entries(e);if(n.length===0)return"";const s=n.slice(0,8).map(([i,r])=>`${i}=${this.FormatValue(r)}`);return n.length>8&&s.push(`+${n.length-8} more`),s.join(" ")}FormatFlowSummary(e){const t=e.FlowName??null;if(!t)return"";const n=[`FlowName=${t}`],s=e.Parameters??e.Result??null;if(s&&typeof s=="object"){const i=s.ProviderId??s.Provider??null,r=s.ModelId??s.Model??null,o=s.Stream??null,a=s.Length??null,c=s.AttachmentCount??null;i&&n.push(`ProviderId=${i}`),r&&n.push(`ModelId=${r}`),typeof o=="boolean"&&n.push(`Stream=${o}`),typeof c=="number"&&n.push(`AttachmentCount=${c}`),typeof a=="number"&&n.push(`Length=${a}`)}return n.join(" ")}FormatValue(e){if(e==null)return"null";const t=typeof e;return t==="string"?e:t==="number"||t==="boolean"?`${e}`:Array.isArray(e)?`Array(${e.length})`:t==="object"?"{...}":String(e)}LogFlowStart(e,t){console.info(this.FormatEntry("Information","Flow.Start",{FlowName:e,Parameters:t}))}LogFlowEnd(e,t){console.info(this.FormatEntry("Information","Flow.End",{FlowName:e,Result:t}))}LogBranch(e,t,n){console.debug(this.FormatEntry("Debug","Flow.Branch",{FlowName:e,Branch:t,Details:n}))}LogTrace(e,t){console.trace(this.FormatEntry("Trace",e,t))}LogDebug(e,t){console.debug(this.FormatEntry("Debug",e,t))}LogInformation(e,t){console.info(this.FormatEntry("Information",e,t))}LogWarning(e,t){console.warn(this.FormatEntry("Warning",e,t))}LogError(e,t){console.error(this.FormatEntry("Error",e,t))}LogCritical(e,t){console.error(this.FormatEntry("Critical",e,t))}LogAttachmentEvent(e,t){console.info(this.FormatEntry("Information",`Attachments.${e}`,t))}}class qs{CreateFromConfiguration(e){return new Gs(e)}}class js{constructor({Storage:e}){this.Storage=e}GetJson(e){const t=this.Storage.getItem(e);return t?JSON.parse(t):null}SetJson(e,t){this.Storage.setItem(e,JSON.stringify(t))}}class Vs{constructor({DbName:e="ghostplug",StoreName:t="kv",StoreNames:n=null,Version:s=1}={}){this.DbName=e,this.StoreName=t;const i=[t,...n??[]].filter(Boolean);this.StoreNames=Array.from(new Set(i)),this.Version=s,this.DbPromise=null}async GetJson(e,t=this.StoreName){const n=await this.OpenAsync();return new Promise((s,i)=>{const a=n.transaction(t,"readonly").objectStore(t).get(e);a.onsuccess=()=>s(a.result??null),a.onerror=()=>i(a.error)})}async SetJson(e,t,n=this.StoreName){const s=await this.OpenAsync();return new Promise((i,r)=>{const c=s.transaction(n,"readwrite").objectStore(n).put(t,e);c.onsuccess=()=>i(),c.onerror=()=>r(c.error)})}async DeleteJson(e,t=this.StoreName){const n=await this.OpenAsync();return new Promise((s,i)=>{const a=n.transaction(t,"readwrite").objectStore(t).delete(e);a.onsuccess=()=>s(),a.onerror=()=>i(a.error)})}OpenAsync(){return this.DbPromise?this.DbPromise:(this.DbPromise=new Promise((e,t)=>{const n=indexedDB.open(this.DbName,this.Version);n.onupgradeneeded=()=>{const s=n.result;(this.StoreNames??[this.StoreName]).forEach(i=>{s.objectStoreNames.contains(i)||s.createObjectStore(i)})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}),this.DbPromise)}}class Ws{constructor({AppStateProvider:e,KeyStorage:t}){this.AppStateProvider=e,this.KeyStorage=t,this.AppStateKey="ghostplug.app-state",this.ProviderKeysKey="ghostplug.provider-keys",this.ProviderModelsKey="ghostplug.provider-models",this.DraftAttachmentsKey="ghostplug.draft-attachments"}async LoadStateAsync(){return this.AppStateProvider.GetJson(this.AppStateKey)}async SaveStateAsync(e){await this.AppStateProvider.SetJson(this.AppStateKey,e)}LoadProviderKeys(){return this.KeyStorage.GetJson(this.ProviderKeysKey)??{}}SaveProviderKeys(e){this.KeyStorage.SetJson(this.ProviderKeysKey,e??{})}LoadProviderModels(){return this.KeyStorage.GetJson(this.ProviderModelsKey)??{}}SaveProviderModels(e){this.KeyStorage.SetJson(this.ProviderModelsKey,e??{})}LoadDraftAttachmentContext(){return this.AppStateProvider.GetJson(this.DraftAttachmentsKey)}SaveDraftAttachmentContext(e){this.AppStateProvider.SetJson(this.DraftAttachmentsKey,e??null)}}class Js{constructor({KeyStorage:e}){this.KeyStorage=e,this.ProviderKeysKey="ghostplug.provider-keys",this.ProviderModelsKey="ghostplug.provider-models",this.ProviderAvailabilityKey="ghostplug.provider-availability"}LoadProviderKeys(){return this.KeyStorage.GetJson(this.ProviderKeysKey)??{}}SaveProviderKeys(e){this.KeyStorage.SetJson(this.ProviderKeysKey,e??{})}SetProviderKey(e,t){const s={...this.LoadProviderKeys(),[e]:t};return this.SaveProviderKeys(s),s}ClearProviderKey(e){const n={...this.LoadProviderKeys(),[e]:""};return this.SaveProviderKeys(n),n}LoadProviderModelStates(){return this.KeyStorage.GetJson(this.ProviderModelsKey)??{}}SaveProviderModelStates(e){this.KeyStorage.SetJson(this.ProviderModelsKey,e??{})}SetProviderModelState(e,t,n){const s=this.LoadProviderModelStates(),i={...s[e]??{},[t]:n},r={...s,[e]:i};return this.SaveProviderModelStates(r),r}LoadProviderAvailability(){return this.KeyStorage.GetJson(this.ProviderAvailabilityKey)??{}}SaveProviderAvailability(e){this.KeyStorage.SetJson(this.ProviderAvailabilityKey,e??{})}SetProviderAvailability(e,t){const s={...this.LoadProviderAvailability(),[e]:{...t??{}}};return this.SaveProviderAvailability(s),s}}class Qs{constructor({StorageProvider:e,StorageKey:t}={}){this.StorageProvider=e,this.StorageKey=t??"Ghostplug.Conversations"}async LoadStateAsync(){var t;const e=await((t=this.StorageProvider)==null?void 0:t.GetJson(this.StorageKey));return this.NormalizeState(e)}async SaveStateAsync(e){var n;const t=this.NormalizeState(e);await((n=this.StorageProvider)==null?void 0:n.SetJson(this.StorageKey,t))}async SaveConversationAsync(e){const t=await this.LoadStateAsync(),n=this.UpsertById(t.Conversations,e);await this.SaveStateAsync({...t,Conversations:n})}async SaveMessageAsync(e){const t=await this.LoadStateAsync(),n=e.ConversationId,s=t.MessagesByConversation[n]??[],i=this.UpsertById(s,e);await this.SaveStateAsync({...t,MessagesByConversation:{...t.MessagesByConversation,[n]:i}})}async SaveMessageGroupAsync(e){const t=await this.LoadStateAsync(),n=e.ConversationId,s=t.MessageGroupsByConversation[n]??[],i=this.UpsertById(s,e);await this.SaveStateAsync({...t,MessageGroupsByConversation:{...t.MessageGroupsByConversation,[n]:i}})}async SaveScrollPositionAsync(e,t){const n=await this.LoadStateAsync(),s=(n.Conversations??[]).map(i=>i.Id===e?{...i,ScrollPosition:t}:i);await this.SaveStateAsync({...n,Conversations:s})}async SaveInternalVisibilityAsync(e,t,n){const s=await this.LoadStateAsync(),r=(s.MessageGroupsByConversation[e]??[]).map(o=>o.Id===t?{...o,InternalVisible:n}:o);await this.SaveStateAsync({...s,MessageGroupsByConversation:{...s.MessageGroupsByConversation,[e]:r}})}NormalizeState(e){const t=this.NormalizeMessageMap(e==null?void 0:e.MessagesByConversation);return{Conversations:(e==null?void 0:e.Conversations)??[],MessagesByConversation:t,MessageGroupsByConversation:(e==null?void 0:e.MessageGroupsByConversation)??{},ReasoningStepsByConversation:(e==null?void 0:e.ReasoningStepsByConversation)??{}}}NormalizeMessageMap(e){const t=Object.entries(e??{});return Object.fromEntries(t.map(([n,s])=>[n,this.NormalizeMessages(s)]))}NormalizeMessages(e){return(e??[]).map(t=>this.NormalizeMessage(t))}NormalizeMessage(e){if(!e)return e;const t=Array.isArray(e.Attachments)?e.Attachments.map(i=>{if(!i||typeof i!="object")return i;const{DownloadUrl:r,...o}=i;return o}):[],n=e.Classification??e.Kind??null,s=typeof e.IsInternal=="boolean"?e.IsInternal:n==="internal"||n==="reasoning"||n==="system-internal"||n==="tool-invocation"||n==="tool-result"||e.Kind==="Internal";return{...e,Attachments:t,Classification:n,IsInternal:s}}UpsertById(e,t){const n=[...e??[]],s=n.findIndex(i=>i.Id===t.Id);return s===-1?(n.push(t),n):(n[s]=t,n)}}class Ys{constructor({StorageProvider:e,StoreName:t="attachments",DraftKeyPrefix:n="Ghostplug.DraftAttachments"}={}){this.StorageProvider=e,this.StoreName=t,this.DraftKeyPrefix=n}async LoadDraftAsync(e){var s,i;if(!e)return{DraftId:null,Attachments:[]};const t=this.BuildDraftKey(e),n=await((i=(s=this.StorageProvider)==null?void 0:s.GetJson)==null?void 0:i.call(s,t,this.StoreName));return this.NormalizeDraft(n,e)}async SaveDraftAsync(e,t){var i,r;if(!e)return;const n=this.BuildDraftKey(e),s={DraftId:e,UpdatedUtc:new Date().toISOString(),Attachments:this.NormalizeAttachments(t)};await((r=(i=this.StorageProvider)==null?void 0:i.SetJson)==null?void 0:r.call(i,n,s,this.StoreName))}async ClearDraftAsync(e){var n,s;if(!e)return;const t=this.BuildDraftKey(e);await((s=(n=this.StorageProvider)==null?void 0:n.DeleteJson)==null?void 0:s.call(n,t,this.StoreName))}async AddAttachmentsAsync(e,t){const s=[...(await this.LoadDraftAsync(e)).Attachments,...t??[]];return await this.SaveDraftAsync(e,s),s}async RemoveAttachmentAsync(e,t){if(!t)return await this.LoadDraftAsync(e);const s=(await this.LoadDraftAsync(e)).Attachments.filter(i=>i.AttachmentId!==t);return await this.SaveDraftAsync(e,s),s}async PurgeExpiredAsync(e,t){const n=await this.LoadDraftAsync(e);if(!n.Attachments.length)return{Attachments:n.Attachments,Removed:[]};const s=typeof t=="number"?t:Date.now(),i=[],r=[];return n.Attachments.forEach(o=>{const a=o.InactivityExpiresAt?Date.parse(o.InactivityExpiresAt):null;a&&a<=s?i.push(o):r.push(o)}),i.length>0&&await this.SaveDraftAsync(e,r),{Attachments:r,Removed:i}}BuildDraftKey(e){return`${this.DraftKeyPrefix}.${e}`}NormalizeDraft(e,t){return{DraftId:t,UpdatedUtc:(e==null?void 0:e.UpdatedUtc)??null,Attachments:this.NormalizeAttachments((e==null?void 0:e.Attachments)??[])}}NormalizeAttachments(e){return(e??[]).map(t=>this.NormalizeAttachment(t))}NormalizeAttachment(e){return e&&{...e,Status:e.Status??"pending"}}}const ht=(l={})=>Object.entries(l).map(([e,t])=>` data-${e}="${t}"`).join(""),Gt=l=>(l??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),Y=(l,e="")=>`<span class="material-symbols-outlined ${e}">${l}</span>`,Et=({Icon:l,Material:e,ClassName:t=""}={})=>!l&&!e?"":e?Y(e,t):`<img src="${l}" alt="" class="${t}" />`,Qe=({Icon:l,Material:e,Action:t,AriaLabel:n,ClassName:s="",Disabled:i=!1,Data:r={}})=>`
  <button class="icon-button ${s}" data-action="${t}" aria-label="${n}"${i?" disabled":""}${ht(r)}>
    ${Et({Icon:l,Material:e})}
  </button>
`,Mt=({Icon:l,Material:e,Label:t,Action:n,ClassName:s="",LabelClass:i="",AriaLabel:r,Disabled:o=!1,Data:a={}})=>`
  <button class="icon-label-button ${s}" data-action="${n}" aria-label="${r??t}"${o?" disabled":""}${ht(a)}>
    ${Et({Icon:l,Material:e})}
    <span class="icon-label ${i}">${t}</span>
  </button>
`,Zs=({Icon:l,Material:e,Title:t,Subtitle:n,Action:s,ClassName:i="",Data:r={}})=>{const o=n.toString().trim().length>0,a=Et({Icon:l,Material:e,ClassName:"two-line-icon"});return`
    <button class="two-line-item ${o?"":"two-line-item-single"} ${i}" data-action="${s}"${ht(r)}>
      ${a}
      <span class="two-line-text">
        <span class="two-line-title" title="${Gt(t)}">${Gt(t)}</span>
        ${o?`<span class="two-line-subtitle">${Gt(n)}</span>`:""}
      </span>
    </button>
  `},yt=l=>`
  <div class="settings-form-title">${l}</div>
  <div class="settings-form-rule"></div>
`,Zt=({MenuId:l,ButtonContent:e,Items:t,SelectedValue:n,Disabled:s=!1})=>{const i=t.map(r=>`
      <button class="settings-dropdown-item ${r.Value===n?"is-selected":""}"${ht(r.Data)}>
        ${r.LeadingHtml??""}
        <span class="dropdown-label">${r.Label}</span>
        ${Y("check","dropdown-check")}
      </button>
    `).join("");return`
    <div class="settings-dropdown">
      <button
        class="settings-dropdown-button"
        data-action="toggle-settings-menu"
        data-menu-id="${l}"
        aria-expanded="false"
        ${s?'disabled aria-disabled="true"':""}
      >
        ${e}
      </button>
      <div class="settings-dropdown-menu hidden" data-settings-menu data-menu-id="${l}">
        ${i}
      </div>
    </div>
  `},On=({Checked:l=!1,Disabled:e=!1,Data:t={}})=>`
  <label class="model-switch">
    <input
      type="checkbox"
      class="model-checkbox"
      ${l?"checked":""}
      ${e?"disabled":""}
      ${ht(t)}
    />
    <span class="model-switch-track"></span>
  </label>
`;class Xs{Render({Conversations:e,Text:t,IsSidebarCollapsed:n}){var p;const s=n?"true":"false",r=(e??[]).filter(h=>h==null?void 0:h.IsPinned).map(h=>Zs({Icon:"assets/icons/chat_bubble_outline.svg",Title:h.Title,Subtitle:"",Action:"select-conversation",Data:{"conversation-id":h.Id,"conversation-pinned":h.IsPinned?"true":"false"},ClassName:"conversation-item"})).join(""),o=Mt({Icon:"assets/icons/add.svg",Action:"new-chat",Label:t.Sidebar.NewChat,ClassName:"sidebar-action",LabelClass:"sidebar-label"}),a=Mt({Icon:"assets/icons/search.svg",Action:"search-chats",Label:t.Sidebar.Search,ClassName:"sidebar-action",LabelClass:"sidebar-label"}),c=Mt({Icon:"assets/icons/settings.svg",Action:"open-settings",Label:t.Sidebar.Settings,ClassName:"sidebar-action",LabelClass:"settings-label"}),u=Qe({Icon:"assets/icons/dock_to_left.svg",Action:"toggle-sidebar",AriaLabel:"Collapse sidebar",ClassName:"sidebar-toggle"});return`
      <aside class="sidebar panel-shadow flex h-full w-72 flex-col gap-4 bg-white sidebar-pad" data-collapsed="${s}">
        <div class="sidebar-header flex items-center justify-between px-1">
          <button class="brand-button flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <span class="brand-icon-wrapper relative inline-flex h-5 w-5 items-center justify-center">
              <img src="assets/icons/logo.svg" alt="" class="brand-icon h-5 w-5" />
              <img src="assets/icons/dock_to_left.svg" alt="" class="toggle-icon hidden h-5 w-5" />
            </span>
            <span class="brand-title font-semibold">${t.AppTitle}</span>
          </button>
          ${u}
        </div>

        <div class="sidebar-actions flex flex-col gap-2 px-1">
          ${o}
          ${a}
        </div>

        <div class="px-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <span class="sidebar-label">${((p=t.ChatSaving)==null?void 0:p.PinnedListTitle)??t.Sidebar.Conversations}</span>
        </div>
        <div class="flex-1 overflow-y-auto pr-1">
          <div class="flex flex-col gap-1">
            ${r}
          </div>
        </div>
        <div class="border-t border-slate-100 pt-3">
          ${c}
        </div>
      </aside>
    `}}class ei{Render({Models:e,SelectedModelId:t,Text:n,ModelSelection:s,Layout:i}){const r=e.find(f=>f.Id===t)??e[0]??{Label:"No models"},o=(s==null?void 0:s.DescriptionText)??"",a=(i==null?void 0:i.ModelDescriptionDurationMs)??5e3,c=(i==null?void 0:i.ModelDescriptionFadeOutMs)??1e3,u=Math.max(a-c,0),p=o?`style="animation: model-description-fade ${c}ms ease forwards; animation-delay: ${u}ms;"`:"",h=e.reduce((f,v)=>{const S=v.ProviderId??"default";return f.has(S)||f.set(S,{ProviderName:v.ProviderName??"",Models:[]}),f.get(S).Models.push(v),f},new Map),d=Array.from(h.values()),m=d.map((f,v)=>{const S=d.length>1&&v>0?'<div class="model-provider-divider"></div>':"",w=f.Models.map(A=>`
        <button
          class="model-item"
          data-action="select-model"
          data-model-id="${A.Id}"
          data-provider-id="${A.ProviderId??""}"
          title="${A.Description??""}"
        >
          <span class="model-item-title">${A.Label}</span>
        </button>
      `).join("");return`${S}${w}`}).join("");return`
      <div class="relative w-full">
        <button
          class="model-toggle text-sm font-semibold"
          data-action="toggle-models"
          aria-haspopup="listbox"
          aria-expanded="false"
        >
          <span class="model-toggle-label-group">
            <span class="model-toggle-label">${r.Label}</span>
            ${Y("expand_more")}
          </span>
          ${o?`<span class="model-toggle-description" ${p}>${o}</span>`:""}
        </button>
        <div
          class="model-menu settings-dropdown-menu hidden"
          data-model-menu
          role="listbox"
          aria-label="${n.ModelSelector.Label}"
        >
          ${m}
        </div>
      </div>
    `}}function on(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var Be=on();function ss(l){Be=l}var dt={exec:()=>null};function D(l,e=""){let t=typeof l=="string"?l:l.source,n={replace:(s,i)=>{let r=typeof i=="string"?i:i.source;return r=r.replace(se.caret,"$1"),t=t.replace(s,r),n},getRegex:()=>new RegExp(t,e)};return n}var ti=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),se={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:l=>new RegExp(`^( {0,3}${l})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}#`),htmlBeginRegex:l=>new RegExp(`^ {0,${Math.min(3,l-1)}}<(?:[a-z].*>|!--)`,"i")},ni=/^(?:[ \t]*(?:\n|$))+/,si=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,ii=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,pt=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,ri=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,an=/(?:[*+-]|\d{1,9}[.)])/,is=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,rs=D(is).replace(/bull/g,an).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),oi=D(is).replace(/bull/g,an).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),ln=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,ai=/^[^\n]+/,cn=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,li=D(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",cn).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),ci=D(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,an).getRegex(),Dt="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",un=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,ui=D("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",un).replace("tag",Dt).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),os=D(ln).replace("hr",pt).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Dt).getRegex(),di=D(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",os).getRegex(),dn={blockquote:di,code:si,def:li,fences:ii,heading:ri,hr:pt,html:ui,lheading:rs,list:ci,newline:ni,paragraph:os,table:dt,text:ai},_n=D("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",pt).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Dt).getRegex(),hi={...dn,lheading:oi,table:_n,paragraph:D(ln).replace("hr",pt).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",_n).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Dt).getRegex()},pi={...dn,html:D(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",un).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:dt,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:D(ln).replace("hr",pt).replace("heading",` *#{1,6} *[^
]`).replace("lheading",rs).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},gi=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,mi=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,as=/^( {2,}|\\)\n(?!\s*$)/,fi=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,$t=/[\p{P}\p{S}]/u,hn=/[\s\p{P}\p{S}]/u,ls=/[^\s\p{P}\p{S}]/u,Si=D(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,hn).getRegex(),cs=/(?!~)[\p{P}\p{S}]/u,vi=/(?!~)[\s\p{P}\p{S}]/u,bi=/(?:[^\s\p{P}\p{S}]|~)/u,yi=D(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",ti?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),us=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,Ci=D(us,"u").replace(/punct/g,$t).getRegex(),Ai=D(us,"u").replace(/punct/g,cs).getRegex(),ds="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",Ii=D(ds,"gu").replace(/notPunctSpace/g,ls).replace(/punctSpace/g,hn).replace(/punct/g,$t).getRegex(),ki=D(ds,"gu").replace(/notPunctSpace/g,bi).replace(/punctSpace/g,vi).replace(/punct/g,cs).getRegex(),xi=D("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,ls).replace(/punctSpace/g,hn).replace(/punct/g,$t).getRegex(),Mi=D(/\\(punct)/,"gu").replace(/punct/g,$t).getRegex(),wi=D(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Ti=D(un).replace("(?:-->|$)","-->").getRegex(),Pi=D("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Ti).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Tt=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,Ri=D(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Tt).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),hs=D(/^!?\[(label)\]\[(ref)\]/).replace("label",Tt).replace("ref",cn).getRegex(),ps=D(/^!?\[(ref)\](?:\[\])?/).replace("ref",cn).getRegex(),Li=D("reflink|nolink(?!\\()","g").replace("reflink",hs).replace("nolink",ps).getRegex(),Un=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,pn={_backpedal:dt,anyPunctuation:Mi,autolink:wi,blockSkip:yi,br:as,code:mi,del:dt,emStrongLDelim:Ci,emStrongRDelimAst:Ii,emStrongRDelimUnd:xi,escape:gi,link:Ri,nolink:ps,punctuation:Si,reflink:hs,reflinkSearch:Li,tag:Pi,text:fi,url:dt},Ei={...pn,link:D(/^!?\[(label)\]\((.*?)\)/).replace("label",Tt).getRegex(),reflink:D(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Tt).getRegex()},Xt={...pn,emStrongRDelimAst:ki,emStrongLDelim:Ai,url:D(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",Un).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:D(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",Un).getRegex()},Di={...Xt,br:D(as).replace("{2,}","*").getRegex(),text:D(Xt.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},Ct={normal:dn,gfm:hi,pedantic:pi},tt={normal:pn,gfm:Xt,breaks:Di,pedantic:Ei},$i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Nn=l=>$i[l];function Pe(l,e){if(e){if(se.escapeTest.test(l))return l.replace(se.escapeReplace,Nn)}else if(se.escapeTestNoEncode.test(l))return l.replace(se.escapeReplaceNoEncode,Nn);return l}function Bn(l){try{l=encodeURI(l).replace(se.percentDecode,"%")}catch{return null}return l}function Fn(l,e){var i;let t=l.replace(se.findPipe,(r,o,a)=>{let c=!1,u=o;for(;--u>=0&&a[u]==="\\";)c=!c;return c?"|":" |"}),n=t.split(se.splitPipe),s=0;if(n[0].trim()||n.shift(),n.length>0&&!((i=n.at(-1))!=null&&i.trim())&&n.pop(),e)if(n.length>e)n.splice(e);else for(;n.length<e;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(se.slashPipe,"|");return n}function nt(l,e,t){let n=l.length;if(n===0)return"";let s=0;for(;s<n&&l.charAt(n-s-1)===e;)s++;return l.slice(0,n-s)}function Oi(l,e){if(l.indexOf(e[1])===-1)return-1;let t=0;for(let n=0;n<l.length;n++)if(l[n]==="\\")n++;else if(l[n]===e[0])t++;else if(l[n]===e[1]&&(t--,t<0))return n;return t>0?-2:-1}function zn(l,e,t,n,s){let i=e.href,r=e.title||null,o=l[1].replace(s.other.outputLinkReplace,"$1");n.state.inLink=!0;let a={type:l[0].charAt(0)==="!"?"image":"link",raw:t,href:i,title:r,text:o,tokens:n.inlineTokens(o)};return n.state.inLink=!1,a}function _i(l,e,t){let n=l.match(t.other.indentCodeCompensation);if(n===null)return e;let s=n[1];return e.split(`
`).map(i=>{let r=i.match(t.other.beginningSpace);if(r===null)return i;let[o]=r;return o.length>=s.length?i.slice(s.length):i}).join(`
`)}var Pt=class{constructor(l){U(this,"options");U(this,"rules");U(this,"lexer");this.options=l||Be}space(l){let e=this.rules.block.newline.exec(l);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(l){let e=this.rules.block.code.exec(l);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:nt(t,`
`)}}}fences(l){let e=this.rules.block.fences.exec(l);if(e){let t=e[0],n=_i(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:n}}}heading(l){let e=this.rules.block.heading.exec(l);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let n=nt(t,"#");(this.options.pedantic||!n||this.rules.other.endingSpaceChar.test(n))&&(t=n.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(l){let e=this.rules.block.hr.exec(l);if(e)return{type:"hr",raw:nt(e[0],`
`)}}blockquote(l){let e=this.rules.block.blockquote.exec(l);if(e){let t=nt(e[0],`
`).split(`
`),n="",s="",i=[];for(;t.length>0;){let r=!1,o=[],a;for(a=0;a<t.length;a++)if(this.rules.other.blockquoteStart.test(t[a]))o.push(t[a]),r=!0;else if(!r)o.push(t[a]);else break;t=t.slice(a);let c=o.join(`
`),u=c.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}
${c}`:c,s=s?`${s}
${u}`:u;let p=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(u,i,!0),this.lexer.state.top=p,t.length===0)break;let h=i.at(-1);if((h==null?void 0:h.type)==="code")break;if((h==null?void 0:h.type)==="blockquote"){let d=h,m=d.raw+`
`+t.join(`
`),f=this.blockquote(m);i[i.length-1]=f,n=n.substring(0,n.length-d.raw.length)+f.raw,s=s.substring(0,s.length-d.text.length)+f.text;break}else if((h==null?void 0:h.type)==="list"){let d=h,m=d.raw+`
`+t.join(`
`),f=this.list(m);i[i.length-1]=f,n=n.substring(0,n.length-h.raw.length)+f.raw,s=s.substring(0,s.length-d.raw.length)+f.raw,t=m.substring(i.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:n,tokens:i,text:s}}}list(l){var t,n;let e=this.rules.block.list.exec(l);if(e){let s=e[1].trim(),i=s.length>1,r={type:"list",raw:"",ordered:i,start:i?+s.slice(0,-1):"",loose:!1,items:[]};s=i?`\\d{1,9}\\${s.slice(-1)}`:`\\${s}`,this.options.pedantic&&(s=i?s:"[*+-]");let o=this.rules.other.listItemRegex(s),a=!1;for(;l;){let u=!1,p="",h="";if(!(e=o.exec(l))||this.rules.block.hr.test(l))break;p=e[0],l=l.substring(p.length);let d=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,S=>" ".repeat(3*S.length)),m=l.split(`
`,1)[0],f=!d.trim(),v=0;if(this.options.pedantic?(v=2,h=d.trimStart()):f?v=e[1].length+1:(v=e[2].search(this.rules.other.nonSpaceChar),v=v>4?1:v,h=d.slice(v),v+=e[1].length),f&&this.rules.other.blankLine.test(m)&&(p+=m+`
`,l=l.substring(m.length+1),u=!0),!u){let S=this.rules.other.nextBulletRegex(v),w=this.rules.other.hrRegex(v),A=this.rules.other.fencesBeginRegex(v),x=this.rules.other.headingBeginRegex(v),I=this.rules.other.htmlBeginRegex(v);for(;l;){let P=l.split(`
`,1)[0],y;if(m=P,this.options.pedantic?(m=m.replace(this.rules.other.listReplaceNesting,"  "),y=m):y=m.replace(this.rules.other.tabCharGlobal,"    "),A.test(m)||x.test(m)||I.test(m)||S.test(m)||w.test(m))break;if(y.search(this.rules.other.nonSpaceChar)>=v||!m.trim())h+=`
`+y.slice(v);else{if(f||d.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||A.test(d)||x.test(d)||w.test(d))break;h+=`
`+m}!f&&!m.trim()&&(f=!0),p+=P+`
`,l=l.substring(P.length+1),d=y.slice(v)}}r.loose||(a?r.loose=!0:this.rules.other.doubleBlankLine.test(p)&&(a=!0)),r.items.push({type:"list_item",raw:p,task:!!this.options.gfm&&this.rules.other.listIsTask.test(h),loose:!1,text:h,tokens:[]}),r.raw+=p}let c=r.items.at(-1);if(c)c.raw=c.raw.trimEnd(),c.text=c.text.trimEnd();else return;r.raw=r.raw.trimEnd();for(let u of r.items){if(this.lexer.state.top=!1,u.tokens=this.lexer.blockTokens(u.text,[]),u.task){if(u.text=u.text.replace(this.rules.other.listReplaceTask,""),((t=u.tokens[0])==null?void 0:t.type)==="text"||((n=u.tokens[0])==null?void 0:n.type)==="paragraph"){u.tokens[0].raw=u.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),u.tokens[0].text=u.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let h=this.lexer.inlineQueue.length-1;h>=0;h--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[h].src)){this.lexer.inlineQueue[h].src=this.lexer.inlineQueue[h].src.replace(this.rules.other.listReplaceTask,"");break}}let p=this.rules.other.listTaskCheckbox.exec(u.raw);if(p){let h={type:"checkbox",raw:p[0]+" ",checked:p[0]!=="[ ]"};u.checked=h.checked,r.loose?u.tokens[0]&&["paragraph","text"].includes(u.tokens[0].type)&&"tokens"in u.tokens[0]&&u.tokens[0].tokens?(u.tokens[0].raw=h.raw+u.tokens[0].raw,u.tokens[0].text=h.raw+u.tokens[0].text,u.tokens[0].tokens.unshift(h)):u.tokens.unshift({type:"paragraph",raw:h.raw,text:h.raw,tokens:[h]}):u.tokens.unshift(h)}}if(!r.loose){let p=u.tokens.filter(d=>d.type==="space"),h=p.length>0&&p.some(d=>this.rules.other.anyLine.test(d.raw));r.loose=h}}if(r.loose)for(let u of r.items){u.loose=!0;for(let p of u.tokens)p.type==="text"&&(p.type="paragraph")}return r}}html(l){let e=this.rules.block.html.exec(l);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(l){let e=this.rules.block.def.exec(l);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:n,title:s}}}table(l){var r;let e=this.rules.block.table.exec(l);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=Fn(e[1]),n=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),s=(r=e[3])!=null&&r.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],i={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===n.length){for(let o of n)this.rules.other.tableAlignRight.test(o)?i.align.push("right"):this.rules.other.tableAlignCenter.test(o)?i.align.push("center"):this.rules.other.tableAlignLeft.test(o)?i.align.push("left"):i.align.push(null);for(let o=0;o<t.length;o++)i.header.push({text:t[o],tokens:this.lexer.inline(t[o]),header:!0,align:i.align[o]});for(let o of s)i.rows.push(Fn(o,i.header.length).map((a,c)=>({text:a,tokens:this.lexer.inline(a),header:!1,align:i.align[c]})));return i}}lheading(l){let e=this.rules.block.lheading.exec(l);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(l){let e=this.rules.block.paragraph.exec(l);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(l){let e=this.rules.block.text.exec(l);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(l){let e=this.rules.inline.escape.exec(l);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(l){let e=this.rules.inline.tag.exec(l);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(l){let e=this.rules.inline.link.exec(l);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let i=nt(t.slice(0,-1),"\\");if((t.length-i.length)%2===0)return}else{let i=Oi(e[2],"()");if(i===-2)return;if(i>-1){let r=(e[0].indexOf("!")===0?5:4)+e[1].length+i;e[2]=e[2].substring(0,i),e[0]=e[0].substring(0,r).trim(),e[3]=""}}let n=e[2],s="";if(this.options.pedantic){let i=this.rules.other.pedanticHrefTitle.exec(n);i&&(n=i[1],s=i[3])}else s=e[3]?e[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?n=n.slice(1):n=n.slice(1,-1)),zn(e,{href:n&&n.replace(this.rules.inline.anyPunctuation,"$1"),title:s&&s.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(l,e){let t;if((t=this.rules.inline.reflink.exec(l))||(t=this.rules.inline.nolink.exec(l))){let n=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),s=e[n.toLowerCase()];if(!s){let i=t[0].charAt(0);return{type:"text",raw:i,text:i}}return zn(t,s,t[0],this.lexer,this.rules)}}emStrong(l,e,t=""){let n=this.rules.inline.emStrongLDelim.exec(l);if(!(!n||n[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(n[1]||n[2])||!t||this.rules.inline.punctuation.exec(t))){let s=[...n[0]].length-1,i,r,o=s,a=0,c=n[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,e=e.slice(-1*l.length+s);(n=c.exec(e))!=null;){if(i=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!i)continue;if(r=[...i].length,n[3]||n[4]){o+=r;continue}else if((n[5]||n[6])&&s%3&&!((s+r)%3)){a+=r;continue}if(o-=r,o>0)continue;r=Math.min(r,r+o+a);let u=[...n[0]][0].length,p=l.slice(0,s+n.index+u+r);if(Math.min(s,r)%2){let d=p.slice(1,-1);return{type:"em",raw:p,text:d,tokens:this.lexer.inlineTokens(d)}}let h=p.slice(2,-2);return{type:"strong",raw:p,text:h,tokens:this.lexer.inlineTokens(h)}}}}codespan(l){let e=this.rules.inline.code.exec(l);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),n=this.rules.other.nonSpaceChar.test(t),s=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return n&&s&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(l){let e=this.rules.inline.br.exec(l);if(e)return{type:"br",raw:e[0]}}del(l){let e=this.rules.inline.del.exec(l);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(l){let e=this.rules.inline.autolink.exec(l);if(e){let t,n;return e[2]==="@"?(t=e[1],n="mailto:"+t):(t=e[1],n=t),{type:"link",raw:e[0],text:t,href:n,tokens:[{type:"text",raw:t,text:t}]}}}url(l){var t;let e;if(e=this.rules.inline.url.exec(l)){let n,s;if(e[2]==="@")n=e[0],s="mailto:"+n;else{let i;do i=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(i!==e[0]);n=e[0],e[1]==="www."?s="http://"+e[0]:s=e[0]}return{type:"link",raw:e[0],text:n,href:s,tokens:[{type:"text",raw:n,text:n}]}}}inlineText(l){let e=this.rules.inline.text.exec(l);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},me=class en{constructor(e){U(this,"tokens");U(this,"options");U(this,"state");U(this,"inlineQueue");U(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||Be,this.options.tokenizer=this.options.tokenizer||new Pt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:se,block:Ct.normal,inline:tt.normal};this.options.pedantic?(t.block=Ct.pedantic,t.inline=tt.pedantic):this.options.gfm&&(t.block=Ct.gfm,this.options.breaks?t.inline=tt.breaks:t.inline=tt.gfm),this.tokenizer.rules=t}static get rules(){return{block:Ct,inline:tt}}static lex(e,t){return new en(t).lex(e)}static lexInline(e,t){return new en(t).inlineTokens(e)}lex(e){e=e.replace(se.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let n=this.inlineQueue[t];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){var s,i,r;for(this.options.pedantic&&(e=e.replace(se.tabCharGlobal,"    ").replace(se.spaceLine,""));e;){let o;if((i=(s=this.options.extensions)==null?void 0:s.block)!=null&&i.some(c=>(o=c.call({lexer:this},e,t))?(e=e.substring(o.raw.length),t.push(o),!0):!1))continue;if(o=this.tokenizer.space(e)){e=e.substring(o.raw.length);let c=t.at(-1);o.raw.length===1&&c!==void 0?c.raw+=`
`:t.push(o);continue}if(o=this.tokenizer.code(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.at(-1).src=c.text):t.push(o);continue}if(o=this.tokenizer.fences(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.heading(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.hr(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.blockquote(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.list(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.html(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.def(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.raw,this.inlineQueue.at(-1).src=c.text):this.tokens.links[o.tag]||(this.tokens.links[o.tag]={href:o.href,title:o.title},t.push(o));continue}if(o=this.tokenizer.table(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.lheading(e)){e=e.substring(o.raw.length),t.push(o);continue}let a=e;if((r=this.options.extensions)!=null&&r.startBlock){let c=1/0,u=e.slice(1),p;this.options.extensions.startBlock.forEach(h=>{p=h.call({lexer:this},u),typeof p=="number"&&p>=0&&(c=Math.min(c,p))}),c<1/0&&c>=0&&(a=e.substring(0,c+1))}if(this.state.top&&(o=this.tokenizer.paragraph(a))){let c=t.at(-1);n&&(c==null?void 0:c.type)==="paragraph"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(o),n=a.length!==e.length,e=e.substring(o.raw.length);continue}if(o=this.tokenizer.text(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(o);continue}if(e){let c="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(c);break}else throw new Error(c)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){var a,c,u,p,h;let n=e,s=null;if(this.tokens.links){let d=Object.keys(this.tokens.links);if(d.length>0)for(;(s=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)d.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(s=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,s.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let i;for(;(s=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)i=s[2]?s[2].length:0,n=n.slice(0,s.index+i)+"["+"a".repeat(s[0].length-i-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);n=((c=(a=this.options.hooks)==null?void 0:a.emStrongMask)==null?void 0:c.call({lexer:this},n))??n;let r=!1,o="";for(;e;){r||(o=""),r=!1;let d;if((p=(u=this.options.extensions)==null?void 0:u.inline)!=null&&p.some(f=>(d=f.call({lexer:this},e,t))?(e=e.substring(d.raw.length),t.push(d),!0):!1))continue;if(d=this.tokenizer.escape(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.tag(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.link(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(d.raw.length);let f=t.at(-1);d.type==="text"&&(f==null?void 0:f.type)==="text"?(f.raw+=d.raw,f.text+=d.text):t.push(d);continue}if(d=this.tokenizer.emStrong(e,n,o)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.codespan(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.br(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.del(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.autolink(e)){e=e.substring(d.raw.length),t.push(d);continue}if(!this.state.inLink&&(d=this.tokenizer.url(e))){e=e.substring(d.raw.length),t.push(d);continue}let m=e;if((h=this.options.extensions)!=null&&h.startInline){let f=1/0,v=e.slice(1),S;this.options.extensions.startInline.forEach(w=>{S=w.call({lexer:this},v),typeof S=="number"&&S>=0&&(f=Math.min(f,S))}),f<1/0&&f>=0&&(m=e.substring(0,f+1))}if(d=this.tokenizer.inlineText(m)){e=e.substring(d.raw.length),d.raw.slice(-1)!=="_"&&(o=d.raw.slice(-1)),r=!0;let f=t.at(-1);(f==null?void 0:f.type)==="text"?(f.raw+=d.raw,f.text+=d.text):t.push(d);continue}if(e){let f="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(f);break}else throw new Error(f)}}return t}},Rt=class{constructor(l){U(this,"options");U(this,"parser");this.options=l||Be}space(l){return""}code({text:l,lang:e,escaped:t}){var i;let n=(i=(e||"").match(se.notSpaceStart))==null?void 0:i[0],s=l.replace(se.endingNewline,"")+`
`;return n?'<pre><code class="language-'+Pe(n)+'">'+(t?s:Pe(s,!0))+`</code></pre>
`:"<pre><code>"+(t?s:Pe(s,!0))+`</code></pre>
`}blockquote({tokens:l}){return`<blockquote>
${this.parser.parse(l)}</blockquote>
`}html({text:l}){return l}def(l){return""}heading({tokens:l,depth:e}){return`<h${e}>${this.parser.parseInline(l)}</h${e}>
`}hr(l){return`<hr>
`}list(l){let e=l.ordered,t=l.start,n="";for(let r=0;r<l.items.length;r++){let o=l.items[r];n+=this.listitem(o)}let s=e?"ol":"ul",i=e&&t!==1?' start="'+t+'"':"";return"<"+s+i+`>
`+n+"</"+s+`>
`}listitem(l){return`<li>${this.parser.parse(l.tokens)}</li>
`}checkbox({checked:l}){return"<input "+(l?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:l}){return`<p>${this.parser.parseInline(l)}</p>
`}table(l){let e="",t="";for(let s=0;s<l.header.length;s++)t+=this.tablecell(l.header[s]);e+=this.tablerow({text:t});let n="";for(let s=0;s<l.rows.length;s++){let i=l.rows[s];t="";for(let r=0;r<i.length;r++)t+=this.tablecell(i[r]);n+=this.tablerow({text:t})}return n&&(n=`<tbody>${n}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+n+`</table>
`}tablerow({text:l}){return`<tr>
${l}</tr>
`}tablecell(l){let e=this.parser.parseInline(l.tokens),t=l.header?"th":"td";return(l.align?`<${t} align="${l.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:l}){return`<strong>${this.parser.parseInline(l)}</strong>`}em({tokens:l}){return`<em>${this.parser.parseInline(l)}</em>`}codespan({text:l}){return`<code>${Pe(l,!0)}</code>`}br(l){return"<br>"}del({tokens:l}){return`<del>${this.parser.parseInline(l)}</del>`}link({href:l,title:e,tokens:t}){let n=this.parser.parseInline(t),s=Bn(l);if(s===null)return n;l=s;let i='<a href="'+l+'"';return e&&(i+=' title="'+Pe(e)+'"'),i+=">"+n+"</a>",i}image({href:l,title:e,text:t,tokens:n}){n&&(t=this.parser.parseInline(n,this.parser.textRenderer));let s=Bn(l);if(s===null)return Pe(t);l=s;let i=`<img src="${l}" alt="${t}"`;return e&&(i+=` title="${Pe(e)}"`),i+=">",i}text(l){return"tokens"in l&&l.tokens?this.parser.parseInline(l.tokens):"escaped"in l&&l.escaped?l.text:Pe(l.text)}},gn=class{strong({text:l}){return l}em({text:l}){return l}codespan({text:l}){return l}del({text:l}){return l}html({text:l}){return l}text({text:l}){return l}link({text:l}){return""+l}image({text:l}){return""+l}br(){return""}checkbox({raw:l}){return l}},fe=class tn{constructor(e){U(this,"options");U(this,"renderer");U(this,"textRenderer");this.options=e||Be,this.options.renderer=this.options.renderer||new Rt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new gn}static parse(e,t){return new tn(t).parse(e)}static parseInline(e,t){return new tn(t).parseInline(e)}parse(e){var n,s;let t="";for(let i=0;i<e.length;i++){let r=e[i];if((s=(n=this.options.extensions)==null?void 0:n.renderers)!=null&&s[r.type]){let a=r,c=this.options.extensions.renderers[a.type].call({parser:this},a);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(a.type)){t+=c||"";continue}}let o=r;switch(o.type){case"space":{t+=this.renderer.space(o);break}case"hr":{t+=this.renderer.hr(o);break}case"heading":{t+=this.renderer.heading(o);break}case"code":{t+=this.renderer.code(o);break}case"table":{t+=this.renderer.table(o);break}case"blockquote":{t+=this.renderer.blockquote(o);break}case"list":{t+=this.renderer.list(o);break}case"checkbox":{t+=this.renderer.checkbox(o);break}case"html":{t+=this.renderer.html(o);break}case"def":{t+=this.renderer.def(o);break}case"paragraph":{t+=this.renderer.paragraph(o);break}case"text":{t+=this.renderer.text(o);break}default:{let a='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(a),"";throw new Error(a)}}}return t}parseInline(e,t=this.renderer){var s,i;let n="";for(let r=0;r<e.length;r++){let o=e[r];if((i=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&i[o.type]){let c=this.options.extensions.renderers[o.type].call({parser:this},o);if(c!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(o.type)){n+=c||"";continue}}let a=o;switch(a.type){case"escape":{n+=t.text(a);break}case"html":{n+=t.html(a);break}case"link":{n+=t.link(a);break}case"image":{n+=t.image(a);break}case"checkbox":{n+=t.checkbox(a);break}case"strong":{n+=t.strong(a);break}case"em":{n+=t.em(a);break}case"codespan":{n+=t.codespan(a);break}case"br":{n+=t.br(a);break}case"del":{n+=t.del(a);break}case"text":{n+=t.text(a);break}default:{let c='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return n}},xt,ct=(xt=class{constructor(l){U(this,"options");U(this,"block");this.options=l||Be}preprocess(l){return l}postprocess(l){return l}processAllTokens(l){return l}emStrongMask(l){return l}provideLexer(){return this.block?me.lex:me.lexInline}provideParser(){return this.block?fe.parse:fe.parseInline}},U(xt,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),U(xt,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),xt),Ui=class{constructor(...l){U(this,"defaults",on());U(this,"options",this.setOptions);U(this,"parse",this.parseMarkdown(!0));U(this,"parseInline",this.parseMarkdown(!1));U(this,"Parser",fe);U(this,"Renderer",Rt);U(this,"TextRenderer",gn);U(this,"Lexer",me);U(this,"Tokenizer",Pt);U(this,"Hooks",ct);this.use(...l)}walkTokens(l,e){var n,s;let t=[];for(let i of l)switch(t=t.concat(e.call(this,i)),i.type){case"table":{let r=i;for(let o of r.header)t=t.concat(this.walkTokens(o.tokens,e));for(let o of r.rows)for(let a of o)t=t.concat(this.walkTokens(a.tokens,e));break}case"list":{let r=i;t=t.concat(this.walkTokens(r.items,e));break}default:{let r=i;(s=(n=this.defaults.extensions)==null?void 0:n.childTokens)!=null&&s[r.type]?this.defaults.extensions.childTokens[r.type].forEach(o=>{let a=r[o].flat(1/0);t=t.concat(this.walkTokens(a,e))}):r.tokens&&(t=t.concat(this.walkTokens(r.tokens,e)))}}return t}use(...l){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return l.forEach(t=>{let n={...t};if(n.async=this.defaults.async||n.async||!1,t.extensions&&(t.extensions.forEach(s=>{if(!s.name)throw new Error("extension name required");if("renderer"in s){let i=e.renderers[s.name];i?e.renderers[s.name]=function(...r){let o=s.renderer.apply(this,r);return o===!1&&(o=i.apply(this,r)),o}:e.renderers[s.name]=s.renderer}if("tokenizer"in s){if(!s.level||s.level!=="block"&&s.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let i=e[s.level];i?i.unshift(s.tokenizer):e[s.level]=[s.tokenizer],s.start&&(s.level==="block"?e.startBlock?e.startBlock.push(s.start):e.startBlock=[s.start]:s.level==="inline"&&(e.startInline?e.startInline.push(s.start):e.startInline=[s.start]))}"childTokens"in s&&s.childTokens&&(e.childTokens[s.name]=s.childTokens)}),n.extensions=e),t.renderer){let s=this.defaults.renderer||new Rt(this.defaults);for(let i in t.renderer){if(!(i in s))throw new Error(`renderer '${i}' does not exist`);if(["options","parser"].includes(i))continue;let r=i,o=t.renderer[r],a=s[r];s[r]=(...c)=>{let u=o.apply(s,c);return u===!1&&(u=a.apply(s,c)),u||""}}n.renderer=s}if(t.tokenizer){let s=this.defaults.tokenizer||new Pt(this.defaults);for(let i in t.tokenizer){if(!(i in s))throw new Error(`tokenizer '${i}' does not exist`);if(["options","rules","lexer"].includes(i))continue;let r=i,o=t.tokenizer[r],a=s[r];s[r]=(...c)=>{let u=o.apply(s,c);return u===!1&&(u=a.apply(s,c)),u}}n.tokenizer=s}if(t.hooks){let s=this.defaults.hooks||new ct;for(let i in t.hooks){if(!(i in s))throw new Error(`hook '${i}' does not exist`);if(["options","block"].includes(i))continue;let r=i,o=t.hooks[r],a=s[r];ct.passThroughHooks.has(i)?s[r]=c=>{if(this.defaults.async&&ct.passThroughHooksRespectAsync.has(i))return(async()=>{let p=await o.call(s,c);return a.call(s,p)})();let u=o.call(s,c);return a.call(s,u)}:s[r]=(...c)=>{if(this.defaults.async)return(async()=>{let p=await o.apply(s,c);return p===!1&&(p=await a.apply(s,c)),p})();let u=o.apply(s,c);return u===!1&&(u=a.apply(s,c)),u}}n.hooks=s}if(t.walkTokens){let s=this.defaults.walkTokens,i=t.walkTokens;n.walkTokens=function(r){let o=[];return o.push(i.call(this,r)),s&&(o=o.concat(s.call(this,r))),o}}this.defaults={...this.defaults,...n}}),this}setOptions(l){return this.defaults={...this.defaults,...l},this}lexer(l,e){return me.lex(l,e??this.defaults)}parser(l,e){return fe.parse(l,e??this.defaults)}parseMarkdown(l){return(e,t)=>{let n={...t},s={...this.defaults,...n},i=this.onError(!!s.silent,!!s.async);if(this.defaults.async===!0&&n.async===!1)return i(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return i(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return i(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(s.hooks&&(s.hooks.options=s,s.hooks.block=l),s.async)return(async()=>{let r=s.hooks?await s.hooks.preprocess(e):e,o=await(s.hooks?await s.hooks.provideLexer():l?me.lex:me.lexInline)(r,s),a=s.hooks?await s.hooks.processAllTokens(o):o;s.walkTokens&&await Promise.all(this.walkTokens(a,s.walkTokens));let c=await(s.hooks?await s.hooks.provideParser():l?fe.parse:fe.parseInline)(a,s);return s.hooks?await s.hooks.postprocess(c):c})().catch(i);try{s.hooks&&(e=s.hooks.preprocess(e));let r=(s.hooks?s.hooks.provideLexer():l?me.lex:me.lexInline)(e,s);s.hooks&&(r=s.hooks.processAllTokens(r)),s.walkTokens&&this.walkTokens(r,s.walkTokens);let o=(s.hooks?s.hooks.provideParser():l?fe.parse:fe.parseInline)(r,s);return s.hooks&&(o=s.hooks.postprocess(o)),o}catch(r){return i(r)}}}onError(l,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,l){let n="<p>An error occurred:</p><pre>"+Pe(t.message+"",!0)+"</pre>";return e?Promise.resolve(n):n}if(e)return Promise.reject(t);throw t}}},Ne=new Ui;function _(l,e){return Ne.parse(l,e)}_.options=_.setOptions=function(l){return Ne.setOptions(l),_.defaults=Ne.defaults,ss(_.defaults),_};_.getDefaults=on;_.defaults=Be;_.use=function(...l){return Ne.use(...l),_.defaults=Ne.defaults,ss(_.defaults),_};_.walkTokens=function(l,e){return Ne.walkTokens(l,e)};_.parseInline=Ne.parseInline;_.Parser=fe;_.parser=fe.parse;_.Renderer=Rt;_.TextRenderer=gn;_.Lexer=me;_.lexer=me.lex;_.Tokenizer=Pt;_.Hooks=ct;_.parse=_;_.options;_.setOptions;_.use;_.walkTokens;_.parseInline;fe.parse;me.lex;/*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE */const{entries:gs,setPrototypeOf:Hn,isFrozen:Ni,getPrototypeOf:Bi,getOwnPropertyDescriptor:Fi}=Object;let{freeze:ie,seal:de,create:nn}=Object,{apply:sn,construct:rn}=typeof Reflect<"u"&&Reflect;ie||(ie=function(e){return e});de||(de=function(e){return e});sn||(sn=function(e,t){for(var n=arguments.length,s=new Array(n>2?n-2:0),i=2;i<n;i++)s[i-2]=arguments[i];return e.apply(t,s)});rn||(rn=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return new e(...n)});const At=re(Array.prototype.forEach),zi=re(Array.prototype.lastIndexOf),Gn=re(Array.prototype.pop),st=re(Array.prototype.push),Hi=re(Array.prototype.splice),wt=re(String.prototype.toLowerCase),Kt=re(String.prototype.toString),qt=re(String.prototype.match),it=re(String.prototype.replace),Gi=re(String.prototype.indexOf),Ki=re(String.prototype.trim),pe=re(Object.prototype.hasOwnProperty),te=re(RegExp.prototype.test),rt=qi(TypeError);function re(l){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,n=new Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return sn(l,e,n)}}function qi(l){return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return rn(l,t)}}function E(l,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:wt;Hn&&Hn(l,null);let n=e.length;for(;n--;){let s=e[n];if(typeof s=="string"){const i=t(s);i!==s&&(Ni(e)||(e[n]=i),s=i)}l[s]=!0}return l}function ji(l){for(let e=0;e<l.length;e++)pe(l,e)||(l[e]=null);return l}function be(l){const e=nn(null);for(const[t,n]of gs(l))pe(l,t)&&(Array.isArray(n)?e[t]=ji(n):n&&typeof n=="object"&&n.constructor===Object?e[t]=be(n):e[t]=n);return e}function ot(l,e){for(;l!==null;){const n=Fi(l,e);if(n){if(n.get)return re(n.get);if(typeof n.value=="function")return re(n.value)}l=Bi(l)}function t(){return null}return t}const Kn=ie(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),jt=ie(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Vt=ie(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Vi=ie(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Wt=ie(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Wi=ie(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),qn=ie(["#text"]),jn=ie(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Jt=ie(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Vn=ie(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),It=ie(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Ji=de(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Qi=de(/<%[\w\W]*|[\w\W]*%>/gm),Yi=de(/\$\{[\w\W]*/gm),Zi=de(/^data-[\-\w.\u00B7-\uFFFF]+$/),Xi=de(/^aria-[\-\w]+$/),ms=de(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),er=de(/^(?:\w+script|data):/i),tr=de(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),fs=de(/^html$/i),nr=de(/^[a-z][.\w]*(-[.\w]+)+$/i);var Wn=Object.freeze({__proto__:null,ARIA_ATTR:Xi,ATTR_WHITESPACE:tr,CUSTOM_ELEMENT:nr,DATA_ATTR:Zi,DOCTYPE_NAME:fs,ERB_EXPR:Qi,IS_ALLOWED_URI:ms,IS_SCRIPT_OR_DATA:er,MUSTACHE_EXPR:Ji,TMPLIT_EXPR:Yi});const at={element:1,text:3,progressingInstruction:7,comment:8,document:9},sr=function(){return typeof window>"u"?null:window},ir=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let n=null;const s="data-tt-policy-suffix";t&&t.hasAttribute(s)&&(n=t.getAttribute(s));const i="dompurify"+(n?"#"+n:"");try{return e.createPolicy(i,{createHTML(r){return r},createScriptURL(r){return r}})}catch{return console.warn("TrustedTypes policy "+i+" could not be created."),null}},Jn=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function Ss(){let l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:sr();const e=R=>Ss(R);if(e.version="3.3.1",e.removed=[],!l||!l.document||l.document.nodeType!==at.document||!l.Element)return e.isSupported=!1,e;let{document:t}=l;const n=t,s=n.currentScript,{DocumentFragment:i,HTMLTemplateElement:r,Node:o,Element:a,NodeFilter:c,NamedNodeMap:u=l.NamedNodeMap||l.MozNamedAttrMap,HTMLFormElement:p,DOMParser:h,trustedTypes:d}=l,m=a.prototype,f=ot(m,"cloneNode"),v=ot(m,"remove"),S=ot(m,"nextSibling"),w=ot(m,"childNodes"),A=ot(m,"parentNode");if(typeof r=="function"){const R=t.createElement("template");R.content&&R.content.ownerDocument&&(t=R.content.ownerDocument)}let x,I="";const{implementation:P,createNodeIterator:y,createDocumentFragment:L,getElementsByTagName:H}=t,{importNode:M}=n;let C=Jn();e.isSupported=typeof gs=="function"&&typeof A=="function"&&P&&P.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:$,ERB_EXPR:B,TMPLIT_EXPR:Q,DATA_ATTR:Ce,ARIA_ATTR:O,IS_SCRIPT_OR_DATA:oe,ATTR_WHITESPACE:ee,CUSTOM_ELEMENT:Ae}=Wn;let{IS_ALLOWED_URI:Re}=Wn,F=null;const Le=E({},[...Kn,...jt,...Vt,...Wt,...qn]);let G=null;const Ee=E({},[...jn,...Jt,...Vn,...It]);let N=Object.seal(nn(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),he=null,Ie=null;const le=Object.seal(nn(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let De=!0,ke=!0,$e=!1,Oe=!0,ce=!1,k=!0,q=!1,xe=!1,ue=!1,He=!1,gt=!1,mt=!1,fn=!0,Sn=!1;const Ts="user-content-";let Ot=!0,Ye=!1,Ge={},Se=null;const _t=E({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let vn=null;const bn=E({},["audio","video","img","source","image","track"]);let Ut=null;const yn=E({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ft="http://www.w3.org/1998/Math/MathML",St="http://www.w3.org/2000/svg",Me="http://www.w3.org/1999/xhtml";let Ke=Me,Nt=!1,Bt=null;const Ps=E({},[ft,St,Me],Kt);let vt=E({},["mi","mo","mn","ms","mtext"]),bt=E({},["annotation-xml"]);const Rs=E({},["title","style","font","a","script"]);let Ze=null;const Ls=["application/xhtml+xml","text/html"],Es="text/html";let V=null,qe=null;const Ds=t.createElement("form"),Cn=function(g){return g instanceof RegExp||g instanceof Function},Ft=function(){let g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(qe&&qe===g)){if((!g||typeof g!="object")&&(g={}),g=be(g),Ze=Ls.indexOf(g.PARSER_MEDIA_TYPE)===-1?Es:g.PARSER_MEDIA_TYPE,V=Ze==="application/xhtml+xml"?Kt:wt,F=pe(g,"ALLOWED_TAGS")?E({},g.ALLOWED_TAGS,V):Le,G=pe(g,"ALLOWED_ATTR")?E({},g.ALLOWED_ATTR,V):Ee,Bt=pe(g,"ALLOWED_NAMESPACES")?E({},g.ALLOWED_NAMESPACES,Kt):Ps,Ut=pe(g,"ADD_URI_SAFE_ATTR")?E(be(yn),g.ADD_URI_SAFE_ATTR,V):yn,vn=pe(g,"ADD_DATA_URI_TAGS")?E(be(bn),g.ADD_DATA_URI_TAGS,V):bn,Se=pe(g,"FORBID_CONTENTS")?E({},g.FORBID_CONTENTS,V):_t,he=pe(g,"FORBID_TAGS")?E({},g.FORBID_TAGS,V):be({}),Ie=pe(g,"FORBID_ATTR")?E({},g.FORBID_ATTR,V):be({}),Ge=pe(g,"USE_PROFILES")?g.USE_PROFILES:!1,De=g.ALLOW_ARIA_ATTR!==!1,ke=g.ALLOW_DATA_ATTR!==!1,$e=g.ALLOW_UNKNOWN_PROTOCOLS||!1,Oe=g.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ce=g.SAFE_FOR_TEMPLATES||!1,k=g.SAFE_FOR_XML!==!1,q=g.WHOLE_DOCUMENT||!1,He=g.RETURN_DOM||!1,gt=g.RETURN_DOM_FRAGMENT||!1,mt=g.RETURN_TRUSTED_TYPE||!1,ue=g.FORCE_BODY||!1,fn=g.SANITIZE_DOM!==!1,Sn=g.SANITIZE_NAMED_PROPS||!1,Ot=g.KEEP_CONTENT!==!1,Ye=g.IN_PLACE||!1,Re=g.ALLOWED_URI_REGEXP||ms,Ke=g.NAMESPACE||Me,vt=g.MATHML_TEXT_INTEGRATION_POINTS||vt,bt=g.HTML_INTEGRATION_POINTS||bt,N=g.CUSTOM_ELEMENT_HANDLING||{},g.CUSTOM_ELEMENT_HANDLING&&Cn(g.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(N.tagNameCheck=g.CUSTOM_ELEMENT_HANDLING.tagNameCheck),g.CUSTOM_ELEMENT_HANDLING&&Cn(g.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(N.attributeNameCheck=g.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),g.CUSTOM_ELEMENT_HANDLING&&typeof g.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(N.allowCustomizedBuiltInElements=g.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ce&&(ke=!1),gt&&(He=!0),Ge&&(F=E({},qn),G=[],Ge.html===!0&&(E(F,Kn),E(G,jn)),Ge.svg===!0&&(E(F,jt),E(G,Jt),E(G,It)),Ge.svgFilters===!0&&(E(F,Vt),E(G,Jt),E(G,It)),Ge.mathMl===!0&&(E(F,Wt),E(G,Vn),E(G,It))),g.ADD_TAGS&&(typeof g.ADD_TAGS=="function"?le.tagCheck=g.ADD_TAGS:(F===Le&&(F=be(F)),E(F,g.ADD_TAGS,V))),g.ADD_ATTR&&(typeof g.ADD_ATTR=="function"?le.attributeCheck=g.ADD_ATTR:(G===Ee&&(G=be(G)),E(G,g.ADD_ATTR,V))),g.ADD_URI_SAFE_ATTR&&E(Ut,g.ADD_URI_SAFE_ATTR,V),g.FORBID_CONTENTS&&(Se===_t&&(Se=be(Se)),E(Se,g.FORBID_CONTENTS,V)),g.ADD_FORBID_CONTENTS&&(Se===_t&&(Se=be(Se)),E(Se,g.ADD_FORBID_CONTENTS,V)),Ot&&(F["#text"]=!0),q&&E(F,["html","head","body"]),F.table&&(E(F,["tbody"]),delete he.tbody),g.TRUSTED_TYPES_POLICY){if(typeof g.TRUSTED_TYPES_POLICY.createHTML!="function")throw rt('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof g.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw rt('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');x=g.TRUSTED_TYPES_POLICY,I=x.createHTML("")}else x===void 0&&(x=ir(d,s)),x!==null&&typeof I=="string"&&(I=x.createHTML(""));ie&&ie(g),qe=g}},An=E({},[...jt,...Vt,...Vi]),In=E({},[...Wt,...Wi]),$s=function(g){let b=A(g);(!b||!b.tagName)&&(b={namespaceURI:Ke,tagName:"template"});const T=wt(g.tagName),z=wt(b.tagName);return Bt[g.namespaceURI]?g.namespaceURI===St?b.namespaceURI===Me?T==="svg":b.namespaceURI===ft?T==="svg"&&(z==="annotation-xml"||vt[z]):!!An[T]:g.namespaceURI===ft?b.namespaceURI===Me?T==="math":b.namespaceURI===St?T==="math"&&bt[z]:!!In[T]:g.namespaceURI===Me?b.namespaceURI===St&&!bt[z]||b.namespaceURI===ft&&!vt[z]?!1:!In[T]&&(Rs[T]||!An[T]):!!(Ze==="application/xhtml+xml"&&Bt[g.namespaceURI]):!1},ve=function(g){st(e.removed,{element:g});try{A(g).removeChild(g)}catch{v(g)}},_e=function(g,b){try{st(e.removed,{attribute:b.getAttributeNode(g),from:b})}catch{st(e.removed,{attribute:null,from:b})}if(b.removeAttribute(g),g==="is")if(He||gt)try{ve(b)}catch{}else try{b.setAttribute(g,"")}catch{}},kn=function(g){let b=null,T=null;if(ue)g="<remove></remove>"+g;else{const j=qt(g,/^[\r\n\t ]+/);T=j&&j[0]}Ze==="application/xhtml+xml"&&Ke===Me&&(g='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+g+"</body></html>");const z=x?x.createHTML(g):g;if(Ke===Me)try{b=new h().parseFromString(z,Ze)}catch{}if(!b||!b.documentElement){b=P.createDocument(Ke,"template",null);try{b.documentElement.innerHTML=Nt?I:z}catch{}}const X=b.body||b.documentElement;return g&&T&&X.insertBefore(t.createTextNode(T),X.childNodes[0]||null),Ke===Me?H.call(b,q?"html":"body")[0]:q?b.documentElement:X},xn=function(g){return y.call(g.ownerDocument||g,g,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT|c.SHOW_PROCESSING_INSTRUCTION|c.SHOW_CDATA_SECTION,null)},zt=function(g){return g instanceof p&&(typeof g.nodeName!="string"||typeof g.textContent!="string"||typeof g.removeChild!="function"||!(g.attributes instanceof u)||typeof g.removeAttribute!="function"||typeof g.setAttribute!="function"||typeof g.namespaceURI!="string"||typeof g.insertBefore!="function"||typeof g.hasChildNodes!="function")},Mn=function(g){return typeof o=="function"&&g instanceof o};function we(R,g,b){At(R,T=>{T.call(e,g,b,qe)})}const wn=function(g){let b=null;if(we(C.beforeSanitizeElements,g,null),zt(g))return ve(g),!0;const T=V(g.nodeName);if(we(C.uponSanitizeElement,g,{tagName:T,allowedTags:F}),k&&g.hasChildNodes()&&!Mn(g.firstElementChild)&&te(/<[/\w!]/g,g.innerHTML)&&te(/<[/\w!]/g,g.textContent)||g.nodeType===at.progressingInstruction||k&&g.nodeType===at.comment&&te(/<[/\w]/g,g.data))return ve(g),!0;if(!(le.tagCheck instanceof Function&&le.tagCheck(T))&&(!F[T]||he[T])){if(!he[T]&&Pn(T)&&(N.tagNameCheck instanceof RegExp&&te(N.tagNameCheck,T)||N.tagNameCheck instanceof Function&&N.tagNameCheck(T)))return!1;if(Ot&&!Se[T]){const z=A(g)||g.parentNode,X=w(g)||g.childNodes;if(X&&z){const j=X.length;for(let ae=j-1;ae>=0;--ae){const Te=f(X[ae],!0);Te.__removalCount=(g.__removalCount||0)+1,z.insertBefore(Te,S(g))}}}return ve(g),!0}return g instanceof a&&!$s(g)||(T==="noscript"||T==="noembed"||T==="noframes")&&te(/<\/no(script|embed|frames)/i,g.innerHTML)?(ve(g),!0):(ce&&g.nodeType===at.text&&(b=g.textContent,At([$,B,Q],z=>{b=it(b,z," ")}),g.textContent!==b&&(st(e.removed,{element:g.cloneNode()}),g.textContent=b)),we(C.afterSanitizeElements,g,null),!1)},Tn=function(g,b,T){if(fn&&(b==="id"||b==="name")&&(T in t||T in Ds))return!1;if(!(ke&&!Ie[b]&&te(Ce,b))){if(!(De&&te(O,b))){if(!(le.attributeCheck instanceof Function&&le.attributeCheck(b,g))){if(!G[b]||Ie[b]){if(!(Pn(g)&&(N.tagNameCheck instanceof RegExp&&te(N.tagNameCheck,g)||N.tagNameCheck instanceof Function&&N.tagNameCheck(g))&&(N.attributeNameCheck instanceof RegExp&&te(N.attributeNameCheck,b)||N.attributeNameCheck instanceof Function&&N.attributeNameCheck(b,g))||b==="is"&&N.allowCustomizedBuiltInElements&&(N.tagNameCheck instanceof RegExp&&te(N.tagNameCheck,T)||N.tagNameCheck instanceof Function&&N.tagNameCheck(T))))return!1}else if(!Ut[b]){if(!te(Re,it(T,ee,""))){if(!((b==="src"||b==="xlink:href"||b==="href")&&g!=="script"&&Gi(T,"data:")===0&&vn[g])){if(!($e&&!te(oe,it(T,ee,"")))){if(T)return!1}}}}}}}return!0},Pn=function(g){return g!=="annotation-xml"&&qt(g,Ae)},Rn=function(g){we(C.beforeSanitizeAttributes,g,null);const{attributes:b}=g;if(!b||zt(g))return;const T={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:G,forceKeepAttr:void 0};let z=b.length;for(;z--;){const X=b[z],{name:j,namespaceURI:ae,value:Te}=X,je=V(j),Ht=Te;let Z=j==="value"?Ht:Ki(Ht);if(T.attrName=je,T.attrValue=Z,T.keepAttr=!0,T.forceKeepAttr=void 0,we(C.uponSanitizeAttribute,g,T),Z=T.attrValue,Sn&&(je==="id"||je==="name")&&(_e(j,g),Z=Ts+Z),k&&te(/((--!?|])>)|<\/(style|title|textarea)/i,Z)){_e(j,g);continue}if(je==="attributename"&&qt(Z,"href")){_e(j,g);continue}if(T.forceKeepAttr)continue;if(!T.keepAttr){_e(j,g);continue}if(!Oe&&te(/\/>/i,Z)){_e(j,g);continue}ce&&At([$,B,Q],En=>{Z=it(Z,En," ")});const Ln=V(g.nodeName);if(!Tn(Ln,je,Z)){_e(j,g);continue}if(x&&typeof d=="object"&&typeof d.getAttributeType=="function"&&!ae)switch(d.getAttributeType(Ln,je)){case"TrustedHTML":{Z=x.createHTML(Z);break}case"TrustedScriptURL":{Z=x.createScriptURL(Z);break}}if(Z!==Ht)try{ae?g.setAttributeNS(ae,j,Z):g.setAttribute(j,Z),zt(g)?ve(g):Gn(e.removed)}catch{_e(j,g)}}we(C.afterSanitizeAttributes,g,null)},Os=function R(g){let b=null;const T=xn(g);for(we(C.beforeSanitizeShadowDOM,g,null);b=T.nextNode();)we(C.uponSanitizeShadowNode,b,null),wn(b),Rn(b),b.content instanceof i&&R(b.content);we(C.afterSanitizeShadowDOM,g,null)};return e.sanitize=function(R){let g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},b=null,T=null,z=null,X=null;if(Nt=!R,Nt&&(R="<!-->"),typeof R!="string"&&!Mn(R))if(typeof R.toString=="function"){if(R=R.toString(),typeof R!="string")throw rt("dirty is not a string, aborting")}else throw rt("toString is not a function");if(!e.isSupported)return R;if(xe||Ft(g),e.removed=[],typeof R=="string"&&(Ye=!1),Ye){if(R.nodeName){const Te=V(R.nodeName);if(!F[Te]||he[Te])throw rt("root node is forbidden and cannot be sanitized in-place")}}else if(R instanceof o)b=kn("<!---->"),T=b.ownerDocument.importNode(R,!0),T.nodeType===at.element&&T.nodeName==="BODY"||T.nodeName==="HTML"?b=T:b.appendChild(T);else{if(!He&&!ce&&!q&&R.indexOf("<")===-1)return x&&mt?x.createHTML(R):R;if(b=kn(R),!b)return He?null:mt?I:""}b&&ue&&ve(b.firstChild);const j=xn(Ye?R:b);for(;z=j.nextNode();)wn(z),Rn(z),z.content instanceof i&&Os(z.content);if(Ye)return R;if(He){if(gt)for(X=L.call(b.ownerDocument);b.firstChild;)X.appendChild(b.firstChild);else X=b;return(G.shadowroot||G.shadowrootmode)&&(X=M.call(n,X,!0)),X}let ae=q?b.outerHTML:b.innerHTML;return q&&F["!doctype"]&&b.ownerDocument&&b.ownerDocument.doctype&&b.ownerDocument.doctype.name&&te(fs,b.ownerDocument.doctype.name)&&(ae="<!DOCTYPE "+b.ownerDocument.doctype.name+`>
`+ae),ce&&At([$,B,Q],Te=>{ae=it(ae,Te," ")}),x&&mt?x.createHTML(ae):ae},e.setConfig=function(){let R=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Ft(R),xe=!0},e.clearConfig=function(){qe=null,xe=!1},e.isValidAttribute=function(R,g,b){qe||Ft({});const T=V(R),z=V(g);return Tn(T,z,b)},e.addHook=function(R,g){typeof g=="function"&&st(C[R],g)},e.removeHook=function(R,g){if(g!==void 0){const b=zi(C[R],g);return b===-1?void 0:Hi(C[R],b,1)[0]}return Gn(C[R])},e.removeHooks=function(R){C[R]=[]},e.removeAllHooks=function(){C=Jn()},e}var rr=Ss();class or{Render(e){const t=_.parse(e??"",{breaks:!0});return rr.sanitize(t)}}class ar{constructor(){this.MarkdownRenderer=new or}RenderWelcome({Text:e}){return`
      <div class="flex h-full flex-col items-center justify-center text-center">
        <h1 class="text-3xl font-semibold text-slate-900">${e.WelcomeHeading}</h1>
      </div>
    `}RenderConversation({Messages:e,MessageGroups:t,Settings:n,Text:s}){const i=new Map((e??[]).map(a=>[a.Id,a])),r=a=>this.ResolveModelLabel(a,n);return t!=null&&t.length?`
        <div class="chat-thread flex flex-col gap-4">
          ${t.map(c=>{var A,x,I;const u=i.get(c.UserMessageId),p=i.get(c.AssistantMessageId),h=c.InternalMessageIds??[],d=h.length,m=((A=n==null?void 0:n.Chat)==null?void 0:A.InternalChatMessages)&&d>0,f=((x=s==null?void 0:s.Chat)==null?void 0:x.InternalMessageLabel)??"Thought",v=((I=s==null?void 0:s.Chat)==null?void 0:I.InternalMessagesSummaryLabel)??"internal messages",S=m?`
            <div class="internal-summary">
              ${d} ${v}
            </div>
          `:"",w=m?`
            <div class="internal-messages">
              ${h.map(P=>i.get(P)).filter(Boolean).map(P=>`
                    <div class="internal-message">
                      <div class="internal-label">${f}</div>
                      ${this.MarkdownRenderer.Render(P.Content)}
                    </div>
                  `).join("")}
            </div>
          `:"";return`
          <div class="flex flex-col gap-3">
            ${u?this.RenderUserMessage(u):""}
            ${S}
            ${w}
            ${p?this.RenderAssistantMessage(p,s,r(p)):""}
          </div>
        `}).join("")}
        </div>
      `:`
      <div class="chat-thread flex flex-col gap-4">
        ${(e??[]).map(a=>a.Role==="User"?this.RenderUserMessage(a):this.RenderAssistantMessage(a,s,r(a))).join("")}
      </div>
    `}RenderUserMessage(e){const t=this.RenderAttachments(e.Attachments??[]);return`
      <div class="flex justify-end">
        <div class="user-bubble max-w-[70%] px-4 py-2 text-sm">
          ${this.MarkdownRenderer.Render(e.Content)}
          ${t}
        </div>
      </div>
    `}RenderAssistantMessage(e,t,n){var i,r;if(e.Status==="pending")return`
        <div class="assistant-block">
          <div class="assistant-pending text-sm" data-chat-pending>
            <span class="material-symbols-outlined pending-spinner">autorenew</span>
            <span>${(t==null?void 0:t.PendingMessage)??"Waiting for response..."}</span>
          </div>
        </div>
      `;if(e.Status==="aborted"){const o=this.RenderAssistantMeta(e,n,{Prefix:"Aborted"});return`
        <div class="assistant-block">
          ${(e.Content??"").trim().length>0?`
            <div class="assistant-text text-sm text-slate-800">
              ${this.MarkdownRenderer.Render(e.Content??"")}
            </div>
          `:""}
          <div class="assistant-pending text-sm" data-chat-aborted>
            <span class="material-symbols-outlined">close</span>
            <span>${((i=t==null?void 0:t.Chat)==null?void 0:i.AbortedMessageText)??"Response aborted."}</span>
          </div>
          ${o}
        </div>
      `}if(e.Status==="streaming"&&e.ReasoningEnabled)return`
        <div class="assistant-block">
          <div class="assistant-pending text-sm" data-chat-thinking>
            <span class="material-symbols-outlined pending-spinner">autorenew</span>
            <span>${((r=t==null?void 0:t.Chat)==null?void 0:r.ThinkingIndicatorText)??"Thinking..."}</span>
          </div>
          ${(e.Content??"").trim().length>0?`
            <div class="assistant-text text-sm text-slate-800">
              ${this.MarkdownRenderer.Render(e.Content??"")}
            </div>
          `:""}
        </div>
      `;if(e.Status==="error"){const o=e.ProviderId??"provider",a=n??e.ModelId??"model";return`
        <div class="assistant-block">
          <div class="assistant-error" data-chat-error>
            <div class="assistant-error-header">Request failed · ${o} / ${a}</div>
            <div class="assistant-error-message">${e.ErrorMessage??"Request failed."}</div>
            <button class="settings-secondary-button" data-action="retry-message" data-message-id="${e.Id}">
              ${(t==null?void 0:t.RetryAction)??"Retry"}
            </button>
          </div>
        </div>
      `}const s=e.Status==="done"?this.RenderAssistantMeta(e,n):"";return`
      <div class="assistant-block">
        <div class="assistant-text text-sm text-slate-800">
          ${this.MarkdownRenderer.Render(e.Content)}
        </div>
        ${s}
      </div>
    `}RenderAssistantMeta(e,t,{Prefix:n}={}){const s=(e==null?void 0:e.Metrics)??{},i=this.FormatDuration(s.DurationMs),r=this.FormatTokenCount(s.InputTokens),o=this.FormatTokenCount(s.OutputTokens),a=t??(e==null?void 0:e.ModelId)??null,c=n?`
        <span>${n}</span>
        <span class="assistant-meta-dot">·</span>
      `:"",u=a?`
        <span>${a}</span>
        <span class="assistant-meta-dot">·</span>
      `:"";return`
      <div class="assistant-meta" data-assistant-meta>
        ${c}
        <span>Time ${i}</span>
        <span class="assistant-meta-dot">·</span>
        ${u}
        <span>In ${r}</span>
        <span class="assistant-meta-dot">·</span>
        <span>Out ${o}</span>
      </div>
    `}ResolveModelLabel(e,t){var o,a,c;const n=(e==null?void 0:e.ProviderId)??null,s=(e==null?void 0:e.ModelId)??null;if(!n||!s)return null;const i=(a=(o=t==null?void 0:t.Providers)==null?void 0:o.Providers)==null?void 0:a.find(u=>u.Id===n),r=(c=i==null?void 0:i.Models)==null?void 0:c.find(u=>u.Id===s);return(r==null?void 0:r.Label)??s}FormatDuration(e){if(typeof e!="number")return"--";const t=Math.max(e,0)/1e3;return t<1?`${Math.round(t*1e3)}ms`:`${t.toFixed(1)}s`}FormatTokenCount(e){return typeof e!="number"?"--":`${e}`}RenderAttachments(e){return e!=null&&e.length?`
      <div class="message-attachments">
        ${e.map(n=>`
      ${this.RenderAttachmentLink(n)}
    `).join("")}
      </div>
    `:""}RenderAttachmentLink(e){const t=this.EscapeHtml((e==null?void 0:e.Name)??"Attachment"),n=this.FormatSize((e==null?void 0:e.SizeBytes)??0),s=this.ResolveAttachmentUrl(e);return s?`
      <a class="message-attachment message-attachment-link" href="${s}" download="${t}">
        ${Y("attach_file","message-attachment-icon")}
        <span class="message-attachment-name">${t}</span>
        <span class="message-attachment-size">${n}</span>
      </a>
    `:`
        <span class="message-attachment message-attachment-link" aria-disabled="true">
          ${Y("attach_file","message-attachment-icon")}
          <span class="message-attachment-name">${t}</span>
          <span class="message-attachment-size">${n}</span>
        </span>
      `}ResolveAttachmentUrl(e){const t=(e==null?void 0:e.DownloadUrl)??null;if(t)return t;const n=(e==null?void 0:e.Blob)??null;if(!n||typeof(URL==null?void 0:URL.createObjectURL)!="function")return null;const s=URL.createObjectURL(n);return e.DownloadUrl=s,s}FormatSize(e){if(!Number.isFinite(e))return"--";if(e<1024)return`${e} B`;const t=e/1024;return t<1024?`${t.toFixed(1)} KB`:`${(t/1024).toFixed(1)} MB`}EscapeHtml(e){return(e??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}}class lr{Render({Attachments:e,Text:t,Mode:n="inline"}){const s=e??[];if(!s.length)return"";const i=s.map(r=>this.RenderItem(r,t,n)).join("");return n==="menu"?`
        <div class="attachments-menu-list">
          ${i}
        </div>
      `:`
      <div class="attachment-list">
        ${i}
      </div>
    `}RenderItem(e,t,n){if(n==="menu")return this.RenderMenuItem(e,t);const s=this.EscapeHtml((e==null?void 0:e.Name)??"Attachment"),i=this.FormatSize((e==null?void 0:e.SizeBytes)??0),r=(e==null?void 0:e.Status)??"pending",o=r==="failed"?(e==null?void 0:e.ErrorMessage)??this.ResolveErrorText(e==null?void 0:e.ErrorCode,t):"",a=o?`<div class="attachment-error">${o}</div>`:"";return`
      <div class="attachment-item" data-attachment-status="${r}">
        <div class="attachment-meta">
          ${Y("attach_file","attachment-icon")}
          <div class="attachment-text">
            <div class="attachment-name">${s}</div>
            <div class="attachment-size">${i}</div>
          </div>
        </div>
        <div class="attachment-actions">
          <button class="icon-button attachment-remove" data-action="remove-attachment" data-attachment-id="${(e==null?void 0:e.AttachmentId)??""}" aria-label="Remove attachment">
            ${Y("close")}
          </button>
        </div>
        ${a}
      </div>
    `}RenderMenuItem(e,t){const n=this.EscapeHtml((e==null?void 0:e.Name)??"Attachment"),s=(e==null?void 0:e.Status)??"pending",i=s==="failed"?(e==null?void 0:e.ErrorMessage)??this.ResolveErrorText(e==null?void 0:e.ErrorCode,t):"",r=i?`<div class="attachments-menu-error">${i}</div>`:"";return`
      <div class="attachments-menu-item attachments-item" data-attachment-status="${s}">
        <span class="attachments-menu-name">
          ${Y("description","attachments-menu-icon")}
          <span class="attachments-menu-filename">${n}</span>
        </span>
        <button class="icon-button attachments-menu-remove" data-action="remove-attachment" data-attachment-id="${(e==null?void 0:e.AttachmentId)??""}" aria-label="Remove attachment">
          ${Y("close")}
        </button>
        ${r}
      </div>
    `}ResolveErrorText(e,t){const n=(t==null?void 0:t.Attachments)??{};return e==="max-count"?n.MaxCountError??"Attachment limit reached.":e==="max-size"?n.MaxSizeError??"File exceeds size limit.":e==="invalid-type"?n.InvalidTypeError??"Unsupported file type.":e==="unsupported"?n.UnsupportedError??"Attachments are not supported.":n.GenericError??"Attachment error."}EscapeHtml(e){return(e??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;")}FormatSize(e){if(!Number.isFinite(e))return"--";if(e<1024)return`${e} B`;const t=e/1024;return t<1024?`${t.toFixed(1)} KB`:`${(t/1024).toFixed(1)} MB`}}class cr{constructor(){this.AttachmentListView=new lr}Render({Text:e,InputText:t="",IsSending:n=!1,SelectedModelId:s,Reasoning:i,DraftAttachments:r=[],AttachmentCapability:o=null}){var y,L;const a=r??[],c=o??null,u=(c==null?void 0:c.SupportsAttachments)!==!1,p=(c==null?void 0:c.AllowedMimeTypes)??[],h=Array.isArray(p)&&p.length>0?p.join(","):"",d=Qe({Icon:"assets/icons/add.svg",Action:"toggle-attachments",AriaLabel:"Attachments",ClassName:"input-attach"}),m=Mt({Material:"attach_file",Action:"attach-files",Label:((y=e.Attachments)==null?void 0:y.AttachFiles)??"Attach files",ClassName:"attachments-item",Disabled:!u}),f=(t??"").trim().length>0,v=(a??[]).length>0,w=Qe(n?{Material:"close",Action:"abort-response",AriaLabel:"Abort",ClassName:"input-send"}:{Material:"keyboard_arrow_up",Action:"send-message",AriaLabel:"Send",ClassName:"input-send",Disabled:!f&&!v||!(s===void 0?!0:!!s)}),A=this.RenderReasoningControls(i,e),x=this.AttachmentListView.Render({Attachments:a,Text:e,Mode:"menu"}),I=u?"":`
        <div class="attachments-row attachments-row-warning">
          <div class="attachments-row-label">
            ${Y("error","attachments-row-icon")}
            <span>${((L=e.Attachments)==null?void 0:L.UnsupportedError)??"Attachments are not supported."}</span>
          </div>
        </div>
      `;return`
      <div class="input-wrapper relative">
        <div class="input-shell" data-input-shell>
          <span class="input-attach-wrapper${v?" input-attach-active":""}">
            ${d}
          </span>
          <textarea
            class="input-text"
            data-action="chat-input"
            rows="1"
            placeholder="${e.InputPlaceholder}"
            aria-label="Chat input"
          >${t}</textarea>
          ${w}
        </div>
        <input
          class="attachment-input hidden"
          type="file"
          multiple
          data-action="attachment-input"
          ${u?"":"disabled"}
          ${h?`accept="${h}"`:""}
        />
        <div class="attachments-menu hidden" data-attachments-menu>
          ${x}
          ${m}
          ${I}
          ${A}
        </div>
      </div>
    `}RenderReasoningControls(e,t){if(!e)return"";const n=(t==null?void 0:t.Chat)??{},s=e.ControlType,i=s==="effort_enum"?this.RenderEffortControl(e,n):s==="token_budget"?this.RenderBudgetControl(e,n):"";return i||""}RenderEffortControl(e,t){var a;const n="off",s=[{Label:t.ReasoningOffLabel??"Off",Value:n,Data:{action:"select-reasoning-effort",value:n}},...(e.Allowed??[]).map(c=>({Label:c,Value:c,Data:{action:"select-reasoning-effort",value:c}}))],i=e.Enabled?e.EffortLevel??((a=s[1])==null?void 0:a.Value)??null:n,r=i??t.ReasoningOffLabel??"Off",o=Zt({MenuId:"reasoning-effort",ButtonContent:`
        <span>${r}</span>
        <span class="material-symbols-outlined">expand_more</span>
      `,Items:s,SelectedValue:i});return`
      <div class="attachments-row">
        <div class="attachments-row-label">\r
          ${Y("neurology","attachments-row-icon")}\r
          <span>${t.ReasoningEffortLabel??"Reasoning"}</span>\r
        </div>
        <div class="attachments-row-control">${o}</div>
      </div>
    `}RenderBudgetControl(e,t){const n=e.TokenBudget??"";return`
      <div class="attachments-row">
        <div class="attachments-row-label">\r
          ${Y("neurology","attachments-row-icon")}\r
          <span>${t.ReasoningBudgetLabel??"Reasoning"}</span>\r
        </div>
        <div class="attachments-row-control">
          <input
            class="attachments-input"
            type="number"
            min="0"
            inputmode="numeric"
            data-action="update-reasoning-budget"
            value="${n}"
            placeholder="0"
          />
        </div>
      </div>
    `}}class ur{constructor({DurationMs:e}){this.DurationMs=e,this.Container=null,this.MessageNode=null,this.TimeoutId=null}Render(){return`
      <div class="pointer-events-none fixed inset-x-0 bottom-6 z-50 flex justify-center">
        <div
          data-snackbar
          class="snackbar-hidden rounded-full bg-slate-900 px-4 py-2 text-sm text-white shadow-lg transition-all duration-200"
          role="status"
          aria-live="polite"
        >
          <span data-snackbar-message></span>
        </div>
      </div>
    `}Mount(e){this.Container=e.querySelector("[data-snackbar]"),this.MessageNode=e.querySelector("[data-snackbar-message]")}Show(e){!this.Container||!this.MessageNode||(this.MessageNode.textContent=e,this.Container.classList.remove("snackbar-hidden"),this.Container.classList.add("snackbar-visible"),this.TimeoutId&&clearTimeout(this.TimeoutId),this.TimeoutId=setTimeout(()=>{this.Container.classList.remove("snackbar-visible"),this.Container.classList.add("snackbar-hidden")},this.DurationMs))}}const dr=[{Id:"general",Label:"General",IconMaterial:"tune"},{Id:"chat",Label:"Chat",IconMaterial:"chat_bubble"},{Id:"providers",Label:"Providers",IconMaterial:"hub"}];class hr{Render(e){const t=e.ActiveCategory,n=e.Options.Accents.find(r=>r.Id===e.General.AccentColor)??e.Options.Accents[0],s=e.Options.Themes.find(r=>r.Id===e.General.Theme)??e.Options.Themes[0],i=dr.map(r=>`
      <button
        class="settings-nav-item ${r.Id===t?"is-active":""}"
        data-action="settings-category"
        data-category="${r.Id}"
      >
        <span class="settings-nav-icon">
          ${Y(r.IconMaterial)}
        </span>
        ${r.Label}
      </button>
    `).join("");return`
      <div class="settings-overlay ${e.IsOpen?"":"hidden"}" data-settings-overlay>
        <div class="settings-backdrop" data-action="close-settings" aria-hidden="true"></div>
        <div class="settings-panel" role="dialog" aria-modal="true" aria-label="Settings">
          <div class="settings-body">
            <aside class="settings-nav">
              ${Qe({Material:"close",Action:"close-settings",AriaLabel:"Close settings",ClassName:"settings-close"})}
              ${i}
            </aside>
            <section class="settings-content">
              ${this.RenderCategory(e,{activeAccent:n,activeTheme:s})}
            </section>
          </div>
        </div>
      </div>
    `}RenderCategory(e,t){return e.ActiveCategory==="providers"?this.RenderProviders(e.Providers):e.ActiveCategory==="chat"?this.RenderChat(e):this.RenderGeneral(e,t)}RenderGeneral(e,{activeAccent:t,activeTheme:n}){const s=e.Options.Themes.map(a=>({Label:a.Label,Value:a.Id,Data:{action:"select-settings-option",field:"theme",value:a.Id}})),i=e.Options.Accents.map(a=>({Label:a.Label,Value:a.Id,LeadingHtml:`<span class="accent-swatch" style="--accent-swatch: ${a.Hex};"></span>`,Data:{action:"select-settings-option",field:"accent",value:a.Id}})),r=Zt({MenuId:"theme",ButtonContent:`
        <span>${n.Label}</span>
        ${Y("expand_more")}
      `,Items:s,SelectedValue:n.Id}),o=Zt({MenuId:"accent",ButtonContent:`
        <span class="accent-swatch" style="--accent-swatch: ${t.Hex};"></span>
        <span>${t.Label}</span>
        ${Y("expand_more")}
      `,Items:i,SelectedValue:t.Id});return`
      <div class="settings-section">
        ${yt("Appearance")}
        <div class="settings-row">
          <div class="settings-row-label">Theme</div>
          <div class="settings-row-control">
            ${r}
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-row-label">Accent Colour</div>
          <div class="settings-row-control">
            ${o}
          </div>
        </div>
      </div>
    `}RenderChat(e){var s,i;const t=On({Checked:e.Chat.InternalChatMessages,Data:{action:"toggle-internal-messages"}}),n=(i=(s=e.Chat)==null?void 0:s.Requests)==null?void 0:i.MaxOutputTokens;return`
      <div class="settings-section">
        ${yt("Chat")}
        <div class="settings-row">
          <div class="settings-row-label">Internal chat messages</div>
          <div class="settings-row-control">
            ${t}
          </div>
        </div>
        <div class="settings-row settings-row-stack settings-row-borderless">
          <div class="settings-row-label">Max output tokens</div>
          <div class="settings-row-control">
            <div class="settings-input-row">
              <div class="settings-input-wrap">
                <input
                  type="number"
                  min="1"
                  class="settings-input"
                  placeholder="Provider default"
                  value="${n??""}"
                  data-action="update-chat-max-output"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    `}RenderProviders(e){var r,o;if(!e.SelectedProviderId)return this.RenderProviderList(e.Providers);const t=e.Providers.find(a=>a.Id===e.SelectedProviderId);if(!t)return this.RenderProviderList(e.Providers);const n=e.Keys[t.Id]??"",s=((r=e.KeyVisibility)==null?void 0:r[t.Id])??!1,i=((o=e.ModelAvailability)==null?void 0:o[t.Id])??null;return this.RenderProviderDetail(t,n,s,i,e.RequestOverrides)}RenderProviderList(e){const t=e.map(n=>`
      <button class="provider-row" data-action="select-provider" data-provider-id="${n.Id}">
        <span class="provider-icon">
          ${Et({Icon:n.Icon})}
        </span>
        <span class="provider-name">${n.Name}</span>
        <span class="provider-arrow">
          ${Y("chevron_right")}
        </span>
      </button>
    `).join("");return`
      <div class="settings-section">
        ${yt("Providers")}
        <div class="provider-list">
          ${t}
        </div>
      </div>
    `}RenderProviderDetail(e,t,n,s,i){var u,p;const r=n?"text":"password",o=n?"visibility_off":"visibility",a=((p=(u=i==null?void 0:i[e.Id])==null?void 0:u.Requests)==null?void 0:p.MaxOutputTokens)??null,c=e.Models.map(h=>{const d=s==null?void 0:s[h.Id],m=s?!d:!0,f=On({Checked:h.Enabled,Disabled:m,Data:{action:"toggle-provider-model","provider-id":e.Id,"model-id":h.Id}});return`
        <div class="${m?"model-row is-unavailable":h.Enabled?"model-row":"model-row is-disabled"}">
          <div class="model-info">
            <div class="model-name">${h.Label}</div>
            <div class="model-description">${h.Description??""}</div>
          </div>
          ${f}
        </div>
      `}).join("");return`
      <div class="settings-section">
        <button class="provider-back" data-action="back-provider" type="button">
          ${Y("arrow_back")}
          <span>Back</span>
        </button>
        ${yt(`${e.Name} Provider Details`)}
        <div class="settings-row settings-row-stack settings-row-borderless">
          <div class="settings-row-label">API Key</div>
          <div class="settings-row-control">
            <div class="settings-input-row">
              <div class="settings-input-wrap">
                <input
                  type="${r}"
                  class="settings-input"
                  placeholder="Paste your key"
                  value="${t}"
                  data-action="update-provider-key"
                  data-provider-id="${e.Id}"
                />
                <button
                  class="settings-input-icon"
                  data-action="toggle-provider-key-visibility"
                  data-provider-id="${e.Id}"
                  type="button"
                  aria-label="Toggle key visibility"
                >
                  ${Y(o)}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-row settings-row-stack settings-row-borderless">
          <div class="settings-row-label">Max output tokens</div>
          <div class="settings-row-control">
            <div class="settings-input-row">
              <div class="settings-input-wrap">
                <input
                  type="number"
                  min="1"
                  class="settings-input"
                  placeholder="Provider default"
                  value="${a??""}"
                  data-action="update-provider-max-output"
                  data-provider-id="${e.Id}"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="settings-divider"></div>
        <div class="settings-subsection-header">
          <div class="settings-subsection-title">Available models</div>
          <button class="settings-secondary-button" data-action="test-provider-key" data-provider-id="${e.Id}" type="button">
            <span>Test</span>
          </button>
        </div>
        <div class="model-list">
          ${c}
        </div>
      </div>
    `}}const ge=l=>(l??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),pr=({ExcerptText:l,ExcerptMatchStart:e,ExcerptMatchEnd:t})=>{const n=(l??"").toString(),s=Math.max(0,e??0),i=Math.max(s,t??s),r=n.slice(0,s),o=n.slice(s,i),a=n.slice(i);return`${ge(r)}<mark class="chat-search-highlight">${ge(o)}</mark>${ge(a)}`};class gr{Render({ChatSearch:e,Text:t}={}){const n=(e==null?void 0:e.IsOpen)===!0,s=(t==null?void 0:t.ChatSearch)??{},i=(e==null?void 0:e.Query)??"",r=(e==null?void 0:e.Results)??[],o=(e==null?void 0:e.Error)??null,a=Qe({Icon:"assets/icons/close.svg",Action:"close-chat-search",AriaLabel:s.CloseAriaLabel??"Close search",ClassName:"chat-search-close"}),c=o?`<div class="chat-search-empty">${ge(s.ErrorText??"Couldn't load pinned chats.")}</div>`:(i??"").trim().length===0?`<div class="chat-search-empty">${ge(s.EmptyStateText??"Type to search your pinned chats.")}</div>`:r.length===0?`<div class="chat-search-empty">${ge(s.NoResultsText??"No matches found.")}</div>`:`
                <div class="chat-search-results-list">
                  ${r.map(u=>`
                    <button
                      class="two-line-item conversation-item chat-search-result"
                      type="button"
                      data-action="select-chat-search-result"
                      data-conversation-id="${ge(u.ConversationId)}"
                    >
                      <img src="assets/icons/chat_bubble_outline.svg" alt="" class="two-line-icon" />
                      <span class="two-line-text">
                        <span class="two-line-title">${ge(u.Title??"")}</span>
                        <span class="two-line-subtitle chat-search-excerpt">${pr(u)}</span>
                      </span>
                    </button>
                  `).join("")}
                </div>
              `;return`
      <div class="settings-overlay chat-search-overlay ${n?"":"hidden"}" data-chat-search-overlay>
        <div class="settings-backdrop" data-action="close-chat-search" aria-hidden="true"></div>
        <div class="settings-panel chat-search-panel" role="dialog" aria-modal="true" aria-label="${ge(s.Title??"Search chats")}">
          <div class="chat-search-header">
            <input
              class="chat-search-input"
              type="text"
              value="${ge(i)}"
              placeholder="${ge(s.Placeholder??"")}"
              data-action="chat-search-query"
              data-chat-search-input="true"
              spellcheck="false"
              autocomplete="off"
            />
            ${a}
          </div>
          <div class="chat-search-divider"></div>
          <div class="chat-search-results">
            ${c}
          </div>
        </div>
      </div>
    `}}const mr=l=>{Object.assign(l.prototype,{CloseMenus({KeepAttachments:e=!1}={}){const t=this.Container;if(!t)return;const n=t.querySelector("[data-model-menu]"),s=t.querySelector('[data-action="toggle-models"]'),i=t.querySelector("[data-attachments-menu]");n&&n.classList.add("hidden"),s&&s.setAttribute("aria-expanded","false"),i&&!e&&i.classList.add("hidden"),t.querySelectorAll("[data-settings-menu]").forEach(r=>{r.classList.add("hidden")}),t.querySelectorAll('[data-action="toggle-settings-menu"]').forEach(r=>{r.setAttribute("aria-expanded","false")})},HandleClick(e){var o,a,c,u,p,h,d,m,f,v,S,w,A,x,I,P,y,L,H,M,C,$,B,Q,Ce,O,oe,ee,Ae,Re,F,Le,G,Ee,N,he,Ie,le,De,ke,$e,Oe,ce;const t=this.Container;if(!t)return;const n=(a=(o=e.target)==null?void 0:o.closest)==null?void 0:a.call(o,"[data-action]");if(!n||!t.contains(n))return;const s=n.getAttribute("data-action"),i=this.LatestHandlers??{},r=this.LatestViewModel??{};if(s==="toggle-sidebar"){(c=i.onToggleSidebar)==null||c.call(i);return}if(s==="toggle-models"){const k=t.querySelector("[data-model-menu]");if(!k)return;const q=k.classList.contains("hidden");this.CloseMenus(),k.classList.toggle("hidden",!q),n.setAttribute("aria-expanded",q?"true":"false");return}if(s==="toggle-settings-menu"){const k=n.getAttribute("data-menu-id"),q=k?t.querySelector(`[data-settings-menu][data-menu-id="${k}"]`):null;if(!q)return;const xe=q.classList.contains("hidden");this.CloseMenus({KeepAttachments:!0}),q.classList.toggle("hidden",!xe),n.setAttribute("aria-expanded",xe?"true":"false");return}if(s==="toggle-attachments"){const k=t.querySelector("[data-attachments-menu]");if(!k)return;const q=k.classList.contains("hidden");this.CloseMenus(),k.classList.toggle("hidden",!q);return}if(s==="select-model"){const k=n.getAttribute("data-model-id");k&&(i.onSelectModel?i.onSelectModel(k):(p=this.Snackbar)==null||p.Show((u=r.Text)==null?void 0:u.NotImplemented)),this.CloseMenus();return}if(s==="new-chat"){this.ChatSavingRestoreFocusSelector='[data-action="new-chat"]',i.onStartNewChat?i.onStartNewChat():(d=this.Snackbar)==null||d.Show((h=r.Text)==null?void 0:h.NotImplemented),this.CloseMenus();return}if(s==="search-chats"){this.ChatSearchRestoreFocusSelector='[data-action="search-chats"]',(m=i.onOpenChatSearch)==null||m.call(i),this.CloseMenus();return}if(s==="close-chat-search"){(f=i.onCloseChatSearch)==null||f.call(i),this.CloseMenus();return}if(s==="select-chat-search-result"){const k=n.getAttribute("data-conversation-id");k&&(this.ChatSearchRestoreFocusSelector='[data-action="chat-input"]',(v=i.onSelectChatSearchResult)==null||v.call(i,k));return}if(s==="attach-files"){const k=t.querySelector('[data-action="attachment-input"]');k&&!k.disabled?(k.click(),(S=i.onRequestAttachmentSelect)==null||S.call(i)):(I=this.Snackbar)==null||I.Show(((A=(w=r.Text)==null?void 0:w.Attachments)==null?void 0:A.UnsupportedError)??((x=r.Text)==null?void 0:x.NotImplemented)),this.CloseMenus();return}if(s==="remove-attachment"){const k=n.getAttribute("data-attachment-id");k&&((P=i.onRemoveAttachment)==null||P.call(i,k));return}if(s==="select-reasoning-effort"){const k=n.getAttribute("data-value");k&&((y=i.onSelectReasoningEffort)==null||y.call(i,k)),this.CloseMenus();return}if(s==="select-reasoning-toggle"){const k=n.getAttribute("data-value");k&&((L=i.onSelectReasoningToggle)==null||L.call(i,k)),this.CloseMenus();return}if(s==="toggle-pin"){this.ChatSavingRestoreFocusSelector='[data-action="toggle-pin"]',(H=i.onTogglePin)==null||H.call(i),this.CloseMenus();return}if(s==="open-settings"){(M=i.onOpenSettings)==null||M.call(i),this.CloseMenus();return}if(s==="select-conversation"){const k=n.getAttribute("data-conversation-id");k&&(this.ChatSavingRestoreFocusSelector=`[data-action="select-conversation"][data-conversation-id="${k}"]`,(C=i.onSelectConversation)==null||C.call(i,k));return}if(s==="send-message"){($=i.onSendMessage)==null||$.call(i);const k=(B=this.Container)==null?void 0:B.querySelector('[data-action="chat-input"]');k&&(k.value="",this.ResizeChatInput(),this.UpdateInputActionButtonState(this.LatestViewModel,k.value));return}if(s==="abort-response"){(Q=i.onAbortSend)==null||Q.call(i);return}if(s==="close-settings"){(Ce=i.onCloseSettings)==null||Ce.call(i),this.CloseMenus();return}if(s==="settings-category"){const k=n.getAttribute("data-category");k&&((O=i.onSelectSettingsCategory)==null||O.call(i,k));return}if(s==="select-settings-option"){const k=n.getAttribute("data-field"),q=n.getAttribute("data-value");k==="theme"&&((oe=i.onUpdateTheme)==null||oe.call(i,q)),k==="accent"&&((ee=i.onUpdateAccent)==null||ee.call(i,q)),this.CloseMenus();return}if(s==="select-provider"){const k=n.getAttribute("data-provider-id");k&&((Ae=i.onSelectProvider)==null||Ae.call(i,k));return}if(s==="back-provider"){(Re=i.onBackToProviders)==null||Re.call(i);return}if(s==="clear-provider-key"){const k=n.getAttribute("data-provider-id");k&&((F=i.onClearProviderKey)==null||F.call(i,k));return}if(s==="toggle-provider-key-visibility"){const k=n.getAttribute("data-provider-id");k&&((Le=i.onToggleProviderKeyVisibility)==null||Le.call(i,k));return}if(s==="test-provider-key"){const k=n.getAttribute("data-provider-id");k&&((G=i.onTestProviderKey)==null||G.call(i,k));return}if(s==="close-provider-validation"){(Ee=i.onCloseProviderValidationPopup)==null||Ee.call(i);return}if(s==="retry-message"){const k=n.getAttribute("data-message-id");k&&((N=i.onRetryMessage)==null||N.call(i,k));return}if(s==="toggle-internal-group"){const k=n.getAttribute("data-group-id");k&&((he=i.onToggleInternalGroup)==null||he.call(i,k));return}if(s==="close-retry-popup"){(Ie=i.onCloseRetryPopup)==null||Ie.call(i);return}if(s==="retry-use-original"){(le=i.onConfirmRetry)==null||le.call(i,!1);return}if(s==="retry-use-selected"){(De=i.onConfirmRetry)==null||De.call(i,!0);return}if(s==="cancel-pin"){(ke=i.onCancelPin)==null||ke.call(i);return}if(s==="confirm-pin"){($e=i.onConfirmPin)==null||$e.call(i);return}if(s==="cancel-discard"){(Oe=i.onCancelDiscard)==null||Oe.call(i);return}s==="confirm-discard"&&((ce=i.onConfirmDiscard)==null||ce.call(i))},HandleInput(e){var i,r,o,a,c,u,p,h;const t=e.target;if(!(t!=null&&t.getAttribute))return;const n=t.getAttribute("data-action"),s=this.LatestHandlers??{};if(n==="chat-input"){this.ResizeChatInput(),(i=s.onUpdateInput)==null||i.call(s,t.value),this.UpdateInputActionButtonState(this.LatestViewModel,t.value);return}if(n==="chat-search-query"){(r=s.onUpdateChatSearchQuery)==null||r.call(s,t.value??"");return}if(n==="update-chat-max-output"){(o=s.onUpdateChatMaxOutput)==null||o.call(s,t.value);return}if(n==="update-provider-max-output"){const d=t.getAttribute("data-provider-id");d&&((a=s.onUpdateProviderMaxOutputTokens)==null||a.call(s,d,t.value));return}if(n==="update-provider-key"){const d=t.getAttribute("data-provider-id");d&&((c=s.onUpdateProviderKey)==null||c.call(s,d,t.value));return}if(n==="pin-name"){const d=(u=this.Container)==null?void 0:u.querySelector("[data-chat-saving-pin-error]");d&&(d.classList.add("hidden"),d.textContent=""),(p=s.onUpdatePinName)==null||p.call(s,t.value)}n==="update-reasoning-budget"&&((h=s.onUpdateReasoningBudget)==null||h.call(s,t.value??""))},HandleChange(e){var i,r,o,a;const t=e.target;if(!(t!=null&&t.getAttribute))return;const n=t.getAttribute("data-action"),s=this.LatestHandlers??{};if(n==="toggle-provider-model"){const c=t.getAttribute("data-provider-id"),u=t.getAttribute("data-model-id");c&&u&&((i=s.onToggleProviderModel)==null||i.call(s,c,u,t.checked));return}if(n==="toggle-internal-messages"&&((r=s.onToggleInternalMessages)==null||r.call(s,t.checked)),n==="toggle-reasoning"&&((o=s.onToggleReasoning)==null||o.call(s,t.checked)),n==="attachment-input"){const c=t.files;c&&c.length>0&&((a=s.onAddAttachments)==null||a.call(s,c)),t.value="";return}},HandleKeydown(e){var s,i,r,o,a,c;if(e.isComposing)return;const t=e.target;if(!(t!=null&&t.getAttribute))return;const n=t.getAttribute("data-action");if(n==="chat-input"){if((s=this.LatestViewModel)!=null&&s.IsSending||e.key!=="Enter"||e.shiftKey)return;const u=(t.value??"").trim().length>0,p=(((i=this.LatestViewModel)==null?void 0:i.DraftAttachments)??[]).length>0;if(!u&&!p||!this.HasSelectedModel(this.LatestViewModel))return;e.preventDefault(),(o=(r=this.LatestHandlers)==null?void 0:r.onSendMessage)==null||o.call(r),t.value="",this.ResizeChatInput(),this.UpdateInputActionButtonState(this.LatestViewModel,t.value);return}if(n==="select-chat-search-result"&&e.key==="Enter"){const u=t.getAttribute("data-conversation-id");if(!u)return;e.preventDefault(),(c=(a=this.LatestHandlers)==null?void 0:a.onSelectChatSearchResult)==null||c.call(a,u)}}})},fr=l=>{Object.assign(l.prototype,{SetupChatInputSizing(){this.TextMeasureCanvas=this.TextMeasureCanvas??document.createElement("canvas"),this.ResizeChatInput()},ResizeChatInput(){var a,c,u,p,h,d,m;const e=(a=this.Container)==null?void 0:a.querySelector('[data-action="chat-input"]'),t=(c=this.Container)==null?void 0:c.querySelector("[data-input-shell]");if(!e||!t)return;const s=(Number.parseFloat(getComputedStyle(e).lineHeight)||20)*(((p=(u=this.LatestViewModel)==null?void 0:u.Layout)==null?void 0:p.InputMaxLines)??10);let i=!1;const r=e.value??"";if(i=r.includes(`
`),!i&&!this.DisableCanvasTextMeasure&&!this.CanvasTextMeasureFailed)try{const f=this.TextMeasureCanvas??document.createElement("canvas");this.TextMeasureCanvas=f;const v=(h=f.getContext)==null?void 0:h.call(f,"2d");if(!v)this.CanvasTextMeasureFailed=!0;else{const S=getComputedStyle(e),w=S.font||`${S.fontStyle} ${S.fontVariant} ${S.fontWeight} ${S.fontSize} / ${S.lineHeight} ${S.fontFamily}`;v.font=w;const A=getComputedStyle(t),x=Number.parseFloat(getComputedStyle(document.documentElement).fontSize)||16,I=B=>{if(!B)return 0;if(B.endsWith("px"))return Number.parseFloat(B);if(B.endsWith("rem"))return Number.parseFloat(B)*x;const Q=Number.parseFloat(B);return Number.isNaN(Q)?0:Q},P=I(A.paddingLeft),y=I(A.paddingRight),L=I(A.columnGap||A.gap||"0px"),H=((d=t.querySelector(".input-attach"))==null?void 0:d.offsetWidth)??0,M=((m=t.querySelector(".input-send"))==null?void 0:m.offsetWidth)??0,C=Math.max(t.clientWidth-P-y-H-M-L*2,0);i=Math.max(...r.split(`
`).map(B=>v.measureText(B).width),0)+2>C}}catch{this.CanvasTextMeasureFailed=!0}t.classList.toggle("input-multiline",i),e.style.height="auto";const o=Math.min(e.scrollHeight,s);e.style.height=`${o}px`,e.style.overflowY=e.scrollHeight>s?"auto":"hidden"},SyncChatInput(e){var s,i;const t=(s=this.Container)==null?void 0:s.querySelector('[data-action="chat-input"]');if(!t)return;const n=((i=e.Text)==null?void 0:i.InputPlaceholder)??"";n&&t.getAttribute("placeholder")!==n&&t.setAttribute("placeholder",n),document.activeElement!==t&&(t.value??"")!==(e.InputText??"")&&(t.value=e.InputText??"",this.ResizeChatInput()),this.EnsureInputActionButtonMode(e),this.UpdateInputActionButtonState(e,t.value??"")},EnsureInputActionButtonMode(e){var o,a,c,u;const t=(o=this.Container)==null?void 0:o.querySelector(".input-send");if(!t)return;const n=!!(e!=null&&e.IsSending),s=n?"abort-response":"send-message";(((a=t.getAttribute)==null?void 0:a.call(t,"data-action"))??"")!==s&&t.setAttribute("data-action",s),t.setAttribute("aria-label",n?"Abort":"Send");const r=(c=t.querySelector)==null?void 0:c.call(t,".material-symbols-outlined");if(r){const p=n?"close":"keyboard_arrow_up";(r.textContent??"").trim()!==p&&(r.textContent=p)}n&&(t.disabled=!1,(u=t.removeAttribute)==null||u.call(t,"disabled"))},HasSelectedModel(e){var n;const t=(e==null?void 0:e.SelectedModelId)??((n=e==null?void 0:e.ModelSelector)==null?void 0:n.SelectedModelId);return t===void 0?!0:!!t},UpdateInputActionButtonState(e,t){var a,c;const n=(a=this.Container)==null?void 0:a.querySelector(".input-send");if(!n)return;const s=((c=n.getAttribute)==null?void 0:c.call(n,"data-action"))??"";if(s==="abort-response"){n.disabled=!1;return}if(s!=="send-message")return;const i=(t??"").trim().length>0,r=((e==null?void 0:e.DraftAttachments)??[]).length>0,o=this.HasSelectedModel(e);n.disabled=!!(e!=null&&e.IsSending)||!i&&!r||!o}})},Sr=l=>{Object.assign(l.prototype,{CaptureChatSearchEditingState(){if(!this.Container)return null;const e=this.Container.querySelector("[data-chat-search-input]");return!e||document.activeElement!==e?null:{SelectionStart:typeof e.selectionStart=="number"?e.selectionStart:null,SelectionEnd:typeof e.selectionEnd=="number"?e.selectionEnd:null}},RestoreChatSearchEditingState(e,t){var s;if(!this.Container||!e||((s=t.ChatSearch)==null?void 0:s.IsOpen)!==!0)return;const n=this.Container.querySelector("[data-chat-search-input]");n&&(n.focus(),typeof n.setSelectionRange=="function"&&e.SelectionStart!=null&&n.setSelectionRange(e.SelectionStart,e.SelectionEnd??e.SelectionStart))},UpdateModalKeyHandlers(e){var i,r,o,a,c,u,p;this.RetryKeyHandler&&(document.removeEventListener("keydown",this.RetryKeyHandler),this.RetryKeyHandler=null),(i=e.RetryPopup)!=null&&i.IsOpen&&(this.RetryKeyHandler=h=>{var d,m;h.key==="Enter"&&(h.preventDefault(),(m=(d=this.LatestHandlers)==null?void 0:d.onConfirmRetry)==null||m.call(d,!0))},document.addEventListener("keydown",this.RetryKeyHandler)),this.ChatSavingKeyHandler&&(document.removeEventListener("keydown",this.ChatSavingKeyHandler),this.ChatSavingKeyHandler=null);const t=((o=(r=e.ChatSaving)==null?void 0:r.PinDialog)==null?void 0:o.IsOpen)===!0,n=((c=(a=e.ChatSaving)==null?void 0:a.DiscardDialog)==null?void 0:c.IsOpen)===!0;(t||n)&&(this.ChatSavingKeyHandler=h=>{var d,m,f,v,S,w,A,x;h.isComposing||(h.key==="Escape"&&(h.preventDefault(),t?(m=(d=this.LatestHandlers)==null?void 0:d.onCancelPin)==null||m.call(d):n&&((v=(f=this.LatestHandlers)==null?void 0:f.onCancelDiscard)==null||v.call(f))),h.key==="Enter"&&(h.preventDefault(),t?(w=(S=this.LatestHandlers)==null?void 0:S.onConfirmPin)==null||w.call(S):n&&((x=(A=this.LatestHandlers)==null?void 0:A.onConfirmDiscard)==null||x.call(A))))},document.addEventListener("keydown",this.ChatSavingKeyHandler)),this.ChatSearchKeyHandler&&(document.removeEventListener("keydown",this.ChatSearchKeyHandler),this.ChatSearchKeyHandler=null),((u=e.ChatSearch)==null?void 0:u.IsOpen)===!0&&!(t||n)&&!((p=e.RetryPopup)!=null&&p.IsOpen)&&(this.ChatSearchKeyHandler=h=>{var d,m;h.isComposing||h.key==="Escape"&&(h.preventDefault(),(m=(d=this.LatestHandlers)==null?void 0:d.onCloseChatSearch)==null||m.call(d))},document.addEventListener("keydown",this.ChatSearchKeyHandler))},UpdateChatSavingFocus(e){var i,r,o,a,c,u,p,h,d,m,f,v;const t=((r=(i=e.ChatSaving)==null?void 0:i.PinDialog)==null?void 0:r.IsOpen)===!0,n=((a=(o=e.ChatSaving)==null?void 0:o.DiscardDialog)==null?void 0:a.IsOpen)===!0,s=t||n;if(t){const S=(c=this.Container)==null?void 0:c.querySelector('[data-action="pin-name"]');S&&(S.value=((p=(u=e.ChatSaving)==null?void 0:u.PinDialog)==null?void 0:p.Name)??"",S.focus(),(h=S.select)==null||h.call(S))}else if(n){const S=(d=this.Container)==null?void 0:d.querySelector('[data-action="cancel-discard"]');(m=S==null?void 0:S.focus)==null||m.call(S)}else if(this.ChatSavingDialogWasOpen){const S=this.ChatSavingRestoreFocusSelector?(f=this.Container)==null?void 0:f.querySelector(this.ChatSavingRestoreFocusSelector):null;(v=S==null?void 0:S.focus)==null||v.call(S),this.ChatSavingRestoreFocusSelector=null}this.ChatSavingDialogWasOpen=s},UpdateChatSearchFocus(e){var n,s,i,r,o,a;const t=((n=e.ChatSearch)==null?void 0:n.IsOpen)===!0;if(t&&!this.ChatSearchDialogWasOpen){const c=(s=this.Container)==null?void 0:s.querySelector('[data-action="chat-search-query"]');c&&(c.value=((i=e.ChatSearch)==null?void 0:i.Query)??"",c.focus(),(r=c.select)==null||r.call(c))}else if(!t&&this.ChatSearchDialogWasOpen){const c=this.ChatSearchRestoreFocusSelector?(o=this.Container)==null?void 0:o.querySelector(this.ChatSearchRestoreFocusSelector):null;(a=c==null?void 0:c.focus)==null||a.call(c),this.ChatSearchRestoreFocusSelector=null}this.ChatSearchDialogWasOpen=t}})},vr=l=>{Object.assign(l.prototype,{BuildChatBodyKey({ConversationId:e,Messages:t,MessageGroups:n,InternalMessagesEnabled:s}){const i=(t??[])[t.length-1]??null,r=[e??"",`${(t==null?void 0:t.length)??0}`,`${(n==null?void 0:n.length)??0}`,s?"1":"0",(i==null?void 0:i.Id)??"",(i==null?void 0:i.Status)??"",`${((i==null?void 0:i.Content)??"").length}`].join("|");if(!s)return r;const o=(n??[]).map(a=>`${a.Id}:${a.InternalVisible?"1":"0"}`).join(";");return`${r}|${o}`},UpdateHeaderElevation(){var n,s;const e=(n=this.Container)==null?void 0:n.querySelector("[data-header]"),t=(s=this.Dom)==null?void 0:s.ChatScroll;!e||!t||e.classList.toggle("header-elevated",t.scrollTop>0)},RenderValidationPopup(e){if(!(e!=null&&e.IsOpen))return"";const t=e.Status??"pending",n=t==="success"?"is-success":t==="failure"?"is-failure":"",s=t==="success"?"check_circle":t==="failure"?"error":"autorenew",i=t==="pending"?"provider-validation-spinner":"",r=e.Message??"",o=t==="pending"&&e.TotalModels&&e.CurrentIndex!=null,a=o?Math.round((e.CurrentIndex+1)/e.TotalModels*100):0;return`
        <div class="provider-validation-overlay">
          <div class="provider-validation-backdrop" data-action="close-provider-validation" aria-hidden="true"></div>
          <div class="provider-validation-dialog ${n}" role="dialog" aria-modal="true" aria-label="Provider validation">
            <div class="provider-validation-title">
              <span class="material-symbols-outlined ${i}">${s}</span>
              <span>Provider validation</span>
            </div>
            <div class="provider-validation-message">${r}</div>
            ${o?`
            <div class="provider-validation-progress">
              <div class="provider-validation-progress-bar" style="width: ${a}%;"></div>
            </div>
            <div class="provider-validation-current">Testing: ${e.CurrentModel??"..."}</div>
            `:""}
            <div class="provider-validation-actions">
              <button class="settings-primary-button" data-action="close-provider-validation" type="button">Close</button>
            </div>
          </div>
        </div>
      `},RenderRetryPopup(e,t){return e!=null&&e.IsOpen?`
        <div class="settings-overlay">
          <div class="settings-backdrop" data-action="close-retry-popup"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="Retry confirmation">
            <div class="settings-dialog-body">
              <div class="settings-form-title">${(t==null?void 0:t.RetryConfirmTitle)??"Use the newly selected model?"}</div>
              <div class="settings-dialog-message">
                ${(t==null?void 0:t.RetryConfirmMessage)??""}
              </div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="retry-use-original" type="button">
                ${(t==null?void 0:t.RetryConfirmNo)??"No"}
              </button>
              <button class="settings-primary-button" data-action="retry-use-selected" type="button">
                ${(t==null?void 0:t.RetryConfirmYes)??"Yes"}
              </button>
            </div>
          </div>
        </div>
      `:""},RenderPinDialog(e,t){if(!(e!=null&&e.IsOpen))return"";const n=(t==null?void 0:t.ChatSaving)??{},s=n.PinDialogTitle??"",i=n.PinDialogPlaceholder??"",r=n.PinDialogOk??"",o=n.PinDialogCancel??"",a=e.ErrorText??"";return`
        <div class="settings-overlay" data-chat-saving-dialog="pin">
          <div class="settings-backdrop" data-action="cancel-pin"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="${s}">
            <div class="settings-dialog-body">
              <div class="settings-form-title">${s}</div>
              <input class="settings-input" data-action="pin-name" type="text" placeholder="${i}" aria-label="${i}" />
              <div class="mt-2 text-sm font-medium text-red-600 ${a?"":"hidden"}" data-chat-saving-pin-error>${a}</div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="cancel-pin" type="button">
                ${o}
              </button>
              <button class="settings-primary-button" data-action="confirm-pin" type="button">
                ${r}
              </button>
            </div>
          </div>
        </div>
      `},RenderDiscardDialog(e,t){if(!(e!=null&&e.IsOpen))return"";const n=(t==null?void 0:t.ChatSaving)??{},s=n.DiscardPromptText??"",i=n.DiscardOk??"",r=n.DiscardCancel??"";return`
        <div class="settings-overlay" data-chat-saving-dialog="discard">
          <div class="settings-backdrop" data-action="cancel-discard"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="${s}">
            <div class="settings-dialog-body">
              <div class="settings-dialog-message" data-chat-saving-discard-message>${s}</div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="cancel-discard" type="button">
                ${r}
              </button>
              <button class="settings-primary-button" data-action="confirm-discard" type="button">
                ${i}
              </button>
            </div>
          </div>
        </div>
      `}})};class Fe{static IsJsDomEnvironment(){return typeof navigator>"u"||typeof navigator.userAgent!="string"?!1:navigator.userAgent.toLowerCase().includes("jsdom")}constructor(){this.SidebarView=new Xs,this.ModelSelectorView=new ei,this.ChatThreadView=new ar,this.InputBarView=new cr,this.SettingsView=new hr,this.ChatSearchView=new gr,this.Container=null,this.Dom=null,this.IsMounted=!1,this.Snackbar=null,this.TextMeasureCanvas=null,this.DisableCanvasTextMeasure=Fe.IsJsDomEnvironment(),this.CanvasTextMeasureFailed=!1,this.LastConversationId=null,this.LastScrollTop=null,this.ChatSavingDialogWasOpen=!1,this.ChatSavingRestoreFocusSelector=null,this.ChatSearchDialogWasOpen=!1,this.ChatSearchRestoreFocusSelector=null,this.LastSidebarHtml=null,this.LastModelSelectorHtml=null,this.LastHeaderActionsHtml=null,this.LastChatBodyKey=null,this.LastInputBarHtml=null,this.LastOverlaysHtml=null,this.LatestViewModel=null,this.LatestHandlers={},this.DocumentClickHandler=null,this.ScrollHandler=null,this.RetryKeyHandler=null,this.ChatSavingKeyHandler=null,this.ChatSearchKeyHandler=null}Render(e,t,n={}){e&&(this.LatestViewModel=t,this.LatestHandlers=n??{},this.EnsureMounted(e,t),this.Update(t))}EnsureMounted(e,t){var n,s;this.IsMounted||(this.Container=e,this.Container.innerHTML=`
      <div class="shell-root app-surface flex h-screen" data-shell data-collapsed="false">
        <div data-slot="sidebar"></div>
        <section class="main-pane flex min-w-0 flex-1 flex-col">
          <header class="app-header app-pad-x app-pad-top" data-header>
            <div class="flex w-full items-center gap-4">
              <div data-slot="model-selector"></div>
              <div class="ml-auto flex items-center gap-2" data-slot="header-actions"></div>
            </div>
          </header>
          <main class="relative flex min-h-0 flex-1 flex-col" data-slot="main">
            <div class="chat-scroll flex-1 overflow-y-auto app-pad-x app-pad-top" data-slot="chat-scroll">
              <div class="content-wrap" data-slot="chat-body"></div>
            </div>
            <div class="input-floating">
              <div class="content-wrap" data-slot="input-bar"></div>
            </div>
          </main>
        </section>
        <div data-slot="snackbar"></div>
      </div>
      <div data-slot="overlays"></div>
    `,this.Dom={Shell:this.Container.querySelector("[data-shell]"),SidebarHost:this.Container.querySelector('[data-slot="sidebar"]'),ModelSelectorHost:this.Container.querySelector('[data-slot="model-selector"]'),HeaderActionsHost:this.Container.querySelector('[data-slot="header-actions"]'),Main:this.Container.querySelector('[data-slot="main"]'),ChatScroll:this.Container.querySelector('[data-slot="chat-scroll"]'),ChatBodyHost:this.Container.querySelector('[data-slot="chat-body"]'),InputHost:this.Container.querySelector('[data-slot="input-bar"]'),SnackbarHost:this.Container.querySelector('[data-slot="snackbar"]'),OverlaysHost:this.Container.querySelector('[data-slot="overlays"]')},this.Snackbar=this.Snackbar??new ur({DurationMs:((n=t.Layout)==null?void 0:n.SnackbarDurationMs)??2400}),this.Dom.SnackbarHost.innerHTML=this.Snackbar.Render(),this.Snackbar.Mount(this.Container),this.Container.addEventListener("click",i=>this.HandleClick(i)),this.Container.addEventListener("input",i=>this.HandleInput(i)),this.Container.addEventListener("change",i=>this.HandleChange(i)),this.Container.addEventListener("keydown",i=>this.HandleKeydown(i)),this.DocumentClickHandler=i=>{var o;if(!((o=this.Container)!=null&&o.contains(i.target)))return;const r=i.target;r.closest("[data-model-menu]")||r.closest('[data-action="toggle-models"]')||r.closest("[data-attachments-menu]")||r.closest('[data-action="toggle-attachments"]')||r.closest("[data-settings-menu]")||r.closest('[data-action="toggle-settings-menu"]')||this.CloseMenus()},document.addEventListener("click",this.DocumentClickHandler),this.ScrollHandler=()=>{var i,r,o;this.UpdateHeaderElevation(),this.LastScrollTop=((i=this.Dom.ChatScroll)==null?void 0:i.scrollTop)??this.LastScrollTop,(o=(r=this.LatestHandlers)==null?void 0:r.onScrollConversation)==null||o.call(r,this.LastScrollTop)},(s=this.Dom.ChatScroll)==null||s.addEventListener("scroll",this.ScrollHandler),this.IsMounted=!0)}Update(e){var oe,ee,Ae,Re,F,Le,G,Ee,N,he,Ie,le,De,ke,$e,Oe,ce,k,q,xe;const t=((oe=this.Container.querySelector(".settings-content"))==null?void 0:oe.scrollTop)??0,n=((ee=this.Dom.ChatScroll)==null?void 0:ee.scrollTop)??this.LastScrollTop,s=this.LastConversationId??e.ActiveConversationId,i=this.IsChatPinnedToBottom(),r=(Ae=this.Container)==null?void 0:Ae.querySelector('[data-action="chat-input"]'),o=r&&document.activeElement===r,a=o?{Start:typeof r.selectionStart=="number"?r.selectionStart:null,End:typeof r.selectionEnd=="number"?r.selectionEnd:null}:null,c=((Le=(F=(Re=e.Settings)==null?void 0:Re.Options)==null?void 0:F.Accents)==null?void 0:Le.find(ue=>ue.Id===e.Settings.General.AccentColor))??((N=(Ee=(G=e.Settings)==null?void 0:G.Options)==null?void 0:Ee.Accents)==null?void 0:N[0]),u=(c==null?void 0:c.Hex)??"#10b981";this.Container.style.setProperty("--accent-color",u),document.documentElement.style.setProperty("--accent-color",u);const p=e.ActiveConversationId,h=((he=e.Conversations)==null?void 0:he.find(ue=>ue.Id===e.ActiveConversationId))??null,d=p?e.MessagesByConversation[p]??[]:[],m=p?((Ie=e.MessageGroupsByConversation)==null?void 0:Ie[p])??[]:[],f=p?this.ChatThreadView.RenderConversation({Messages:d,MessageGroups:m,Settings:e.Settings,Text:e.Text}):this.ChatThreadView.RenderWelcome({Text:e.Text}),v=this.SidebarView.Render(e),S=this.ModelSelectorView.Render(e),w=((le=e.Text)==null?void 0:le.ChatSaving)??{},A=h!=null&&h.IsPinned?w.UnpinActionLabel:w.PinActionLabel,x=A?`
        <button class="model-toggle flex items-center gap-2 text-sm font-semibold" data-action="toggle-pin" type="button" aria-label="${A}">
          <span>${A}</span>
          <span class="material-symbols-outlined">push_pin</span>
        </button>
      `:"",I=e.Settings?this.SettingsView.Render(e.Settings):"",P=this.RenderValidationPopup((ke=(De=e.Settings)==null?void 0:De.Providers)==null?void 0:ke.ValidationPopup),y=this.RenderRetryPopup(e.RetryPopup,e.Text),L=this.ChatSearchView.Render({ChatSearch:e.ChatSearch,Text:e.Text}),H=this.RenderPinDialog(($e=e.ChatSaving)==null?void 0:$e.PinDialog,e.Text),M=this.RenderDiscardDialog((Oe=e.ChatSaving)==null?void 0:Oe.DiscardDialog,e.Text),C=`${I}${P}${y}${L}${H}${M}`,$=[`--chat-bottom-padding: ${e.Layout.ChatBottomPadding};`,`--chat-input-line-height: ${e.Layout.InputLineHeightRem}rem;`,`--chat-input-max-height: ${e.Layout.InputMaxHeightRem}rem;`].join(" ");this.Dom.Shell.setAttribute("data-collapsed",e.IsSidebarCollapsed?"true":"false"),this.Dom.Main.style.cssText=$,v!==this.LastSidebarHtml&&(this.Dom.SidebarHost.innerHTML=v,this.LastSidebarHtml=v),S!==this.LastModelSelectorHtml&&(this.Dom.ModelSelectorHost.innerHTML=S,this.LastModelSelectorHtml=S),x!==this.LastHeaderActionsHtml&&(this.Dom.HeaderActionsHost.innerHTML=x,this.LastHeaderActionsHtml=x);const B=this.BuildChatBodyKey({ConversationId:p,Messages:d,MessageGroups:m,InternalMessagesEnabled:!!((k=(ce=e.Settings)==null?void 0:ce.Chat)!=null&&k.InternalChatMessages)});B!==this.LastChatBodyKey&&(this.Dom.ChatBodyHost.innerHTML=f,this.LastChatBodyKey=B);const Q=this.InputBarView.Render(e);if(Q!==this.LastInputBarHtml){this.Dom.InputHost.innerHTML=Q,this.LastInputBarHtml=Q,this.SetupChatInputSizing();const ue=(q=this.Container)==null?void 0:q.querySelector('[data-action="chat-input"]');ue&&o&&(ue.focus(),typeof ue.setSelectionRange=="function"&&(a==null?void 0:a.Start)!=null&&ue.setSelectionRange(a.Start,a.End??a.Start))}this.SyncChatInput(e);const Ce=this.CaptureChatSearchEditingState();C!==this.LastOverlaysHtml&&(this.Dom.OverlaysHost.innerHTML=C,this.LastOverlaysHtml=C,this.RestoreChatSearchEditingState(Ce,e));const O=this.Container.querySelector(".settings-content");O&&t>0&&(O.scrollTop=t),this.Dom.ChatScroll&&(s===e.ActiveConversationId&&n!=null?i?this.Dom.ChatScroll.scrollTop=this.Dom.ChatScroll.scrollHeight:this.Dom.ChatScroll.scrollTop=n:(h==null?void 0:h.ScrollPosition)!=null?this.Dom.ChatScroll.scrollTop=h.ScrollPosition:this.Dom.ChatScroll.scrollTop=0),this.LastConversationId=e.ActiveConversationId,this.LastScrollTop=((xe=this.Dom.ChatScroll)==null?void 0:xe.scrollTop)??this.LastScrollTop,this.Snackbar.DurationMs=e.Layout.SnackbarDurationMs,this.UpdateHeaderElevation(),this.UpdateModalKeyHandlers(e),this.UpdateChatSavingFocus(e),this.UpdateChatSearchFocus(e)}IsChatPinnedToBottom(){var n;const e=(n=this.Dom)==null?void 0:n.ChatScroll;return e?e.scrollHeight-(e.scrollTop+e.clientHeight)<=8:!1}}mr(Fe);fr(Fe);Sr(Fe);vr(Fe);const br="2025-12-31",yr={SupportsAttachments:!0,MaxAttachments:5,MaxFileSizeMb:10,AllowedMimeTypes:["image/png","image/jpeg","application/pdf","text/plain"],RetentionDays:7},Cr=[{Id:"openai",Name:"OpenAI",Icon:"assets/icons/provider_openai.svg",ApiConventions:{PrimaryEndpoint:"responses",Endpoints:{responses:{MaxOutputTokensParam:"max_output_tokens"},chat:{MaxOutputTokensParam:"max_tokens"},completions:{MaxOutputTokensParam:"max_tokens"}},Streaming:{DefaultSchema:"openai.responses.v1"},Reasoning:{EffortParam:"reasoning.effort",EffortLevelsCommon:["low","medium","high","xhigh"],Notes:["Some models have configurable effort; some are fixed."]}},Models:[{Id:"gpt-5.2",Label:"GPT-5.2",Description:"Latest flagship general model. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5.2-pro",Label:"GPT-5.2 Pro",Description:"Highest capability GPT-5.2 tier. Responses API only.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["medium","high","xhigh"]}}}},{Id:"gpt-5.1",Label:"GPT-5.1",Description:"Flagship general model (previous generation). Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5",Label:"GPT-5",Description:"Flagship general model. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5-pro",Label:"GPT-5 Pro",Description:"Higher capability tier within GPT-5 family. Responses API only. Reasoning effort fixed to high.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit",ParamPath:"reasoning.effort",Allowed:["high"]}}}},{Id:"gpt-5-mini",Label:"GPT-5 Mini",Description:"Lower-latency, cost-efficient GPT-5 family model. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high"]}}}},{Id:"gpt-5-nano",Label:"GPT-5 Nano",Description:"Smallest/fastest GPT-5 family option. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high"]}}}},{Id:"gpt-5.1-codex",Label:"GPT-5.1 Codex",Description:"GPT-5.1 optimized for agentic coding (Responses API).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5.1-codex-max",Label:"GPT-5.1 Codex Max",Description:"Largest Codex variant for demanding coding agents (Responses API).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["medium","high","xhigh"]}}}},{Id:"gpt-5-codex",Label:"GPT-5 Codex",Description:"GPT-5 coding-optimized model family (Codex, Responses API).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"o3-deep-research",Label:"o3 Deep Research",Description:"Deep research optimized reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o4-mini-deep-research",Label:"o4-mini Deep Research",Description:"Deep research optimized, smaller/faster reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o3-pro",Label:"o3 Pro",Description:"Higher-tier o3 reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o3",Label:"o3",Description:"General high-capability reasoning model (with snapshots available).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o3-mini",Label:"o3 Mini",Description:"Faster/lower-cost reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o1",Label:"o1",Description:"Reasoning model (earlier o-series).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o4-mini",Label:"o4-mini",Description:"Small reasoning model balancing speed and capability.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"gpt-4.1",Label:"GPT-4.1",Description:"High-quality general model (non-reasoning-first).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4.1-mini",Label:"GPT-4.1 Mini",Description:"Smaller GPT-4.1 variant for lower latency/cost.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4.1-nano",Label:"GPT-4.1 Nano",Description:"Smallest GPT-4.1 variant.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o",Label:"GPT-4o",Description:"Omni multimodal model for text+vision.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o-mini",Label:"GPT-4o Mini",Description:"Lower-cost GPT-4o family model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o-search-preview",Label:"GPT-4o Search Preview",Description:"Web search specialized (tool-call priced).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o-mini-search-preview",Label:"GPT-4o Mini Search Preview",Description:"Cheaper web search specialized model (with snapshots).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}}]},{Id:"anthropic",Name:"Anthropic",Icon:"assets/icons/provider_anthropic.svg",ApiConventions:{PrimaryEndpoint:"messages",Endpoints:{messages:{MaxOutputTokensParam:"max_tokens"}},Streaming:{DefaultSchema:"anthropic.messages.v1"},Reasoning:{ExtendedThinkingParamPath:"thinking",EnableShape:{type:"enabled",budget_tokens:"number"},BudgetParam:"budget_tokens"}},Models:[{Id:"claude-sonnet-4-5",Label:"Claude Sonnet 4.5 (alias)",Description:"Alias to latest Sonnet 4.5 snapshot.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"token_budget",ParamPath:"thinking.budget_tokens",Range:{Min:0,Max:64e3}},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0,ReturnsSummary:!0}}}},{Id:"claude-haiku-4-5",Label:"Claude Haiku 4.5 (alias)",Description:"Alias to latest Haiku 4.5 snapshot.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"token_budget",ParamPath:"thinking.budget_tokens",Range:{Min:0,Max:64e3}},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0,ReturnsSummary:!0}}}},{Id:"claude-opus-4-5",Label:"Claude Opus 4.5 (alias)",Description:"Alias to latest Opus 4.5 snapshot.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"token_budget",ParamPath:"thinking.budget_tokens",Range:{Min:0,Max:64e3}},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0,ReturnsSummary:!0}}}},{Id:"claude-sonnet-4-5-20250929",Label:"Claude Sonnet 4.5 (2025-09-29)",Description:"Pinned Sonnet 4.5 snapshot.",Enabled:!0},{Id:"claude-haiku-4-5-20251001",Label:"Claude Haiku 4.5 (2025-10-01)",Description:"Pinned Haiku 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-5-20251101",Label:"Claude Opus 4.5 (2025-11-01)",Description:"Pinned Opus 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-1",Label:"Claude Opus 4.1 (alias)",Description:"Alias to latest Opus 4.1 snapshot.",Enabled:!0},{Id:"claude-opus-4-1-20250805",Label:"Claude Opus 4.1 (2025-08-05)",Description:"Pinned Opus 4.1 snapshot.",Enabled:!0},{Id:"claude-opus-4",Label:"Claude Opus 4 (alias)",Description:"Alias to latest Opus 4 snapshot.",Enabled:!0},{Id:"claude-opus-4-20250514",Label:"Claude Opus 4 (2025-05-14)",Description:"Pinned Opus 4 snapshot.",Enabled:!0},{Id:"claude-sonnet-4",Label:"Claude Sonnet 4 (alias)",Description:"Alias to latest Sonnet 4 snapshot.",Enabled:!0},{Id:"claude-sonnet-4-20250514",Label:"Claude Sonnet 4 (2025-05-14)",Description:"Pinned Sonnet 4 snapshot.",Enabled:!0},{Id:"claude-3-haiku-20240307",Label:"Claude 3 Haiku (2024-03-07)",Description:"Active smaller Claude 3 model.",Enabled:!0},{Id:"claude-3-opus-20240229",Label:"Claude 3 Opus (2024-02-29)",Description:"Deprecated (available to existing users) â€” retirement Jan 5, 2026 per Anthropic.",Enabled:!0},{Id:"claude-3-5-haiku-20241022",Label:"Claude 3.5 Haiku (2024-10-22)",Description:"Deprecated (available to existing users) â€” retirement Feb 19, 2026 per Anthropic.",Enabled:!0},{Id:"claude-3-7-sonnet-20250219",Label:"Claude 3.7 Sonnet (2025-02-19)",Description:"Deprecated (available to existing users) â€” retirement Feb 19, 2026 per Anthropic.",Enabled:!0}]},{Id:"google",Name:"Google",Icon:"assets/icons/provider_google.svg",ApiConventions:{PrimaryEndpoint:"gemini_api",Endpoints:{gemini_api:{MaxOutputTokensParam:"generationConfig.maxOutputTokens"}},Streaming:{DefaultSchema:"google.gemini.v1"},Reasoning:{Notes:["Gemini 3 preview model cards list thinking support; request shape may vary by SDK/version."]}},Models:[{Id:"gemini-3-pro-preview",Label:"Gemini 3 Pro (Preview)",Description:"Most capable Gemini 3 preview model code.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"toggle",ParamPath:"thinking",Allowed:["on","off"]},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0}}}},{Id:"gemini-3-flash-preview",Label:"Gemini 3 Flash (Preview)",Description:"Gemini 3 speed-optimized preview model code.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"toggle",ParamPath:"thinking",Allowed:["on","off"]},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0}}}},{Id:"gemini-2.5-flash",Label:"Gemini 2.5 Flash",Description:"Stable Gemini 2.5 Flash model code.",Enabled:!0},{Id:"gemini-2.5-flash-lite",Label:"Gemini 2.5 Flash-Lite",Description:"Ultra fast/cost-efficient Gemini 2.5 Flash-Lite model code.",Enabled:!0}]},{Id:"grok",Name:"Grok",Icon:"assets/icons/provider_grok.svg",ApiConventions:{PrimaryEndpoint:"chat_completions",Streaming:{DefaultSchema:"grok.chat_completions.v1"},Reasoning:{Notes:["Grok 4 reasoning models do not accept reasoning_effort; some parameters may be rejected."]}},Models:[{Id:"grok-4",Label:"Grok 4",Description:"Frontier Grok model family.",Enabled:!0,Capabilities:{Reasoning:{Control:{Type:"implicit"}},RequestConstraints:{DisallowedParamsWhenReasoning:["presence_penalty","frequency_penalty","stop","reasoning_effort"]}}},{Id:"grok-4-0709",Label:"Grok 4 (0709)",Description:"Pinned Grok 4 snapshot ID (as documented by xAI).",Enabled:!0},{Id:"grok-4-fast",Label:"Grok 4 Fast",Description:"Lower-latency Grok 4 variant.",Enabled:!0},{Id:"grok-4-1-fast",Label:"Grok 4.1 Fast",Description:"Fast Grok 4.1 variant.",Enabled:!0},{Id:"grok-4-1-fast-reasoning",Label:"Grok 4.1 Fast Reasoning",Description:"Fast reasoning-oriented Grok 4.1 variant.",Enabled:!0},{Id:"grok-3-fast",Label:"Grok 3 Fast",Description:"Lower-latency Grok 3 variant.",Enabled:!0},{Id:"grok-3-mini",Label:"Grok 3 Mini",Description:"Smaller Grok 3 variant for cost/latency.",Enabled:!0},{Id:"grok-3-mini-fast",Label:"Grok 3 Mini Fast",Description:"Fastest Grok 3 mini variant.",Enabled:!0},{Id:"grok-code-fast-1",Label:"Grok Code Fast 1",Description:"Coding-optimized Grok model ID.",Enabled:!0},{Id:"grok-2-1212",Label:"Grok 2 (1212)",Description:"Pinned Grok 2 model snapshot ID.",Enabled:!0}]}],Qn={SchemaVersion:br,Attachments:yr,Providers:Cr};class Ar{constructor({Fetch:e,Logger:t,EnvironmentName:n}){this.Fetch=e,this.Logger=t,this.EnvironmentName=n}async LoadAsync(){const e=await this.FetchOverrideAsync();return e?this.MergeCatalogs(Qn,e):Qn}async FetchOverrideAsync(){var t,n;const e=`config/providers.catalog.${this.EnvironmentName}.json`;try{const s=await this.Fetch(e);return s.ok?await s.json():null}catch(s){return(n=(t=this.Logger)==null?void 0:t.LogWarning)==null||n.call(t,"ProviderCatalog.Override.Missing",{Path:e,Error:(s==null?void 0:s.message)??"Unknown error"}),null}}MergeCatalogs(e,t){const n=(e==null?void 0:e.Providers)??[],s=(t==null?void 0:t.Providers)??[],i=new Map(s.map(a=>[a.Id,a])),r=n.map(a=>{const c=i.get(a.Id);return c?{...a,...c,Models:this.MergeModels(a.Models??[],c.Models??[])}:a}),o=s.filter(a=>!n.some(c=>c.Id===a.Id));return{...e,...t,Attachments:{...(e==null?void 0:e.Attachments)??{},...(t==null?void 0:t.Attachments)??{}},Providers:[...r,...o]}}MergeModels(e,t){if(t.length===0)return e;const n=new Map(t.map(r=>[r.Id,r])),s=e.map(r=>({...r,...n.get(r.Id)??{}})),i=t.filter(r=>!e.some(o=>o.Id===r.Id));return[...s,...i]}}class Ir{constructor({Catalog:e}){this.Catalog=e}async LoadCatalogAsync(){return await this.Catalog.LoadAsync()}GetAttachmentDefaults(e){return(e==null?void 0:e.Attachments)??{}}GetModelAttachmentCapabilities(e,t,n){var r,o;const s=((e==null?void 0:e.Providers)??[]).find(a=>a.Id===t),i=(r=s==null?void 0:s.Models)==null?void 0:r.find(a=>a.Id===n);return((o=i==null?void 0:i.Capabilities)==null?void 0:o.Attachments)??null}}class kr{constructor({Providers:e}){this.Providers=new Map((e??[]).map(t=>[t.Id,t]))}GetProvider(e){const t=this.Providers.get(e);if(!t)throw new Error(`Provider not registered: ${e}`);return t}async ListModelIds(e,t){return await this.GetProvider(e).ListModelIds({Key:t})}async ValidateKey(e,t){return await this.GetProvider(e).ValidateKey(t)}}class xr{constructor({Fetch:e,BaseUrl:t="https://api.openai.com/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="openai",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??[]).map(n=>n==null?void 0:n.id).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{Authorization:`Bearer ${e}`}}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s,MaxOutputTokens:i,ModelConfig:r}){const o=(r==null?void 0:r.Endpoint)??"chat",a=(r==null?void 0:r.MaxTokensParam)??"max_tokens",c=o==="responses"?{model:t,input:this.MapMessages(n??[]),stream:!!s}:o==="completions"?{model:t,prompt:this.MapMessagesToPrompt(n??[]),stream:!!s}:{model:t,messages:this.MapMessages(n??[]),stream:!!s};s&&o==="chat"&&(c.stream_options={include_usage:!0}),i!=null&&(c[a]=i);const u=o==="responses"?"/responses":o==="completions"?"/completions":"/chat/completions";return{Url:`${this.BaseUrl}${u}`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:c}}ParseChatResponse(e){var c,u,p,h,d;const t=(e==null?void 0:e.usage)??{},n=t.input_tokens??t.prompt_tokens??null,s=t.output_tokens??t.completion_tokens??null,i={InputTokens:n??null,OutputTokens:s??null};if(e!=null&&e.output_text)return{Content:e.output_text,Usage:i};const o=((e==null?void 0:e.output)??[]).flatMap(m=>(m==null?void 0:m.content)??[]).map(m=>(m==null?void 0:m.text)??"").join("");if(o)return{Content:o,Usage:i};const a=(u=(c=e==null?void 0:e.choices)==null?void 0:c[0])==null?void 0:u.text;return a?{Content:a,Usage:i}:{Content:((d=(h=(p=e==null?void 0:e.choices)==null?void 0:p[0])==null?void 0:h.message)==null?void 0:d.content)??"",Usage:i}}ParseStreamEvent(e){var r,o,a,c,u,p,h,d;if(!e)return{Content:"",IsDone:!1};if(e==="[DONE]")return{Content:"",IsDone:!0};const t=(a=(o=(r=e==null?void 0:e.choices)==null?void 0:r[0])==null?void 0:o.delta)==null?void 0:a.content,n=(p=(u=(c=e==null?void 0:e.choices)==null?void 0:c[0])==null?void 0:u.delta)==null?void 0:p.reasoning,s=(d=(h=e==null?void 0:e.choices)==null?void 0:h[0])==null?void 0:d.text,i=e!=null&&e.usage?{InputTokens:e.usage.input_tokens??e.usage.prompt_tokens??null,OutputTokens:e.usage.output_tokens??e.usage.completion_tokens??null}:null;return{Content:t??s??"",InternalContent:n??null,Classification:n?"reasoning":null,IsDone:!1,Usage:i}}MapMessages(e){return e.map(t=>({role:(t.Role??"user").toLowerCase(),content:t.Content??""}))}MapMessagesToPrompt(e){return(e??[]).map(t=>{const n=(t.Role??"user").toLowerCase();return`${n==="assistant"?"Assistant":n==="system"?"System":"User"}: ${t.Content??""}`}).join(`

`)}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"OpenAI validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}class Mr{constructor({Fetch:e,BaseUrl:t="https://api.anthropic.com/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="anthropic",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??(t==null?void 0:t.models)??[]).map(n=>(n==null?void 0:n.id)??(n==null?void 0:n.name)).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{"x-api-key":e,"anthropic-version":"2023-06-01"}}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s,MaxOutputTokens:i}){const r=this.MapMessages(n??[]),o={model:t,messages:r.Messages,stream:!!s};return i!=null&&(o.max_tokens=i),r.System&&(o.system=r.System),{Url:`${this.BaseUrl}/messages`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:o}}ParseChatResponse(e){const t=(e==null?void 0:e.content)??[],n=(e==null?void 0:e.usage)??{};return{Content:t.map(s=>(s==null?void 0:s.text)??"").join(""),Usage:{InputTokens:n.input_tokens??null,OutputTokens:n.output_tokens??null}}}ParseStreamEvent(e){var t,n;if(!e)return{Content:"",IsDone:!1};if(e.type==="message_stop")return{Content:"",IsDone:!0};if(e.type==="content_block_delta"){const s=((t=e==null?void 0:e.delta)==null?void 0:t.text)??"",i=((n=e==null?void 0:e.delta)==null?void 0:n.thinking)??"";return i?{Content:"",InternalContent:i,Classification:"reasoning",IsDone:!1}:{Content:s,IsDone:!1}}return{Content:"",IsDone:!1}}MapMessages(e){const t=[],n=[];return e.forEach(s=>{const i=(s.Role??"").toLowerCase(),r=(s.Classification??s.Kind??"").toString().toLowerCase(),o=s.IsInternal===!0||r==="internal"||r==="reasoning"||r==="system-internal";if(i==="system"||i==="tool"||o){t.push(s.Content??"");return}if(i==="assistant"){n.push({role:"assistant",content:s.Content??""});return}n.push({role:"user",content:s.Content??""})}),{System:t.filter(Boolean).join(`

`),Messages:n}}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"Anthropic validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}class wr{constructor({Fetch:e,BaseUrl:t="https://generativelanguage.googleapis.com/v1beta"}){this.Fetch=e,this.BaseUrl=t,this.Id="google",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models?key=${encodeURIComponent(e)}`);if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.models)??[]).map(n=>n==null?void 0:n.name).filter(Boolean).map(n=>n.replace(/^models\//,""))}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s}){const i=this.MapMessages(n??[]),r=t.startsWith("models/")?t:`models/${t}`,o=s?`${this.BaseUrl}/${r}:streamGenerateContent?key=${encodeURIComponent(e)}&alt=sse`:`${this.BaseUrl}/${r}:generateContent?key=${encodeURIComponent(e)}`,a={contents:i.Messages};return i.System&&(a.systemInstruction={parts:[{text:i.System}]}),{Url:o,Headers:{"Content-Type":"application/json"},Body:a}}ParseChatResponse(e){var s,i,r;const t=((r=(i=(s=e==null?void 0:e.candidates)==null?void 0:s[0])==null?void 0:i.content)==null?void 0:r.parts)??[],n=(e==null?void 0:e.usageMetadata)??{};return{Content:t.map(o=>(o==null?void 0:o.text)??"").join(""),Usage:{InputTokens:n.promptTokenCount??null,OutputTokens:n.candidatesTokenCount??null}}}ParseStreamEvent(e){var i,r,o;if(!e)return{Content:"",IsDone:!1};if(e==="[DONE]")return{Content:"",IsDone:!0};const t=((o=(r=(i=e==null?void 0:e.candidates)==null?void 0:i[0])==null?void 0:r.content)==null?void 0:o.parts)??[],n=t.map(a=>(a==null?void 0:a.text)??"").join(""),s=t.map(a=>(a==null?void 0:a.thought)??(a==null?void 0:a.reasoning)??"").join("");return{Content:n,InternalContent:s||null,Classification:s?"reasoning":null,IsDone:!1}}MapMessages(e){const t=[],n=[];return e.forEach(s=>{const i=(s.Role??"").toLowerCase(),r=(s.Classification??s.Kind??"").toString().toLowerCase(),o=s.IsInternal===!0||r==="internal"||r==="reasoning"||r==="system-internal";if(i==="system"||i==="tool"||o){t.push(s.Content??"");return}const a=i==="assistant"?"model":"user";n.push({role:a,parts:[{text:s.Content??""}]})}),{System:t.filter(Boolean).join(`

`),Messages:n}}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"Google validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}class Tr{constructor({Fetch:e,BaseUrl:t="https://api.x.ai/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="grok",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??[]).map(n=>n==null?void 0:n.id).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{Authorization:`Bearer ${e}`}}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s,MaxOutputTokens:i}){const r={model:t,messages:this.MapMessages(n??[]),stream:!!s};return i&&(r.max_tokens=i),{Url:`${this.BaseUrl}/chat/completions`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:r}}ParseChatResponse(e){var n,s,i;const t=(e==null?void 0:e.usage)??{};return{Content:((i=(s=(n=e==null?void 0:e.choices)==null?void 0:n[0])==null?void 0:s.message)==null?void 0:i.content)??"",Usage:{InputTokens:t.prompt_tokens??null,OutputTokens:t.completion_tokens??null}}}ParseStreamEvent(e){var n,s,i;return e?e==="[DONE]"?{Content:"",IsDone:!0}:{Content:((i=(s=(n=e==null?void 0:e.choices)==null?void 0:n[0])==null?void 0:s.delta)==null?void 0:i.content)??"",IsDone:!1}:{Content:"",IsDone:!1}}MapMessages(e){return e.map(t=>({role:(t.Role??"user").toLowerCase(),content:t.Content??""}))}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"Grok validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}const ye=Object.freeze({MissingKey:"MissingKey",Unauthorized:"Unauthorized",Forbidden:"Forbidden",RateLimited:"RateLimited",ServiceUnavailable:"ServiceUnavailable",NetworkError:"NetworkError",Unknown:"Unknown"});class Yn{static BuildError({Code:e,Message:t,Status:n}){const s=new Error(t);return s.Code=e,s.Status=n,s}static Normalize(e){if(!e)return{Code:ye.Unknown,Message:"Validation failed. Please try again."};if(e.Code===ye.MissingKey)return{Code:ye.MissingKey,Message:"API key required before testing."};if(e.Code&&e.Message)return{Code:e.Code,Message:e.Message};const t=e.Status??e.status;return t===401?{Code:ye.Unauthorized,Message:"API key rejected. Check the key and try again."}:t===403?{Code:ye.Forbidden,Message:"Access denied for this API key."}:t===429?{Code:ye.RateLimited,Message:"Provider is rate limiting requests. Try again shortly."}:t>=500?{Code:ye.ServiceUnavailable,Message:"Provider service is unavailable. Try again later."}:e.name==="TypeError"?{Code:ye.NetworkError,Message:"Network error while contacting provider."}:{Code:ye.Unknown,Message:"Validation failed. Please try again."}}}class Pr{constructor({ProviderRegistry:e,ProviderLogger:t}){this.ProviderRegistry=e,this.ProviderLogger=t}async ValidateAsync(e,t){var n,s,i,r;if(!t)return{Status:"failure",Message:Yn.BuildError({Code:ye.MissingKey,Message:"API key required before testing."}).message};(n=this.ProviderLogger)==null||n.LogValidationStart(e);try{const a={Status:"success",Message:"API key validated successfully.",ModelIds:await this.ProviderRegistry.ListModelIds(e,t)};return(s=this.ProviderLogger)==null||s.LogValidationEnd(e,a),a}catch(o){(i=this.ProviderLogger)==null||i.LogValidationFailure(e,o);const c={Status:"failure",Message:Yn.Normalize(o).Message};return(r=this.ProviderLogger)==null||r.LogValidationEnd(e,c),c}}GetAttachmentCapabilities(e,t,n){var r,o;const s=((e==null?void 0:e.Providers)??[]).find(a=>a.Id===t),i=(r=s==null?void 0:s.Models)==null?void 0:r.find(a=>a.Id===n);return((o=i==null?void 0:i.Capabilities)==null?void 0:o.Attachments)??null}}class Rr{constructor({Logger:e}){this.Logger=e}LogValidationStart(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||n.call(t,"Providers.Validate",{ProviderId:e})}LogValidationEnd(e,t){var n,s;(s=(n=this.Logger)==null?void 0:n.LogFlowEnd)==null||s.call(n,"Providers.Validate",{ProviderId:e,Result:t})}LogValidationFailure(e,t){var n,s;(s=(n=this.Logger)==null?void 0:n.LogWarning)==null||s.call(n,"Providers.Validate.Failed",{ProviderId:e,Error:(t==null?void 0:t.message)??"Unknown error"})}}class Lr{constructor({Providers:e}={}){this.Providers=new Map((e??[]).map(t=>[t.Id,t]))}GetProvider(e){const t=this.Providers.get(e);if(!t)throw new Error(`Chat provider not registered: ${e}`);return t}}class Er{BuildContext({Messages:e}){return[...e??[]].sort((n,s)=>n.CreatedUtc===s.CreatedUtc?0:n.CreatedUtc<s.CreatedUtc?-1:1).map(n=>({Role:n.Role,Content:n.Content,Kind:n.Kind,Classification:n.Classification,IsInternal:n.IsInternal,Attachments:Array.isArray(n.Attachments)?n.Attachments:[]}))}}const Je=Object.freeze({OpenAiChatV1:"openai.chat.v1",OpenAiResponsesV1:"openai.responses.v1",AnthropicMessagesV1:"anthropic.messages.v1",GoogleGeminiV1:"google.gemini.v1",GrokChatCompletionsV1:"grok.chat_completions.v1"}),K=Object.freeze({ContentDelta:"content.delta",ReasoningDelta:"reasoning.delta",ReasoningSummaryDelta:"reasoning.summary.delta",ToolCallDelta:"tool.call.delta",ToolResultDelta:"tool.result.delta",StreamDone:"stream.done"}),Dr=({Provider:l,Model:e}={})=>{var t,n,s,i;return((n=(t=e==null?void 0:e.Capabilities)==null?void 0:t.Streaming)==null?void 0:n.EventSchema)??((i=(s=l==null?void 0:l.ApiConventions)==null?void 0:s.Streaming)==null?void 0:i.DefaultSchema)??null},$r=l=>l!=null&&l.usage?{InputTokens:l.usage.input_tokens??l.usage.prompt_tokens??null,OutputTokens:l.usage.output_tokens??l.usage.completion_tokens??null}:null,Zn=l=>{var t;const e=(l==null?void 0:l.usage)??((t=l==null?void 0:l.response)==null?void 0:t.usage)??null;return e?{InputTokens:e.input_tokens??null,OutputTokens:e.output_tokens??null}:null},Or=l=>l!=null&&l.usage?{InputTokens:l.usage.input_tokens??null,OutputTokens:l.usage.output_tokens??null}:null,_r=l=>{const e=(l==null?void 0:l.usageMetadata)??null;return e?{InputTokens:e.promptTokenCount??null,OutputTokens:e.candidatesTokenCount??null}:null},Xn=l=>{var r,o,a,c,u,p,h,d;if(!l)return[];if(l==="[DONE]")return[{Type:K.StreamDone}];const e=(a=(o=(r=l==null?void 0:l.choices)==null?void 0:r[0])==null?void 0:o.delta)==null?void 0:a.content,t=(p=(u=(c=l==null?void 0:l.choices)==null?void 0:c[0])==null?void 0:u.delta)==null?void 0:p.reasoning,n=(d=(h=l==null?void 0:l.choices)==null?void 0:h[0])==null?void 0:d.text,s=$r(l),i=[];return t&&i.push({Type:K.ReasoningDelta,Content:t,Classification:"reasoning"}),(e??n)&&i.push({Type:K.ContentDelta,Content:e??n??""}),s&&i.push({Type:K.StreamDone,Usage:s}),i},Ur=(l,e)=>{if(!e&&!l)return[];if(e==="[DONE]")return[{Type:K.StreamDone}];const t=[],n=(l??"").toLowerCase();if(n==="response.output_text.delta"){const i=(e==null?void 0:e.delta)??(e==null?void 0:e.text)??(e==null?void 0:e.output_text)??"";i&&t.push({Type:K.ContentDelta,Content:i})}else if(n==="response.reasoning_text.delta"){const i=(e==null?void 0:e.delta)??(e==null?void 0:e.text)??"";i&&t.push({Type:K.ReasoningDelta,Content:i,Classification:"reasoning"})}else if(n==="response.reasoning_summary_text.delta"){const i=(e==null?void 0:e.delta)??(e==null?void 0:e.text)??"";i&&t.push({Type:K.ReasoningSummaryDelta,Content:i,Classification:"reasoning"})}else(n==="response.completed"||n==="response.done")&&t.push({Type:K.StreamDone,Usage:Zn(e)});const s=Zn(e);return s&&t.length===0&&t.push({Type:K.StreamDone,Usage:s}),t},Nr=l=>{var t,n;if(!l)return[];const e=[];if(l.type==="message_stop")return e.push({Type:K.StreamDone,Usage:Or(l)}),e;if(l.type==="content_block_delta"){const s=((t=l==null?void 0:l.delta)==null?void 0:t.text)??"",i=((n=l==null?void 0:l.delta)==null?void 0:n.thinking)??"";i&&e.push({Type:K.ReasoningDelta,Content:i,Classification:"reasoning"}),s&&e.push({Type:K.ContentDelta,Content:s})}return e},Br=l=>{var r,o,a;if(!l)return[];if(l==="[DONE]")return[{Type:K.StreamDone}];const e=((a=(o=(r=l==null?void 0:l.candidates)==null?void 0:r[0])==null?void 0:o.content)==null?void 0:a.parts)??[],t=e.map(c=>(c==null?void 0:c.text)??"").join(""),n=e.map(c=>(c==null?void 0:c.thought)??(c==null?void 0:c.reasoning)??"").join(""),s=[];n&&s.push({Type:K.ReasoningDelta,Content:n,Classification:"reasoning"}),t&&s.push({Type:K.ContentDelta,Content:t});const i=_r(l);return i&&s.push({Type:K.StreamDone,Usage:i}),s},Fr=l=>{var t,n,s;if(!l)return[];if(l==="[DONE]")return[{Type:K.StreamDone}];const e=(s=(n=(t=l==null?void 0:l.choices)==null?void 0:t[0])==null?void 0:n.delta)==null?void 0:s.content;return e?[{Type:K.ContentDelta,Content:e}]:[]},kt=({Schema:l,EventName:e,Data:t})=>{switch(l){case Je.OpenAiChatV1:return Xn(t);case Je.OpenAiResponsesV1:return Ur(e,t);case Je.AnthropicMessagesV1:return Nr(t);case Je.GoogleGeminiV1:return Br(t);case Je.GrokChatCompletionsV1:return Fr(t);default:return Xn(t)}};class zr{constructor({ChatRegistry:e,ContextBuilder:t,ChatLogger:n,Configuration:s,Fetch:i}){this.ChatRegistry=e,this.ContextBuilder=t,this.ChatLogger=n,this.Configuration=s,this.Fetch=i??((...r)=>globalThis.fetch(...r))}async SendAsync({ProviderId:e,ModelId:t,Key:n,Messages:s,Stream:i,OnToken:r,OnStreamStart:o,OnEvent:a,ModelConfig:c,Signal:u}){var I,P,y,L,H,M,C,$,B,Q,Ce;const p=this.ChatRegistry.GetProvider(e),h=await this.InlineAttachmentsAsync(this.ContextBuilder.BuildContext({Messages:s,ProviderId:e,ModelId:t})),d=this.ResolveRequestSettings(e),m=((I=c==null?void 0:c.Streaming)==null?void 0:I.Supported)??!0,f=Date.now(),v=p.BuildChatRequest({Key:n,ModelId:t,Messages:h,Stream:i&&p.SupportsStreaming&&m,MaxOutputTokens:d.MaxOutputTokens,ModelConfig:c}),S=this.ApplyReasoningSettings(v,c);S&&((y=(P=this.ChatLogger)==null?void 0:P.LogReasoningApplied)==null||y.call(P,{ProviderId:e,ModelId:t,...S}));const w=i&&p.SupportsStreaming&&m,A=(s??[]).reduce((O,oe)=>{var ee;return O+(((ee=oe==null?void 0:oe.Attachments)==null?void 0:ee.length)??0)},0),x={ProviderId:e,ModelId:t,Stream:w,AttachmentCount:A};(H=(L=this.ChatLogger)==null?void 0:L.LogSendStart)==null||H.call(L,x);try{if(w){const ee=await this.StreamResponse(p,v,d,r,o,a,c==null?void 0:c.StreamSchema,u),Ae=this.BuildMetrics(ee,f);return(C=(M=this.ChatLogger)==null?void 0:M.LogSendEnd)==null||C.call(M,{...x,Length:ee.Content.length}),{Content:ee.Content,IsStreamed:!0,Metrics:Ae}}const O=await this.FetchResponse(p,v,d,u),oe=this.BuildMetrics(O,f);return(B=($=this.ChatLogger)==null?void 0:$.LogSendEnd)==null||B.call($,{...x,Length:O.Content.length}),{Content:O.Content,IsStreamed:!1,Metrics:oe}}catch(O){if(((u==null?void 0:u.aborted)&&(O==null?void 0:O.name)==="AbortError"||(O==null?void 0:O.name)==="AbortError")&&!(O!=null&&O.Metrics))try{O.Metrics=this.BuildMetrics({Usage:(O==null?void 0:O.Usage)??null},f)}catch{}throw(Ce=(Q=this.ChatLogger)==null?void 0:Q.LogSendFailure)==null||Ce.call(Q,{...x,Error:(O==null?void 0:O.message)??"Unknown error"}),O}}BuildAbortError(){if(typeof DOMException<"u")return new DOMException("Aborted","AbortError");const e=new Error("Aborted");return e.name="AbortError",e}ResolveRequestSettings(e){var i,r,o;const t=((i=this.Configuration)==null?void 0:i[J.Chat])??{},n=t[$n.Requests]??{},s=((o=(r=t[$n.ProviderOverrides])==null?void 0:r[e])==null?void 0:o.Requests)??{};return{TimeoutMs:s[Ve.TimeoutMs]??n[Ve.TimeoutMs],MaxRetries:0,BackoffMs:s[Ve.BackoffMs]??n[Ve.BackoffMs],MaxOutputTokens:s[Ve.MaxOutputTokens]??n[Ve.MaxOutputTokens]}}async FetchResponse(e,t,n,s){let i=null;try{const r=s?new Promise((p,h)=>{if(s.aborted){h(this.BuildAbortError());return}const d=()=>h(this.BuildAbortError());typeof s.addEventListener=="function"?(s.addEventListener("abort",d,{once:!0}),i=()=>s.removeEventListener("abort",d)):(s.onabort=d,i=()=>{s.onabort===d&&(s.onabort=null)})}):null,o=this.FetchWithTimeout(t,n.TimeoutMs,s),a=await(r?Promise.race([o,r]):o);if(!a.ok)throw await e.BuildError(a);const c=await a.json(),u=e.ParseChatResponse(c);return this.NormalizeParsedResponse(u)}finally{i==null||i()}}async StreamResponse(e,t,n,s,i,r,o,a){var w,A,x;const c=await this.FetchWithTimeout(t,n.TimeoutMs,a);if(!c.ok)throw await e.BuildError(c);i==null||i();const u=(w=c.body)==null?void 0:w.getReader();if(!u)throw new Error("Streaming not supported in this environment.");const p=new TextDecoder;let h="",d="",m=null,f=null;const v=a?this.BuildAbortError():null,S=a?new Promise((I,P)=>{if(a.aborted){try{v.Usage=m,v.PartialContent=d}catch{}P(v);return}const y=()=>{try{v.Usage=m,v.PartialContent=d}catch{}P(v)};typeof a.addEventListener=="function"?(a.addEventListener("abort",y,{once:!0}),f=()=>a.removeEventListener("abort",y)):(a.onabort=y,f=()=>{a.onabort===y&&(a.onabort=null)})}):null;try{for(;;){let I;try{I=await(S?Promise.race([u.read(),S]):u.read())}catch(y){if(a!=null&&a.aborted&&(y==null?void 0:y.name)==="AbortError"){try{await u.cancel()}catch{}try{y.Usage=(y==null?void 0:y.Usage)??m,y.PartialContent=(y==null?void 0:y.PartialContent)??d}catch{}}throw y}if(I.done)break;h+=p.decode(I.value,{stream:!0});const P=h.split(/\r?\n\r?\n/);h=P.pop()??"";for(const y of P){const L=this.ExtractSseEvent(y),H=L?(()=>{const M=L.Data,C=M==="[DONE]"?"[DONE]":JSON.parse(M);return kt({Schema:o,EventName:L.EventName,Data:C})})():(()=>{const M=y.trim();if(!M||M==="[DONE]")return kt({Schema:o,EventName:null,Data:"[DONE]"});if(M.startsWith("data:")){const C=M.replace(/^data:\s?/,"");try{const $=C==="[DONE]"?"[DONE]":JSON.parse(C);return kt({Schema:o,EventName:null,Data:$})}catch{return[]}}if(M.startsWith("{"))try{const C=JSON.parse(M);return kt({Schema:o,EventName:null,Data:C})}catch{return[]}return[]})();for(const M of H)if(M){if(M.Type===K.ContentDelta){const C=M.Content??"";C&&(d+=C,s==null||s(C));continue}if(M.Type===K.ReasoningDelta||M.Type===K.ReasoningSummaryDelta){const C=M.Content??"";C&&(r==null||r({Type:"internal",Content:C,Classification:M.Classification??"reasoning"}),(x=(A=this.ChatLogger)==null?void 0:A.LogStreamClassified)==null||x.call(A,{ProviderId:e.Id,Classification:M.Classification??"reasoning"}));continue}if(M.Type===K.StreamDone)return M.Usage&&(m=M.Usage),{Content:d,Usage:m};M.Usage&&(m=M.Usage)}}}return{Content:d,Usage:m}}finally{f==null||f()}}ExtractSseEvent(e){const t=e.split(/\r?\n/);let n=null;const s=[];return t.forEach(i=>{const r=i.trim();r.startsWith("event:")&&(n=r.replace(/^event:\s?/,"")),r.startsWith("data:")&&s.push(r.replace(/^data:\s?/,""))}),s.length===0?null:{EventName:n,Data:s.join(`
`)}}async FetchWithTimeout(e,t,n){const s=new AbortController,r=typeof t=="number"&&t>0?setTimeout(()=>s.abort(),t):null;let o=null;if(n)if(n.aborted)s.abort();else{const a=()=>s.abort();typeof n.addEventListener=="function"?(n.addEventListener("abort",a,{once:!0}),o=()=>n.removeEventListener("abort",a)):(n.onabort=a,o=()=>{n.onabort===a&&(n.onabort=null)})}try{return await this.Fetch(e.Url,{method:"POST",headers:e.Headers,body:JSON.stringify(e.Body),signal:s.signal})}finally{r&&clearTimeout(r),o==null||o()}}NormalizeParsedResponse(e){return e?typeof e=="string"?{Content:e,Usage:null}:{Content:e.Content??"",Usage:e.Usage??null}:{Content:"",Usage:null}}ApplyReasoningSettings(e,t){var p,h,d,m;const n=(t==null?void 0:t.ReasoningPreference)??null,s=((p=t==null?void 0:t.Reasoning)==null?void 0:p.Control)??null;if(!n||!s)return null;const i=!!n.Enabled;if(!i)return null;const r=s.Type??null,o=s.ParamPath??null,a=(t==null?void 0:t.Endpoint)??"chat";if(o!=null&&o.startsWith("reasoning")&&a!=="responses")return null;let c=null;if(r==="effort_enum")c=n.EffortLevel??null,c&&Array.isArray(s.Allowed)&&!s.Allowed.includes(c)&&(c=null);else if(r==="token_budget"){const f=n.TokenBudget,v=typeof f=="number"?f:Number(f);Number.isFinite(v)&&(((h=s.Range)==null?void 0:h.Min)!=null&&v<s.Range.Min?c=s.Range.Min:((d=s.Range)==null?void 0:d.Max)!=null&&v>s.Range.Max?c=s.Range.Max:c=v)}else r==="toggle"&&(c=n.ToggleState??"on",Array.isArray(s.Allowed)&&!s.Allowed.includes(c)&&(c=s.Allowed[0]??null));return o&&c!=null&&this.SetParamPath(e.Body,o,c),(((m=t==null?void 0:t.RequestConstraints)==null?void 0:m.DisallowedParamsWhenReasoning)??[]).forEach(f=>{f&&Object.prototype.hasOwnProperty.call(e.Body,f)&&delete e.Body[f]}),{Enabled:i,ControlType:r,Value:c}}SetParamPath(e,t,n){if(!e||!t)return;const s=t.split(".").filter(Boolean);let i=e;for(let r=0;r<s.length;r+=1){const o=s[r];if(r===s.length-1){i[o]=n;return}(!i[o]||typeof i[o]!="object")&&(i[o]={}),i=i[o]}}BuildMetrics(e,t){const n=Math.max(Date.now()-t,0),s=(e==null?void 0:e.Usage)??{};return{DurationMs:n,InputTokens:s.InputTokens??null,OutputTokens:s.OutputTokens??null}}async InlineAttachmentsAsync(e){var i;if(!Array.isArray(e))return e;const t=50*1024,n=new Set(["text/plain","text/markdown","text/csv","application/json"]),s=[];for(const r of e){const o=r.Attachments??[];if(!o.length){s.push(r);continue}const a=[];for(const u of o){const p=(u==null?void 0:u.Name)??"Attachment",h=(u==null?void 0:u.SizeBytes)??0,d=(u==null?void 0:u.MimeType)??"",m=(u==null?void 0:u.Blob)??null;if(!m||typeof m.text!="function"){a.push(`Attachment "${p}" (${h} bytes) was not sent (no readable content).`);continue}if(!n.has(d)){a.push(`Attachment "${p}" (${h} bytes) was not sent (unsupported type ${d||"unknown"}).`);continue}if(h>t){a.push(`Attachment "${p}" (${h} bytes) was not sent (too large to inline; limit ${t} bytes).`);continue}try{const f=await m.text();a.push(`Attachment "${p}" (${h} bytes, ${d}):
${f}`)}catch{a.push(`Attachment "${p}" (${h} bytes) could not be read.`)}}if(!a.length){s.push(r);continue}const c=(i=r.Content)!=null&&i.endsWith(`
`)?"":`

`;s.push({...r,Content:`${r.Content??""}${c}${a.join(`

`)}`})}return s}}class Hr{constructor({Logger:e}={}){this.Logger=e}LogSendStart(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||n.call(t,"Chat.Send",e)}LogSendEnd(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowEnd)==null||n.call(t,"Chat.Send",e)}LogSendFailure(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogWarning)==null||n.call(t,"Chat.Send.Failed",e)}LogStreamStart(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||n.call(t,"Chat.Stream",e)}LogStreamEnd(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowEnd)==null||n.call(t,"Chat.Stream",e)}LogStreamFailure(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogWarning)==null||n.call(t,"Chat.Stream.Failed",e)}LogReasoningApplied(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogInformation)==null||n.call(t,"Chat.Reasoning.Applied",e)}LogStreamClassified(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogDebug)==null||n.call(t,"Chat.Stream.Classified",e)}LogAttachmentsAdd(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogInformation)==null||n.call(t,"Chat.Attachments.Add",e)}LogAttachmentsValidate(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogInformation)==null||n.call(t,"Chat.Attachments.Validate",e)}LogAttachmentsRevalidate(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogInformation)==null||n.call(t,"Chat.Attachments.Revalidate",e)}LogAttachmentsClear(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogInformation)==null||n.call(t,"Chat.Attachments.Clear",e)}}const Gr=(l,e,t)=>Math.min(Math.max(l,e),t),Kr=l=>(l??"").trim(),es=l=>(l??"").toString(),qr=({StartIndex:l,FieldLength:e,PositionMinMultiplier:t})=>{const n=Number(t);return!Number.isFinite(n)||e<=1?1:1-Gr(l/(e-1),0,1)*(1-n)},jr=({Text:l,Query:e})=>{const t=(l??"").toString(),n=(e??"").toString();if(!n.trim())return[];const s=t.toLowerCase(),i=n.toLowerCase(),r=[];let o=0;for(;o<=s.length-i.length;){const a=s.indexOf(i,o);if(a===-1)break;r.push({StartIndex:a,EndIndex:a+i.length,FieldLength:s.length}),o=a+1}return r},ts=({Text:l,Query:e,BaseMultiplier:t,PositionMinMultiplier:n})=>{const s=jr({Text:l,Query:e});if(s.length===0)return{Matches:[],TotalScore:0,BestMatch:null};const i=Number(t),r=Number.isFinite(i)?i:1,o=s.map(u=>{const p=qr({StartIndex:u.StartIndex,FieldLength:u.FieldLength,PositionMinMultiplier:n}),h=r*p;return{...u,BaseMultiplier:r,PositionMultiplier:p,Score:h}}),a=o.reduce((u,p)=>u?p.Score===u.Score?p.StartIndex<u.StartIndex?p:u:p.Score>u.Score?p:u:p,null),c=o.reduce((u,p)=>u+p.Score,0);return{Matches:o,TotalScore:c,BestMatch:a}},ns=l=>{const e=(l??"").toString(),t=new Date(e);return Number.isNaN(t.getTime())?new Date(0):t},Vr=Object.freeze({TitleMatchMultiplier:2,BodyMatchMultiplier:1,PositionMinMultiplier:.5,MaxResults:50,ExcerptContextChars:48,ExcerptMaxLength:180}),ut=(l,e,t)=>Math.min(Math.max(l,e),t),Wr=({Text:l,MatchStart:e,MatchLength:t,ExcerptContextChars:n,ExcerptMaxLength:s})=>{const i=(l??"").toString(),r=ut(e,0,Math.max(i.length,0)),o=ut(e+t,0,Math.max(i.length,0)),a=ut(Number(n)||0,0,1e3),c=ut(Number(s)||180,20,2e3),u="...",p="...",h=o-r,d=Math.max(c-(u.length+p.length),h),m=Math.floor(Math.max(d-h,0)/2);let f=Math.max(r-Math.max(a,m),0),v=Math.min(o+Math.max(a,m),i.length);(()=>{if(v-f<=d)return;f=Math.max(r-Math.floor((d-h)/2),0),v=Math.min(f+d,i.length),v-f<d&&(f=Math.max(v-d,0))})();const w=f>0,A=v<i.length,x=w?u:"",I=A?p:"",P=i.slice(f,v),y=`${x}${P}${I}`,L=x.length+(r-f),H=L+(o-r);return{ExcerptText:y,ExcerptMatchStart:L,ExcerptMatchEnd:H}};class vs{SearchPinnedChats({Conversations:e,MessagesByConversation:t,Query:n,Config:s}={}){const i=Kr(n);if(!i)return[];const r={...Vr,...s??{}},o=ut(Number(r.MaxResults)||50,1,500),c=(e??[]).filter(u=>u==null?void 0:u.IsPinned).map(u=>{const p=es((u==null?void 0:u.Title)??""),m=((t??{})[u.Id]??[]??[]).filter(I=>{const P=((I==null?void 0:I.Role)??"").toString(),y=((I==null?void 0:I.Classification)??(I==null?void 0:I.Kind)??"").toString().toLowerCase(),L=(I==null?void 0:I.IsInternal)===!0||y==="internal"||y==="reasoning"||y==="system-internal"||y==="tool-invocation"||y==="tool-result";return!(P!=="User"&&P!=="Assistant"||L)}).map(I=>es((I==null?void 0:I.Content)??"")),f=ts({Text:p,Query:i,BaseMultiplier:r.TitleMatchMultiplier,PositionMinMultiplier:r.PositionMinMultiplier}),v=m.map(I=>ts({Text:I,Query:i,BaseMultiplier:r.BodyMatchMultiplier,PositionMinMultiplier:r.PositionMinMultiplier})),S=[...f.Matches.map(I=>({Field:"title",Text:p,...I})),...v.flatMap((I,P)=>I.Matches.map(y=>({Field:"body",Text:m[P],...y})))],w=S.reduce((I,P)=>I+(P.Score??0),0),A=S.reduce((I,P)=>I?P.Score===I.Score?P.StartIndex<I.StartIndex?P:I:P.Score>I.Score?P:I:P,null);if(!A||w<=0)return null;const x=Wr({Text:A.Text,MatchStart:A.StartIndex,MatchLength:i.length,ExcerptContextChars:r.ExcerptContextChars,ExcerptMaxLength:r.ExcerptMaxLength});return{ConversationId:u.Id,Title:p,Score:w,LastUpdatedUtc:u.LastUpdatedUtc??u.CreatedUtc??null,...x}}).filter(Boolean);return c.sort((u,p)=>{if(u.Score===p.Score){const h=ns(u.LastUpdatedUtc);return ns(p.LastUpdatedUtc).getTime()-h.getTime()}return p.Score-u.Score}),c.slice(0,o)}}const Qt=Object.freeze(["image/png","image/jpeg","application/pdf","text/plain"]),ne=Object.freeze({Unsupported:"unsupported",MaxCount:"max-count",MaxSize:"max-size",InvalidType:"invalid-type"});class Jr{constructor({Configuration:e,Logger:t}={}){this.Configuration=e,this.Logger=t}ResolveDefaults({Catalog:e}={}){var a;const t=((a=this.Configuration)==null?void 0:a[J.Attachments])??{},n=(e==null?void 0:e.Attachments)??{},s={...t,...n},i=this.ParseNumber(s[We.MaxAttachments],5),r=this.ParseNumber(s[We.MaxFileSizeMb],10),o=this.ParseNumber(s[We.RetentionDays],7);return{SupportsAttachments:this.ParseBoolean(s[We.SupportsAttachments],!0),MaxAttachments:i,MaxFileSizeBytes:this.MbToBytes(r),AllowedMimeTypes:Array.isArray(s[We.AllowedMimeTypes])?s[We.AllowedMimeTypes]:Qt,RetentionDays:o}}ResolveCapability({ProviderId:e,ModelId:t,ProvidersCatalog:n,Defaults:s}){var d,m;const i=(n??[]).find(f=>f.Id===e)??null,r=((d=i==null?void 0:i.Models)==null?void 0:d.find(f=>f.Id===t))??null,o=((m=r==null?void 0:r.Capabilities)==null?void 0:m.Attachments)??null,a=o==null?void 0:o.SupportsAttachments,c=typeof a=="boolean"?a:s.SupportsAttachments,u=this.ResolveLimit(s.MaxAttachments,o==null?void 0:o.MaxAttachments),p=this.ResolveLimit(s.MaxFileSizeBytes,(o==null?void 0:o.MaxFileSizeBytes)??this.MbToBytes(o==null?void 0:o.MaxFileSizeMb)),h=Array.isArray(o==null?void 0:o.AllowedMimeTypes)?o.AllowedMimeTypes:s.AllowedMimeTypes;return{ProviderId:e,ModelId:t,SupportsAttachments:c,MaxAttachments:u,MaxFileSizeBytes:p,AllowedMimeTypes:h,LimitsSource:o?"provider":"defaults"}}ValidateFiles({Files:e,ExistingAttachments:t,Capability:n,RetentionDays:s,Now:i}){const r=[];if(!(n!=null&&n.SupportsAttachments))return r.push({Code:ne.Unsupported}),{Attachments:[],Errors:r};const o=Array.from(e??[]),a=t??[],c=n==null?void 0:n.MaxAttachments;if(typeof c=="number"&&a.length>=c)return r.push({Code:ne.MaxCount,Max:c}),{Attachments:[],Errors:r};const u=typeof c=="number"?Math.max(c-a.length,0):o.length,p=typeof c=="number"?o.slice(0,u):o;typeof c=="number"&&o.length>u&&r.push({Code:ne.MaxCount,Max:c});const h=i??Date.now(),d=this.DaysToMs(s??7),m=n==null?void 0:n.MaxFileSizeBytes,f=(n==null?void 0:n.AllowedMimeTypes)??Qt,v=[];return p.forEach(S=>{const w=(S==null?void 0:S.type)??"";if(f.length>0&&!f.includes(w)){r.push({Code:ne.InvalidType,Name:(S==null?void 0:S.name)??""});return}if(typeof m=="number"&&(S==null?void 0:S.size)>m){r.push({Code:ne.MaxSize,Name:(S==null?void 0:S.name)??"",MaxBytes:m});return}v.push({AttachmentId:this.CreateId(),Name:(S==null?void 0:S.name)??"Attachment",MimeType:w,SizeBytes:(S==null?void 0:S.size)??0,Status:"pending",AddedAt:new Date(h).toISOString(),LastValidatedAt:new Date(h).toISOString(),ProviderId:(n==null?void 0:n.ProviderId)??null,ModelId:(n==null?void 0:n.ModelId)??null,InactivityExpiresAt:new Date(h+d).toISOString(),Blob:S??null})}),{Attachments:v,Errors:r}}RevalidateAttachments({Attachments:e,Capability:t,RetentionDays:n,Now:s}){const i=s??Date.now(),r=this.DaysToMs(n??7),o=t==null?void 0:t.MaxFileSizeBytes,a=(t==null?void 0:t.AllowedMimeTypes)??Qt,c=t==null?void 0:t.MaxAttachments,u=[];let p=(e??[]).map(h=>({...h}));return t!=null&&t.SupportsAttachments?(typeof c=="number"&&p.length>c&&u.push({Code:ne.MaxCount,Max:c}),p=p.map((h,d)=>{let m=null;return typeof c=="number"&&d>=c&&(m=ne.MaxCount),!m&&a.length>0&&!a.includes(h.MimeType)&&(m=ne.InvalidType),!m&&typeof o=="number"&&h.SizeBytes>o&&(m=ne.MaxSize),{...h,Status:m?"failed":"pending",ErrorCode:m,ErrorMessage:null,LastValidatedAt:new Date(i).toISOString(),InactivityExpiresAt:new Date(i+r).toISOString()}}),{Attachments:p,Errors:u}):(p=p.map(h=>({...h,Status:"failed",ErrorCode:ne.Unsupported,ErrorMessage:null,LastValidatedAt:new Date(i).toISOString()})),u.push({Code:ne.Unsupported}),{Attachments:p,Errors:u})}ResolveLimit(e,t){return typeof t!="number"?e:typeof e!="number"?t:Math.min(e,t)}MbToBytes(e){return typeof e!="number"?null:Math.round(e*1024*1024)}DaysToMs(e){return Math.max(typeof e=="number"?e:7,0)*24*60*60*1e3}ParseNumber(e,t){const n=typeof e=="number"?e:Number(e);return Number.isFinite(n)?n:t}ParseBoolean(e,t){return typeof e=="boolean"?e:e==="true"?!0:e==="false"?!1:t}CreateId(){var e;return(e=globalThis.crypto)!=null&&e.randomUUID?globalThis.crypto.randomUUID():`att-${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`}}const Qr=Object.freeze({AppTitle:"Ghostplug",WelcomeHeading:"How can I help?",InputPlaceholder:"Ask anything",NotImplemented:"Not implemented",PendingMessage:"Waiting for response...",Chat:{WaitForResponseToastText:"Waiting for a response. Please wait or abort before switching chats.",AbortedToastText:"Response aborted.",AbortedMessageText:"Response aborted.",ReasoningToggleLabel:"Reasoning",ReasoningSectionLabel:"Reasoning",ReasoningActiveLabel:"Active",ReasoningOffLabel:"Off",ReasoningOnLabel:"On",ReasoningEffortLabel:"Reasoning",ReasoningBudgetLabel:"Reasoning",ReasoningToggleOnLabel:"Thinking on",ReasoningToggleOffLabel:"Thinking off",ThinkingIndicatorText:"Thinking...",InternalMessageLabel:"Thought",InternalMessagesSummaryLabel:"internal messages"},RetryAction:"Retry",RetryConfirmTitle:"Use the newly selected model?",RetryConfirmMessage:"You changed the selected model since the failed request. Use the new selection for retry?",RetryConfirmYes:"Yes",RetryConfirmNo:"No",Sidebar:{NewChat:"New chat",Search:"Search chats",Conversations:"Chats",Settings:"Settings"},ModelSelector:{Label:"Models"},Attachments:{AttachFiles:"Attach files",UnsupportedError:"Attachments are not supported for this model.",MaxCountError:"Attachment limit reached.",MaxSizeError:"File exceeds size limit.",InvalidTypeError:"Unsupported file type.",GenericError:"Attachment error.",ExpiredError:"An attachment expired and was removed."}}),bs=1.5,ys=10,Cs=.75,As=.75,Is=3,ks=2.5,xs=1.25,Ms=bs*ys,Yr=Is+Ms+ks+As+Cs*2+xs,Zr=Math.max(24,Yr),Xr=Object.freeze({ChatBottomPadding:`${Zr}rem`,InputLineHeightRem:bs,InputMaxLines:ys,InputShellPaddingRem:Cs,InputShellGapRem:As,InputBottomGapRem:Is,InputButtonRowRem:ks,InputSafetyPaddingRem:xs,InputMaxHeightRem:Ms,SnackbarDurationMs:2400,ModelDescriptionDurationMs:5e3,ModelDescriptionFadeOutMs:1e3}),Yt=Object.freeze({Themes:[{Id:"light",Label:"Light"},{Id:"dark",Label:"Dark"},{Id:"system",Label:"System"}],Accents:[{Id:"lime",Label:"Lime",Hex:"#84cc16"},{Id:"sunset",Label:"Sunset",Hex:"#ff6b6b"},{Id:"citrus",Label:"Citrus",Hex:"#f97316"},{Id:"electric",Label:"Electric",Hex:"#22d3ee"},{Id:"royal",Label:"Royal",Hex:"#6366f1"},{Id:"mint",Label:"Mint",Hex:"#10b981"},{Id:"magenta",Label:"Magenta",Hex:"#ec4899"},{Id:"amber",Label:"Amber",Hex:"#f59e0b"}],Providers:[]}),ws=({IsOpen:l=!1,ActiveCategory:e="general",General:t={},Chat:n={},Providers:s={},ProvidersCatalog:i=null}={})=>{var o;const r=i??Yt.Providers;return{IsOpen:l,ActiveCategory:e,Options:Yt,General:{Theme:t.Theme??"system",AccentColor:t.AccentColor??Yt.Accents[0].Id},Chat:{InternalChatMessages:n.InternalChatMessages??!1,ReasoningPreferences:n.ReasoningPreferences??{},Requests:{MaxOutputTokens:((o=n.Requests)==null?void 0:o.MaxOutputTokens)??null}},Providers:{SelectedProviderId:s.SelectedProviderId??null,Providers:r.map(a=>({...a,Models:a.Models.map(c=>({...c}))})),RequestOverrides:s.RequestOverrides??{},Keys:{openai:"",anthropic:"",google:"",grok:""},KeyVisibility:{},ValidationPopup:null,ModelAvailability:{}}}},lt=Object.freeze({Models:[{Id:"gpt-4o-mini",Label:"GPT-4o Mini",Description:"Fast responses",IsDefault:!0},{Id:"gpt-4o",Label:"GPT-4o",Description:"Balanced reasoning",IsDefault:!1},{Id:"gpt-4.1",Label:"GPT-4.1",Description:"Deeper analysis",IsDefault:!1}],Conversations:[{Id:"conv-001",Title:"Welcome chat",LastUpdatedUtc:"2025-12-25T09:00:00Z",Preview:"Hello..."},{Id:"conv-002",Title:"Layout ideas",LastUpdatedUtc:"2025-12-24T15:10:00Z",Preview:"Sidebar and input..."},{Id:"conv-003",Title:"Model switch",LastUpdatedUtc:"2025-12-24T08:30:00Z",Preview:"Dropdown behaviors..."}],MessagesByConversation:{"conv-001":[{Id:"msg-001",ConversationId:"conv-001",Role:"User",Content:"hello",TimestampUtc:"2025-12-25T09:00:00Z",Attachments:[{AttachmentId:"att-001",Name:"notes.txt",SizeBytes:512}]},{Id:"msg-002",ConversationId:"conv-001",Role:"Assistant",Content:"Hello, Borivoje — what are you working on today?",TimestampUtc:"2025-12-25T09:00:10Z"}]}}),eo=({ActiveConversationId:l=null,IsSidebarCollapsed:e=!1,InputText:t="",IsSending:n=!1,RetryPopup:s=null,ChatSearch:i=null,Conversations:r=lt.Conversations,MessagesByConversation:o=lt.MessagesByConversation,MessageGroupsByConversation:a={},ReasoningStepsByConversation:c={},SelectedModelId:u=null,Settings:p=null,ProvidersCatalog:h=null,ModelSelection:d=null,Reasoning:m=null,DraftAttachments:f=[],AttachmentDefaults:v=null,AttachmentCapability:S=null}={})=>{const w=lt.Models.find(A=>A.IsDefault)??lt.Models[0];return{IsSidebarCollapsed:e,ActiveConversationId:l,Conversations:r,MessagesByConversation:o,MessageGroupsByConversation:a,ReasoningStepsByConversation:c,Models:lt.Models,InputText:t,DraftAttachments:f,AttachmentDefaults:v,AttachmentCapability:S,IsSending:n,RetryPopup:s,ChatSearch:i??{IsOpen:!1,Query:"",Results:[],Error:null},SelectedModelId:u??(w==null?void 0:w.Id)??null,ModelSelection:d??{LastUserSelectedModelId:null,AutoSelectedModelId:null,DescriptionText:null},Reasoning:m,Text:Qr,Layout:Xr,Settings:p??ws({ProvidersCatalog:h})}};class Ue{static CreateConversation({Title:e,ProviderId:t,ModelId:n}){const s=new Date().toISOString();return{Id:crypto.randomUUID(),Title:e??"",IsPinned:!1,CreatedUtc:s,LastUpdatedUtc:s,LastProviderId:t??null,LastModelId:n??null,ScrollPosition:0}}static CreateMessage({ConversationId:e,Role:t,Kind:n,Classification:s,IsInternal:i,Content:r,ProviderId:o,ModelId:a,Status:c,Attachments:u}){const p=s??n??null,h=typeof i=="boolean"?i:p==="internal"||p==="reasoning"||p==="system-internal"||p==="tool-invocation"||p==="tool-result"||n==="Internal";return{Id:crypto.randomUUID(),ConversationId:e,Role:t,Kind:n,Classification:p,IsInternal:h,Content:r,CreatedUtc:new Date().toISOString(),ProviderId:o??null,ModelId:a??null,Status:c??"pending",Metrics:null,Attachments:Array.isArray(u)?u:[]}}static CreateMessageGroup({ConversationId:e,UserMessageId:t,InternalMessageIds:n,AssistantMessageId:s}){return{Id:crypto.randomUUID(),ConversationId:e,UserMessageId:t,InternalMessageIds:n??[],AssistantMessageId:s??null,InternalVisible:!1}}static TouchConversation(e,{ProviderId:t,ModelId:n}={}){return{...e,LastUpdatedUtc:new Date().toISOString(),LastProviderId:t??e.LastProviderId,LastModelId:n??e.LastModelId}}}const mn=l=>l==null?"":String(l).trim().replace(/\s+/g," "),Lt=l=>mn(l).toLowerCase(),to=l=>{Object.assign(l.prototype,{GetActiveConversation(){var t;const e=(t=this.State)==null?void 0:t.ActiveConversationId;return e?(this.State.Conversations??[]).find(n=>n.Id===e)??null:null},HasActiveUnpinnedContent(){var i,r,o,a;const e=((((i=this.State)==null?void 0:i.InputText)??"").trim().length??0)>0,t=(((r=this.State)==null?void 0:r.DraftAttachments)??[]).length>0,n=this.GetActiveConversation();if(!n)return e||t;if(n.IsPinned)return!1;const s=((a=(o=this.State)==null?void 0:o.MessagesByConversation)==null?void 0:a[n.Id])??[];return e||t||((s==null?void 0:s.length)??0)>0},RequestNewChat(){var e,t,n,s,i;if((e=this.State)!=null&&e.IsSending){this.ShowSnackbar((s=(n=(t=this.State)==null?void 0:t.Text)==null?void 0:n.Chat)==null?void 0:s.WaitForResponseToastText);return}if(this.Logger.LogFlowStart("ChatSaving.NewChat.Request",{ActiveConversationId:((i=this.State)==null?void 0:i.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"new-chat"}}),this.Logger.LogFlowEnd("ChatSaving.NewChat.Request",{Result:"prompted"});return}this.ExecuteNewChat()},ExecuteNewChat(){const e=this.GetActiveConversation();e&&!e.IsPinned&&this.ClearDraftAttachmentsAsync(e.Id).catch(t=>{this.Logger.LogError("Attachments.Clear.Failed",{Error:(t==null?void 0:t.message)??"Unknown error"})}),e||this.ClearDraftAttachmentsAsync(null).catch(t=>{this.Logger.LogError("Attachments.Clear.Failed",{Error:(t==null?void 0:t.message)??"Unknown error"})}),this.UpdateState({ActiveConversationId:null,InputText:"",ChatSaving:null,ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.LoadDraftAttachmentsAsync(null).catch(t=>{this.Logger.LogError("Attachments.Load.Failed",{Error:(t==null?void 0:t.message)??"Unknown error"})}),this.Logger.LogFlowEnd("ChatSaving.NewChat.Request",{Result:"started"})},RequestSelectConversation(e){var t,n,s,i,r,o;if((t=this.State)!=null&&t.IsSending){this.ShowSnackbar((i=(s=(n=this.State)==null?void 0:n.Text)==null?void 0:s.Chat)==null?void 0:i.WaitForResponseToastText);return}if(e&&e!==((r=this.State)==null?void 0:r.ActiveConversationId)){if(this.Logger.LogFlowStart("ChatSaving.SelectConversation.Request",{SelectedConversationId:e,ActiveConversationId:((o=this.State)==null?void 0:o.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"select-conversation",ConversationId:e}}),this.Logger.LogFlowEnd("ChatSaving.SelectConversation.Request",{Result:"prompted"});return}this.ExecuteSelectConversation(e)}},ExecuteSelectConversation(e){const t=this.GetActiveConversation();t&&!t.IsPinned&&this.ClearDraftAttachmentsAsync(t.Id).catch(n=>{this.Logger.LogError("Attachments.Clear.Failed",{Error:(n==null?void 0:n.message)??"Unknown error"})}),this.UpdateState({ActiveConversationId:e,InputText:"",ChatSaving:null,ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.LoadDraftAttachmentsAsync(e).catch(n=>{this.Logger.LogError("Attachments.Load.Failed",{Error:(n==null?void 0:n.message)??"Unknown error"})}),this.Logger.LogFlowEnd("ChatSaving.SelectConversation.Request",{Result:"selected"})},OpenDiscardDialog({NextAction:e}={}){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},DiscardDialog:{IsOpen:!0,NextAction:e??null}}})},CloseDiscardDialog(){var e,t,n;(n=(t=(e=this.State)==null?void 0:e.ChatSaving)==null?void 0:t.DiscardDialog)!=null&&n.IsOpen&&(this.UpdateState({ChatSaving:null}),this.Logger.LogFlowEnd("ChatSaving.Discard",{Result:"cancelled"}))},ConfirmDiscard(){var p,h,d,m;const e=((d=(h=(p=this.State)==null?void 0:p.ChatSaving)==null?void 0:h.DiscardDialog)==null?void 0:d.NextAction)??null,t=this.GetActiveConversation(),n=((m=this.State)==null?void 0:m.ActiveConversationId)??null,i=t&&!t.IsPinned&&!!n;let r=this.State.Conversations??[],o=this.State.MessagesByConversation??{},a=this.State.MessageGroupsByConversation??{};i&&n&&(r=r.filter(f=>f.Id!==n),o={...o},delete o[n],a={...a},delete a[n],this.ClearDraftAttachmentsAsync(n).catch(f=>{this.Logger.LogError("Attachments.Clear.Failed",{Error:(f==null?void 0:f.message)??"Unknown error"})}));const c={Conversations:r,MessagesByConversation:o,MessageGroupsByConversation:a,InputText:"",ChatSaving:null};(e==null?void 0:e.Type)==="select-conversation"?c.ActiveConversationId=e.ConversationId??null:(e==null?void 0:e.Type)==="select-chat-search-result"?(c.ActiveConversationId=e.ConversationId??null,c.ChatSearch={IsOpen:!1,Query:"",Results:[],Error:null}):(e==null?void 0:e.Type)==="new-chat"&&(c.ActiveConversationId=null),this.UpdateState(c);const u=c.ActiveConversationId??null;this.LoadDraftAttachmentsAsync(u).catch(f=>{this.Logger.LogError("Attachments.Load.Failed",{Error:(f==null?void 0:f.message)??"Unknown error"})}),this.Logger.LogFlowEnd("ChatSaving.Discard",{Result:"confirmed",NextAction:(e==null?void 0:e.Type)??null})},RequestTogglePin(){var n;if((n=this.State)!=null&&n.IsSending)return;const e=this.GetActiveConversation();if(e!=null&&e.IsPinned){this.UnpinConversation(e.Id);return}const t=(e==null?void 0:e.Title)??"";this.OpenPinDialog({Name:t})},OpenPinDialog({Name:e}={}){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{IsOpen:!0,Name:e??"",ErrorText:null}}})},ClosePinDialog(){var e,t,n;(n=(t=(e=this.State)==null?void 0:e.ChatSaving)==null?void 0:t.PinDialog)!=null&&n.IsOpen&&(this.UpdateState({ChatSaving:null}),this.Logger.LogFlowEnd("ChatSaving.Pin",{Result:"cancelled"}))},UpdatePinDialogName(e){var t,n,s,i;(s=(n=(t=this.State)==null?void 0:t.ChatSaving)==null?void 0:n.PinDialog)!=null&&s.IsOpen&&(this.State={...this.State,ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...((i=this.State.ChatSaving)==null?void 0:i.PinDialog)??{},Name:e??"",ErrorText:null}}})},ConfirmPinFromDialog(){var u,p,h,d,m,f;const e=(p=(u=this.State)==null?void 0:u.ChatSaving)==null?void 0:p.PinDialog;if(!(e!=null&&e.IsOpen))return;this.Logger.LogFlowStart("ChatSaving.Pin",{ActiveConversationId:((h=this.State)==null?void 0:h.ActiveConversationId)??null});const t=mn(e.Name??""),n=((m=(d=this.State)==null?void 0:d.Text)==null?void 0:m.ChatSaving)??{};if(!t){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...e,Name:e.Name??"",ErrorText:n.PinDialogEmptyError??null}}});return}const s=Lt(t);if((this.State.Conversations??[]).filter(v=>v==null?void 0:v.IsPinned).some(v=>Lt((v==null?void 0:v.Title)??"")===s)){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...e,Name:t,ErrorText:n.PinDialogDuplicateError??null}}});return}const o=new Date().toISOString();let a=((f=this.State)==null?void 0:f.ActiveConversationId)??null,c=this.State.Conversations??[];if(a){const v=this.GetActiveConversation();if(!v){this.Logger.LogError("ChatSaving.Pin.MissingActiveConversation",{ActiveConversationId:a});return}const S={...v,Title:t,IsPinned:!0,LastUpdatedUtc:o};c=[S,...c.filter(w=>w.Id!==S.Id)],this.UpdateState({Conversations:c,ChatSaving:null})}else{const v=Ue.CreateConversation({Title:t});v.IsPinned=!0,v.LastUpdatedUtc=o,a=v.Id,c=[v,...c],this.UpdateState({Conversations:c,ActiveConversationId:a,ChatSaving:null}),this.MigrateDraftAttachmentsAsync(null,a).catch(S=>{this.Logger.LogError("Attachments.Migrate.Failed",{Error:(S==null?void 0:S.message)??"Unknown error"})})}this.ShowSnackbar(n.PinnedToastText),this.Logger.LogFlowEnd("ChatSaving.Pin",{Result:"pinned",Name:t})},UnpinConversation(e){var r,o;if(!e)return;const t=(this.State.Conversations??[]).find(a=>a.Id===e);if(!t)return;const n=((o=(r=this.State)==null?void 0:r.Text)==null?void 0:o.ChatSaving)??{},s={...t,IsPinned:!1,LastUpdatedUtc:new Date().toISOString()},i=(this.State.Conversations??[]).map(a=>a.Id===e?s:a);this.UpdateState({Conversations:i,ChatSaving:null}),this.ShowSnackbar(n.UnpinnedToastText),this.Logger.LogFlowEnd("ChatSaving.Unpin",{Result:"unpinned",ConversationId:e})}})},no=l=>{Object.assign(l.prototype,{OpenChatSearch(){var e,t,n,s,i;if((e=this.State)!=null&&e.IsSending){this.ShowSnackbar((s=(n=(t=this.State)==null?void 0:t.Text)==null?void 0:n.Chat)==null?void 0:s.WaitForResponseToastText);return}this.Logger.LogFlowStart("ChatSearch.Open",{ActiveConversationId:((i=this.State)==null?void 0:i.ActiveConversationId)??null}),this.UpdateState({ChatSearch:{IsOpen:!0,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSearch.Open",{Result:"opened"})},CloseChatSearch(){var e,t;(t=(e=this.State)==null?void 0:e.ChatSearch)!=null&&t.IsOpen&&(this.ChatSearchDebounceTimer&&(clearTimeout(this.ChatSearchDebounceTimer),this.ChatSearchDebounceTimer=null),this.UpdateState({ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSearch.Close",{Result:"closed"}))},UpdateChatSearchQuery(e){var i,r,o,a,c;if(!((r=(i=this.State)==null?void 0:i.ChatSearch)!=null&&r.IsOpen))return;const t=e??"",n=Number(((c=(a=(o=this.State)==null?void 0:o.Text)==null?void 0:a.ChatSearch)==null?void 0:c.DebounceMs)??0),s=Number.isFinite(n)?Math.max(0,n):0;this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Query:t,Error:null}}),this.ChatSearchDebounceTimer&&(clearTimeout(this.ChatSearchDebounceTimer),this.ChatSearchDebounceTimer=null),this.ChatSearchDebounceTimer=setTimeout(()=>{this.ChatSearchDebounceTimer=null,this.ComputeChatSearchResults()},s)},ComputeChatSearchResults(){var s,i,r,o,a,c,u;if(!((i=(s=this.State)==null?void 0:s.ChatSearch)!=null&&i.IsOpen))return;const e=((r=this.State.ChatSearch)==null?void 0:r.Query)??"",t=((a=(o=this.State)==null?void 0:o.Text)==null?void 0:a.ChatSearch)??{},n=performance.now();try{const p=this.ChatSearchService.SearchPinnedChats({Conversations:((c=this.State)==null?void 0:c.Conversations)??[],MessagesByConversation:((u=this.State)==null?void 0:u.MessagesByConversation)??{},Query:e,Config:t}),h=performance.now()-n;this.Logger.LogInformation("ChatSearch.Query.Updated",{QueryLength:(e??"").length,ResultCount:p.length,DurationMs:Math.round(h)}),this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Results:p,Error:null}})}catch(p){this.Logger.LogError("ChatSearch.Query.Failed",{Error:(p==null?void 0:p.message)??"Unknown error"}),this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Results:[],Error:(p==null?void 0:p.message)??"Search failed."}})}},RequestSelectChatSearchResult(e){var t,n,s,i,r,o;if((t=this.State)!=null&&t.IsSending){this.ShowSnackbar((i=(s=(n=this.State)==null?void 0:n.Text)==null?void 0:s.Chat)==null?void 0:i.WaitForResponseToastText);return}if(e){if(e===((r=this.State)==null?void 0:r.ActiveConversationId)){this.CloseChatSearch();return}if(this.Logger.LogFlowStart("ChatSearch.SelectResult.Request",{SelectedConversationId:e,ActiveConversationId:((o=this.State)==null?void 0:o.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"select-chat-search-result",ConversationId:e}}),this.Logger.LogFlowEnd("ChatSearch.SelectResult.Request",{Result:"prompted"});return}this.ExecuteSelectConversation(e),this.Logger.LogFlowEnd("ChatSearch.SelectResult.Request",{Result:"selected"})}}})},so=l=>{Object.assign(l.prototype,{PersistState(){var n,s,i,r,o,a,c,u,p,h;const e=this.SanitizeState(this.State);try{Promise.resolve((s=(n=this.AppStateStore)==null?void 0:n.SaveStateAsync)==null?void 0:s.call(n,e)).catch(d=>{var m,f,v;this.Logger.LogError("App.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((v=(f=(m=this.State)==null?void 0:m.Text)==null?void 0:f.ChatSaving)==null?void 0:v.StorageErrorText)})}catch(d){this.Logger.LogError("App.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((o=(r=(i=this.State)==null?void 0:i.Text)==null?void 0:r.ChatSaving)==null?void 0:o.StorageErrorText)}const t=this.ExtractConversationState(this.State);try{Promise.resolve((c=(a=this.ConversationStore)==null?void 0:a.SaveStateAsync)==null?void 0:c.call(a,t)).catch(d=>{var m,f,v;this.Logger.LogError("Conversation.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((v=(f=(m=this.State)==null?void 0:m.Text)==null?void 0:f.ChatSaving)==null?void 0:v.StorageErrorText)})}catch(d){this.Logger.LogError("Conversation.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((h=(p=(u=this.State)==null?void 0:u.Text)==null?void 0:p.ChatSaving)==null?void 0:h.StorageErrorText)}},SanitizeState(e){const{Layout:t,Text:n,Conversations:s,MessagesByConversation:i,MessageGroupsByConversation:r,ChatSearch:o,DraftAttachments:a,AttachmentDefaults:c,AttachmentCapability:u,...p}=e,d=new Set((s??[]).filter(m=>m==null?void 0:m.IsPinned).map(m=>m.Id).filter(Boolean)).has(e.ActiveConversationId)?e.ActiveConversationId:null;return{...p,ActiveConversationId:d,IsSending:!1,RetryPopup:null,ChatSaving:null,ChatSearch:null,Settings:{...e.Settings,Providers:{...e.Settings.Providers,Keys:ws().Providers.Keys,KeyVisibility:{},ValidationPopup:null}}}},ExtractConversationState(e){const t=new Set((e.Conversations??[]).filter(s=>s==null?void 0:s.IsPinned).map(s=>s.Id).filter(Boolean)),n=s=>t.has(s);return{Conversations:(e.Conversations??[]).filter(s=>n(s.Id)),MessagesByConversation:Object.fromEntries(Object.entries(e.MessagesByConversation??{}).filter(([s])=>n(s))),MessageGroupsByConversation:Object.fromEntries(Object.entries(e.MessageGroupsByConversation??{}).filter(([s])=>n(s))),ReasoningStepsByConversation:Object.fromEntries(Object.entries(e.ReasoningStepsByConversation??{}).filter(([s])=>n(s)))}},BuildText(e,{AppName:t}={}){var o,a,c,u,p,h,d,m;const n=((a=(o=this.Configuration)==null?void 0:o[J.Ui])==null?void 0:a.Chat)??{},s=((u=(c=this.Configuration)==null?void 0:c[J.Ui])==null?void 0:u.ChatSaving)??{},i=((h=(p=this.Configuration)==null?void 0:p[J.Ui])==null?void 0:h.ChatSearch)??{},r=((m=(d=this.Configuration)==null?void 0:d[J.Ui])==null?void 0:m.Attachments)??{};return{...e??{},AppTitle:t??(e==null?void 0:e.AppTitle),Chat:{...(e==null?void 0:e.Chat)??{},...n},ChatSaving:s,ChatSearch:i,Attachments:{...(e==null?void 0:e.Attachments)??{},...r}}},NormalizeStoredConversationState(e){var r;if(!((r=e==null?void 0:e.Conversations)!=null&&r.length)||e.Conversations.some(o=>Object.prototype.hasOwnProperty.call(o??{},"IsPinned")))return e;const n=new Set,s=[],i=e.Conversations.map(o=>{const a=(o==null?void 0:o.Title)??"",c=mn(a);if(!c)return{...o,IsPinned:!0};let u=c,p=1;for(;n.has(Lt(u));)p+=1,u=`${c} (${p})`;const h=Lt(u);return h&&n.add(h),u!==a&&s.push({ConversationId:o==null?void 0:o.Id,From:a,To:u}),{...o,Title:u,IsPinned:!0}});return this.Logger.LogFlowStart("Conversation.Migration.LegacyPinned.Start",{ConversationCount:e.Conversations.length}),s.length>0&&this.Logger.LogWarning("Conversation.Migration.LegacyPinned.Renamed",{Renamed:s}),this.Logger.LogFlowEnd("Conversation.Migration.LegacyPinned.End",{RenamedCount:s.length}),{...e,Conversations:i}},ShowSnackbar(e){var t,n;e&&((n=(t=this.RootView)==null?void 0:t.Snackbar)==null||n.Show(e))},MergeState(e,t){if(!t)return e;const n={...e,...t};return n.Layout=e.Layout,n.Text=e.Text,n.Conversations=e.Conversations,n.MessagesByConversation=e.MessagesByConversation,n.MessageGroupsByConversation=e.MessageGroupsByConversation,n.Settings=this.MergeSettings(e.Settings,t.Settings),n.ModelSelection||(n.ModelSelection={LastUserSelectedModelId:n.SelectedModelId??null,AutoSelectedModelId:null}),n},MergeSettings(e,t){var r,o,a,c,u,p,h;if(!t)return e;const n={...e,...t,Options:e.Options,General:{...e.General,...t.General},Chat:{...e.Chat,...t.Chat,ReasoningPreferences:{...((r=e.Chat)==null?void 0:r.ReasoningPreferences)??{},...((o=t.Chat)==null?void 0:o.ReasoningPreferences)??{}},Requests:{...((a=e.Chat)==null?void 0:a.Requests)??{},...((c=t.Chat)==null?void 0:c.Requests)??{}}}};((u=t.General)==null?void 0:u.InternalChatMessages)!=null&&((p=t.Chat)==null?void 0:p.InternalChatMessages)==null&&(n.Chat={...n.Chat,InternalChatMessages:t.General.InternalChatMessages});const s=t.Providers??{},i={...e.Providers,...s};return i.RequestOverrides={...((h=e.Providers)==null?void 0:h.RequestOverrides)??{},...s.RequestOverrides??{}},i.Providers=e.Providers.Providers.map(d=>{var v;const m=(v=s.Providers)==null?void 0:v.find(S=>S.Id===d.Id);if(!m)return d;const f=new Map((m.Models??[]).map(S=>[S.Id,S.Enabled]));return{...d,Models:d.Models.map(S=>({...S,Enabled:f.has(S.Id)?f.get(S.Id):S.Enabled}))}}),i.SelectedProviderId=i.Providers.some(d=>d.Id===i.SelectedProviderId)?i.SelectedProviderId:null,n.Providers=i,n}})},io=l=>{Object.assign(l.prototype,{ApplyProviderModelStates(e,t){return!t||e.length===0?e:e.map(n=>{const s=t[n.Id]??{};return{...n,Models:n.Models.map(i=>({...i,Enabled:s[i.Id]??i.Enabled}))}})},RefreshModelSelectorState(e){const t=this.NormalizeModelSelection(e.ModelSelection,e.SelectedModelId),n=this.BuildAvailableModels(e.Settings.Providers.Providers,e.Settings.Providers.ModelAvailability),s=this.ResolveModelSelection(n,t,e.SelectedModelId),i=this.MaybeClearDescription(e,s.SelectedModelId,s.ModelSelection);return{...e,Models:n,SelectedModelId:s.SelectedModelId,ModelSelection:i}},NormalizeModelSelection(e,t){return e||{LastUserSelectedModelId:t??null,AutoSelectedModelId:null}},BuildAvailableModels(e,t){const n=[];return(e??[]).forEach(s=>{const i=(t==null?void 0:t[s.Id])??{};(s.Models??[]).forEach(r=>{r.Enabled&&i[r.Id]&&n.push({Id:r.Id,Label:r.Label,Description:r.Description??"",ProviderId:s.Id,ProviderName:s.Name,Capabilities:r.Capabilities??{}})})}),n},ResolveModelSelectionState({Providers:e,ModelAvailability:t,SelectedModelId:n,ModelSelection:s}){const i=this.BuildAvailableModels(e,t),r=this.NormalizeModelSelection(s,n),o=this.ResolveModelSelection(i,r,n);return{Models:i,SelectedModelId:o.SelectedModelId,ModelSelection:o.ModelSelection}},ResolveModelSelection(e,t,n){const s=new Set(e.map(a=>a.Id)),i=t.LastUserSelectedModelId;let r=s.has(n)?n:null,o=t.AutoSelectedModelId;return i&&s.has(i)?(r=i,o=null):!r&&e.length>0&&(r=e[0].Id,o=r),{SelectedModelId:r,ModelSelection:{...t,AutoSelectedModelId:o}}},MaybeClearDescription(e,t,n){return!(n!=null&&n.DescriptionText)||t&&t===e.SelectedModelId?n:{...n,DescriptionText:null}},BuildModelAvailability(e,t){const n={};return(t??[]).forEach(s=>{n[s.Id]=!1}),e.forEach(s=>{n[s]=!0}),n},BuildProviderAvailability(e){const t={};return(e??[]).forEach(n=>{t[n.Id]=!1}),t},MergeAvailability(e,t){const n={};return(e??[]).forEach(s=>{const i=this.BuildProviderAvailability(s.Models??[]),r=(t==null?void 0:t[s.Id])??{};n[s.Id]={...i,...r}}),n},ResetProviderAvailability(e){const n=this.State.Settings.Providers.Providers.find(r=>r.Id===e);if(!n)return;const i={...this.State.Settings.Providers.ModelAvailability??{},[e]:this.BuildProviderAvailability(n.Models??[])};this.ProvidersStore.SetProviderAvailability(e,i[e]),this.UpdateSettings(r=>{const o={...r,Providers:{...r.Providers,ModelAvailability:i}},a=this.ResolveModelSelectionState({Providers:o.Providers.Providers,ModelAvailability:o.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:o,Models:a.Models,SelectedModelId:a.SelectedModelId,ModelSelection:a.ModelSelection}})},ApplyModelAvailability(e,t,n){return n?e.map(s=>{if(s.Id!==t)return s;const i=s.Models.map(r=>({...r}));return{...s,Models:i}}):e}})},ro=l=>{Object.assign(l.prototype,{async SendMessageAsync(){var P,y,L,H;if(this.State.IsSending)return;const e=(this.State.InputText??"").trim(),t=this.State.DraftAttachments??[];if(!e&&t.length===0)return;const n=this.State.Models.find(M=>M.Id===this.State.SelectedModelId);if(!n){this.Logger.LogWarning("Chat.Send.MissingModel",{});return}const s=n.ProviderId,i=n.Id,r=((P=this.State.Settings.Providers.Keys)==null?void 0:P[s])??"";let o=this.State.ActiveConversationId,a=this.State.Conversations,c={...this.State.MessagesByConversation};const u=this.BuildPreview(e);if(o)a=this.UpdateConversationPreview(a,o,u,s,i);else{const M=this.InferTitle(e),C=Ue.CreateConversation({Title:M,ProviderId:s,ModelId:i});C.Preview=u,o=C.Id,a=[C,...a],c[o]=[]}const p=this.State.ActiveConversationId??null,h=this.BuildMessageAttachments(t),d=Ue.CreateMessage({ConversationId:o,Role:"User",Kind:"User",Classification:null,Content:e,ProviderId:s,ModelId:i,Status:"done",Attachments:h}),m=Ue.CreateMessage({ConversationId:o,Role:"Assistant",Kind:"Assistant",Classification:null,Content:"",ProviderId:s,ModelId:i,Status:"pending"});m.ReasoningEnabled=this.IsReasoningEnabled(s,i);const f=Ue.CreateMessageGroup({ConversationId:o,UserMessageId:d.Id,InternalMessageIds:[],AssistantMessageId:m.Id}),v=[...c[o]??[],d,m];c={...c,[o]:v};const S={...this.State.MessageGroupsByConversation??{},[o]:[...(this.State.MessageGroupsByConversation??{})[o]??[],f]};this.UpdateState({ActiveConversationId:o,Conversations:a,MessagesByConversation:c,MessageGroupsByConversation:S,InputText:"",DraftAttachments:[],IsSending:!0}),this.ClearDraftAttachmentsAsync(p).catch(M=>{this.Logger.LogError("Attachments.Clear.Failed",{Error:(M==null?void 0:M.message)??"Unknown error"})});const w=v.filter(M=>M.Id!==m.Id&&!this.IsInternalMessage(M)),A=new AbortController;this.SendAbortController=A;const x=(H=(L=(y=this.State.Settings)==null?void 0:y.Providers)==null?void 0:L.Providers)==null?void 0:H.find(M=>M.Id===s),I=this.BuildReasoningConfig(n,x,s,i);try{const M=await this.ChatService.SendAsync({ProviderId:s,ModelId:i,Key:r,Messages:w,Stream:!0,ModelConfig:I,Signal:A.signal,OnStreamStart:()=>{A.signal.aborted||this.IsReasoningEnabled(s,i)&&this.UpdateMessage(o,m.Id,C=>({...C,Status:C.Status==="pending"?"streaming":C.Status}))},OnEvent:C=>{A.signal.aborted||this.AppendInternalMessage({ConversationId:o,MessageGroupId:f.Id,AssistantMessageId:m.Id,ProviderId:s,ModelId:i,Content:(C==null?void 0:C.Content)??"",Classification:(C==null?void 0:C.Classification)??"reasoning"})},OnToken:C=>{A.signal.aborted||this.UpdateMessage(o,m.Id,$=>({...$,Content:`${$.Content??""}${C}`,Status:"streaming"}))}});if(A.signal.aborted)return;this.UpdateMessage(o,m.Id,C=>({...C,Content:M.Content??C.Content??"",Status:"done",Metrics:M.Metrics??null}))}catch(M){A.signal.aborted&&(M==null?void 0:M.name)==="AbortError"?this.UpdateMessage(o,m.Id,$=>({...$,Status:"aborted",Metrics:(M==null?void 0:M.Metrics)??$.Metrics??null})):this.UpdateMessage(o,m.Id,$=>({...$,Status:"error",ErrorMessage:this.ResolveFriendlyError(M),Metrics:null}))}finally{this.SendAbortController===A&&(this.SendAbortController=null),this.UpdateState({IsSending:!1})}},AbortSend(){var t,n,s,i;if(!((t=this.State)!=null&&t.IsSending))return;const e=this.SendAbortController;!e||e.signal.aborted||(e.abort(),this.ShowSnackbar((i=(s=(n=this.State)==null?void 0:n.Text)==null?void 0:s.Chat)==null?void 0:i.AbortedToastText))},OpenRetryPopup(e){const t=this.FindMessageLocation(e);if(!t)return;const n=t.Message;if(n.Status!=="error")return;const s=this.State.Models.find(r=>r.Id===this.State.SelectedModelId);if(!s)return;if(s.Id===n.ModelId&&s.ProviderId===n.ProviderId){this.RetryMessageAsync(t.ConversationId,e,n.ProviderId,n.ModelId).catch(r=>{this.Logger.LogError("Chat.Retry.Failed",{Error:(r==null?void 0:r.message)??"Unknown error"})});return}this.UpdateState({RetryPopup:{IsOpen:!0,MessageId:e,ConversationId:t.ConversationId,OriginalProviderId:n.ProviderId,OriginalModelId:n.ModelId,SelectedProviderId:s.ProviderId,SelectedModelId:s.Id}})},async ConfirmRetryAsync(e){const t=this.State.RetryPopup;if(!(t!=null&&t.IsOpen))return;const n=e?t.SelectedProviderId:t.OriginalProviderId,s=e?t.SelectedModelId:t.OriginalModelId,i=t.ConversationId,r=t.MessageId;this.UpdateState({RetryPopup:null}),await this.RetryMessageAsync(i,r,n,s)},async RetryMessageAsync(e,t,n,s){var p;if(this.State.IsSending)return;const i=this.State.MessagesByConversation[e]??[],r=i.findIndex(h=>h.Id===t);if(r===-1)return;this.UpdateState({IsSending:!0}),this.UpdateMessage(e,t,h=>({...h,Status:"pending",Content:"",ErrorMessage:null,ProviderId:n,ModelId:s,Metrics:null,ReasoningEnabled:this.IsReasoningEnabled(n,s)}));const o=i.slice(0,r).filter(h=>h.Status!=="error"&&!this.IsInternalMessage(h)),a=((p=this.State.Settings.Providers.Keys)==null?void 0:p[n])??"",c=this.GetModelConfig(n,s),u=new AbortController;this.SendAbortController=u;try{const h=await this.ChatService.SendAsync({ProviderId:n,ModelId:s,Key:a,Messages:o,Stream:!0,ModelConfig:c,Signal:u.signal,OnStreamStart:()=>{u.signal.aborted||this.IsReasoningEnabled(n,s)&&this.UpdateMessage(e,t,d=>({...d,Status:d.Status==="pending"?"streaming":d.Status}))},OnEvent:d=>{if(u.signal.aborted)return;const m=this.FindMessageGroupByAssistantId(e,t);m&&this.AppendInternalMessage({ConversationId:e,MessageGroupId:m.Id,AssistantMessageId:t,ProviderId:n,ModelId:s,Content:(d==null?void 0:d.Content)??"",Classification:(d==null?void 0:d.Classification)??"reasoning"})},OnToken:d=>{u.signal.aborted||this.UpdateMessage(e,t,m=>({...m,Content:`${m.Content??""}${d}`,Status:"streaming"}))}});if(u.signal.aborted)return;this.UpdateMessage(e,t,d=>({...d,Content:h.Content??d.Content??"",Status:"done",Metrics:h.Metrics??null}))}catch(h){u.signal.aborted&&(h==null?void 0:h.name)==="AbortError"?this.UpdateMessage(e,t,m=>({...m,Status:"aborted",Metrics:(h==null?void 0:h.Metrics)??m.Metrics??null})):this.UpdateMessage(e,t,m=>({...m,Status:"error",ErrorMessage:this.ResolveFriendlyError(h),Metrics:null}))}finally{this.SendAbortController===u&&(this.SendAbortController=null),this.UpdateState({IsSending:!1})}},ToggleInternalGroup(e){var i;const t=this.FindMessageGroupLocation(e);if(!t)return;const s=(((i=this.State.MessageGroupsByConversation)==null?void 0:i[t.ConversationId])??[]).map(r=>r.Id===e?{...r,InternalVisible:!r.InternalVisible}:r);this.UpdateState({MessageGroupsByConversation:{...this.State.MessageGroupsByConversation,[t.ConversationId]:s}})},UpdateMessage(e,t,n){const i=(this.State.MessagesByConversation[e]??[]).map(r=>r.Id===t?n(r):r);this.UpdateState({MessagesByConversation:{...this.State.MessagesByConversation,[e]:i}})},IsInternalMessage(e){if(!e)return!1;const t=(e.Classification??e.Kind??"").toString().toLowerCase();return t==="internal"||t==="reasoning"||t==="system-internal"||t==="tool-invocation"||t==="tool-result"},IsReasoningEnabled(e,t){var i,r,o,a,c,u;const n=(i=this.State)==null?void 0:i.Reasoning;if(n&&n.ProviderId===e&&n.ModelId===t)return!!n.Enabled;const s=this.BuildReasoningKey?this.BuildReasoningKey(e,t):`${e}:${t}`;return!!((u=(c=(a=(o=(r=this.State)==null?void 0:r.Settings)==null?void 0:o.Chat)==null?void 0:a.ReasoningPreferences)==null?void 0:c[s])!=null&&u.Enabled)},FindMessageLocation(e){const t=Object.entries(this.State.MessagesByConversation??{});for(const[n,s]of t){const i=(s??[]).find(r=>r.Id===e);if(i)return{ConversationId:n,Message:i}}return null},FindMessageGroupLocation(e){const t=Object.entries(this.State.MessageGroupsByConversation??{});for(const[n,s]of t){const i=(s??[]).find(r=>r.Id===e);if(i)return{ConversationId:n,Group:i}}return null},FindMessageGroupByAssistantId(e,t){var s;return(((s=this.State.MessageGroupsByConversation)==null?void 0:s[e])??[]).find(i=>i.AssistantMessageId===t)??null},AppendInternalMessage({ConversationId:e,MessageGroupId:t,AssistantMessageId:n,ProviderId:s,ModelId:i,Content:r,Classification:o}){var S,w,A;const a=(r??"").toString();if(!a.trim())return;const c=Ue.CreateMessage({ConversationId:e,Role:"System",Kind:"Internal",Classification:o??"reasoning",Content:a,ProviderId:s,ModelId:i,Status:"done"}),p=[...((S=this.State.MessagesByConversation)==null?void 0:S[e])??[],c],d=(((w=this.State.MessageGroupsByConversation)==null?void 0:w[e])??[]).map(x=>x.Id===t?{...x,InternalMessageIds:[...x.InternalMessageIds??[],c.Id]}:x),m=((A=this.State.ReasoningStepsByConversation)==null?void 0:A[e])??[],f=m.filter(x=>x.MessageId===n).length,v=[...m,{Id:crypto.randomUUID(),MessageId:n,ConversationId:e,StepIndex:f,Content:a,ProviderId:s,ModelId:i,TimestampUtc:new Date().toISOString(),Classification:o??"reasoning"}];this.UpdateState({MessagesByConversation:{...this.State.MessagesByConversation,[e]:p},MessageGroupsByConversation:{...this.State.MessageGroupsByConversation,[e]:d},ReasoningStepsByConversation:{...this.State.ReasoningStepsByConversation??{},[e]:v}})},GetModelConfig(e,t){var r,o,a,c;const n=(a=(o=(r=this.State.Settings)==null?void 0:r.Providers)==null?void 0:o.Providers)==null?void 0:a.find(u=>u.Id===e),s=(c=n==null?void 0:n.Models)==null?void 0:c.find(u=>u.Id===t),i=s?{...s,ProviderId:e}:null;return this.BuildReasoningConfig(i,n,e,t)},BuildReasoningConfig(e,t,n,s){var p,h,d,m,f,v;const i={...(e==null?void 0:e.Capabilities)??{}};!i.Endpoint&&((p=t==null?void 0:t.ApiConventions)!=null&&p.PrimaryEndpoint)&&(i.Endpoint=t.ApiConventions.PrimaryEndpoint);const r=Dr({Provider:t,Model:e});r?i.StreamSchema=r:i.Endpoint==="responses"&&(t==null?void 0:t.Id)==="openai"&&(i.StreamSchema=Je.OpenAiResponsesV1),t&&(i.Provider=t),e&&(i.Model=e);const o=(h=this.State)!=null&&h.Reasoning&&this.State.Reasoning.ModelId===s&&this.State.Reasoning.ProviderId===n?this.State.Reasoning:null,a=this.BuildReasoningKey?this.BuildReasoningKey(n,s):`${n}:${s}`,c=((v=(f=(m=(d=this.State)==null?void 0:d.Settings)==null?void 0:m.Chat)==null?void 0:f.ReasoningPreferences)==null?void 0:v[a])??null,u=o??c;return u?{...i,ReasoningPreference:u}:i},InferTitle(e){var s;const t=((s=e.split(`
`)[0])==null?void 0:s.trim())??"",n=48;return t.length<=n?t||"New chat":`${t.slice(0,n-3)}...`},BuildPreview(e){var s;const t=((s=e.split(`
`)[0])==null?void 0:s.trim())??"",n=72;return t.length<=n?t:`${t.slice(0,n-3)}...`},UpdateConversationPreview(e,t,n,s,i){const r=(e??[]).map(a=>a.Id!==t?a:{...Ue.TouchConversation(a,{ProviderId:s,ModelId:i}),Preview:n}),o=r.find(a=>a.Id===t);return o?[o,...r.filter(a=>a.Id!==t)]:r},BuildMessageAttachments(e){return(e??[]).map(t=>({AttachmentId:t.AttachmentId??null,Name:t.Name??"",MimeType:t.MimeType??"",SizeBytes:t.SizeBytes??0,Status:t.Status??"pending",AddedAt:t.AddedAt??null,ProviderId:t.ProviderId??null,ModelId:t.ModelId??null,Blob:t.Blob??null,DownloadUrl:this.ResolveAttachmentDownloadUrl(t)}))},ResolveAttachmentDownloadUrl(e){const t=(e==null?void 0:e.DownloadUrl)??null;if(t)return t;const n=(e==null?void 0:e.Blob)??null;return!n||typeof(URL==null?void 0:URL.createObjectURL)!="function"?null:URL.createObjectURL(n)},UpdateConversationScroll(e,t){const n=(this.State.Conversations??[]).map(s=>s.Id===e?{...s,ScrollPosition:t}:s);this.UpdateState({Conversations:n},{Render:!1})},async YieldToBrowser(){return await new Promise(e=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(()=>e());return}setTimeout(e,0)})},ScheduleModelDescriptionClear(){var t;const e=((t=this.State.Layout)==null?void 0:t.ModelDescriptionDurationMs)??5e3;this.ModelDescriptionTimer&&clearTimeout(this.ModelDescriptionTimer),this.ModelDescriptionTimer=setTimeout(()=>{var n,s;(s=(n=this.State)==null?void 0:n.ModelSelection)!=null&&s.DescriptionText&&this.UpdateState({ModelSelection:{...this.State.ModelSelection,DescriptionText:null}})},e)},ResolveFriendlyError(e){const t=(e==null?void 0:e.Status)??(e==null?void 0:e.status)??null,n=(e==null?void 0:e.message)??"Request failed.";return t===401||t===403?`${n} (Authentication failed or key invalid)`:t===429?`${n} (Rate limit or quota exceeded)`:t&&typeof t=="number"?`${n} (HTTP ${t})`:n}})},oo="draft",ao=l=>{Object.assign(l.prototype,{ResolveAttachmentDefaults(){var e,t,n;return((e=this.State)==null?void 0:e.AttachmentDefaults)??((n=(t=this.AttachmentsService)==null?void 0:t.ResolveDefaults)==null?void 0:n.call(t,{Catalog:null}))??null},ResolveAttachmentCapability({ProviderId:e,ModelId:t}={}){var i,r,o,a,c;const n=this.ResolveAttachmentDefaults()??{},s=((o=(r=(i=this.State)==null?void 0:i.Settings)==null?void 0:r.Providers)==null?void 0:o.Providers)??[];return((c=(a=this.AttachmentsService)==null?void 0:a.ResolveCapability)==null?void 0:c.call(a,{ProviderId:e,ModelId:t,ProvidersCatalog:s,Defaults:n}))??null},RefreshAttachmentCapability(e,t){const n=this.ResolveAttachmentCapability({ProviderId:e,ModelId:t});return this.UpdateState({AttachmentCapability:n},{Render:!1}),n},GetDraftId(e){return e??oo},async LoadDraftAttachmentsAsync(e){var r,o,a,c,u,p,h,d,m,f,v,S,w;const t=this.GetDraftId(e),n=await((o=(r=this.AttachmentStore)==null?void 0:r.LoadDraftAsync)==null?void 0:o.call(r,t)),s=await((c=(a=this.AttachmentStore)==null?void 0:a.PurgeExpiredAsync)==null?void 0:c.call(a,t,Date.now())),i=(s==null?void 0:s.Attachments)??(n==null?void 0:n.Attachments)??[];return(u=s==null?void 0:s.Removed)!=null&&u.length&&this.ShowSnackbar(((d=(h=(p=this.State)==null?void 0:p.Text)==null?void 0:h.Attachments)==null?void 0:d.ExpiredError)??"Attachment expired."),(f=(m=this.AppStateStore)==null?void 0:m.SaveDraftAttachmentContext)==null||f.call(m,{DraftId:t,UpdatedUtc:new Date().toISOString()}),(w=(v=this.Logger)==null?void 0:v.LogAttachmentEvent)==null||w.call(v,"Load",{DraftId:t,Total:i.length,Removed:((S=s==null?void 0:s.Removed)==null?void 0:S.length)??0}),this.UpdateState({DraftAttachments:i},{Render:!1}),i},async AddDraftAttachmentsAsync(e){var p,h,d,m,f,v,S,w,A,x,I,P,y;const t=this.State.Models.find(L=>L.Id===this.State.SelectedModelId),n=(t==null?void 0:t.ProviderId)??null,s=(t==null?void 0:t.Id)??null,i=this.ResolveAttachmentDefaults()??{},r=this.RefreshAttachmentCapability(n,s);if(!(r!=null&&r.SupportsAttachments)){this.ShowSnackbar(((d=(h=(p=this.State)==null?void 0:p.Text)==null?void 0:h.Attachments)==null?void 0:d.UnsupportedError)??"Attachments are not supported.");return}const o=this.State.DraftAttachments??[],a=this.AttachmentsService.ValidateFiles({Files:e,ExistingAttachments:o,Capability:r,RetentionDays:i.RetentionDays});if((S=(m=this.Logger)==null?void 0:m.LogAttachmentEvent)==null||S.call(m,"Validate",{ProviderId:n,ModelId:s,Incoming:Array.from(e??[]).length,Accepted:((f=a.Attachments)==null?void 0:f.length)??0,Errors:((v=a.Errors)==null?void 0:v.map(L=>L.Code))??[]}),(w=a.Errors)!=null&&w.length&&this.ShowAttachmentErrors(a.Errors,r),!((A=a.Attachments)!=null&&A.length))return;const c=this.GetDraftId(this.State.ActiveConversationId),u=await((I=(x=this.AttachmentStore)==null?void 0:x.AddAttachmentsAsync)==null?void 0:I.call(x,c,a.Attachments));(y=(P=this.Logger)==null?void 0:P.LogAttachmentEvent)==null||y.call(P,"Add",{ProviderId:n,ModelId:s,DraftId:c,Total:(u==null?void 0:u.length)??0}),this.UpdateState({DraftAttachments:u},{Render:!0})},async RemoveDraftAttachmentAsync(e){var s,i,r,o;const t=this.GetDraftId(this.State.ActiveConversationId),n=await((i=(s=this.AttachmentStore)==null?void 0:s.RemoveAttachmentAsync)==null?void 0:i.call(s,t,e));(o=(r=this.Logger)==null?void 0:r.LogAttachmentEvent)==null||o.call(r,"Remove",{DraftId:t,AttachmentId:e}),this.UpdateState({DraftAttachments:n??[]},{Render:!0})},async ClearDraftAttachmentsAsync(e){var n,s,i,r,o,a;const t=this.GetDraftId(e);await((s=(n=this.AttachmentStore)==null?void 0:n.ClearDraftAsync)==null?void 0:s.call(n,t)),(r=(i=this.AppStateStore)==null?void 0:i.SaveDraftAttachmentContext)==null||r.call(i,null),(a=(o=this.Logger)==null?void 0:o.LogAttachmentEvent)==null||a.call(o,"Clear",{DraftId:t}),(e===this.State.ActiveConversationId||!e&&!this.State.ActiveConversationId)&&this.UpdateState({DraftAttachments:[]},{Render:!0})},async MigrateDraftAttachmentsAsync(e,t){var o,a,c,u,p,h,d,m;const n=this.GetDraftId(e),s=this.GetDraftId(t);if(!n||!s||n===s)return;const i=await((a=(o=this.AttachmentStore)==null?void 0:o.LoadDraftAsync)==null?void 0:a.call(o,n)),r=(i==null?void 0:i.Attachments)??[];r.length&&(await((u=(c=this.AttachmentStore)==null?void 0:c.SaveDraftAsync)==null?void 0:u.call(c,s,r)),await((h=(p=this.AttachmentStore)==null?void 0:p.ClearDraftAsync)==null?void 0:h.call(p,n)),(m=(d=this.Logger)==null?void 0:d.LogAttachmentEvent)==null||m.call(d,"Migrate",{From:n,To:s,Total:r.length}),this.State.ActiveConversationId===t&&this.UpdateState({DraftAttachments:r},{Render:!0}))},async RevalidateDraftAttachmentsAsync(e,t){var a,c,u,p,h,d,m;const n=this.ResolveAttachmentDefaults()??{},s=this.RefreshAttachmentCapability(e,t),i=this.State.DraftAttachments??[];if(!i.length)return;const r=this.AttachmentsService.RevalidateAttachments({Attachments:i,Capability:s,RetentionDays:n.RetentionDays});(p=(a=this.Logger)==null?void 0:a.LogAttachmentEvent)==null||p.call(a,"Revalidate",{ProviderId:e,ModelId:t,Total:((c=r.Attachments)==null?void 0:c.length)??0,Errors:((u=r.Errors)==null?void 0:u.map(f=>f.Code))??[]});const o=this.GetDraftId(this.State.ActiveConversationId);await((d=(h=this.AttachmentStore)==null?void 0:h.SaveDraftAsync)==null?void 0:d.call(h,o,r.Attachments)),this.UpdateState({DraftAttachments:r.Attachments},{Render:!0}),(m=r.Errors)!=null&&m.length&&this.ShowAttachmentErrors(r.Errors,s)},ShowAttachmentErrors(e,t){var r,o;if(!(e!=null&&e.length))return;const n=((o=(r=this.State)==null?void 0:r.Text)==null?void 0:o.Attachments)??{},s=e.map(a=>{switch(a.Code){case ne.Unsupported:return n.UnsupportedError??"Attachments are not supported.";case ne.MaxCount:return n.MaxCountError??"Attachment limit reached.";case ne.MaxSize:return n.MaxSizeError??"File exceeds size limit.";case ne.InvalidType:return n.InvalidTypeError??"Unsupported file type.";default:return n.GenericError??"Attachment error."}}),i=Array.from(new Set(s));this.ShowSnackbar(i.join(" "))}})};class ze{constructor({Configuration:e,Logger:t,RootView:n,AppStateStore:s,ProvidersStore:i,ProviderCatalogService:r,ProviderValidationService:o,ConversationStore:a,AttachmentStore:c,AttachmentsService:u,ChatService:p,ChatSearchService:h}){this.Configuration=e,this.Logger=t,this.RootView=n,this.AppStateStore=s,this.ProvidersStore=i,this.ProviderCatalogService=r,this.ProviderValidationService=o,this.ConversationStore=a,this.AttachmentStore=c,this.AttachmentsService=u,this.ChatService=p,this.ChatSearchService=h??new vs,this.SendAbortController=null,this.ChatSearchDebounceTimer=null,this.State=null}async StartAsync(){var v,S,w,A,x,I,P,y,L,H,M;this.Logger.LogFlowStart("App.Start",{Environment:this.Configuration[J.App][Dn.Environment]});const e=document.getElementById("app");if(!e)throw this.Logger.LogError("App.Start.MissingContainer",{ContainerId:"app"}),new Error("App container not found.");const t=await this.AppStateStore.LoadStateAsync();let n=null,s=null;try{n=await((v=this.ConversationStore)==null?void 0:v.LoadStateAsync())}catch(C){s=C,this.Logger.LogError("Conversation.State.LoadFailed",{Error:(C==null?void 0:C.message)??"Unknown error"})}const i=await this.ProviderCatalogService.LoadCatalogAsync(),r=((w=(S=this.AttachmentsService)==null?void 0:S.ResolveDefaults)==null?void 0:w.call(S,{Catalog:i}))??null,o=eo({ActiveConversationId:null,ProvidersCatalog:(i==null?void 0:i.Providers)??[],AttachmentDefaults:r}),a=this.MergeState(o,t),c=this.Configuration[J.App][Dn.Name];a.Text=this.BuildText(a.Text,{AppName:c}),a.ChatSearch=a.ChatSearch??{IsOpen:!1,Query:"",Results:[],Error:null};const u=this.NormalizeStoredConversationState(n);u&&(a.Conversations=u.Conversations??a.Conversations,a.MessagesByConversation=u.MessagesByConversation??a.MessagesByConversation,a.MessageGroupsByConversation=u.MessageGroupsByConversation??{},a.ReasoningStepsByConversation=u.ReasoningStepsByConversation??{}),a.ActiveConversationId&&!a.Conversations.some(C=>C.Id===a.ActiveConversationId)&&(a.ActiveConversationId=null),!a.ActiveConversationId&&a.Conversations.length>0&&(a.ActiveConversationId=a.Conversations[0].Id);const p=this.ProvidersStore.LoadProviderKeys();a.Settings.Providers.Keys={...a.Settings.Providers.Keys,...p},a.Settings.Providers.KeyVisibility={},a.Settings.Providers.ValidationPopup=null;const h=this.ProvidersStore.LoadProviderModelStates();a.Settings.Providers.Providers=this.ApplyProviderModelStates(a.Settings.Providers.Providers,h);const d=this.ProvidersStore.LoadProviderAvailability();a.Settings.Providers.ModelAvailability=this.MergeAvailability(a.Settings.Providers.Providers,d),a.Settings.Chat.Requests=a.Settings.Chat.Requests??{},a.Settings.Chat.Requests.MaxOutputTokens=((I=(x=(A=this.Configuration)==null?void 0:A[J.Chat])==null?void 0:x.Requests)==null?void 0:I.MaxOutputTokens)??null;const m=((y=(P=this.Configuration)==null?void 0:P[J.Chat])==null?void 0:y.ProviderOverrides)??{};a.Settings.Providers.RequestOverrides={...a.Settings.Providers.RequestOverrides,...Object.fromEntries(Object.entries(m).map(([C,$])=>{var B;return[C,{Requests:{MaxOutputTokens:((B=$==null?void 0:$.Requests)==null?void 0:B.MaxOutputTokens)??null}}]}))},this.State=this.ResolveReasoningState(this.RefreshModelSelectorState(a));const f=this.State.Models.find(C=>C.Id===this.State.SelectedModelId)??null;this.RefreshAttachmentCapability((f==null?void 0:f.ProviderId)??null,(f==null?void 0:f.Id)??null),await this.LoadDraftAttachmentsAsync(this.State.ActiveConversationId),this.Render(e),s&&this.ShowSnackbar((M=(H=(L=this.State)==null?void 0:L.Text)==null?void 0:H.ChatSaving)==null?void 0:M.StorageErrorText),this.Logger.LogFlowEnd("App.Start",{Rendered:!0})}Render(e){this.RootView.Render(e,this.State,{onToggleSidebar:()=>{this.UpdateState({IsSidebarCollapsed:!this.State.IsSidebarCollapsed})},onStartNewChat:()=>{this.RequestNewChat()},onTogglePin:()=>{this.RequestTogglePin()},onUpdatePinName:t=>{this.UpdatePinDialogName(t)},onConfirmPin:()=>{this.ConfirmPinFromDialog()},onCancelPin:()=>{this.ClosePinDialog()},onConfirmDiscard:()=>{this.ConfirmDiscard()},onCancelDiscard:()=>{this.CloseDiscardDialog()},onSelectModel:t=>{const n=this.State.Models.find(i=>i.Id===t),s={LastUserSelectedModelId:t,AutoSelectedModelId:null,DescriptionText:(n==null?void 0:n.Description)??""};this.UpdateState({SelectedModelId:t,ModelSelection:s}),this.ScheduleModelDescriptionClear(),n&&this.RevalidateDraftAttachmentsAsync(n.ProviderId,n.Id).catch(i=>{this.Logger.LogError("Attachments.Revalidate.Failed",{Error:(i==null?void 0:i.message)??"Unknown error"})})},onSelectConversation:t=>{this.RequestSelectConversation(t)},onOpenChatSearch:()=>{this.OpenChatSearch()},onCloseChatSearch:()=>{this.CloseChatSearch()},onUpdateChatSearchQuery:t=>{this.UpdateChatSearchQuery(t)},onSelectChatSearchResult:t=>{this.RequestSelectChatSearchResult(t)},onUpdateChatMaxOutputTokens:t=>{this.UpdateChatMaxOutputTokens(t)},onUpdateProviderMaxOutputTokens:(t,n)=>{this.UpdateProviderMaxOutputTokens(t,n)},onScrollConversation:t=>{const n=this.State.ActiveConversationId;n&&this.UpdateConversationScroll(n,t)},onUpdateInput:t=>{this.UpdateState({InputText:t},{Render:!1})},onSendMessage:()=>{this.SendMessageAsync().catch(t=>{this.Logger.LogError("Chat.Send.Failed",{Error:(t==null?void 0:t.message)??"Unknown error"})})},onAddAttachments:t=>{this.AddDraftAttachmentsAsync(t).catch(n=>{this.Logger.LogError("Attachments.Add.Failed",{Error:(n==null?void 0:n.message)??"Unknown error"})})},onRemoveAttachment:t=>{this.RemoveDraftAttachmentAsync(t).catch(n=>{this.Logger.LogError("Attachments.Remove.Failed",{Error:(n==null?void 0:n.message)??"Unknown error"})})},onAbortSend:()=>{this.AbortSend()},onRetryMessage:t=>{this.OpenRetryPopup(t)},onCloseRetryPopup:()=>{this.UpdateState({RetryPopup:null})},onConfirmRetry:t=>{this.ConfirmRetryAsync(t).catch(n=>{this.Logger.LogError("Chat.Retry.Failed",{Error:(n==null?void 0:n.message)??"Unknown error"})})},onToggleInternalGroup:t=>{this.ToggleInternalGroup(t)},onToggleReasoning:t=>{this.UpdateReasoningPreference((n,s)=>s.ControlType==="toggle"?{...n,Enabled:t,ToggleState:t?"on":"off"}:{...n,Enabled:t})},onSelectReasoningEffort:t=>{const n=t&&t!=="off";this.UpdateReasoningPreference(s=>({...s,Enabled:n,EffortLevel:n?t:null}))},onSelectReasoningToggle:t=>{const n=t==="on";this.UpdateReasoningPreference(s=>({...s,Enabled:n,ToggleState:t}))},onUpdateReasoningBudget:t=>{if(t===""||t==null){this.UpdateReasoningPreference(i=>({...i,Enabled:!1,TokenBudget:null}));return}const n=Number(t),s=Number.isFinite(n)&&n>=0?n:null;s!=null&&this.UpdateReasoningPreference(i=>({...i,Enabled:!0,TokenBudget:s}))},onOpenSettings:()=>{this.UpdateSettings(t=>({...t,IsOpen:!0}))},onCloseSettings:()=>{this.UpdateSettings(t=>({...t,IsOpen:!1}))},onSelectSettingsCategory:t=>{this.UpdateSettings(n=>({...n,ActiveCategory:t}))},onUpdateTheme:t=>{this.UpdateSettings(n=>({...n,General:{...n.General,Theme:t}}))},onToggleInternalMessages:t=>{this.UpdateSettings(n=>({...n,Chat:{...n.Chat,InternalChatMessages:t}}))},onUpdateAccent:t=>{this.UpdateSettings(n=>({...n,General:{...n.General,AccentColor:t}}))},onSelectProvider:t=>{this.UpdateSettings(n=>({...n,Providers:{...n.Providers,SelectedProviderId:t}}))},onBackToProviders:()=>{this.UpdateSettings(t=>({...t,Providers:{...t.Providers,SelectedProviderId:null}}))},onUpdateProviderKey:(t,n)=>{const s=this.ProvidersStore.SetProviderKey(t,n);this.State=this.RefreshModelSelectorState({...this.State,Settings:{...this.State.Settings,Providers:{...this.State.Settings.Providers,Keys:s}}}),this.ResetProviderAvailability(t)},onClearProviderKey:t=>{const n=this.ProvidersStore.ClearProviderKey(t);this.State=this.RefreshModelSelectorState({...this.State,Settings:{...this.State.Settings,Providers:{...this.State.Settings.Providers,Keys:n}}}),this.ResetProviderAvailability(t)},onToggleProviderKeyVisibility:t=>{const n=this.State.Settings.Providers.KeyVisibility??{},s={...n,[t]:!n[t]};this.UpdateSettings(i=>({...i,Providers:{...i.Providers,KeyVisibility:s}}))},onTestProviderKey:async t=>{var o;const n=((o=this.State.Settings.Providers.Keys)==null?void 0:o[t])??"",s=this.State.Settings.Providers.Providers.find(a=>a.Id===t),i=(s==null?void 0:s.Models)??[];this.UpdateSettings(a=>({...a,Providers:{...a.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"working",Message:"Testing key...",Progress:{Current:0,Total:i.length},CurrentModel:null}}}));const r=await this.ProviderValidationService.ValidateAsync(t,n);if(r.Status!=="success"){this.UpdateSettings(a=>({...a,Providers:{...a.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:r.Status,Message:r.Message}}}));return}for(let a=0;a<i.length;a+=1){const c=i[a];this.UpdateSettings(u=>({...u,Providers:{...u.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"working",Message:"Checking model availability...",Progress:{Current:a+1,Total:i.length},CurrentModel:c.Label??c.Id}}})),await this.YieldToBrowser()}this.UpdateSettings(a=>{const c=a.Providers.ModelAvailability??{},u=this.BuildModelAvailability(r.ModelIds??[],i),p={...c,[t]:u};this.ProvidersStore.SetProviderAvailability(t,u);const h=this.ApplyModelAvailability(a.Providers.Providers,t,u),d={...a,Providers:{...a.Providers,Providers:h,ModelAvailability:p,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"success",Message:r.Message}}},m=this.ResolveModelSelectionState({Providers:d.Providers.Providers,ModelAvailability:d.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:d,Models:m.Models,SelectedModelId:m.SelectedModelId,ModelSelection:m.ModelSelection}})},onCloseProviderValidationPopup:()=>{this.UpdateSettings(t=>({...t,Providers:{...t.Providers,ValidationPopup:null}}))},onToggleProviderModel:(t,n,s)=>{this.ProvidersStore.SetProviderModelState(t,n,s),this.UpdateSettings(i=>{const r=i.Providers.Providers.map(a=>a.Id!==t?a:{...a,Models:a.Models.map(c=>c.Id===n?{...c,Enabled:s}:c)}),o=this.ResolveModelSelectionState({Providers:r,ModelAvailability:i.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:{...i,Providers:{...i.Providers,Providers:r}},Models:o.Models,SelectedModelId:o.SelectedModelId,ModelSelection:o.ModelSelection}})}})}UpdateSettings(e){const t=e(this.State.Settings);if(t&&t.Settings){this.UpdateState(t);return}this.UpdateState({Settings:t})}UpdateChatMaxOutputTokens(e){const t=this.ParseMaxTokens(e);this.UpdateSettings(n=>{var i;const s={...n,Chat:{...n.Chat,Requests:{...((i=n.Chat)==null?void 0:i.Requests)??{},MaxOutputTokens:t}}};return this.Configuration[J.Chat]=this.Configuration[J.Chat]??{},this.Configuration[J.Chat].Requests={...this.Configuration[J.Chat].Requests??{},MaxOutputTokens:t},s})}UpdateProviderMaxOutputTokens(e,t){if(!e)return;const n=this.ParseMaxTokens(t);this.UpdateSettings(s=>{var c;const i=s.Providers.RequestOverrides??{},r=i[e]??{},o={...i,[e]:{...r,Requests:{...r.Requests??{},MaxOutputTokens:n}}};this.Configuration[J.Chat]=this.Configuration[J.Chat]??{};const a=this.Configuration[J.Chat].ProviderOverrides??{};return this.Configuration[J.Chat].ProviderOverrides={...a,[e]:{...a[e]??{},Requests:{...((c=a[e])==null?void 0:c.Requests)??{},MaxOutputTokens:n}}},{...s,Providers:{...s.Providers,RequestOverrides:o}}})}ParseMaxTokens(e){if(e==null)return null;const t=e.toString().trim();if(!t)return null;const n=Number(t);return Number.isFinite(n)&&n>0?n:null}UpdateState(e,{Render:t=!0}={}){const n={...this.State,...e};if(this.State=this.ResolveReasoningState(n),this.PersistState(),t){const s=document.getElementById("app");this.Render(s)}}UpdateReasoningPreference(e){var s;const t=(s=this.State)==null?void 0:s.Reasoning;if(!t)return;const n=this.BuildReasoningKey(t.ProviderId,t.ModelId);this.UpdateSettings(i=>{var c;const r=((c=i.Chat)==null?void 0:c.ReasoningPreferences)??{},o=r[n]??{},a=e(o,t);return{...i,Chat:{...i.Chat,ReasoningPreferences:{...r,[n]:{...a,LastUpdatedUtc:new Date().toISOString()}}}}})}ResolveReasoningState(e){var f,v,S,w;const t=(e.Models??[]).find(A=>A.Id===e.SelectedModelId);if(!t)return{...e,Reasoning:null};const n=((f=t.Capabilities)==null?void 0:f.Reasoning)??null,s=(n==null?void 0:n.Control)??null;if(!s)return{...e,Reasoning:null};const i=s.Type??null,r=(n==null?void 0:n.Signals)===!0,o=i&&i!=="implicit";if(!(o||i==="implicit"&&r))return{...e,Reasoning:null};const c=this.BuildReasoningKey(t.ProviderId,t.Id),u=((w=(S=(v=e.Settings)==null?void 0:v.Chat)==null?void 0:S.ReasoningPreferences)==null?void 0:w[c])??{},p=s.Allowed??[],h=s.Range??null,d=i==="implicit"?!!r:!1,m=u.Enabled??d;return{...e,Reasoning:{ProviderId:t.ProviderId,ModelId:t.Id,ControlType:i,Allowed:p,Range:h,Enabled:m,EffortLevel:u.EffortLevel??(p==null?void 0:p[0])??null,TokenBudget:u.TokenBudget??null,ToggleState:u.ToggleState??(p==null?void 0:p[0])??"on",IsConfigurable:o,HasSignals:r}}}BuildReasoningKey(e,t){return`${e}:${t}`}}to(ze);no(ze);so(ze);io(ze);ro(ze);ao(ze);class lo{static Build(){const e=new Ks,t=new zs,n=new Fs({Fetch:(...y)=>globalThis.fetch(...y),Logger:e,Paths:t}),s=new qs,i=new js({Storage:globalThis.localStorage}),r=new Vs({DbName:"ghostplug",StoreName:"state",StoreNames:["attachments"],Version:2}),o=new Ws({AppStateProvider:r,KeyStorage:i}),a=new Js({KeyStorage:i}),c=new Fe,u=new Rr({Logger:e}),p=new Ar({Fetch:(...y)=>globalThis.fetch(...y),Logger:e,EnvironmentName:"production"}),h=new Ir({Catalog:p}),d=[new xr({Fetch:(...y)=>globalThis.fetch(...y)}),new Mr({Fetch:(...y)=>globalThis.fetch(...y)}),new wr({Fetch:(...y)=>globalThis.fetch(...y)}),new Tr({Fetch:(...y)=>globalThis.fetch(...y)})],m=new kr({Providers:d}),f=new Lr({Providers:d}),v=new Er,S=new Hr({Logger:e}),w=new vs,A=new Jr({Configuration:null,Logger:e}),x=new zr({ChatRegistry:f,ContextBuilder:v,ChatLogger:S,Configuration:null,Fetch:(...y)=>globalThis.fetch(...y)}),I=new Pr({ProviderRegistry:m,ProviderLogger:u});return{ConfigurationService:n,LoggerFactory:s,AppFactory:({Configuration:y,Logger:L})=>{var C,$;const H=new Qs({StorageProvider:r,StorageKey:(($=(C=y==null?void 0:y.Storage)==null?void 0:C.Keys)==null?void 0:$.Conversations)??"Ghostplug.Conversations"}),M=new Ys({StorageProvider:r,StoreName:"attachments"});return S.Logger=L,u.Logger=L,A.Logger=L,x.Configuration=y,A.Configuration=y,new ze({Configuration:y,Logger:L,RootView:c,AppStateStore:o,ProvidersStore:a,ProviderCatalogService:h,ProviderValidationService:I,ConversationStore:H,ChatService:x,AttachmentStore:M,AttachmentsService:A,ChatSearchService:w})},EnvironmentName:"production"}}}const co=new Ns(lo.Build());co.StartAsync();
