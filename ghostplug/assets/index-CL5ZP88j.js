var Es=Object.defineProperty;var Ds=(a,e,t)=>e in a?Es(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var U=(a,e,t)=>Ds(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();class _s{constructor({ConfigurationService:e,LoggerFactory:t,AppFactory:n,EnvironmentName:s}){this.ConfigurationService=e,this.LoggerFactory=t,this.AppFactory=n,this.EnvironmentName=s}async StartAsync(){try{const e=await this.ConfigurationService.LoadAsync(this.EnvironmentName),t=this.LoggerFactory.CreateFromConfiguration(e);t.LogFlowStart("Bootstrap.Start",{EnvironmentName:this.EnvironmentName}),await this.AppFactory({Configuration:e,Logger:t}).StartAsync(),t.LogFlowEnd("Bootstrap.Start",{Success:!0})}catch(e){console.error("Bootstrap failed",e)}}}class Os{Merge(e,t){if(e==null)return this.CloneValue(t);if(t==null)return this.CloneValue(e);if(Array.isArray(e)||Array.isArray(t))return this.CloneValue(t);if(typeof e=="object"&&typeof t=="object"){const n={...e};return Object.keys(t).forEach(s=>{n[s]=this.Merge(e[s],t[s])}),n}return this.CloneValue(t)}CloneValue(e){return e==null?e:JSON.parse(JSON.stringify(e))}}class $s{constructor({Fetch:e,Logger:t,Paths:n}){this.Fetch=e,this.Logger=t,this.Paths=n,this.Merger=new Os}async LoadAsync(e){this.Logger.LogFlowStart("Configuration.Load",{EnvironmentName:e});const t=await this.FetchJsonAsync(this.Paths.GetDefaultPath(),!1),n=await this.FetchJsonAsync(this.Paths.GetEnvironmentPath(e),!0),s=this.Merger.Merge(t,n);return this.Logger.LogFlowEnd("Configuration.Load",{EnvironmentName:e,HasOverrides:!!n}),s}async FetchJsonAsync(e,t){const n=await this.Fetch(e);if(!n.ok){if(t)return this.Logger.LogWarning("Configuration.Load.Missing",{Path:e}),null;throw this.Logger.LogError("Configuration.Load.Failed",{Path:e,Status:n.status}),new Error(`Configuration fetch failed for ${e}`)}return await n.json()}}class Us{constructor({RootPath:e="config",DefaultFileName:t="default.json",EnvironmentPrefix:n="env."}={}){this.RootPath=e,this.DefaultFileName=t,this.EnvironmentPrefix=n}GetDefaultPath(){return`${this.RootPath}/${this.DefaultFileName}`}GetEnvironmentPath(e){return`${this.RootPath}/${this.EnvironmentPrefix}${e}.json`}}const Nt=Object.freeze({Trace:0,Debug:1,Information:2,Warning:3,Error:4,Critical:5}),ie=Object.freeze({Trace:"Trace",Debug:"Debug",Information:"Information",Warning:"Warning",Error:"Error",Critical:"Critical"}),Oe=Object.freeze({App:"App",Logging:"Logging",Storage:"Storage",Providers:"Providers",Chat:"Chat",Ui:"Ui",Pwa:"Pwa"}),An=Object.freeze({Name:"Name",Version:"Version",Environment:"Environment"}),Bt=Object.freeze({MinimumLevel:"MinimumLevel",EnableDebug:"EnableDebug",MaxPayloadLength:"MaxPayloadLength"}),Rn=Object.freeze({Requests:"Requests",ProviderOverrides:"ProviderOverrides"}),qe=Object.freeze({TimeoutMs:"TimeoutMs",MaxRetries:"MaxRetries",BackoffMs:"BackoffMs",MaxOutputTokens:"MaxOutputTokens"}),Ns=Object.freeze({Trace:"trace",Debug:"debug",Information:"info",Warning:"warn",Error:"error",Critical:"error"});class Bs{constructor(e){const t=e[Oe.Logging]??{};this.MinimumLevelName=t[Bt.MinimumLevel]??ie.Information,this.EnableDebug=t[Bt.EnableDebug]??!1,this.MaxPayloadLength=t[Bt.MaxPayloadLength]??4096,this.MinimumLevel=Nt[this.MinimumLevelName]??Nt.Information}LogFlowStart(e,t){this.Log(ie.Information,"Flow.Start",{FlowName:e,Parameters:t})}LogFlowEnd(e,t){this.Log(ie.Information,"Flow.End",{FlowName:e,Result:t})}LogBranch(e,t,n){this.Log(ie.Debug,"Flow.Branch",{FlowName:e,Branch:t,Details:n})}LogTrace(e,t){this.Log(ie.Trace,e,t)}LogDebug(e,t){this.Log(ie.Debug,e,t)}LogInformation(e,t){this.Log(ie.Information,e,t)}LogWarning(e,t){this.Log(ie.Warning,e,t)}LogError(e,t){this.Log(ie.Error,e,t)}LogCritical(e,t){this.Log(ie.Critical,e,t)}Log(e,t,n){const s=Nt[e];if(!this.IsEnabled(e,s))return;const i={Timestamp:new Date().toISOString(),Level:e,Message:t,Payload:this.TruncatePayload(n)},r=Ns[e]??"log";console[r](i)}IsEnabled(e,t){return!this.EnableDebug&&(e===ie.Debug||e===ie.Trace)?!1:t>=this.MinimumLevel}TruncatePayload(e){if(e==null)return e;const t=JSON.stringify(e);return t.length<=this.MaxPayloadLength?e:{Truncated:!0,Value:`${t.slice(0,this.MaxPayloadLength)}...`}}}class Fs{LogFlowStart(e,t){console.info({Timestamp:new Date().toISOString(),Level:"Information",Message:"Flow.Start",Payload:{FlowName:e,Parameters:t}})}LogFlowEnd(e,t){console.info({Timestamp:new Date().toISOString(),Level:"Information",Message:"Flow.End",Payload:{FlowName:e,Result:t}})}LogBranch(e,t,n){console.debug({Timestamp:new Date().toISOString(),Level:"Debug",Message:"Flow.Branch",Payload:{FlowName:e,Branch:t,Details:n}})}LogTrace(e,t){console.trace({Timestamp:new Date().toISOString(),Level:"Trace",Message:e,Payload:t})}LogDebug(e,t){console.debug({Timestamp:new Date().toISOString(),Level:"Debug",Message:e,Payload:t})}LogInformation(e,t){console.info({Timestamp:new Date().toISOString(),Level:"Information",Message:e,Payload:t})}LogWarning(e,t){console.warn({Timestamp:new Date().toISOString(),Level:"Warning",Message:e,Payload:t})}LogError(e,t){console.error({Timestamp:new Date().toISOString(),Level:"Error",Message:e,Payload:t})}LogCritical(e,t){console.error({Timestamp:new Date().toISOString(),Level:"Critical",Message:e,Payload:t})}}class Hs{CreateFromConfiguration(e){return new Bs(e)}}class Gs{constructor({Storage:e}){this.Storage=e}GetJson(e){const t=this.Storage.getItem(e);return t?JSON.parse(t):null}SetJson(e,t){this.Storage.setItem(e,JSON.stringify(t))}}class zs{constructor({DbName:e="ghostplug",StoreName:t="kv",Version:n=1}={}){this.DbName=e,this.StoreName=t,this.Version=n,this.DbPromise=null}async GetJson(e){const t=await this.OpenAsync();return new Promise((n,s)=>{const o=t.transaction(this.StoreName,"readonly").objectStore(this.StoreName).get(e);o.onsuccess=()=>n(o.result??null),o.onerror=()=>s(o.error)})}async SetJson(e,t){const n=await this.OpenAsync();return new Promise((s,i)=>{const l=n.transaction(this.StoreName,"readwrite").objectStore(this.StoreName).put(t,e);l.onsuccess=()=>s(),l.onerror=()=>i(l.error)})}OpenAsync(){return this.DbPromise?this.DbPromise:(this.DbPromise=new Promise((e,t)=>{const n=indexedDB.open(this.DbName,this.Version);n.onupgradeneeded=()=>{const s=n.result;s.objectStoreNames.contains(this.StoreName)||s.createObjectStore(this.StoreName)},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}),this.DbPromise)}}class Ks{constructor({AppStateProvider:e,KeyStorage:t}){this.AppStateProvider=e,this.KeyStorage=t,this.AppStateKey="ghostplug.app-state",this.ProviderKeysKey="ghostplug.provider-keys",this.ProviderModelsKey="ghostplug.provider-models"}async LoadStateAsync(){return this.AppStateProvider.GetJson(this.AppStateKey)}async SaveStateAsync(e){await this.AppStateProvider.SetJson(this.AppStateKey,e)}LoadProviderKeys(){return this.KeyStorage.GetJson(this.ProviderKeysKey)??{}}SaveProviderKeys(e){this.KeyStorage.SetJson(this.ProviderKeysKey,e??{})}LoadProviderModels(){return this.KeyStorage.GetJson(this.ProviderModelsKey)??{}}SaveProviderModels(e){this.KeyStorage.SetJson(this.ProviderModelsKey,e??{})}}class qs{constructor({KeyStorage:e}){this.KeyStorage=e,this.ProviderKeysKey="ghostplug.provider-keys",this.ProviderModelsKey="ghostplug.provider-models",this.ProviderAvailabilityKey="ghostplug.provider-availability"}LoadProviderKeys(){return this.KeyStorage.GetJson(this.ProviderKeysKey)??{}}SaveProviderKeys(e){this.KeyStorage.SetJson(this.ProviderKeysKey,e??{})}SetProviderKey(e,t){const s={...this.LoadProviderKeys(),[e]:t};return this.SaveProviderKeys(s),s}ClearProviderKey(e){const n={...this.LoadProviderKeys(),[e]:""};return this.SaveProviderKeys(n),n}LoadProviderModelStates(){return this.KeyStorage.GetJson(this.ProviderModelsKey)??{}}SaveProviderModelStates(e){this.KeyStorage.SetJson(this.ProviderModelsKey,e??{})}SetProviderModelState(e,t,n){const s=this.LoadProviderModelStates(),i={...s[e]??{},[t]:n},r={...s,[e]:i};return this.SaveProviderModelStates(r),r}LoadProviderAvailability(){return this.KeyStorage.GetJson(this.ProviderAvailabilityKey)??{}}SaveProviderAvailability(e){this.KeyStorage.SetJson(this.ProviderAvailabilityKey,e??{})}SetProviderAvailability(e,t){const s={...this.LoadProviderAvailability(),[e]:{...t??{}}};return this.SaveProviderAvailability(s),s}}class Vs{constructor({StorageProvider:e,StorageKey:t}={}){this.StorageProvider=e,this.StorageKey=t??"Ghostplug.Conversations"}async LoadStateAsync(){var t;const e=await((t=this.StorageProvider)==null?void 0:t.GetJson(this.StorageKey));return this.NormalizeState(e)}async SaveStateAsync(e){var n;const t=this.NormalizeState(e);await((n=this.StorageProvider)==null?void 0:n.SetJson(this.StorageKey,t))}async SaveConversationAsync(e){const t=await this.LoadStateAsync(),n=this.UpsertById(t.Conversations,e);await this.SaveStateAsync({...t,Conversations:n})}async SaveMessageAsync(e){const t=await this.LoadStateAsync(),n=e.ConversationId,s=t.MessagesByConversation[n]??[],i=this.UpsertById(s,e);await this.SaveStateAsync({...t,MessagesByConversation:{...t.MessagesByConversation,[n]:i}})}async SaveMessageGroupAsync(e){const t=await this.LoadStateAsync(),n=e.ConversationId,s=t.MessageGroupsByConversation[n]??[],i=this.UpsertById(s,e);await this.SaveStateAsync({...t,MessageGroupsByConversation:{...t.MessageGroupsByConversation,[n]:i}})}async SaveScrollPositionAsync(e,t){const n=await this.LoadStateAsync(),s=(n.Conversations??[]).map(i=>i.Id===e?{...i,ScrollPosition:t}:i);await this.SaveStateAsync({...n,Conversations:s})}async SaveInternalVisibilityAsync(e,t,n){const s=await this.LoadStateAsync(),r=(s.MessageGroupsByConversation[e]??[]).map(o=>o.Id===t?{...o,InternalVisible:n}:o);await this.SaveStateAsync({...s,MessageGroupsByConversation:{...s.MessageGroupsByConversation,[e]:r}})}NormalizeState(e){const t=this.NormalizeMessageMap(e==null?void 0:e.MessagesByConversation);return{Conversations:(e==null?void 0:e.Conversations)??[],MessagesByConversation:t,MessageGroupsByConversation:(e==null?void 0:e.MessageGroupsByConversation)??{},ReasoningStepsByConversation:(e==null?void 0:e.ReasoningStepsByConversation)??{}}}NormalizeMessageMap(e){const t=Object.entries(e??{});return Object.fromEntries(t.map(([n,s])=>[n,this.NormalizeMessages(s)]))}NormalizeMessages(e){return(e??[]).map(t=>this.NormalizeMessage(t))}NormalizeMessage(e){if(!e)return e;const t=e.Classification??e.Kind??null,n=typeof e.IsInternal=="boolean"?e.IsInternal:t==="internal"||t==="reasoning"||t==="system-internal"||t==="tool-invocation"||t==="tool-result"||e.Kind==="Internal";return{...e,Classification:t,IsInternal:n}}UpsertById(e,t){const n=[...e??[]],s=n.findIndex(i=>i.Id===t.Id);return s===-1?(n.push(t),n):(n[s]=t,n)}}const lt=(a={})=>Object.entries(a).map(([e,t])=>` data-${e}="${t}"`).join(""),Ft=a=>(a??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),ue=(a,e="")=>`<span class="material-symbols-outlined ${e}">${a}</span>`,Pt=({Icon:a,Material:e,ClassName:t=""}={})=>!a&&!e?"":e?ue(e,t):`<img src="${a}" alt="" class="${t}" />`,Ve=({Icon:a,Material:e,Action:t,AriaLabel:n,ClassName:s="",Disabled:i=!1,Data:r={}})=>`
  <button class="icon-button ${s}" data-action="${t}" aria-label="${n}"${i?" disabled":""}${lt(r)}>
    ${Pt({Icon:a,Material:e})}
  </button>
`,yt=({Icon:a,Material:e,Label:t,Action:n,ClassName:s="",LabelClass:i="",AriaLabel:r,Data:o={}})=>`
  <button class="icon-label-button ${s}" data-action="${n}" aria-label="${r??t}"${lt(o)}>
    ${Pt({Icon:a,Material:e})}
    <span class="icon-label ${i}">${t}</span>
  </button>
`,js=({Icon:a,Material:e,Title:t,Subtitle:n,Action:s,ClassName:i="",Data:r={}})=>{const o=n.toString().trim().length>0,l=Pt({Icon:a,Material:e,ClassName:"two-line-icon"});return`
    <button class="two-line-item ${o?"":"two-line-item-single"} ${i}" data-action="${s}"${lt(r)}>
      ${l}
      <span class="two-line-text">
        <span class="two-line-title" title="${Ft(t)}">${Ft(t)}</span>
        ${o?`<span class="two-line-subtitle">${Ft(n)}</span>`:""}
      </span>
    </button>
  `},mt=a=>`
  <div class="settings-form-title">${a}</div>
  <div class="settings-form-rule"></div>
`,Wt=({MenuId:a,ButtonContent:e,Items:t,SelectedValue:n,Disabled:s=!1})=>{const i=t.map(r=>`
      <button class="settings-dropdown-item ${r.Value===n?"is-selected":""}"${lt(r.Data)}>
        ${r.LeadingHtml??""}
        <span class="dropdown-label">${r.Label}</span>
        ${ue("check","dropdown-check")}
      </button>
    `).join("");return`
    <div class="settings-dropdown">
      <button
        class="settings-dropdown-button"
        data-action="toggle-settings-menu"
        data-menu-id="${a}"
        aria-expanded="false"
        ${s?'disabled aria-disabled="true"':""}
      >
        ${e}
      </button>
      <div class="settings-dropdown-menu hidden" data-settings-menu data-menu-id="${a}">
        ${i}
      </div>
    </div>
  `},Ln=({Checked:a=!1,Disabled:e=!1,Data:t={}})=>`
  <label class="model-switch">
    <input
      type="checkbox"
      class="model-checkbox"
      ${a?"checked":""}
      ${e?"disabled":""}
      ${lt(t)}
    />
    <span class="model-switch-track"></span>
  </label>
`;class Ws{Render({Conversations:e,Text:t,IsSidebarCollapsed:n}){var p;const s=n?"true":"false",r=(e??[]).filter(g=>g==null?void 0:g.IsPinned).map(g=>js({Icon:"assets/icons/chat_bubble_outline.svg",Title:g.Title,Subtitle:"",Action:"select-conversation",Data:{"conversation-id":g.Id},ClassName:"conversation-item"})).join(""),o=yt({Icon:"assets/icons/add.svg",Action:"new-chat",Label:t.Sidebar.NewChat,ClassName:"sidebar-action",LabelClass:"sidebar-label"}),l=yt({Icon:"assets/icons/search.svg",Action:"search-chats",Label:t.Sidebar.Search,ClassName:"sidebar-action",LabelClass:"sidebar-label"}),c=yt({Icon:"assets/icons/settings.svg",Action:"open-settings",Label:t.Sidebar.Settings,ClassName:"sidebar-action",LabelClass:"settings-label"}),u=Ve({Icon:"assets/icons/dock_to_left.svg",Action:"toggle-sidebar",AriaLabel:"Collapse sidebar",ClassName:"sidebar-toggle"});return`
      <aside class="sidebar panel-shadow flex h-full w-72 flex-col gap-4 bg-white sidebar-pad" data-collapsed="${s}">
        <div class="sidebar-header flex items-center justify-between px-1">
          <button class="brand-button flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <span class="brand-icon-wrapper relative inline-flex h-5 w-5 items-center justify-center">
              <img src="assets/icons/logo.svg" alt="" class="brand-icon h-5 w-5" />
              <img src="assets/icons/dock_to_left.svg" alt="" class="toggle-icon hidden h-5 w-5" />
            </span>
            <span class="brand-title font-semibold">${t.AppTitle}</span>
          </button>
          ${u}
        </div>

        <div class="sidebar-actions flex flex-col gap-2 px-1">
          ${o}
          ${l}
        </div>

        <div class="px-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <span class="sidebar-label">${((p=t.ChatSaving)==null?void 0:p.PinnedListTitle)??t.Sidebar.Conversations}</span>
        </div>
        <div class="flex-1 overflow-y-auto pr-1">
          <div class="flex flex-col gap-1">
            ${r}
          </div>
        </div>
        <div class="border-t border-slate-100 pt-3">
          ${c}
        </div>
      </aside>
    `}}class Qs{Render({Models:e,SelectedModelId:t,Text:n,ModelSelection:s,Layout:i}){const r=e.find(m=>m.Id===t)??e[0]??{Label:"No models"},o=(s==null?void 0:s.DescriptionText)??"",l=(i==null?void 0:i.ModelDescriptionDurationMs)??5e3,c=(i==null?void 0:i.ModelDescriptionFadeOutMs)??1e3,u=Math.max(l-c,0),p=o?`style="animation: model-description-fade ${c}ms ease forwards; animation-delay: ${u}ms;"`:"",g=e.reduce((m,S)=>{const b=S.ProviderId??"default";return m.has(b)||m.set(b,{ProviderName:S.ProviderName??"",Models:[]}),m.get(b).Models.push(S),m},new Map),d=Array.from(g.values()),f=d.map((m,S)=>{const b=d.length>1&&S>0?'<div class="model-provider-divider"></div>':"",w=m.Models.map(M=>`
        <button
          class="model-item"
          data-action="select-model"
          data-model-id="${M.Id}"
          title="${M.Description??""}"
        >
          <span class="model-item-title">${M.Label}</span>
        </button>
      `).join("");return`${b}${w}`}).join("");return`
      <div class="relative">
        <button
          class="model-toggle flex items-center gap-2 text-sm font-semibold"
          data-action="toggle-models"
          aria-haspopup="listbox"
          aria-expanded="false"
        >
          <span>${r.Label}</span>
          ${ue("expand_more")}
          ${o?`<span class="model-toggle-description" ${p}>${o}</span>`:""}
        </button>
        <div
          class="model-menu settings-dropdown-menu hidden"
          data-model-menu
          role="listbox"
          aria-label="${n.ModelSelector.Label}"
        >
          ${f}
        </div>
      </div>
    `}}function tn(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var Ue=tn();function Xn(a){Ue=a}var at={exec:()=>null};function E(a,e=""){let t=typeof a=="string"?a:a.source,n={replace:(s,i)=>{let r=typeof i=="string"?i:i.source;return r=r.replace(J.caret,"$1"),t=t.replace(s,r),n},getRegex:()=>new RegExp(t,e)};return n}var Ys=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),J={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:a=>new RegExp(`^( {0,3}${a})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}#`),htmlBeginRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}<(?:[a-z].*>|!--)`,"i")},Zs=/^(?:[ \t]*(?:\n|$))+/,Js=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Xs=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,ct=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,ei=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,nn=/(?:[*+-]|\d{1,9}[.)])/,es=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,ts=E(es).replace(/bull/g,nn).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),ti=E(es).replace(/bull/g,nn).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),sn=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,ni=/^[^\n]+/,rn=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,si=E(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",rn).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),ii=E(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,nn).getRegex(),wt="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",on=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,ri=E("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",on).replace("tag",wt).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),ns=E(sn).replace("hr",ct).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",wt).getRegex(),oi=E(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",ns).getRegex(),an={blockquote:oi,code:Js,def:si,fences:Xs,heading:ei,hr:ct,html:ri,lheading:ts,list:ii,newline:Zs,paragraph:ns,table:at,text:ni},En=E("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",ct).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",wt).getRegex(),ai={...an,lheading:ti,table:En,paragraph:E(sn).replace("hr",ct).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",En).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",wt).getRegex()},li={...an,html:E(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",on).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:at,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:E(sn).replace("hr",ct).replace("heading",` *#{1,6} *[^
]`).replace("lheading",ts).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},ci=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,ui=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,ss=/^( {2,}|\\)\n(?!\s*$)/,di=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,At=/[\p{P}\p{S}]/u,ln=/[\s\p{P}\p{S}]/u,is=/[^\s\p{P}\p{S}]/u,hi=E(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,ln).getRegex(),rs=/(?!~)[\p{P}\p{S}]/u,pi=/(?!~)[\s\p{P}\p{S}]/u,gi=/(?:[^\s\p{P}\p{S}]|~)/u,fi=E(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",Ys?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),os=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,mi=E(os,"u").replace(/punct/g,At).getRegex(),Si=E(os,"u").replace(/punct/g,rs).getRegex(),as="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",vi=E(as,"gu").replace(/notPunctSpace/g,is).replace(/punctSpace/g,ln).replace(/punct/g,At).getRegex(),bi=E(as,"gu").replace(/notPunctSpace/g,gi).replace(/punctSpace/g,pi).replace(/punct/g,rs).getRegex(),Ci=E("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,is).replace(/punctSpace/g,ln).replace(/punct/g,At).getRegex(),yi=E(/\\(punct)/,"gu").replace(/punct/g,At).getRegex(),ki=E(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Ii=E(on).replace("(?:-->|$)","-->").getRegex(),Ti=E("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Ii).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),It=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,Mi=E(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",It).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),ls=E(/^!?\[(label)\]\[(ref)\]/).replace("label",It).replace("ref",rn).getRegex(),cs=E(/^!?\[(ref)\](?:\[\])?/).replace("ref",rn).getRegex(),xi=E("reflink|nolink(?!\\()","g").replace("reflink",ls).replace("nolink",cs).getRegex(),Dn=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,cn={_backpedal:at,anyPunctuation:yi,autolink:ki,blockSkip:fi,br:ss,code:ui,del:at,emStrongLDelim:mi,emStrongRDelimAst:vi,emStrongRDelimUnd:Ci,escape:ci,link:Mi,nolink:cs,punctuation:hi,reflink:ls,reflinkSearch:xi,tag:Ti,text:di,url:at},Pi={...cn,link:E(/^!?\[(label)\]\((.*?)\)/).replace("label",It).getRegex(),reflink:E(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",It).getRegex()},Qt={...cn,emStrongRDelimAst:bi,emStrongLDelim:Si,url:E(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",Dn).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:E(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",Dn).getRegex()},wi={...Qt,br:E(ss).replace("{2,}","*").getRegex(),text:E(Qt.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},St={normal:an,gfm:ai,pedantic:li},Ye={normal:cn,gfm:Qt,breaks:wi,pedantic:Pi},Ai={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},_n=a=>Ai[a];function Me(a,e){if(e){if(J.escapeTest.test(a))return a.replace(J.escapeReplace,_n)}else if(J.escapeTestNoEncode.test(a))return a.replace(J.escapeReplaceNoEncode,_n);return a}function On(a){try{a=encodeURI(a).replace(J.percentDecode,"%")}catch{return null}return a}function $n(a,e){var i;let t=a.replace(J.findPipe,(r,o,l)=>{let c=!1,u=o;for(;--u>=0&&l[u]==="\\";)c=!c;return c?"|":" |"}),n=t.split(J.splitPipe),s=0;if(n[0].trim()||n.shift(),n.length>0&&!((i=n.at(-1))!=null&&i.trim())&&n.pop(),e)if(n.length>e)n.splice(e);else for(;n.length<e;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(J.slashPipe,"|");return n}function Ze(a,e,t){let n=a.length;if(n===0)return"";let s=0;for(;s<n&&a.charAt(n-s-1)===e;)s++;return a.slice(0,n-s)}function Ri(a,e){if(a.indexOf(e[1])===-1)return-1;let t=0;for(let n=0;n<a.length;n++)if(a[n]==="\\")n++;else if(a[n]===e[0])t++;else if(a[n]===e[1]&&(t--,t<0))return n;return t>0?-2:-1}function Un(a,e,t,n,s){let i=e.href,r=e.title||null,o=a[1].replace(s.other.outputLinkReplace,"$1");n.state.inLink=!0;let l={type:a[0].charAt(0)==="!"?"image":"link",raw:t,href:i,title:r,text:o,tokens:n.inlineTokens(o)};return n.state.inLink=!1,l}function Li(a,e,t){let n=a.match(t.other.indentCodeCompensation);if(n===null)return e;let s=n[1];return e.split(`
`).map(i=>{let r=i.match(t.other.beginningSpace);if(r===null)return i;let[o]=r;return o.length>=s.length?i.slice(s.length):i}).join(`
`)}var Tt=class{constructor(a){U(this,"options");U(this,"rules");U(this,"lexer");this.options=a||Ue}space(a){let e=this.rules.block.newline.exec(a);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(a){let e=this.rules.block.code.exec(a);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:Ze(t,`
`)}}}fences(a){let e=this.rules.block.fences.exec(a);if(e){let t=e[0],n=Li(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:n}}}heading(a){let e=this.rules.block.heading.exec(a);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let n=Ze(t,"#");(this.options.pedantic||!n||this.rules.other.endingSpaceChar.test(n))&&(t=n.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(a){let e=this.rules.block.hr.exec(a);if(e)return{type:"hr",raw:Ze(e[0],`
`)}}blockquote(a){let e=this.rules.block.blockquote.exec(a);if(e){let t=Ze(e[0],`
`).split(`
`),n="",s="",i=[];for(;t.length>0;){let r=!1,o=[],l;for(l=0;l<t.length;l++)if(this.rules.other.blockquoteStart.test(t[l]))o.push(t[l]),r=!0;else if(!r)o.push(t[l]);else break;t=t.slice(l);let c=o.join(`
`),u=c.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}
${c}`:c,s=s?`${s}
${u}`:u;let p=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(u,i,!0),this.lexer.state.top=p,t.length===0)break;let g=i.at(-1);if((g==null?void 0:g.type)==="code")break;if((g==null?void 0:g.type)==="blockquote"){let d=g,f=d.raw+`
`+t.join(`
`),m=this.blockquote(f);i[i.length-1]=m,n=n.substring(0,n.length-d.raw.length)+m.raw,s=s.substring(0,s.length-d.text.length)+m.text;break}else if((g==null?void 0:g.type)==="list"){let d=g,f=d.raw+`
`+t.join(`
`),m=this.list(f);i[i.length-1]=m,n=n.substring(0,n.length-g.raw.length)+m.raw,s=s.substring(0,s.length-d.raw.length)+m.raw,t=f.substring(i.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:n,tokens:i,text:s}}}list(a){var t,n;let e=this.rules.block.list.exec(a);if(e){let s=e[1].trim(),i=s.length>1,r={type:"list",raw:"",ordered:i,start:i?+s.slice(0,-1):"",loose:!1,items:[]};s=i?`\\d{1,9}\\${s.slice(-1)}`:`\\${s}`,this.options.pedantic&&(s=i?s:"[*+-]");let o=this.rules.other.listItemRegex(s),l=!1;for(;a;){let u=!1,p="",g="";if(!(e=o.exec(a))||this.rules.block.hr.test(a))break;p=e[0],a=a.substring(p.length);let d=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,b=>" ".repeat(3*b.length)),f=a.split(`
`,1)[0],m=!d.trim(),S=0;if(this.options.pedantic?(S=2,g=d.trimStart()):m?S=e[1].length+1:(S=e[2].search(this.rules.other.nonSpaceChar),S=S>4?1:S,g=d.slice(S),S+=e[1].length),m&&this.rules.other.blankLine.test(f)&&(p+=f+`
`,a=a.substring(f.length+1),u=!0),!u){let b=this.rules.other.nextBulletRegex(S),w=this.rules.other.hrRegex(S),M=this.rules.other.fencesBeginRegex(S),x=this.rules.other.headingBeginRegex(S),y=this.rules.other.htmlBeginRegex(S);for(;a;){let k=a.split(`
`,1)[0],C;if(f=k,this.options.pedantic?(f=f.replace(this.rules.other.listReplaceNesting,"  "),C=f):C=f.replace(this.rules.other.tabCharGlobal,"    "),M.test(f)||x.test(f)||y.test(f)||b.test(f)||w.test(f))break;if(C.search(this.rules.other.nonSpaceChar)>=S||!f.trim())g+=`
`+C.slice(S);else{if(m||d.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||M.test(d)||x.test(d)||w.test(d))break;g+=`
`+f}!m&&!f.trim()&&(m=!0),p+=k+`
`,a=a.substring(k.length+1),d=C.slice(S)}}r.loose||(l?r.loose=!0:this.rules.other.doubleBlankLine.test(p)&&(l=!0)),r.items.push({type:"list_item",raw:p,task:!!this.options.gfm&&this.rules.other.listIsTask.test(g),loose:!1,text:g,tokens:[]}),r.raw+=p}let c=r.items.at(-1);if(c)c.raw=c.raw.trimEnd(),c.text=c.text.trimEnd();else return;r.raw=r.raw.trimEnd();for(let u of r.items){if(this.lexer.state.top=!1,u.tokens=this.lexer.blockTokens(u.text,[]),u.task){if(u.text=u.text.replace(this.rules.other.listReplaceTask,""),((t=u.tokens[0])==null?void 0:t.type)==="text"||((n=u.tokens[0])==null?void 0:n.type)==="paragraph"){u.tokens[0].raw=u.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),u.tokens[0].text=u.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let g=this.lexer.inlineQueue.length-1;g>=0;g--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[g].src)){this.lexer.inlineQueue[g].src=this.lexer.inlineQueue[g].src.replace(this.rules.other.listReplaceTask,"");break}}let p=this.rules.other.listTaskCheckbox.exec(u.raw);if(p){let g={type:"checkbox",raw:p[0]+" ",checked:p[0]!=="[ ]"};u.checked=g.checked,r.loose?u.tokens[0]&&["paragraph","text"].includes(u.tokens[0].type)&&"tokens"in u.tokens[0]&&u.tokens[0].tokens?(u.tokens[0].raw=g.raw+u.tokens[0].raw,u.tokens[0].text=g.raw+u.tokens[0].text,u.tokens[0].tokens.unshift(g)):u.tokens.unshift({type:"paragraph",raw:g.raw,text:g.raw,tokens:[g]}):u.tokens.unshift(g)}}if(!r.loose){let p=u.tokens.filter(d=>d.type==="space"),g=p.length>0&&p.some(d=>this.rules.other.anyLine.test(d.raw));r.loose=g}}if(r.loose)for(let u of r.items){u.loose=!0;for(let p of u.tokens)p.type==="text"&&(p.type="paragraph")}return r}}html(a){let e=this.rules.block.html.exec(a);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(a){let e=this.rules.block.def.exec(a);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:n,title:s}}}table(a){var r;let e=this.rules.block.table.exec(a);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=$n(e[1]),n=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),s=(r=e[3])!=null&&r.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],i={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===n.length){for(let o of n)this.rules.other.tableAlignRight.test(o)?i.align.push("right"):this.rules.other.tableAlignCenter.test(o)?i.align.push("center"):this.rules.other.tableAlignLeft.test(o)?i.align.push("left"):i.align.push(null);for(let o=0;o<t.length;o++)i.header.push({text:t[o],tokens:this.lexer.inline(t[o]),header:!0,align:i.align[o]});for(let o of s)i.rows.push($n(o,i.header.length).map((l,c)=>({text:l,tokens:this.lexer.inline(l),header:!1,align:i.align[c]})));return i}}lheading(a){let e=this.rules.block.lheading.exec(a);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(a){let e=this.rules.block.paragraph.exec(a);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(a){let e=this.rules.block.text.exec(a);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(a){let e=this.rules.inline.escape.exec(a);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(a){let e=this.rules.inline.tag.exec(a);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(a){let e=this.rules.inline.link.exec(a);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let i=Ze(t.slice(0,-1),"\\");if((t.length-i.length)%2===0)return}else{let i=Ri(e[2],"()");if(i===-2)return;if(i>-1){let r=(e[0].indexOf("!")===0?5:4)+e[1].length+i;e[2]=e[2].substring(0,i),e[0]=e[0].substring(0,r).trim(),e[3]=""}}let n=e[2],s="";if(this.options.pedantic){let i=this.rules.other.pedanticHrefTitle.exec(n);i&&(n=i[1],s=i[3])}else s=e[3]?e[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?n=n.slice(1):n=n.slice(1,-1)),Un(e,{href:n&&n.replace(this.rules.inline.anyPunctuation,"$1"),title:s&&s.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(a,e){let t;if((t=this.rules.inline.reflink.exec(a))||(t=this.rules.inline.nolink.exec(a))){let n=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),s=e[n.toLowerCase()];if(!s){let i=t[0].charAt(0);return{type:"text",raw:i,text:i}}return Un(t,s,t[0],this.lexer,this.rules)}}emStrong(a,e,t=""){let n=this.rules.inline.emStrongLDelim.exec(a);if(!(!n||n[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(n[1]||n[2])||!t||this.rules.inline.punctuation.exec(t))){let s=[...n[0]].length-1,i,r,o=s,l=0,c=n[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,e=e.slice(-1*a.length+s);(n=c.exec(e))!=null;){if(i=n[1]||n[2]||n[3]||n[4]||n[5]||n[6],!i)continue;if(r=[...i].length,n[3]||n[4]){o+=r;continue}else if((n[5]||n[6])&&s%3&&!((s+r)%3)){l+=r;continue}if(o-=r,o>0)continue;r=Math.min(r,r+o+l);let u=[...n[0]][0].length,p=a.slice(0,s+n.index+u+r);if(Math.min(s,r)%2){let d=p.slice(1,-1);return{type:"em",raw:p,text:d,tokens:this.lexer.inlineTokens(d)}}let g=p.slice(2,-2);return{type:"strong",raw:p,text:g,tokens:this.lexer.inlineTokens(g)}}}}codespan(a){let e=this.rules.inline.code.exec(a);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),n=this.rules.other.nonSpaceChar.test(t),s=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return n&&s&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(a){let e=this.rules.inline.br.exec(a);if(e)return{type:"br",raw:e[0]}}del(a){let e=this.rules.inline.del.exec(a);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(a){let e=this.rules.inline.autolink.exec(a);if(e){let t,n;return e[2]==="@"?(t=e[1],n="mailto:"+t):(t=e[1],n=t),{type:"link",raw:e[0],text:t,href:n,tokens:[{type:"text",raw:t,text:t}]}}}url(a){var t;let e;if(e=this.rules.inline.url.exec(a)){let n,s;if(e[2]==="@")n=e[0],s="mailto:"+n;else{let i;do i=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(i!==e[0]);n=e[0],e[1]==="www."?s="http://"+e[0]:s=e[0]}return{type:"link",raw:e[0],text:n,href:s,tokens:[{type:"text",raw:n,text:n}]}}}inlineText(a){let e=this.rules.inline.text.exec(a);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},de=class Yt{constructor(e){U(this,"tokens");U(this,"options");U(this,"state");U(this,"inlineQueue");U(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||Ue,this.options.tokenizer=this.options.tokenizer||new Tt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:J,block:St.normal,inline:Ye.normal};this.options.pedantic?(t.block=St.pedantic,t.inline=Ye.pedantic):this.options.gfm&&(t.block=St.gfm,this.options.breaks?t.inline=Ye.breaks:t.inline=Ye.gfm),this.tokenizer.rules=t}static get rules(){return{block:St,inline:Ye}}static lex(e,t){return new Yt(t).lex(e)}static lexInline(e,t){return new Yt(t).inlineTokens(e)}lex(e){e=e.replace(J.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let n=this.inlineQueue[t];this.inlineTokens(n.src,n.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){var s,i,r;for(this.options.pedantic&&(e=e.replace(J.tabCharGlobal,"    ").replace(J.spaceLine,""));e;){let o;if((i=(s=this.options.extensions)==null?void 0:s.block)!=null&&i.some(c=>(o=c.call({lexer:this},e,t))?(e=e.substring(o.raw.length),t.push(o),!0):!1))continue;if(o=this.tokenizer.space(e)){e=e.substring(o.raw.length);let c=t.at(-1);o.raw.length===1&&c!==void 0?c.raw+=`
`:t.push(o);continue}if(o=this.tokenizer.code(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.at(-1).src=c.text):t.push(o);continue}if(o=this.tokenizer.fences(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.heading(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.hr(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.blockquote(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.list(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.html(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.def(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.raw,this.inlineQueue.at(-1).src=c.text):this.tokens.links[o.tag]||(this.tokens.links[o.tag]={href:o.href,title:o.title},t.push(o));continue}if(o=this.tokenizer.table(e)){e=e.substring(o.raw.length),t.push(o);continue}if(o=this.tokenizer.lheading(e)){e=e.substring(o.raw.length),t.push(o);continue}let l=e;if((r=this.options.extensions)!=null&&r.startBlock){let c=1/0,u=e.slice(1),p;this.options.extensions.startBlock.forEach(g=>{p=g.call({lexer:this},u),typeof p=="number"&&p>=0&&(c=Math.min(c,p))}),c<1/0&&c>=0&&(l=e.substring(0,c+1))}if(this.state.top&&(o=this.tokenizer.paragraph(l))){let c=t.at(-1);n&&(c==null?void 0:c.type)==="paragraph"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(o),n=l.length!==e.length,e=e.substring(o.raw.length);continue}if(o=this.tokenizer.text(e)){e=e.substring(o.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+o.raw,c.text+=`
`+o.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(o);continue}if(e){let c="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(c);break}else throw new Error(c)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){var l,c,u,p,g;let n=e,s=null;if(this.tokens.links){let d=Object.keys(this.tokens.links);if(d.length>0)for(;(s=this.tokenizer.rules.inline.reflinkSearch.exec(n))!=null;)d.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(s=this.tokenizer.rules.inline.anyPunctuation.exec(n))!=null;)n=n.slice(0,s.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let i;for(;(s=this.tokenizer.rules.inline.blockSkip.exec(n))!=null;)i=s[2]?s[2].length:0,n=n.slice(0,s.index+i)+"["+"a".repeat(s[0].length-i-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);n=((c=(l=this.options.hooks)==null?void 0:l.emStrongMask)==null?void 0:c.call({lexer:this},n))??n;let r=!1,o="";for(;e;){r||(o=""),r=!1;let d;if((p=(u=this.options.extensions)==null?void 0:u.inline)!=null&&p.some(m=>(d=m.call({lexer:this},e,t))?(e=e.substring(d.raw.length),t.push(d),!0):!1))continue;if(d=this.tokenizer.escape(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.tag(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.link(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(d.raw.length);let m=t.at(-1);d.type==="text"&&(m==null?void 0:m.type)==="text"?(m.raw+=d.raw,m.text+=d.text):t.push(d);continue}if(d=this.tokenizer.emStrong(e,n,o)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.codespan(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.br(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.del(e)){e=e.substring(d.raw.length),t.push(d);continue}if(d=this.tokenizer.autolink(e)){e=e.substring(d.raw.length),t.push(d);continue}if(!this.state.inLink&&(d=this.tokenizer.url(e))){e=e.substring(d.raw.length),t.push(d);continue}let f=e;if((g=this.options.extensions)!=null&&g.startInline){let m=1/0,S=e.slice(1),b;this.options.extensions.startInline.forEach(w=>{b=w.call({lexer:this},S),typeof b=="number"&&b>=0&&(m=Math.min(m,b))}),m<1/0&&m>=0&&(f=e.substring(0,m+1))}if(d=this.tokenizer.inlineText(f)){e=e.substring(d.raw.length),d.raw.slice(-1)!=="_"&&(o=d.raw.slice(-1)),r=!0;let m=t.at(-1);(m==null?void 0:m.type)==="text"?(m.raw+=d.raw,m.text+=d.text):t.push(d);continue}if(e){let m="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(m);break}else throw new Error(m)}}return t}},Mt=class{constructor(a){U(this,"options");U(this,"parser");this.options=a||Ue}space(a){return""}code({text:a,lang:e,escaped:t}){var i;let n=(i=(e||"").match(J.notSpaceStart))==null?void 0:i[0],s=a.replace(J.endingNewline,"")+`
`;return n?'<pre><code class="language-'+Me(n)+'">'+(t?s:Me(s,!0))+`</code></pre>
`:"<pre><code>"+(t?s:Me(s,!0))+`</code></pre>
`}blockquote({tokens:a}){return`<blockquote>
${this.parser.parse(a)}</blockquote>
`}html({text:a}){return a}def(a){return""}heading({tokens:a,depth:e}){return`<h${e}>${this.parser.parseInline(a)}</h${e}>
`}hr(a){return`<hr>
`}list(a){let e=a.ordered,t=a.start,n="";for(let r=0;r<a.items.length;r++){let o=a.items[r];n+=this.listitem(o)}let s=e?"ol":"ul",i=e&&t!==1?' start="'+t+'"':"";return"<"+s+i+`>
`+n+"</"+s+`>
`}listitem(a){return`<li>${this.parser.parse(a.tokens)}</li>
`}checkbox({checked:a}){return"<input "+(a?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:a}){return`<p>${this.parser.parseInline(a)}</p>
`}table(a){let e="",t="";for(let s=0;s<a.header.length;s++)t+=this.tablecell(a.header[s]);e+=this.tablerow({text:t});let n="";for(let s=0;s<a.rows.length;s++){let i=a.rows[s];t="";for(let r=0;r<i.length;r++)t+=this.tablecell(i[r]);n+=this.tablerow({text:t})}return n&&(n=`<tbody>${n}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+n+`</table>
`}tablerow({text:a}){return`<tr>
${a}</tr>
`}tablecell(a){let e=this.parser.parseInline(a.tokens),t=a.header?"th":"td";return(a.align?`<${t} align="${a.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:a}){return`<strong>${this.parser.parseInline(a)}</strong>`}em({tokens:a}){return`<em>${this.parser.parseInline(a)}</em>`}codespan({text:a}){return`<code>${Me(a,!0)}</code>`}br(a){return"<br>"}del({tokens:a}){return`<del>${this.parser.parseInline(a)}</del>`}link({href:a,title:e,tokens:t}){let n=this.parser.parseInline(t),s=On(a);if(s===null)return n;a=s;let i='<a href="'+a+'"';return e&&(i+=' title="'+Me(e)+'"'),i+=">"+n+"</a>",i}image({href:a,title:e,text:t,tokens:n}){n&&(t=this.parser.parseInline(n,this.parser.textRenderer));let s=On(a);if(s===null)return Me(t);a=s;let i=`<img src="${a}" alt="${t}"`;return e&&(i+=` title="${Me(e)}"`),i+=">",i}text(a){return"tokens"in a&&a.tokens?this.parser.parseInline(a.tokens):"escaped"in a&&a.escaped?a.text:Me(a.text)}},un=class{strong({text:a}){return a}em({text:a}){return a}codespan({text:a}){return a}del({text:a}){return a}html({text:a}){return a}text({text:a}){return a}link({text:a}){return""+a}image({text:a}){return""+a}br(){return""}checkbox({raw:a}){return a}},he=class Zt{constructor(e){U(this,"options");U(this,"renderer");U(this,"textRenderer");this.options=e||Ue,this.options.renderer=this.options.renderer||new Mt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new un}static parse(e,t){return new Zt(t).parse(e)}static parseInline(e,t){return new Zt(t).parseInline(e)}parse(e){var n,s;let t="";for(let i=0;i<e.length;i++){let r=e[i];if((s=(n=this.options.extensions)==null?void 0:n.renderers)!=null&&s[r.type]){let l=r,c=this.options.extensions.renderers[l.type].call({parser:this},l);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(l.type)){t+=c||"";continue}}let o=r;switch(o.type){case"space":{t+=this.renderer.space(o);break}case"hr":{t+=this.renderer.hr(o);break}case"heading":{t+=this.renderer.heading(o);break}case"code":{t+=this.renderer.code(o);break}case"table":{t+=this.renderer.table(o);break}case"blockquote":{t+=this.renderer.blockquote(o);break}case"list":{t+=this.renderer.list(o);break}case"checkbox":{t+=this.renderer.checkbox(o);break}case"html":{t+=this.renderer.html(o);break}case"def":{t+=this.renderer.def(o);break}case"paragraph":{t+=this.renderer.paragraph(o);break}case"text":{t+=this.renderer.text(o);break}default:{let l='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(l),"";throw new Error(l)}}}return t}parseInline(e,t=this.renderer){var s,i;let n="";for(let r=0;r<e.length;r++){let o=e[r];if((i=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&i[o.type]){let c=this.options.extensions.renderers[o.type].call({parser:this},o);if(c!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(o.type)){n+=c||"";continue}}let l=o;switch(l.type){case"escape":{n+=t.text(l);break}case"html":{n+=t.html(l);break}case"link":{n+=t.link(l);break}case"image":{n+=t.image(l);break}case"checkbox":{n+=t.checkbox(l);break}case"strong":{n+=t.strong(l);break}case"em":{n+=t.em(l);break}case"codespan":{n+=t.codespan(l);break}case"br":{n+=t.br(l);break}case"del":{n+=t.del(l);break}case"text":{n+=t.text(l);break}default:{let c='Token with "'+l.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return n}},Ct,rt=(Ct=class{constructor(a){U(this,"options");U(this,"block");this.options=a||Ue}preprocess(a){return a}postprocess(a){return a}processAllTokens(a){return a}emStrongMask(a){return a}provideLexer(){return this.block?de.lex:de.lexInline}provideParser(){return this.block?he.parse:he.parseInline}},U(Ct,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),U(Ct,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),Ct),Ei=class{constructor(...a){U(this,"defaults",tn());U(this,"options",this.setOptions);U(this,"parse",this.parseMarkdown(!0));U(this,"parseInline",this.parseMarkdown(!1));U(this,"Parser",he);U(this,"Renderer",Mt);U(this,"TextRenderer",un);U(this,"Lexer",de);U(this,"Tokenizer",Tt);U(this,"Hooks",rt);this.use(...a)}walkTokens(a,e){var n,s;let t=[];for(let i of a)switch(t=t.concat(e.call(this,i)),i.type){case"table":{let r=i;for(let o of r.header)t=t.concat(this.walkTokens(o.tokens,e));for(let o of r.rows)for(let l of o)t=t.concat(this.walkTokens(l.tokens,e));break}case"list":{let r=i;t=t.concat(this.walkTokens(r.items,e));break}default:{let r=i;(s=(n=this.defaults.extensions)==null?void 0:n.childTokens)!=null&&s[r.type]?this.defaults.extensions.childTokens[r.type].forEach(o=>{let l=r[o].flat(1/0);t=t.concat(this.walkTokens(l,e))}):r.tokens&&(t=t.concat(this.walkTokens(r.tokens,e)))}}return t}use(...a){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return a.forEach(t=>{let n={...t};if(n.async=this.defaults.async||n.async||!1,t.extensions&&(t.extensions.forEach(s=>{if(!s.name)throw new Error("extension name required");if("renderer"in s){let i=e.renderers[s.name];i?e.renderers[s.name]=function(...r){let o=s.renderer.apply(this,r);return o===!1&&(o=i.apply(this,r)),o}:e.renderers[s.name]=s.renderer}if("tokenizer"in s){if(!s.level||s.level!=="block"&&s.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let i=e[s.level];i?i.unshift(s.tokenizer):e[s.level]=[s.tokenizer],s.start&&(s.level==="block"?e.startBlock?e.startBlock.push(s.start):e.startBlock=[s.start]:s.level==="inline"&&(e.startInline?e.startInline.push(s.start):e.startInline=[s.start]))}"childTokens"in s&&s.childTokens&&(e.childTokens[s.name]=s.childTokens)}),n.extensions=e),t.renderer){let s=this.defaults.renderer||new Mt(this.defaults);for(let i in t.renderer){if(!(i in s))throw new Error(`renderer '${i}' does not exist`);if(["options","parser"].includes(i))continue;let r=i,o=t.renderer[r],l=s[r];s[r]=(...c)=>{let u=o.apply(s,c);return u===!1&&(u=l.apply(s,c)),u||""}}n.renderer=s}if(t.tokenizer){let s=this.defaults.tokenizer||new Tt(this.defaults);for(let i in t.tokenizer){if(!(i in s))throw new Error(`tokenizer '${i}' does not exist`);if(["options","rules","lexer"].includes(i))continue;let r=i,o=t.tokenizer[r],l=s[r];s[r]=(...c)=>{let u=o.apply(s,c);return u===!1&&(u=l.apply(s,c)),u}}n.tokenizer=s}if(t.hooks){let s=this.defaults.hooks||new rt;for(let i in t.hooks){if(!(i in s))throw new Error(`hook '${i}' does not exist`);if(["options","block"].includes(i))continue;let r=i,o=t.hooks[r],l=s[r];rt.passThroughHooks.has(i)?s[r]=c=>{if(this.defaults.async&&rt.passThroughHooksRespectAsync.has(i))return(async()=>{let p=await o.call(s,c);return l.call(s,p)})();let u=o.call(s,c);return l.call(s,u)}:s[r]=(...c)=>{if(this.defaults.async)return(async()=>{let p=await o.apply(s,c);return p===!1&&(p=await l.apply(s,c)),p})();let u=o.apply(s,c);return u===!1&&(u=l.apply(s,c)),u}}n.hooks=s}if(t.walkTokens){let s=this.defaults.walkTokens,i=t.walkTokens;n.walkTokens=function(r){let o=[];return o.push(i.call(this,r)),s&&(o=o.concat(s.call(this,r))),o}}this.defaults={...this.defaults,...n}}),this}setOptions(a){return this.defaults={...this.defaults,...a},this}lexer(a,e){return de.lex(a,e??this.defaults)}parser(a,e){return he.parse(a,e??this.defaults)}parseMarkdown(a){return(e,t)=>{let n={...t},s={...this.defaults,...n},i=this.onError(!!s.silent,!!s.async);if(this.defaults.async===!0&&n.async===!1)return i(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return i(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return i(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(s.hooks&&(s.hooks.options=s,s.hooks.block=a),s.async)return(async()=>{let r=s.hooks?await s.hooks.preprocess(e):e,o=await(s.hooks?await s.hooks.provideLexer():a?de.lex:de.lexInline)(r,s),l=s.hooks?await s.hooks.processAllTokens(o):o;s.walkTokens&&await Promise.all(this.walkTokens(l,s.walkTokens));let c=await(s.hooks?await s.hooks.provideParser():a?he.parse:he.parseInline)(l,s);return s.hooks?await s.hooks.postprocess(c):c})().catch(i);try{s.hooks&&(e=s.hooks.preprocess(e));let r=(s.hooks?s.hooks.provideLexer():a?de.lex:de.lexInline)(e,s);s.hooks&&(r=s.hooks.processAllTokens(r)),s.walkTokens&&this.walkTokens(r,s.walkTokens);let o=(s.hooks?s.hooks.provideParser():a?he.parse:he.parseInline)(r,s);return s.hooks&&(o=s.hooks.postprocess(o)),o}catch(r){return i(r)}}}onError(a,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,a){let n="<p>An error occurred:</p><pre>"+Me(t.message+"",!0)+"</pre>";return e?Promise.resolve(n):n}if(e)return Promise.reject(t);throw t}}},$e=new Ei;function O(a,e){return $e.parse(a,e)}O.options=O.setOptions=function(a){return $e.setOptions(a),O.defaults=$e.defaults,Xn(O.defaults),O};O.getDefaults=tn;O.defaults=Ue;O.use=function(...a){return $e.use(...a),O.defaults=$e.defaults,Xn(O.defaults),O};O.walkTokens=function(a,e){return $e.walkTokens(a,e)};O.parseInline=$e.parseInline;O.Parser=he;O.parser=he.parse;O.Renderer=Mt;O.TextRenderer=un;O.Lexer=de;O.lexer=de.lex;O.Tokenizer=Tt;O.Hooks=rt;O.parse=O;O.options;O.setOptions;O.use;O.walkTokens;O.parseInline;he.parse;de.lex;/*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE */const{entries:us,setPrototypeOf:Nn,isFrozen:Di,getPrototypeOf:_i,getOwnPropertyDescriptor:Oi}=Object;let{freeze:X,seal:re,create:Jt}=Object,{apply:Xt,construct:en}=typeof Reflect<"u"&&Reflect;X||(X=function(e){return e});re||(re=function(e){return e});Xt||(Xt=function(e,t){for(var n=arguments.length,s=new Array(n>2?n-2:0),i=2;i<n;i++)s[i-2]=arguments[i];return e.apply(t,s)});en||(en=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return new e(...n)});const vt=ee(Array.prototype.forEach),$i=ee(Array.prototype.lastIndexOf),Bn=ee(Array.prototype.pop),Je=ee(Array.prototype.push),Ui=ee(Array.prototype.splice),kt=ee(String.prototype.toLowerCase),Ht=ee(String.prototype.toString),Gt=ee(String.prototype.match),Xe=ee(String.prototype.replace),Ni=ee(String.prototype.indexOf),Bi=ee(String.prototype.trim),le=ee(Object.prototype.hasOwnProperty),Z=ee(RegExp.prototype.test),et=Fi(TypeError);function ee(a){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,n=new Array(t>1?t-1:0),s=1;s<t;s++)n[s-1]=arguments[s];return Xt(a,e,n)}}function Fi(a){return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return en(a,t)}}function R(a,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:kt;Nn&&Nn(a,null);let n=e.length;for(;n--;){let s=e[n];if(typeof s=="string"){const i=t(s);i!==s&&(Di(e)||(e[n]=i),s=i)}a[s]=!0}return a}function Hi(a){for(let e=0;e<a.length;e++)le(a,e)||(a[e]=null);return a}function ve(a){const e=Jt(null);for(const[t,n]of us(a))le(a,t)&&(Array.isArray(n)?e[t]=Hi(n):n&&typeof n=="object"&&n.constructor===Object?e[t]=ve(n):e[t]=n);return e}function tt(a,e){for(;a!==null;){const n=Oi(a,e);if(n){if(n.get)return ee(n.get);if(typeof n.value=="function")return ee(n.value)}a=_i(a)}function t(){return null}return t}const Fn=X(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),zt=X(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Kt=X(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Gi=X(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),qt=X(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),zi=X(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Hn=X(["#text"]),Gn=X(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Vt=X(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),zn=X(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),bt=X(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Ki=re(/\{\{[\w\W]*|[\w\W]*\}\}/gm),qi=re(/<%[\w\W]*|[\w\W]*%>/gm),Vi=re(/\$\{[\w\W]*/gm),ji=re(/^data-[\-\w.\u00B7-\uFFFF]+$/),Wi=re(/^aria-[\-\w]+$/),ds=re(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Qi=re(/^(?:\w+script|data):/i),Yi=re(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),hs=re(/^html$/i),Zi=re(/^[a-z][.\w]*(-[.\w]+)+$/i);var Kn=Object.freeze({__proto__:null,ARIA_ATTR:Wi,ATTR_WHITESPACE:Yi,CUSTOM_ELEMENT:Zi,DATA_ATTR:ji,DOCTYPE_NAME:hs,ERB_EXPR:qi,IS_ALLOWED_URI:ds,IS_SCRIPT_OR_DATA:Qi,MUSTACHE_EXPR:Ki,TMPLIT_EXPR:Vi});const nt={element:1,text:3,progressingInstruction:7,comment:8,document:9},Ji=function(){return typeof window>"u"?null:window},Xi=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let n=null;const s="data-tt-policy-suffix";t&&t.hasAttribute(s)&&(n=t.getAttribute(s));const i="dompurify"+(n?"#"+n:"");try{return e.createPolicy(i,{createHTML(r){return r},createScriptURL(r){return r}})}catch{return console.warn("TrustedTypes policy "+i+" could not be created."),null}},qn=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function ps(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Ji();const e=P=>ps(P);if(e.version="3.3.1",e.removed=[],!a||!a.document||a.document.nodeType!==nt.document||!a.Element)return e.isSupported=!1,e;let{document:t}=a;const n=t,s=n.currentScript,{DocumentFragment:i,HTMLTemplateElement:r,Node:o,Element:l,NodeFilter:c,NamedNodeMap:u=a.NamedNodeMap||a.MozNamedAttrMap,HTMLFormElement:p,DOMParser:g,trustedTypes:d}=a,f=l.prototype,m=tt(f,"cloneNode"),S=tt(f,"remove"),b=tt(f,"nextSibling"),w=tt(f,"childNodes"),M=tt(f,"parentNode");if(typeof r=="function"){const P=t.createElement("template");P.content&&P.content.ownerDocument&&(t=P.content.ownerDocument)}let x,y="";const{implementation:k,createNodeIterator:C,createDocumentFragment:A,getElementsByTagName:_}=t,{importNode:V}=n;let L=qn();e.isSupported=typeof us=="function"&&typeof M=="function"&&k&&k.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:B,ERB_EXPR:D,TMPLIT_EXPR:Q,DATA_ATTR:$,ARIA_ATTR:pe,IS_SCRIPT_OR_DATA:oe,ATTR_WHITESPACE:ge,CUSTOM_ELEMENT:Le}=Kn;let{IS_ALLOWED_URI:xe}=Kn,F=null;const Pe=R({},[...Fn,...zt,...Kt,...qt,...Hn]);let G=null;const we=R({},[...Gn,...Vt,...zn,...bt]);let N=Object.seal(Jt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),ae=null,Ce=null;const ne=Object.seal(Jt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Ae=!0,I=!0,j=!1,Re=!0,ye=!1,Ee=!0,fe=!1,Be=!1,se=!1,Fe=!1,ut=!1,dt=!1,hn=!0,pn=!1;const Ts="user-content-";let Rt=!0,We=!1,He={},me=null;const Lt=R({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let gn=null;const fn=R({},["audio","video","img","source","image","track"]);let Et=null;const mn=R({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),ht="http://www.w3.org/1998/Math/MathML",pt="http://www.w3.org/2000/svg",ke="http://www.w3.org/1999/xhtml";let Ge=ke,Dt=!1,_t=null;const Ms=R({},[ht,pt,ke],Ht);let gt=R({},["mi","mo","mn","ms","mtext"]),ft=R({},["annotation-xml"]);const xs=R({},["title","style","font","a","script"]);let Qe=null;const Ps=["application/xhtml+xml","text/html"],ws="text/html";let q=null,ze=null;const As=t.createElement("form"),Sn=function(h){return h instanceof RegExp||h instanceof Function},Ot=function(){let h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(ze&&ze===h)){if((!h||typeof h!="object")&&(h={}),h=ve(h),Qe=Ps.indexOf(h.PARSER_MEDIA_TYPE)===-1?ws:h.PARSER_MEDIA_TYPE,q=Qe==="application/xhtml+xml"?Ht:kt,F=le(h,"ALLOWED_TAGS")?R({},h.ALLOWED_TAGS,q):Pe,G=le(h,"ALLOWED_ATTR")?R({},h.ALLOWED_ATTR,q):we,_t=le(h,"ALLOWED_NAMESPACES")?R({},h.ALLOWED_NAMESPACES,Ht):Ms,Et=le(h,"ADD_URI_SAFE_ATTR")?R(ve(mn),h.ADD_URI_SAFE_ATTR,q):mn,gn=le(h,"ADD_DATA_URI_TAGS")?R(ve(fn),h.ADD_DATA_URI_TAGS,q):fn,me=le(h,"FORBID_CONTENTS")?R({},h.FORBID_CONTENTS,q):Lt,ae=le(h,"FORBID_TAGS")?R({},h.FORBID_TAGS,q):ve({}),Ce=le(h,"FORBID_ATTR")?R({},h.FORBID_ATTR,q):ve({}),He=le(h,"USE_PROFILES")?h.USE_PROFILES:!1,Ae=h.ALLOW_ARIA_ATTR!==!1,I=h.ALLOW_DATA_ATTR!==!1,j=h.ALLOW_UNKNOWN_PROTOCOLS||!1,Re=h.ALLOW_SELF_CLOSE_IN_ATTR!==!1,ye=h.SAFE_FOR_TEMPLATES||!1,Ee=h.SAFE_FOR_XML!==!1,fe=h.WHOLE_DOCUMENT||!1,Fe=h.RETURN_DOM||!1,ut=h.RETURN_DOM_FRAGMENT||!1,dt=h.RETURN_TRUSTED_TYPE||!1,se=h.FORCE_BODY||!1,hn=h.SANITIZE_DOM!==!1,pn=h.SANITIZE_NAMED_PROPS||!1,Rt=h.KEEP_CONTENT!==!1,We=h.IN_PLACE||!1,xe=h.ALLOWED_URI_REGEXP||ds,Ge=h.NAMESPACE||ke,gt=h.MATHML_TEXT_INTEGRATION_POINTS||gt,ft=h.HTML_INTEGRATION_POINTS||ft,N=h.CUSTOM_ELEMENT_HANDLING||{},h.CUSTOM_ELEMENT_HANDLING&&Sn(h.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(N.tagNameCheck=h.CUSTOM_ELEMENT_HANDLING.tagNameCheck),h.CUSTOM_ELEMENT_HANDLING&&Sn(h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(N.attributeNameCheck=h.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),h.CUSTOM_ELEMENT_HANDLING&&typeof h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(N.allowCustomizedBuiltInElements=h.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),ye&&(I=!1),ut&&(Fe=!0),He&&(F=R({},Hn),G=[],He.html===!0&&(R(F,Fn),R(G,Gn)),He.svg===!0&&(R(F,zt),R(G,Vt),R(G,bt)),He.svgFilters===!0&&(R(F,Kt),R(G,Vt),R(G,bt)),He.mathMl===!0&&(R(F,qt),R(G,zn),R(G,bt))),h.ADD_TAGS&&(typeof h.ADD_TAGS=="function"?ne.tagCheck=h.ADD_TAGS:(F===Pe&&(F=ve(F)),R(F,h.ADD_TAGS,q))),h.ADD_ATTR&&(typeof h.ADD_ATTR=="function"?ne.attributeCheck=h.ADD_ATTR:(G===we&&(G=ve(G)),R(G,h.ADD_ATTR,q))),h.ADD_URI_SAFE_ATTR&&R(Et,h.ADD_URI_SAFE_ATTR,q),h.FORBID_CONTENTS&&(me===Lt&&(me=ve(me)),R(me,h.FORBID_CONTENTS,q)),h.ADD_FORBID_CONTENTS&&(me===Lt&&(me=ve(me)),R(me,h.ADD_FORBID_CONTENTS,q)),Rt&&(F["#text"]=!0),fe&&R(F,["html","head","body"]),F.table&&(R(F,["tbody"]),delete ae.tbody),h.TRUSTED_TYPES_POLICY){if(typeof h.TRUSTED_TYPES_POLICY.createHTML!="function")throw et('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof h.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw et('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');x=h.TRUSTED_TYPES_POLICY,y=x.createHTML("")}else x===void 0&&(x=Xi(d,s)),x!==null&&typeof y=="string"&&(y=x.createHTML(""));X&&X(h),ze=h}},vn=R({},[...zt,...Kt,...Gi]),bn=R({},[...qt,...zi]),Rs=function(h){let v=M(h);(!v||!v.tagName)&&(v={namespaceURI:Ge,tagName:"template"});const T=kt(h.tagName),H=kt(v.tagName);return _t[h.namespaceURI]?h.namespaceURI===pt?v.namespaceURI===ke?T==="svg":v.namespaceURI===ht?T==="svg"&&(H==="annotation-xml"||gt[H]):!!vn[T]:h.namespaceURI===ht?v.namespaceURI===ke?T==="math":v.namespaceURI===pt?T==="math"&&ft[H]:!!bn[T]:h.namespaceURI===ke?v.namespaceURI===pt&&!ft[H]||v.namespaceURI===ht&&!gt[H]?!1:!bn[T]&&(xs[T]||!vn[T]):!!(Qe==="application/xhtml+xml"&&_t[h.namespaceURI]):!1},Se=function(h){Je(e.removed,{element:h});try{M(h).removeChild(h)}catch{S(h)}},De=function(h,v){try{Je(e.removed,{attribute:v.getAttributeNode(h),from:v})}catch{Je(e.removed,{attribute:null,from:v})}if(v.removeAttribute(h),h==="is")if(Fe||ut)try{Se(v)}catch{}else try{v.setAttribute(h,"")}catch{}},Cn=function(h){let v=null,T=null;if(se)h="<remove></remove>"+h;else{const K=Gt(h,/^[\r\n\t ]+/);T=K&&K[0]}Qe==="application/xhtml+xml"&&Ge===ke&&(h='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+h+"</body></html>");const H=x?x.createHTML(h):h;if(Ge===ke)try{v=new g().parseFromString(H,Qe)}catch{}if(!v||!v.documentElement){v=k.createDocument(Ge,"template",null);try{v.documentElement.innerHTML=Dt?y:H}catch{}}const Y=v.body||v.documentElement;return h&&T&&Y.insertBefore(t.createTextNode(T),Y.childNodes[0]||null),Ge===ke?_.call(v,fe?"html":"body")[0]:fe?v.documentElement:Y},yn=function(h){return C.call(h.ownerDocument||h,h,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT|c.SHOW_PROCESSING_INSTRUCTION|c.SHOW_CDATA_SECTION,null)},$t=function(h){return h instanceof p&&(typeof h.nodeName!="string"||typeof h.textContent!="string"||typeof h.removeChild!="function"||!(h.attributes instanceof u)||typeof h.removeAttribute!="function"||typeof h.setAttribute!="function"||typeof h.namespaceURI!="string"||typeof h.insertBefore!="function"||typeof h.hasChildNodes!="function")},kn=function(h){return typeof o=="function"&&h instanceof o};function Ie(P,h,v){vt(P,T=>{T.call(e,h,v,ze)})}const In=function(h){let v=null;if(Ie(L.beforeSanitizeElements,h,null),$t(h))return Se(h),!0;const T=q(h.nodeName);if(Ie(L.uponSanitizeElement,h,{tagName:T,allowedTags:F}),Ee&&h.hasChildNodes()&&!kn(h.firstElementChild)&&Z(/<[/\w!]/g,h.innerHTML)&&Z(/<[/\w!]/g,h.textContent)||h.nodeType===nt.progressingInstruction||Ee&&h.nodeType===nt.comment&&Z(/<[/\w]/g,h.data))return Se(h),!0;if(!(ne.tagCheck instanceof Function&&ne.tagCheck(T))&&(!F[T]||ae[T])){if(!ae[T]&&Mn(T)&&(N.tagNameCheck instanceof RegExp&&Z(N.tagNameCheck,T)||N.tagNameCheck instanceof Function&&N.tagNameCheck(T)))return!1;if(Rt&&!me[T]){const H=M(h)||h.parentNode,Y=w(h)||h.childNodes;if(Y&&H){const K=Y.length;for(let te=K-1;te>=0;--te){const Te=m(Y[te],!0);Te.__removalCount=(h.__removalCount||0)+1,H.insertBefore(Te,b(h))}}}return Se(h),!0}return h instanceof l&&!Rs(h)||(T==="noscript"||T==="noembed"||T==="noframes")&&Z(/<\/no(script|embed|frames)/i,h.innerHTML)?(Se(h),!0):(ye&&h.nodeType===nt.text&&(v=h.textContent,vt([B,D,Q],H=>{v=Xe(v,H," ")}),h.textContent!==v&&(Je(e.removed,{element:h.cloneNode()}),h.textContent=v)),Ie(L.afterSanitizeElements,h,null),!1)},Tn=function(h,v,T){if(hn&&(v==="id"||v==="name")&&(T in t||T in As))return!1;if(!(I&&!Ce[v]&&Z($,v))){if(!(Ae&&Z(pe,v))){if(!(ne.attributeCheck instanceof Function&&ne.attributeCheck(v,h))){if(!G[v]||Ce[v]){if(!(Mn(h)&&(N.tagNameCheck instanceof RegExp&&Z(N.tagNameCheck,h)||N.tagNameCheck instanceof Function&&N.tagNameCheck(h))&&(N.attributeNameCheck instanceof RegExp&&Z(N.attributeNameCheck,v)||N.attributeNameCheck instanceof Function&&N.attributeNameCheck(v,h))||v==="is"&&N.allowCustomizedBuiltInElements&&(N.tagNameCheck instanceof RegExp&&Z(N.tagNameCheck,T)||N.tagNameCheck instanceof Function&&N.tagNameCheck(T))))return!1}else if(!Et[v]){if(!Z(xe,Xe(T,ge,""))){if(!((v==="src"||v==="xlink:href"||v==="href")&&h!=="script"&&Ni(T,"data:")===0&&gn[h])){if(!(j&&!Z(oe,Xe(T,ge,"")))){if(T)return!1}}}}}}}return!0},Mn=function(h){return h!=="annotation-xml"&&Gt(h,Le)},xn=function(h){Ie(L.beforeSanitizeAttributes,h,null);const{attributes:v}=h;if(!v||$t(h))return;const T={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:G,forceKeepAttr:void 0};let H=v.length;for(;H--;){const Y=v[H],{name:K,namespaceURI:te,value:Te}=Y,Ke=q(K),Ut=Te;let W=K==="value"?Ut:Bi(Ut);if(T.attrName=Ke,T.attrValue=W,T.keepAttr=!0,T.forceKeepAttr=void 0,Ie(L.uponSanitizeAttribute,h,T),W=T.attrValue,pn&&(Ke==="id"||Ke==="name")&&(De(K,h),W=Ts+W),Ee&&Z(/((--!?|])>)|<\/(style|title|textarea)/i,W)){De(K,h);continue}if(Ke==="attributename"&&Gt(W,"href")){De(K,h);continue}if(T.forceKeepAttr)continue;if(!T.keepAttr){De(K,h);continue}if(!Re&&Z(/\/>/i,W)){De(K,h);continue}ye&&vt([B,D,Q],wn=>{W=Xe(W,wn," ")});const Pn=q(h.nodeName);if(!Tn(Pn,Ke,W)){De(K,h);continue}if(x&&typeof d=="object"&&typeof d.getAttributeType=="function"&&!te)switch(d.getAttributeType(Pn,Ke)){case"TrustedHTML":{W=x.createHTML(W);break}case"TrustedScriptURL":{W=x.createScriptURL(W);break}}if(W!==Ut)try{te?h.setAttributeNS(te,K,W):h.setAttribute(K,W),$t(h)?Se(h):Bn(e.removed)}catch{De(K,h)}}Ie(L.afterSanitizeAttributes,h,null)},Ls=function P(h){let v=null;const T=yn(h);for(Ie(L.beforeSanitizeShadowDOM,h,null);v=T.nextNode();)Ie(L.uponSanitizeShadowNode,v,null),In(v),xn(v),v.content instanceof i&&P(v.content);Ie(L.afterSanitizeShadowDOM,h,null)};return e.sanitize=function(P){let h=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},v=null,T=null,H=null,Y=null;if(Dt=!P,Dt&&(P="<!-->"),typeof P!="string"&&!kn(P))if(typeof P.toString=="function"){if(P=P.toString(),typeof P!="string")throw et("dirty is not a string, aborting")}else throw et("toString is not a function");if(!e.isSupported)return P;if(Be||Ot(h),e.removed=[],typeof P=="string"&&(We=!1),We){if(P.nodeName){const Te=q(P.nodeName);if(!F[Te]||ae[Te])throw et("root node is forbidden and cannot be sanitized in-place")}}else if(P instanceof o)v=Cn("<!---->"),T=v.ownerDocument.importNode(P,!0),T.nodeType===nt.element&&T.nodeName==="BODY"||T.nodeName==="HTML"?v=T:v.appendChild(T);else{if(!Fe&&!ye&&!fe&&P.indexOf("<")===-1)return x&&dt?x.createHTML(P):P;if(v=Cn(P),!v)return Fe?null:dt?y:""}v&&se&&Se(v.firstChild);const K=yn(We?P:v);for(;H=K.nextNode();)In(H),xn(H),H.content instanceof i&&Ls(H.content);if(We)return P;if(Fe){if(ut)for(Y=A.call(v.ownerDocument);v.firstChild;)Y.appendChild(v.firstChild);else Y=v;return(G.shadowroot||G.shadowrootmode)&&(Y=V.call(n,Y,!0)),Y}let te=fe?v.outerHTML:v.innerHTML;return fe&&F["!doctype"]&&v.ownerDocument&&v.ownerDocument.doctype&&v.ownerDocument.doctype.name&&Z(hs,v.ownerDocument.doctype.name)&&(te="<!DOCTYPE "+v.ownerDocument.doctype.name+`>
`+te),ye&&vt([B,D,Q],Te=>{te=Xe(te,Te," ")}),x&&dt?x.createHTML(te):te},e.setConfig=function(){let P=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Ot(P),Be=!0},e.clearConfig=function(){ze=null,Be=!1},e.isValidAttribute=function(P,h,v){ze||Ot({});const T=q(P),H=q(h);return Tn(T,H,v)},e.addHook=function(P,h){typeof h=="function"&&Je(L[P],h)},e.removeHook=function(P,h){if(h!==void 0){const v=$i(L[P],h);return v===-1?void 0:Ui(L[P],v,1)[0]}return Bn(L[P])},e.removeHooks=function(P){L[P]=[]},e.removeAllHooks=function(){L=qn()},e}var er=ps();class tr{Render(e){const t=O.parse(e??"",{breaks:!0});return er.sanitize(t)}}class nr{constructor(){this.MarkdownRenderer=new tr}RenderWelcome({Text:e}){return`
      <div class="flex h-full flex-col items-center justify-center text-center">
        <h1 class="text-3xl font-semibold text-slate-900">${e.WelcomeHeading}</h1>
      </div>
    `}RenderConversation({Messages:e,MessageGroups:t,Settings:n,Text:s}){const i=new Map((e??[]).map(l=>[l.Id,l])),r=l=>this.ResolveModelLabel(l,n);return t!=null&&t.length?`
        <div class="chat-thread flex flex-col gap-4">
          ${t.map(c=>{var M,x,y;const u=i.get(c.UserMessageId),p=i.get(c.AssistantMessageId),g=c.InternalMessageIds??[],d=g.length,f=((M=n==null?void 0:n.Chat)==null?void 0:M.InternalChatMessages)&&d>0,m=((x=s==null?void 0:s.Chat)==null?void 0:x.InternalMessageLabel)??"Thought",S=((y=s==null?void 0:s.Chat)==null?void 0:y.InternalMessagesSummaryLabel)??"internal messages",b=f?`
            <div class="internal-summary">
              ${d} ${S}
            </div>
          `:"",w=f?`
            <div class="internal-messages">
              ${g.map(k=>i.get(k)).filter(Boolean).map(k=>`
                    <div class="internal-message">
                      <div class="internal-label">${m}</div>
                      ${this.MarkdownRenderer.Render(k.Content)}
                    </div>
                  `).join("")}
            </div>
          `:"";return`
          <div class="flex flex-col gap-3">
            ${u?this.RenderUserMessage(u):""}
            ${b}
            ${w}
            ${p?this.RenderAssistantMessage(p,s,r(p)):""}
          </div>
        `}).join("")}
        </div>
      `:`
      <div class="chat-thread flex flex-col gap-4">
        ${(e??[]).map(l=>l.Role==="User"?this.RenderUserMessage(l):this.RenderAssistantMessage(l,s,r(l))).join("")}
      </div>
    `}RenderUserMessage(e){return`
      <div class="flex justify-end">
        <div class="user-bubble max-w-[70%] px-4 py-2 text-sm">
          ${this.MarkdownRenderer.Render(e.Content)}
        </div>
      </div>
    `}RenderAssistantMessage(e,t,n){var i,r;if(e.Status==="pending")return`
        <div class="assistant-block">
          <div class="assistant-pending text-sm" data-chat-pending>
            <span class="material-symbols-outlined pending-spinner">autorenew</span>
            <span>${(t==null?void 0:t.PendingMessage)??"Waiting for response..."}</span>
          </div>
        </div>
      `;if(e.Status==="aborted"){const o=this.RenderAssistantMeta(e,n,{Prefix:"Aborted"});return`
        <div class="assistant-block">
          ${(e.Content??"").trim().length>0?`
            <div class="assistant-text text-sm text-slate-800">
              ${this.MarkdownRenderer.Render(e.Content??"")}
            </div>
          `:""}
          <div class="assistant-pending text-sm" data-chat-aborted>
            <span class="material-symbols-outlined">close</span>
            <span>${((i=t==null?void 0:t.Chat)==null?void 0:i.AbortedMessageText)??"Response aborted."}</span>
          </div>
          ${o}
        </div>
      `}if(e.Status==="streaming"&&e.ReasoningEnabled)return`
        <div class="assistant-block">
          <div class="assistant-pending text-sm" data-chat-thinking>
            <span class="material-symbols-outlined pending-spinner">autorenew</span>
            <span>${((r=t==null?void 0:t.Chat)==null?void 0:r.ThinkingIndicatorText)??"Thinking..."}</span>
          </div>
          ${(e.Content??"").trim().length>0?`
            <div class="assistant-text text-sm text-slate-800">
              ${this.MarkdownRenderer.Render(e.Content??"")}
            </div>
          `:""}
        </div>
      `;if(e.Status==="error"){const o=e.ProviderId??"provider",l=n??e.ModelId??"model";return`
        <div class="assistant-block">
          <div class="assistant-error" data-chat-error>
            <div class="assistant-error-header">Request failed · ${o} / ${l}</div>
            <div class="assistant-error-message">${e.ErrorMessage??"Request failed."}</div>
            <button class="settings-secondary-button" data-action="retry-message" data-message-id="${e.Id}">
              ${(t==null?void 0:t.RetryAction)??"Retry"}
            </button>
          </div>
        </div>
      `}const s=e.Status==="done"?this.RenderAssistantMeta(e,n):"";return`
      <div class="assistant-block">
        <div class="assistant-text text-sm text-slate-800">
          ${this.MarkdownRenderer.Render(e.Content)}
        </div>
        ${s}
      </div>
    `}RenderAssistantMeta(e,t,{Prefix:n}={}){const s=(e==null?void 0:e.Metrics)??{},i=this.FormatDuration(s.DurationMs),r=this.FormatTokenCount(s.InputTokens),o=this.FormatTokenCount(s.OutputTokens),l=t??(e==null?void 0:e.ModelId)??null,c=n?`
        <span>${n}</span>
        <span class="assistant-meta-dot">·</span>
      `:"",u=l?`
        <span>${l}</span>
        <span class="assistant-meta-dot">·</span>
      `:"";return`
      <div class="assistant-meta" data-assistant-meta>
        ${c}
        <span>Time ${i}</span>
        <span class="assistant-meta-dot">·</span>
        ${u}
        <span>In ${r}</span>
        <span class="assistant-meta-dot">·</span>
        <span>Out ${o}</span>
      </div>
    `}ResolveModelLabel(e,t){var o,l,c;const n=(e==null?void 0:e.ProviderId)??null,s=(e==null?void 0:e.ModelId)??null;if(!n||!s)return null;const i=(l=(o=t==null?void 0:t.Providers)==null?void 0:o.Providers)==null?void 0:l.find(u=>u.Id===n),r=(c=i==null?void 0:i.Models)==null?void 0:c.find(u=>u.Id===s);return(r==null?void 0:r.Label)??s}FormatDuration(e){if(typeof e!="number")return"--";const t=Math.max(e,0)/1e3;return t<1?`${Math.round(t*1e3)}ms`:`${t.toFixed(1)}s`}FormatTokenCount(e){return typeof e!="number"?"--":`${e}`}}class sr{Render({Text:e,InputText:t="",IsSending:n=!1,SelectedModelId:s,Reasoning:i}){const r=Ve({Icon:"assets/icons/add.svg",Action:"toggle-attachments",AriaLabel:"Attachments",ClassName:"input-attach"}),o=yt({Material:"attach_file",Action:"attach-files",Label:e.Attachments.AttachFiles,ClassName:"attachments-item"}),l=(t??"").trim().length>0,u=Ve(n?{Material:"close",Action:"abort-response",AriaLabel:"Abort",ClassName:"input-send"}:{Material:"keyboard_arrow_up",Action:"send-message",AriaLabel:"Send",ClassName:"input-send",Disabled:!l||!(s===void 0?!0:!!s)}),p=this.RenderReasoningControls(i,e);return`
      <div class="input-wrapper relative">
        <div class="input-shell" data-input-shell>
          ${r}
          <textarea
            class="input-text"
            data-action="chat-input"
            rows="1"
            placeholder="${e.InputPlaceholder}"
            aria-label="Chat input"
          >${t}</textarea>
          ${u}
        </div>
        <div class="attachments-menu hidden" data-attachments-menu>
          ${o}
          ${p}
        </div>
      </div>
    `}RenderReasoningControls(e,t){if(!e)return"";const n=(t==null?void 0:t.Chat)??{},s=e.ControlType,i=s==="effort_enum"?this.RenderEffortControl(e,n):s==="token_budget"?this.RenderBudgetControl(e,n):"";return i||""}RenderEffortControl(e,t){var l;const n="off",s=[{Label:t.ReasoningOffLabel??"Off",Value:n,Data:{action:"select-reasoning-effort",value:n}},...(e.Allowed??[]).map(c=>({Label:c,Value:c,Data:{action:"select-reasoning-effort",value:c}}))],i=e.Enabled?e.EffortLevel??((l=s[1])==null?void 0:l.Value)??null:n,r=i??t.ReasoningOffLabel??"Off",o=Wt({MenuId:"reasoning-effort",ButtonContent:`
        <span>${r}</span>
        <span class="material-symbols-outlined">expand_more</span>
      `,Items:s,SelectedValue:i});return`
      <div class="attachments-row">
        <div class="attachments-row-label">\r
          ${ue("neurology","attachments-row-icon")}\r
          <span>${t.ReasoningEffortLabel??"Reasoning"}</span>\r
        </div>
        <div class="attachments-row-control">${o}</div>
      </div>
    `}RenderBudgetControl(e,t){const n=e.TokenBudget??"";return`
      <div class="attachments-row">
        <div class="attachments-row-label">\r
          ${ue("neurology","attachments-row-icon")}\r
          <span>${t.ReasoningBudgetLabel??"Reasoning"}</span>\r
        </div>
        <div class="attachments-row-control">
          <input
            class="attachments-input"
            type="number"
            min="0"
            inputmode="numeric"
            data-action="update-reasoning-budget"
            value="${n}"
            placeholder="0"
          />
        </div>
      </div>
    `}}class ir{constructor({DurationMs:e}){this.DurationMs=e,this.Container=null,this.MessageNode=null,this.TimeoutId=null}Render(){return`
      <div class="pointer-events-none fixed inset-x-0 bottom-6 z-50 flex justify-center">
        <div
          data-snackbar
          class="snackbar-hidden rounded-full bg-slate-900 px-4 py-2 text-sm text-white shadow-lg transition-all duration-200"
          role="status"
          aria-live="polite"
        >
          <span data-snackbar-message></span>
        </div>
      </div>
    `}Mount(e){this.Container=e.querySelector("[data-snackbar]"),this.MessageNode=e.querySelector("[data-snackbar-message]")}Show(e){!this.Container||!this.MessageNode||(this.MessageNode.textContent=e,this.Container.classList.remove("snackbar-hidden"),this.Container.classList.add("snackbar-visible"),this.TimeoutId&&clearTimeout(this.TimeoutId),this.TimeoutId=setTimeout(()=>{this.Container.classList.remove("snackbar-visible"),this.Container.classList.add("snackbar-hidden")},this.DurationMs))}}const rr=[{Id:"general",Label:"General",IconMaterial:"tune"},{Id:"chat",Label:"Chat",IconMaterial:"chat_bubble"},{Id:"providers",Label:"Providers",IconMaterial:"hub"}];class or{Render(e){const t=e.ActiveCategory,n=e.Options.Accents.find(r=>r.Id===e.General.AccentColor)??e.Options.Accents[0],s=e.Options.Themes.find(r=>r.Id===e.General.Theme)??e.Options.Themes[0],i=rr.map(r=>`
      <button
        class="settings-nav-item ${r.Id===t?"is-active":""}"
        data-action="settings-category"
        data-category="${r.Id}"
      >
        <span class="settings-nav-icon">
          ${ue(r.IconMaterial)}
        </span>
        ${r.Label}
      </button>
    `).join("");return`
      <div class="settings-overlay ${e.IsOpen?"":"hidden"}" data-settings-overlay>
        <div class="settings-backdrop" data-action="close-settings" aria-hidden="true"></div>
        <div class="settings-panel" role="dialog" aria-modal="true" aria-label="Settings">
          <div class="settings-body">
            <aside class="settings-nav">
              ${Ve({Material:"close",Action:"close-settings",AriaLabel:"Close settings",ClassName:"settings-close"})}
              ${i}
            </aside>
            <section class="settings-content">
              ${this.RenderCategory(e,{activeAccent:n,activeTheme:s})}
            </section>
          </div>
        </div>
      </div>
    `}RenderCategory(e,t){return e.ActiveCategory==="providers"?this.RenderProviders(e.Providers):e.ActiveCategory==="chat"?this.RenderChat(e):this.RenderGeneral(e,t)}RenderGeneral(e,{activeAccent:t,activeTheme:n}){const s=e.Options.Themes.map(l=>({Label:l.Label,Value:l.Id,Data:{action:"select-settings-option",field:"theme",value:l.Id}})),i=e.Options.Accents.map(l=>({Label:l.Label,Value:l.Id,LeadingHtml:`<span class="accent-swatch" style="--accent-swatch: ${l.Hex};"></span>`,Data:{action:"select-settings-option",field:"accent",value:l.Id}})),r=Wt({MenuId:"theme",ButtonContent:`
        <span>${n.Label}</span>
        ${ue("expand_more")}
      `,Items:s,SelectedValue:n.Id}),o=Wt({MenuId:"accent",ButtonContent:`
        <span class="accent-swatch" style="--accent-swatch: ${t.Hex};"></span>
        <span>${t.Label}</span>
        ${ue("expand_more")}
      `,Items:i,SelectedValue:t.Id});return`
      <div class="settings-section">
        ${mt("Appearance")}
        <div class="settings-row">
          <div class="settings-row-label">Theme</div>
          <div class="settings-row-control">
            ${r}
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-row-label">Accent Colour</div>
          <div class="settings-row-control">
            ${o}
          </div>
        </div>
      </div>
    `}RenderChat(e){const t=Ln({Checked:e.Chat.InternalChatMessages,Data:{action:"toggle-internal-messages"}});return`
      <div class="settings-section">
        ${mt("Chat")}
        <div class="settings-row">
          <div class="settings-row-label">Internal chat messages</div>
          <div class="settings-row-control">
            ${t}
          </div>
        </div>
      </div>
    `}RenderProviders(e){var r,o;if(!e.SelectedProviderId)return this.RenderProviderList(e.Providers);const t=e.Providers.find(l=>l.Id===e.SelectedProviderId);if(!t)return this.RenderProviderList(e.Providers);const n=e.Keys[t.Id]??"",s=((r=e.KeyVisibility)==null?void 0:r[t.Id])??!1,i=((o=e.ModelAvailability)==null?void 0:o[t.Id])??null;return this.RenderProviderDetail(t,n,s,i)}RenderProviderList(e){const t=e.map(n=>`
      <button class="provider-row" data-action="select-provider" data-provider-id="${n.Id}">
        <span class="provider-icon">
          ${Pt({Icon:n.Icon})}
        </span>
        <span class="provider-name">${n.Name}</span>
        <span class="provider-arrow">
          ${ue("chevron_right")}
        </span>
      </button>
    `).join("");return`
      <div class="settings-section">
        ${mt("Providers")}
        <div class="provider-list">
          ${t}
        </div>
      </div>
    `}RenderProviderDetail(e,t,n,s){const i=n?"text":"password",r=n?"visibility_off":"visibility",o=e.Models.map(l=>{const c=s==null?void 0:s[l.Id],u=s?!c:!0,p=Ln({Checked:l.Enabled,Disabled:u,Data:{action:"toggle-provider-model","provider-id":e.Id,"model-id":l.Id}});return`
        <div class="${u?"model-row is-unavailable":l.Enabled?"model-row":"model-row is-disabled"}">
          <div class="model-info">
            <div class="model-name">${l.Label}</div>
            <div class="model-description">${l.Description??""}</div>
          </div>
          ${p}
        </div>
      `}).join("");return`
      <div class="settings-section">
        <button class="provider-back" data-action="back-provider" type="button">
          ${ue("arrow_back")}
          <span>Back</span>
        </button>
        ${mt(`${e.Name} Provider Details`)}
        <div class="settings-row settings-row-stack settings-row-borderless">
          <div class="settings-row-label">API Key</div>
          <div class="settings-row-control">
            <div class="settings-input-row">
              <div class="settings-input-wrap">
                <input
                  type="${i}"
                  class="settings-input"
                  placeholder="Paste your key"
                  value="${t}"
                  data-action="update-provider-key"
                  data-provider-id="${e.Id}"
                />
                <button
                  class="settings-input-icon"
                  data-action="toggle-provider-key-visibility"
                  data-provider-id="${e.Id}"
                  type="button"
                  aria-label="Toggle key visibility"
                >
                  ${ue(r)}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-divider"></div>
        <div class="settings-subsection-header">
          <div class="settings-subsection-title">Available models</div>
          <button class="settings-secondary-button" data-action="test-provider-key" data-provider-id="${e.Id}" type="button">
            <span>Test</span>
          </button>
        </div>
        <div class="model-list">
          ${o}
        </div>
      </div>
    `}}const ce=a=>(a??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),ar=({ExcerptText:a,ExcerptMatchStart:e,ExcerptMatchEnd:t})=>{const n=(a??"").toString(),s=Math.max(0,e??0),i=Math.max(s,t??s),r=n.slice(0,s),o=n.slice(s,i),l=n.slice(i);return`${ce(r)}<mark class="chat-search-highlight">${ce(o)}</mark>${ce(l)}`};class lr{Render({ChatSearch:e,Text:t}={}){const n=(e==null?void 0:e.IsOpen)===!0,s=(t==null?void 0:t.ChatSearch)??{},i=(e==null?void 0:e.Query)??"",r=(e==null?void 0:e.Results)??[],o=(e==null?void 0:e.Error)??null,l=Ve({Icon:"assets/icons/close.svg",Action:"close-chat-search",AriaLabel:s.CloseAriaLabel??"Close search",ClassName:"chat-search-close"}),c=o?`<div class="chat-search-empty">${ce(s.ErrorText??"Couldn't load pinned chats.")}</div>`:(i??"").trim().length===0?`<div class="chat-search-empty">${ce(s.EmptyStateText??"Type to search your pinned chats.")}</div>`:r.length===0?`<div class="chat-search-empty">${ce(s.NoResultsText??"No matches found.")}</div>`:`
                <div class="chat-search-results-list">
                  ${r.map(u=>`
                    <button
                      class="two-line-item conversation-item chat-search-result"
                      type="button"
                      data-action="select-chat-search-result"
                      data-conversation-id="${ce(u.ConversationId)}"
                    >
                      <img src="assets/icons/chat_bubble_outline.svg" alt="" class="two-line-icon" />
                      <span class="two-line-text">
                        <span class="two-line-title">${ce(u.Title??"")}</span>
                        <span class="two-line-subtitle chat-search-excerpt">${ar(u)}</span>
                      </span>
                    </button>
                  `).join("")}
                </div>
              `;return`
      <div class="settings-overlay chat-search-overlay ${n?"":"hidden"}" data-chat-search-overlay>
        <div class="settings-backdrop" data-action="close-chat-search" aria-hidden="true"></div>
        <div class="settings-panel chat-search-panel" role="dialog" aria-modal="true" aria-label="${ce(s.Title??"Search chats")}">
          <div class="chat-search-header">
            <input
              class="chat-search-input"
              type="text"
              value="${ce(i)}"
              placeholder="${ce(s.Placeholder??"")}"
              data-action="chat-search-query"
              data-chat-search-input="true"
              spellcheck="false"
              autocomplete="off"
            />
            ${l}
          </div>
          <div class="chat-search-divider"></div>
          <div class="chat-search-results">
            ${c}
          </div>
        </div>
      </div>
    `}}const cr=a=>{Object.assign(a.prototype,{CloseMenus({KeepAttachments:e=!1}={}){const t=this.Container;if(!t)return;const n=t.querySelector("[data-model-menu]"),s=t.querySelector('[data-action="toggle-models"]'),i=t.querySelector("[data-attachments-menu]");n&&n.classList.add("hidden"),s&&s.setAttribute("aria-expanded","false"),i&&!e&&i.classList.add("hidden"),t.querySelectorAll("[data-settings-menu]").forEach(r=>{r.classList.add("hidden")}),t.querySelectorAll('[data-action="toggle-settings-menu"]').forEach(r=>{r.setAttribute("aria-expanded","false")})},HandleClick(e){var o,l,c,u,p,g,d,f,m,S,b,w,M,x,y,k,C,A,_,V,L,B,D,Q,$,pe,oe,ge,Le,xe,F,Pe,G,we,N,ae,Ce,ne,Ae;const t=this.Container;if(!t)return;const n=(l=(o=e.target)==null?void 0:o.closest)==null?void 0:l.call(o,"[data-action]");if(!n||!t.contains(n))return;const s=n.getAttribute("data-action"),i=this.LatestHandlers??{},r=this.LatestViewModel??{};if(s==="toggle-sidebar"){(c=i.onToggleSidebar)==null||c.call(i);return}if(s==="toggle-models"){const I=t.querySelector("[data-model-menu]");if(!I)return;const j=I.classList.contains("hidden");this.CloseMenus(),I.classList.toggle("hidden",!j),n.setAttribute("aria-expanded",j?"true":"false");return}if(s==="toggle-settings-menu"){const I=n.getAttribute("data-menu-id"),j=I?t.querySelector(`[data-settings-menu][data-menu-id="${I}"]`):null;if(!j)return;const Re=j.classList.contains("hidden");this.CloseMenus({KeepAttachments:!0}),j.classList.toggle("hidden",!Re),n.setAttribute("aria-expanded",Re?"true":"false");return}if(s==="toggle-attachments"){const I=t.querySelector("[data-attachments-menu]");if(!I)return;const j=I.classList.contains("hidden");this.CloseMenus(),I.classList.toggle("hidden",!j);return}if(s==="select-model"){const I=n.getAttribute("data-model-id");I&&(i.onSelectModel?i.onSelectModel(I):(p=this.Snackbar)==null||p.Show((u=r.Text)==null?void 0:u.NotImplemented)),this.CloseMenus();return}if(s==="new-chat"){this.ChatSavingRestoreFocusSelector='[data-action="new-chat"]',i.onStartNewChat?i.onStartNewChat():(d=this.Snackbar)==null||d.Show((g=r.Text)==null?void 0:g.NotImplemented),this.CloseMenus();return}if(s==="search-chats"){this.ChatSearchRestoreFocusSelector='[data-action="search-chats"]',(f=i.onOpenChatSearch)==null||f.call(i),this.CloseMenus();return}if(s==="close-chat-search"){(m=i.onCloseChatSearch)==null||m.call(i),this.CloseMenus();return}if(s==="select-chat-search-result"){const I=n.getAttribute("data-conversation-id");I&&(this.ChatSearchRestoreFocusSelector='[data-action="chat-input"]',(S=i.onSelectChatSearchResult)==null||S.call(i,I));return}if(s==="attach-files"){(w=this.Snackbar)==null||w.Show((b=r.Text)==null?void 0:b.NotImplemented),this.CloseMenus();return}if(s==="select-reasoning-effort"){const I=n.getAttribute("data-value");I&&((M=i.onSelectReasoningEffort)==null||M.call(i,I)),this.CloseMenus();return}if(s==="select-reasoning-toggle"){const I=n.getAttribute("data-value");I&&((x=i.onSelectReasoningToggle)==null||x.call(i,I)),this.CloseMenus();return}if(s==="toggle-pin"){this.ChatSavingRestoreFocusSelector='[data-action="toggle-pin"]',(y=i.onTogglePin)==null||y.call(i),this.CloseMenus();return}if(s==="open-settings"){(k=i.onOpenSettings)==null||k.call(i),this.CloseMenus();return}if(s==="select-conversation"){const I=n.getAttribute("data-conversation-id");I&&(this.ChatSavingRestoreFocusSelector=`[data-action="select-conversation"][data-conversation-id="${I}"]`,(C=i.onSelectConversation)==null||C.call(i,I));return}if(s==="send-message"){(A=i.onSendMessage)==null||A.call(i);const I=(_=this.Container)==null?void 0:_.querySelector('[data-action="chat-input"]');I&&(I.value="",this.ResizeChatInput(),this.UpdateInputActionButtonState(this.LatestViewModel,I.value));return}if(s==="abort-response"){(V=i.onAbortSend)==null||V.call(i);return}if(s==="close-settings"){(L=i.onCloseSettings)==null||L.call(i),this.CloseMenus();return}if(s==="settings-category"){const I=n.getAttribute("data-category");I&&((B=i.onSelectSettingsCategory)==null||B.call(i,I));return}if(s==="select-settings-option"){const I=n.getAttribute("data-field"),j=n.getAttribute("data-value");I==="theme"&&((D=i.onUpdateTheme)==null||D.call(i,j)),I==="accent"&&((Q=i.onUpdateAccent)==null||Q.call(i,j)),this.CloseMenus();return}if(s==="select-provider"){const I=n.getAttribute("data-provider-id");I&&(($=i.onSelectProvider)==null||$.call(i,I));return}if(s==="back-provider"){(pe=i.onBackToProviders)==null||pe.call(i);return}if(s==="clear-provider-key"){const I=n.getAttribute("data-provider-id");I&&((oe=i.onClearProviderKey)==null||oe.call(i,I));return}if(s==="toggle-provider-key-visibility"){const I=n.getAttribute("data-provider-id");I&&((ge=i.onToggleProviderKeyVisibility)==null||ge.call(i,I));return}if(s==="test-provider-key"){const I=n.getAttribute("data-provider-id");I&&((Le=i.onTestProviderKey)==null||Le.call(i,I));return}if(s==="close-provider-validation"){(xe=i.onCloseProviderValidationPopup)==null||xe.call(i);return}if(s==="retry-message"){const I=n.getAttribute("data-message-id");I&&((F=i.onRetryMessage)==null||F.call(i,I));return}if(s==="toggle-internal-group"){const I=n.getAttribute("data-group-id");I&&((Pe=i.onToggleInternalGroup)==null||Pe.call(i,I));return}if(s==="close-retry-popup"){(G=i.onCloseRetryPopup)==null||G.call(i);return}if(s==="retry-use-original"){(we=i.onConfirmRetry)==null||we.call(i,!1);return}if(s==="retry-use-selected"){(N=i.onConfirmRetry)==null||N.call(i,!0);return}if(s==="cancel-pin"){(ae=i.onCancelPin)==null||ae.call(i);return}if(s==="confirm-pin"){(Ce=i.onConfirmPin)==null||Ce.call(i);return}if(s==="cancel-discard"){(ne=i.onCancelDiscard)==null||ne.call(i);return}s==="confirm-discard"&&((Ae=i.onConfirmDiscard)==null||Ae.call(i))},HandleInput(e){var i,r,o,l,c,u;const t=e.target;if(!(t!=null&&t.getAttribute))return;const n=t.getAttribute("data-action"),s=this.LatestHandlers??{};if(n==="chat-input"){this.ResizeChatInput(),(i=s.onUpdateInput)==null||i.call(s,t.value),this.UpdateInputActionButtonState(this.LatestViewModel,t.value);return}if(n==="chat-search-query"){(r=s.onUpdateChatSearchQuery)==null||r.call(s,t.value??"");return}if(n==="update-provider-key"){const p=t.getAttribute("data-provider-id");p&&((o=s.onUpdateProviderKey)==null||o.call(s,p,t.value));return}if(n==="pin-name"){const p=(l=this.Container)==null?void 0:l.querySelector("[data-chat-saving-pin-error]");p&&(p.classList.add("hidden"),p.textContent=""),(c=s.onUpdatePinName)==null||c.call(s,t.value)}n==="update-reasoning-budget"&&((u=s.onUpdateReasoningBudget)==null||u.call(s,t.value??""))},HandleChange(e){var i,r,o;const t=e.target;if(!(t!=null&&t.getAttribute))return;const n=t.getAttribute("data-action"),s=this.LatestHandlers??{};if(n==="toggle-provider-model"){const l=t.getAttribute("data-provider-id"),c=t.getAttribute("data-model-id");l&&c&&((i=s.onToggleProviderModel)==null||i.call(s,l,c,t.checked));return}n==="toggle-internal-messages"&&((r=s.onToggleInternalMessages)==null||r.call(s,t.checked)),n==="toggle-reasoning"&&((o=s.onToggleReasoning)==null||o.call(s,t.checked))},HandleKeydown(e){var s,i,r,o,l;if(e.isComposing)return;const t=e.target;if(!(t!=null&&t.getAttribute))return;const n=t.getAttribute("data-action");if(n==="chat-input"){if((s=this.LatestViewModel)!=null&&s.IsSending||e.key!=="Enter"||e.shiftKey||!((t.value??"").trim().length>0)||!this.HasSelectedModel(this.LatestViewModel))return;e.preventDefault(),(r=(i=this.LatestHandlers)==null?void 0:i.onSendMessage)==null||r.call(i),t.value="",this.ResizeChatInput(),this.UpdateInputActionButtonState(this.LatestViewModel,t.value);return}if(n==="select-chat-search-result"&&e.key==="Enter"){const c=t.getAttribute("data-conversation-id");if(!c)return;e.preventDefault(),(l=(o=this.LatestHandlers)==null?void 0:o.onSelectChatSearchResult)==null||l.call(o,c)}}})},ur=a=>{Object.assign(a.prototype,{SetupChatInputSizing(){this.TextMeasureCanvas=this.TextMeasureCanvas??document.createElement("canvas"),this.ResizeChatInput()},ResizeChatInput(){var l,c,u,p,g,d,f;const e=(l=this.Container)==null?void 0:l.querySelector('[data-action="chat-input"]'),t=(c=this.Container)==null?void 0:c.querySelector("[data-input-shell]");if(!e||!t)return;const s=(Number.parseFloat(getComputedStyle(e).lineHeight)||20)*(((p=(u=this.LatestViewModel)==null?void 0:u.Layout)==null?void 0:p.InputMaxLines)??10);let i=!1;const r=e.value??"";if(i=r.includes(`
`),!i&&!this.DisableCanvasTextMeasure&&!this.CanvasTextMeasureFailed)try{const m=this.TextMeasureCanvas??document.createElement("canvas");this.TextMeasureCanvas=m;const S=(g=m.getContext)==null?void 0:g.call(m,"2d");if(!S)this.CanvasTextMeasureFailed=!0;else{const b=getComputedStyle(e),w=b.font||`${b.fontStyle} ${b.fontVariant} ${b.fontWeight} ${b.fontSize} / ${b.lineHeight} ${b.fontFamily}`;S.font=w;const M=getComputedStyle(t),x=Number.parseFloat(getComputedStyle(document.documentElement).fontSize)||16,y=D=>{if(!D)return 0;if(D.endsWith("px"))return Number.parseFloat(D);if(D.endsWith("rem"))return Number.parseFloat(D)*x;const Q=Number.parseFloat(D);return Number.isNaN(Q)?0:Q},k=y(M.paddingLeft),C=y(M.paddingRight),A=y(M.columnGap||M.gap||"0px"),_=((d=t.querySelector(".input-attach"))==null?void 0:d.offsetWidth)??0,V=((f=t.querySelector(".input-send"))==null?void 0:f.offsetWidth)??0,L=Math.max(t.clientWidth-k-C-_-V-A*2,0);i=Math.max(...r.split(`
`).map(D=>S.measureText(D).width),0)+2>L}}catch{this.CanvasTextMeasureFailed=!0}t.classList.toggle("input-multiline",i),e.style.height="auto";const o=Math.min(e.scrollHeight,s);e.style.height=`${o}px`,e.style.overflowY=e.scrollHeight>s?"auto":"hidden"},SyncChatInput(e){var s,i;const t=(s=this.Container)==null?void 0:s.querySelector('[data-action="chat-input"]');if(!t)return;const n=((i=e.Text)==null?void 0:i.InputPlaceholder)??"";n&&t.getAttribute("placeholder")!==n&&t.setAttribute("placeholder",n),document.activeElement!==t&&(t.value??"")!==(e.InputText??"")&&(t.value=e.InputText??"",this.ResizeChatInput()),this.EnsureInputActionButtonMode(e),this.UpdateInputActionButtonState(e,t.value??"")},EnsureInputActionButtonMode(e){var o,l,c,u;const t=(o=this.Container)==null?void 0:o.querySelector(".input-send");if(!t)return;const n=!!(e!=null&&e.IsSending),s=n?"abort-response":"send-message";(((l=t.getAttribute)==null?void 0:l.call(t,"data-action"))??"")!==s&&t.setAttribute("data-action",s),t.setAttribute("aria-label",n?"Abort":"Send");const r=(c=t.querySelector)==null?void 0:c.call(t,".material-symbols-outlined");if(r){const p=n?"close":"keyboard_arrow_up";(r.textContent??"").trim()!==p&&(r.textContent=p)}n&&(t.disabled=!1,(u=t.removeAttribute)==null||u.call(t,"disabled"))},HasSelectedModel(e){var n;const t=(e==null?void 0:e.SelectedModelId)??((n=e==null?void 0:e.ModelSelector)==null?void 0:n.SelectedModelId);return t===void 0?!0:!!t},UpdateInputActionButtonState(e,t){var o,l;const n=(o=this.Container)==null?void 0:o.querySelector(".input-send");if(!n)return;const s=((l=n.getAttribute)==null?void 0:l.call(n,"data-action"))??"";if(s==="abort-response"){n.disabled=!1;return}if(s!=="send-message")return;const i=(t??"").trim().length>0,r=this.HasSelectedModel(e);n.disabled=!!(e!=null&&e.IsSending)||!i||!r}})},dr=a=>{Object.assign(a.prototype,{CaptureChatSearchEditingState(){if(!this.Container)return null;const e=this.Container.querySelector("[data-chat-search-input]");return!e||document.activeElement!==e?null:{SelectionStart:typeof e.selectionStart=="number"?e.selectionStart:null,SelectionEnd:typeof e.selectionEnd=="number"?e.selectionEnd:null}},RestoreChatSearchEditingState(e,t){var s;if(!this.Container||!e||((s=t.ChatSearch)==null?void 0:s.IsOpen)!==!0)return;const n=this.Container.querySelector("[data-chat-search-input]");n&&(n.focus(),typeof n.setSelectionRange=="function"&&e.SelectionStart!=null&&n.setSelectionRange(e.SelectionStart,e.SelectionEnd??e.SelectionStart))},UpdateModalKeyHandlers(e){var i,r,o,l,c,u,p;this.RetryKeyHandler&&(document.removeEventListener("keydown",this.RetryKeyHandler),this.RetryKeyHandler=null),(i=e.RetryPopup)!=null&&i.IsOpen&&(this.RetryKeyHandler=g=>{var d,f;g.key==="Enter"&&(g.preventDefault(),(f=(d=this.LatestHandlers)==null?void 0:d.onConfirmRetry)==null||f.call(d,!0))},document.addEventListener("keydown",this.RetryKeyHandler)),this.ChatSavingKeyHandler&&(document.removeEventListener("keydown",this.ChatSavingKeyHandler),this.ChatSavingKeyHandler=null);const t=((o=(r=e.ChatSaving)==null?void 0:r.PinDialog)==null?void 0:o.IsOpen)===!0,n=((c=(l=e.ChatSaving)==null?void 0:l.DiscardDialog)==null?void 0:c.IsOpen)===!0;(t||n)&&(this.ChatSavingKeyHandler=g=>{var d,f,m,S,b,w,M,x;g.isComposing||(g.key==="Escape"&&(g.preventDefault(),t?(f=(d=this.LatestHandlers)==null?void 0:d.onCancelPin)==null||f.call(d):n&&((S=(m=this.LatestHandlers)==null?void 0:m.onCancelDiscard)==null||S.call(m))),g.key==="Enter"&&(g.preventDefault(),t?(w=(b=this.LatestHandlers)==null?void 0:b.onConfirmPin)==null||w.call(b):n&&((x=(M=this.LatestHandlers)==null?void 0:M.onConfirmDiscard)==null||x.call(M))))},document.addEventListener("keydown",this.ChatSavingKeyHandler)),this.ChatSearchKeyHandler&&(document.removeEventListener("keydown",this.ChatSearchKeyHandler),this.ChatSearchKeyHandler=null),((u=e.ChatSearch)==null?void 0:u.IsOpen)===!0&&!(t||n)&&!((p=e.RetryPopup)!=null&&p.IsOpen)&&(this.ChatSearchKeyHandler=g=>{var d,f;g.isComposing||g.key==="Escape"&&(g.preventDefault(),(f=(d=this.LatestHandlers)==null?void 0:d.onCloseChatSearch)==null||f.call(d))},document.addEventListener("keydown",this.ChatSearchKeyHandler))},UpdateChatSavingFocus(e){var i,r,o,l,c,u,p,g,d,f,m,S;const t=((r=(i=e.ChatSaving)==null?void 0:i.PinDialog)==null?void 0:r.IsOpen)===!0,n=((l=(o=e.ChatSaving)==null?void 0:o.DiscardDialog)==null?void 0:l.IsOpen)===!0,s=t||n;if(t){const b=(c=this.Container)==null?void 0:c.querySelector('[data-action="pin-name"]');b&&(b.value=((p=(u=e.ChatSaving)==null?void 0:u.PinDialog)==null?void 0:p.Name)??"",b.focus(),(g=b.select)==null||g.call(b))}else if(n){const b=(d=this.Container)==null?void 0:d.querySelector('[data-action="cancel-discard"]');(f=b==null?void 0:b.focus)==null||f.call(b)}else if(this.ChatSavingDialogWasOpen){const b=this.ChatSavingRestoreFocusSelector?(m=this.Container)==null?void 0:m.querySelector(this.ChatSavingRestoreFocusSelector):null;(S=b==null?void 0:b.focus)==null||S.call(b),this.ChatSavingRestoreFocusSelector=null}this.ChatSavingDialogWasOpen=s},UpdateChatSearchFocus(e){var n,s,i,r,o,l;const t=((n=e.ChatSearch)==null?void 0:n.IsOpen)===!0;if(t&&!this.ChatSearchDialogWasOpen){const c=(s=this.Container)==null?void 0:s.querySelector('[data-action="chat-search-query"]');c&&(c.value=((i=e.ChatSearch)==null?void 0:i.Query)??"",c.focus(),(r=c.select)==null||r.call(c))}else if(!t&&this.ChatSearchDialogWasOpen){const c=this.ChatSearchRestoreFocusSelector?(o=this.Container)==null?void 0:o.querySelector(this.ChatSearchRestoreFocusSelector):null;(l=c==null?void 0:c.focus)==null||l.call(c),this.ChatSearchRestoreFocusSelector=null}this.ChatSearchDialogWasOpen=t}})},hr=a=>{Object.assign(a.prototype,{BuildChatBodyKey({ConversationId:e,Messages:t,MessageGroups:n,InternalMessagesEnabled:s}){const i=(t??[])[t.length-1]??null,r=[e??"",`${(t==null?void 0:t.length)??0}`,`${(n==null?void 0:n.length)??0}`,s?"1":"0",(i==null?void 0:i.Id)??"",(i==null?void 0:i.Status)??"",`${((i==null?void 0:i.Content)??"").length}`].join("|");if(!s)return r;const o=(n??[]).map(l=>`${l.Id}:${l.InternalVisible?"1":"0"}`).join(";");return`${r}|${o}`},UpdateHeaderElevation(){var n,s;const e=(n=this.Container)==null?void 0:n.querySelector("[data-header]"),t=(s=this.Dom)==null?void 0:s.ChatScroll;!e||!t||e.classList.toggle("header-elevated",t.scrollTop>0)},RenderValidationPopup(e){if(!(e!=null&&e.IsOpen))return"";const t=e.Status??"pending",n=t==="success"?"is-success":t==="failure"?"is-failure":"",s=t==="success"?"check_circle":t==="failure"?"error":"autorenew",i=t==="pending"?"provider-validation-spinner":"",r=e.Message??"",o=t==="pending"&&e.TotalModels&&e.CurrentIndex!=null,l=o?Math.round((e.CurrentIndex+1)/e.TotalModels*100):0;return`
        <div class="provider-validation-overlay">
          <div class="provider-validation-backdrop" data-action="close-provider-validation" aria-hidden="true"></div>
          <div class="provider-validation-dialog ${n}" role="dialog" aria-modal="true" aria-label="Provider validation">
            <div class="provider-validation-title">
              <span class="material-symbols-outlined ${i}">${s}</span>
              <span>Provider validation</span>
            </div>
            <div class="provider-validation-message">${r}</div>
            ${o?`
            <div class="provider-validation-progress">
              <div class="provider-validation-progress-bar" style="width: ${l}%;"></div>
            </div>
            <div class="provider-validation-current">Testing: ${e.CurrentModel??"..."}</div>
            `:""}
            <div class="provider-validation-actions">
              <button class="settings-primary-button" data-action="close-provider-validation" type="button">Close</button>
            </div>
          </div>
        </div>
      `},RenderRetryPopup(e,t){return e!=null&&e.IsOpen?`
        <div class="settings-overlay">
          <div class="settings-backdrop" data-action="close-retry-popup"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="Retry confirmation">
            <div class="settings-dialog-body">
              <div class="settings-form-title">${(t==null?void 0:t.RetryConfirmTitle)??"Use the newly selected model?"}</div>
              <div class="settings-dialog-message">
                ${(t==null?void 0:t.RetryConfirmMessage)??""}
              </div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="retry-use-original" type="button">
                ${(t==null?void 0:t.RetryConfirmNo)??"No"}
              </button>
              <button class="settings-primary-button" data-action="retry-use-selected" type="button">
                ${(t==null?void 0:t.RetryConfirmYes)??"Yes"}
              </button>
            </div>
          </div>
        </div>
      `:""},RenderPinDialog(e,t){if(!(e!=null&&e.IsOpen))return"";const n=(t==null?void 0:t.ChatSaving)??{},s=n.PinDialogTitle??"",i=n.PinDialogPlaceholder??"",r=n.PinDialogOk??"",o=n.PinDialogCancel??"",l=e.ErrorText??"";return`
        <div class="settings-overlay" data-chat-saving-dialog="pin">
          <div class="settings-backdrop" data-action="cancel-pin"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="${s}">
            <div class="settings-dialog-body">
              <div class="settings-form-title">${s}</div>
              <input class="settings-input" data-action="pin-name" type="text" placeholder="${i}" aria-label="${i}" />
              <div class="mt-2 text-sm font-medium text-red-600 ${l?"":"hidden"}" data-chat-saving-pin-error>${l}</div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="cancel-pin" type="button">
                ${o}
              </button>
              <button class="settings-primary-button" data-action="confirm-pin" type="button">
                ${r}
              </button>
            </div>
          </div>
        </div>
      `},RenderDiscardDialog(e,t){if(!(e!=null&&e.IsOpen))return"";const n=(t==null?void 0:t.ChatSaving)??{},s=n.DiscardPromptText??"",i=n.DiscardOk??"",r=n.DiscardCancel??"";return`
        <div class="settings-overlay" data-chat-saving-dialog="discard">
          <div class="settings-backdrop" data-action="cancel-discard"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="${s}">
            <div class="settings-dialog-body">
              <div class="settings-dialog-message" data-chat-saving-discard-message>${s}</div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="cancel-discard" type="button">
                ${r}
              </button>
              <button class="settings-primary-button" data-action="confirm-discard" type="button">
                ${i}
              </button>
            </div>
          </div>
        </div>
      `}})};class Ne{static IsJsDomEnvironment(){return typeof navigator>"u"||typeof navigator.userAgent!="string"?!1:navigator.userAgent.toLowerCase().includes("jsdom")}constructor(){this.SidebarView=new Ws,this.ModelSelectorView=new Qs,this.ChatThreadView=new nr,this.InputBarView=new sr,this.SettingsView=new or,this.ChatSearchView=new lr,this.Container=null,this.Dom=null,this.IsMounted=!1,this.Snackbar=null,this.TextMeasureCanvas=null,this.DisableCanvasTextMeasure=Ne.IsJsDomEnvironment(),this.CanvasTextMeasureFailed=!1,this.LastConversationId=null,this.LastScrollTop=null,this.ChatSavingDialogWasOpen=!1,this.ChatSavingRestoreFocusSelector=null,this.ChatSearchDialogWasOpen=!1,this.ChatSearchRestoreFocusSelector=null,this.LastSidebarHtml=null,this.LastModelSelectorHtml=null,this.LastHeaderActionsHtml=null,this.LastChatBodyKey=null,this.LastInputBarHtml=null,this.LastOverlaysHtml=null,this.LatestViewModel=null,this.LatestHandlers={},this.DocumentClickHandler=null,this.ScrollHandler=null,this.RetryKeyHandler=null,this.ChatSavingKeyHandler=null,this.ChatSearchKeyHandler=null}Render(e,t,n={}){e&&(this.LatestViewModel=t,this.LatestHandlers=n??{},this.EnsureMounted(e,t),this.Update(t))}EnsureMounted(e,t){var n,s;this.IsMounted||(this.Container=e,this.Container.innerHTML=`
      <div class="shell-root app-surface flex h-screen" data-shell data-collapsed="false">
        <div data-slot="sidebar"></div>
        <section class="main-pane flex min-w-0 flex-1 flex-col">
          <header class="app-header app-pad-x app-pad-top" data-header>
            <div class="flex w-full items-center gap-4">
              <div data-slot="model-selector"></div>
              <div class="ml-auto flex items-center gap-2" data-slot="header-actions"></div>
            </div>
          </header>
          <main class="relative flex min-h-0 flex-1 flex-col" data-slot="main">
            <div class="chat-scroll flex-1 overflow-y-auto app-pad-x app-pad-top" data-slot="chat-scroll">
              <div class="content-wrap" data-slot="chat-body"></div>
            </div>
            <div class="input-floating">
              <div class="content-wrap" data-slot="input-bar"></div>
            </div>
          </main>
        </section>
        <div data-slot="snackbar"></div>
      </div>
      <div data-slot="overlays"></div>
    `,this.Dom={Shell:this.Container.querySelector("[data-shell]"),SidebarHost:this.Container.querySelector('[data-slot="sidebar"]'),ModelSelectorHost:this.Container.querySelector('[data-slot="model-selector"]'),HeaderActionsHost:this.Container.querySelector('[data-slot="header-actions"]'),Main:this.Container.querySelector('[data-slot="main"]'),ChatScroll:this.Container.querySelector('[data-slot="chat-scroll"]'),ChatBodyHost:this.Container.querySelector('[data-slot="chat-body"]'),InputHost:this.Container.querySelector('[data-slot="input-bar"]'),SnackbarHost:this.Container.querySelector('[data-slot="snackbar"]'),OverlaysHost:this.Container.querySelector('[data-slot="overlays"]')},this.Snackbar=this.Snackbar??new ir({DurationMs:((n=t.Layout)==null?void 0:n.SnackbarDurationMs)??2400}),this.Dom.SnackbarHost.innerHTML=this.Snackbar.Render(),this.Snackbar.Mount(this.Container),this.Container.addEventListener("click",i=>this.HandleClick(i)),this.Container.addEventListener("input",i=>this.HandleInput(i)),this.Container.addEventListener("change",i=>this.HandleChange(i)),this.Container.addEventListener("keydown",i=>this.HandleKeydown(i)),this.DocumentClickHandler=i=>{var o;if(!((o=this.Container)!=null&&o.contains(i.target)))return;const r=i.target;r.closest("[data-model-menu]")||r.closest('[data-action="toggle-models"]')||r.closest("[data-attachments-menu]")||r.closest('[data-action="toggle-attachments"]')||r.closest("[data-settings-menu]")||r.closest('[data-action="toggle-settings-menu"]')||this.CloseMenus()},document.addEventListener("click",this.DocumentClickHandler),this.ScrollHandler=()=>{var i,r,o;this.UpdateHeaderElevation(),this.LastScrollTop=((i=this.Dom.ChatScroll)==null?void 0:i.scrollTop)??this.LastScrollTop,(o=(r=this.LatestHandlers)==null?void 0:r.onScrollConversation)==null||o.call(r,this.LastScrollTop)},(s=this.Dom.ChatScroll)==null||s.addEventListener("scroll",this.ScrollHandler),this.IsMounted=!0)}Update(e){var oe,ge,Le,xe,F,Pe,G,we,N,ae,Ce,ne,Ae,I,j,Re,ye,Ee,fe,Be;const t=((oe=this.Container.querySelector(".settings-content"))==null?void 0:oe.scrollTop)??0,n=((ge=this.Dom.ChatScroll)==null?void 0:ge.scrollTop)??this.LastScrollTop,s=this.LastConversationId??e.ActiveConversationId,i=this.IsChatPinnedToBottom(),r=(Le=this.Container)==null?void 0:Le.querySelector('[data-action="chat-input"]'),o=r&&document.activeElement===r,l=o?{Start:typeof r.selectionStart=="number"?r.selectionStart:null,End:typeof r.selectionEnd=="number"?r.selectionEnd:null}:null,c=((Pe=(F=(xe=e.Settings)==null?void 0:xe.Options)==null?void 0:F.Accents)==null?void 0:Pe.find(se=>se.Id===e.Settings.General.AccentColor))??((N=(we=(G=e.Settings)==null?void 0:G.Options)==null?void 0:we.Accents)==null?void 0:N[0]),u=(c==null?void 0:c.Hex)??"#10b981";this.Container.style.setProperty("--accent-color",u),document.documentElement.style.setProperty("--accent-color",u);const p=e.ActiveConversationId,g=((ae=e.Conversations)==null?void 0:ae.find(se=>se.Id===e.ActiveConversationId))??null,d=p?e.MessagesByConversation[p]??[]:[],f=p?((Ce=e.MessageGroupsByConversation)==null?void 0:Ce[p])??[]:[],m=p?this.ChatThreadView.RenderConversation({Messages:d,MessageGroups:f,Settings:e.Settings,Text:e.Text}):this.ChatThreadView.RenderWelcome({Text:e.Text}),S=this.SidebarView.Render(e),b=this.ModelSelectorView.Render(e),w=((ne=e.Text)==null?void 0:ne.ChatSaving)??{},M=g!=null&&g.IsPinned?w.UnpinActionLabel:w.PinActionLabel,x=M?`
        <button class="model-toggle flex items-center gap-2 text-sm font-semibold" data-action="toggle-pin" type="button" aria-label="${M}">
          <span>${M}</span>
          <span class="material-symbols-outlined">push_pin</span>
        </button>
      `:"",y=e.Settings?this.SettingsView.Render(e.Settings):"",k=this.RenderValidationPopup((I=(Ae=e.Settings)==null?void 0:Ae.Providers)==null?void 0:I.ValidationPopup),C=this.RenderRetryPopup(e.RetryPopup,e.Text),A=this.ChatSearchView.Render({ChatSearch:e.ChatSearch,Text:e.Text}),_=this.RenderPinDialog((j=e.ChatSaving)==null?void 0:j.PinDialog,e.Text),V=this.RenderDiscardDialog((Re=e.ChatSaving)==null?void 0:Re.DiscardDialog,e.Text),L=`${y}${k}${C}${A}${_}${V}`,B=[`--chat-bottom-padding: ${e.Layout.ChatBottomPadding};`,`--chat-input-line-height: ${e.Layout.InputLineHeightRem}rem;`,`--chat-input-max-height: ${e.Layout.InputMaxHeightRem}rem;`].join(" ");this.Dom.Shell.setAttribute("data-collapsed",e.IsSidebarCollapsed?"true":"false"),this.Dom.Main.style.cssText=B,S!==this.LastSidebarHtml&&(this.Dom.SidebarHost.innerHTML=S,this.LastSidebarHtml=S),b!==this.LastModelSelectorHtml&&(this.Dom.ModelSelectorHost.innerHTML=b,this.LastModelSelectorHtml=b),x!==this.LastHeaderActionsHtml&&(this.Dom.HeaderActionsHost.innerHTML=x,this.LastHeaderActionsHtml=x);const D=this.BuildChatBodyKey({ConversationId:p,Messages:d,MessageGroups:f,InternalMessagesEnabled:!!((Ee=(ye=e.Settings)==null?void 0:ye.Chat)!=null&&Ee.InternalChatMessages)});D!==this.LastChatBodyKey&&(this.Dom.ChatBodyHost.innerHTML=m,this.LastChatBodyKey=D);const Q=this.InputBarView.Render(e);if(Q!==this.LastInputBarHtml){this.Dom.InputHost.innerHTML=Q,this.LastInputBarHtml=Q,this.SetupChatInputSizing();const se=(fe=this.Container)==null?void 0:fe.querySelector('[data-action="chat-input"]');se&&o&&(se.focus(),typeof se.setSelectionRange=="function"&&(l==null?void 0:l.Start)!=null&&se.setSelectionRange(l.Start,l.End??l.Start))}this.SyncChatInput(e);const $=this.CaptureChatSearchEditingState();L!==this.LastOverlaysHtml&&(this.Dom.OverlaysHost.innerHTML=L,this.LastOverlaysHtml=L,this.RestoreChatSearchEditingState($,e));const pe=this.Container.querySelector(".settings-content");pe&&t>0&&(pe.scrollTop=t),this.Dom.ChatScroll&&(s===e.ActiveConversationId&&n!=null?i?this.Dom.ChatScroll.scrollTop=this.Dom.ChatScroll.scrollHeight:this.Dom.ChatScroll.scrollTop=n:(g==null?void 0:g.ScrollPosition)!=null?this.Dom.ChatScroll.scrollTop=g.ScrollPosition:this.Dom.ChatScroll.scrollTop=0),this.LastConversationId=e.ActiveConversationId,this.LastScrollTop=((Be=this.Dom.ChatScroll)==null?void 0:Be.scrollTop)??this.LastScrollTop,this.Snackbar.DurationMs=e.Layout.SnackbarDurationMs,this.UpdateHeaderElevation(),this.UpdateModalKeyHandlers(e),this.UpdateChatSavingFocus(e),this.UpdateChatSearchFocus(e)}IsChatPinnedToBottom(){var n;const e=(n=this.Dom)==null?void 0:n.ChatScroll;return e?e.scrollHeight-(e.scrollTop+e.clientHeight)<=8:!1}}cr(Ne);ur(Ne);dr(Ne);hr(Ne);const pr="2025-12-31",gr=[{Id:"openai",Name:"OpenAI",Icon:"assets/icons/provider_openai.svg",ApiConventions:{PrimaryEndpoint:"responses",Endpoints:{responses:{MaxOutputTokensParam:"max_output_tokens"},chat:{MaxOutputTokensParam:"max_tokens"},completions:{MaxOutputTokensParam:"max_tokens"}},Streaming:{DefaultSchema:"openai.responses.v1"},Reasoning:{EffortParam:"reasoning.effort",EffortLevelsCommon:["low","medium","high","xhigh"],Notes:["Some models have configurable effort; some are fixed."]}},Models:[{Id:"gpt-5.2",Label:"GPT-5.2",Description:"Latest flagship general model. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5.2-pro",Label:"GPT-5.2 Pro",Description:"Highest capability GPT-5.2 tier. Responses API only.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["medium","high","xhigh"]}}}},{Id:"gpt-5.1",Label:"GPT-5.1",Description:"Flagship general model (previous generation). Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5",Label:"GPT-5",Description:"Flagship general model. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5-pro",Label:"GPT-5 Pro",Description:"Higher capability tier within GPT-5 family. Responses API only. Reasoning effort fixed to high.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit",ParamPath:"reasoning.effort",Allowed:["high"]}}}},{Id:"gpt-5-mini",Label:"GPT-5 Mini",Description:"Lower-latency, cost-efficient GPT-5 family model. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high"]}}}},{Id:"gpt-5-nano",Label:"GPT-5 Nano",Description:"Smallest/fastest GPT-5 family option. Responses API default.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high"]}}}},{Id:"gpt-5.1-codex",Label:"GPT-5.1 Codex",Description:"GPT-5.1 optimized for agentic coding (Responses API).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"gpt-5.1-codex-max",Label:"GPT-5.1 Codex Max",Description:"Largest Codex variant for demanding coding agents (Responses API).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["medium","high","xhigh"]}}}},{Id:"gpt-5-codex",Label:"GPT-5 Codex",Description:"GPT-5 coding-optimized model family (Codex, Responses API).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"effort_enum",ParamPath:"reasoning.effort",Allowed:["low","medium","high","xhigh"]}}}},{Id:"o3-deep-research",Label:"o3 Deep Research",Description:"Deep research optimized reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o4-mini-deep-research",Label:"o4-mini Deep Research",Description:"Deep research optimized, smaller/faster reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o3-pro",Label:"o3 Pro",Description:"Higher-tier o3 reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o3",Label:"o3",Description:"General high-capability reasoning model (with snapshots available).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o3-mini",Label:"o3 Mini",Description:"Faster/lower-cost reasoning model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o1",Label:"o1",Description:"Reasoning model (earlier o-series).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"o4-mini",Label:"o4-mini",Description:"Small reasoning model balancing speed and capability.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"},Reasoning:{Control:{Type:"implicit"}}}},{Id:"gpt-4.1",Label:"GPT-4.1",Description:"High-quality general model (non-reasoning-first).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4.1-mini",Label:"GPT-4.1 Mini",Description:"Smaller GPT-4.1 variant for lower latency/cost.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4.1-nano",Label:"GPT-4.1 Nano",Description:"Smallest GPT-4.1 variant.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o",Label:"GPT-4o",Description:"Omni multimodal model for text+vision.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o-mini",Label:"GPT-4o Mini",Description:"Lower-cost GPT-4o family model.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o-search-preview",Label:"GPT-4o Search Preview",Description:"Web search specialized (tool-call priced).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}},{Id:"gpt-4o-mini-search-preview",Label:"GPT-4o Mini Search Preview",Description:"Cheaper web search specialized model (with snapshots).",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens",Streaming:{EventSchema:"openai.responses.v1"}}}]},{Id:"anthropic",Name:"Anthropic",Icon:"assets/icons/provider_anthropic.svg",ApiConventions:{PrimaryEndpoint:"messages",Endpoints:{messages:{MaxOutputTokensParam:"max_tokens"}},Streaming:{DefaultSchema:"anthropic.messages.v1"},Reasoning:{ExtendedThinkingParamPath:"thinking",EnableShape:{type:"enabled",budget_tokens:"number"},BudgetParam:"budget_tokens"}},Models:[{Id:"claude-sonnet-4-5",Label:"Claude Sonnet 4.5 (alias)",Description:"Alias to latest Sonnet 4.5 snapshot.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"token_budget",ParamPath:"thinking.budget_tokens",Range:{Min:0,Max:64e3}},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0,ReturnsSummary:!0}}}},{Id:"claude-haiku-4-5",Label:"Claude Haiku 4.5 (alias)",Description:"Alias to latest Haiku 4.5 snapshot.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"token_budget",ParamPath:"thinking.budget_tokens",Range:{Min:0,Max:64e3}},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0,ReturnsSummary:!0}}}},{Id:"claude-opus-4-5",Label:"Claude Opus 4.5 (alias)",Description:"Alias to latest Opus 4.5 snapshot.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"token_budget",ParamPath:"thinking.budget_tokens",Range:{Min:0,Max:64e3}},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0,ReturnsSummary:!0}}}},{Id:"claude-sonnet-4-5-20250929",Label:"Claude Sonnet 4.5 (2025-09-29)",Description:"Pinned Sonnet 4.5 snapshot.",Enabled:!0},{Id:"claude-haiku-4-5-20251001",Label:"Claude Haiku 4.5 (2025-10-01)",Description:"Pinned Haiku 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-5-20251101",Label:"Claude Opus 4.5 (2025-11-01)",Description:"Pinned Opus 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-1",Label:"Claude Opus 4.1 (alias)",Description:"Alias to latest Opus 4.1 snapshot.",Enabled:!0},{Id:"claude-opus-4-1-20250805",Label:"Claude Opus 4.1 (2025-08-05)",Description:"Pinned Opus 4.1 snapshot.",Enabled:!0},{Id:"claude-opus-4",Label:"Claude Opus 4 (alias)",Description:"Alias to latest Opus 4 snapshot.",Enabled:!0},{Id:"claude-opus-4-20250514",Label:"Claude Opus 4 (2025-05-14)",Description:"Pinned Opus 4 snapshot.",Enabled:!0},{Id:"claude-sonnet-4",Label:"Claude Sonnet 4 (alias)",Description:"Alias to latest Sonnet 4 snapshot.",Enabled:!0},{Id:"claude-sonnet-4-20250514",Label:"Claude Sonnet 4 (2025-05-14)",Description:"Pinned Sonnet 4 snapshot.",Enabled:!0},{Id:"claude-3-haiku-20240307",Label:"Claude 3 Haiku (2024-03-07)",Description:"Active smaller Claude 3 model.",Enabled:!0},{Id:"claude-3-opus-20240229",Label:"Claude 3 Opus (2024-02-29)",Description:"Deprecated (available to existing users) â€” retirement Jan 5, 2026 per Anthropic.",Enabled:!0},{Id:"claude-3-5-haiku-20241022",Label:"Claude 3.5 Haiku (2024-10-22)",Description:"Deprecated (available to existing users) â€” retirement Feb 19, 2026 per Anthropic.",Enabled:!0},{Id:"claude-3-7-sonnet-20250219",Label:"Claude 3.7 Sonnet (2025-02-19)",Description:"Deprecated (available to existing users) â€” retirement Feb 19, 2026 per Anthropic.",Enabled:!0}]},{Id:"google",Name:"Google",Icon:"assets/icons/provider_google.svg",ApiConventions:{PrimaryEndpoint:"gemini_api",Endpoints:{gemini_api:{MaxOutputTokensParam:"generationConfig.maxOutputTokens"}},Streaming:{DefaultSchema:"google.gemini.v1"},Reasoning:{Notes:["Gemini 3 preview model cards list thinking support; request shape may vary by SDK/version."]}},Models:[{Id:"gemini-3-pro-preview",Label:"Gemini 3 Pro (Preview)",Description:"Most capable Gemini 3 preview model code.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"toggle",ParamPath:"thinking",Allowed:["on","off"]},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0}}}},{Id:"gemini-3-flash-preview",Label:"Gemini 3 Flash (Preview)",Description:"Gemini 3 speed-optimized preview model code.",Enabled:!0,Capabilities:{Reasoning:{Signals:!0,Control:{Type:"toggle",ParamPath:"thinking",Allowed:["on","off"]},Accounting:{HasReasoningTokens:!0,BilledSeparately:!0}}}},{Id:"gemini-2.5-flash",Label:"Gemini 2.5 Flash",Description:"Stable Gemini 2.5 Flash model code.",Enabled:!0},{Id:"gemini-2.5-flash-lite",Label:"Gemini 2.5 Flash-Lite",Description:"Ultra fast/cost-efficient Gemini 2.5 Flash-Lite model code.",Enabled:!0}]},{Id:"grok",Name:"Grok",Icon:"assets/icons/provider_grok.svg",ApiConventions:{PrimaryEndpoint:"chat_completions",Streaming:{DefaultSchema:"grok.chat_completions.v1"},Reasoning:{Notes:["Grok 4 reasoning models do not accept reasoning_effort; some parameters may be rejected."]}},Models:[{Id:"grok-4",Label:"Grok 4",Description:"Frontier Grok model family.",Enabled:!0,Capabilities:{Reasoning:{Control:{Type:"implicit"}},RequestConstraints:{DisallowedParamsWhenReasoning:["presence_penalty","frequency_penalty","stop","reasoning_effort"]}}},{Id:"grok-4-0709",Label:"Grok 4 (0709)",Description:"Pinned Grok 4 snapshot ID (as documented by xAI).",Enabled:!0},{Id:"grok-4-fast",Label:"Grok 4 Fast",Description:"Lower-latency Grok 4 variant.",Enabled:!0},{Id:"grok-4-1-fast",Label:"Grok 4.1 Fast",Description:"Fast Grok 4.1 variant.",Enabled:!0},{Id:"grok-4-1-fast-reasoning",Label:"Grok 4.1 Fast Reasoning",Description:"Fast reasoning-oriented Grok 4.1 variant.",Enabled:!0},{Id:"grok-3-fast",Label:"Grok 3 Fast",Description:"Lower-latency Grok 3 variant.",Enabled:!0},{Id:"grok-3-mini",Label:"Grok 3 Mini",Description:"Smaller Grok 3 variant for cost/latency.",Enabled:!0},{Id:"grok-3-mini-fast",Label:"Grok 3 Mini Fast",Description:"Fastest Grok 3 mini variant.",Enabled:!0},{Id:"grok-code-fast-1",Label:"Grok Code Fast 1",Description:"Coding-optimized Grok model ID.",Enabled:!0},{Id:"grok-2-1212",Label:"Grok 2 (1212)",Description:"Pinned Grok 2 model snapshot ID.",Enabled:!0}]}],Vn={SchemaVersion:pr,Providers:gr};class fr{constructor({Fetch:e,Logger:t,EnvironmentName:n}){this.Fetch=e,this.Logger=t,this.EnvironmentName=n}async LoadAsync(){const e=await this.FetchOverrideAsync();return e?this.MergeCatalogs(Vn,e):Vn}async FetchOverrideAsync(){var t,n;const e=`config/providers.catalog.${this.EnvironmentName}.json`;try{const s=await this.Fetch(e);return s.ok?await s.json():null}catch(s){return(n=(t=this.Logger)==null?void 0:t.LogWarning)==null||n.call(t,"ProviderCatalog.Override.Missing",{Path:e,Error:(s==null?void 0:s.message)??"Unknown error"}),null}}MergeCatalogs(e,t){const n=(e==null?void 0:e.Providers)??[],s=(t==null?void 0:t.Providers)??[],i=new Map(s.map(l=>[l.Id,l])),r=n.map(l=>{const c=i.get(l.Id);return c?{...l,...c,Models:this.MergeModels(l.Models??[],c.Models??[])}:l}),o=s.filter(l=>!n.some(c=>c.Id===l.Id));return{Providers:[...r,...o]}}MergeModels(e,t){if(t.length===0)return e;const n=new Map(t.map(r=>[r.Id,r])),s=e.map(r=>({...r,...n.get(r.Id)??{}})),i=t.filter(r=>!e.some(o=>o.Id===r.Id));return[...s,...i]}}class mr{constructor({Catalog:e}){this.Catalog=e}async LoadCatalogAsync(){return await this.Catalog.LoadAsync()}}class Sr{constructor({Providers:e}){this.Providers=new Map((e??[]).map(t=>[t.Id,t]))}GetProvider(e){const t=this.Providers.get(e);if(!t)throw new Error(`Provider not registered: ${e}`);return t}async ListModelIds(e,t){return await this.GetProvider(e).ListModelIds({Key:t})}async ValidateKey(e,t){return await this.GetProvider(e).ValidateKey(t)}}class vr{constructor({Fetch:e,BaseUrl:t="https://api.openai.com/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="openai",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??[]).map(n=>n==null?void 0:n.id).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{Authorization:`Bearer ${e}`}}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s,MaxOutputTokens:i,ModelConfig:r}){const o=(r==null?void 0:r.Endpoint)??"chat",l=(r==null?void 0:r.MaxTokensParam)??"max_tokens",c=o==="responses"?{model:t,input:this.MapMessages(n??[]),stream:!!s}:o==="completions"?{model:t,prompt:this.MapMessagesToPrompt(n??[]),stream:!!s}:{model:t,messages:this.MapMessages(n??[]),stream:!!s};s&&o==="chat"&&(c.stream_options={include_usage:!0}),i!=null&&(c[l]=i);const u=o==="responses"?"/responses":o==="completions"?"/completions":"/chat/completions";return{Url:`${this.BaseUrl}${u}`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:c}}ParseChatResponse(e){var c,u,p,g,d;const t=(e==null?void 0:e.usage)??{},n=t.input_tokens??t.prompt_tokens??null,s=t.output_tokens??t.completion_tokens??null,i={InputTokens:n??null,OutputTokens:s??null};if(e!=null&&e.output_text)return{Content:e.output_text,Usage:i};const o=((e==null?void 0:e.output)??[]).flatMap(f=>(f==null?void 0:f.content)??[]).map(f=>(f==null?void 0:f.text)??"").join("");if(o)return{Content:o,Usage:i};const l=(u=(c=e==null?void 0:e.choices)==null?void 0:c[0])==null?void 0:u.text;return l?{Content:l,Usage:i}:{Content:((d=(g=(p=e==null?void 0:e.choices)==null?void 0:p[0])==null?void 0:g.message)==null?void 0:d.content)??"",Usage:i}}ParseStreamEvent(e){var r,o,l,c,u,p,g,d;if(!e)return{Content:"",IsDone:!1};if(e==="[DONE]")return{Content:"",IsDone:!0};const t=(l=(o=(r=e==null?void 0:e.choices)==null?void 0:r[0])==null?void 0:o.delta)==null?void 0:l.content,n=(p=(u=(c=e==null?void 0:e.choices)==null?void 0:c[0])==null?void 0:u.delta)==null?void 0:p.reasoning,s=(d=(g=e==null?void 0:e.choices)==null?void 0:g[0])==null?void 0:d.text,i=e!=null&&e.usage?{InputTokens:e.usage.input_tokens??e.usage.prompt_tokens??null,OutputTokens:e.usage.output_tokens??e.usage.completion_tokens??null}:null;return{Content:t??s??"",InternalContent:n??null,Classification:n?"reasoning":null,IsDone:!1,Usage:i}}MapMessages(e){return e.map(t=>({role:(t.Role??"user").toLowerCase(),content:t.Content??""}))}MapMessagesToPrompt(e){return(e??[]).map(t=>{const n=(t.Role??"user").toLowerCase();return`${n==="assistant"?"Assistant":n==="system"?"System":"User"}: ${t.Content??""}`}).join(`

`)}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"OpenAI validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}class br{constructor({Fetch:e,BaseUrl:t="https://api.anthropic.com/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="anthropic",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??(t==null?void 0:t.models)??[]).map(n=>(n==null?void 0:n.id)??(n==null?void 0:n.name)).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{"x-api-key":e,"anthropic-version":"2023-06-01"}}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s,MaxOutputTokens:i}){const r=this.MapMessages(n??[]),o={model:t,messages:r.Messages,stream:!!s};return i!=null&&(o.max_tokens=i),r.System&&(o.system=r.System),{Url:`${this.BaseUrl}/messages`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:o}}ParseChatResponse(e){const t=(e==null?void 0:e.content)??[],n=(e==null?void 0:e.usage)??{};return{Content:t.map(s=>(s==null?void 0:s.text)??"").join(""),Usage:{InputTokens:n.input_tokens??null,OutputTokens:n.output_tokens??null}}}ParseStreamEvent(e){var t,n;if(!e)return{Content:"",IsDone:!1};if(e.type==="message_stop")return{Content:"",IsDone:!0};if(e.type==="content_block_delta"){const s=((t=e==null?void 0:e.delta)==null?void 0:t.text)??"",i=((n=e==null?void 0:e.delta)==null?void 0:n.thinking)??"";return i?{Content:"",InternalContent:i,Classification:"reasoning",IsDone:!1}:{Content:s,IsDone:!1}}return{Content:"",IsDone:!1}}MapMessages(e){const t=[],n=[];return e.forEach(s=>{const i=(s.Role??"").toLowerCase(),r=(s.Classification??s.Kind??"").toString().toLowerCase(),o=s.IsInternal===!0||r==="internal"||r==="reasoning"||r==="system-internal";if(i==="system"||i==="tool"||o){t.push(s.Content??"");return}if(i==="assistant"){n.push({role:"assistant",content:s.Content??""});return}n.push({role:"user",content:s.Content??""})}),{System:t.filter(Boolean).join(`

`),Messages:n}}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"Anthropic validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}class Cr{constructor({Fetch:e,BaseUrl:t="https://generativelanguage.googleapis.com/v1beta"}){this.Fetch=e,this.BaseUrl=t,this.Id="google",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models?key=${encodeURIComponent(e)}`);if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.models)??[]).map(n=>n==null?void 0:n.name).filter(Boolean).map(n=>n.replace(/^models\//,""))}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s}){const i=this.MapMessages(n??[]),r=t.startsWith("models/")?t:`models/${t}`,o=s?`${this.BaseUrl}/${r}:streamGenerateContent?key=${encodeURIComponent(e)}&alt=sse`:`${this.BaseUrl}/${r}:generateContent?key=${encodeURIComponent(e)}`,l={contents:i.Messages};return i.System&&(l.systemInstruction={parts:[{text:i.System}]}),{Url:o,Headers:{"Content-Type":"application/json"},Body:l}}ParseChatResponse(e){var s,i,r;const t=((r=(i=(s=e==null?void 0:e.candidates)==null?void 0:s[0])==null?void 0:i.content)==null?void 0:r.parts)??[],n=(e==null?void 0:e.usageMetadata)??{};return{Content:t.map(o=>(o==null?void 0:o.text)??"").join(""),Usage:{InputTokens:n.promptTokenCount??null,OutputTokens:n.candidatesTokenCount??null}}}ParseStreamEvent(e){var i,r,o;if(!e)return{Content:"",IsDone:!1};if(e==="[DONE]")return{Content:"",IsDone:!0};const t=((o=(r=(i=e==null?void 0:e.candidates)==null?void 0:i[0])==null?void 0:r.content)==null?void 0:o.parts)??[],n=t.map(l=>(l==null?void 0:l.text)??"").join(""),s=t.map(l=>(l==null?void 0:l.thought)??(l==null?void 0:l.reasoning)??"").join("");return{Content:n,InternalContent:s||null,Classification:s?"reasoning":null,IsDone:!1}}MapMessages(e){const t=[],n=[];return e.forEach(s=>{const i=(s.Role??"").toLowerCase(),r=(s.Classification??s.Kind??"").toString().toLowerCase(),o=s.IsInternal===!0||r==="internal"||r==="reasoning"||r==="system-internal";if(i==="system"||i==="tool"||o){t.push(s.Content??"");return}const l=i==="assistant"?"model":"user";n.push({role:l,parts:[{text:s.Content??""}]})}),{System:t.filter(Boolean).join(`

`),Messages:n}}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"Google validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}class yr{constructor({Fetch:e,BaseUrl:t="https://api.x.ai/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="grok",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??[]).map(n=>n==null?void 0:n.id).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{Authorization:`Bearer ${e}`}}BuildChatRequest({Key:e,ModelId:t,Messages:n,Stream:s,MaxOutputTokens:i}){const r={model:t,messages:this.MapMessages(n??[]),stream:!!s};return i&&(r.max_tokens=i),{Url:`${this.BaseUrl}/chat/completions`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:r}}ParseChatResponse(e){var n,s,i;const t=(e==null?void 0:e.usage)??{};return{Content:((i=(s=(n=e==null?void 0:e.choices)==null?void 0:n[0])==null?void 0:s.message)==null?void 0:i.content)??"",Usage:{InputTokens:t.prompt_tokens??null,OutputTokens:t.completion_tokens??null}}}ParseStreamEvent(e){var n,s,i;return e?e==="[DONE]"?{Content:"",IsDone:!0}:{Content:((i=(s=(n=e==null?void 0:e.choices)==null?void 0:n[0])==null?void 0:s.delta)==null?void 0:i.content)??"",IsDone:!1}:{Content:"",IsDone:!1}}MapMessages(e){return e.map(t=>({role:(t.Role??"user").toLowerCase(),content:t.Content??""}))}async BuildError(e){const t=await this.TryReadMessage(e),n=new Error(t??"Grok validation failed.");return n.Status=e.status,n}async TryReadMessage(e){var t;try{const n=await e.json();return((t=n==null?void 0:n.error)==null?void 0:t.message)??(n==null?void 0:n.message)}catch{return null}}}const be=Object.freeze({MissingKey:"MissingKey",Unauthorized:"Unauthorized",Forbidden:"Forbidden",RateLimited:"RateLimited",ServiceUnavailable:"ServiceUnavailable",NetworkError:"NetworkError",Unknown:"Unknown"});class jn{static BuildError({Code:e,Message:t,Status:n}){const s=new Error(t);return s.Code=e,s.Status=n,s}static Normalize(e){if(!e)return{Code:be.Unknown,Message:"Validation failed. Please try again."};if(e.Code===be.MissingKey)return{Code:be.MissingKey,Message:"API key required before testing."};if(e.Code&&e.Message)return{Code:e.Code,Message:e.Message};const t=e.Status??e.status;return t===401?{Code:be.Unauthorized,Message:"API key rejected. Check the key and try again."}:t===403?{Code:be.Forbidden,Message:"Access denied for this API key."}:t===429?{Code:be.RateLimited,Message:"Provider is rate limiting requests. Try again shortly."}:t>=500?{Code:be.ServiceUnavailable,Message:"Provider service is unavailable. Try again later."}:e.name==="TypeError"?{Code:be.NetworkError,Message:"Network error while contacting provider."}:{Code:be.Unknown,Message:"Validation failed. Please try again."}}}class kr{constructor({ProviderRegistry:e,ProviderLogger:t}){this.ProviderRegistry=e,this.ProviderLogger=t}async ValidateAsync(e,t){var n,s,i,r;if(!t)return{Status:"failure",Message:jn.BuildError({Code:be.MissingKey,Message:"API key required before testing."}).message};(n=this.ProviderLogger)==null||n.LogValidationStart(e);try{const l={Status:"success",Message:"API key validated successfully.",ModelIds:await this.ProviderRegistry.ListModelIds(e,t)};return(s=this.ProviderLogger)==null||s.LogValidationEnd(e,l),l}catch(o){(i=this.ProviderLogger)==null||i.LogValidationFailure(e,o);const c={Status:"failure",Message:jn.Normalize(o).Message};return(r=this.ProviderLogger)==null||r.LogValidationEnd(e,c),c}}}class Ir{constructor({Logger:e}){this.Logger=e}LogValidationStart(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||n.call(t,"Providers.Validate",{ProviderId:e})}LogValidationEnd(e,t){var n,s;(s=(n=this.Logger)==null?void 0:n.LogFlowEnd)==null||s.call(n,"Providers.Validate",{ProviderId:e,Result:t})}LogValidationFailure(e,t){var n,s;(s=(n=this.Logger)==null?void 0:n.LogWarning)==null||s.call(n,"Providers.Validate.Failed",{ProviderId:e,Error:(t==null?void 0:t.message)??"Unknown error"})}}class Tr{constructor({Providers:e}={}){this.Providers=new Map((e??[]).map(t=>[t.Id,t]))}GetProvider(e){const t=this.Providers.get(e);if(!t)throw new Error(`Chat provider not registered: ${e}`);return t}}class Mr{BuildContext({Messages:e}){return[...e??[]].sort((n,s)=>n.CreatedUtc===s.CreatedUtc?0:n.CreatedUtc<s.CreatedUtc?-1:1).map(n=>({Role:n.Role,Content:n.Content,Kind:n.Kind,Classification:n.Classification,IsInternal:n.IsInternal}))}}const st=Object.freeze({OpenAiChatV1:"openai.chat.v1",OpenAiResponsesV1:"openai.responses.v1",AnthropicMessagesV1:"anthropic.messages.v1",GoogleGeminiV1:"google.gemini.v1",GrokChatCompletionsV1:"grok.chat_completions.v1"}),z=Object.freeze({ContentDelta:"content.delta",ReasoningDelta:"reasoning.delta",ReasoningSummaryDelta:"reasoning.summary.delta",ToolCallDelta:"tool.call.delta",ToolResultDelta:"tool.result.delta",StreamDone:"stream.done"}),xr=({Provider:a,Model:e}={})=>{var t,n,s,i;return((n=(t=e==null?void 0:e.Capabilities)==null?void 0:t.Streaming)==null?void 0:n.EventSchema)??((i=(s=a==null?void 0:a.ApiConventions)==null?void 0:s.Streaming)==null?void 0:i.DefaultSchema)??null},Pr=a=>a!=null&&a.usage?{InputTokens:a.usage.input_tokens??a.usage.prompt_tokens??null,OutputTokens:a.usage.output_tokens??a.usage.completion_tokens??null}:null,Wn=a=>{var t;const e=(a==null?void 0:a.usage)??((t=a==null?void 0:a.response)==null?void 0:t.usage)??null;return e?{InputTokens:e.input_tokens??null,OutputTokens:e.output_tokens??null}:null},wr=a=>a!=null&&a.usage?{InputTokens:a.usage.input_tokens??null,OutputTokens:a.usage.output_tokens??null}:null,Ar=a=>{const e=(a==null?void 0:a.usageMetadata)??null;return e?{InputTokens:e.promptTokenCount??null,OutputTokens:e.candidatesTokenCount??null}:null},Qn=a=>{var r,o,l,c,u,p,g,d;if(!a)return[];if(a==="[DONE]")return[{Type:z.StreamDone}];const e=(l=(o=(r=a==null?void 0:a.choices)==null?void 0:r[0])==null?void 0:o.delta)==null?void 0:l.content,t=(p=(u=(c=a==null?void 0:a.choices)==null?void 0:c[0])==null?void 0:u.delta)==null?void 0:p.reasoning,n=(d=(g=a==null?void 0:a.choices)==null?void 0:g[0])==null?void 0:d.text,s=Pr(a),i=[];return t&&i.push({Type:z.ReasoningDelta,Content:t,Classification:"reasoning"}),(e??n)&&i.push({Type:z.ContentDelta,Content:e??n??""}),s&&i.push({Type:z.StreamDone,Usage:s}),i},Rr=(a,e)=>{if(!e&&!a)return[];if(e==="[DONE]")return[{Type:z.StreamDone}];const t=[],n=(a??"").toLowerCase();if(n==="response.output_text.delta"){const i=(e==null?void 0:e.delta)??(e==null?void 0:e.text)??"";i&&t.push({Type:z.ContentDelta,Content:i})}else if(n==="response.reasoning_text.delta"){const i=(e==null?void 0:e.delta)??(e==null?void 0:e.text)??"";i&&t.push({Type:z.ReasoningDelta,Content:i,Classification:"reasoning"})}else if(n==="response.reasoning_summary_text.delta"){const i=(e==null?void 0:e.delta)??(e==null?void 0:e.text)??"";i&&t.push({Type:z.ReasoningSummaryDelta,Content:i,Classification:"reasoning"})}else(n==="response.completed"||n==="response.done")&&t.push({Type:z.StreamDone,Usage:Wn(e)});const s=Wn(e);return s&&t.length===0&&t.push({Type:z.StreamDone,Usage:s}),t},Lr=a=>{var t,n;if(!a)return[];const e=[];if(a.type==="message_stop")return e.push({Type:z.StreamDone,Usage:wr(a)}),e;if(a.type==="content_block_delta"){const s=((t=a==null?void 0:a.delta)==null?void 0:t.text)??"",i=((n=a==null?void 0:a.delta)==null?void 0:n.thinking)??"";i&&e.push({Type:z.ReasoningDelta,Content:i,Classification:"reasoning"}),s&&e.push({Type:z.ContentDelta,Content:s})}return e},Er=a=>{var r,o,l;if(!a)return[];if(a==="[DONE]")return[{Type:z.StreamDone}];const e=((l=(o=(r=a==null?void 0:a.candidates)==null?void 0:r[0])==null?void 0:o.content)==null?void 0:l.parts)??[],t=e.map(c=>(c==null?void 0:c.text)??"").join(""),n=e.map(c=>(c==null?void 0:c.thought)??(c==null?void 0:c.reasoning)??"").join(""),s=[];n&&s.push({Type:z.ReasoningDelta,Content:n,Classification:"reasoning"}),t&&s.push({Type:z.ContentDelta,Content:t});const i=Ar(a);return i&&s.push({Type:z.StreamDone,Usage:i}),s},Dr=a=>{var t,n,s;if(!a)return[];if(a==="[DONE]")return[{Type:z.StreamDone}];const e=(s=(n=(t=a==null?void 0:a.choices)==null?void 0:t[0])==null?void 0:n.delta)==null?void 0:s.content;return e?[{Type:z.ContentDelta,Content:e}]:[]},_r=({Schema:a,EventName:e,Data:t})=>{switch(a){case st.OpenAiChatV1:return Qn(t);case st.OpenAiResponsesV1:return Rr(e,t);case st.AnthropicMessagesV1:return Lr(t);case st.GoogleGeminiV1:return Er(t);case st.GrokChatCompletionsV1:return Dr(t);default:return Qn(t)}};class Or{constructor({ChatRegistry:e,ContextBuilder:t,ChatLogger:n,Configuration:s,Fetch:i}){this.ChatRegistry=e,this.ContextBuilder=t,this.ChatLogger=n,this.Configuration=s,this.Fetch=i??((...r)=>globalThis.fetch(...r))}async SendAsync({ProviderId:e,ModelId:t,Key:n,Messages:s,Stream:i,OnToken:r,OnStreamStart:o,OnEvent:l,ModelConfig:c,Signal:u}){var x,y,k,C,A,_,V,L,B,D,Q;const p=this.ChatRegistry.GetProvider(e),g=this.ContextBuilder.BuildContext({Messages:s,ProviderId:e,ModelId:t}),d=this.ResolveRequestSettings(e),f=((x=c==null?void 0:c.Streaming)==null?void 0:x.Supported)??!0,m=Date.now(),S=p.BuildChatRequest({Key:n,ModelId:t,Messages:g,Stream:i&&p.SupportsStreaming&&f,MaxOutputTokens:d.MaxOutputTokens,ModelConfig:c}),b=this.ApplyReasoningSettings(S,c);b&&((k=(y=this.ChatLogger)==null?void 0:y.LogReasoningApplied)==null||k.call(y,{ProviderId:e,ModelId:t,...b}));const w=i&&p.SupportsStreaming&&f,M={ProviderId:e,ModelId:t,Stream:w};(A=(C=this.ChatLogger)==null?void 0:C.LogSendStart)==null||A.call(C,M);try{if(w){const oe=await this.StreamResponse(p,S,d,r,o,l,c==null?void 0:c.StreamSchema,u),ge=this.BuildMetrics(oe,m);return(V=(_=this.ChatLogger)==null?void 0:_.LogSendEnd)==null||V.call(_,{...M,Length:oe.Content.length}),{Content:oe.Content,IsStreamed:!0,Metrics:ge}}const $=await this.FetchResponse(p,S,d,u),pe=this.BuildMetrics($,m);return(B=(L=this.ChatLogger)==null?void 0:L.LogSendEnd)==null||B.call(L,{...M,Length:$.Content.length}),{Content:$.Content,IsStreamed:!1,Metrics:pe}}catch($){if(((u==null?void 0:u.aborted)&&($==null?void 0:$.name)==="AbortError"||($==null?void 0:$.name)==="AbortError")&&!($!=null&&$.Metrics))try{$.Metrics=this.BuildMetrics({Usage:($==null?void 0:$.Usage)??null},m)}catch{}throw(Q=(D=this.ChatLogger)==null?void 0:D.LogSendFailure)==null||Q.call(D,{...M,Error:($==null?void 0:$.message)??"Unknown error"}),$}}BuildAbortError(){if(typeof DOMException<"u")return new DOMException("Aborted","AbortError");const e=new Error("Aborted");return e.name="AbortError",e}ResolveRequestSettings(e){var i,r,o;const t=((i=this.Configuration)==null?void 0:i[Oe.Chat])??{},n=t[Rn.Requests]??{},s=((o=(r=t[Rn.ProviderOverrides])==null?void 0:r[e])==null?void 0:o.Requests)??{};return{TimeoutMs:s[qe.TimeoutMs]??n[qe.TimeoutMs],MaxRetries:0,BackoffMs:s[qe.BackoffMs]??n[qe.BackoffMs],MaxOutputTokens:s[qe.MaxOutputTokens]??n[qe.MaxOutputTokens]}}async FetchResponse(e,t,n,s){let i=null;try{const r=s?new Promise((p,g)=>{if(s.aborted){g(this.BuildAbortError());return}const d=()=>g(this.BuildAbortError());typeof s.addEventListener=="function"?(s.addEventListener("abort",d,{once:!0}),i=()=>s.removeEventListener("abort",d)):(s.onabort=d,i=()=>{s.onabort===d&&(s.onabort=null)})}):null,o=this.FetchWithTimeout(t,n.TimeoutMs,s),l=await(r?Promise.race([o,r]):o);if(!l.ok)throw await e.BuildError(l);const c=await l.json(),u=e.ParseChatResponse(c);return this.NormalizeParsedResponse(u)}finally{i==null||i()}}async StreamResponse(e,t,n,s,i,r,o,l){var w,M,x;const c=await this.FetchWithTimeout(t,n.TimeoutMs,l);if(!c.ok)throw await e.BuildError(c);i==null||i();const u=(w=c.body)==null?void 0:w.getReader();if(!u)throw new Error("Streaming not supported in this environment.");const p=new TextDecoder;let g="",d="",f=null,m=null;const S=l?this.BuildAbortError():null,b=l?new Promise((y,k)=>{if(l.aborted){try{S.Usage=f,S.PartialContent=d}catch{}k(S);return}const C=()=>{try{S.Usage=f,S.PartialContent=d}catch{}k(S)};typeof l.addEventListener=="function"?(l.addEventListener("abort",C,{once:!0}),m=()=>l.removeEventListener("abort",C)):(l.onabort=C,m=()=>{l.onabort===C&&(l.onabort=null)})}):null;try{for(;;){let y;try{y=await(b?Promise.race([u.read(),b]):u.read())}catch(C){if(l!=null&&l.aborted&&(C==null?void 0:C.name)==="AbortError"){try{await u.cancel()}catch{}try{C.Usage=(C==null?void 0:C.Usage)??f,C.PartialContent=(C==null?void 0:C.PartialContent)??d}catch{}}throw C}if(y.done)break;g+=p.decode(y.value,{stream:!0});const k=g.split(`

`);g=k.pop()??"";for(const C of k){const A=this.ExtractSseEvent(C);if(!A)continue;const _=A.Data,V=_==="[DONE]"?"[DONE]":JSON.parse(_),L=_r({Schema:o,EventName:A.EventName,Data:V});for(const B of L)if(B){if(B.Type===z.ContentDelta){const D=B.Content??"";D&&(d+=D,s==null||s(D));continue}if(B.Type===z.ReasoningDelta||B.Type===z.ReasoningSummaryDelta){const D=B.Content??"";D&&(r==null||r({Type:"internal",Content:D,Classification:B.Classification??"reasoning"}),(x=(M=this.ChatLogger)==null?void 0:M.LogStreamClassified)==null||x.call(M,{ProviderId:e.Id,Classification:B.Classification??"reasoning"}));continue}if(B.Type===z.StreamDone)return B.Usage&&(f=B.Usage),{Content:d,Usage:f};B.Usage&&(f=B.Usage)}}}return{Content:d,Usage:f}}finally{m==null||m()}}ExtractSseEvent(e){const t=e.split(`
`);let n=null;const s=[];return t.forEach(i=>{const r=i.trim();r.startsWith("event:")&&(n=r.replace(/^event:\s?/,"")),r.startsWith("data:")&&s.push(r.replace(/^data:\s?/,""))}),s.length===0?null:{EventName:n,Data:s.join(`
`)}}async FetchWithTimeout(e,t,n){const s=new AbortController,r=typeof t=="number"&&t>0?setTimeout(()=>s.abort(),t):null;let o=null;if(n)if(n.aborted)s.abort();else{const l=()=>s.abort();typeof n.addEventListener=="function"?(n.addEventListener("abort",l,{once:!0}),o=()=>n.removeEventListener("abort",l)):(n.onabort=l,o=()=>{n.onabort===l&&(n.onabort=null)})}try{return await this.Fetch(e.Url,{method:"POST",headers:e.Headers,body:JSON.stringify(e.Body),signal:s.signal})}finally{r&&clearTimeout(r),o==null||o()}}NormalizeParsedResponse(e){return e?typeof e=="string"?{Content:e,Usage:null}:{Content:e.Content??"",Usage:e.Usage??null}:{Content:"",Usage:null}}ApplyReasoningSettings(e,t){var p,g,d,f;const n=(t==null?void 0:t.ReasoningPreference)??null,s=((p=t==null?void 0:t.Reasoning)==null?void 0:p.Control)??null;if(!n||!s)return null;const i=!!n.Enabled;if(!i)return null;const r=s.Type??null,o=s.ParamPath??null,l=(t==null?void 0:t.Endpoint)??"chat";if(o!=null&&o.startsWith("reasoning")&&l!=="responses")return null;let c=null;if(r==="effort_enum")c=n.EffortLevel??null,c&&Array.isArray(s.Allowed)&&!s.Allowed.includes(c)&&(c=null);else if(r==="token_budget"){const m=n.TokenBudget,S=typeof m=="number"?m:Number(m);Number.isFinite(S)&&(((g=s.Range)==null?void 0:g.Min)!=null&&S<s.Range.Min?c=s.Range.Min:((d=s.Range)==null?void 0:d.Max)!=null&&S>s.Range.Max?c=s.Range.Max:c=S)}else r==="toggle"&&(c=n.ToggleState??"on",Array.isArray(s.Allowed)&&!s.Allowed.includes(c)&&(c=s.Allowed[0]??null));return o&&c!=null&&this.SetParamPath(e.Body,o,c),(((f=t==null?void 0:t.RequestConstraints)==null?void 0:f.DisallowedParamsWhenReasoning)??[]).forEach(m=>{m&&Object.prototype.hasOwnProperty.call(e.Body,m)&&delete e.Body[m]}),{Enabled:i,ControlType:r,Value:c}}SetParamPath(e,t,n){if(!e||!t)return;const s=t.split(".").filter(Boolean);let i=e;for(let r=0;r<s.length;r+=1){const o=s[r];if(r===s.length-1){i[o]=n;return}(!i[o]||typeof i[o]!="object")&&(i[o]={}),i=i[o]}}BuildMetrics(e,t){const n=Math.max(Date.now()-t,0),s=(e==null?void 0:e.Usage)??{};return{DurationMs:n,InputTokens:s.InputTokens??null,OutputTokens:s.OutputTokens??null}}}class $r{constructor({Logger:e}={}){this.Logger=e}LogSendStart(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||n.call(t,"Chat.Send",e)}LogSendEnd(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowEnd)==null||n.call(t,"Chat.Send",e)}LogSendFailure(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogWarning)==null||n.call(t,"Chat.Send.Failed",e)}LogStreamStart(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||n.call(t,"Chat.Stream",e)}LogStreamEnd(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogFlowEnd)==null||n.call(t,"Chat.Stream",e)}LogStreamFailure(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogWarning)==null||n.call(t,"Chat.Stream.Failed",e)}LogReasoningApplied(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogInformation)==null||n.call(t,"Chat.Reasoning.Applied",e)}LogStreamClassified(e){var t,n;(n=(t=this.Logger)==null?void 0:t.LogDebug)==null||n.call(t,"Chat.Stream.Classified",e)}}const Ur=(a,e,t)=>Math.min(Math.max(a,e),t),Nr=a=>(a??"").trim(),Yn=a=>(a??"").toString(),Br=({StartIndex:a,FieldLength:e,PositionMinMultiplier:t})=>{const n=Number(t);return!Number.isFinite(n)||e<=1?1:1-Ur(a/(e-1),0,1)*(1-n)},Fr=({Text:a,Query:e})=>{const t=(a??"").toString(),n=(e??"").toString();if(!n.trim())return[];const s=t.toLowerCase(),i=n.toLowerCase(),r=[];let o=0;for(;o<=s.length-i.length;){const l=s.indexOf(i,o);if(l===-1)break;r.push({StartIndex:l,EndIndex:l+i.length,FieldLength:s.length}),o=l+1}return r},Zn=({Text:a,Query:e,BaseMultiplier:t,PositionMinMultiplier:n})=>{const s=Fr({Text:a,Query:e});if(s.length===0)return{Matches:[],TotalScore:0,BestMatch:null};const i=Number(t),r=Number.isFinite(i)?i:1,o=s.map(u=>{const p=Br({StartIndex:u.StartIndex,FieldLength:u.FieldLength,PositionMinMultiplier:n}),g=r*p;return{...u,BaseMultiplier:r,PositionMultiplier:p,Score:g}}),l=o.reduce((u,p)=>u?p.Score===u.Score?p.StartIndex<u.StartIndex?p:u:p.Score>u.Score?p:u:p,null),c=o.reduce((u,p)=>u+p.Score,0);return{Matches:o,TotalScore:c,BestMatch:l}},Jn=a=>{const e=(a??"").toString(),t=new Date(e);return Number.isNaN(t.getTime())?new Date(0):t},Hr=Object.freeze({TitleMatchMultiplier:2,BodyMatchMultiplier:1,PositionMinMultiplier:.5,MaxResults:50,ExcerptContextChars:48,ExcerptMaxLength:180}),ot=(a,e,t)=>Math.min(Math.max(a,e),t),Gr=({Text:a,MatchStart:e,MatchLength:t,ExcerptContextChars:n,ExcerptMaxLength:s})=>{const i=(a??"").toString(),r=ot(e,0,Math.max(i.length,0)),o=ot(e+t,0,Math.max(i.length,0)),l=ot(Number(n)||0,0,1e3),c=ot(Number(s)||180,20,2e3),u="...",p="...",g=o-r,d=Math.max(c-(u.length+p.length),g),f=Math.floor(Math.max(d-g,0)/2);let m=Math.max(r-Math.max(l,f),0),S=Math.min(o+Math.max(l,f),i.length);(()=>{if(S-m<=d)return;m=Math.max(r-Math.floor((d-g)/2),0),S=Math.min(m+d,i.length),S-m<d&&(m=Math.max(S-d,0))})();const w=m>0,M=S<i.length,x=w?u:"",y=M?p:"",k=i.slice(m,S),C=`${x}${k}${y}`,A=x.length+(r-m),_=A+(o-r);return{ExcerptText:C,ExcerptMatchStart:A,ExcerptMatchEnd:_}};class gs{SearchPinnedChats({Conversations:e,MessagesByConversation:t,Query:n,Config:s}={}){const i=Nr(n);if(!i)return[];const r={...Hr,...s??{}},o=ot(Number(r.MaxResults)||50,1,500),c=(e??[]).filter(u=>u==null?void 0:u.IsPinned).map(u=>{const p=Yn((u==null?void 0:u.Title)??""),f=((t??{})[u.Id]??[]??[]).filter(y=>{const k=((y==null?void 0:y.Role)??"").toString(),C=((y==null?void 0:y.Classification)??(y==null?void 0:y.Kind)??"").toString().toLowerCase(),A=(y==null?void 0:y.IsInternal)===!0||C==="internal"||C==="reasoning"||C==="system-internal"||C==="tool-invocation"||C==="tool-result";return!(k!=="User"&&k!=="Assistant"||A)}).map(y=>Yn((y==null?void 0:y.Content)??"")),m=Zn({Text:p,Query:i,BaseMultiplier:r.TitleMatchMultiplier,PositionMinMultiplier:r.PositionMinMultiplier}),S=f.map(y=>Zn({Text:y,Query:i,BaseMultiplier:r.BodyMatchMultiplier,PositionMinMultiplier:r.PositionMinMultiplier})),b=[...m.Matches.map(y=>({Field:"title",Text:p,...y})),...S.flatMap((y,k)=>y.Matches.map(C=>({Field:"body",Text:f[k],...C})))],w=b.reduce((y,k)=>y+(k.Score??0),0),M=b.reduce((y,k)=>y?k.Score===y.Score?k.StartIndex<y.StartIndex?k:y:k.Score>y.Score?k:y:k,null);if(!M||w<=0)return null;const x=Gr({Text:M.Text,MatchStart:M.StartIndex,MatchLength:i.length,ExcerptContextChars:r.ExcerptContextChars,ExcerptMaxLength:r.ExcerptMaxLength});return{ConversationId:u.Id,Title:p,Score:w,LastUpdatedUtc:u.LastUpdatedUtc??u.CreatedUtc??null,...x}}).filter(Boolean);return c.sort((u,p)=>{if(u.Score===p.Score){const g=Jn(u.LastUpdatedUtc);return Jn(p.LastUpdatedUtc).getTime()-g.getTime()}return p.Score-u.Score}),c.slice(0,o)}}const zr=Object.freeze({AppTitle:"Ghostplug",WelcomeHeading:"How can I help?",InputPlaceholder:"Ask anything",NotImplemented:"Not implemented",PendingMessage:"Waiting for response...",Chat:{WaitForResponseToastText:"Waiting for a response. Please wait or abort before switching chats.",AbortedToastText:"Response aborted.",AbortedMessageText:"Response aborted.",ReasoningToggleLabel:"Reasoning",ReasoningSectionLabel:"Reasoning",ReasoningActiveLabel:"Active",ReasoningOffLabel:"Off",ReasoningOnLabel:"On",ReasoningEffortLabel:"Reasoning",ReasoningBudgetLabel:"Reasoning",ReasoningToggleOnLabel:"Thinking on",ReasoningToggleOffLabel:"Thinking off",ThinkingIndicatorText:"Thinking...",InternalMessageLabel:"Thought",InternalMessagesSummaryLabel:"internal messages"},RetryAction:"Retry",RetryConfirmTitle:"Use the newly selected model?",RetryConfirmMessage:"You changed the selected model since the failed request. Use the new selection for retry?",RetryConfirmYes:"Yes",RetryConfirmNo:"No",Sidebar:{NewChat:"New chat",Search:"Search chats",Conversations:"Chats",Settings:"Settings"},ModelSelector:{Label:"Models"},Attachments:{AttachFiles:"Attach files"}}),fs=1.5,ms=10,Ss=.75,vs=.75,bs=3,Cs=2.5,ys=1.25,ks=fs*ms,Kr=bs+ks+Cs+vs+Ss*2+ys,qr=Math.max(24,Kr),Vr=Object.freeze({ChatBottomPadding:`${qr}rem`,InputLineHeightRem:fs,InputMaxLines:ms,InputShellPaddingRem:Ss,InputShellGapRem:vs,InputBottomGapRem:bs,InputButtonRowRem:Cs,InputSafetyPaddingRem:ys,InputMaxHeightRem:ks,SnackbarDurationMs:2400,ModelDescriptionDurationMs:5e3,ModelDescriptionFadeOutMs:1e3}),jt=Object.freeze({Themes:[{Id:"light",Label:"Light"},{Id:"dark",Label:"Dark"},{Id:"system",Label:"System"}],Accents:[{Id:"lime",Label:"Lime",Hex:"#84cc16"},{Id:"sunset",Label:"Sunset",Hex:"#ff6b6b"},{Id:"citrus",Label:"Citrus",Hex:"#f97316"},{Id:"electric",Label:"Electric",Hex:"#22d3ee"},{Id:"royal",Label:"Royal",Hex:"#6366f1"},{Id:"mint",Label:"Mint",Hex:"#10b981"},{Id:"magenta",Label:"Magenta",Hex:"#ec4899"},{Id:"amber",Label:"Amber",Hex:"#f59e0b"}],Providers:[]}),Is=({IsOpen:a=!1,ActiveCategory:e="general",General:t={},Chat:n={},Providers:s={},ProvidersCatalog:i=null}={})=>{const r=i??jt.Providers;return{IsOpen:a,ActiveCategory:e,Options:jt,General:{Theme:t.Theme??"system",AccentColor:t.AccentColor??jt.Accents[0].Id},Chat:{InternalChatMessages:n.InternalChatMessages??!1,ReasoningPreferences:n.ReasoningPreferences??{}},Providers:{SelectedProviderId:s.SelectedProviderId??null,Providers:r.map(o=>({...o,Models:o.Models.map(l=>({...l}))})),Keys:{openai:"",anthropic:"",google:"",grok:""},KeyVisibility:{},ValidationPopup:null,ModelAvailability:{}}}},it=Object.freeze({Models:[{Id:"gpt-4o-mini",Label:"GPT-4o Mini",Description:"Fast responses",IsDefault:!0},{Id:"gpt-4o",Label:"GPT-4o",Description:"Balanced reasoning",IsDefault:!1},{Id:"gpt-4.1",Label:"GPT-4.1",Description:"Deeper analysis",IsDefault:!1}],Conversations:[{Id:"conv-001",Title:"Welcome chat",LastUpdatedUtc:"2025-12-25T09:00:00Z",Preview:"Hello..."},{Id:"conv-002",Title:"Layout ideas",LastUpdatedUtc:"2025-12-24T15:10:00Z",Preview:"Sidebar and input..."},{Id:"conv-003",Title:"Model switch",LastUpdatedUtc:"2025-12-24T08:30:00Z",Preview:"Dropdown behaviors..."}],MessagesByConversation:{"conv-001":[{Id:"msg-001",ConversationId:"conv-001",Role:"User",Content:"hello",TimestampUtc:"2025-12-25T09:00:00Z"},{Id:"msg-002",ConversationId:"conv-001",Role:"Assistant",Content:"Hello, Borivoje — what are you working on today?",TimestampUtc:"2025-12-25T09:00:10Z"}]}}),jr=({ActiveConversationId:a=null,IsSidebarCollapsed:e=!1,InputText:t="",IsSending:n=!1,RetryPopup:s=null,ChatSearch:i=null,Conversations:r=it.Conversations,MessagesByConversation:o=it.MessagesByConversation,MessageGroupsByConversation:l={},ReasoningStepsByConversation:c={},SelectedModelId:u=null,Settings:p=null,ProvidersCatalog:g=null,ModelSelection:d=null,Reasoning:f=null}={})=>{const m=it.Models.find(S=>S.IsDefault)??it.Models[0];return{IsSidebarCollapsed:e,ActiveConversationId:a,Conversations:r,MessagesByConversation:o,MessageGroupsByConversation:l,ReasoningStepsByConversation:c,Models:it.Models,InputText:t,IsSending:n,RetryPopup:s,ChatSearch:i??{IsOpen:!1,Query:"",Results:[],Error:null},SelectedModelId:u??(m==null?void 0:m.Id)??null,ModelSelection:d??{LastUserSelectedModelId:null,AutoSelectedModelId:null,DescriptionText:null},Reasoning:f,Text:zr,Layout:Vr,Settings:p??Is({ProvidersCatalog:g})}};class _e{static CreateConversation({Title:e,ProviderId:t,ModelId:n}){const s=new Date().toISOString();return{Id:crypto.randomUUID(),Title:e??"",IsPinned:!1,CreatedUtc:s,LastUpdatedUtc:s,LastProviderId:t??null,LastModelId:n??null,ScrollPosition:0}}static CreateMessage({ConversationId:e,Role:t,Kind:n,Classification:s,IsInternal:i,Content:r,ProviderId:o,ModelId:l,Status:c}){const u=s??n??null,p=typeof i=="boolean"?i:u==="internal"||u==="reasoning"||u==="system-internal"||u==="tool-invocation"||u==="tool-result"||n==="Internal";return{Id:crypto.randomUUID(),ConversationId:e,Role:t,Kind:n,Classification:u,IsInternal:p,Content:r,CreatedUtc:new Date().toISOString(),ProviderId:o??null,ModelId:l??null,Status:c??"pending",Metrics:null}}static CreateMessageGroup({ConversationId:e,UserMessageId:t,InternalMessageIds:n,AssistantMessageId:s}){return{Id:crypto.randomUUID(),ConversationId:e,UserMessageId:t,InternalMessageIds:n??[],AssistantMessageId:s??null,InternalVisible:!1}}static TouchConversation(e,{ProviderId:t,ModelId:n}={}){return{...e,LastUpdatedUtc:new Date().toISOString(),LastProviderId:t??e.LastProviderId,LastModelId:n??e.LastModelId}}}const dn=a=>a==null?"":String(a).trim().replace(/\s+/g," "),xt=a=>dn(a).toLowerCase(),Wr=a=>{Object.assign(a.prototype,{GetActiveConversation(){var t;const e=(t=this.State)==null?void 0:t.ActiveConversationId;return e?(this.State.Conversations??[]).find(n=>n.Id===e)??null:null},HasActiveUnpinnedContent(){var s,i,r;const e=((((s=this.State)==null?void 0:s.InputText)??"").trim().length??0)>0,t=this.GetActiveConversation();if(!t)return e;if(t.IsPinned)return!1;const n=((r=(i=this.State)==null?void 0:i.MessagesByConversation)==null?void 0:r[t.Id])??[];return e||((n==null?void 0:n.length)??0)>0},RequestNewChat(){var e,t,n,s,i;if((e=this.State)!=null&&e.IsSending){this.ShowSnackbar((s=(n=(t=this.State)==null?void 0:t.Text)==null?void 0:n.Chat)==null?void 0:s.WaitForResponseToastText);return}if(this.Logger.LogFlowStart("ChatSaving.NewChat.Request",{ActiveConversationId:((i=this.State)==null?void 0:i.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"new-chat"}}),this.Logger.LogFlowEnd("ChatSaving.NewChat.Request",{Result:"prompted"});return}this.ExecuteNewChat()},ExecuteNewChat(){this.UpdateState({ActiveConversationId:null,InputText:"",ChatSaving:null,ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSaving.NewChat.Request",{Result:"started"})},RequestSelectConversation(e){var t,n,s,i,r,o;if((t=this.State)!=null&&t.IsSending){this.ShowSnackbar((i=(s=(n=this.State)==null?void 0:n.Text)==null?void 0:s.Chat)==null?void 0:i.WaitForResponseToastText);return}if(e&&e!==((r=this.State)==null?void 0:r.ActiveConversationId)){if(this.Logger.LogFlowStart("ChatSaving.SelectConversation.Request",{SelectedConversationId:e,ActiveConversationId:((o=this.State)==null?void 0:o.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"select-conversation",ConversationId:e}}),this.Logger.LogFlowEnd("ChatSaving.SelectConversation.Request",{Result:"prompted"});return}this.ExecuteSelectConversation(e)}},ExecuteSelectConversation(e){this.UpdateState({ActiveConversationId:e,InputText:"",ChatSaving:null,ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSaving.SelectConversation.Request",{Result:"selected"})},OpenDiscardDialog({NextAction:e}={}){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},DiscardDialog:{IsOpen:!0,NextAction:e??null}}})},CloseDiscardDialog(){var e,t,n;(n=(t=(e=this.State)==null?void 0:e.ChatSaving)==null?void 0:t.DiscardDialog)!=null&&n.IsOpen&&(this.UpdateState({ChatSaving:null}),this.Logger.LogFlowEnd("ChatSaving.Discard",{Result:"cancelled"}))},ConfirmDiscard(){var u,p,g,d;const e=((g=(p=(u=this.State)==null?void 0:u.ChatSaving)==null?void 0:p.DiscardDialog)==null?void 0:g.NextAction)??null,t=this.GetActiveConversation(),n=((d=this.State)==null?void 0:d.ActiveConversationId)??null,i=t&&!t.IsPinned&&!!n;let r=this.State.Conversations??[],o=this.State.MessagesByConversation??{},l=this.State.MessageGroupsByConversation??{};i&&n&&(r=r.filter(f=>f.Id!==n),o={...o},delete o[n],l={...l},delete l[n]);const c={Conversations:r,MessagesByConversation:o,MessageGroupsByConversation:l,InputText:"",ChatSaving:null};(e==null?void 0:e.Type)==="select-conversation"?c.ActiveConversationId=e.ConversationId??null:(e==null?void 0:e.Type)==="select-chat-search-result"?(c.ActiveConversationId=e.ConversationId??null,c.ChatSearch={IsOpen:!1,Query:"",Results:[],Error:null}):(e==null?void 0:e.Type)==="new-chat"&&(c.ActiveConversationId=null),this.UpdateState(c),this.Logger.LogFlowEnd("ChatSaving.Discard",{Result:"confirmed",NextAction:(e==null?void 0:e.Type)??null})},RequestTogglePin(){var n;if((n=this.State)!=null&&n.IsSending)return;const e=this.GetActiveConversation();if(e!=null&&e.IsPinned){this.UnpinConversation(e.Id);return}const t=(e==null?void 0:e.Title)??"";this.OpenPinDialog({Name:t})},OpenPinDialog({Name:e}={}){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{IsOpen:!0,Name:e??"",ErrorText:null}}})},ClosePinDialog(){var e,t,n;(n=(t=(e=this.State)==null?void 0:e.ChatSaving)==null?void 0:t.PinDialog)!=null&&n.IsOpen&&(this.UpdateState({ChatSaving:null}),this.Logger.LogFlowEnd("ChatSaving.Pin",{Result:"cancelled"}))},UpdatePinDialogName(e){var t,n,s,i;(s=(n=(t=this.State)==null?void 0:t.ChatSaving)==null?void 0:n.PinDialog)!=null&&s.IsOpen&&(this.State={...this.State,ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...((i=this.State.ChatSaving)==null?void 0:i.PinDialog)??{},Name:e??"",ErrorText:null}}})},ConfirmPinFromDialog(){var u,p,g,d,f,m;const e=(p=(u=this.State)==null?void 0:u.ChatSaving)==null?void 0:p.PinDialog;if(!(e!=null&&e.IsOpen))return;this.Logger.LogFlowStart("ChatSaving.Pin",{ActiveConversationId:((g=this.State)==null?void 0:g.ActiveConversationId)??null});const t=dn(e.Name??""),n=((f=(d=this.State)==null?void 0:d.Text)==null?void 0:f.ChatSaving)??{};if(!t){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...e,Name:e.Name??"",ErrorText:n.PinDialogEmptyError??null}}});return}const s=xt(t);if((this.State.Conversations??[]).filter(S=>S==null?void 0:S.IsPinned).some(S=>xt((S==null?void 0:S.Title)??"")===s)){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...e,Name:t,ErrorText:n.PinDialogDuplicateError??null}}});return}const o=new Date().toISOString();let l=((m=this.State)==null?void 0:m.ActiveConversationId)??null,c=this.State.Conversations??[];if(l){const S=this.GetActiveConversation();if(!S){this.Logger.LogError("ChatSaving.Pin.MissingActiveConversation",{ActiveConversationId:l});return}const b={...S,Title:t,IsPinned:!0,LastUpdatedUtc:o};c=[b,...c.filter(w=>w.Id!==b.Id)],this.UpdateState({Conversations:c,ChatSaving:null})}else{const S=_e.CreateConversation({Title:t});S.IsPinned=!0,S.LastUpdatedUtc=o,l=S.Id,c=[S,...c],this.UpdateState({Conversations:c,ActiveConversationId:l,ChatSaving:null})}this.ShowSnackbar(n.PinnedToastText),this.Logger.LogFlowEnd("ChatSaving.Pin",{Result:"pinned",Name:t})},UnpinConversation(e){var r,o;if(!e)return;const t=(this.State.Conversations??[]).find(l=>l.Id===e);if(!t)return;const n=((o=(r=this.State)==null?void 0:r.Text)==null?void 0:o.ChatSaving)??{},s={...t,IsPinned:!1,LastUpdatedUtc:new Date().toISOString()},i=(this.State.Conversations??[]).map(l=>l.Id===e?s:l);this.UpdateState({Conversations:i,ChatSaving:null}),this.ShowSnackbar(n.UnpinnedToastText),this.Logger.LogFlowEnd("ChatSaving.Unpin",{Result:"unpinned",ConversationId:e})}})},Qr=a=>{Object.assign(a.prototype,{OpenChatSearch(){var e,t,n,s,i;if((e=this.State)!=null&&e.IsSending){this.ShowSnackbar((s=(n=(t=this.State)==null?void 0:t.Text)==null?void 0:n.Chat)==null?void 0:s.WaitForResponseToastText);return}this.Logger.LogFlowStart("ChatSearch.Open",{ActiveConversationId:((i=this.State)==null?void 0:i.ActiveConversationId)??null}),this.UpdateState({ChatSearch:{IsOpen:!0,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSearch.Open",{Result:"opened"})},CloseChatSearch(){var e,t;(t=(e=this.State)==null?void 0:e.ChatSearch)!=null&&t.IsOpen&&(this.ChatSearchDebounceTimer&&(clearTimeout(this.ChatSearchDebounceTimer),this.ChatSearchDebounceTimer=null),this.UpdateState({ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSearch.Close",{Result:"closed"}))},UpdateChatSearchQuery(e){var i,r,o,l,c;if(!((r=(i=this.State)==null?void 0:i.ChatSearch)!=null&&r.IsOpen))return;const t=e??"",n=Number(((c=(l=(o=this.State)==null?void 0:o.Text)==null?void 0:l.ChatSearch)==null?void 0:c.DebounceMs)??0),s=Number.isFinite(n)?Math.max(0,n):0;this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Query:t,Error:null}}),this.ChatSearchDebounceTimer&&(clearTimeout(this.ChatSearchDebounceTimer),this.ChatSearchDebounceTimer=null),this.ChatSearchDebounceTimer=setTimeout(()=>{this.ChatSearchDebounceTimer=null,this.ComputeChatSearchResults()},s)},ComputeChatSearchResults(){var s,i,r,o,l,c,u;if(!((i=(s=this.State)==null?void 0:s.ChatSearch)!=null&&i.IsOpen))return;const e=((r=this.State.ChatSearch)==null?void 0:r.Query)??"",t=((l=(o=this.State)==null?void 0:o.Text)==null?void 0:l.ChatSearch)??{},n=performance.now();try{const p=this.ChatSearchService.SearchPinnedChats({Conversations:((c=this.State)==null?void 0:c.Conversations)??[],MessagesByConversation:((u=this.State)==null?void 0:u.MessagesByConversation)??{},Query:e,Config:t}),g=performance.now()-n;this.Logger.LogInformation("ChatSearch.Query.Updated",{QueryLength:(e??"").length,ResultCount:p.length,DurationMs:Math.round(g)}),this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Results:p,Error:null}})}catch(p){this.Logger.LogError("ChatSearch.Query.Failed",{Error:(p==null?void 0:p.message)??"Unknown error"}),this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Results:[],Error:(p==null?void 0:p.message)??"Search failed."}})}},RequestSelectChatSearchResult(e){var t,n,s,i,r,o;if((t=this.State)!=null&&t.IsSending){this.ShowSnackbar((i=(s=(n=this.State)==null?void 0:n.Text)==null?void 0:s.Chat)==null?void 0:i.WaitForResponseToastText);return}if(e){if(e===((r=this.State)==null?void 0:r.ActiveConversationId)){this.CloseChatSearch();return}if(this.Logger.LogFlowStart("ChatSearch.SelectResult.Request",{SelectedConversationId:e,ActiveConversationId:((o=this.State)==null?void 0:o.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"select-chat-search-result",ConversationId:e}}),this.Logger.LogFlowEnd("ChatSearch.SelectResult.Request",{Result:"prompted"});return}this.ExecuteSelectConversation(e),this.Logger.LogFlowEnd("ChatSearch.SelectResult.Request",{Result:"selected"})}}})},Yr=a=>{Object.assign(a.prototype,{PersistState(){var n,s,i,r,o,l,c,u,p,g;const e=this.SanitizeState(this.State);try{Promise.resolve((s=(n=this.AppStateStore)==null?void 0:n.SaveStateAsync)==null?void 0:s.call(n,e)).catch(d=>{var f,m,S;this.Logger.LogError("App.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((S=(m=(f=this.State)==null?void 0:f.Text)==null?void 0:m.ChatSaving)==null?void 0:S.StorageErrorText)})}catch(d){this.Logger.LogError("App.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((o=(r=(i=this.State)==null?void 0:i.Text)==null?void 0:r.ChatSaving)==null?void 0:o.StorageErrorText)}const t=this.ExtractConversationState(this.State);try{Promise.resolve((c=(l=this.ConversationStore)==null?void 0:l.SaveStateAsync)==null?void 0:c.call(l,t)).catch(d=>{var f,m,S;this.Logger.LogError("Conversation.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((S=(m=(f=this.State)==null?void 0:f.Text)==null?void 0:m.ChatSaving)==null?void 0:S.StorageErrorText)})}catch(d){this.Logger.LogError("Conversation.State.SaveFailed",{Error:(d==null?void 0:d.message)??"Unknown error"}),this.ShowSnackbar((g=(p=(u=this.State)==null?void 0:u.Text)==null?void 0:p.ChatSaving)==null?void 0:g.StorageErrorText)}},SanitizeState(e){const{Layout:t,Text:n,Conversations:s,MessagesByConversation:i,MessageGroupsByConversation:r,ChatSearch:o,...l}=e,u=new Set((s??[]).filter(p=>p==null?void 0:p.IsPinned).map(p=>p.Id).filter(Boolean)).has(e.ActiveConversationId)?e.ActiveConversationId:null;return{...l,ActiveConversationId:u,IsSending:!1,RetryPopup:null,ChatSaving:null,ChatSearch:null,Settings:{...e.Settings,Providers:{...e.Settings.Providers,Keys:Is().Providers.Keys,KeyVisibility:{},ValidationPopup:null}}}},ExtractConversationState(e){const t=new Set((e.Conversations??[]).filter(s=>s==null?void 0:s.IsPinned).map(s=>s.Id).filter(Boolean)),n=s=>t.has(s);return{Conversations:(e.Conversations??[]).filter(s=>n(s.Id)),MessagesByConversation:Object.fromEntries(Object.entries(e.MessagesByConversation??{}).filter(([s])=>n(s))),MessageGroupsByConversation:Object.fromEntries(Object.entries(e.MessageGroupsByConversation??{}).filter(([s])=>n(s))),ReasoningStepsByConversation:Object.fromEntries(Object.entries(e.ReasoningStepsByConversation??{}).filter(([s])=>n(s)))}},BuildText(e,{AppName:t}={}){var r,o,l,c,u,p;const n=((o=(r=this.Configuration)==null?void 0:r[Oe.Ui])==null?void 0:o.Chat)??{},s=((c=(l=this.Configuration)==null?void 0:l[Oe.Ui])==null?void 0:c.ChatSaving)??{},i=((p=(u=this.Configuration)==null?void 0:u[Oe.Ui])==null?void 0:p.ChatSearch)??{};return{...e??{},AppTitle:t??(e==null?void 0:e.AppTitle),Chat:{...(e==null?void 0:e.Chat)??{},...n},ChatSaving:s,ChatSearch:i}},NormalizeStoredConversationState(e){var r;if(!((r=e==null?void 0:e.Conversations)!=null&&r.length)||e.Conversations.some(o=>Object.prototype.hasOwnProperty.call(o??{},"IsPinned")))return e;const n=new Set,s=[],i=e.Conversations.map(o=>{const l=(o==null?void 0:o.Title)??"",c=dn(l);if(!c)return{...o,IsPinned:!0};let u=c,p=1;for(;n.has(xt(u));)p+=1,u=`${c} (${p})`;const g=xt(u);return g&&n.add(g),u!==l&&s.push({ConversationId:o==null?void 0:o.Id,From:l,To:u}),{...o,Title:u,IsPinned:!0}});return this.Logger.LogFlowStart("Conversation.Migration.LegacyPinned.Start",{ConversationCount:e.Conversations.length}),s.length>0&&this.Logger.LogWarning("Conversation.Migration.LegacyPinned.Renamed",{Renamed:s}),this.Logger.LogFlowEnd("Conversation.Migration.LegacyPinned.End",{RenamedCount:s.length}),{...e,Conversations:i}},ShowSnackbar(e){var t,n;e&&((n=(t=this.RootView)==null?void 0:t.Snackbar)==null||n.Show(e))},MergeState(e,t){if(!t)return e;const n={...e,...t};return n.Layout=e.Layout,n.Text=e.Text,n.Conversations=e.Conversations,n.MessagesByConversation=e.MessagesByConversation,n.MessageGroupsByConversation=e.MessageGroupsByConversation,n.Settings=this.MergeSettings(e.Settings,t.Settings),n.ModelSelection||(n.ModelSelection={LastUserSelectedModelId:n.SelectedModelId??null,AutoSelectedModelId:null}),n},MergeSettings(e,t){var r,o,l,c;if(!t)return e;const n={...e,...t,Options:e.Options,General:{...e.General,...t.General},Chat:{...e.Chat,...t.Chat,ReasoningPreferences:{...((r=e.Chat)==null?void 0:r.ReasoningPreferences)??{},...((o=t.Chat)==null?void 0:o.ReasoningPreferences)??{}}}};((l=t.General)==null?void 0:l.InternalChatMessages)!=null&&((c=t.Chat)==null?void 0:c.InternalChatMessages)==null&&(n.Chat={...n.Chat,InternalChatMessages:t.General.InternalChatMessages});const s=t.Providers??{},i={...e.Providers,...s};return i.Providers=e.Providers.Providers.map(u=>{var d;const p=(d=s.Providers)==null?void 0:d.find(f=>f.Id===u.Id);if(!p)return u;const g=new Map((p.Models??[]).map(f=>[f.Id,f.Enabled]));return{...u,Models:u.Models.map(f=>({...f,Enabled:g.has(f.Id)?g.get(f.Id):f.Enabled}))}}),i.SelectedProviderId=i.Providers.some(u=>u.Id===i.SelectedProviderId)?i.SelectedProviderId:null,n.Providers=i,n}})},Zr=a=>{Object.assign(a.prototype,{ApplyProviderModelStates(e,t){return!t||e.length===0?e:e.map(n=>{const s=t[n.Id]??{};return{...n,Models:n.Models.map(i=>({...i,Enabled:s[i.Id]??i.Enabled}))}})},RefreshModelSelectorState(e){const t=this.NormalizeModelSelection(e.ModelSelection,e.SelectedModelId),n=this.BuildAvailableModels(e.Settings.Providers.Providers,e.Settings.Providers.ModelAvailability),s=this.ResolveModelSelection(n,t,e.SelectedModelId),i=this.MaybeClearDescription(e,s.SelectedModelId,s.ModelSelection);return{...e,Models:n,SelectedModelId:s.SelectedModelId,ModelSelection:i}},NormalizeModelSelection(e,t){return e||{LastUserSelectedModelId:t??null,AutoSelectedModelId:null}},BuildAvailableModels(e,t){const n=[];return(e??[]).forEach(s=>{const i=(t==null?void 0:t[s.Id])??{};(s.Models??[]).forEach(r=>{r.Enabled&&i[r.Id]&&n.push({Id:r.Id,Label:r.Label,Description:r.Description??"",ProviderId:s.Id,ProviderName:s.Name,Capabilities:r.Capabilities??{}})})}),n},ResolveModelSelectionState({Providers:e,ModelAvailability:t,SelectedModelId:n,ModelSelection:s}){const i=this.BuildAvailableModels(e,t),r=this.NormalizeModelSelection(s,n),o=this.ResolveModelSelection(i,r,n);return{Models:i,SelectedModelId:o.SelectedModelId,ModelSelection:o.ModelSelection}},ResolveModelSelection(e,t,n){const s=new Set(e.map(l=>l.Id)),i=t.LastUserSelectedModelId;let r=s.has(n)?n:null,o=t.AutoSelectedModelId;return i&&s.has(i)?(r=i,o=null):!r&&e.length>0&&(r=e[0].Id,o=r),{SelectedModelId:r,ModelSelection:{...t,AutoSelectedModelId:o}}},MaybeClearDescription(e,t,n){return!(n!=null&&n.DescriptionText)||t&&t===e.SelectedModelId?n:{...n,DescriptionText:null}},BuildModelAvailability(e,t){const n={};return(t??[]).forEach(s=>{n[s.Id]=!1}),e.forEach(s=>{n[s]=!0}),n},BuildProviderAvailability(e){const t={};return(e??[]).forEach(n=>{t[n.Id]=!1}),t},MergeAvailability(e,t){const n={};return(e??[]).forEach(s=>{const i=this.BuildProviderAvailability(s.Models??[]),r=(t==null?void 0:t[s.Id])??{};n[s.Id]={...i,...r}}),n},ResetProviderAvailability(e){const n=this.State.Settings.Providers.Providers.find(r=>r.Id===e);if(!n)return;const i={...this.State.Settings.Providers.ModelAvailability??{},[e]:this.BuildProviderAvailability(n.Models??[])};this.ProvidersStore.SetProviderAvailability(e,i[e]),this.UpdateSettings(r=>{const o={...r,Providers:{...r.Providers,ModelAvailability:i}},l=this.ResolveModelSelectionState({Providers:o.Providers.Providers,ModelAvailability:o.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:o,Models:l.Models,SelectedModelId:l.SelectedModelId,ModelSelection:l.ModelSelection}})},ApplyModelAvailability(e,t,n){return n?e.map(s=>{if(s.Id!==t)return s;const i=s.Models.map(r=>({...r}));return{...s,Models:i}}):e}})},Jr=a=>{Object.assign(a.prototype,{async SendMessageAsync(){var M,x,y,k;if(this.State.IsSending)return;const e=(this.State.InputText??"").trim();if(!e)return;const t=this.State.Models.find(C=>C.Id===this.State.SelectedModelId);if(!t){this.Logger.LogWarning("Chat.Send.MissingModel",{});return}const n=t.ProviderId,s=t.Id,i=((M=this.State.Settings.Providers.Keys)==null?void 0:M[n])??"";let r=this.State.ActiveConversationId,o=this.State.Conversations,l={...this.State.MessagesByConversation};const c=this.BuildPreview(e);if(r)o=this.UpdateConversationPreview(o,r,c,n,s);else{const C=this.InferTitle(e),A=_e.CreateConversation({Title:C,ProviderId:n,ModelId:s});A.Preview=c,r=A.Id,o=[A,...o],l[r]=[]}const u=_e.CreateMessage({ConversationId:r,Role:"User",Kind:"User",Classification:null,Content:e,ProviderId:n,ModelId:s,Status:"done"}),p=_e.CreateMessage({ConversationId:r,Role:"Assistant",Kind:"Assistant",Classification:null,Content:"",ProviderId:n,ModelId:s,Status:"pending"});p.ReasoningEnabled=this.IsReasoningEnabled(n,s);const g=_e.CreateMessageGroup({ConversationId:r,UserMessageId:u.Id,InternalMessageIds:[],AssistantMessageId:p.Id}),d=[...l[r]??[],u,p];l={...l,[r]:d};const f={...this.State.MessageGroupsByConversation??{},[r]:[...(this.State.MessageGroupsByConversation??{})[r]??[],g]};this.UpdateState({ActiveConversationId:r,Conversations:o,MessagesByConversation:l,MessageGroupsByConversation:f,InputText:"",IsSending:!0});const m=d.filter(C=>C.Id!==p.Id&&!this.IsInternalMessage(C)),S=new AbortController;this.SendAbortController=S;const b=(k=(y=(x=this.State.Settings)==null?void 0:x.Providers)==null?void 0:y.Providers)==null?void 0:k.find(C=>C.Id===n),w=this.BuildReasoningConfig(t,b,n,s);try{const C=await this.ChatService.SendAsync({ProviderId:n,ModelId:s,Key:i,Messages:m,Stream:!0,ModelConfig:w,Signal:S.signal,OnStreamStart:()=>{S.signal.aborted||this.IsReasoningEnabled(n,s)&&this.UpdateMessage(r,p.Id,A=>({...A,Status:A.Status==="pending"?"streaming":A.Status}))},OnEvent:A=>{S.signal.aborted||this.AppendInternalMessage({ConversationId:r,MessageGroupId:g.Id,AssistantMessageId:p.Id,ProviderId:n,ModelId:s,Content:(A==null?void 0:A.Content)??"",Classification:(A==null?void 0:A.Classification)??"reasoning"})},OnToken:A=>{S.signal.aborted||this.UpdateMessage(r,p.Id,_=>({..._,Content:`${_.Content??""}${A}`,Status:"streaming"}))}});if(S.signal.aborted)return;this.UpdateMessage(r,p.Id,A=>({...A,Content:C.Content??A.Content??"",Status:"done",Metrics:C.Metrics??null}))}catch(C){S.signal.aborted&&(C==null?void 0:C.name)==="AbortError"?this.UpdateMessage(r,p.Id,_=>({..._,Status:"aborted",Metrics:(C==null?void 0:C.Metrics)??_.Metrics??null})):this.UpdateMessage(r,p.Id,_=>({..._,Status:"error",ErrorMessage:(C==null?void 0:C.message)??"Request failed.",Metrics:null}))}finally{this.SendAbortController===S&&(this.SendAbortController=null),this.UpdateState({IsSending:!1})}},AbortSend(){var t,n,s,i;if(!((t=this.State)!=null&&t.IsSending))return;const e=this.SendAbortController;!e||e.signal.aborted||(e.abort(),this.ShowSnackbar((i=(s=(n=this.State)==null?void 0:n.Text)==null?void 0:s.Chat)==null?void 0:i.AbortedToastText))},OpenRetryPopup(e){const t=this.FindMessageLocation(e);if(!t)return;const n=t.Message;if(n.Status!=="error")return;const s=this.State.Models.find(r=>r.Id===this.State.SelectedModelId);if(!s)return;if(s.Id===n.ModelId&&s.ProviderId===n.ProviderId){this.RetryMessageAsync(t.ConversationId,e,n.ProviderId,n.ModelId).catch(r=>{this.Logger.LogError("Chat.Retry.Failed",{Error:(r==null?void 0:r.message)??"Unknown error"})});return}this.UpdateState({RetryPopup:{IsOpen:!0,MessageId:e,ConversationId:t.ConversationId,OriginalProviderId:n.ProviderId,OriginalModelId:n.ModelId,SelectedProviderId:s.ProviderId,SelectedModelId:s.Id}})},async ConfirmRetryAsync(e){const t=this.State.RetryPopup;if(!(t!=null&&t.IsOpen))return;const n=e?t.SelectedProviderId:t.OriginalProviderId,s=e?t.SelectedModelId:t.OriginalModelId,i=t.ConversationId,r=t.MessageId;this.UpdateState({RetryPopup:null}),await this.RetryMessageAsync(i,r,n,s)},async RetryMessageAsync(e,t,n,s){var p;if(this.State.IsSending)return;const i=this.State.MessagesByConversation[e]??[],r=i.findIndex(g=>g.Id===t);if(r===-1)return;this.UpdateState({IsSending:!0}),this.UpdateMessage(e,t,g=>({...g,Status:"pending",Content:"",ErrorMessage:null,ProviderId:n,ModelId:s,Metrics:null,ReasoningEnabled:this.IsReasoningEnabled(n,s)}));const o=i.slice(0,r).filter(g=>g.Status!=="error"&&!this.IsInternalMessage(g)),l=((p=this.State.Settings.Providers.Keys)==null?void 0:p[n])??"",c=this.GetModelConfig(n,s),u=new AbortController;this.SendAbortController=u;try{const g=await this.ChatService.SendAsync({ProviderId:n,ModelId:s,Key:l,Messages:o,Stream:!0,ModelConfig:c,Signal:u.signal,OnStreamStart:()=>{u.signal.aborted||this.IsReasoningEnabled(n,s)&&this.UpdateMessage(e,t,d=>({...d,Status:d.Status==="pending"?"streaming":d.Status}))},OnEvent:d=>{if(u.signal.aborted)return;const f=this.FindMessageGroupByAssistantId(e,t);f&&this.AppendInternalMessage({ConversationId:e,MessageGroupId:f.Id,AssistantMessageId:t,ProviderId:n,ModelId:s,Content:(d==null?void 0:d.Content)??"",Classification:(d==null?void 0:d.Classification)??"reasoning"})},OnToken:d=>{u.signal.aborted||this.UpdateMessage(e,t,f=>({...f,Content:`${f.Content??""}${d}`,Status:"streaming"}))}});if(u.signal.aborted)return;this.UpdateMessage(e,t,d=>({...d,Content:g.Content??d.Content??"",Status:"done",Metrics:g.Metrics??null}))}catch(g){u.signal.aborted&&(g==null?void 0:g.name)==="AbortError"?this.UpdateMessage(e,t,f=>({...f,Status:"aborted",Metrics:(g==null?void 0:g.Metrics)??f.Metrics??null})):this.UpdateMessage(e,t,f=>({...f,Status:"error",ErrorMessage:(g==null?void 0:g.message)??"Request failed.",Metrics:null}))}finally{this.SendAbortController===u&&(this.SendAbortController=null),this.UpdateState({IsSending:!1})}},ToggleInternalGroup(e){var i;const t=this.FindMessageGroupLocation(e);if(!t)return;const s=(((i=this.State.MessageGroupsByConversation)==null?void 0:i[t.ConversationId])??[]).map(r=>r.Id===e?{...r,InternalVisible:!r.InternalVisible}:r);this.UpdateState({MessageGroupsByConversation:{...this.State.MessageGroupsByConversation,[t.ConversationId]:s}})},UpdateMessage(e,t,n){const i=(this.State.MessagesByConversation[e]??[]).map(r=>r.Id===t?n(r):r);this.UpdateState({MessagesByConversation:{...this.State.MessagesByConversation,[e]:i}})},IsInternalMessage(e){if(!e)return!1;const t=(e.Classification??e.Kind??"").toString().toLowerCase();return t==="internal"||t==="reasoning"||t==="system-internal"||t==="tool-invocation"||t==="tool-result"},IsReasoningEnabled(e,t){var i,r,o,l,c,u;const n=(i=this.State)==null?void 0:i.Reasoning;if(n&&n.ProviderId===e&&n.ModelId===t)return!!n.Enabled;const s=this.BuildReasoningKey?this.BuildReasoningKey(e,t):`${e}:${t}`;return!!((u=(c=(l=(o=(r=this.State)==null?void 0:r.Settings)==null?void 0:o.Chat)==null?void 0:l.ReasoningPreferences)==null?void 0:c[s])!=null&&u.Enabled)},FindMessageLocation(e){const t=Object.entries(this.State.MessagesByConversation??{});for(const[n,s]of t){const i=(s??[]).find(r=>r.Id===e);if(i)return{ConversationId:n,Message:i}}return null},FindMessageGroupLocation(e){const t=Object.entries(this.State.MessageGroupsByConversation??{});for(const[n,s]of t){const i=(s??[]).find(r=>r.Id===e);if(i)return{ConversationId:n,Group:i}}return null},FindMessageGroupByAssistantId(e,t){var s;return(((s=this.State.MessageGroupsByConversation)==null?void 0:s[e])??[]).find(i=>i.AssistantMessageId===t)??null},AppendInternalMessage({ConversationId:e,MessageGroupId:t,AssistantMessageId:n,ProviderId:s,ModelId:i,Content:r,Classification:o}){var b,w,M;const l=(r??"").toString();if(!l.trim())return;const c=_e.CreateMessage({ConversationId:e,Role:"System",Kind:"Internal",Classification:o??"reasoning",Content:l,ProviderId:s,ModelId:i,Status:"done"}),p=[...((b=this.State.MessagesByConversation)==null?void 0:b[e])??[],c],d=(((w=this.State.MessageGroupsByConversation)==null?void 0:w[e])??[]).map(x=>x.Id===t?{...x,InternalMessageIds:[...x.InternalMessageIds??[],c.Id]}:x),f=((M=this.State.ReasoningStepsByConversation)==null?void 0:M[e])??[],m=f.filter(x=>x.MessageId===n).length,S=[...f,{Id:crypto.randomUUID(),MessageId:n,ConversationId:e,StepIndex:m,Content:l,ProviderId:s,ModelId:i,TimestampUtc:new Date().toISOString(),Classification:o??"reasoning"}];this.UpdateState({MessagesByConversation:{...this.State.MessagesByConversation,[e]:p},MessageGroupsByConversation:{...this.State.MessageGroupsByConversation,[e]:d},ReasoningStepsByConversation:{...this.State.ReasoningStepsByConversation??{},[e]:S}})},GetModelConfig(e,t){var r,o,l,c;const n=(l=(o=(r=this.State.Settings)==null?void 0:r.Providers)==null?void 0:o.Providers)==null?void 0:l.find(u=>u.Id===e),s=(c=n==null?void 0:n.Models)==null?void 0:c.find(u=>u.Id===t),i=s?{...s,ProviderId:e}:null;return this.BuildReasoningConfig(i,n,e,t)},BuildReasoningConfig(e,t,n,s){var p,g,d,f,m,S;const i={...(e==null?void 0:e.Capabilities)??{}};!i.Endpoint&&((p=t==null?void 0:t.ApiConventions)!=null&&p.PrimaryEndpoint)&&(i.Endpoint=t.ApiConventions.PrimaryEndpoint);const r=xr({Provider:t,Model:e});r&&(i.StreamSchema=r),t&&(i.Provider=t),e&&(i.Model=e);const o=(g=this.State)!=null&&g.Reasoning&&this.State.Reasoning.ModelId===s&&this.State.Reasoning.ProviderId===n?this.State.Reasoning:null,l=this.BuildReasoningKey?this.BuildReasoningKey(n,s):`${n}:${s}`,c=((S=(m=(f=(d=this.State)==null?void 0:d.Settings)==null?void 0:f.Chat)==null?void 0:m.ReasoningPreferences)==null?void 0:S[l])??null,u=o??c;return u?{...i,ReasoningPreference:u}:i},InferTitle(e){var s;const t=((s=e.split(`
`)[0])==null?void 0:s.trim())??"",n=48;return t.length<=n?t||"New chat":`${t.slice(0,n-3)}...`},BuildPreview(e){var s;const t=((s=e.split(`
`)[0])==null?void 0:s.trim())??"",n=72;return t.length<=n?t:`${t.slice(0,n-3)}...`},UpdateConversationPreview(e,t,n,s,i){const r=(e??[]).map(l=>l.Id!==t?l:{..._e.TouchConversation(l,{ProviderId:s,ModelId:i}),Preview:n}),o=r.find(l=>l.Id===t);return o?[o,...r.filter(l=>l.Id!==t)]:r},UpdateConversationScroll(e,t){const n=(this.State.Conversations??[]).map(s=>s.Id===e?{...s,ScrollPosition:t}:s);this.UpdateState({Conversations:n},{Render:!1})},async YieldToBrowser(){return await new Promise(e=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(()=>e());return}setTimeout(e,0)})},ScheduleModelDescriptionClear(){var t;const e=((t=this.State.Layout)==null?void 0:t.ModelDescriptionDurationMs)??5e3;this.ModelDescriptionTimer&&clearTimeout(this.ModelDescriptionTimer),this.ModelDescriptionTimer=setTimeout(()=>{var n,s;(s=(n=this.State)==null?void 0:n.ModelSelection)!=null&&s.DescriptionText&&this.UpdateState({ModelSelection:{...this.State.ModelSelection,DescriptionText:null}})},e)}})};class je{constructor({Configuration:e,Logger:t,RootView:n,AppStateStore:s,ProvidersStore:i,ProviderCatalogService:r,ProviderValidationService:o,ConversationStore:l,ChatService:c,ChatSearchService:u}){this.Configuration=e,this.Logger=t,this.RootView=n,this.AppStateStore=s,this.ProvidersStore=i,this.ProviderCatalogService=r,this.ProviderValidationService=o,this.ConversationStore=l,this.ChatService=c,this.ChatSearchService=u??new gs,this.SendAbortController=null,this.ChatSearchDebounceTimer=null,this.State=null}async StartAsync(){var d,f,m,S;this.Logger.LogFlowStart("App.Start",{Environment:this.Configuration[Oe.App][An.Environment]});const e=document.getElementById("app");if(!e)throw this.Logger.LogError("App.Start.MissingContainer",{ContainerId:"app"}),new Error("App container not found.");const t=await this.AppStateStore.LoadStateAsync();let n=null,s=null;try{n=await((d=this.ConversationStore)==null?void 0:d.LoadStateAsync())}catch(b){s=b,this.Logger.LogError("Conversation.State.LoadFailed",{Error:(b==null?void 0:b.message)??"Unknown error"})}const i=await this.ProviderCatalogService.LoadCatalogAsync(),r=jr({ActiveConversationId:null,ProvidersCatalog:(i==null?void 0:i.Providers)??[]}),o=this.MergeState(r,t),l=this.Configuration[Oe.App][An.Name];o.Text=this.BuildText(o.Text,{AppName:l}),o.ChatSearch=o.ChatSearch??{IsOpen:!1,Query:"",Results:[],Error:null};const c=this.NormalizeStoredConversationState(n);c&&(o.Conversations=c.Conversations??o.Conversations,o.MessagesByConversation=c.MessagesByConversation??o.MessagesByConversation,o.MessageGroupsByConversation=c.MessageGroupsByConversation??{},o.ReasoningStepsByConversation=c.ReasoningStepsByConversation??{}),o.ActiveConversationId&&!o.Conversations.some(b=>b.Id===o.ActiveConversationId)&&(o.ActiveConversationId=null),!o.ActiveConversationId&&o.Conversations.length>0&&(o.ActiveConversationId=o.Conversations[0].Id);const u=this.ProvidersStore.LoadProviderKeys();o.Settings.Providers.Keys={...o.Settings.Providers.Keys,...u},o.Settings.Providers.KeyVisibility={},o.Settings.Providers.ValidationPopup=null;const p=this.ProvidersStore.LoadProviderModelStates();o.Settings.Providers.Providers=this.ApplyProviderModelStates(o.Settings.Providers.Providers,p);const g=this.ProvidersStore.LoadProviderAvailability();o.Settings.Providers.ModelAvailability=this.MergeAvailability(o.Settings.Providers.Providers,g),this.State=this.ResolveReasoningState(this.RefreshModelSelectorState(o)),this.Render(e),s&&this.ShowSnackbar((S=(m=(f=this.State)==null?void 0:f.Text)==null?void 0:m.ChatSaving)==null?void 0:S.StorageErrorText),this.Logger.LogFlowEnd("App.Start",{Rendered:!0})}Render(e){this.RootView.Render(e,this.State,{onToggleSidebar:()=>{this.UpdateState({IsSidebarCollapsed:!this.State.IsSidebarCollapsed})},onStartNewChat:()=>{this.RequestNewChat()},onTogglePin:()=>{this.RequestTogglePin()},onUpdatePinName:t=>{this.UpdatePinDialogName(t)},onConfirmPin:()=>{this.ConfirmPinFromDialog()},onCancelPin:()=>{this.ClosePinDialog()},onConfirmDiscard:()=>{this.ConfirmDiscard()},onCancelDiscard:()=>{this.CloseDiscardDialog()},onSelectModel:t=>{const n=this.State.Models.find(i=>i.Id===t),s={LastUserSelectedModelId:t,AutoSelectedModelId:null,DescriptionText:(n==null?void 0:n.Description)??""};this.UpdateState({SelectedModelId:t,ModelSelection:s}),this.ScheduleModelDescriptionClear()},onSelectConversation:t=>{this.RequestSelectConversation(t)},onOpenChatSearch:()=>{this.OpenChatSearch()},onCloseChatSearch:()=>{this.CloseChatSearch()},onUpdateChatSearchQuery:t=>{this.UpdateChatSearchQuery(t)},onSelectChatSearchResult:t=>{this.RequestSelectChatSearchResult(t)},onScrollConversation:t=>{const n=this.State.ActiveConversationId;n&&this.UpdateConversationScroll(n,t)},onUpdateInput:t=>{this.UpdateState({InputText:t},{Render:!1})},onSendMessage:()=>{this.SendMessageAsync().catch(t=>{this.Logger.LogError("Chat.Send.Failed",{Error:(t==null?void 0:t.message)??"Unknown error"})})},onAbortSend:()=>{this.AbortSend()},onRetryMessage:t=>{this.OpenRetryPopup(t)},onCloseRetryPopup:()=>{this.UpdateState({RetryPopup:null})},onConfirmRetry:t=>{this.ConfirmRetryAsync(t).catch(n=>{this.Logger.LogError("Chat.Retry.Failed",{Error:(n==null?void 0:n.message)??"Unknown error"})})},onToggleInternalGroup:t=>{this.ToggleInternalGroup(t)},onToggleReasoning:t=>{this.UpdateReasoningPreference((n,s)=>s.ControlType==="toggle"?{...n,Enabled:t,ToggleState:t?"on":"off"}:{...n,Enabled:t})},onSelectReasoningEffort:t=>{const n=t&&t!=="off";this.UpdateReasoningPreference(s=>({...s,Enabled:n,EffortLevel:n?t:null}))},onSelectReasoningToggle:t=>{const n=t==="on";this.UpdateReasoningPreference(s=>({...s,Enabled:n,ToggleState:t}))},onUpdateReasoningBudget:t=>{if(t===""||t==null){this.UpdateReasoningPreference(i=>({...i,Enabled:!1,TokenBudget:null}));return}const n=Number(t),s=Number.isFinite(n)&&n>=0?n:null;s!=null&&this.UpdateReasoningPreference(i=>({...i,Enabled:!0,TokenBudget:s}))},onOpenSettings:()=>{this.UpdateSettings(t=>({...t,IsOpen:!0}))},onCloseSettings:()=>{this.UpdateSettings(t=>({...t,IsOpen:!1}))},onSelectSettingsCategory:t=>{this.UpdateSettings(n=>({...n,ActiveCategory:t}))},onUpdateTheme:t=>{this.UpdateSettings(n=>({...n,General:{...n.General,Theme:t}}))},onToggleInternalMessages:t=>{this.UpdateSettings(n=>({...n,Chat:{...n.Chat,InternalChatMessages:t}}))},onUpdateAccent:t=>{this.UpdateSettings(n=>({...n,General:{...n.General,AccentColor:t}}))},onSelectProvider:t=>{this.UpdateSettings(n=>({...n,Providers:{...n.Providers,SelectedProviderId:t}}))},onBackToProviders:()=>{this.UpdateSettings(t=>({...t,Providers:{...t.Providers,SelectedProviderId:null}}))},onUpdateProviderKey:(t,n)=>{const s=this.ProvidersStore.SetProviderKey(t,n);this.State=this.RefreshModelSelectorState({...this.State,Settings:{...this.State.Settings,Providers:{...this.State.Settings.Providers,Keys:s}}}),this.ResetProviderAvailability(t)},onClearProviderKey:t=>{const n=this.ProvidersStore.ClearProviderKey(t);this.State=this.RefreshModelSelectorState({...this.State,Settings:{...this.State.Settings,Providers:{...this.State.Settings.Providers,Keys:n}}}),this.ResetProviderAvailability(t)},onToggleProviderKeyVisibility:t=>{const n=this.State.Settings.Providers.KeyVisibility??{},s={...n,[t]:!n[t]};this.UpdateSettings(i=>({...i,Providers:{...i.Providers,KeyVisibility:s}}))},onTestProviderKey:async t=>{var o;const n=((o=this.State.Settings.Providers.Keys)==null?void 0:o[t])??"",s=this.State.Settings.Providers.Providers.find(l=>l.Id===t),i=(s==null?void 0:s.Models)??[];this.UpdateSettings(l=>({...l,Providers:{...l.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"working",Message:"Testing key...",Progress:{Current:0,Total:i.length},CurrentModel:null}}}));const r=await this.ProviderValidationService.ValidateAsync(t,n);if(r.Status!=="success"){this.UpdateSettings(l=>({...l,Providers:{...l.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:r.Status,Message:r.Message}}}));return}for(let l=0;l<i.length;l+=1){const c=i[l];this.UpdateSettings(u=>({...u,Providers:{...u.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"working",Message:"Checking model availability...",Progress:{Current:l+1,Total:i.length},CurrentModel:c.Label??c.Id}}})),await this.YieldToBrowser()}this.UpdateSettings(l=>{const c=l.Providers.ModelAvailability??{},u=this.BuildModelAvailability(r.ModelIds??[],i),p={...c,[t]:u};this.ProvidersStore.SetProviderAvailability(t,u);const g=this.ApplyModelAvailability(l.Providers.Providers,t,u),d={...l,Providers:{...l.Providers,Providers:g,ModelAvailability:p,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"success",Message:r.Message}}},f=this.ResolveModelSelectionState({Providers:d.Providers.Providers,ModelAvailability:d.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:d,Models:f.Models,SelectedModelId:f.SelectedModelId,ModelSelection:f.ModelSelection}})},onCloseProviderValidationPopup:()=>{this.UpdateSettings(t=>({...t,Providers:{...t.Providers,ValidationPopup:null}}))},onToggleProviderModel:(t,n,s)=>{this.ProvidersStore.SetProviderModelState(t,n,s),this.UpdateSettings(i=>{const r=i.Providers.Providers.map(l=>l.Id!==t?l:{...l,Models:l.Models.map(c=>c.Id===n?{...c,Enabled:s}:c)}),o=this.ResolveModelSelectionState({Providers:r,ModelAvailability:i.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:{...i,Providers:{...i.Providers,Providers:r}},Models:o.Models,SelectedModelId:o.SelectedModelId,ModelSelection:o.ModelSelection}})}})}UpdateSettings(e){const t=e(this.State.Settings);if(t&&t.Settings){this.UpdateState(t);return}this.UpdateState({Settings:t})}UpdateState(e,{Render:t=!0}={}){const n={...this.State,...e};if(this.State=this.ResolveReasoningState(n),this.PersistState(),t){const s=document.getElementById("app");this.Render(s)}}UpdateReasoningPreference(e){var s;const t=(s=this.State)==null?void 0:s.Reasoning;if(!t)return;const n=this.BuildReasoningKey(t.ProviderId,t.ModelId);this.UpdateSettings(i=>{var c;const r=((c=i.Chat)==null?void 0:c.ReasoningPreferences)??{},o=r[n]??{},l=e(o,t);return{...i,Chat:{...i.Chat,ReasoningPreferences:{...r,[n]:{...l,LastUpdatedUtc:new Date().toISOString()}}}}})}ResolveReasoningState(e){var m,S,b,w;const t=(e.Models??[]).find(M=>M.Id===e.SelectedModelId);if(!t)return{...e,Reasoning:null};const n=((m=t.Capabilities)==null?void 0:m.Reasoning)??null,s=(n==null?void 0:n.Control)??null;if(!s)return{...e,Reasoning:null};const i=s.Type??null,r=(n==null?void 0:n.Signals)===!0,o=i&&i!=="implicit";if(!(o||i==="implicit"&&r))return{...e,Reasoning:null};const c=this.BuildReasoningKey(t.ProviderId,t.Id),u=((w=(b=(S=e.Settings)==null?void 0:S.Chat)==null?void 0:b.ReasoningPreferences)==null?void 0:w[c])??{},p=s.Allowed??[],g=s.Range??null,d=i==="implicit"?!!r:!1,f=u.Enabled??d;return{...e,Reasoning:{ProviderId:t.ProviderId,ModelId:t.Id,ControlType:i,Allowed:p,Range:g,Enabled:f,EffortLevel:u.EffortLevel??(p==null?void 0:p[0])??null,TokenBudget:u.TokenBudget??null,ToggleState:u.ToggleState??(p==null?void 0:p[0])??"on",IsConfigurable:o,HasSignals:r}}}BuildReasoningKey(e,t){return`${e}:${t}`}}Wr(je);Qr(je);Yr(je);Zr(je);Jr(je);class Xr{static Build(){const e=new Fs,t=new Us,n=new $s({Fetch:(...k)=>globalThis.fetch(...k),Logger:e,Paths:t}),s=new Hs,i=new Gs({Storage:globalThis.localStorage}),r=new zs({DbName:"ghostplug",StoreName:"state",Version:1}),o=new Ks({AppStateProvider:r,KeyStorage:i}),l=new qs({KeyStorage:i}),c=new Ne,u=new Ir({Logger:e}),p=new fr({Fetch:(...k)=>globalThis.fetch(...k),Logger:e,EnvironmentName:"production"}),g=new mr({Catalog:p}),d=[new vr({Fetch:(...k)=>globalThis.fetch(...k)}),new br({Fetch:(...k)=>globalThis.fetch(...k)}),new Cr({Fetch:(...k)=>globalThis.fetch(...k)}),new yr({Fetch:(...k)=>globalThis.fetch(...k)})],f=new Sr({Providers:d}),m=new Tr({Providers:d}),S=new Mr,b=new $r({Logger:e}),w=new gs,M=new Or({ChatRegistry:m,ContextBuilder:S,ChatLogger:b,Configuration:null,Fetch:(...k)=>globalThis.fetch(...k)}),x=new kr({ProviderRegistry:f,ProviderLogger:u});return{ConfigurationService:n,LoggerFactory:s,AppFactory:({Configuration:k,Logger:C})=>{var _,V;const A=new Vs({StorageProvider:r,StorageKey:((V=(_=k==null?void 0:k.Storage)==null?void 0:_.Keys)==null?void 0:V.Conversations)??"Ghostplug.Conversations"});return M.Configuration=k,new je({Configuration:k,Logger:C,RootView:c,AppStateStore:o,ProvidersStore:l,ProviderCatalogService:g,ProviderValidationService:x,ConversationStore:A,ChatService:M,ChatSearchService:w})},EnvironmentName:"production"}}}const eo=new _s(Xr.Build());eo.StartAsync();
