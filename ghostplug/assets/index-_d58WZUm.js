var Ln=Object.defineProperty;var Pn=(o,e,t)=>e in o?Ln(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var D=(o,e,t)=>Pn(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class An{constructor({ConfigurationService:e,LoggerFactory:t,AppFactory:s,EnvironmentName:n}){this.ConfigurationService=e,this.LoggerFactory=t,this.AppFactory=s,this.EnvironmentName=n}async StartAsync(){try{const e=await this.ConfigurationService.LoadAsync(this.EnvironmentName),t=this.LoggerFactory.CreateFromConfiguration(e);t.LogFlowStart("Bootstrap.Start",{EnvironmentName:this.EnvironmentName}),await this.AppFactory({Configuration:e,Logger:t}).StartAsync(),t.LogFlowEnd("Bootstrap.Start",{Success:!0})}catch(e){console.error("Bootstrap failed",e)}}}class En{Merge(e,t){if(e==null)return this.CloneValue(t);if(t==null)return this.CloneValue(e);if(Array.isArray(e)||Array.isArray(t))return this.CloneValue(t);if(typeof e=="object"&&typeof t=="object"){const s={...e};return Object.keys(t).forEach(n=>{s[n]=this.Merge(e[n],t[n])}),s}return this.CloneValue(t)}CloneValue(e){return e==null?e:JSON.parse(JSON.stringify(e))}}class Rn{constructor({Fetch:e,Logger:t,Paths:s}){this.Fetch=e,this.Logger=t,this.Paths=s,this.Merger=new En}async LoadAsync(e){this.Logger.LogFlowStart("Configuration.Load",{EnvironmentName:e});const t=await this.FetchJsonAsync(this.Paths.GetDefaultPath(),!1),s=await this.FetchJsonAsync(this.Paths.GetEnvironmentPath(e),!0),n=this.Merger.Merge(t,s);return this.Logger.LogFlowEnd("Configuration.Load",{EnvironmentName:e,HasOverrides:!!s}),n}async FetchJsonAsync(e,t){const s=await this.Fetch(e);if(!s.ok){if(t)return this.Logger.LogWarning("Configuration.Load.Missing",{Path:e}),null;throw this.Logger.LogError("Configuration.Load.Failed",{Path:e,Status:s.status}),new Error(`Configuration fetch failed for ${e}`)}return await s.json()}}class Dn{constructor({RootPath:e="/config",DefaultFileName:t="default.json",EnvironmentPrefix:s="env."}={}){this.RootPath=e,this.DefaultFileName=t,this.EnvironmentPrefix=s}GetDefaultPath(){return`${this.RootPath}/${this.DefaultFileName}`}GetEnvironmentPath(e){return`${this.RootPath}/${this.EnvironmentPrefix}${e}.json`}}const _t=Object.freeze({Trace:0,Debug:1,Information:2,Warning:3,Error:4,Critical:5}),ee=Object.freeze({Trace:"Trace",Debug:"Debug",Information:"Information",Warning:"Warning",Error:"Error",Critical:"Critical"}),Le=Object.freeze({App:"App",Logging:"Logging",Storage:"Storage",Providers:"Providers",Chat:"Chat",Ui:"Ui",Pwa:"Pwa"}),Ms=Object.freeze({Name:"Name",Version:"Version",Environment:"Environment"}),Ot=Object.freeze({MinimumLevel:"MinimumLevel",EnableDebug:"EnableDebug",MaxPayloadLength:"MaxPayloadLength"}),xs=Object.freeze({Requests:"Requests",ProviderOverrides:"ProviderOverrides"}),Ne=Object.freeze({TimeoutMs:"TimeoutMs",MaxRetries:"MaxRetries",BackoffMs:"BackoffMs",MaxOutputTokens:"MaxOutputTokens"}),_n=Object.freeze({Trace:"trace",Debug:"debug",Information:"info",Warning:"warn",Error:"error",Critical:"error"});class On{constructor(e){const t=e[Le.Logging]??{};this.MinimumLevelName=t[Ot.MinimumLevel]??ee.Information,this.EnableDebug=t[Ot.EnableDebug]??!1,this.MaxPayloadLength=t[Ot.MaxPayloadLength]??4096,this.MinimumLevel=_t[this.MinimumLevelName]??_t.Information}LogFlowStart(e,t){this.Log(ee.Information,"Flow.Start",{FlowName:e,Parameters:t})}LogFlowEnd(e,t){this.Log(ee.Information,"Flow.End",{FlowName:e,Result:t})}LogBranch(e,t,s){this.Log(ee.Debug,"Flow.Branch",{FlowName:e,Branch:t,Details:s})}LogTrace(e,t){this.Log(ee.Trace,e,t)}LogDebug(e,t){this.Log(ee.Debug,e,t)}LogInformation(e,t){this.Log(ee.Information,e,t)}LogWarning(e,t){this.Log(ee.Warning,e,t)}LogError(e,t){this.Log(ee.Error,e,t)}LogCritical(e,t){this.Log(ee.Critical,e,t)}Log(e,t,s){const n=_t[e];if(!this.IsEnabled(e,n))return;const i={Timestamp:new Date().toISOString(),Level:e,Message:t,Payload:this.TruncatePayload(s)},r=_n[e]??"log";console[r](i)}IsEnabled(e,t){return!this.EnableDebug&&(e===ee.Debug||e===ee.Trace)?!1:t>=this.MinimumLevel}TruncatePayload(e){if(e==null)return e;const t=JSON.stringify(e);return t.length<=this.MaxPayloadLength?e:{Truncated:!0,Value:`${t.slice(0,this.MaxPayloadLength)}...`}}}class $n{LogFlowStart(e,t){console.info({Timestamp:new Date().toISOString(),Level:"Information",Message:"Flow.Start",Payload:{FlowName:e,Parameters:t}})}LogFlowEnd(e,t){console.info({Timestamp:new Date().toISOString(),Level:"Information",Message:"Flow.End",Payload:{FlowName:e,Result:t}})}LogBranch(e,t,s){console.debug({Timestamp:new Date().toISOString(),Level:"Debug",Message:"Flow.Branch",Payload:{FlowName:e,Branch:t,Details:s}})}LogTrace(e,t){console.trace({Timestamp:new Date().toISOString(),Level:"Trace",Message:e,Payload:t})}LogDebug(e,t){console.debug({Timestamp:new Date().toISOString(),Level:"Debug",Message:e,Payload:t})}LogInformation(e,t){console.info({Timestamp:new Date().toISOString(),Level:"Information",Message:e,Payload:t})}LogWarning(e,t){console.warn({Timestamp:new Date().toISOString(),Level:"Warning",Message:e,Payload:t})}LogError(e,t){console.error({Timestamp:new Date().toISOString(),Level:"Error",Message:e,Payload:t})}LogCritical(e,t){console.error({Timestamp:new Date().toISOString(),Level:"Critical",Message:e,Payload:t})}}class Un{CreateFromConfiguration(e){return new On(e)}}class Nn{constructor({Storage:e}){this.Storage=e}GetJson(e){const t=this.Storage.getItem(e);return t?JSON.parse(t):null}SetJson(e,t){this.Storage.setItem(e,JSON.stringify(t))}}class Bn{constructor({DbName:e="ghostplug",StoreName:t="kv",Version:s=1}={}){this.DbName=e,this.StoreName=t,this.Version=s,this.DbPromise=null}async GetJson(e){const t=await this.OpenAsync();return new Promise((s,n)=>{const a=t.transaction(this.StoreName,"readonly").objectStore(this.StoreName).get(e);a.onsuccess=()=>s(a.result??null),a.onerror=()=>n(a.error)})}async SetJson(e,t){const s=await this.OpenAsync();return new Promise((n,i)=>{const l=s.transaction(this.StoreName,"readwrite").objectStore(this.StoreName).put(t,e);l.onsuccess=()=>n(),l.onerror=()=>i(l.error)})}OpenAsync(){return this.DbPromise?this.DbPromise:(this.DbPromise=new Promise((e,t)=>{const s=indexedDB.open(this.DbName,this.Version);s.onupgradeneeded=()=>{const n=s.result;n.objectStoreNames.contains(this.StoreName)||n.createObjectStore(this.StoreName)},s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)}),this.DbPromise)}}class Fn{constructor({AppStateProvider:e,KeyStorage:t}){this.AppStateProvider=e,this.KeyStorage=t,this.AppStateKey="ghostplug.app-state",this.ProviderKeysKey="ghostplug.provider-keys",this.ProviderModelsKey="ghostplug.provider-models"}async LoadStateAsync(){return this.AppStateProvider.GetJson(this.AppStateKey)}async SaveStateAsync(e){await this.AppStateProvider.SetJson(this.AppStateKey,e)}LoadProviderKeys(){return this.KeyStorage.GetJson(this.ProviderKeysKey)??{}}SaveProviderKeys(e){this.KeyStorage.SetJson(this.ProviderKeysKey,e??{})}LoadProviderModels(){return this.KeyStorage.GetJson(this.ProviderModelsKey)??{}}SaveProviderModels(e){this.KeyStorage.SetJson(this.ProviderModelsKey,e??{})}}class Hn{constructor({KeyStorage:e}){this.KeyStorage=e,this.ProviderKeysKey="ghostplug.provider-keys",this.ProviderModelsKey="ghostplug.provider-models",this.ProviderAvailabilityKey="ghostplug.provider-availability"}LoadProviderKeys(){return this.KeyStorage.GetJson(this.ProviderKeysKey)??{}}SaveProviderKeys(e){this.KeyStorage.SetJson(this.ProviderKeysKey,e??{})}SetProviderKey(e,t){const n={...this.LoadProviderKeys(),[e]:t};return this.SaveProviderKeys(n),n}ClearProviderKey(e){const s={...this.LoadProviderKeys(),[e]:""};return this.SaveProviderKeys(s),s}LoadProviderModelStates(){return this.KeyStorage.GetJson(this.ProviderModelsKey)??{}}SaveProviderModelStates(e){this.KeyStorage.SetJson(this.ProviderModelsKey,e??{})}SetProviderModelState(e,t,s){const n=this.LoadProviderModelStates(),i={...n[e]??{},[t]:s},r={...n,[e]:i};return this.SaveProviderModelStates(r),r}LoadProviderAvailability(){return this.KeyStorage.GetJson(this.ProviderAvailabilityKey)??{}}SaveProviderAvailability(e){this.KeyStorage.SetJson(this.ProviderAvailabilityKey,e??{})}SetProviderAvailability(e,t){const n={...this.LoadProviderAvailability(),[e]:{...t??{}}};return this.SaveProviderAvailability(n),n}}class Gn{constructor({StorageProvider:e,StorageKey:t}={}){this.StorageProvider=e,this.StorageKey=t??"Ghostplug.Conversations"}async LoadStateAsync(){var t;const e=await((t=this.StorageProvider)==null?void 0:t.GetJson(this.StorageKey));return this.NormalizeState(e)}async SaveStateAsync(e){var s;const t=this.NormalizeState(e);await((s=this.StorageProvider)==null?void 0:s.SetJson(this.StorageKey,t))}async SaveConversationAsync(e){const t=await this.LoadStateAsync(),s=this.UpsertById(t.Conversations,e);await this.SaveStateAsync({...t,Conversations:s})}async SaveMessageAsync(e){const t=await this.LoadStateAsync(),s=e.ConversationId,n=t.MessagesByConversation[s]??[],i=this.UpsertById(n,e);await this.SaveStateAsync({...t,MessagesByConversation:{...t.MessagesByConversation,[s]:i}})}async SaveMessageGroupAsync(e){const t=await this.LoadStateAsync(),s=e.ConversationId,n=t.MessageGroupsByConversation[s]??[],i=this.UpsertById(n,e);await this.SaveStateAsync({...t,MessageGroupsByConversation:{...t.MessageGroupsByConversation,[s]:i}})}async SaveScrollPositionAsync(e,t){const s=await this.LoadStateAsync(),n=(s.Conversations??[]).map(i=>i.Id===e?{...i,ScrollPosition:t}:i);await this.SaveStateAsync({...s,Conversations:n})}async SaveInternalVisibilityAsync(e,t,s){const n=await this.LoadStateAsync(),r=(n.MessageGroupsByConversation[e]??[]).map(a=>a.Id===t?{...a,InternalVisible:s}:a);await this.SaveStateAsync({...n,MessageGroupsByConversation:{...n.MessageGroupsByConversation,[e]:r}})}NormalizeState(e){return{Conversations:(e==null?void 0:e.Conversations)??[],MessagesByConversation:(e==null?void 0:e.MessagesByConversation)??{},MessageGroupsByConversation:(e==null?void 0:e.MessageGroupsByConversation)??{}}}UpsertById(e,t){const s=[...e??[]],n=s.findIndex(i=>i.Id===t.Id);return n===-1?(s.push(t),s):(s[n]=t,s)}}const tt=(o={})=>Object.entries(o).map(([e,t])=>` data-${e}="${t}"`).join(""),$t=o=>(o??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),fe=(o,e="")=>`<span class="material-symbols-outlined ${e}">${o}</span>`,yt=({Icon:o,Material:e,ClassName:t=""}={})=>!o&&!e?"":e?fe(e,t):`<img src="${o}" alt="" class="${t}" />`,Fe=({Icon:o,Material:e,Action:t,AriaLabel:s,ClassName:n="",Disabled:i=!1,Data:r={}})=>`
  <button class="icon-button ${n}" data-action="${t}" aria-label="${s}"${i?" disabled":""}${tt(r)}>
    ${yt({Icon:o,Material:e})}
  </button>
`,ft=({Icon:o,Material:e,Label:t,Action:s,ClassName:n="",LabelClass:i="",AriaLabel:r,Data:a={}})=>`
  <button class="icon-label-button ${n}" data-action="${s}" aria-label="${r??t}"${tt(a)}>
    ${yt({Icon:o,Material:e})}
    <span class="icon-label ${i}">${t}</span>
  </button>
`,zn=({Icon:o,Material:e,Title:t,Subtitle:s,Action:n,ClassName:i="",Data:r={}})=>{const a=s.toString().trim().length>0,l=yt({Icon:o,Material:e,ClassName:"two-line-icon"});return`
    <button class="two-line-item ${a?"":"two-line-item-single"} ${i}" data-action="${n}"${tt(r)}>
      ${l}
      <span class="two-line-text">
        <span class="two-line-title" title="${$t(t)}">${$t(t)}</span>
        ${a?`<span class="two-line-subtitle">${$t(s)}</span>`:""}
      </span>
    </button>
  `},dt=o=>`
  <div class="settings-form-title">${o}</div>
  <div class="settings-form-rule"></div>
`,Ts=({MenuId:o,ButtonContent:e,Items:t,SelectedValue:s})=>{const n=t.map(i=>`
      <button class="settings-dropdown-item ${i.Value===s?"is-selected":""}"${tt(i.Data)}>
        ${i.LeadingHtml??""}
        <span class="dropdown-label">${i.Label}</span>
        ${fe("check","dropdown-check")}
      </button>
    `).join("");return`
    <div class="settings-dropdown">
      <button
        class="settings-dropdown-button"
        data-action="toggle-settings-menu"
        data-menu-id="${o}"
        aria-expanded="false"
      >
        ${e}
      </button>
      <div class="settings-dropdown-menu hidden" data-settings-menu data-menu-id="${o}">
        ${n}
      </div>
    </div>
  `},Ls=({Checked:o=!1,Disabled:e=!1,Data:t={}})=>`
  <label class="model-switch">
    <input
      type="checkbox"
      class="model-checkbox"
      ${o?"checked":""}
      ${e?"disabled":""}
      ${tt(t)}
    />
    <span class="model-switch-track"></span>
  </label>
`;class Kn{Render({Conversations:e,Text:t,IsSidebarCollapsed:s}){var p;const n=s?"true":"false",r=(e??[]).filter(g=>g==null?void 0:g.IsPinned).map(g=>zn({Icon:"/assets/icons/chat_bubble_outline.svg",Title:g.Title,Subtitle:"",Action:"select-conversation",Data:{"conversation-id":g.Id},ClassName:"conversation-item"})).join(""),a=ft({Icon:"/assets/icons/add.svg",Action:"new-chat",Label:t.Sidebar.NewChat,ClassName:"sidebar-action",LabelClass:"sidebar-label"}),l=ft({Icon:"/assets/icons/search.svg",Action:"search-chats",Label:t.Sidebar.Search,ClassName:"sidebar-action",LabelClass:"sidebar-label"}),c=ft({Icon:"/assets/icons/settings.svg",Action:"open-settings",Label:t.Sidebar.Settings,ClassName:"sidebar-action",LabelClass:"settings-label"}),u=Fe({Icon:"/assets/icons/dock_to_left.svg",Action:"toggle-sidebar",AriaLabel:"Collapse sidebar",ClassName:"sidebar-toggle"});return`
      <aside class="sidebar panel-shadow flex h-full w-72 flex-col gap-4 bg-white sidebar-pad" data-collapsed="${n}">
        <div class="sidebar-header flex items-center justify-between px-1">
          <button class="brand-button flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <span class="brand-icon-wrapper relative inline-flex h-5 w-5 items-center justify-center">
              <img src="/assets/icons/logo.svg" alt="" class="brand-icon h-5 w-5" />
              <img src="/assets/icons/dock_to_left.svg" alt="" class="toggle-icon hidden h-5 w-5" />
            </span>
            <span class="brand-title font-semibold">${t.AppTitle}</span>
          </button>
          ${u}
        </div>

        <div class="sidebar-actions flex flex-col gap-2 px-1">
          ${a}
          ${l}
        </div>

        <div class="px-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
          <span class="sidebar-label">${((p=t.ChatSaving)==null?void 0:p.PinnedListTitle)??t.Sidebar.Conversations}</span>
        </div>
        <div class="flex-1 overflow-y-auto pr-1">
          <div class="flex flex-col gap-1">
            ${r}
          </div>
        </div>
        <div class="border-t border-slate-100 pt-3">
          ${c}
        </div>
      </aside>
    `}}class qn{Render({Models:e,SelectedModelId:t,Text:s,ModelSelection:n,Layout:i}){const r=e.find(f=>f.Id===t)??e[0]??{Label:"No models"},a=(n==null?void 0:n.DescriptionText)??"",l=(i==null?void 0:i.ModelDescriptionDurationMs)??5e3,c=(i==null?void 0:i.ModelDescriptionFadeOutMs)??1e3,u=Math.max(l-c,0),p=a?`style="animation: model-description-fade ${c}ms ease forwards; animation-delay: ${u}ms;"`:"",g=e.reduce((f,S)=>{const b=S.ProviderId??"default";return f.has(b)||f.set(b,{ProviderName:S.ProviderName??"",Models:[]}),f.get(b).Models.push(S),f},new Map),h=Array.from(g.values()),m=h.map((f,S)=>{const b=h.length>1&&S>0?'<div class="model-provider-divider"></div>':"",C=f.Models.map(M=>`
        <button
          class="model-item"
          data-action="select-model"
          data-model-id="${M.Id}"
          title="${M.Description??""}"
        >
          <span class="model-item-title">${M.Label}</span>
        </button>
      `).join("");return`${b}${C}`}).join("");return`
      <div class="relative">
        <button
          class="model-toggle flex items-center gap-2 text-sm font-semibold"
          data-action="toggle-models"
          aria-haspopup="listbox"
          aria-expanded="false"
        >
          <span>${r.Label}</span>
          ${fe("expand_more")}
          ${a?`<span class="model-toggle-description" ${p}>${a}</span>`:""}
        </button>
        <div
          class="model-menu settings-dropdown-menu hidden"
          data-model-menu
          role="listbox"
          aria-label="${s.ModelSelector.Label}"
        >
          ${m}
        </div>
      </div>
    `}}function Yt(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var Ae=Yt();function Ws(o){Ae=o}var et={exec:()=>null};function A(o,e=""){let t=typeof o=="string"?o:o.source,s={replace:(n,i)=>{let r=typeof i=="string"?i:i.source;return r=r.replace(W.caret,"$1"),t=t.replace(n,r),s},getRegex:()=>new RegExp(t,e)};return s}var jn=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),W={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:o=>new RegExp(`^( {0,3}${o})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:o=>new RegExp(`^ {0,${Math.min(3,o-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:o=>new RegExp(`^ {0,${Math.min(3,o-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:o=>new RegExp(`^ {0,${Math.min(3,o-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:o=>new RegExp(`^ {0,${Math.min(3,o-1)}}#`),htmlBeginRegex:o=>new RegExp(`^ {0,${Math.min(3,o-1)}}<(?:[a-z].*>|!--)`,"i")},Vn=/^(?:[ \t]*(?:\n|$))+/,Wn=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Qn=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,st=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,Yn=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Zt=/(?:[*+-]|\d{1,9}[.)])/,Qs=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,Ys=A(Qs).replace(/bull/g,Zt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Zn=A(Qs).replace(/bull/g,Zt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Jt=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Jn=/^[^\n]+/,Xt=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,Xn=A(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Xt).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),ei=A(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Zt).getRegex(),It="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",es=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,ti=A("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",es).replace("tag",It).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Zs=A(Jt).replace("hr",st).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",It).getRegex(),si=A(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Zs).getRegex(),ts={blockquote:si,code:Wn,def:Xn,fences:Qn,heading:Yn,hr:st,html:ti,lheading:Ys,list:ei,newline:Vn,paragraph:Zs,table:et,text:Jn},Ps=A("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",st).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",It).getRegex(),ni={...ts,lheading:Zn,table:Ps,paragraph:A(Jt).replace("hr",st).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Ps).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",It).getRegex()},ii={...ts,html:A(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",es).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:et,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:A(Jt).replace("hr",st).replace("heading",` *#{1,6} *[^
]`).replace("lheading",Ys).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},ri=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,ai=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Js=/^( {2,}|\\)\n(?!\s*$)/,oi=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,kt=/[\p{P}\p{S}]/u,ss=/[\s\p{P}\p{S}]/u,Xs=/[^\s\p{P}\p{S}]/u,li=A(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,ss).getRegex(),en=/(?!~)[\p{P}\p{S}]/u,ci=/(?!~)[\s\p{P}\p{S}]/u,di=/(?:[^\s\p{P}\p{S}]|~)/u,ui=A(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",jn?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),tn=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,hi=A(tn,"u").replace(/punct/g,kt).getRegex(),pi=A(tn,"u").replace(/punct/g,en).getRegex(),sn="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",gi=A(sn,"gu").replace(/notPunctSpace/g,Xs).replace(/punctSpace/g,ss).replace(/punct/g,kt).getRegex(),fi=A(sn,"gu").replace(/notPunctSpace/g,di).replace(/punctSpace/g,ci).replace(/punct/g,en).getRegex(),mi=A("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Xs).replace(/punctSpace/g,ss).replace(/punct/g,kt).getRegex(),Si=A(/\\(punct)/,"gu").replace(/punct/g,kt).getRegex(),vi=A(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),bi=A(es).replace("(?:-->|$)","-->").getRegex(),Ci=A("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",bi).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),St=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,yi=A(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",St).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),nn=A(/^!?\[(label)\]\[(ref)\]/).replace("label",St).replace("ref",Xt).getRegex(),rn=A(/^!?\[(ref)\](?:\[\])?/).replace("ref",Xt).getRegex(),Ii=A("reflink|nolink(?!\\()","g").replace("reflink",nn).replace("nolink",rn).getRegex(),As=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,ns={_backpedal:et,anyPunctuation:Si,autolink:vi,blockSkip:ui,br:Js,code:ai,del:et,emStrongLDelim:hi,emStrongRDelimAst:gi,emStrongRDelimUnd:mi,escape:ri,link:yi,nolink:rn,punctuation:li,reflink:nn,reflinkSearch:Ii,tag:Ci,text:oi,url:et},ki={...ns,link:A(/^!?\[(label)\]\((.*?)\)/).replace("label",St).getRegex(),reflink:A(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",St).getRegex()},Kt={...ns,emStrongRDelimAst:fi,emStrongLDelim:pi,url:A(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",As).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:A(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",As).getRegex()},wi={...Kt,br:A(Js).replace("{2,}","*").getRegex(),text:A(Kt.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},ut={normal:ts,gfm:ni,pedantic:ii},Ke={normal:ns,gfm:Kt,breaks:wi,pedantic:ki},Mi={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Es=o=>Mi[o];function ge(o,e){if(e){if(W.escapeTest.test(o))return o.replace(W.escapeReplace,Es)}else if(W.escapeTestNoEncode.test(o))return o.replace(W.escapeReplaceNoEncode,Es);return o}function Rs(o){try{o=encodeURI(o).replace(W.percentDecode,"%")}catch{return null}return o}function Ds(o,e){var i;let t=o.replace(W.findPipe,(r,a,l)=>{let c=!1,u=a;for(;--u>=0&&l[u]==="\\";)c=!c;return c?"|":" |"}),s=t.split(W.splitPipe),n=0;if(s[0].trim()||s.shift(),s.length>0&&!((i=s.at(-1))!=null&&i.trim())&&s.pop(),e)if(s.length>e)s.splice(e);else for(;s.length<e;)s.push("");for(;n<s.length;n++)s[n]=s[n].trim().replace(W.slashPipe,"|");return s}function qe(o,e,t){let s=o.length;if(s===0)return"";let n=0;for(;n<s&&o.charAt(s-n-1)===e;)n++;return o.slice(0,s-n)}function xi(o,e){if(o.indexOf(e[1])===-1)return-1;let t=0;for(let s=0;s<o.length;s++)if(o[s]==="\\")s++;else if(o[s]===e[0])t++;else if(o[s]===e[1]&&(t--,t<0))return s;return t>0?-2:-1}function _s(o,e,t,s,n){let i=e.href,r=e.title||null,a=o[1].replace(n.other.outputLinkReplace,"$1");s.state.inLink=!0;let l={type:o[0].charAt(0)==="!"?"image":"link",raw:t,href:i,title:r,text:a,tokens:s.inlineTokens(a)};return s.state.inLink=!1,l}function Ti(o,e,t){let s=o.match(t.other.indentCodeCompensation);if(s===null)return e;let n=s[1];return e.split(`
`).map(i=>{let r=i.match(t.other.beginningSpace);if(r===null)return i;let[a]=r;return a.length>=n.length?i.slice(n.length):i}).join(`
`)}var vt=class{constructor(o){D(this,"options");D(this,"rules");D(this,"lexer");this.options=o||Ae}space(o){let e=this.rules.block.newline.exec(o);if(e&&e[0].length>0)return{type:"space",raw:e[0]}}code(o){let e=this.rules.block.code.exec(o);if(e){let t=e[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:e[0],codeBlockStyle:"indented",text:this.options.pedantic?t:qe(t,`
`)}}}fences(o){let e=this.rules.block.fences.exec(o);if(e){let t=e[0],s=Ti(t,e[3]||"",this.rules);return{type:"code",raw:t,lang:e[2]?e[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):e[2],text:s}}}heading(o){let e=this.rules.block.heading.exec(o);if(e){let t=e[2].trim();if(this.rules.other.endingHash.test(t)){let s=qe(t,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(t=s.trim())}return{type:"heading",raw:e[0],depth:e[1].length,text:t,tokens:this.lexer.inline(t)}}}hr(o){let e=this.rules.block.hr.exec(o);if(e)return{type:"hr",raw:qe(e[0],`
`)}}blockquote(o){let e=this.rules.block.blockquote.exec(o);if(e){let t=qe(e[0],`
`).split(`
`),s="",n="",i=[];for(;t.length>0;){let r=!1,a=[],l;for(l=0;l<t.length;l++)if(this.rules.other.blockquoteStart.test(t[l]))a.push(t[l]),r=!0;else if(!r)a.push(t[l]);else break;t=t.slice(l);let c=a.join(`
`),u=c.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${c}`:c,n=n?`${n}
${u}`:u;let p=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(u,i,!0),this.lexer.state.top=p,t.length===0)break;let g=i.at(-1);if((g==null?void 0:g.type)==="code")break;if((g==null?void 0:g.type)==="blockquote"){let h=g,m=h.raw+`
`+t.join(`
`),f=this.blockquote(m);i[i.length-1]=f,s=s.substring(0,s.length-h.raw.length)+f.raw,n=n.substring(0,n.length-h.text.length)+f.text;break}else if((g==null?void 0:g.type)==="list"){let h=g,m=h.raw+`
`+t.join(`
`),f=this.list(m);i[i.length-1]=f,s=s.substring(0,s.length-g.raw.length)+f.raw,n=n.substring(0,n.length-h.raw.length)+f.raw,t=m.substring(i.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:i,text:n}}}list(o){var t,s;let e=this.rules.block.list.exec(o);if(e){let n=e[1].trim(),i=n.length>1,r={type:"list",raw:"",ordered:i,start:i?+n.slice(0,-1):"",loose:!1,items:[]};n=i?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=i?n:"[*+-]");let a=this.rules.other.listItemRegex(n),l=!1;for(;o;){let u=!1,p="",g="";if(!(e=a.exec(o))||this.rules.block.hr.test(o))break;p=e[0],o=o.substring(p.length);let h=e[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,b=>" ".repeat(3*b.length)),m=o.split(`
`,1)[0],f=!h.trim(),S=0;if(this.options.pedantic?(S=2,g=h.trimStart()):f?S=e[1].length+1:(S=e[2].search(this.rules.other.nonSpaceChar),S=S>4?1:S,g=h.slice(S),S+=e[1].length),f&&this.rules.other.blankLine.test(m)&&(p+=m+`
`,o=o.substring(m.length+1),u=!0),!u){let b=this.rules.other.nextBulletRegex(S),C=this.rules.other.hrRegex(S),M=this.rules.other.fencesBeginRegex(S),T=this.rules.other.headingBeginRegex(S),I=this.rules.other.htmlBeginRegex(S);for(;o;){let k=o.split(`
`,1)[0],R;if(m=k,this.options.pedantic?(m=m.replace(this.rules.other.listReplaceNesting,"  "),R=m):R=m.replace(this.rules.other.tabCharGlobal,"    "),M.test(m)||T.test(m)||I.test(m)||b.test(m)||C.test(m))break;if(R.search(this.rules.other.nonSpaceChar)>=S||!m.trim())g+=`
`+R.slice(S);else{if(f||h.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||M.test(h)||T.test(h)||C.test(h))break;g+=`
`+m}!f&&!m.trim()&&(f=!0),p+=k+`
`,o=o.substring(k.length+1),h=R.slice(S)}}r.loose||(l?r.loose=!0:this.rules.other.doubleBlankLine.test(p)&&(l=!0)),r.items.push({type:"list_item",raw:p,task:!!this.options.gfm&&this.rules.other.listIsTask.test(g),loose:!1,text:g,tokens:[]}),r.raw+=p}let c=r.items.at(-1);if(c)c.raw=c.raw.trimEnd(),c.text=c.text.trimEnd();else return;r.raw=r.raw.trimEnd();for(let u of r.items){if(this.lexer.state.top=!1,u.tokens=this.lexer.blockTokens(u.text,[]),u.task){if(u.text=u.text.replace(this.rules.other.listReplaceTask,""),((t=u.tokens[0])==null?void 0:t.type)==="text"||((s=u.tokens[0])==null?void 0:s.type)==="paragraph"){u.tokens[0].raw=u.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),u.tokens[0].text=u.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let g=this.lexer.inlineQueue.length-1;g>=0;g--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[g].src)){this.lexer.inlineQueue[g].src=this.lexer.inlineQueue[g].src.replace(this.rules.other.listReplaceTask,"");break}}let p=this.rules.other.listTaskCheckbox.exec(u.raw);if(p){let g={type:"checkbox",raw:p[0]+" ",checked:p[0]!=="[ ]"};u.checked=g.checked,r.loose?u.tokens[0]&&["paragraph","text"].includes(u.tokens[0].type)&&"tokens"in u.tokens[0]&&u.tokens[0].tokens?(u.tokens[0].raw=g.raw+u.tokens[0].raw,u.tokens[0].text=g.raw+u.tokens[0].text,u.tokens[0].tokens.unshift(g)):u.tokens.unshift({type:"paragraph",raw:g.raw,text:g.raw,tokens:[g]}):u.tokens.unshift(g)}}if(!r.loose){let p=u.tokens.filter(h=>h.type==="space"),g=p.length>0&&p.some(h=>this.rules.other.anyLine.test(h.raw));r.loose=g}}if(r.loose)for(let u of r.items){u.loose=!0;for(let p of u.tokens)p.type==="text"&&(p.type="paragraph")}return r}}html(o){let e=this.rules.block.html.exec(o);if(e)return{type:"html",block:!0,raw:e[0],pre:e[1]==="pre"||e[1]==="script"||e[1]==="style",text:e[0]}}def(o){let e=this.rules.block.def.exec(o);if(e){let t=e[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=e[2]?e[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",n=e[3]?e[3].substring(1,e[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):e[3];return{type:"def",tag:t,raw:e[0],href:s,title:n}}}table(o){var r;let e=this.rules.block.table.exec(o);if(!e||!this.rules.other.tableDelimiter.test(e[2]))return;let t=Ds(e[1]),s=e[2].replace(this.rules.other.tableAlignChars,"").split("|"),n=(r=e[3])!=null&&r.trim()?e[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],i={type:"table",raw:e[0],header:[],align:[],rows:[]};if(t.length===s.length){for(let a of s)this.rules.other.tableAlignRight.test(a)?i.align.push("right"):this.rules.other.tableAlignCenter.test(a)?i.align.push("center"):this.rules.other.tableAlignLeft.test(a)?i.align.push("left"):i.align.push(null);for(let a=0;a<t.length;a++)i.header.push({text:t[a],tokens:this.lexer.inline(t[a]),header:!0,align:i.align[a]});for(let a of n)i.rows.push(Ds(a,i.header.length).map((l,c)=>({text:l,tokens:this.lexer.inline(l),header:!1,align:i.align[c]})));return i}}lheading(o){let e=this.rules.block.lheading.exec(o);if(e)return{type:"heading",raw:e[0],depth:e[2].charAt(0)==="="?1:2,text:e[1],tokens:this.lexer.inline(e[1])}}paragraph(o){let e=this.rules.block.paragraph.exec(o);if(e){let t=e[1].charAt(e[1].length-1)===`
`?e[1].slice(0,-1):e[1];return{type:"paragraph",raw:e[0],text:t,tokens:this.lexer.inline(t)}}}text(o){let e=this.rules.block.text.exec(o);if(e)return{type:"text",raw:e[0],text:e[0],tokens:this.lexer.inline(e[0])}}escape(o){let e=this.rules.inline.escape.exec(o);if(e)return{type:"escape",raw:e[0],text:e[1]}}tag(o){let e=this.rules.inline.tag.exec(o);if(e)return!this.lexer.state.inLink&&this.rules.other.startATag.test(e[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(e[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(e[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(e[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:e[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:e[0]}}link(o){let e=this.rules.inline.link.exec(o);if(e){let t=e[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(t)){if(!this.rules.other.endAngleBracket.test(t))return;let i=qe(t.slice(0,-1),"\\");if((t.length-i.length)%2===0)return}else{let i=xi(e[2],"()");if(i===-2)return;if(i>-1){let r=(e[0].indexOf("!")===0?5:4)+e[1].length+i;e[2]=e[2].substring(0,i),e[0]=e[0].substring(0,r).trim(),e[3]=""}}let s=e[2],n="";if(this.options.pedantic){let i=this.rules.other.pedanticHrefTitle.exec(s);i&&(s=i[1],n=i[3])}else n=e[3]?e[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(t)?s=s.slice(1):s=s.slice(1,-1)),_s(e,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:n&&n.replace(this.rules.inline.anyPunctuation,"$1")},e[0],this.lexer,this.rules)}}reflink(o,e){let t;if((t=this.rules.inline.reflink.exec(o))||(t=this.rules.inline.nolink.exec(o))){let s=(t[2]||t[1]).replace(this.rules.other.multipleSpaceGlobal," "),n=e[s.toLowerCase()];if(!n){let i=t[0].charAt(0);return{type:"text",raw:i,text:i}}return _s(t,n,t[0],this.lexer,this.rules)}}emStrong(o,e,t=""){let s=this.rules.inline.emStrongLDelim.exec(o);if(!(!s||s[3]&&t.match(this.rules.other.unicodeAlphaNumeric))&&(!(s[1]||s[2])||!t||this.rules.inline.punctuation.exec(t))){let n=[...s[0]].length-1,i,r,a=n,l=0,c=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,e=e.slice(-1*o.length+n);(s=c.exec(e))!=null;){if(i=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!i)continue;if(r=[...i].length,s[3]||s[4]){a+=r;continue}else if((s[5]||s[6])&&n%3&&!((n+r)%3)){l+=r;continue}if(a-=r,a>0)continue;r=Math.min(r,r+a+l);let u=[...s[0]][0].length,p=o.slice(0,n+s.index+u+r);if(Math.min(n,r)%2){let h=p.slice(1,-1);return{type:"em",raw:p,text:h,tokens:this.lexer.inlineTokens(h)}}let g=p.slice(2,-2);return{type:"strong",raw:p,text:g,tokens:this.lexer.inlineTokens(g)}}}}codespan(o){let e=this.rules.inline.code.exec(o);if(e){let t=e[2].replace(this.rules.other.newLineCharGlobal," "),s=this.rules.other.nonSpaceChar.test(t),n=this.rules.other.startingSpaceChar.test(t)&&this.rules.other.endingSpaceChar.test(t);return s&&n&&(t=t.substring(1,t.length-1)),{type:"codespan",raw:e[0],text:t}}}br(o){let e=this.rules.inline.br.exec(o);if(e)return{type:"br",raw:e[0]}}del(o){let e=this.rules.inline.del.exec(o);if(e)return{type:"del",raw:e[0],text:e[2],tokens:this.lexer.inlineTokens(e[2])}}autolink(o){let e=this.rules.inline.autolink.exec(o);if(e){let t,s;return e[2]==="@"?(t=e[1],s="mailto:"+t):(t=e[1],s=t),{type:"link",raw:e[0],text:t,href:s,tokens:[{type:"text",raw:t,text:t}]}}}url(o){var t;let e;if(e=this.rules.inline.url.exec(o)){let s,n;if(e[2]==="@")s=e[0],n="mailto:"+s;else{let i;do i=e[0],e[0]=((t=this.rules.inline._backpedal.exec(e[0]))==null?void 0:t[0])??"";while(i!==e[0]);s=e[0],e[1]==="www."?n="http://"+e[0]:n=e[0]}return{type:"link",raw:e[0],text:s,href:n,tokens:[{type:"text",raw:s,text:s}]}}}inlineText(o){let e=this.rules.inline.text.exec(o);if(e){let t=this.lexer.state.inRawBlock;return{type:"text",raw:e[0],text:e[0],escaped:t}}}},re=class qt{constructor(e){D(this,"tokens");D(this,"options");D(this,"state");D(this,"inlineQueue");D(this,"tokenizer");this.tokens=[],this.tokens.links=Object.create(null),this.options=e||Ae,this.options.tokenizer=this.options.tokenizer||new vt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let t={other:W,block:ut.normal,inline:Ke.normal};this.options.pedantic?(t.block=ut.pedantic,t.inline=Ke.pedantic):this.options.gfm&&(t.block=ut.gfm,this.options.breaks?t.inline=Ke.breaks:t.inline=Ke.gfm),this.tokenizer.rules=t}static get rules(){return{block:ut,inline:Ke}}static lex(e,t){return new qt(t).lex(e)}static lexInline(e,t){return new qt(t).inlineTokens(e)}lex(e){e=e.replace(W.carriageReturn,`
`),this.blockTokens(e,this.tokens);for(let t=0;t<this.inlineQueue.length;t++){let s=this.inlineQueue[t];this.inlineTokens(s.src,s.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],s=!1){var n,i,r;for(this.options.pedantic&&(e=e.replace(W.tabCharGlobal,"    ").replace(W.spaceLine,""));e;){let a;if((i=(n=this.options.extensions)==null?void 0:n.block)!=null&&i.some(c=>(a=c.call({lexer:this},e,t))?(e=e.substring(a.raw.length),t.push(a),!0):!1))continue;if(a=this.tokenizer.space(e)){e=e.substring(a.raw.length);let c=t.at(-1);a.raw.length===1&&c!==void 0?c.raw+=`
`:t.push(a);continue}if(a=this.tokenizer.code(e)){e=e.substring(a.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+a.raw,c.text+=`
`+a.text,this.inlineQueue.at(-1).src=c.text):t.push(a);continue}if(a=this.tokenizer.fences(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.heading(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.hr(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.blockquote(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.list(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.html(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.def(e)){e=e.substring(a.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="paragraph"||(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+a.raw,c.text+=`
`+a.raw,this.inlineQueue.at(-1).src=c.text):this.tokens.links[a.tag]||(this.tokens.links[a.tag]={href:a.href,title:a.title},t.push(a));continue}if(a=this.tokenizer.table(e)){e=e.substring(a.raw.length),t.push(a);continue}if(a=this.tokenizer.lheading(e)){e=e.substring(a.raw.length),t.push(a);continue}let l=e;if((r=this.options.extensions)!=null&&r.startBlock){let c=1/0,u=e.slice(1),p;this.options.extensions.startBlock.forEach(g=>{p=g.call({lexer:this},u),typeof p=="number"&&p>=0&&(c=Math.min(c,p))}),c<1/0&&c>=0&&(l=e.substring(0,c+1))}if(this.state.top&&(a=this.tokenizer.paragraph(l))){let c=t.at(-1);s&&(c==null?void 0:c.type)==="paragraph"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+a.raw,c.text+=`
`+a.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(a),s=l.length!==e.length,e=e.substring(a.raw.length);continue}if(a=this.tokenizer.text(e)){e=e.substring(a.raw.length);let c=t.at(-1);(c==null?void 0:c.type)==="text"?(c.raw+=(c.raw.endsWith(`
`)?"":`
`)+a.raw,c.text+=`
`+a.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=c.text):t.push(a);continue}if(e){let c="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(c);break}else throw new Error(c)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){var l,c,u,p,g;let s=e,n=null;if(this.tokens.links){let h=Object.keys(this.tokens.links);if(h.length>0)for(;(n=this.tokenizer.rules.inline.reflinkSearch.exec(s))!=null;)h.includes(n[0].slice(n[0].lastIndexOf("[")+1,-1))&&(s=s.slice(0,n.index)+"["+"a".repeat(n[0].length-2)+"]"+s.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(n=this.tokenizer.rules.inline.anyPunctuation.exec(s))!=null;)s=s.slice(0,n.index)+"++"+s.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let i;for(;(n=this.tokenizer.rules.inline.blockSkip.exec(s))!=null;)i=n[2]?n[2].length:0,s=s.slice(0,n.index+i)+"["+"a".repeat(n[0].length-i-2)+"]"+s.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);s=((c=(l=this.options.hooks)==null?void 0:l.emStrongMask)==null?void 0:c.call({lexer:this},s))??s;let r=!1,a="";for(;e;){r||(a=""),r=!1;let h;if((p=(u=this.options.extensions)==null?void 0:u.inline)!=null&&p.some(f=>(h=f.call({lexer:this},e,t))?(e=e.substring(h.raw.length),t.push(h),!0):!1))continue;if(h=this.tokenizer.escape(e)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.tag(e)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.link(e)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(h.raw.length);let f=t.at(-1);h.type==="text"&&(f==null?void 0:f.type)==="text"?(f.raw+=h.raw,f.text+=h.text):t.push(h);continue}if(h=this.tokenizer.emStrong(e,s,a)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.codespan(e)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.br(e)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.del(e)){e=e.substring(h.raw.length),t.push(h);continue}if(h=this.tokenizer.autolink(e)){e=e.substring(h.raw.length),t.push(h);continue}if(!this.state.inLink&&(h=this.tokenizer.url(e))){e=e.substring(h.raw.length),t.push(h);continue}let m=e;if((g=this.options.extensions)!=null&&g.startInline){let f=1/0,S=e.slice(1),b;this.options.extensions.startInline.forEach(C=>{b=C.call({lexer:this},S),typeof b=="number"&&b>=0&&(f=Math.min(f,b))}),f<1/0&&f>=0&&(m=e.substring(0,f+1))}if(h=this.tokenizer.inlineText(m)){e=e.substring(h.raw.length),h.raw.slice(-1)!=="_"&&(a=h.raw.slice(-1)),r=!0;let f=t.at(-1);(f==null?void 0:f.type)==="text"?(f.raw+=h.raw,f.text+=h.text):t.push(h);continue}if(e){let f="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(f);break}else throw new Error(f)}}return t}},bt=class{constructor(o){D(this,"options");D(this,"parser");this.options=o||Ae}space(o){return""}code({text:o,lang:e,escaped:t}){var i;let s=(i=(e||"").match(W.notSpaceStart))==null?void 0:i[0],n=o.replace(W.endingNewline,"")+`
`;return s?'<pre><code class="language-'+ge(s)+'">'+(t?n:ge(n,!0))+`</code></pre>
`:"<pre><code>"+(t?n:ge(n,!0))+`</code></pre>
`}blockquote({tokens:o}){return`<blockquote>
${this.parser.parse(o)}</blockquote>
`}html({text:o}){return o}def(o){return""}heading({tokens:o,depth:e}){return`<h${e}>${this.parser.parseInline(o)}</h${e}>
`}hr(o){return`<hr>
`}list(o){let e=o.ordered,t=o.start,s="";for(let r=0;r<o.items.length;r++){let a=o.items[r];s+=this.listitem(a)}let n=e?"ol":"ul",i=e&&t!==1?' start="'+t+'"':"";return"<"+n+i+`>
`+s+"</"+n+`>
`}listitem(o){return`<li>${this.parser.parse(o.tokens)}</li>
`}checkbox({checked:o}){return"<input "+(o?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:o}){return`<p>${this.parser.parseInline(o)}</p>
`}table(o){let e="",t="";for(let n=0;n<o.header.length;n++)t+=this.tablecell(o.header[n]);e+=this.tablerow({text:t});let s="";for(let n=0;n<o.rows.length;n++){let i=o.rows[n];t="";for(let r=0;r<i.length;r++)t+=this.tablecell(i[r]);s+=this.tablerow({text:t})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+e+`</thead>
`+s+`</table>
`}tablerow({text:o}){return`<tr>
${o}</tr>
`}tablecell(o){let e=this.parser.parseInline(o.tokens),t=o.header?"th":"td";return(o.align?`<${t} align="${o.align}">`:`<${t}>`)+e+`</${t}>
`}strong({tokens:o}){return`<strong>${this.parser.parseInline(o)}</strong>`}em({tokens:o}){return`<em>${this.parser.parseInline(o)}</em>`}codespan({text:o}){return`<code>${ge(o,!0)}</code>`}br(o){return"<br>"}del({tokens:o}){return`<del>${this.parser.parseInline(o)}</del>`}link({href:o,title:e,tokens:t}){let s=this.parser.parseInline(t),n=Rs(o);if(n===null)return s;o=n;let i='<a href="'+o+'"';return e&&(i+=' title="'+ge(e)+'"'),i+=">"+s+"</a>",i}image({href:o,title:e,text:t,tokens:s}){s&&(t=this.parser.parseInline(s,this.parser.textRenderer));let n=Rs(o);if(n===null)return ge(t);o=n;let i=`<img src="${o}" alt="${t}"`;return e&&(i+=` title="${ge(e)}"`),i+=">",i}text(o){return"tokens"in o&&o.tokens?this.parser.parseInline(o.tokens):"escaped"in o&&o.escaped?o.text:ge(o.text)}},is=class{strong({text:o}){return o}em({text:o}){return o}codespan({text:o}){return o}del({text:o}){return o}html({text:o}){return o}text({text:o}){return o}link({text:o}){return""+o}image({text:o}){return""+o}br(){return""}checkbox({raw:o}){return o}},ae=class jt{constructor(e){D(this,"options");D(this,"renderer");D(this,"textRenderer");this.options=e||Ae,this.options.renderer=this.options.renderer||new bt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new is}static parse(e,t){return new jt(t).parse(e)}static parseInline(e,t){return new jt(t).parseInline(e)}parse(e){var s,n;let t="";for(let i=0;i<e.length;i++){let r=e[i];if((n=(s=this.options.extensions)==null?void 0:s.renderers)!=null&&n[r.type]){let l=r,c=this.options.extensions.renderers[l.type].call({parser:this},l);if(c!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(l.type)){t+=c||"";continue}}let a=r;switch(a.type){case"space":{t+=this.renderer.space(a);break}case"hr":{t+=this.renderer.hr(a);break}case"heading":{t+=this.renderer.heading(a);break}case"code":{t+=this.renderer.code(a);break}case"table":{t+=this.renderer.table(a);break}case"blockquote":{t+=this.renderer.blockquote(a);break}case"list":{t+=this.renderer.list(a);break}case"checkbox":{t+=this.renderer.checkbox(a);break}case"html":{t+=this.renderer.html(a);break}case"def":{t+=this.renderer.def(a);break}case"paragraph":{t+=this.renderer.paragraph(a);break}case"text":{t+=this.renderer.text(a);break}default:{let l='Token with "'+a.type+'" type was not found.';if(this.options.silent)return console.error(l),"";throw new Error(l)}}}return t}parseInline(e,t=this.renderer){var n,i;let s="";for(let r=0;r<e.length;r++){let a=e[r];if((i=(n=this.options.extensions)==null?void 0:n.renderers)!=null&&i[a.type]){let c=this.options.extensions.renderers[a.type].call({parser:this},a);if(c!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(a.type)){s+=c||"";continue}}let l=a;switch(l.type){case"escape":{s+=t.text(l);break}case"html":{s+=t.html(l);break}case"link":{s+=t.link(l);break}case"image":{s+=t.image(l);break}case"checkbox":{s+=t.checkbox(l);break}case"strong":{s+=t.strong(l);break}case"em":{s+=t.em(l);break}case"codespan":{s+=t.codespan(l);break}case"br":{s+=t.br(l);break}case"del":{s+=t.del(l);break}case"text":{s+=t.text(l);break}default:{let c='Token with "'+l.type+'" type was not found.';if(this.options.silent)return console.error(c),"";throw new Error(c)}}}return s}},gt,Je=(gt=class{constructor(o){D(this,"options");D(this,"block");this.options=o||Ae}preprocess(o){return o}postprocess(o){return o}processAllTokens(o){return o}emStrongMask(o){return o}provideLexer(){return this.block?re.lex:re.lexInline}provideParser(){return this.block?ae.parse:ae.parseInline}},D(gt,"passThroughHooks",new Set(["preprocess","postprocess","processAllTokens","emStrongMask"])),D(gt,"passThroughHooksRespectAsync",new Set(["preprocess","postprocess","processAllTokens"])),gt),Li=class{constructor(...o){D(this,"defaults",Yt());D(this,"options",this.setOptions);D(this,"parse",this.parseMarkdown(!0));D(this,"parseInline",this.parseMarkdown(!1));D(this,"Parser",ae);D(this,"Renderer",bt);D(this,"TextRenderer",is);D(this,"Lexer",re);D(this,"Tokenizer",vt);D(this,"Hooks",Je);this.use(...o)}walkTokens(o,e){var s,n;let t=[];for(let i of o)switch(t=t.concat(e.call(this,i)),i.type){case"table":{let r=i;for(let a of r.header)t=t.concat(this.walkTokens(a.tokens,e));for(let a of r.rows)for(let l of a)t=t.concat(this.walkTokens(l.tokens,e));break}case"list":{let r=i;t=t.concat(this.walkTokens(r.items,e));break}default:{let r=i;(n=(s=this.defaults.extensions)==null?void 0:s.childTokens)!=null&&n[r.type]?this.defaults.extensions.childTokens[r.type].forEach(a=>{let l=r[a].flat(1/0);t=t.concat(this.walkTokens(l,e))}):r.tokens&&(t=t.concat(this.walkTokens(r.tokens,e)))}}return t}use(...o){let e=this.defaults.extensions||{renderers:{},childTokens:{}};return o.forEach(t=>{let s={...t};if(s.async=this.defaults.async||s.async||!1,t.extensions&&(t.extensions.forEach(n=>{if(!n.name)throw new Error("extension name required");if("renderer"in n){let i=e.renderers[n.name];i?e.renderers[n.name]=function(...r){let a=n.renderer.apply(this,r);return a===!1&&(a=i.apply(this,r)),a}:e.renderers[n.name]=n.renderer}if("tokenizer"in n){if(!n.level||n.level!=="block"&&n.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let i=e[n.level];i?i.unshift(n.tokenizer):e[n.level]=[n.tokenizer],n.start&&(n.level==="block"?e.startBlock?e.startBlock.push(n.start):e.startBlock=[n.start]:n.level==="inline"&&(e.startInline?e.startInline.push(n.start):e.startInline=[n.start]))}"childTokens"in n&&n.childTokens&&(e.childTokens[n.name]=n.childTokens)}),s.extensions=e),t.renderer){let n=this.defaults.renderer||new bt(this.defaults);for(let i in t.renderer){if(!(i in n))throw new Error(`renderer '${i}' does not exist`);if(["options","parser"].includes(i))continue;let r=i,a=t.renderer[r],l=n[r];n[r]=(...c)=>{let u=a.apply(n,c);return u===!1&&(u=l.apply(n,c)),u||""}}s.renderer=n}if(t.tokenizer){let n=this.defaults.tokenizer||new vt(this.defaults);for(let i in t.tokenizer){if(!(i in n))throw new Error(`tokenizer '${i}' does not exist`);if(["options","rules","lexer"].includes(i))continue;let r=i,a=t.tokenizer[r],l=n[r];n[r]=(...c)=>{let u=a.apply(n,c);return u===!1&&(u=l.apply(n,c)),u}}s.tokenizer=n}if(t.hooks){let n=this.defaults.hooks||new Je;for(let i in t.hooks){if(!(i in n))throw new Error(`hook '${i}' does not exist`);if(["options","block"].includes(i))continue;let r=i,a=t.hooks[r],l=n[r];Je.passThroughHooks.has(i)?n[r]=c=>{if(this.defaults.async&&Je.passThroughHooksRespectAsync.has(i))return(async()=>{let p=await a.call(n,c);return l.call(n,p)})();let u=a.call(n,c);return l.call(n,u)}:n[r]=(...c)=>{if(this.defaults.async)return(async()=>{let p=await a.apply(n,c);return p===!1&&(p=await l.apply(n,c)),p})();let u=a.apply(n,c);return u===!1&&(u=l.apply(n,c)),u}}s.hooks=n}if(t.walkTokens){let n=this.defaults.walkTokens,i=t.walkTokens;s.walkTokens=function(r){let a=[];return a.push(i.call(this,r)),n&&(a=a.concat(n.call(this,r))),a}}this.defaults={...this.defaults,...s}}),this}setOptions(o){return this.defaults={...this.defaults,...o},this}lexer(o,e){return re.lex(o,e??this.defaults)}parser(o,e){return ae.parse(o,e??this.defaults)}parseMarkdown(o){return(e,t)=>{let s={...t},n={...this.defaults,...s},i=this.onError(!!n.silent,!!n.async);if(this.defaults.async===!0&&s.async===!1)return i(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof e>"u"||e===null)return i(new Error("marked(): input parameter is undefined or null"));if(typeof e!="string")return i(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(e)+", string expected"));if(n.hooks&&(n.hooks.options=n,n.hooks.block=o),n.async)return(async()=>{let r=n.hooks?await n.hooks.preprocess(e):e,a=await(n.hooks?await n.hooks.provideLexer():o?re.lex:re.lexInline)(r,n),l=n.hooks?await n.hooks.processAllTokens(a):a;n.walkTokens&&await Promise.all(this.walkTokens(l,n.walkTokens));let c=await(n.hooks?await n.hooks.provideParser():o?ae.parse:ae.parseInline)(l,n);return n.hooks?await n.hooks.postprocess(c):c})().catch(i);try{n.hooks&&(e=n.hooks.preprocess(e));let r=(n.hooks?n.hooks.provideLexer():o?re.lex:re.lexInline)(e,n);n.hooks&&(r=n.hooks.processAllTokens(r)),n.walkTokens&&this.walkTokens(r,n.walkTokens);let a=(n.hooks?n.hooks.provideParser():o?ae.parse:ae.parseInline)(r,n);return n.hooks&&(a=n.hooks.postprocess(a)),a}catch(r){return i(r)}}}onError(o,e){return t=>{if(t.message+=`
Please report this to https://github.com/markedjs/marked.`,o){let s="<p>An error occurred:</p><pre>"+ge(t.message+"",!0)+"</pre>";return e?Promise.resolve(s):s}if(e)return Promise.reject(t);throw t}}},Pe=new Li;function E(o,e){return Pe.parse(o,e)}E.options=E.setOptions=function(o){return Pe.setOptions(o),E.defaults=Pe.defaults,Ws(E.defaults),E};E.getDefaults=Yt;E.defaults=Ae;E.use=function(...o){return Pe.use(...o),E.defaults=Pe.defaults,Ws(E.defaults),E};E.walkTokens=function(o,e){return Pe.walkTokens(o,e)};E.parseInline=Pe.parseInline;E.Parser=ae;E.parser=ae.parse;E.Renderer=bt;E.TextRenderer=is;E.Lexer=re;E.lexer=re.lex;E.Tokenizer=vt;E.Hooks=Je;E.parse=E;E.options;E.setOptions;E.use;E.walkTokens;E.parseInline;ae.parse;re.lex;/*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE */const{entries:an,setPrototypeOf:Os,isFrozen:Pi,getPrototypeOf:Ai,getOwnPropertyDescriptor:Ei}=Object;let{freeze:Q,seal:te,create:Vt}=Object,{apply:Wt,construct:Qt}=typeof Reflect<"u"&&Reflect;Q||(Q=function(e){return e});te||(te=function(e){return e});Wt||(Wt=function(e,t){for(var s=arguments.length,n=new Array(s>2?s-2:0),i=2;i<s;i++)n[i-2]=arguments[i];return e.apply(t,n)});Qt||(Qt=function(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];return new e(...s)});const ht=Y(Array.prototype.forEach),Ri=Y(Array.prototype.lastIndexOf),$s=Y(Array.prototype.pop),je=Y(Array.prototype.push),Di=Y(Array.prototype.splice),mt=Y(String.prototype.toLowerCase),Ut=Y(String.prototype.toString),Nt=Y(String.prototype.match),Ve=Y(String.prototype.replace),_i=Y(String.prototype.indexOf),Oi=Y(String.prototype.trim),ne=Y(Object.prototype.hasOwnProperty),V=Y(RegExp.prototype.test),We=$i(TypeError);function Y(o){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,s=new Array(t>1?t-1:0),n=1;n<t;n++)s[n-1]=arguments[n];return Wt(o,e,s)}}function $i(o){return function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return Qt(o,t)}}function L(o,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:mt;Os&&Os(o,null);let s=e.length;for(;s--;){let n=e[s];if(typeof n=="string"){const i=t(n);i!==n&&(Pi(e)||(e[s]=i),n=i)}o[n]=!0}return o}function Ui(o){for(let e=0;e<o.length;e++)ne(o,e)||(o[e]=null);return o}function ce(o){const e=Vt(null);for(const[t,s]of an(o))ne(o,t)&&(Array.isArray(s)?e[t]=Ui(s):s&&typeof s=="object"&&s.constructor===Object?e[t]=ce(s):e[t]=s);return e}function Qe(o,e){for(;o!==null;){const s=Ei(o,e);if(s){if(s.get)return Y(s.get);if(typeof s.value=="function")return Y(s.value)}o=Ai(o)}function t(){return null}return t}const Us=Q(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Bt=Q(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),Ft=Q(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Ni=Q(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),Ht=Q(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Bi=Q(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),Ns=Q(["#text"]),Bs=Q(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Gt=Q(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),Fs=Q(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),pt=Q(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),Fi=te(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Hi=te(/<%[\w\W]*|[\w\W]*%>/gm),Gi=te(/\$\{[\w\W]*/gm),zi=te(/^data-[\-\w.\u00B7-\uFFFF]+$/),Ki=te(/^aria-[\-\w]+$/),on=te(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),qi=te(/^(?:\w+script|data):/i),ji=te(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),ln=te(/^html$/i),Vi=te(/^[a-z][.\w]*(-[.\w]+)+$/i);var Hs=Object.freeze({__proto__:null,ARIA_ATTR:Ki,ATTR_WHITESPACE:ji,CUSTOM_ELEMENT:Vi,DATA_ATTR:zi,DOCTYPE_NAME:ln,ERB_EXPR:Hi,IS_ALLOWED_URI:on,IS_SCRIPT_OR_DATA:qi,MUSTACHE_EXPR:Fi,TMPLIT_EXPR:Gi});const Ye={element:1,text:3,progressingInstruction:7,comment:8,document:9},Wi=function(){return typeof window>"u"?null:window},Qi=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let s=null;const n="data-tt-policy-suffix";t&&t.hasAttribute(n)&&(s=t.getAttribute(n));const i="dompurify"+(s?"#"+s:"");try{return e.createPolicy(i,{createHTML(r){return r},createScriptURL(r){return r}})}catch{return console.warn("TrustedTypes policy "+i+" could not be created."),null}},Gs=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function cn(){let o=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Wi();const e=w=>cn(w);if(e.version="3.3.1",e.removed=[],!o||!o.document||o.document.nodeType!==Ye.document||!o.Element)return e.isSupported=!1,e;let{document:t}=o;const s=t,n=s.currentScript,{DocumentFragment:i,HTMLTemplateElement:r,Node:a,Element:l,NodeFilter:c,NamedNodeMap:u=o.NamedNodeMap||o.MozNamedAttrMap,HTMLFormElement:p,DOMParser:g,trustedTypes:h}=o,m=l.prototype,f=Qe(m,"cloneNode"),S=Qe(m,"remove"),b=Qe(m,"nextSibling"),C=Qe(m,"childNodes"),M=Qe(m,"parentNode");if(typeof r=="function"){const w=t.createElement("template");w.content&&w.content.ownerDocument&&(t=w.content.ownerDocument)}let T,I="";const{implementation:k,createNodeIterator:R,createDocumentFragment:z,getElementsByTagName:K}=t,{importNode:P}=s;let _=Gs();e.isSupported=typeof an=="function"&&typeof M=="function"&&k&&k.createHTMLDocument!==void 0;const{MUSTACHE_EXPR:Z,ERB_EXPR:F,TMPLIT_EXPR:X,DATA_ATTR:ye,ARIA_ATTR:Ie,IS_SCRIPT_OR_DATA:ke,ATTR_WHITESPACE:me,CUSTOM_ELEMENT:we}=Hs;let{IS_ALLOWED_URI:Se}=Hs,$=null;const ve=L({},[...Us,...Bt,...Ft,...Ht,...Ns]);let N=null;const be=L({},[...Bs,...Gt,...Fs,...pt]);let O=Object.seal(Vt(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),se=null,x=null;const B=Object.seal(Vt(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}}));let Ce=!0,Me=!0,as=!1,os=!0,Re=!1,nt=!0,xe=!1,wt=!1,Mt=!1,De=!1,it=!1,rt=!1,ls=!0,cs=!1;const Cn="user-content-";let xt=!0,Ge=!1,_e={},oe=null;const Tt=L({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]);let ds=null;const us=L({},["audio","video","img","source","image","track"]);let Lt=null;const hs=L({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),at="http://www.w3.org/1998/Math/MathML",ot="http://www.w3.org/2000/svg",ue="http://www.w3.org/1999/xhtml";let Oe=ue,Pt=!1,At=null;const yn=L({},[at,ot,ue],Ut);let lt=L({},["mi","mo","mn","ms","mtext"]),ct=L({},["annotation-xml"]);const In=L({},["title","style","font","a","script"]);let ze=null;const kn=["application/xhtml+xml","text/html"],wn="text/html";let G=null,$e=null;const Mn=t.createElement("form"),ps=function(d){return d instanceof RegExp||d instanceof Function},Et=function(){let d=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!($e&&$e===d)){if((!d||typeof d!="object")&&(d={}),d=ce(d),ze=kn.indexOf(d.PARSER_MEDIA_TYPE)===-1?wn:d.PARSER_MEDIA_TYPE,G=ze==="application/xhtml+xml"?Ut:mt,$=ne(d,"ALLOWED_TAGS")?L({},d.ALLOWED_TAGS,G):ve,N=ne(d,"ALLOWED_ATTR")?L({},d.ALLOWED_ATTR,G):be,At=ne(d,"ALLOWED_NAMESPACES")?L({},d.ALLOWED_NAMESPACES,Ut):yn,Lt=ne(d,"ADD_URI_SAFE_ATTR")?L(ce(hs),d.ADD_URI_SAFE_ATTR,G):hs,ds=ne(d,"ADD_DATA_URI_TAGS")?L(ce(us),d.ADD_DATA_URI_TAGS,G):us,oe=ne(d,"FORBID_CONTENTS")?L({},d.FORBID_CONTENTS,G):Tt,se=ne(d,"FORBID_TAGS")?L({},d.FORBID_TAGS,G):ce({}),x=ne(d,"FORBID_ATTR")?L({},d.FORBID_ATTR,G):ce({}),_e=ne(d,"USE_PROFILES")?d.USE_PROFILES:!1,Ce=d.ALLOW_ARIA_ATTR!==!1,Me=d.ALLOW_DATA_ATTR!==!1,as=d.ALLOW_UNKNOWN_PROTOCOLS||!1,os=d.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Re=d.SAFE_FOR_TEMPLATES||!1,nt=d.SAFE_FOR_XML!==!1,xe=d.WHOLE_DOCUMENT||!1,De=d.RETURN_DOM||!1,it=d.RETURN_DOM_FRAGMENT||!1,rt=d.RETURN_TRUSTED_TYPE||!1,Mt=d.FORCE_BODY||!1,ls=d.SANITIZE_DOM!==!1,cs=d.SANITIZE_NAMED_PROPS||!1,xt=d.KEEP_CONTENT!==!1,Ge=d.IN_PLACE||!1,Se=d.ALLOWED_URI_REGEXP||on,Oe=d.NAMESPACE||ue,lt=d.MATHML_TEXT_INTEGRATION_POINTS||lt,ct=d.HTML_INTEGRATION_POINTS||ct,O=d.CUSTOM_ELEMENT_HANDLING||{},d.CUSTOM_ELEMENT_HANDLING&&ps(d.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(O.tagNameCheck=d.CUSTOM_ELEMENT_HANDLING.tagNameCheck),d.CUSTOM_ELEMENT_HANDLING&&ps(d.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(O.attributeNameCheck=d.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),d.CUSTOM_ELEMENT_HANDLING&&typeof d.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(O.allowCustomizedBuiltInElements=d.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Re&&(Me=!1),it&&(De=!0),_e&&($=L({},Ns),N=[],_e.html===!0&&(L($,Us),L(N,Bs)),_e.svg===!0&&(L($,Bt),L(N,Gt),L(N,pt)),_e.svgFilters===!0&&(L($,Ft),L(N,Gt),L(N,pt)),_e.mathMl===!0&&(L($,Ht),L(N,Fs),L(N,pt))),d.ADD_TAGS&&(typeof d.ADD_TAGS=="function"?B.tagCheck=d.ADD_TAGS:($===ve&&($=ce($)),L($,d.ADD_TAGS,G))),d.ADD_ATTR&&(typeof d.ADD_ATTR=="function"?B.attributeCheck=d.ADD_ATTR:(N===be&&(N=ce(N)),L(N,d.ADD_ATTR,G))),d.ADD_URI_SAFE_ATTR&&L(Lt,d.ADD_URI_SAFE_ATTR,G),d.FORBID_CONTENTS&&(oe===Tt&&(oe=ce(oe)),L(oe,d.FORBID_CONTENTS,G)),d.ADD_FORBID_CONTENTS&&(oe===Tt&&(oe=ce(oe)),L(oe,d.ADD_FORBID_CONTENTS,G)),xt&&($["#text"]=!0),xe&&L($,["html","head","body"]),$.table&&(L($,["tbody"]),delete se.tbody),d.TRUSTED_TYPES_POLICY){if(typeof d.TRUSTED_TYPES_POLICY.createHTML!="function")throw We('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof d.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw We('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');T=d.TRUSTED_TYPES_POLICY,I=T.createHTML("")}else T===void 0&&(T=Qi(h,n)),T!==null&&typeof I=="string"&&(I=T.createHTML(""));Q&&Q(d),$e=d}},gs=L({},[...Bt,...Ft,...Ni]),fs=L({},[...Ht,...Bi]),xn=function(d){let v=M(d);(!v||!v.tagName)&&(v={namespaceURI:Oe,tagName:"template"});const y=mt(d.tagName),U=mt(v.tagName);return At[d.namespaceURI]?d.namespaceURI===ot?v.namespaceURI===ue?y==="svg":v.namespaceURI===at?y==="svg"&&(U==="annotation-xml"||lt[U]):!!gs[y]:d.namespaceURI===at?v.namespaceURI===ue?y==="math":v.namespaceURI===ot?y==="math"&&ct[U]:!!fs[y]:d.namespaceURI===ue?v.namespaceURI===ot&&!ct[U]||v.namespaceURI===at&&!lt[U]?!1:!fs[y]&&(In[y]||!gs[y]):!!(ze==="application/xhtml+xml"&&At[d.namespaceURI]):!1},le=function(d){je(e.removed,{element:d});try{M(d).removeChild(d)}catch{S(d)}},Te=function(d,v){try{je(e.removed,{attribute:v.getAttributeNode(d),from:v})}catch{je(e.removed,{attribute:null,from:v})}if(v.removeAttribute(d),d==="is")if(De||it)try{le(v)}catch{}else try{v.setAttribute(d,"")}catch{}},ms=function(d){let v=null,y=null;if(Mt)d="<remove></remove>"+d;else{const H=Nt(d,/^[\r\n\t ]+/);y=H&&H[0]}ze==="application/xhtml+xml"&&Oe===ue&&(d='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+d+"</body></html>");const U=T?T.createHTML(d):d;if(Oe===ue)try{v=new g().parseFromString(U,ze)}catch{}if(!v||!v.documentElement){v=k.createDocument(Oe,"template",null);try{v.documentElement.innerHTML=Pt?I:U}catch{}}const j=v.body||v.documentElement;return d&&y&&j.insertBefore(t.createTextNode(y),j.childNodes[0]||null),Oe===ue?K.call(v,xe?"html":"body")[0]:xe?v.documentElement:j},Ss=function(d){return R.call(d.ownerDocument||d,d,c.SHOW_ELEMENT|c.SHOW_COMMENT|c.SHOW_TEXT|c.SHOW_PROCESSING_INSTRUCTION|c.SHOW_CDATA_SECTION,null)},Rt=function(d){return d instanceof p&&(typeof d.nodeName!="string"||typeof d.textContent!="string"||typeof d.removeChild!="function"||!(d.attributes instanceof u)||typeof d.removeAttribute!="function"||typeof d.setAttribute!="function"||typeof d.namespaceURI!="string"||typeof d.insertBefore!="function"||typeof d.hasChildNodes!="function")},vs=function(d){return typeof a=="function"&&d instanceof a};function he(w,d,v){ht(w,y=>{y.call(e,d,v,$e)})}const bs=function(d){let v=null;if(he(_.beforeSanitizeElements,d,null),Rt(d))return le(d),!0;const y=G(d.nodeName);if(he(_.uponSanitizeElement,d,{tagName:y,allowedTags:$}),nt&&d.hasChildNodes()&&!vs(d.firstElementChild)&&V(/<[/\w!]/g,d.innerHTML)&&V(/<[/\w!]/g,d.textContent)||d.nodeType===Ye.progressingInstruction||nt&&d.nodeType===Ye.comment&&V(/<[/\w]/g,d.data))return le(d),!0;if(!(B.tagCheck instanceof Function&&B.tagCheck(y))&&(!$[y]||se[y])){if(!se[y]&&ys(y)&&(O.tagNameCheck instanceof RegExp&&V(O.tagNameCheck,y)||O.tagNameCheck instanceof Function&&O.tagNameCheck(y)))return!1;if(xt&&!oe[y]){const U=M(d)||d.parentNode,j=C(d)||d.childNodes;if(j&&U){const H=j.length;for(let J=H-1;J>=0;--J){const pe=f(j[J],!0);pe.__removalCount=(d.__removalCount||0)+1,U.insertBefore(pe,b(d))}}}return le(d),!0}return d instanceof l&&!xn(d)||(y==="noscript"||y==="noembed"||y==="noframes")&&V(/<\/no(script|embed|frames)/i,d.innerHTML)?(le(d),!0):(Re&&d.nodeType===Ye.text&&(v=d.textContent,ht([Z,F,X],U=>{v=Ve(v,U," ")}),d.textContent!==v&&(je(e.removed,{element:d.cloneNode()}),d.textContent=v)),he(_.afterSanitizeElements,d,null),!1)},Cs=function(d,v,y){if(ls&&(v==="id"||v==="name")&&(y in t||y in Mn))return!1;if(!(Me&&!x[v]&&V(ye,v))){if(!(Ce&&V(Ie,v))){if(!(B.attributeCheck instanceof Function&&B.attributeCheck(v,d))){if(!N[v]||x[v]){if(!(ys(d)&&(O.tagNameCheck instanceof RegExp&&V(O.tagNameCheck,d)||O.tagNameCheck instanceof Function&&O.tagNameCheck(d))&&(O.attributeNameCheck instanceof RegExp&&V(O.attributeNameCheck,v)||O.attributeNameCheck instanceof Function&&O.attributeNameCheck(v,d))||v==="is"&&O.allowCustomizedBuiltInElements&&(O.tagNameCheck instanceof RegExp&&V(O.tagNameCheck,y)||O.tagNameCheck instanceof Function&&O.tagNameCheck(y))))return!1}else if(!Lt[v]){if(!V(Se,Ve(y,me,""))){if(!((v==="src"||v==="xlink:href"||v==="href")&&d!=="script"&&_i(y,"data:")===0&&ds[d])){if(!(as&&!V(ke,Ve(y,me,"")))){if(y)return!1}}}}}}}return!0},ys=function(d){return d!=="annotation-xml"&&Nt(d,we)},Is=function(d){he(_.beforeSanitizeAttributes,d,null);const{attributes:v}=d;if(!v||Rt(d))return;const y={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:N,forceKeepAttr:void 0};let U=v.length;for(;U--;){const j=v[U],{name:H,namespaceURI:J,value:pe}=j,Ue=G(H),Dt=pe;let q=H==="value"?Dt:Oi(Dt);if(y.attrName=Ue,y.attrValue=q,y.keepAttr=!0,y.forceKeepAttr=void 0,he(_.uponSanitizeAttribute,d,y),q=y.attrValue,cs&&(Ue==="id"||Ue==="name")&&(Te(H,d),q=Cn+q),nt&&V(/((--!?|])>)|<\/(style|title|textarea)/i,q)){Te(H,d);continue}if(Ue==="attributename"&&Nt(q,"href")){Te(H,d);continue}if(y.forceKeepAttr)continue;if(!y.keepAttr){Te(H,d);continue}if(!os&&V(/\/>/i,q)){Te(H,d);continue}Re&&ht([Z,F,X],ws=>{q=Ve(q,ws," ")});const ks=G(d.nodeName);if(!Cs(ks,Ue,q)){Te(H,d);continue}if(T&&typeof h=="object"&&typeof h.getAttributeType=="function"&&!J)switch(h.getAttributeType(ks,Ue)){case"TrustedHTML":{q=T.createHTML(q);break}case"TrustedScriptURL":{q=T.createScriptURL(q);break}}if(q!==Dt)try{J?d.setAttributeNS(J,H,q):d.setAttribute(H,q),Rt(d)?le(d):$s(e.removed)}catch{Te(H,d)}}he(_.afterSanitizeAttributes,d,null)},Tn=function w(d){let v=null;const y=Ss(d);for(he(_.beforeSanitizeShadowDOM,d,null);v=y.nextNode();)he(_.uponSanitizeShadowNode,v,null),bs(v),Is(v),v.content instanceof i&&w(v.content);he(_.afterSanitizeShadowDOM,d,null)};return e.sanitize=function(w){let d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},v=null,y=null,U=null,j=null;if(Pt=!w,Pt&&(w="<!-->"),typeof w!="string"&&!vs(w))if(typeof w.toString=="function"){if(w=w.toString(),typeof w!="string")throw We("dirty is not a string, aborting")}else throw We("toString is not a function");if(!e.isSupported)return w;if(wt||Et(d),e.removed=[],typeof w=="string"&&(Ge=!1),Ge){if(w.nodeName){const pe=G(w.nodeName);if(!$[pe]||se[pe])throw We("root node is forbidden and cannot be sanitized in-place")}}else if(w instanceof a)v=ms("<!---->"),y=v.ownerDocument.importNode(w,!0),y.nodeType===Ye.element&&y.nodeName==="BODY"||y.nodeName==="HTML"?v=y:v.appendChild(y);else{if(!De&&!Re&&!xe&&w.indexOf("<")===-1)return T&&rt?T.createHTML(w):w;if(v=ms(w),!v)return De?null:rt?I:""}v&&Mt&&le(v.firstChild);const H=Ss(Ge?w:v);for(;U=H.nextNode();)bs(U),Is(U),U.content instanceof i&&Tn(U.content);if(Ge)return w;if(De){if(it)for(j=z.call(v.ownerDocument);v.firstChild;)j.appendChild(v.firstChild);else j=v;return(N.shadowroot||N.shadowrootmode)&&(j=P.call(s,j,!0)),j}let J=xe?v.outerHTML:v.innerHTML;return xe&&$["!doctype"]&&v.ownerDocument&&v.ownerDocument.doctype&&v.ownerDocument.doctype.name&&V(ln,v.ownerDocument.doctype.name)&&(J="<!DOCTYPE "+v.ownerDocument.doctype.name+`>
`+J),Re&&ht([Z,F,X],pe=>{J=Ve(J,pe," ")}),T&&rt?T.createHTML(J):J},e.setConfig=function(){let w=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Et(w),wt=!0},e.clearConfig=function(){$e=null,wt=!1},e.isValidAttribute=function(w,d,v){$e||Et({});const y=G(w),U=G(d);return Cs(y,U,v)},e.addHook=function(w,d){typeof d=="function"&&je(_[w],d)},e.removeHook=function(w,d){if(d!==void 0){const v=Ri(_[w],d);return v===-1?void 0:Di(_[w],v,1)[0]}return $s(_[w])},e.removeHooks=function(w){_[w]=[]},e.removeAllHooks=function(){_=Gs()},e}var Yi=cn();class Zi{Render(e){const t=E.parse(e??"",{breaks:!0});return Yi.sanitize(t)}}class Ji{constructor(){this.MarkdownRenderer=new Zi}RenderWelcome({Text:e}){return`
      <div class="flex h-full flex-col items-center justify-center text-center">
        <h1 class="text-3xl font-semibold text-slate-900">${e.WelcomeHeading}</h1>
      </div>
    `}RenderConversation({Messages:e,MessageGroups:t,Settings:s,Text:n}){const i=new Map((e??[]).map(a=>[a.Id,a]));return t!=null&&t.length?`
        <div class="chat-thread flex flex-col gap-4">
          ${t.map(l=>{var S;const c=i.get(l.UserMessageId),u=i.get(l.AssistantMessageId),p=l.InternalMessageIds??[],g=p.length,h=((S=s==null?void 0:s.Chat)==null?void 0:S.InternalChatMessages)&&g>0,m=h?`
            <button class="internal-summary" data-action="toggle-internal-group" data-group-id="${l.Id}">
              ${g} internal messages
            </button>
          `:"",f=h&&l.InternalVisible?`
            <div class="internal-messages">
              ${p.map(b=>i.get(b)).filter(Boolean).map(b=>`
                    <div class="internal-message">
                      ${this.MarkdownRenderer.Render(b.Content)}
                    </div>
                  `).join("")}
            </div>
          `:"";return`
          <div class="flex flex-col gap-3">
            ${c?this.RenderUserMessage(c):""}
            ${m}
            ${f}
            ${u?this.RenderAssistantMessage(u,n):""}
          </div>
        `}).join("")}
        </div>
      `:`
      <div class="chat-thread flex flex-col gap-4">
        ${(e??[]).map(a=>a.Role==="User"?this.RenderUserMessage(a):this.RenderAssistantMessage(a,n)).join("")}
      </div>
    `}RenderUserMessage(e){return`
      <div class="flex justify-end">
        <div class="user-bubble max-w-[70%] px-4 py-2 text-sm">
          ${this.MarkdownRenderer.Render(e.Content)}
        </div>
      </div>
    `}RenderAssistantMessage(e,t){var n;if(e.Status==="pending")return`
        <div class="assistant-block">
          <div class="assistant-pending text-sm" data-chat-pending>
            <span class="material-symbols-outlined pending-spinner">autorenew</span>
            <span>${(t==null?void 0:t.PendingMessage)??"Waiting for response..."}</span>
          </div>
        </div>
      `;if(e.Status==="aborted"){const i=this.RenderAssistantMeta(e,{Prefix:"Aborted"});return`
        <div class="assistant-block">
          ${(e.Content??"").trim().length>0?`
            <div class="assistant-text text-sm text-slate-800">
              ${this.MarkdownRenderer.Render(e.Content??"")}
            </div>
          `:""}
          <div class="assistant-pending text-sm" data-chat-aborted>
            <span class="material-symbols-outlined">close</span>
            <span>${((n=t==null?void 0:t.Chat)==null?void 0:n.AbortedMessageText)??"Response aborted."}</span>
          </div>
          ${i}
        </div>
      `}if(e.Status==="error"){const i=e.ProviderId??"provider",r=e.ModelId??"model";return`
        <div class="assistant-block">
          <div class="assistant-error" data-chat-error>
            <div class="assistant-error-header">Request failed · ${i} / ${r}</div>
            <div class="assistant-error-message">${e.ErrorMessage??"Request failed."}</div>
            <button class="settings-secondary-button" data-action="retry-message" data-message-id="${e.Id}">
              ${(t==null?void 0:t.RetryAction)??"Retry"}
            </button>
          </div>
        </div>
      `}const s=e.Status==="done"?this.RenderAssistantMeta(e):"";return`
      <div class="assistant-block">
        <div class="assistant-text text-sm text-slate-800">
          ${this.MarkdownRenderer.Render(e.Content)}
        </div>
        ${s}
      </div>
    `}RenderAssistantMeta(e,{Prefix:t}={}){const s=(e==null?void 0:e.Metrics)??{},n=this.FormatDuration(s.DurationMs),i=this.FormatTokenCount(s.InputTokens),r=this.FormatTokenCount(s.OutputTokens);return`
      <div class="assistant-meta" data-assistant-meta>
        ${t?`
        <span>${t}</span>
        <span class="assistant-meta-dot">·</span>
      `:""}
        <span>Time ${n}</span>
        <span class="assistant-meta-dot">·</span>
        <span>In ${i}</span>
        <span class="assistant-meta-dot">·</span>
        <span>Out ${r}</span>
      </div>
    `}FormatDuration(e){if(typeof e!="number")return"--";const t=Math.max(e,0)/1e3;return t<1?`${Math.round(t*1e3)}ms`:`${t.toFixed(1)}s`}FormatTokenCount(e){return typeof e!="number"?"--":`${e}`}}class Xi{Render({Text:e,InputText:t="",IsSending:s=!1,SelectedModelId:n}){const i=Fe({Icon:"/assets/icons/add.svg",Action:"toggle-attachments",AriaLabel:"Attachments",ClassName:"input-attach"}),r=ft({Icon:"/assets/icons/attach_file.svg",Action:"attach-files",Label:e.Attachments.AttachFiles,ClassName:"attachments-item"}),a=(t??"").trim().length>0,c=Fe(s?{Material:"close",Action:"abort-response",AriaLabel:"Abort",ClassName:"input-send"}:{Material:"keyboard_arrow_up",Action:"send-message",AriaLabel:"Send",ClassName:"input-send",Disabled:!a||!(n===void 0?!0:!!n)});return`
      <div class="input-wrapper relative">
        <div class="input-shell" data-input-shell>
          ${i}
          <textarea
            class="input-text"
            data-action="chat-input"
            rows="1"
            placeholder="${e.InputPlaceholder}"
            aria-label="Chat input"
          >${t}</textarea>
          ${c}
        </div>
        <div class="attachments-menu hidden" data-attachments-menu>
          ${r}
        </div>
      </div>
    `}}class er{constructor({DurationMs:e}){this.DurationMs=e,this.Container=null,this.MessageNode=null,this.TimeoutId=null}Render(){return`
      <div class="pointer-events-none fixed inset-x-0 bottom-6 z-50 flex justify-center">
        <div
          data-snackbar
          class="snackbar-hidden rounded-full bg-slate-900 px-4 py-2 text-sm text-white shadow-lg transition-all duration-200"
          role="status"
          aria-live="polite"
        >
          <span data-snackbar-message></span>
        </div>
      </div>
    `}Mount(e){this.Container=e.querySelector("[data-snackbar]"),this.MessageNode=e.querySelector("[data-snackbar-message]")}Show(e){!this.Container||!this.MessageNode||(this.MessageNode.textContent=e,this.Container.classList.remove("snackbar-hidden"),this.Container.classList.add("snackbar-visible"),this.TimeoutId&&clearTimeout(this.TimeoutId),this.TimeoutId=setTimeout(()=>{this.Container.classList.remove("snackbar-visible"),this.Container.classList.add("snackbar-hidden")},this.DurationMs))}}const tr=[{Id:"general",Label:"General",IconMaterial:"tune"},{Id:"chat",Label:"Chat",IconMaterial:"chat_bubble"},{Id:"providers",Label:"Providers",IconMaterial:"hub"}];class sr{Render(e){const t=e.ActiveCategory,s=e.Options.Accents.find(r=>r.Id===e.General.AccentColor)??e.Options.Accents[0],n=e.Options.Themes.find(r=>r.Id===e.General.Theme)??e.Options.Themes[0],i=tr.map(r=>`
      <button
        class="settings-nav-item ${r.Id===t?"is-active":""}"
        data-action="settings-category"
        data-category="${r.Id}"
      >
        <span class="settings-nav-icon">
          ${fe(r.IconMaterial)}
        </span>
        ${r.Label}
      </button>
    `).join("");return`
      <div class="settings-overlay ${e.IsOpen?"":"hidden"}" data-settings-overlay>
        <div class="settings-backdrop" data-action="close-settings" aria-hidden="true"></div>
        <div class="settings-panel" role="dialog" aria-modal="true" aria-label="Settings">
          <div class="settings-body">
            <aside class="settings-nav">
              ${Fe({Material:"close",Action:"close-settings",AriaLabel:"Close settings",ClassName:"settings-close"})}
              ${i}
            </aside>
            <section class="settings-content">
              ${this.RenderCategory(e,{activeAccent:s,activeTheme:n})}
            </section>
          </div>
        </div>
      </div>
    `}RenderCategory(e,t){return e.ActiveCategory==="providers"?this.RenderProviders(e.Providers):e.ActiveCategory==="chat"?this.RenderChat(e):this.RenderGeneral(e,t)}RenderGeneral(e,{activeAccent:t,activeTheme:s}){const n=e.Options.Themes.map(l=>({Label:l.Label,Value:l.Id,Data:{action:"select-settings-option",field:"theme",value:l.Id}})),i=e.Options.Accents.map(l=>({Label:l.Label,Value:l.Id,LeadingHtml:`<span class="accent-swatch" style="--accent-swatch: ${l.Hex};"></span>`,Data:{action:"select-settings-option",field:"accent",value:l.Id}})),r=Ts({MenuId:"theme",ButtonContent:`
        <span>${s.Label}</span>
        ${fe("expand_more")}
      `,Items:n,SelectedValue:s.Id}),a=Ts({MenuId:"accent",ButtonContent:`
        <span class="accent-swatch" style="--accent-swatch: ${t.Hex};"></span>
        <span>${t.Label}</span>
        ${fe("expand_more")}
      `,Items:i,SelectedValue:t.Id});return`
      <div class="settings-section">
        ${dt("Appearance")}
        <div class="settings-row">
          <div class="settings-row-label">Theme</div>
          <div class="settings-row-control">
            ${r}
          </div>
        </div>
        <div class="settings-row">
          <div class="settings-row-label">Accent Colour</div>
          <div class="settings-row-control">
            ${a}
          </div>
        </div>
      </div>
    `}RenderChat(e){const t=Ls({Checked:e.Chat.InternalChatMessages,Data:{action:"toggle-internal-messages"}});return`
      <div class="settings-section">
        ${dt("Chat")}
        <div class="settings-row">
          <div class="settings-row-label">Internal chat messages</div>
          <div class="settings-row-control">
            ${t}
          </div>
        </div>
      </div>
    `}RenderProviders(e){var r,a;if(!e.SelectedProviderId)return this.RenderProviderList(e.Providers);const t=e.Providers.find(l=>l.Id===e.SelectedProviderId);if(!t)return this.RenderProviderList(e.Providers);const s=e.Keys[t.Id]??"",n=((r=e.KeyVisibility)==null?void 0:r[t.Id])??!1,i=((a=e.ModelAvailability)==null?void 0:a[t.Id])??null;return this.RenderProviderDetail(t,s,n,i)}RenderProviderList(e){const t=e.map(s=>`
      <button class="provider-row" data-action="select-provider" data-provider-id="${s.Id}">
        <span class="provider-icon">
          ${yt({Icon:s.Icon})}
        </span>
        <span class="provider-name">${s.Name}</span>
        <span class="provider-arrow">
          ${fe("chevron_right")}
        </span>
      </button>
    `).join("");return`
      <div class="settings-section">
        ${dt("Providers")}
        <div class="provider-list">
          ${t}
        </div>
      </div>
    `}RenderProviderDetail(e,t,s,n){const i=s?"text":"password",r=s?"visibility_off":"visibility",a=e.Models.map(l=>{const c=n==null?void 0:n[l.Id],u=n?!c:!0,p=Ls({Checked:l.Enabled,Disabled:u,Data:{action:"toggle-provider-model","provider-id":e.Id,"model-id":l.Id}});return`
        <div class="${u?"model-row is-unavailable":l.Enabled?"model-row":"model-row is-disabled"}">
          <div class="model-info">
            <div class="model-name">${l.Label}</div>
            <div class="model-description">${l.Description??""}</div>
          </div>
          ${p}
        </div>
      `}).join("");return`
      <div class="settings-section">
        <button class="provider-back" data-action="back-provider" type="button">
          ${fe("arrow_back")}
          <span>Back</span>
        </button>
        ${dt(`${e.Name} Provider Details`)}
        <div class="settings-row settings-row-stack settings-row-borderless">
          <div class="settings-row-label">API Key</div>
          <div class="settings-row-control">
            <div class="settings-input-row">
              <div class="settings-input-wrap">
                <input
                  type="${i}"
                  class="settings-input"
                  placeholder="Paste your key"
                  value="${t}"
                  data-action="update-provider-key"
                  data-provider-id="${e.Id}"
                />
                <button
                  class="settings-input-icon"
                  data-action="toggle-provider-key-visibility"
                  data-provider-id="${e.Id}"
                  type="button"
                  aria-label="Toggle key visibility"
                >
                  ${fe(r)}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-divider"></div>
        <div class="settings-subsection-header">
          <div class="settings-subsection-title">Available models</div>
          <button class="settings-secondary-button" data-action="test-provider-key" data-provider-id="${e.Id}" type="button">
            <span>Test</span>
          </button>
        </div>
        <div class="model-list">
          ${a}
        </div>
      </div>
    `}}const ie=o=>(o??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),nr=({ExcerptText:o,ExcerptMatchStart:e,ExcerptMatchEnd:t})=>{const s=(o??"").toString(),n=Math.max(0,e??0),i=Math.max(n,t??n),r=s.slice(0,n),a=s.slice(n,i),l=s.slice(i);return`${ie(r)}<mark class="chat-search-highlight">${ie(a)}</mark>${ie(l)}`};class ir{Render({ChatSearch:e,Text:t}={}){const s=(e==null?void 0:e.IsOpen)===!0,n=(t==null?void 0:t.ChatSearch)??{},i=(e==null?void 0:e.Query)??"",r=(e==null?void 0:e.Results)??[],a=(e==null?void 0:e.Error)??null,l=Fe({Icon:"/assets/icons/close.svg",Action:"close-chat-search",AriaLabel:n.CloseAriaLabel??"Close search",ClassName:"chat-search-close"}),c=a?`<div class="chat-search-empty">${ie(n.ErrorText??"Couldn't load pinned chats.")}</div>`:(i??"").trim().length===0?`<div class="chat-search-empty">${ie(n.EmptyStateText??"Type to search your pinned chats.")}</div>`:r.length===0?`<div class="chat-search-empty">${ie(n.NoResultsText??"No matches found.")}</div>`:`
                <div class="chat-search-results-list">
                  ${r.map(u=>`
                    <button
                      class="two-line-item conversation-item chat-search-result"
                      type="button"
                      data-action="select-chat-search-result"
                      data-conversation-id="${ie(u.ConversationId)}"
                    >
                      <img src="/assets/icons/chat_bubble_outline.svg" alt="" class="two-line-icon" />
                      <span class="two-line-text">
                        <span class="two-line-title">${ie(u.Title??"")}</span>
                        <span class="two-line-subtitle chat-search-excerpt">${nr(u)}</span>
                      </span>
                    </button>
                  `).join("")}
                </div>
              `;return`
      <div class="settings-overlay chat-search-overlay ${s?"":"hidden"}" data-chat-search-overlay>
        <div class="settings-backdrop" data-action="close-chat-search" aria-hidden="true"></div>
        <div class="settings-panel chat-search-panel" role="dialog" aria-modal="true" aria-label="${ie(n.Title??"Search chats")}">
          <div class="chat-search-header">
            <input
              class="chat-search-input"
              type="text"
              value="${ie(i)}"
              placeholder="${ie(n.Placeholder??"")}"
              data-action="chat-search-query"
              data-chat-search-input="true"
              spellcheck="false"
              autocomplete="off"
            />
            ${l}
          </div>
          <div class="chat-search-divider"></div>
          <div class="chat-search-results">
            ${c}
          </div>
        </div>
      </div>
    `}}const rr=o=>{Object.assign(o.prototype,{CloseMenus(){const e=this.Container;if(!e)return;const t=e.querySelector("[data-model-menu]"),s=e.querySelector('[data-action="toggle-models"]'),n=e.querySelector("[data-attachments-menu]");t&&t.classList.add("hidden"),s&&s.setAttribute("aria-expanded","false"),n&&n.classList.add("hidden"),e.querySelectorAll("[data-settings-menu]").forEach(i=>{i.classList.add("hidden")}),e.querySelectorAll('[data-action="toggle-settings-menu"]').forEach(i=>{i.setAttribute("aria-expanded","false")})},HandleClick(e){var a,l,c,u,p,g,h,m,f,S,b,C,M,T,I,k,R,z,K,P,_,Z,F,X,ye,Ie,ke,me,we,Se,$,ve,N,be,O,se;const t=this.Container;if(!t)return;const s=(l=(a=e.target)==null?void 0:a.closest)==null?void 0:l.call(a,"[data-action]");if(!s||!t.contains(s))return;const n=s.getAttribute("data-action"),i=this.LatestHandlers??{},r=this.LatestViewModel??{};if(n==="toggle-sidebar"){(c=i.onToggleSidebar)==null||c.call(i);return}if(n==="toggle-models"){const x=t.querySelector("[data-model-menu]");if(!x)return;const B=x.classList.contains("hidden");this.CloseMenus(),x.classList.toggle("hidden",!B),s.setAttribute("aria-expanded",B?"true":"false");return}if(n==="toggle-settings-menu"){const x=s.getAttribute("data-menu-id"),B=x?t.querySelector(`[data-settings-menu][data-menu-id="${x}"]`):null;if(!B)return;const Ce=B.classList.contains("hidden");this.CloseMenus(),B.classList.toggle("hidden",!Ce),s.setAttribute("aria-expanded",Ce?"true":"false");return}if(n==="toggle-attachments"){const x=t.querySelector("[data-attachments-menu]");if(!x)return;const B=x.classList.contains("hidden");this.CloseMenus(),x.classList.toggle("hidden",!B);return}if(n==="select-model"){const x=s.getAttribute("data-model-id");x&&(i.onSelectModel?i.onSelectModel(x):(p=this.Snackbar)==null||p.Show((u=r.Text)==null?void 0:u.NotImplemented)),this.CloseMenus();return}if(n==="new-chat"){this.ChatSavingRestoreFocusSelector='[data-action="new-chat"]',i.onStartNewChat?i.onStartNewChat():(h=this.Snackbar)==null||h.Show((g=r.Text)==null?void 0:g.NotImplemented),this.CloseMenus();return}if(n==="search-chats"){this.ChatSearchRestoreFocusSelector='[data-action="search-chats"]',(m=i.onOpenChatSearch)==null||m.call(i),this.CloseMenus();return}if(n==="close-chat-search"){(f=i.onCloseChatSearch)==null||f.call(i),this.CloseMenus();return}if(n==="select-chat-search-result"){const x=s.getAttribute("data-conversation-id");x&&(this.ChatSearchRestoreFocusSelector='[data-action="chat-input"]',(S=i.onSelectChatSearchResult)==null||S.call(i,x));return}if(n==="attach-files"){(C=this.Snackbar)==null||C.Show((b=r.Text)==null?void 0:b.NotImplemented),this.CloseMenus();return}if(n==="toggle-pin"){this.ChatSavingRestoreFocusSelector='[data-action="toggle-pin"]',(M=i.onTogglePin)==null||M.call(i),this.CloseMenus();return}if(n==="open-settings"){(T=i.onOpenSettings)==null||T.call(i),this.CloseMenus();return}if(n==="select-conversation"){const x=s.getAttribute("data-conversation-id");x&&(this.ChatSavingRestoreFocusSelector=`[data-action="select-conversation"][data-conversation-id="${x}"]`,(I=i.onSelectConversation)==null||I.call(i,x));return}if(n==="send-message"){(k=i.onSendMessage)==null||k.call(i);return}if(n==="abort-response"){(R=i.onAbortSend)==null||R.call(i);return}if(n==="close-settings"){(z=i.onCloseSettings)==null||z.call(i),this.CloseMenus();return}if(n==="settings-category"){const x=s.getAttribute("data-category");x&&((K=i.onSelectSettingsCategory)==null||K.call(i,x));return}if(n==="select-settings-option"){const x=s.getAttribute("data-field"),B=s.getAttribute("data-value");x==="theme"&&((P=i.onUpdateTheme)==null||P.call(i,B)),x==="accent"&&((_=i.onUpdateAccent)==null||_.call(i,B)),this.CloseMenus();return}if(n==="select-provider"){const x=s.getAttribute("data-provider-id");x&&((Z=i.onSelectProvider)==null||Z.call(i,x));return}if(n==="back-provider"){(F=i.onBackToProviders)==null||F.call(i);return}if(n==="clear-provider-key"){const x=s.getAttribute("data-provider-id");x&&((X=i.onClearProviderKey)==null||X.call(i,x));return}if(n==="toggle-provider-key-visibility"){const x=s.getAttribute("data-provider-id");x&&((ye=i.onToggleProviderKeyVisibility)==null||ye.call(i,x));return}if(n==="test-provider-key"){const x=s.getAttribute("data-provider-id");x&&((Ie=i.onTestProviderKey)==null||Ie.call(i,x));return}if(n==="close-provider-validation"){(ke=i.onCloseProviderValidationPopup)==null||ke.call(i);return}if(n==="retry-message"){const x=s.getAttribute("data-message-id");x&&((me=i.onRetryMessage)==null||me.call(i,x));return}if(n==="toggle-internal-group"){const x=s.getAttribute("data-group-id");x&&((we=i.onToggleInternalGroup)==null||we.call(i,x));return}if(n==="close-retry-popup"){(Se=i.onCloseRetryPopup)==null||Se.call(i);return}if(n==="retry-use-original"){($=i.onConfirmRetry)==null||$.call(i,!1);return}if(n==="retry-use-selected"){(ve=i.onConfirmRetry)==null||ve.call(i,!0);return}if(n==="cancel-pin"){(N=i.onCancelPin)==null||N.call(i);return}if(n==="confirm-pin"){(be=i.onConfirmPin)==null||be.call(i);return}if(n==="cancel-discard"){(O=i.onCancelDiscard)==null||O.call(i);return}n==="confirm-discard"&&((se=i.onConfirmDiscard)==null||se.call(i))},HandleInput(e){var i,r,a,l,c;const t=e.target;if(!(t!=null&&t.getAttribute))return;const s=t.getAttribute("data-action"),n=this.LatestHandlers??{};if(s==="chat-input"){this.ResizeChatInput(),(i=n.onUpdateInput)==null||i.call(n,t.value),this.UpdateInputActionButtonState(this.LatestViewModel,t.value);return}if(s==="chat-search-query"){(r=n.onUpdateChatSearchQuery)==null||r.call(n,t.value??"");return}if(s==="update-provider-key"){const u=t.getAttribute("data-provider-id");u&&((a=n.onUpdateProviderKey)==null||a.call(n,u,t.value));return}if(s==="pin-name"){const u=(l=this.Container)==null?void 0:l.querySelector("[data-chat-saving-pin-error]");u&&(u.classList.add("hidden"),u.textContent=""),(c=n.onUpdatePinName)==null||c.call(n,t.value)}},HandleChange(e){var i,r;const t=e.target;if(!(t!=null&&t.getAttribute))return;const s=t.getAttribute("data-action"),n=this.LatestHandlers??{};if(s==="toggle-provider-model"){const a=t.getAttribute("data-provider-id"),l=t.getAttribute("data-model-id");a&&l&&((i=n.onToggleProviderModel)==null||i.call(n,a,l,t.checked));return}s==="toggle-internal-messages"&&((r=n.onToggleInternalMessages)==null||r.call(n,t.checked))},HandleKeydown(e){var n,i,r,a,l;if(e.isComposing)return;const t=e.target;if(!(t!=null&&t.getAttribute))return;const s=t.getAttribute("data-action");if(s==="chat-input"){if((n=this.LatestViewModel)!=null&&n.IsSending||e.key!=="Enter"||e.shiftKey||!((t.value??"").trim().length>0)||!this.HasSelectedModel(this.LatestViewModel))return;e.preventDefault(),(r=(i=this.LatestHandlers)==null?void 0:i.onSendMessage)==null||r.call(i),t.value="";return}if(s==="select-chat-search-result"&&e.key==="Enter"){const c=t.getAttribute("data-conversation-id");if(!c)return;e.preventDefault(),(l=(a=this.LatestHandlers)==null?void 0:a.onSelectChatSearchResult)==null||l.call(a,c)}}})},ar=o=>{Object.assign(o.prototype,{SetupChatInputSizing(){this.TextMeasureCanvas=this.TextMeasureCanvas??document.createElement("canvas"),this.ResizeChatInput()},ResizeChatInput(){var l,c,u,p,g,h,m;const e=(l=this.Container)==null?void 0:l.querySelector('[data-action="chat-input"]'),t=(c=this.Container)==null?void 0:c.querySelector("[data-input-shell]");if(!e||!t)return;const n=(Number.parseFloat(getComputedStyle(e).lineHeight)||20)*(((p=(u=this.LatestViewModel)==null?void 0:u.Layout)==null?void 0:p.InputMaxLines)??10);let i=!1;const r=e.value??"";if(i=r.includes(`
`),!i&&!this.DisableCanvasTextMeasure&&!this.CanvasTextMeasureFailed)try{const f=this.TextMeasureCanvas??document.createElement("canvas");this.TextMeasureCanvas=f;const S=(g=f.getContext)==null?void 0:g.call(f,"2d");if(!S)this.CanvasTextMeasureFailed=!0;else{const b=getComputedStyle(e),C=b.font||`${b.fontStyle} ${b.fontVariant} ${b.fontWeight} ${b.fontSize} / ${b.lineHeight} ${b.fontFamily}`;S.font=C;const M=getComputedStyle(t),T=Number.parseFloat(getComputedStyle(document.documentElement).fontSize)||16,I=F=>{if(!F)return 0;if(F.endsWith("px"))return Number.parseFloat(F);if(F.endsWith("rem"))return Number.parseFloat(F)*T;const X=Number.parseFloat(F);return Number.isNaN(X)?0:X},k=I(M.paddingLeft),R=I(M.paddingRight),z=I(M.columnGap||M.gap||"0px"),K=((h=t.querySelector(".input-attach"))==null?void 0:h.offsetWidth)??0,P=((m=t.querySelector(".input-send"))==null?void 0:m.offsetWidth)??0,_=Math.max(t.clientWidth-k-R-K-P-z*2,0);i=Math.max(...r.split(`
`).map(F=>S.measureText(F).width),0)+2>_}}catch{this.CanvasTextMeasureFailed=!0}t.classList.toggle("input-multiline",i),e.style.height="auto";const a=Math.min(e.scrollHeight,n);e.style.height=`${a}px`,e.style.overflowY=e.scrollHeight>n?"auto":"hidden"},SyncChatInput(e){var n,i;const t=(n=this.Container)==null?void 0:n.querySelector('[data-action="chat-input"]');if(!t)return;const s=((i=e.Text)==null?void 0:i.InputPlaceholder)??"";s&&t.getAttribute("placeholder")!==s&&t.setAttribute("placeholder",s),document.activeElement!==t&&(t.value??"")!==(e.InputText??"")&&(t.value=e.InputText??"",this.ResizeChatInput()),this.EnsureInputActionButtonMode(e),this.UpdateInputActionButtonState(e,t.value??"")},EnsureInputActionButtonMode(e){var a,l,c,u;const t=(a=this.Container)==null?void 0:a.querySelector(".input-send");if(!t)return;const s=!!(e!=null&&e.IsSending),n=s?"abort-response":"send-message";(((l=t.getAttribute)==null?void 0:l.call(t,"data-action"))??"")!==n&&t.setAttribute("data-action",n),t.setAttribute("aria-label",s?"Abort":"Send");const r=(c=t.querySelector)==null?void 0:c.call(t,".material-symbols-outlined");if(r){const p=s?"close":"keyboard_arrow_up";(r.textContent??"").trim()!==p&&(r.textContent=p)}s&&(t.disabled=!1,(u=t.removeAttribute)==null||u.call(t,"disabled"))},HasSelectedModel(e){var s;const t=(e==null?void 0:e.SelectedModelId)??((s=e==null?void 0:e.ModelSelector)==null?void 0:s.SelectedModelId);return t===void 0?!0:!!t},UpdateInputActionButtonState(e,t){var a,l;const s=(a=this.Container)==null?void 0:a.querySelector(".input-send");if(!s)return;const n=((l=s.getAttribute)==null?void 0:l.call(s,"data-action"))??"";if(n==="abort-response"){s.disabled=!1;return}if(n!=="send-message")return;const i=(t??"").trim().length>0,r=this.HasSelectedModel(e);s.disabled=!!(e!=null&&e.IsSending)||!i||!r}})},or=o=>{Object.assign(o.prototype,{CaptureChatSearchEditingState(){if(!this.Container)return null;const e=this.Container.querySelector("[data-chat-search-input]");return!e||document.activeElement!==e?null:{SelectionStart:typeof e.selectionStart=="number"?e.selectionStart:null,SelectionEnd:typeof e.selectionEnd=="number"?e.selectionEnd:null}},RestoreChatSearchEditingState(e,t){var n;if(!this.Container||!e||((n=t.ChatSearch)==null?void 0:n.IsOpen)!==!0)return;const s=this.Container.querySelector("[data-chat-search-input]");s&&(s.focus(),typeof s.setSelectionRange=="function"&&e.SelectionStart!=null&&s.setSelectionRange(e.SelectionStart,e.SelectionEnd??e.SelectionStart))},UpdateModalKeyHandlers(e){var i,r,a,l,c,u,p;this.RetryKeyHandler&&(document.removeEventListener("keydown",this.RetryKeyHandler),this.RetryKeyHandler=null),(i=e.RetryPopup)!=null&&i.IsOpen&&(this.RetryKeyHandler=g=>{var h,m;g.key==="Enter"&&(g.preventDefault(),(m=(h=this.LatestHandlers)==null?void 0:h.onConfirmRetry)==null||m.call(h,!0))},document.addEventListener("keydown",this.RetryKeyHandler)),this.ChatSavingKeyHandler&&(document.removeEventListener("keydown",this.ChatSavingKeyHandler),this.ChatSavingKeyHandler=null);const t=((a=(r=e.ChatSaving)==null?void 0:r.PinDialog)==null?void 0:a.IsOpen)===!0,s=((c=(l=e.ChatSaving)==null?void 0:l.DiscardDialog)==null?void 0:c.IsOpen)===!0;(t||s)&&(this.ChatSavingKeyHandler=g=>{var h,m,f,S,b,C,M,T;g.isComposing||(g.key==="Escape"&&(g.preventDefault(),t?(m=(h=this.LatestHandlers)==null?void 0:h.onCancelPin)==null||m.call(h):s&&((S=(f=this.LatestHandlers)==null?void 0:f.onCancelDiscard)==null||S.call(f))),g.key==="Enter"&&(g.preventDefault(),t?(C=(b=this.LatestHandlers)==null?void 0:b.onConfirmPin)==null||C.call(b):s&&((T=(M=this.LatestHandlers)==null?void 0:M.onConfirmDiscard)==null||T.call(M))))},document.addEventListener("keydown",this.ChatSavingKeyHandler)),this.ChatSearchKeyHandler&&(document.removeEventListener("keydown",this.ChatSearchKeyHandler),this.ChatSearchKeyHandler=null),((u=e.ChatSearch)==null?void 0:u.IsOpen)===!0&&!(t||s)&&!((p=e.RetryPopup)!=null&&p.IsOpen)&&(this.ChatSearchKeyHandler=g=>{var h,m;g.isComposing||g.key==="Escape"&&(g.preventDefault(),(m=(h=this.LatestHandlers)==null?void 0:h.onCloseChatSearch)==null||m.call(h))},document.addEventListener("keydown",this.ChatSearchKeyHandler))},UpdateChatSavingFocus(e){var i,r,a,l,c,u,p,g,h,m,f,S;const t=((r=(i=e.ChatSaving)==null?void 0:i.PinDialog)==null?void 0:r.IsOpen)===!0,s=((l=(a=e.ChatSaving)==null?void 0:a.DiscardDialog)==null?void 0:l.IsOpen)===!0,n=t||s;if(t){const b=(c=this.Container)==null?void 0:c.querySelector('[data-action="pin-name"]');b&&(b.value=((p=(u=e.ChatSaving)==null?void 0:u.PinDialog)==null?void 0:p.Name)??"",b.focus(),(g=b.select)==null||g.call(b))}else if(s){const b=(h=this.Container)==null?void 0:h.querySelector('[data-action="cancel-discard"]');(m=b==null?void 0:b.focus)==null||m.call(b)}else if(this.ChatSavingDialogWasOpen){const b=this.ChatSavingRestoreFocusSelector?(f=this.Container)==null?void 0:f.querySelector(this.ChatSavingRestoreFocusSelector):null;(S=b==null?void 0:b.focus)==null||S.call(b),this.ChatSavingRestoreFocusSelector=null}this.ChatSavingDialogWasOpen=n},UpdateChatSearchFocus(e){var s,n,i,r,a,l;const t=((s=e.ChatSearch)==null?void 0:s.IsOpen)===!0;if(t&&!this.ChatSearchDialogWasOpen){const c=(n=this.Container)==null?void 0:n.querySelector('[data-action="chat-search-query"]');c&&(c.value=((i=e.ChatSearch)==null?void 0:i.Query)??"",c.focus(),(r=c.select)==null||r.call(c))}else if(!t&&this.ChatSearchDialogWasOpen){const c=this.ChatSearchRestoreFocusSelector?(a=this.Container)==null?void 0:a.querySelector(this.ChatSearchRestoreFocusSelector):null;(l=c==null?void 0:c.focus)==null||l.call(c),this.ChatSearchRestoreFocusSelector=null}this.ChatSearchDialogWasOpen=t}})},lr=o=>{Object.assign(o.prototype,{BuildChatBodyKey({ConversationId:e,Messages:t,MessageGroups:s,InternalMessagesEnabled:n}){const i=(t??[])[t.length-1]??null,r=[e??"",`${(t==null?void 0:t.length)??0}`,`${(s==null?void 0:s.length)??0}`,n?"1":"0",(i==null?void 0:i.Id)??"",(i==null?void 0:i.Status)??"",`${((i==null?void 0:i.Content)??"").length}`].join("|");if(!n)return r;const a=(s??[]).map(l=>`${l.Id}:${l.InternalVisible?"1":"0"}`).join(";");return`${r}|${a}`},UpdateHeaderElevation(){var s,n;const e=(s=this.Container)==null?void 0:s.querySelector("[data-header]"),t=(n=this.Dom)==null?void 0:n.ChatScroll;!e||!t||e.classList.toggle("header-elevated",t.scrollTop>0)},RenderValidationPopup(e){if(!(e!=null&&e.IsOpen))return"";const t=e.Status??"pending",s=t==="success"?"is-success":t==="failure"?"is-failure":"",n=t==="success"?"check_circle":t==="failure"?"error":"autorenew",i=t==="pending"?"provider-validation-spinner":"",r=e.Message??"",a=t==="pending"&&e.TotalModels&&e.CurrentIndex!=null,l=a?Math.round((e.CurrentIndex+1)/e.TotalModels*100):0;return`
        <div class="provider-validation-overlay">
          <div class="provider-validation-backdrop" data-action="close-provider-validation" aria-hidden="true"></div>
          <div class="provider-validation-dialog ${s}" role="dialog" aria-modal="true" aria-label="Provider validation">
            <div class="provider-validation-title">
              <span class="material-symbols-outlined ${i}">${n}</span>
              <span>Provider validation</span>
            </div>
            <div class="provider-validation-message">${r}</div>
            ${a?`
            <div class="provider-validation-progress">
              <div class="provider-validation-progress-bar" style="width: ${l}%;"></div>
            </div>
            <div class="provider-validation-current">Testing: ${e.CurrentModel??"..."}</div>
            `:""}
            <div class="provider-validation-actions">
              <button class="settings-primary-button" data-action="close-provider-validation" type="button">Close</button>
            </div>
          </div>
        </div>
      `},RenderRetryPopup(e,t){return e!=null&&e.IsOpen?`
        <div class="settings-overlay">
          <div class="settings-backdrop" data-action="close-retry-popup"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="Retry confirmation">
            <div class="settings-dialog-body">
              <div class="settings-form-title">${(t==null?void 0:t.RetryConfirmTitle)??"Use the newly selected model?"}</div>
              <div class="settings-dialog-message">
                ${(t==null?void 0:t.RetryConfirmMessage)??""}
              </div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="retry-use-original" type="button">
                ${(t==null?void 0:t.RetryConfirmNo)??"No"}
              </button>
              <button class="settings-primary-button" data-action="retry-use-selected" type="button">
                ${(t==null?void 0:t.RetryConfirmYes)??"Yes"}
              </button>
            </div>
          </div>
        </div>
      `:""},RenderPinDialog(e,t){if(!(e!=null&&e.IsOpen))return"";const s=(t==null?void 0:t.ChatSaving)??{},n=s.PinDialogTitle??"",i=s.PinDialogPlaceholder??"",r=s.PinDialogOk??"",a=s.PinDialogCancel??"",l=e.ErrorText??"";return`
        <div class="settings-overlay" data-chat-saving-dialog="pin">
          <div class="settings-backdrop" data-action="cancel-pin"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="${n}">
            <div class="settings-dialog-body">
              <div class="settings-form-title">${n}</div>
              <input class="settings-input" data-action="pin-name" type="text" placeholder="${i}" aria-label="${i}" />
              <div class="mt-2 text-sm font-medium text-red-600 ${l?"":"hidden"}" data-chat-saving-pin-error>${l}</div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="cancel-pin" type="button">
                ${a}
              </button>
              <button class="settings-primary-button" data-action="confirm-pin" type="button">
                ${r}
              </button>
            </div>
          </div>
        </div>
      `},RenderDiscardDialog(e,t){if(!(e!=null&&e.IsOpen))return"";const s=(t==null?void 0:t.ChatSaving)??{},n=s.DiscardPromptText??"",i=s.DiscardOk??"",r=s.DiscardCancel??"";return`
        <div class="settings-overlay" data-chat-saving-dialog="discard">
          <div class="settings-backdrop" data-action="cancel-discard"></div>
          <div class="settings-panel settings-dialog" role="dialog" aria-modal="true" aria-label="${n}">
            <div class="settings-dialog-body">
              <div class="settings-dialog-message" data-chat-saving-discard-message>${n}</div>
            </div>
            <div class="settings-dialog-actions">
              <button class="settings-secondary-button" data-action="cancel-discard" type="button">
                ${r}
              </button>
              <button class="settings-primary-button" data-action="confirm-discard" type="button">
                ${i}
              </button>
            </div>
          </div>
        </div>
      `}})};class Ee{static IsJsDomEnvironment(){return typeof navigator>"u"||typeof navigator.userAgent!="string"?!1:navigator.userAgent.toLowerCase().includes("jsdom")}constructor(){this.SidebarView=new Kn,this.ModelSelectorView=new qn,this.ChatThreadView=new Ji,this.InputBarView=new Xi,this.SettingsView=new sr,this.ChatSearchView=new ir,this.Container=null,this.Dom=null,this.IsMounted=!1,this.Snackbar=null,this.TextMeasureCanvas=null,this.DisableCanvasTextMeasure=Ee.IsJsDomEnvironment(),this.CanvasTextMeasureFailed=!1,this.LastConversationId=null,this.LastScrollTop=null,this.ChatSavingDialogWasOpen=!1,this.ChatSavingRestoreFocusSelector=null,this.ChatSearchDialogWasOpen=!1,this.ChatSearchRestoreFocusSelector=null,this.LastSidebarHtml=null,this.LastModelSelectorHtml=null,this.LastHeaderActionsHtml=null,this.LastChatBodyKey=null,this.LastOverlaysHtml=null,this.LatestViewModel=null,this.LatestHandlers={},this.DocumentClickHandler=null,this.ScrollHandler=null,this.RetryKeyHandler=null,this.ChatSavingKeyHandler=null,this.ChatSearchKeyHandler=null}Render(e,t,s={}){e&&(this.LatestViewModel=t,this.LatestHandlers=s??{},this.EnsureMounted(e,t),this.Update(t))}EnsureMounted(e,t){var s,n;this.IsMounted||(this.Container=e,this.Container.innerHTML=`
      <div class="shell-root app-surface flex h-screen" data-shell data-collapsed="false">
        <div data-slot="sidebar"></div>
        <section class="main-pane flex min-w-0 flex-1 flex-col">
          <header class="app-header app-pad-x app-pad-top" data-header>
            <div class="flex w-full items-center gap-4">
              <div data-slot="model-selector"></div>
              <div class="ml-auto flex items-center gap-2" data-slot="header-actions"></div>
            </div>
          </header>
          <main class="relative flex min-h-0 flex-1 flex-col" data-slot="main">
            <div class="chat-scroll flex-1 overflow-y-auto app-pad-x app-pad-top" data-slot="chat-scroll">
              <div class="content-wrap" data-slot="chat-body"></div>
            </div>
            <div class="input-floating">
              <div class="content-wrap" data-slot="input-bar"></div>
            </div>
          </main>
        </section>
        <div data-slot="snackbar"></div>
      </div>
      <div data-slot="overlays"></div>
    `,this.Dom={Shell:this.Container.querySelector("[data-shell]"),SidebarHost:this.Container.querySelector('[data-slot="sidebar"]'),ModelSelectorHost:this.Container.querySelector('[data-slot="model-selector"]'),HeaderActionsHost:this.Container.querySelector('[data-slot="header-actions"]'),Main:this.Container.querySelector('[data-slot="main"]'),ChatScroll:this.Container.querySelector('[data-slot="chat-scroll"]'),ChatBodyHost:this.Container.querySelector('[data-slot="chat-body"]'),InputHost:this.Container.querySelector('[data-slot="input-bar"]'),SnackbarHost:this.Container.querySelector('[data-slot="snackbar"]'),OverlaysHost:this.Container.querySelector('[data-slot="overlays"]')},this.Snackbar=this.Snackbar??new er({DurationMs:((s=t.Layout)==null?void 0:s.SnackbarDurationMs)??2400}),this.Dom.SnackbarHost.innerHTML=this.Snackbar.Render(),this.Snackbar.Mount(this.Container),this.Container.addEventListener("click",i=>this.HandleClick(i)),this.Container.addEventListener("input",i=>this.HandleInput(i)),this.Container.addEventListener("change",i=>this.HandleChange(i)),this.Container.addEventListener("keydown",i=>this.HandleKeydown(i)),this.DocumentClickHandler=i=>{var a;if(!((a=this.Container)!=null&&a.contains(i.target)))return;const r=i.target;r.closest("[data-model-menu]")||r.closest('[data-action="toggle-models"]')||r.closest("[data-attachments-menu]")||r.closest('[data-action="toggle-attachments"]')||r.closest("[data-settings-menu]")||r.closest('[data-action="toggle-settings-menu"]')||this.CloseMenus()},document.addEventListener("click",this.DocumentClickHandler),this.ScrollHandler=()=>{var i,r,a;this.UpdateHeaderElevation(),this.LastScrollTop=((i=this.Dom.ChatScroll)==null?void 0:i.scrollTop)??this.LastScrollTop,(a=(r=this.LatestHandlers)==null?void 0:r.onScrollConversation)==null||a.call(r,this.LastScrollTop)},(n=this.Dom.ChatScroll)==null||n.addEventListener("scroll",this.ScrollHandler),this.IsMounted=!0)}Update(e){var Z,F,X,ye,Ie,ke,me,we,Se,$,ve,N,be,O,se,x,B,Ce;const t=((Z=this.Container.querySelector(".settings-content"))==null?void 0:Z.scrollTop)??0,s=((F=this.Dom.ChatScroll)==null?void 0:F.scrollTop)??this.LastScrollTop,n=this.LastConversationId??e.ActiveConversationId,i=((Ie=(ye=(X=e.Settings)==null?void 0:X.Options)==null?void 0:ye.Accents)==null?void 0:Ie.find(Me=>Me.Id===e.Settings.General.AccentColor))??((we=(me=(ke=e.Settings)==null?void 0:ke.Options)==null?void 0:me.Accents)==null?void 0:we[0]),r=(i==null?void 0:i.Hex)??"#10b981";this.Container.style.setProperty("--accent-color",r),document.documentElement.style.setProperty("--accent-color",r);const a=e.ActiveConversationId,l=((Se=e.Conversations)==null?void 0:Se.find(Me=>Me.Id===e.ActiveConversationId))??null,c=a?e.MessagesByConversation[a]??[]:[],u=a?(($=e.MessageGroupsByConversation)==null?void 0:$[a])??[]:[],p=a?this.ChatThreadView.RenderConversation({Messages:c,MessageGroups:u,Settings:e.Settings,Text:e.Text}):this.ChatThreadView.RenderWelcome({Text:e.Text}),g=this.SidebarView.Render(e),h=this.ModelSelectorView.Render(e),m=((ve=e.Text)==null?void 0:ve.ChatSaving)??{},f=l!=null&&l.IsPinned?m.UnpinActionLabel:m.PinActionLabel,S=f?`
        <button class="model-toggle flex items-center gap-2 text-sm font-semibold" data-action="toggle-pin" type="button" aria-label="${f}">
          <span>${f}</span>
          <span class="material-symbols-outlined">push_pin</span>
        </button>
      `:"",b=e.Settings?this.SettingsView.Render(e.Settings):"",C=this.RenderValidationPopup((be=(N=e.Settings)==null?void 0:N.Providers)==null?void 0:be.ValidationPopup),M=this.RenderRetryPopup(e.RetryPopup,e.Text),T=this.ChatSearchView.Render({ChatSearch:e.ChatSearch,Text:e.Text}),I=this.RenderPinDialog((O=e.ChatSaving)==null?void 0:O.PinDialog,e.Text),k=this.RenderDiscardDialog((se=e.ChatSaving)==null?void 0:se.DiscardDialog,e.Text),R=`${b}${C}${M}${T}${I}${k}`,z=[`--chat-bottom-padding: ${e.Layout.ChatBottomPadding};`,`--chat-input-line-height: ${e.Layout.InputLineHeightRem}rem;`,`--chat-input-max-height: ${e.Layout.InputMaxHeightRem}rem;`].join(" ");this.Dom.Shell.setAttribute("data-collapsed",e.IsSidebarCollapsed?"true":"false"),this.Dom.Main.style.cssText=z,g!==this.LastSidebarHtml&&(this.Dom.SidebarHost.innerHTML=g,this.LastSidebarHtml=g),h!==this.LastModelSelectorHtml&&(this.Dom.ModelSelectorHost.innerHTML=h,this.LastModelSelectorHtml=h),S!==this.LastHeaderActionsHtml&&(this.Dom.HeaderActionsHost.innerHTML=S,this.LastHeaderActionsHtml=S);const K=this.BuildChatBodyKey({ConversationId:a,Messages:c,MessageGroups:u,InternalMessagesEnabled:!!((B=(x=e.Settings)==null?void 0:x.Chat)!=null&&B.InternalChatMessages)});K!==this.LastChatBodyKey&&(this.Dom.ChatBodyHost.innerHTML=p,this.LastChatBodyKey=K),this.Dom.InputHost.hasChildNodes()||(this.Dom.InputHost.innerHTML=this.InputBarView.Render(e),this.SetupChatInputSizing()),this.SyncChatInput(e);const P=this.CaptureChatSearchEditingState();R!==this.LastOverlaysHtml&&(this.Dom.OverlaysHost.innerHTML=R,this.LastOverlaysHtml=R,this.RestoreChatSearchEditingState(P,e));const _=this.Container.querySelector(".settings-content");_&&t>0&&(_.scrollTop=t),this.Dom.ChatScroll&&(n===e.ActiveConversationId&&s!=null?this.Dom.ChatScroll.scrollTop=s:(l==null?void 0:l.ScrollPosition)!=null?this.Dom.ChatScroll.scrollTop=l.ScrollPosition:this.Dom.ChatScroll.scrollTop=0),this.LastConversationId=e.ActiveConversationId,this.LastScrollTop=((Ce=this.Dom.ChatScroll)==null?void 0:Ce.scrollTop)??this.LastScrollTop,this.Snackbar.DurationMs=e.Layout.SnackbarDurationMs,this.UpdateHeaderElevation(),this.UpdateModalKeyHandlers(e),this.UpdateChatSavingFocus(e),this.UpdateChatSearchFocus(e)}}rr(Ee);ar(Ee);or(Ee);lr(Ee);const cr=[{Id:"openai",Name:"OpenAI",Icon:"/assets/icons/provider_openai.svg",Models:[{Id:"gpt-5.2",Label:"GPT-5.2",Description:"Latest flagship general model. Uses max_completion_tokens.",Enabled:!0,Capabilities:{MaxTokensParam:"max_completion_tokens"}},{Id:"gpt-5.2-pro",Label:"GPT-5.2 Pro",Description:"Highest capability GPT-5.2 tier.",Enabled:!0},{Id:"gpt-5.1",Label:"GPT-5.1",Description:"Flagship general model (previous generation). Uses max_completion_tokens.",Enabled:!0,Capabilities:{MaxTokensParam:"max_completion_tokens"}},{Id:"gpt-5",Label:"GPT-5",Description:"Flagship general model.",Enabled:!0},{Id:"gpt-5-pro",Label:"GPT-5 Pro",Description:"Higher capability tier within GPT-5 family. Responses API only.",Enabled:!0,Capabilities:{Endpoint:"responses",MaxTokensParam:"max_output_tokens"}},{Id:"gpt-5-mini",Label:"GPT-5 Mini",Description:"Lower-latency, cost-efficient GPT-5 family model.",Enabled:!0},{Id:"gpt-5-nano",Label:"GPT-5 Nano",Description:"Smallest/fastest GPT-5 family option.",Enabled:!0},{Id:"gpt-5.1-codex",Label:"GPT-5.1 Codex",Description:"GPT-5.1 optimized for agentic coding (Responses API).",Enabled:!0},{Id:"gpt-5.1-codex-max",Label:"GPT-5.1 Codex Max",Description:"Largest Codex variant for demanding coding agents.",Enabled:!0},{Id:"gpt-5-codex",Label:"GPT-5 Codex",Description:"GPT-5 coding-optimized model family (Codex).",Enabled:!0},{Id:"o3-deep-research",Label:"o3 Deep Research",Description:"Deep research optimized reasoning model.",Enabled:!0},{Id:"o4-mini-deep-research",Label:"o4-mini Deep Research",Description:"Deep research optimized, smaller/faster reasoning model.",Enabled:!0},{Id:"o3-pro",Label:"o3 Pro",Description:"Higher-tier o3 reasoning model.",Enabled:!0},{Id:"o3",Label:"o3",Description:"General high-capability reasoning model (with snapshots available).",Enabled:!0},{Id:"o3-mini",Label:"o3 Mini",Description:"Faster/lower-cost reasoning model.",Enabled:!0},{Id:"o1",Label:"o1",Description:"Reasoning model (earlier o-series).",Enabled:!0},{Id:"o4-mini",Label:"o4-mini",Description:"Small reasoning model balancing speed and capability.",Enabled:!0},{Id:"gpt-4.1",Label:"GPT-4.1",Description:"High-quality general model (non-reasoning-first).",Enabled:!0},{Id:"gpt-4.1-mini",Label:"GPT-4.1 Mini",Description:"Smaller GPT-4.1 variant for lower latency/cost.",Enabled:!0},{Id:"gpt-4.1-nano",Label:"GPT-4.1 Nano",Description:"Smallest GPT-4.1 variant.",Enabled:!0},{Id:"gpt-4o",Label:"GPT-4o",Description:"Omni multimodal model for text+vision.",Enabled:!0},{Id:"gpt-4o-mini",Label:"GPT-4o Mini",Description:"Lower-cost GPT-4o family model.",Enabled:!0},{Id:"gpt-4o-search-preview",Label:"GPT-4o Search Preview",Description:"Web search specialized (tool-call priced).",Enabled:!0},{Id:"gpt-4o-mini-search-preview",Label:"GPT-4o Mini Search Preview",Description:"Cheaper web search specialized model (with snapshots).",Enabled:!0}]},{Id:"anthropic",Name:"Anthropic",Icon:"/assets/icons/provider_anthropic.svg",Models:[{Id:"claude-sonnet-4-5",Label:"Claude Sonnet 4.5 (alias)",Description:"Alias to latest Sonnet 4.5 snapshot.",Enabled:!0},{Id:"claude-haiku-4-5",Label:"Claude Haiku 4.5 (alias)",Description:"Alias to latest Haiku 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-5",Label:"Claude Opus 4.5 (alias)",Description:"Alias to latest Opus 4.5 snapshot.",Enabled:!0},{Id:"claude-sonnet-4-5-20250929",Label:"Claude Sonnet 4.5 (2025-09-29)",Description:"Pinned Sonnet 4.5 snapshot.",Enabled:!0},{Id:"claude-haiku-4-5-20251001",Label:"Claude Haiku 4.5 (2025-10-01)",Description:"Pinned Haiku 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-5-20251101",Label:"Claude Opus 4.5 (2025-11-01)",Description:"Pinned Opus 4.5 snapshot.",Enabled:!0},{Id:"claude-opus-4-1",Label:"Claude Opus 4.1 (alias)",Description:"Alias to latest Opus 4.1 snapshot.",Enabled:!0},{Id:"claude-opus-4-1-20250805",Label:"Claude Opus 4.1 (2025-08-05)",Description:"Pinned Opus 4.1 snapshot.",Enabled:!0},{Id:"claude-opus-4",Label:"Claude Opus 4 (alias)",Description:"Alias to latest Opus 4 snapshot.",Enabled:!0},{Id:"claude-opus-4-20250514",Label:"Claude Opus 4 (2025-05-14)",Description:"Pinned Opus 4 snapshot.",Enabled:!0},{Id:"claude-sonnet-4",Label:"Claude Sonnet 4 (alias)",Description:"Alias to latest Sonnet 4 snapshot.",Enabled:!0},{Id:"claude-sonnet-4-20250514",Label:"Claude Sonnet 4 (2025-05-14)",Description:"Pinned Sonnet 4 snapshot.",Enabled:!0},{Id:"claude-3-haiku-20240307",Label:"Claude 3 Haiku (2024-03-07)",Description:"Active smaller Claude 3 model.",Enabled:!0},{Id:"claude-3-opus-20240229",Label:"Claude 3 Opus (2024-02-29)",Description:"Deprecated (available to existing users) — retirement Jan 5, 2026 per Anthropic.",Enabled:!0},{Id:"claude-3-5-haiku-20241022",Label:"Claude 3.5 Haiku (2024-10-22)",Description:"Deprecated (available to existing users) — retirement Feb 19, 2026 per Anthropic.",Enabled:!0},{Id:"claude-3-7-sonnet-20250219",Label:"Claude 3.7 Sonnet (2025-02-19)",Description:"Deprecated (available to existing users) — retirement Feb 19, 2026 per Anthropic.",Enabled:!0}]},{Id:"google",Name:"Google",Icon:"/assets/icons/provider_google.svg",Models:[{Id:"gemini-3-pro-preview",Label:"Gemini 3 Pro (Preview)",Description:"Most capable Gemini 3 preview model code.",Enabled:!0},{Id:"gemini-3-flash-preview",Label:"Gemini 3 Flash (Preview)",Description:"Gemini 3 speed-optimized preview model code.",Enabled:!0},{Id:"gemini-2.5-flash",Label:"Gemini 2.5 Flash",Description:"Stable Gemini 2.5 Flash model code.",Enabled:!0},{Id:"gemini-2.5-flash-lite",Label:"Gemini 2.5 Flash-Lite",Description:"Ultra fast/cost-efficient Gemini 2.5 Flash-Lite model code.",Enabled:!0}]},{Id:"grok",Name:"Grok",Icon:"/assets/icons/provider_grok.svg",Models:[{Id:"grok-4",Label:"Grok 4",Description:"Frontier Grok model family.",Enabled:!0},{Id:"grok-4-0709",Label:"Grok 4 (0709)",Description:"Pinned Grok 4 snapshot ID (as documented by xAI).",Enabled:!0},{Id:"grok-4-fast",Label:"Grok 4 Fast",Description:"Lower-latency Grok 4 variant.",Enabled:!0},{Id:"grok-4-1-fast",Label:"Grok 4.1 Fast",Description:"Fast Grok 4.1 variant.",Enabled:!0},{Id:"grok-4-1-fast-reasoning",Label:"Grok 4.1 Fast Reasoning",Description:"Fast reasoning-oriented Grok 4.1 variant.",Enabled:!0},{Id:"grok-3-fast",Label:"Grok 3 Fast",Description:"Lower-latency Grok 3 variant.",Enabled:!0},{Id:"grok-3-mini",Label:"Grok 3 Mini",Description:"Smaller Grok 3 variant for cost/latency.",Enabled:!0},{Id:"grok-3-mini-fast",Label:"Grok 3 Mini Fast",Description:"Fastest Grok 3 mini variant.",Enabled:!0},{Id:"grok-code-fast-1",Label:"Grok Code Fast 1",Description:"Coding-optimized Grok model ID.",Enabled:!0},{Id:"grok-2-1212",Label:"Grok 2 (1212)",Description:"Pinned Grok 2 model snapshot ID.",Enabled:!0}]}],zs={Providers:cr};class dr{constructor({Fetch:e,Logger:t,EnvironmentName:s}){this.Fetch=e,this.Logger=t,this.EnvironmentName=s}async LoadAsync(){const e=await this.FetchOverrideAsync();return e?this.MergeCatalogs(zs,e):zs}async FetchOverrideAsync(){var t,s;const e=`/config/providers.catalog.${this.EnvironmentName}.json`;try{const n=await this.Fetch(e);return n.ok?await n.json():null}catch(n){return(s=(t=this.Logger)==null?void 0:t.LogWarning)==null||s.call(t,"ProviderCatalog.Override.Missing",{Path:e,Error:(n==null?void 0:n.message)??"Unknown error"}),null}}MergeCatalogs(e,t){const s=(e==null?void 0:e.Providers)??[],n=(t==null?void 0:t.Providers)??[],i=new Map(n.map(l=>[l.Id,l])),r=s.map(l=>{const c=i.get(l.Id);return c?{...l,...c,Models:this.MergeModels(l.Models??[],c.Models??[])}:l}),a=n.filter(l=>!s.some(c=>c.Id===l.Id));return{Providers:[...r,...a]}}MergeModels(e,t){if(t.length===0)return e;const s=new Map(t.map(r=>[r.Id,r])),n=e.map(r=>({...r,...s.get(r.Id)??{}})),i=t.filter(r=>!e.some(a=>a.Id===r.Id));return[...n,...i]}}class ur{constructor({Catalog:e}){this.Catalog=e}async LoadCatalogAsync(){return await this.Catalog.LoadAsync()}}class hr{constructor({Providers:e}){this.Providers=new Map((e??[]).map(t=>[t.Id,t]))}GetProvider(e){const t=this.Providers.get(e);if(!t)throw new Error(`Provider not registered: ${e}`);return t}async ListModelIds(e,t){return await this.GetProvider(e).ListModelIds({Key:t})}async ValidateKey(e,t){return await this.GetProvider(e).ValidateKey(t)}}class pr{constructor({Fetch:e,BaseUrl:t="https://api.openai.com/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="openai",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??[]).map(s=>s==null?void 0:s.id).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{Authorization:`Bearer ${e}`}}BuildChatRequest({Key:e,ModelId:t,Messages:s,Stream:n,MaxOutputTokens:i,ModelConfig:r}){const a=(r==null?void 0:r.Endpoint)??"chat",l=(r==null?void 0:r.MaxTokensParam)??"max_tokens",c=a==="responses"?{model:t,input:this.MapMessages(s??[]),stream:!!n}:{model:t,messages:this.MapMessages(s??[]),stream:!!n};n&&a!=="responses"&&(c.stream_options={include_usage:!0}),i!=null&&(c[l]=i);const u=a==="responses"?"/responses":"/chat/completions";return{Url:`${this.BaseUrl}${u}`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:c}}ParseChatResponse(e){var l,c,u;const t=(e==null?void 0:e.usage)??{},s=t.input_tokens??t.prompt_tokens??null,n=t.output_tokens??t.completion_tokens??null,i={InputTokens:s??null,OutputTokens:n??null};if(e!=null&&e.output_text)return{Content:e.output_text,Usage:i};const a=((e==null?void 0:e.output)??[]).flatMap(p=>(p==null?void 0:p.content)??[]).map(p=>(p==null?void 0:p.text)??"").join("");return a?{Content:a,Usage:i}:{Content:((u=(c=(l=e==null?void 0:e.choices)==null?void 0:l[0])==null?void 0:c.message)==null?void 0:u.content)??"",Usage:i}}ParseStreamEvent(e){var n,i,r;if(!e)return{Content:"",IsDone:!1};if(e==="[DONE]")return{Content:"",IsDone:!0};const t=(r=(i=(n=e==null?void 0:e.choices)==null?void 0:n[0])==null?void 0:i.delta)==null?void 0:r.content,s=e!=null&&e.usage?{InputTokens:e.usage.input_tokens??e.usage.prompt_tokens??null,OutputTokens:e.usage.output_tokens??e.usage.completion_tokens??null}:null;return{Content:t??"",IsDone:!1,Usage:s}}MapMessages(e){return e.map(t=>({role:(t.Role??"user").toLowerCase(),content:t.Content??""}))}async BuildError(e){const t=await this.TryReadMessage(e),s=new Error(t??"OpenAI validation failed.");return s.Status=e.status,s}async TryReadMessage(e){var t;try{const s=await e.json();return((t=s==null?void 0:s.error)==null?void 0:t.message)??(s==null?void 0:s.message)}catch{return null}}}class gr{constructor({Fetch:e,BaseUrl:t="https://api.anthropic.com/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="anthropic",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??(t==null?void 0:t.models)??[]).map(s=>(s==null?void 0:s.id)??(s==null?void 0:s.name)).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{"x-api-key":e,"anthropic-version":"2023-06-01"}}BuildChatRequest({Key:e,ModelId:t,Messages:s,Stream:n,MaxOutputTokens:i}){const r=this.MapMessages(s??[]),a={model:t,messages:r.Messages,stream:!!n};return i!=null&&(a.max_tokens=i),r.System&&(a.system=r.System),{Url:`${this.BaseUrl}/messages`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:a}}ParseChatResponse(e){const t=(e==null?void 0:e.content)??[],s=(e==null?void 0:e.usage)??{};return{Content:t.map(n=>(n==null?void 0:n.text)??"").join(""),Usage:{InputTokens:s.input_tokens??null,OutputTokens:s.output_tokens??null}}}ParseStreamEvent(e){var t;return e?e.type==="message_stop"?{Content:"",IsDone:!0}:e.type==="content_block_delta"?{Content:((t=e==null?void 0:e.delta)==null?void 0:t.text)??"",IsDone:!1}:{Content:"",IsDone:!1}:{Content:"",IsDone:!1}}MapMessages(e){const t=[],s=[];return e.forEach(n=>{const i=(n.Role??"").toLowerCase();if(i==="system"||i==="tool"||n.Kind==="Internal"){t.push(n.Content??"");return}if(i==="assistant"){s.push({role:"assistant",content:n.Content??""});return}s.push({role:"user",content:n.Content??""})}),{System:t.filter(Boolean).join(`

`),Messages:s}}async BuildError(e){const t=await this.TryReadMessage(e),s=new Error(t??"Anthropic validation failed.");return s.Status=e.status,s}async TryReadMessage(e){var t;try{const s=await e.json();return((t=s==null?void 0:s.error)==null?void 0:t.message)??(s==null?void 0:s.message)}catch{return null}}}class fr{constructor({Fetch:e,BaseUrl:t="https://generativelanguage.googleapis.com/v1beta"}){this.Fetch=e,this.BaseUrl=t,this.Id="google",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models?key=${encodeURIComponent(e)}`);if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.models)??[]).map(s=>s==null?void 0:s.name).filter(Boolean).map(s=>s.replace(/^models\//,""))}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}BuildChatRequest({Key:e,ModelId:t,Messages:s,Stream:n}){const i=this.MapMessages(s??[]),r=t.startsWith("models/")?t:`models/${t}`,a=n?`${this.BaseUrl}/${r}:streamGenerateContent?key=${encodeURIComponent(e)}&alt=sse`:`${this.BaseUrl}/${r}:generateContent?key=${encodeURIComponent(e)}`,l={contents:i.Messages};return i.System&&(l.systemInstruction={parts:[{text:i.System}]}),{Url:a,Headers:{"Content-Type":"application/json"},Body:l}}ParseChatResponse(e){var n,i,r;const t=((r=(i=(n=e==null?void 0:e.candidates)==null?void 0:n[0])==null?void 0:i.content)==null?void 0:r.parts)??[],s=(e==null?void 0:e.usageMetadata)??{};return{Content:t.map(a=>(a==null?void 0:a.text)??"").join(""),Usage:{InputTokens:s.promptTokenCount??null,OutputTokens:s.candidatesTokenCount??null}}}ParseStreamEvent(e){var n,i,r;return e?e==="[DONE]"?{Content:"",IsDone:!0}:{Content:(((r=(i=(n=e==null?void 0:e.candidates)==null?void 0:n[0])==null?void 0:i.content)==null?void 0:r.parts)??[]).map(a=>(a==null?void 0:a.text)??"").join(""),IsDone:!1}:{Content:"",IsDone:!1}}MapMessages(e){const t=[],s=[];return e.forEach(n=>{const i=(n.Role??"").toLowerCase();if(i==="system"||i==="tool"||n.Kind==="Internal"){t.push(n.Content??"");return}const r=i==="assistant"?"model":"user";s.push({role:r,parts:[{text:n.Content??""}]})}),{System:t.filter(Boolean).join(`

`),Messages:s}}async BuildError(e){const t=await this.TryReadMessage(e),s=new Error(t??"Google validation failed.");return s.Status=e.status,s}async TryReadMessage(e){var t;try{const s=await e.json();return((t=s==null?void 0:s.error)==null?void 0:t.message)??(s==null?void 0:s.message)}catch{return null}}}class mr{constructor({Fetch:e,BaseUrl:t="https://api.x.ai/v1"}){this.Fetch=e,this.BaseUrl=t,this.Id="grok",this.SupportsStreaming=!0}async ListModels({Key:e}){const t=await this.Fetch(`${this.BaseUrl}/models`,{headers:this.GetAuthHeaders(e)});if(!t.ok)throw await this.BuildError(t);return await t.json()}async ListModelIds({Key:e}){const t=await this.ListModels({Key:e});return((t==null?void 0:t.data)??[]).map(s=>s==null?void 0:s.id).filter(Boolean)}async ValidateKey(e){return await this.ListModelIds({Key:e}),!0}GetAuthHeaders(e){return{Authorization:`Bearer ${e}`}}BuildChatRequest({Key:e,ModelId:t,Messages:s,Stream:n,MaxOutputTokens:i}){const r={model:t,messages:this.MapMessages(s??[]),stream:!!n};return i&&(r.max_tokens=i),{Url:`${this.BaseUrl}/chat/completions`,Headers:{...this.GetAuthHeaders(e),"Content-Type":"application/json"},Body:r}}ParseChatResponse(e){var s,n,i;const t=(e==null?void 0:e.usage)??{};return{Content:((i=(n=(s=e==null?void 0:e.choices)==null?void 0:s[0])==null?void 0:n.message)==null?void 0:i.content)??"",Usage:{InputTokens:t.prompt_tokens??null,OutputTokens:t.completion_tokens??null}}}ParseStreamEvent(e){var s,n,i;return e?e==="[DONE]"?{Content:"",IsDone:!0}:{Content:((i=(n=(s=e==null?void 0:e.choices)==null?void 0:s[0])==null?void 0:n.delta)==null?void 0:i.content)??"",IsDone:!1}:{Content:"",IsDone:!1}}MapMessages(e){return e.map(t=>({role:(t.Role??"user").toLowerCase(),content:t.Content??""}))}async BuildError(e){const t=await this.TryReadMessage(e),s=new Error(t??"Grok validation failed.");return s.Status=e.status,s}async TryReadMessage(e){var t;try{const s=await e.json();return((t=s==null?void 0:s.error)==null?void 0:t.message)??(s==null?void 0:s.message)}catch{return null}}}const de=Object.freeze({MissingKey:"MissingKey",Unauthorized:"Unauthorized",Forbidden:"Forbidden",RateLimited:"RateLimited",ServiceUnavailable:"ServiceUnavailable",NetworkError:"NetworkError",Unknown:"Unknown"});class Ks{static BuildError({Code:e,Message:t,Status:s}){const n=new Error(t);return n.Code=e,n.Status=s,n}static Normalize(e){if(!e)return{Code:de.Unknown,Message:"Validation failed. Please try again."};if(e.Code===de.MissingKey)return{Code:de.MissingKey,Message:"API key required before testing."};if(e.Code&&e.Message)return{Code:e.Code,Message:e.Message};const t=e.Status??e.status;return t===401?{Code:de.Unauthorized,Message:"API key rejected. Check the key and try again."}:t===403?{Code:de.Forbidden,Message:"Access denied for this API key."}:t===429?{Code:de.RateLimited,Message:"Provider is rate limiting requests. Try again shortly."}:t>=500?{Code:de.ServiceUnavailable,Message:"Provider service is unavailable. Try again later."}:e.name==="TypeError"?{Code:de.NetworkError,Message:"Network error while contacting provider."}:{Code:de.Unknown,Message:"Validation failed. Please try again."}}}class Sr{constructor({ProviderRegistry:e,ProviderLogger:t}){this.ProviderRegistry=e,this.ProviderLogger=t}async ValidateAsync(e,t){var s,n,i,r;if(!t)return{Status:"failure",Message:Ks.BuildError({Code:de.MissingKey,Message:"API key required before testing."}).message};(s=this.ProviderLogger)==null||s.LogValidationStart(e);try{const l={Status:"success",Message:"API key validated successfully.",ModelIds:await this.ProviderRegistry.ListModelIds(e,t)};return(n=this.ProviderLogger)==null||n.LogValidationEnd(e,l),l}catch(a){(i=this.ProviderLogger)==null||i.LogValidationFailure(e,a);const c={Status:"failure",Message:Ks.Normalize(a).Message};return(r=this.ProviderLogger)==null||r.LogValidationEnd(e,c),c}}}class vr{constructor({Logger:e}){this.Logger=e}LogValidationStart(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||s.call(t,"Providers.Validate",{ProviderId:e})}LogValidationEnd(e,t){var s,n;(n=(s=this.Logger)==null?void 0:s.LogFlowEnd)==null||n.call(s,"Providers.Validate",{ProviderId:e,Result:t})}LogValidationFailure(e,t){var s,n;(n=(s=this.Logger)==null?void 0:s.LogWarning)==null||n.call(s,"Providers.Validate.Failed",{ProviderId:e,Error:(t==null?void 0:t.message)??"Unknown error"})}}class br{constructor({Providers:e}={}){this.Providers=new Map((e??[]).map(t=>[t.Id,t]))}GetProvider(e){const t=this.Providers.get(e);if(!t)throw new Error(`Chat provider not registered: ${e}`);return t}}class Cr{BuildContext({Messages:e}){return[...e??[]].sort((s,n)=>s.CreatedUtc===n.CreatedUtc?0:s.CreatedUtc<n.CreatedUtc?-1:1).map(s=>({Role:s.Role,Content:s.Content,Kind:s.Kind}))}}class yr{constructor({ChatRegistry:e,ContextBuilder:t,ChatLogger:s,Configuration:n,Fetch:i}){this.ChatRegistry=e,this.ContextBuilder=t,this.ChatLogger=s,this.Configuration=n,this.Fetch=i??((...r)=>globalThis.fetch(...r))}async SendAsync({ProviderId:e,ModelId:t,Key:s,Messages:n,Stream:i,OnToken:r,ModelConfig:a,Signal:l}){var C,M,T,I,k,R,z,K;const c=this.ChatRegistry.GetProvider(e),u=this.ContextBuilder.BuildContext({Messages:n,ProviderId:e,ModelId:t}),p=this.ResolveRequestSettings(e),h=((a==null?void 0:a.Endpoint)??"chat")!=="responses",m=Date.now(),f=c.BuildChatRequest({Key:s,ModelId:t,Messages:u,Stream:i&&c.SupportsStreaming&&h,MaxOutputTokens:p.MaxOutputTokens,ModelConfig:a}),S=i&&c.SupportsStreaming&&h,b={ProviderId:e,ModelId:t,Stream:S};(M=(C=this.ChatLogger)==null?void 0:C.LogSendStart)==null||M.call(C,b);try{if(S){const Z=await this.StreamResponse(c,f,p,r,l),F=this.BuildMetrics(Z,m);return(I=(T=this.ChatLogger)==null?void 0:T.LogSendEnd)==null||I.call(T,{...b,Length:Z.Content.length}),{Content:Z.Content,IsStreamed:!0,Metrics:F}}const P=await this.FetchResponse(c,f,p,l),_=this.BuildMetrics(P,m);return(R=(k=this.ChatLogger)==null?void 0:k.LogSendEnd)==null||R.call(k,{...b,Length:P.Content.length}),{Content:P.Content,IsStreamed:!1,Metrics:_}}catch(P){if(((l==null?void 0:l.aborted)&&(P==null?void 0:P.name)==="AbortError"||(P==null?void 0:P.name)==="AbortError")&&!(P!=null&&P.Metrics))try{P.Metrics=this.BuildMetrics({Usage:(P==null?void 0:P.Usage)??null},m)}catch{}throw(K=(z=this.ChatLogger)==null?void 0:z.LogSendFailure)==null||K.call(z,{...b,Error:(P==null?void 0:P.message)??"Unknown error"}),P}}BuildAbortError(){if(typeof DOMException<"u")return new DOMException("Aborted","AbortError");const e=new Error("Aborted");return e.name="AbortError",e}ResolveRequestSettings(e){var i,r,a;const t=((i=this.Configuration)==null?void 0:i[Le.Chat])??{},s=t[xs.Requests]??{},n=((a=(r=t[xs.ProviderOverrides])==null?void 0:r[e])==null?void 0:a.Requests)??{};return{TimeoutMs:n[Ne.TimeoutMs]??s[Ne.TimeoutMs],MaxRetries:0,BackoffMs:n[Ne.BackoffMs]??s[Ne.BackoffMs],MaxOutputTokens:n[Ne.MaxOutputTokens]??s[Ne.MaxOutputTokens]}}async FetchResponse(e,t,s,n){let i=null;try{const r=n?new Promise((p,g)=>{if(n.aborted){g(this.BuildAbortError());return}const h=()=>g(this.BuildAbortError());typeof n.addEventListener=="function"?(n.addEventListener("abort",h,{once:!0}),i=()=>n.removeEventListener("abort",h)):(n.onabort=h,i=()=>{n.onabort===h&&(n.onabort=null)})}):null,a=this.FetchWithTimeout(t,s.TimeoutMs,n),l=await(r?Promise.race([a,r]):a);if(!l.ok)throw await e.BuildError(l);const c=await l.json(),u=e.ParseChatResponse(c);return this.NormalizeParsedResponse(u)}finally{i==null||i()}}async StreamResponse(e,t,s,n,i){var f;const r=await this.FetchWithTimeout(t,s.TimeoutMs,i);if(!r.ok)throw await e.BuildError(r);const a=(f=r.body)==null?void 0:f.getReader();if(!a)throw new Error("Streaming not supported in this environment.");const l=new TextDecoder;let c="",u="",p=null,g=null;const h=i?this.BuildAbortError():null,m=i?new Promise((S,b)=>{if(i.aborted){try{h.Usage=p,h.PartialContent=u}catch{}b(h);return}const C=()=>{try{h.Usage=p,h.PartialContent=u}catch{}b(h)};typeof i.addEventListener=="function"?(i.addEventListener("abort",C,{once:!0}),g=()=>i.removeEventListener("abort",C)):(i.onabort=C,g=()=>{i.onabort===C&&(i.onabort=null)})}):null;try{for(;;){let S;try{S=await(m?Promise.race([a.read(),m]):a.read())}catch(C){if(i!=null&&i.aborted&&(C==null?void 0:C.name)==="AbortError"){try{await a.cancel()}catch{}try{C.Usage=(C==null?void 0:C.Usage)??p,C.PartialContent=(C==null?void 0:C.PartialContent)??u}catch{}}throw C}if(S.done)break;c+=l.decode(S.value,{stream:!0});const b=c.split(`

`);c=b.pop()??"";for(const C of b){const M=this.ExtractSseData(C);if(!M)continue;const T=M==="[DONE]"?"[DONE]":JSON.parse(M),I=e.ParseStreamEvent(T);if(I.Content&&(u+=I.Content,n==null||n(I.Content)),I.Usage&&(p=I.Usage),I.IsDone)return{Content:u,Usage:p}}}return{Content:u,Usage:p}}finally{g==null||g()}}ExtractSseData(e){const s=e.split(`
`).map(n=>n.trim()).filter(n=>n.startsWith("data:")).map(n=>n.replace(/^data:\s?/,""));return s.length===0?null:s.join(`
`)}async FetchWithTimeout(e,t,s){const n=new AbortController,r=typeof t=="number"&&t>0?setTimeout(()=>n.abort(),t):null;let a=null;if(s)if(s.aborted)n.abort();else{const l=()=>n.abort();typeof s.addEventListener=="function"?(s.addEventListener("abort",l,{once:!0}),a=()=>s.removeEventListener("abort",l)):(s.onabort=l,a=()=>{s.onabort===l&&(s.onabort=null)})}try{return await this.Fetch(e.Url,{method:"POST",headers:e.Headers,body:JSON.stringify(e.Body),signal:n.signal})}finally{r&&clearTimeout(r),a==null||a()}}NormalizeParsedResponse(e){return e?typeof e=="string"?{Content:e,Usage:null}:{Content:e.Content??"",Usage:e.Usage??null}:{Content:"",Usage:null}}BuildMetrics(e,t){const s=Math.max(Date.now()-t,0),n=(e==null?void 0:e.Usage)??{};return{DurationMs:s,InputTokens:n.InputTokens??null,OutputTokens:n.OutputTokens??null}}}class Ir{constructor({Logger:e}={}){this.Logger=e}LogSendStart(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||s.call(t,"Chat.Send",e)}LogSendEnd(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogFlowEnd)==null||s.call(t,"Chat.Send",e)}LogSendFailure(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogWarning)==null||s.call(t,"Chat.Send.Failed",e)}LogStreamStart(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogFlowStart)==null||s.call(t,"Chat.Stream",e)}LogStreamEnd(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogFlowEnd)==null||s.call(t,"Chat.Stream",e)}LogStreamFailure(e){var t,s;(s=(t=this.Logger)==null?void 0:t.LogWarning)==null||s.call(t,"Chat.Stream.Failed",e)}}const kr=(o,e,t)=>Math.min(Math.max(o,e),t),wr=o=>(o??"").trim(),qs=o=>(o??"").toString(),Mr=({StartIndex:o,FieldLength:e,PositionMinMultiplier:t})=>{const s=Number(t);return!Number.isFinite(s)||e<=1?1:1-kr(o/(e-1),0,1)*(1-s)},xr=({Text:o,Query:e})=>{const t=(o??"").toString(),s=(e??"").toString();if(!s.trim())return[];const n=t.toLowerCase(),i=s.toLowerCase(),r=[];let a=0;for(;a<=n.length-i.length;){const l=n.indexOf(i,a);if(l===-1)break;r.push({StartIndex:l,EndIndex:l+i.length,FieldLength:n.length}),a=l+1}return r},js=({Text:o,Query:e,BaseMultiplier:t,PositionMinMultiplier:s})=>{const n=xr({Text:o,Query:e});if(n.length===0)return{Matches:[],TotalScore:0,BestMatch:null};const i=Number(t),r=Number.isFinite(i)?i:1,a=n.map(u=>{const p=Mr({StartIndex:u.StartIndex,FieldLength:u.FieldLength,PositionMinMultiplier:s}),g=r*p;return{...u,BaseMultiplier:r,PositionMultiplier:p,Score:g}}),l=a.reduce((u,p)=>u?p.Score===u.Score?p.StartIndex<u.StartIndex?p:u:p.Score>u.Score?p:u:p,null),c=a.reduce((u,p)=>u+p.Score,0);return{Matches:a,TotalScore:c,BestMatch:l}},Vs=o=>{const e=(o??"").toString(),t=new Date(e);return Number.isNaN(t.getTime())?new Date(0):t},Tr=Object.freeze({TitleMatchMultiplier:2,BodyMatchMultiplier:1,PositionMinMultiplier:.5,MaxResults:50,ExcerptContextChars:48,ExcerptMaxLength:180}),Xe=(o,e,t)=>Math.min(Math.max(o,e),t),Lr=({Text:o,MatchStart:e,MatchLength:t,ExcerptContextChars:s,ExcerptMaxLength:n})=>{const i=(o??"").toString(),r=Xe(e,0,Math.max(i.length,0)),a=Xe(e+t,0,Math.max(i.length,0)),l=Xe(Number(s)||0,0,1e3),c=Xe(Number(n)||180,20,2e3),u="...",p="...",g=a-r,h=Math.max(c-(u.length+p.length),g),m=Math.floor(Math.max(h-g,0)/2);let f=Math.max(r-Math.max(l,m),0),S=Math.min(a+Math.max(l,m),i.length);(()=>{if(S-f<=h)return;f=Math.max(r-Math.floor((h-g)/2),0),S=Math.min(f+h,i.length),S-f<h&&(f=Math.max(S-h,0))})();const C=f>0,M=S<i.length,T=C?u:"",I=M?p:"",k=i.slice(f,S),R=`${T}${k}${I}`,z=T.length+(r-f),K=z+(a-r);return{ExcerptText:R,ExcerptMatchStart:z,ExcerptMatchEnd:K}};class dn{SearchPinnedChats({Conversations:e,MessagesByConversation:t,Query:s,Config:n}={}){const i=wr(s);if(!i)return[];const r={...Tr,...n??{}},a=Xe(Number(r.MaxResults)||50,1,500),c=(e??[]).filter(u=>u==null?void 0:u.IsPinned).map(u=>{const p=qs((u==null?void 0:u.Title)??""),m=((t??{})[u.Id]??[]??[]).filter(I=>{const k=((I==null?void 0:I.Role)??"").toString(),R=((I==null?void 0:I.Kind)??"").toString();return!(k!=="User"&&k!=="Assistant"||R==="Internal"||R==="System")}).map(I=>qs((I==null?void 0:I.Content)??"")),f=js({Text:p,Query:i,BaseMultiplier:r.TitleMatchMultiplier,PositionMinMultiplier:r.PositionMinMultiplier}),S=m.map(I=>js({Text:I,Query:i,BaseMultiplier:r.BodyMatchMultiplier,PositionMinMultiplier:r.PositionMinMultiplier})),b=[...f.Matches.map(I=>({Field:"title",Text:p,...I})),...S.flatMap((I,k)=>I.Matches.map(R=>({Field:"body",Text:m[k],...R})))],C=b.reduce((I,k)=>I+(k.Score??0),0),M=b.reduce((I,k)=>I?k.Score===I.Score?k.StartIndex<I.StartIndex?k:I:k.Score>I.Score?k:I:k,null);if(!M||C<=0)return null;const T=Lr({Text:M.Text,MatchStart:M.StartIndex,MatchLength:i.length,ExcerptContextChars:r.ExcerptContextChars,ExcerptMaxLength:r.ExcerptMaxLength});return{ConversationId:u.Id,Title:p,Score:C,LastUpdatedUtc:u.LastUpdatedUtc??u.CreatedUtc??null,...T}}).filter(Boolean);return c.sort((u,p)=>{if(u.Score===p.Score){const g=Vs(u.LastUpdatedUtc);return Vs(p.LastUpdatedUtc).getTime()-g.getTime()}return p.Score-u.Score}),c.slice(0,a)}}const Pr=Object.freeze({AppTitle:"Ghostplug",WelcomeHeading:"How can I help?",InputPlaceholder:"Ask anything",NotImplemented:"Not implemented",PendingMessage:"Waiting for response...",Chat:{WaitForResponseToastText:"Waiting for a response. Please wait or abort before switching chats.",AbortedToastText:"Response aborted.",AbortedMessageText:"Response aborted."},RetryAction:"Retry",RetryConfirmTitle:"Use the newly selected model?",RetryConfirmMessage:"You changed the selected model since the failed request. Use the new selection for retry?",RetryConfirmYes:"Yes",RetryConfirmNo:"No",Sidebar:{NewChat:"New chat",Search:"Search chats",Conversations:"Chats",Settings:"Settings"},ModelSelector:{Label:"Models"},Attachments:{AttachFiles:"Attach files"}}),un=1.5,hn=10,pn=.75,gn=.75,fn=3,mn=2.5,Sn=1.25,vn=un*hn,Ar=fn+vn+mn+gn+pn*2+Sn,Er=Math.max(24,Ar),Rr=Object.freeze({ChatBottomPadding:`${Er}rem`,InputLineHeightRem:un,InputMaxLines:hn,InputShellPaddingRem:pn,InputShellGapRem:gn,InputBottomGapRem:fn,InputButtonRowRem:mn,InputSafetyPaddingRem:Sn,InputMaxHeightRem:vn,SnackbarDurationMs:2400,ModelDescriptionDurationMs:5e3,ModelDescriptionFadeOutMs:1e3}),zt=Object.freeze({Themes:[{Id:"light",Label:"Light"},{Id:"dark",Label:"Dark"},{Id:"system",Label:"System"}],Accents:[{Id:"lime",Label:"Lime",Hex:"#84cc16"},{Id:"sunset",Label:"Sunset",Hex:"#ff6b6b"},{Id:"citrus",Label:"Citrus",Hex:"#f97316"},{Id:"electric",Label:"Electric",Hex:"#22d3ee"},{Id:"royal",Label:"Royal",Hex:"#6366f1"},{Id:"mint",Label:"Mint",Hex:"#10b981"},{Id:"magenta",Label:"Magenta",Hex:"#ec4899"},{Id:"amber",Label:"Amber",Hex:"#f59e0b"}],Providers:[]}),bn=({IsOpen:o=!1,ActiveCategory:e="general",General:t={},Chat:s={},Providers:n={},ProvidersCatalog:i=null}={})=>{const r=i??zt.Providers;return{IsOpen:o,ActiveCategory:e,Options:zt,General:{Theme:t.Theme??"system",AccentColor:t.AccentColor??zt.Accents[0].Id},Chat:{InternalChatMessages:s.InternalChatMessages??!1},Providers:{SelectedProviderId:n.SelectedProviderId??null,Providers:r.map(a=>({...a,Models:a.Models.map(l=>({...l}))})),Keys:{openai:"",anthropic:"",google:"",grok:""},KeyVisibility:{},ValidationPopup:null,ModelAvailability:{}}}},Ze=Object.freeze({Models:[{Id:"gpt-4o-mini",Label:"GPT-4o Mini",Description:"Fast responses",IsDefault:!0},{Id:"gpt-4o",Label:"GPT-4o",Description:"Balanced reasoning",IsDefault:!1},{Id:"gpt-4.1",Label:"GPT-4.1",Description:"Deeper analysis",IsDefault:!1}],Conversations:[{Id:"conv-001",Title:"Welcome chat",LastUpdatedUtc:"2025-12-25T09:00:00Z",Preview:"Hello..."},{Id:"conv-002",Title:"Layout ideas",LastUpdatedUtc:"2025-12-24T15:10:00Z",Preview:"Sidebar and input..."},{Id:"conv-003",Title:"Model switch",LastUpdatedUtc:"2025-12-24T08:30:00Z",Preview:"Dropdown behaviors..."}],MessagesByConversation:{"conv-001":[{Id:"msg-001",ConversationId:"conv-001",Role:"User",Content:"hello",TimestampUtc:"2025-12-25T09:00:00Z"},{Id:"msg-002",ConversationId:"conv-001",Role:"Assistant",Content:"Hello, Borivoje — what are you working on today?",TimestampUtc:"2025-12-25T09:00:10Z"}]}}),Dr=({ActiveConversationId:o=null,IsSidebarCollapsed:e=!1,InputText:t="",IsSending:s=!1,RetryPopup:n=null,ChatSearch:i=null,Conversations:r=Ze.Conversations,MessagesByConversation:a=Ze.MessagesByConversation,MessageGroupsByConversation:l={},SelectedModelId:c=null,Settings:u=null,ProvidersCatalog:p=null,ModelSelection:g=null}={})=>{const h=Ze.Models.find(m=>m.IsDefault)??Ze.Models[0];return{IsSidebarCollapsed:e,ActiveConversationId:o,Conversations:r,MessagesByConversation:a,MessageGroupsByConversation:l,Models:Ze.Models,InputText:t,IsSending:s,RetryPopup:n,ChatSearch:i??{IsOpen:!1,Query:"",Results:[],Error:null},SelectedModelId:c??(h==null?void 0:h.Id)??null,ModelSelection:g??{LastUserSelectedModelId:null,AutoSelectedModelId:null,DescriptionText:null},Text:Pr,Layout:Rr,Settings:u??bn({ProvidersCatalog:p})}};class Be{static CreateConversation({Title:e,ProviderId:t,ModelId:s}){const n=new Date().toISOString();return{Id:crypto.randomUUID(),Title:e??"",IsPinned:!1,CreatedUtc:n,LastUpdatedUtc:n,LastProviderId:t??null,LastModelId:s??null,ScrollPosition:0}}static CreateMessage({ConversationId:e,Role:t,Kind:s,Content:n,ProviderId:i,ModelId:r,Status:a}){return{Id:crypto.randomUUID(),ConversationId:e,Role:t,Kind:s,Content:n,CreatedUtc:new Date().toISOString(),ProviderId:i??null,ModelId:r??null,Status:a??"pending",Metrics:null}}static CreateMessageGroup({ConversationId:e,UserMessageId:t,InternalMessageIds:s,AssistantMessageId:n}){return{Id:crypto.randomUUID(),ConversationId:e,UserMessageId:t,InternalMessageIds:s??[],AssistantMessageId:n??null,InternalVisible:!1}}static TouchConversation(e,{ProviderId:t,ModelId:s}={}){return{...e,LastUpdatedUtc:new Date().toISOString(),LastProviderId:t??e.LastProviderId,LastModelId:s??e.LastModelId}}}const rs=o=>o==null?"":String(o).trim().replace(/\s+/g," "),Ct=o=>rs(o).toLowerCase(),_r=o=>{Object.assign(o.prototype,{GetActiveConversation(){var t;const e=(t=this.State)==null?void 0:t.ActiveConversationId;return e?(this.State.Conversations??[]).find(s=>s.Id===e)??null:null},HasActiveUnpinnedContent(){var n,i,r;const e=((((n=this.State)==null?void 0:n.InputText)??"").trim().length??0)>0,t=this.GetActiveConversation();if(!t)return e;if(t.IsPinned)return!1;const s=((r=(i=this.State)==null?void 0:i.MessagesByConversation)==null?void 0:r[t.Id])??[];return e||((s==null?void 0:s.length)??0)>0},RequestNewChat(){var e,t,s,n,i;if((e=this.State)!=null&&e.IsSending){this.ShowSnackbar((n=(s=(t=this.State)==null?void 0:t.Text)==null?void 0:s.Chat)==null?void 0:n.WaitForResponseToastText);return}if(this.Logger.LogFlowStart("ChatSaving.NewChat.Request",{ActiveConversationId:((i=this.State)==null?void 0:i.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"new-chat"}}),this.Logger.LogFlowEnd("ChatSaving.NewChat.Request",{Result:"prompted"});return}this.ExecuteNewChat()},ExecuteNewChat(){this.UpdateState({ActiveConversationId:null,InputText:"",ChatSaving:null,ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSaving.NewChat.Request",{Result:"started"})},RequestSelectConversation(e){var t,s,n,i,r,a;if((t=this.State)!=null&&t.IsSending){this.ShowSnackbar((i=(n=(s=this.State)==null?void 0:s.Text)==null?void 0:n.Chat)==null?void 0:i.WaitForResponseToastText);return}if(e&&e!==((r=this.State)==null?void 0:r.ActiveConversationId)){if(this.Logger.LogFlowStart("ChatSaving.SelectConversation.Request",{SelectedConversationId:e,ActiveConversationId:((a=this.State)==null?void 0:a.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"select-conversation",ConversationId:e}}),this.Logger.LogFlowEnd("ChatSaving.SelectConversation.Request",{Result:"prompted"});return}this.ExecuteSelectConversation(e)}},ExecuteSelectConversation(e){this.UpdateState({ActiveConversationId:e,InputText:"",ChatSaving:null,ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSaving.SelectConversation.Request",{Result:"selected"})},OpenDiscardDialog({NextAction:e}={}){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},DiscardDialog:{IsOpen:!0,NextAction:e??null}}})},CloseDiscardDialog(){var e,t,s;(s=(t=(e=this.State)==null?void 0:e.ChatSaving)==null?void 0:t.DiscardDialog)!=null&&s.IsOpen&&(this.UpdateState({ChatSaving:null}),this.Logger.LogFlowEnd("ChatSaving.Discard",{Result:"cancelled"}))},ConfirmDiscard(){var u,p,g,h;const e=((g=(p=(u=this.State)==null?void 0:u.ChatSaving)==null?void 0:p.DiscardDialog)==null?void 0:g.NextAction)??null,t=this.GetActiveConversation(),s=((h=this.State)==null?void 0:h.ActiveConversationId)??null,i=t&&!t.IsPinned&&!!s;let r=this.State.Conversations??[],a=this.State.MessagesByConversation??{},l=this.State.MessageGroupsByConversation??{};i&&s&&(r=r.filter(m=>m.Id!==s),a={...a},delete a[s],l={...l},delete l[s]);const c={Conversations:r,MessagesByConversation:a,MessageGroupsByConversation:l,InputText:"",ChatSaving:null};(e==null?void 0:e.Type)==="select-conversation"?c.ActiveConversationId=e.ConversationId??null:(e==null?void 0:e.Type)==="select-chat-search-result"?(c.ActiveConversationId=e.ConversationId??null,c.ChatSearch={IsOpen:!1,Query:"",Results:[],Error:null}):(e==null?void 0:e.Type)==="new-chat"&&(c.ActiveConversationId=null),this.UpdateState(c),this.Logger.LogFlowEnd("ChatSaving.Discard",{Result:"confirmed",NextAction:(e==null?void 0:e.Type)??null})},RequestTogglePin(){var s;if((s=this.State)!=null&&s.IsSending)return;const e=this.GetActiveConversation();if(e!=null&&e.IsPinned){this.UnpinConversation(e.Id);return}const t=(e==null?void 0:e.Title)??"";this.OpenPinDialog({Name:t})},OpenPinDialog({Name:e}={}){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{IsOpen:!0,Name:e??"",ErrorText:null}}})},ClosePinDialog(){var e,t,s;(s=(t=(e=this.State)==null?void 0:e.ChatSaving)==null?void 0:t.PinDialog)!=null&&s.IsOpen&&(this.UpdateState({ChatSaving:null}),this.Logger.LogFlowEnd("ChatSaving.Pin",{Result:"cancelled"}))},UpdatePinDialogName(e){var t,s,n,i;(n=(s=(t=this.State)==null?void 0:t.ChatSaving)==null?void 0:s.PinDialog)!=null&&n.IsOpen&&(this.State={...this.State,ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...((i=this.State.ChatSaving)==null?void 0:i.PinDialog)??{},Name:e??"",ErrorText:null}}})},ConfirmPinFromDialog(){var u,p,g,h,m,f;const e=(p=(u=this.State)==null?void 0:u.ChatSaving)==null?void 0:p.PinDialog;if(!(e!=null&&e.IsOpen))return;this.Logger.LogFlowStart("ChatSaving.Pin",{ActiveConversationId:((g=this.State)==null?void 0:g.ActiveConversationId)??null});const t=rs(e.Name??""),s=((m=(h=this.State)==null?void 0:h.Text)==null?void 0:m.ChatSaving)??{};if(!t){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...e,Name:e.Name??"",ErrorText:s.PinDialogEmptyError??null}}});return}const n=Ct(t);if((this.State.Conversations??[]).filter(S=>S==null?void 0:S.IsPinned).some(S=>Ct((S==null?void 0:S.Title)??"")===n)){this.UpdateState({ChatSaving:{...this.State.ChatSaving??{},PinDialog:{...e,Name:t,ErrorText:s.PinDialogDuplicateError??null}}});return}const a=new Date().toISOString();let l=((f=this.State)==null?void 0:f.ActiveConversationId)??null,c=this.State.Conversations??[];if(l){const S=this.GetActiveConversation();if(!S){this.Logger.LogError("ChatSaving.Pin.MissingActiveConversation",{ActiveConversationId:l});return}const b={...S,Title:t,IsPinned:!0,LastUpdatedUtc:a};c=[b,...c.filter(C=>C.Id!==b.Id)],this.UpdateState({Conversations:c,ChatSaving:null})}else{const S=Be.CreateConversation({Title:t});S.IsPinned=!0,S.LastUpdatedUtc=a,l=S.Id,c=[S,...c],this.UpdateState({Conversations:c,ActiveConversationId:l,ChatSaving:null})}this.ShowSnackbar(s.PinnedToastText),this.Logger.LogFlowEnd("ChatSaving.Pin",{Result:"pinned",Name:t})},UnpinConversation(e){var r,a;if(!e)return;const t=(this.State.Conversations??[]).find(l=>l.Id===e);if(!t)return;const s=((a=(r=this.State)==null?void 0:r.Text)==null?void 0:a.ChatSaving)??{},n={...t,IsPinned:!1,LastUpdatedUtc:new Date().toISOString()},i=(this.State.Conversations??[]).map(l=>l.Id===e?n:l);this.UpdateState({Conversations:i,ChatSaving:null}),this.ShowSnackbar(s.UnpinnedToastText),this.Logger.LogFlowEnd("ChatSaving.Unpin",{Result:"unpinned",ConversationId:e})}})},Or=o=>{Object.assign(o.prototype,{OpenChatSearch(){var e,t,s,n,i;if((e=this.State)!=null&&e.IsSending){this.ShowSnackbar((n=(s=(t=this.State)==null?void 0:t.Text)==null?void 0:s.Chat)==null?void 0:n.WaitForResponseToastText);return}this.Logger.LogFlowStart("ChatSearch.Open",{ActiveConversationId:((i=this.State)==null?void 0:i.ActiveConversationId)??null}),this.UpdateState({ChatSearch:{IsOpen:!0,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSearch.Open",{Result:"opened"})},CloseChatSearch(){var e,t;(t=(e=this.State)==null?void 0:e.ChatSearch)!=null&&t.IsOpen&&(this.ChatSearchDebounceTimer&&(clearTimeout(this.ChatSearchDebounceTimer),this.ChatSearchDebounceTimer=null),this.UpdateState({ChatSearch:{IsOpen:!1,Query:"",Results:[],Error:null}}),this.Logger.LogFlowEnd("ChatSearch.Close",{Result:"closed"}))},UpdateChatSearchQuery(e){var i,r,a,l,c;if(!((r=(i=this.State)==null?void 0:i.ChatSearch)!=null&&r.IsOpen))return;const t=e??"",s=Number(((c=(l=(a=this.State)==null?void 0:a.Text)==null?void 0:l.ChatSearch)==null?void 0:c.DebounceMs)??0),n=Number.isFinite(s)?Math.max(0,s):0;this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Query:t,Error:null}}),this.ChatSearchDebounceTimer&&(clearTimeout(this.ChatSearchDebounceTimer),this.ChatSearchDebounceTimer=null),this.ChatSearchDebounceTimer=setTimeout(()=>{this.ChatSearchDebounceTimer=null,this.ComputeChatSearchResults()},n)},ComputeChatSearchResults(){var n,i,r,a,l,c,u;if(!((i=(n=this.State)==null?void 0:n.ChatSearch)!=null&&i.IsOpen))return;const e=((r=this.State.ChatSearch)==null?void 0:r.Query)??"",t=((l=(a=this.State)==null?void 0:a.Text)==null?void 0:l.ChatSearch)??{},s=performance.now();try{const p=this.ChatSearchService.SearchPinnedChats({Conversations:((c=this.State)==null?void 0:c.Conversations)??[],MessagesByConversation:((u=this.State)==null?void 0:u.MessagesByConversation)??{},Query:e,Config:t}),g=performance.now()-s;this.Logger.LogInformation("ChatSearch.Query.Updated",{QueryLength:(e??"").length,ResultCount:p.length,DurationMs:Math.round(g)}),this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Results:p,Error:null}})}catch(p){this.Logger.LogError("ChatSearch.Query.Failed",{Error:(p==null?void 0:p.message)??"Unknown error"}),this.UpdateState({ChatSearch:{...this.State.ChatSearch??{},Results:[],Error:(p==null?void 0:p.message)??"Search failed."}})}},RequestSelectChatSearchResult(e){var t,s,n,i,r,a;if((t=this.State)!=null&&t.IsSending){this.ShowSnackbar((i=(n=(s=this.State)==null?void 0:s.Text)==null?void 0:n.Chat)==null?void 0:i.WaitForResponseToastText);return}if(e){if(e===((r=this.State)==null?void 0:r.ActiveConversationId)){this.CloseChatSearch();return}if(this.Logger.LogFlowStart("ChatSearch.SelectResult.Request",{SelectedConversationId:e,ActiveConversationId:((a=this.State)==null?void 0:a.ActiveConversationId)??null}),this.HasActiveUnpinnedContent()){this.OpenDiscardDialog({NextAction:{Type:"select-chat-search-result",ConversationId:e}}),this.Logger.LogFlowEnd("ChatSearch.SelectResult.Request",{Result:"prompted"});return}this.ExecuteSelectConversation(e),this.Logger.LogFlowEnd("ChatSearch.SelectResult.Request",{Result:"selected"})}}})},$r=o=>{Object.assign(o.prototype,{PersistState(){var s,n,i,r,a,l,c,u,p,g;const e=this.SanitizeState(this.State);try{Promise.resolve((n=(s=this.AppStateStore)==null?void 0:s.SaveStateAsync)==null?void 0:n.call(s,e)).catch(h=>{var m,f,S;this.Logger.LogError("App.State.SaveFailed",{Error:(h==null?void 0:h.message)??"Unknown error"}),this.ShowSnackbar((S=(f=(m=this.State)==null?void 0:m.Text)==null?void 0:f.ChatSaving)==null?void 0:S.StorageErrorText)})}catch(h){this.Logger.LogError("App.State.SaveFailed",{Error:(h==null?void 0:h.message)??"Unknown error"}),this.ShowSnackbar((a=(r=(i=this.State)==null?void 0:i.Text)==null?void 0:r.ChatSaving)==null?void 0:a.StorageErrorText)}const t=this.ExtractConversationState(this.State);try{Promise.resolve((c=(l=this.ConversationStore)==null?void 0:l.SaveStateAsync)==null?void 0:c.call(l,t)).catch(h=>{var m,f,S;this.Logger.LogError("Conversation.State.SaveFailed",{Error:(h==null?void 0:h.message)??"Unknown error"}),this.ShowSnackbar((S=(f=(m=this.State)==null?void 0:m.Text)==null?void 0:f.ChatSaving)==null?void 0:S.StorageErrorText)})}catch(h){this.Logger.LogError("Conversation.State.SaveFailed",{Error:(h==null?void 0:h.message)??"Unknown error"}),this.ShowSnackbar((g=(p=(u=this.State)==null?void 0:u.Text)==null?void 0:p.ChatSaving)==null?void 0:g.StorageErrorText)}},SanitizeState(e){const{Layout:t,Text:s,Conversations:n,MessagesByConversation:i,MessageGroupsByConversation:r,ChatSearch:a,...l}=e,u=new Set((n??[]).filter(p=>p==null?void 0:p.IsPinned).map(p=>p.Id).filter(Boolean)).has(e.ActiveConversationId)?e.ActiveConversationId:null;return{...l,ActiveConversationId:u,IsSending:!1,RetryPopup:null,ChatSaving:null,ChatSearch:null,Settings:{...e.Settings,Providers:{...e.Settings.Providers,Keys:bn().Providers.Keys,KeyVisibility:{},ValidationPopup:null}}}},ExtractConversationState(e){const t=new Set((e.Conversations??[]).filter(n=>n==null?void 0:n.IsPinned).map(n=>n.Id).filter(Boolean)),s=n=>t.has(n);return{Conversations:(e.Conversations??[]).filter(n=>s(n.Id)),MessagesByConversation:Object.fromEntries(Object.entries(e.MessagesByConversation??{}).filter(([n])=>s(n))),MessageGroupsByConversation:Object.fromEntries(Object.entries(e.MessageGroupsByConversation??{}).filter(([n])=>s(n)))}},BuildText(e,{AppName:t}={}){var r,a,l,c,u,p;const s=((a=(r=this.Configuration)==null?void 0:r[Le.Ui])==null?void 0:a.Chat)??{},n=((c=(l=this.Configuration)==null?void 0:l[Le.Ui])==null?void 0:c.ChatSaving)??{},i=((p=(u=this.Configuration)==null?void 0:u[Le.Ui])==null?void 0:p.ChatSearch)??{};return{...e??{},AppTitle:t??(e==null?void 0:e.AppTitle),Chat:{...(e==null?void 0:e.Chat)??{},...s},ChatSaving:n,ChatSearch:i}},NormalizeStoredConversationState(e){var r;if(!((r=e==null?void 0:e.Conversations)!=null&&r.length)||e.Conversations.some(a=>Object.prototype.hasOwnProperty.call(a??{},"IsPinned")))return e;const s=new Set,n=[],i=e.Conversations.map(a=>{const l=(a==null?void 0:a.Title)??"",c=rs(l);if(!c)return{...a,IsPinned:!0};let u=c,p=1;for(;s.has(Ct(u));)p+=1,u=`${c} (${p})`;const g=Ct(u);return g&&s.add(g),u!==l&&n.push({ConversationId:a==null?void 0:a.Id,From:l,To:u}),{...a,Title:u,IsPinned:!0}});return this.Logger.LogFlowStart("Conversation.Migration.LegacyPinned.Start",{ConversationCount:e.Conversations.length}),n.length>0&&this.Logger.LogWarning("Conversation.Migration.LegacyPinned.Renamed",{Renamed:n}),this.Logger.LogFlowEnd("Conversation.Migration.LegacyPinned.End",{RenamedCount:n.length}),{...e,Conversations:i}},ShowSnackbar(e){var t,s;e&&((s=(t=this.RootView)==null?void 0:t.Snackbar)==null||s.Show(e))},MergeState(e,t){if(!t)return e;const s={...e,...t};return s.Layout=e.Layout,s.Text=e.Text,s.Conversations=e.Conversations,s.MessagesByConversation=e.MessagesByConversation,s.MessageGroupsByConversation=e.MessageGroupsByConversation,s.Settings=this.MergeSettings(e.Settings,t.Settings),s.ModelSelection||(s.ModelSelection={LastUserSelectedModelId:s.SelectedModelId??null,AutoSelectedModelId:null}),s},MergeSettings(e,t){var r,a;if(!t)return e;const s={...e,...t,Options:e.Options,General:{...e.General,...t.General},Chat:{...e.Chat,...t.Chat}};((r=t.General)==null?void 0:r.InternalChatMessages)!=null&&((a=t.Chat)==null?void 0:a.InternalChatMessages)==null&&(s.Chat={...s.Chat,InternalChatMessages:t.General.InternalChatMessages});const n=t.Providers??{},i={...e.Providers,...n};return i.Providers=e.Providers.Providers.map(l=>{var p;const c=(p=n.Providers)==null?void 0:p.find(g=>g.Id===l.Id);if(!c)return l;const u=new Map((c.Models??[]).map(g=>[g.Id,g.Enabled]));return{...l,Models:l.Models.map(g=>({...g,Enabled:u.has(g.Id)?u.get(g.Id):g.Enabled}))}}),i.SelectedProviderId=i.Providers.some(l=>l.Id===i.SelectedProviderId)?i.SelectedProviderId:null,s.Providers=i,s}})},Ur=o=>{Object.assign(o.prototype,{ApplyProviderModelStates(e,t){return!t||e.length===0?e:e.map(s=>{const n=t[s.Id]??{};return{...s,Models:s.Models.map(i=>({...i,Enabled:n[i.Id]??i.Enabled}))}})},RefreshModelSelectorState(e){const t=this.NormalizeModelSelection(e.ModelSelection,e.SelectedModelId),s=this.BuildAvailableModels(e.Settings.Providers.Providers,e.Settings.Providers.ModelAvailability),n=this.ResolveModelSelection(s,t,e.SelectedModelId),i=this.MaybeClearDescription(e,n.SelectedModelId,n.ModelSelection);return{...e,Models:s,SelectedModelId:n.SelectedModelId,ModelSelection:i}},NormalizeModelSelection(e,t){return e||{LastUserSelectedModelId:t??null,AutoSelectedModelId:null}},BuildAvailableModels(e,t){const s=[];return(e??[]).forEach(n=>{const i=(t==null?void 0:t[n.Id])??{};(n.Models??[]).forEach(r=>{r.Enabled&&i[r.Id]&&s.push({Id:r.Id,Label:r.Label,Description:r.Description??"",ProviderId:n.Id,ProviderName:n.Name,Capabilities:r.Capabilities??{}})})}),s},ResolveModelSelectionState({Providers:e,ModelAvailability:t,SelectedModelId:s,ModelSelection:n}){const i=this.BuildAvailableModels(e,t),r=this.NormalizeModelSelection(n,s),a=this.ResolveModelSelection(i,r,s);return{Models:i,SelectedModelId:a.SelectedModelId,ModelSelection:a.ModelSelection}},ResolveModelSelection(e,t,s){const n=new Set(e.map(l=>l.Id)),i=t.LastUserSelectedModelId;let r=n.has(s)?s:null,a=t.AutoSelectedModelId;return i&&n.has(i)?(r=i,a=null):!r&&e.length>0&&(r=e[0].Id,a=r),{SelectedModelId:r,ModelSelection:{...t,AutoSelectedModelId:a}}},MaybeClearDescription(e,t,s){return!(s!=null&&s.DescriptionText)||t&&t===e.SelectedModelId?s:{...s,DescriptionText:null}},BuildModelAvailability(e,t){const s={};return(t??[]).forEach(n=>{s[n.Id]=!1}),e.forEach(n=>{s[n]=!0}),s},BuildProviderAvailability(e){const t={};return(e??[]).forEach(s=>{t[s.Id]=!1}),t},MergeAvailability(e,t){const s={};return(e??[]).forEach(n=>{const i=this.BuildProviderAvailability(n.Models??[]),r=(t==null?void 0:t[n.Id])??{};s[n.Id]={...i,...r}}),s},ResetProviderAvailability(e){const s=this.State.Settings.Providers.Providers.find(r=>r.Id===e);if(!s)return;const i={...this.State.Settings.Providers.ModelAvailability??{},[e]:this.BuildProviderAvailability(s.Models??[])};this.ProvidersStore.SetProviderAvailability(e,i[e]),this.UpdateSettings(r=>{const a={...r,Providers:{...r.Providers,ModelAvailability:i}},l=this.ResolveModelSelectionState({Providers:a.Providers.Providers,ModelAvailability:a.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:a,Models:l.Models,SelectedModelId:l.SelectedModelId,ModelSelection:l.ModelSelection}})},ApplyModelAvailability(e,t,s){return s?e.map(n=>{if(n.Id!==t)return n;const i=n.Models.map(r=>({...r}));return{...n,Models:i}}):e}})},Nr=o=>{Object.assign(o.prototype,{async SendMessageAsync(){var b;if(this.State.IsSending)return;const e=(this.State.InputText??"").trim();if(!e)return;const t=this.State.Models.find(C=>C.Id===this.State.SelectedModelId);if(!t){this.Logger.LogWarning("Chat.Send.MissingModel",{});return}const s=t.ProviderId,n=t.Id,i=((b=this.State.Settings.Providers.Keys)==null?void 0:b[s])??"";let r=this.State.ActiveConversationId,a=this.State.Conversations,l={...this.State.MessagesByConversation};const c=this.BuildPreview(e);if(r)a=this.UpdateConversationPreview(a,r,c,s,n);else{const C=this.InferTitle(e),M=Be.CreateConversation({Title:C,ProviderId:s,ModelId:n});M.Preview=c,r=M.Id,a=[M,...a],l[r]=[]}const u=Be.CreateMessage({ConversationId:r,Role:"User",Kind:"User",Content:e,ProviderId:s,ModelId:n,Status:"done"}),p=Be.CreateMessage({ConversationId:r,Role:"Assistant",Kind:"Assistant",Content:"",ProviderId:s,ModelId:n,Status:"pending"}),g=Be.CreateMessageGroup({ConversationId:r,UserMessageId:u.Id,InternalMessageIds:[],AssistantMessageId:p.Id}),h=[...l[r]??[],u,p];l={...l,[r]:h};const m={...this.State.MessageGroupsByConversation??{},[r]:[...(this.State.MessageGroupsByConversation??{})[r]??[],g]};this.UpdateState({ActiveConversationId:r,Conversations:a,MessagesByConversation:l,MessageGroupsByConversation:m,InputText:"",IsSending:!0});const f=h.filter(C=>C.Id!==p.Id),S=new AbortController;this.SendAbortController=S;try{const C=await this.ChatService.SendAsync({ProviderId:s,ModelId:n,Key:i,Messages:f,Stream:!0,ModelConfig:(t==null?void 0:t.Capabilities)??{},Signal:S.signal,OnToken:M=>{S.signal.aborted||this.UpdateMessage(r,p.Id,T=>({...T,Content:`${T.Content??""}${M}`,Status:"streaming"}))}});if(S.signal.aborted)return;this.UpdateMessage(r,p.Id,M=>({...M,Content:C.Content??M.Content??"",Status:"done",Metrics:C.Metrics??null}))}catch(C){S.signal.aborted&&(C==null?void 0:C.name)==="AbortError"?this.UpdateMessage(r,p.Id,T=>({...T,Status:"aborted",Metrics:(C==null?void 0:C.Metrics)??T.Metrics??null})):this.UpdateMessage(r,p.Id,T=>({...T,Status:"error",ErrorMessage:(C==null?void 0:C.message)??"Request failed.",Metrics:null}))}finally{this.SendAbortController===S&&(this.SendAbortController=null),this.UpdateState({IsSending:!1})}},AbortSend(){var t,s,n,i;if(!((t=this.State)!=null&&t.IsSending))return;const e=this.SendAbortController;!e||e.signal.aborted||(e.abort(),this.ShowSnackbar((i=(n=(s=this.State)==null?void 0:s.Text)==null?void 0:n.Chat)==null?void 0:i.AbortedToastText))},OpenRetryPopup(e){const t=this.FindMessageLocation(e);if(!t)return;const s=t.Message;if(s.Status!=="error")return;const n=this.State.Models.find(r=>r.Id===this.State.SelectedModelId);if(!n)return;if(n.Id===s.ModelId&&n.ProviderId===s.ProviderId){this.RetryMessageAsync(t.ConversationId,e,s.ProviderId,s.ModelId).catch(r=>{this.Logger.LogError("Chat.Retry.Failed",{Error:(r==null?void 0:r.message)??"Unknown error"})});return}this.UpdateState({RetryPopup:{IsOpen:!0,MessageId:e,ConversationId:t.ConversationId,OriginalProviderId:s.ProviderId,OriginalModelId:s.ModelId,SelectedProviderId:n.ProviderId,SelectedModelId:n.Id}})},async ConfirmRetryAsync(e){const t=this.State.RetryPopup;if(!(t!=null&&t.IsOpen))return;const s=e?t.SelectedProviderId:t.OriginalProviderId,n=e?t.SelectedModelId:t.OriginalModelId,i=t.ConversationId,r=t.MessageId;this.UpdateState({RetryPopup:null}),await this.RetryMessageAsync(i,r,s,n)},async RetryMessageAsync(e,t,s,n){var p;if(this.State.IsSending)return;const i=this.State.MessagesByConversation[e]??[],r=i.findIndex(g=>g.Id===t);if(r===-1)return;this.UpdateState({IsSending:!0}),this.UpdateMessage(e,t,g=>({...g,Status:"pending",Content:"",ErrorMessage:null,ProviderId:s,ModelId:n,Metrics:null}));const a=i.slice(0,r).filter(g=>g.Status!=="error"),l=((p=this.State.Settings.Providers.Keys)==null?void 0:p[s])??"",c=this.GetModelConfig(s,n),u=new AbortController;this.SendAbortController=u;try{const g=await this.ChatService.SendAsync({ProviderId:s,ModelId:n,Key:l,Messages:a,Stream:!0,ModelConfig:c,Signal:u.signal,OnToken:h=>{u.signal.aborted||this.UpdateMessage(e,t,m=>({...m,Content:`${m.Content??""}${h}`,Status:"streaming"}))}});if(u.signal.aborted)return;this.UpdateMessage(e,t,h=>({...h,Content:g.Content??h.Content??"",Status:"done",Metrics:g.Metrics??null}))}catch(g){u.signal.aborted&&(g==null?void 0:g.name)==="AbortError"?this.UpdateMessage(e,t,m=>({...m,Status:"aborted",Metrics:(g==null?void 0:g.Metrics)??m.Metrics??null})):this.UpdateMessage(e,t,m=>({...m,Status:"error",ErrorMessage:(g==null?void 0:g.message)??"Request failed.",Metrics:null}))}finally{this.SendAbortController===u&&(this.SendAbortController=null),this.UpdateState({IsSending:!1})}},ToggleInternalGroup(e){var i;const t=this.FindMessageGroupLocation(e);if(!t)return;const n=(((i=this.State.MessageGroupsByConversation)==null?void 0:i[t.ConversationId])??[]).map(r=>r.Id===e?{...r,InternalVisible:!r.InternalVisible}:r);this.UpdateState({MessageGroupsByConversation:{...this.State.MessageGroupsByConversation,[t.ConversationId]:n}})},UpdateMessage(e,t,s){const i=(this.State.MessagesByConversation[e]??[]).map(r=>r.Id===t?s(r):r);this.UpdateState({MessagesByConversation:{...this.State.MessagesByConversation,[e]:i}})},FindMessageLocation(e){const t=Object.entries(this.State.MessagesByConversation??{});for(const[s,n]of t){const i=(n??[]).find(r=>r.Id===e);if(i)return{ConversationId:s,Message:i}}return null},FindMessageGroupLocation(e){const t=Object.entries(this.State.MessageGroupsByConversation??{});for(const[s,n]of t){const i=(n??[]).find(r=>r.Id===e);if(i)return{ConversationId:s,Group:i}}return null},GetModelConfig(e,t){var i,r,a,l;const s=(a=(r=(i=this.State.Settings)==null?void 0:i.Providers)==null?void 0:r.Providers)==null?void 0:a.find(c=>c.Id===e),n=(l=s==null?void 0:s.Models)==null?void 0:l.find(c=>c.Id===t);return(n==null?void 0:n.Capabilities)??{}},InferTitle(e){var n;const t=((n=e.split(`
`)[0])==null?void 0:n.trim())??"",s=48;return t.length<=s?t||"New chat":`${t.slice(0,s-3)}...`},BuildPreview(e){var n;const t=((n=e.split(`
`)[0])==null?void 0:n.trim())??"",s=72;return t.length<=s?t:`${t.slice(0,s-3)}...`},UpdateConversationPreview(e,t,s,n,i){const r=(e??[]).map(l=>l.Id!==t?l:{...Be.TouchConversation(l,{ProviderId:n,ModelId:i}),Preview:s}),a=r.find(l=>l.Id===t);return a?[a,...r.filter(l=>l.Id!==t)]:r},UpdateConversationScroll(e,t){const s=(this.State.Conversations??[]).map(n=>n.Id===e?{...n,ScrollPosition:t}:n);this.UpdateState({Conversations:s},{Render:!1})},async YieldToBrowser(){return await new Promise(e=>{if(typeof requestAnimationFrame=="function"){requestAnimationFrame(()=>e());return}setTimeout(e,0)})},ScheduleModelDescriptionClear(){var t;const e=((t=this.State.Layout)==null?void 0:t.ModelDescriptionDurationMs)??5e3;this.ModelDescriptionTimer&&clearTimeout(this.ModelDescriptionTimer),this.ModelDescriptionTimer=setTimeout(()=>{var s,n;(n=(s=this.State)==null?void 0:s.ModelSelection)!=null&&n.DescriptionText&&this.UpdateState({ModelSelection:{...this.State.ModelSelection,DescriptionText:null}})},e)}})};class He{constructor({Configuration:e,Logger:t,RootView:s,AppStateStore:n,ProvidersStore:i,ProviderCatalogService:r,ProviderValidationService:a,ConversationStore:l,ChatService:c,ChatSearchService:u}){this.Configuration=e,this.Logger=t,this.RootView=s,this.AppStateStore=n,this.ProvidersStore=i,this.ProviderCatalogService=r,this.ProviderValidationService=a,this.ConversationStore=l,this.ChatService=c,this.ChatSearchService=u??new dn,this.SendAbortController=null,this.ChatSearchDebounceTimer=null,this.State=null}async StartAsync(){var h,m,f,S;this.Logger.LogFlowStart("App.Start",{Environment:this.Configuration[Le.App][Ms.Environment]});const e=document.getElementById("app");if(!e)throw this.Logger.LogError("App.Start.MissingContainer",{ContainerId:"app"}),new Error("App container not found.");const t=await this.AppStateStore.LoadStateAsync();let s=null,n=null;try{s=await((h=this.ConversationStore)==null?void 0:h.LoadStateAsync())}catch(b){n=b,this.Logger.LogError("Conversation.State.LoadFailed",{Error:(b==null?void 0:b.message)??"Unknown error"})}const i=await this.ProviderCatalogService.LoadCatalogAsync(),r=Dr({ActiveConversationId:null,ProvidersCatalog:(i==null?void 0:i.Providers)??[]}),a=this.MergeState(r,t),l=this.Configuration[Le.App][Ms.Name];a.Text=this.BuildText(a.Text,{AppName:l}),a.ChatSearch=a.ChatSearch??{IsOpen:!1,Query:"",Results:[],Error:null};const c=this.NormalizeStoredConversationState(s);c&&(a.Conversations=c.Conversations??a.Conversations,a.MessagesByConversation=c.MessagesByConversation??a.MessagesByConversation,a.MessageGroupsByConversation=c.MessageGroupsByConversation??{}),a.ActiveConversationId&&!a.Conversations.some(b=>b.Id===a.ActiveConversationId)&&(a.ActiveConversationId=null),!a.ActiveConversationId&&a.Conversations.length>0&&(a.ActiveConversationId=a.Conversations[0].Id);const u=this.ProvidersStore.LoadProviderKeys();a.Settings.Providers.Keys={...a.Settings.Providers.Keys,...u},a.Settings.Providers.KeyVisibility={},a.Settings.Providers.ValidationPopup=null;const p=this.ProvidersStore.LoadProviderModelStates();a.Settings.Providers.Providers=this.ApplyProviderModelStates(a.Settings.Providers.Providers,p);const g=this.ProvidersStore.LoadProviderAvailability();a.Settings.Providers.ModelAvailability=this.MergeAvailability(a.Settings.Providers.Providers,g),this.State=this.RefreshModelSelectorState(a),this.Render(e),n&&this.ShowSnackbar((S=(f=(m=this.State)==null?void 0:m.Text)==null?void 0:f.ChatSaving)==null?void 0:S.StorageErrorText),this.Logger.LogFlowEnd("App.Start",{Rendered:!0})}Render(e){this.RootView.Render(e,this.State,{onToggleSidebar:()=>{this.UpdateState({IsSidebarCollapsed:!this.State.IsSidebarCollapsed})},onStartNewChat:()=>{this.RequestNewChat()},onTogglePin:()=>{this.RequestTogglePin()},onUpdatePinName:t=>{this.UpdatePinDialogName(t)},onConfirmPin:()=>{this.ConfirmPinFromDialog()},onCancelPin:()=>{this.ClosePinDialog()},onConfirmDiscard:()=>{this.ConfirmDiscard()},onCancelDiscard:()=>{this.CloseDiscardDialog()},onSelectModel:t=>{const s=this.State.Models.find(i=>i.Id===t),n={LastUserSelectedModelId:t,AutoSelectedModelId:null,DescriptionText:(s==null?void 0:s.Description)??""};this.UpdateState({SelectedModelId:t,ModelSelection:n}),this.ScheduleModelDescriptionClear()},onSelectConversation:t=>{this.RequestSelectConversation(t)},onOpenChatSearch:()=>{this.OpenChatSearch()},onCloseChatSearch:()=>{this.CloseChatSearch()},onUpdateChatSearchQuery:t=>{this.UpdateChatSearchQuery(t)},onSelectChatSearchResult:t=>{this.RequestSelectChatSearchResult(t)},onScrollConversation:t=>{const s=this.State.ActiveConversationId;s&&this.UpdateConversationScroll(s,t)},onUpdateInput:t=>{this.UpdateState({InputText:t},{Render:!1})},onSendMessage:()=>{this.SendMessageAsync().catch(t=>{this.Logger.LogError("Chat.Send.Failed",{Error:(t==null?void 0:t.message)??"Unknown error"})})},onAbortSend:()=>{this.AbortSend()},onRetryMessage:t=>{this.OpenRetryPopup(t)},onCloseRetryPopup:()=>{this.UpdateState({RetryPopup:null})},onConfirmRetry:t=>{this.ConfirmRetryAsync(t).catch(s=>{this.Logger.LogError("Chat.Retry.Failed",{Error:(s==null?void 0:s.message)??"Unknown error"})})},onToggleInternalGroup:t=>{this.ToggleInternalGroup(t)},onOpenSettings:()=>{this.UpdateSettings(t=>({...t,IsOpen:!0}))},onCloseSettings:()=>{this.UpdateSettings(t=>({...t,IsOpen:!1}))},onSelectSettingsCategory:t=>{this.UpdateSettings(s=>({...s,ActiveCategory:t}))},onUpdateTheme:t=>{this.UpdateSettings(s=>({...s,General:{...s.General,Theme:t}}))},onToggleInternalMessages:t=>{this.UpdateSettings(s=>({...s,Chat:{...s.Chat,InternalChatMessages:t}}))},onUpdateAccent:t=>{this.UpdateSettings(s=>({...s,General:{...s.General,AccentColor:t}}))},onSelectProvider:t=>{this.UpdateSettings(s=>({...s,Providers:{...s.Providers,SelectedProviderId:t}}))},onBackToProviders:()=>{this.UpdateSettings(t=>({...t,Providers:{...t.Providers,SelectedProviderId:null}}))},onUpdateProviderKey:(t,s)=>{const n=this.ProvidersStore.SetProviderKey(t,s);this.State=this.RefreshModelSelectorState({...this.State,Settings:{...this.State.Settings,Providers:{...this.State.Settings.Providers,Keys:n}}}),this.ResetProviderAvailability(t)},onClearProviderKey:t=>{const s=this.ProvidersStore.ClearProviderKey(t);this.State=this.RefreshModelSelectorState({...this.State,Settings:{...this.State.Settings,Providers:{...this.State.Settings.Providers,Keys:s}}}),this.ResetProviderAvailability(t)},onToggleProviderKeyVisibility:t=>{const s=this.State.Settings.Providers.KeyVisibility??{},n={...s,[t]:!s[t]};this.UpdateSettings(i=>({...i,Providers:{...i.Providers,KeyVisibility:n}}))},onTestProviderKey:async t=>{var a;const s=((a=this.State.Settings.Providers.Keys)==null?void 0:a[t])??"",n=this.State.Settings.Providers.Providers.find(l=>l.Id===t),i=(n==null?void 0:n.Models)??[];this.UpdateSettings(l=>({...l,Providers:{...l.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"working",Message:"Testing key...",Progress:{Current:0,Total:i.length},CurrentModel:null}}}));const r=await this.ProviderValidationService.ValidateAsync(t,s);if(r.Status!=="success"){this.UpdateSettings(l=>({...l,Providers:{...l.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:r.Status,Message:r.Message}}}));return}for(let l=0;l<i.length;l+=1){const c=i[l];this.UpdateSettings(u=>({...u,Providers:{...u.Providers,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"working",Message:"Checking model availability...",Progress:{Current:l+1,Total:i.length},CurrentModel:c.Label??c.Id}}})),await this.YieldToBrowser()}this.UpdateSettings(l=>{const c=l.Providers.ModelAvailability??{},u=this.BuildModelAvailability(r.ModelIds??[],i),p={...c,[t]:u};this.ProvidersStore.SetProviderAvailability(t,u);const g=this.ApplyModelAvailability(l.Providers.Providers,t,u),h={...l,Providers:{...l.Providers,Providers:g,ModelAvailability:p,ValidationPopup:{IsOpen:!0,ProviderId:t,Status:"success",Message:r.Message}}},m=this.ResolveModelSelectionState({Providers:h.Providers.Providers,ModelAvailability:h.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:h,Models:m.Models,SelectedModelId:m.SelectedModelId,ModelSelection:m.ModelSelection}})},onCloseProviderValidationPopup:()=>{this.UpdateSettings(t=>({...t,Providers:{...t.Providers,ValidationPopup:null}}))},onToggleProviderModel:(t,s,n)=>{this.ProvidersStore.SetProviderModelState(t,s,n),this.UpdateSettings(i=>{const r=i.Providers.Providers.map(l=>l.Id!==t?l:{...l,Models:l.Models.map(c=>c.Id===s?{...c,Enabled:n}:c)}),a=this.ResolveModelSelectionState({Providers:r,ModelAvailability:i.Providers.ModelAvailability,SelectedModelId:this.State.SelectedModelId,ModelSelection:this.State.ModelSelection});return{Settings:{...i,Providers:{...i.Providers,Providers:r}},Models:a.Models,SelectedModelId:a.SelectedModelId,ModelSelection:a.ModelSelection}})}})}UpdateSettings(e){const t=e(this.State.Settings);if(t&&t.Settings){this.UpdateState(t);return}this.UpdateState({Settings:t})}UpdateState(e,{Render:t=!0}={}){if(this.State={...this.State,...e},this.PersistState(),t){const s=document.getElementById("app");this.Render(s)}}}_r(He);Or(He);$r(He);Ur(He);Nr(He);class Br{static Build(){const e=new $n,t=new Dn,s=new Rn({Fetch:(...k)=>globalThis.fetch(...k),Logger:e,Paths:t}),n=new Un,i=new Nn({Storage:globalThis.localStorage}),r=new Bn({DbName:"ghostplug",StoreName:"state",Version:1}),a=new Fn({AppStateProvider:r,KeyStorage:i}),l=new Hn({KeyStorage:i}),c=new Ee,u=new vr({Logger:e}),p=new dr({Fetch:(...k)=>globalThis.fetch(...k),Logger:e,EnvironmentName:"production"}),g=new ur({Catalog:p}),h=[new pr({Fetch:(...k)=>globalThis.fetch(...k)}),new gr({Fetch:(...k)=>globalThis.fetch(...k)}),new fr({Fetch:(...k)=>globalThis.fetch(...k)}),new mr({Fetch:(...k)=>globalThis.fetch(...k)})],m=new hr({Providers:h}),f=new br({Providers:h}),S=new Cr,b=new Ir({Logger:e}),C=new dn,M=new yr({ChatRegistry:f,ContextBuilder:S,ChatLogger:b,Configuration:null,Fetch:(...k)=>globalThis.fetch(...k)}),T=new Sr({ProviderRegistry:m,ProviderLogger:u});return{ConfigurationService:s,LoggerFactory:n,AppFactory:({Configuration:k,Logger:R})=>{var K,P;const z=new Gn({StorageProvider:r,StorageKey:((P=(K=k==null?void 0:k.Storage)==null?void 0:K.Keys)==null?void 0:P.Conversations)??"Ghostplug.Conversations"});return M.Configuration=k,new He({Configuration:k,Logger:R,RootView:c,AppStateStore:a,ProvidersStore:l,ProviderCatalogService:g,ProviderValidationService:T,ConversationStore:z,ChatService:M,ChatSearchService:C})},EnvironmentName:"production"}}}const Fr=new An(Br.Build());Fr.StartAsync();
