var Sn=Object.defineProperty;var Pn=(s,e,t)=>e in s?Sn(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var O=(s,e,t)=>Pn(s,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const Mt="promptHistory",Nt="prompt_history";class rn{constructor(e=50){this.maxSize=e,this.entries=[],this.position=-1,this.debounceTimer=null,this.loaded=!1}async load(){try{const e=await pe(Mt,Nt);e&&(this.entries=e.entries||[],this.position=e.position??-1,this.maxSize=e.maxSize||this.maxSize),this.loaded=!0}catch(e){console.warn("Failed to load prompt history:",e),this.loaded=!0}}push(e){var t;this.position>=0&&((t=this.entries[this.position])==null?void 0:t.text)===e||(this.entries=this.entries.slice(0,this.position+1),this.entries.push({text:e,timestamp:Date.now()}),this.entries.length>this.maxSize&&this.entries.shift(),this.position=this.entries.length-1,this.persist())}pushDebounced(e,t=500){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.push(e),this.debounceTimer=null},t)}cancelDebounce(){this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null)}undo(){return this.canUndo()?(this.position--,this.persist(),this.entries[this.position].text):null}redo(){return this.canRedo()?(this.position++,this.persist(),this.entries[this.position].text):null}canUndo(){return this.position>0}canRedo(){return this.position<this.entries.length-1}getCurrent(){return this.position<0||this.position>=this.entries.length?null:this.entries[this.position].text}get length(){return this.entries.length}async persist(){try{await D(Mt,{id:Nt,entries:this.entries,position:this.position,maxSize:this.maxSize})}catch(e){console.warn("Failed to persist prompt history:",e)}}async clear(){this.entries=[],this.position=-1,this.cancelDebounce(),await this.persist()}}const K="logs";let j=null;function An(s){j=s}function ze(s){return{id:crypto.randomUUID(),timestamp:new Date().toISOString(),type:s.type||"request",provider:s.provider||"",model:s.model||"",promptLength:s.promptLength||0,responseLength:s.responseLength||null,tokens:s.tokens||null,error:s.error||null,durationMs:s.durationMs||0}}async function je(s){if(!j){console.warn("Logger: Database not initialized");return}if(!j.objectStoreNames.contains(K)){console.warn("Logger: Logs store not found - DB may need upgrade. Clear site data to fix.");return}return new Promise((e,t)=>{try{const n=j.transaction(K,"readwrite");n.objectStore(K).add(s),n.oncomplete=()=>e(),n.onerror=()=>t(n.error)}catch(n){console.error("Logger: Failed to save log",n),e()}})}async function Mn(s,e,t){const n=ze({type:"request",provider:s,model:e,promptLength:t});return await je(n),n}async function Le(s,e,t,n,i){const o=ze({type:"response",provider:s,model:e,responseLength:t,tokens:n,durationMs:i});await je(o)}async function fe(s,e,t,n){const i=ze({type:"error",provider:s,model:e,error:t,durationMs:n});await je(i)}async function Nn(s,e="",t=""){const n=ze({type:"skip",provider:e,model:t,error:null,durationMs:0});n.principleId=s,await je(n)}async function an(){return!j||!j.objectStoreNames.contains(K)?[]:new Promise(s=>{try{const n=j.transaction(K,"readonly").objectStore(K).getAll();n.onsuccess=()=>s(n.result||[]),n.onerror=()=>s([])}catch(e){console.error("Logger: Failed to get logs",e),s([])}})}async function Lt(){return!j||!j.objectStoreNames.contains(K)?0:new Promise(s=>{try{const n=j.transaction(K,"readonly").objectStore(K).count();n.onsuccess=()=>s(n.result||0),n.onerror=()=>s(0)}catch{s(0)}})}async function Ln(){const s=await an();return s.sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp)),s.map(e=>JSON.stringify(e)).join(`
`)}async function In(){const s=await Ln(),e=new Blob([s],{type:"application/jsonl"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`promptcoach-logs-${new Date().toISOString().split("T")[0]}.jsonl`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}async function _n(){try{const[s,e,t,n]=await Promise.all([xt(),F(),W(),an()]),i=new rn(50);await i.load();const o=i.entries,a=Rn(n),r={export:{version:"1.0",timestamp:new Date().toISOString(),sessionId:e.id,userAgent:navigator.userAgent,appVersion:"1.0.0"},session:{id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,totalTokens:e.totalTokens||0,lastScore:e.lastScore,lastDescription:e.lastDescription,feedbackCount:e.feedbackCount||0},settings:{theme:t.theme,provider:t.provider,testModel:t.testModel},activity:s,promptHistory:o.map(l=>({timestamp:l.timestamp,text:l.text})),logs:n,performance:a};return JSON.stringify(r,null,2)}catch(s){throw console.error("Failed to export comprehensive session:",s),s}}function Rn(s){if(!s||s.length===0)return{totalRequests:0,totalTokens:0,averageResponseTime:0,errorRate:0};const e=s.filter(r=>r.type==="request"||r.type==="response"),t=s.filter(r=>r.type==="error"),n=s.reduce((r,l)=>{var c;return r+(((c=l.tokens)==null?void 0:c.total)||0)},0),i=s.reduce((r,l)=>r+(l.durationMs||0),0),o=e.length>0?i/e.length:0,a=e.length>0?t.length/e.length:0;return{totalRequests:e.length,totalTokens:n,averageResponseTime:Math.round(o),errorRate:Math.round(a*100)/100}}async function qn(){try{const s=await _n(),e=new Blob([s],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`promptcoach-session-${new Date().toISOString().split("T")[0]}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}catch(s){throw console.error("Failed to download comprehensive session:",s),s}}const rt="promptcoach",Fn=7;let $=null;const It=["sessions","logs","history","promptHistory","attachments"];async function M(){if($){const s=It.filter(e=>!$.objectStoreNames.contains(e));if(s.length===0)return $;console.warn("IndexedDB missing stores:",s,"- resetting database"),$.close(),$=null,await Bn()}return new Promise((s,e)=>{const t=indexedDB.open(rt,Fn);t.onerror=()=>e(t.error),t.onsuccess=()=>{$=t.result;const n=It.filter(i=>!$.objectStoreNames.contains(i));if(n.length>0){console.warn("IndexedDB still missing stores after open:",n,"- deleting and retrying"),$.close(),$=null,indexedDB.deleteDatabase(rt),setTimeout(()=>{M().then(s).catch(e)},100);return}An($),s($)},t.onupgradeneeded=n=>{const i=n.target.result;if(i.objectStoreNames.contains("sessions")){const o=n.target.transaction;if(o){const a=o.objectStore("sessions");a.indexNames.contains("archivedAt")||a.createIndex("archivedAt","archivedAt",{unique:!1}),a.indexNames.contains("starred")||a.createIndex("starred","starred",{unique:!1})}}else{const o=i.createObjectStore("sessions",{keyPath:"id"});o.createIndex("createdAt","createdAt",{unique:!1}),o.createIndex("updatedAt","updatedAt",{unique:!1}),o.createIndex("archivedAt","archivedAt",{unique:!1}),o.createIndex("starred","starred",{unique:!1})}if(i.objectStoreNames.contains("logs")){const o=n.target.transaction;if(o){const a=o.objectStore("logs");a.indexNames.contains("sessionId")||a.createIndex("sessionId","sessionId",{unique:!1})}}else{const o=i.createObjectStore("logs",{keyPath:"id"});o.createIndex("timestamp","timestamp",{unique:!1}),o.createIndex("type","type",{unique:!1}),o.createIndex("provider","provider",{unique:!1}),o.createIndex("sessionId","sessionId",{unique:!1})}if(!i.objectStoreNames.contains("history")){const o=i.createObjectStore("history",{keyPath:"id"});o.createIndex("sessionId","sessionId",{unique:!1}),o.createIndex("timestamp","timestamp",{unique:!1}),o.createIndex("type","type",{unique:!1})}if(i.objectStoreNames.contains("promptHistory")||i.createObjectStore("promptHistory",{keyPath:"id"}),!i.objectStoreNames.contains("attachments")){const o=i.createObjectStore("attachments",{keyPath:"id"});o.createIndex("addedAt","addedAt",{unique:!1}),o.createIndex("filename","filename",{unique:!1})}}})}function Bn(){return new Promise(s=>{const e=indexedDB.deleteDatabase(rt);e.onsuccess=()=>s(),e.onerror=()=>s(),e.onblocked=()=>{console.warn("IndexedDB delete blocked - close other tabs"),s()}})}async function pe(s,e){const t=await M();return new Promise((n,i)=>{const r=t.transaction(s,"readonly").objectStore(s).get(e);r.onerror=()=>i(r.error),r.onsuccess=()=>n(r.result)})}async function D(s,e){const t=await M();return new Promise((n,i)=>{const r=t.transaction(s,"readwrite").objectStore(s).put(e);r.onerror=()=>i(r.error),r.onsuccess=()=>n()})}async function xe(s){const e=await M();return new Promise((t,n)=>{const a=e.transaction(s,"readonly").objectStore(s).getAll();a.onerror=()=>n(a.error),a.onsuccess=()=>t(a.result)})}async function bt(s,e){const t=await M();return new Promise((n,i)=>{const r=t.transaction(s,"readwrite").objectStore(s).delete(e);r.onerror=()=>i(r.error),r.onsuccess=()=>n()})}async function Hn(s){const e=await M();return new Promise((t,n)=>{const a=e.transaction(s,"readwrite").objectStore(s).clear();a.onerror=()=>n(a.error),a.onsuccess=()=>t()})}const cn="promptcoach_appstate",me="promptcoach_settings",ln="promptcoach_current_session",_t={currentTab:"prompt",firstRunCompleted:!1,feedbackPanelPinned:!1,feedbackPanelRatio:.5},ke={theme:"light",apiKeys:{openai:null,anthropic:null,google:null,x:null},provider:"openai",testModel:null};function Ze(){try{const s=localStorage.getItem(cn);if(s)return{..._t,...JSON.parse(s)}}catch(s){console.error("Failed to load AppState:",s)}return{..._t}}function On(s){try{["prompt","history","attachments"].includes(s.currentTab)||(s.currentTab="prompt"),(s.feedbackPanelRatio<.2||s.feedbackPanelRatio>.8)&&(s.feedbackPanelRatio=.5),localStorage.setItem(cn,JSON.stringify(s))}catch(e){console.error("Failed to save AppState:",e)}}function ne(s,e){const t=Ze();return t[s]=e,On(t),t}function W(){var s;try{const e=localStorage.getItem(me);if(e){const t=JSON.parse(e);return t.apiKey&&!((s=t.apiKeys)!=null&&s.openai)&&(t.apiKeys=t.apiKeys||{},t.apiKeys.openai=t.apiKey,delete t.apiKey,localStorage.setItem(me,JSON.stringify(t)),console.log("Settings: Migrated legacy apiKey to apiKeys.openai")),t.model&&!t.testModel&&(t.testModel=t.model,delete t.model,localStorage.setItem(me,JSON.stringify(t)),console.log("Settings: Migrated legacy model to testModel")),("coachProvider"in t||"testProvider"in t)&&(t.provider=t.coachProvider||t.testProvider||"openai",delete t.coachProvider,delete t.testProvider,delete t.coachModel,localStorage.setItem(me,JSON.stringify(t)),console.log("Settings: Migrated to unified provider")),{...ke,...t,apiKeys:{...ke.apiKeys,...t.apiKeys}}}}catch(e){console.error("Failed to load Settings:",e)}return{...ke,apiKeys:{...ke.apiKeys}}}function dn(s){try{["system","light","dark"].includes(s.theme)||(s.theme="light"),["openai","anthropic","google","x"].includes(s.provider)||(s.provider="openai"),localStorage.setItem(me,JSON.stringify(s))}catch(e){console.error("Failed to save Settings:",e)}}function pn(s,e){const t=W();return s==="apiKeys"?t.apiKeys={...t.apiKeys,...e}:t[s]=e,dn(t),t}function at(){const s=W();return Object.values(s.apiKeys).some(e=>e&&e.trim()!=="")}function he(){try{const s=localStorage.getItem(ln);if(s)return JSON.parse(s).sessionId}catch(s){console.error("Failed to load current session ID:",s)}return null}function hn(s){try{localStorage.setItem(ln,JSON.stringify({sessionId:s}))}catch(e){console.error("Failed to save current session ID:",e)}}async function un(){const s={id:crypto.randomUUID(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),promptText:"",promptHistory:[],results:[],totalTokens:0,lastScore:null,lastDescription:null,feedbackCount:0};return await D("sessions",s),hn(s.id),s}async function F(){await M();const s=he();if(s){const e=await pe("sessions",s);if(e)return e}return un()}async function oe(s){const t={...await F(),...s,updatedAt:new Date().toISOString()};return await D("sessions",t),t}let Ye=null;function Je(s){Ye&&clearTimeout(Ye),Ye=setTimeout(async()=>{await oe({promptText:s})},500)}async function Ke(){return(await F()).results||[]}async function mn(){return oe({results:[],totalTokens:0})}function $n(s={}){return{id:crypto.randomUUID(),sessionId:he(),timestamp:new Date().toISOString(),type:"feedback",promptSnapshot:s.promptSnapshot||"",scores:s.scores||[],overall:s.overall||0,description:s.description||"",feedback:s.feedback||"",provider:s.provider||"",model:s.model||"",durationMs:s.durationMs||0,targetPrinciple:s.targetPrinciple||null,complete:s.complete||!1,completionReason:s.completionReason||null,canReintroduceSkipped:s.canReintroduceSkipped||!1,skippedPrinciples:s.skippedPrinciples||[],actionableThreshold:s.actionableThreshold||null}}function Dn(s={}){return{id:crypto.randomUUID(),sessionId:he(),timestamp:new Date().toISOString(),type:"result",promptSnapshot:s.promptSnapshot||"",responseText:s.responseText||"",status:s.status||"streaming",error:s.error||null,tokens:s.tokens||{prompt:0,completion:0,total:0},provider:s.provider||"",model:s.model||"",durationMs:s.durationMs||0}}function zn(s={}){return{id:crypto.randomUUID(),sessionId:he(),timestamp:new Date().toISOString(),type:"prompt-change",newPromptText:s.newPromptText||""}}async function ct(s){await M();try{await D("history",s)}catch(e){throw console.error("Failed to save history entry:",e),e}if(s.type==="feedback"){const e=await F();await oe({lastScore:s.overall,lastDescription:s.description,feedbackCount:(e.feedbackCount||0)+1})}return s}async function xt(){await M();const s=he();if(!s)return[];try{return(await xe("history")).filter(t=>t.sessionId===s).sort((t,n)=>new Date(t.timestamp)-new Date(n.timestamp))}catch(e){return console.error("Failed to get history:",e),[]}}async function jn(s){return(await xt()).filter(t=>t.type===s)}async function Rt(s,e){await M();try{const t=await pe("history",s);if(!t)throw new Error(`History entry not found: ${s}`);const n={...t,...e};return await D("history",n),n}catch(t){throw console.error("Failed to update history entry:",t),t}}async function Zn(s){const t=(await F()).lastRecordedPrompt||"";return s.trim()!==t.trim()}async function qt(s){if(await Zn(s)){const t=zn({newPromptText:s});return await ct(t),await oe({lastRecordedPrompt:s.trim()}),t}return null}async function Ue(){return jn("feedback")}async function fn(){await M();const s=he();if(s)try{const t=(await xe("history")).filter(n=>n.sessionId===s&&n.type==="feedback");for(const n of t)await bt("history",n.id);await oe({lastScore:null,lastDescription:null,feedbackCount:0})}catch(e){console.error("Failed to clear feedback:",e)}}const Ft="data-theme";function lt(s){const e=document.documentElement;s==="system"?e.removeAttribute(Ft):e.setAttribute(Ft,s);const t=document.querySelector('meta[name="theme-color"]');if(t){const n=s==="dark"||s==="system"&&window.matchMedia("(prefers-color-scheme: dark)").matches;t.setAttribute("content",n?"#1C1B1F":"#6750A4")}}function Kn(s){pn("theme",s),lt(s)}function Un(){const s=W();lt(s.theme),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{W().theme==="system"&&lt("system")})}const Wn="modulepreload",Gn=function(s,e){return new URL(s,e).href},Bt={},Y=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){const a=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),l=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=Promise.allSettled(t.map(c=>{if(c=Gn(c,n),c in Bt)return;Bt[c]=!0;const d=c.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(!!n)for(let m=a.length-1;m>=0;m--){const f=a[m];if(f.href===c&&(!d||f.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${p}`))return;const u=document.createElement("link");if(u.rel=d?"stylesheet":Wn,d||(u.as="script"),u.crossOrigin="",u.href=c,l&&u.setAttribute("nonce",l),document.head.appendChild(u),d)return new Promise((m,f)=>{u.addEventListener("load",m),u.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function o(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return i.then(a=>{for(const r of a||[])r.status==="rejected"&&o(r.reason);return e().catch(o)})};class Vn{constructor(){this.element=null,this.ringEl=null,this.scoreEl=null,this.score=null,this.description=null,this.onClick=null}render(){this.element=document.createElement("div"),this.element.className="score-badge",this.element.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    `,this.element.title="Not evaluated",this.element.addEventListener("click",()=>{this.onClick&&this.onClick()});const e=document.createElement("div");e.style.cssText=`
      position: relative;
      width: 32px;
      height: 32px;
    `;const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("width","32"),t.setAttribute("height","32"),t.setAttribute("viewBox","0 0 36 36"),t.style.cssText="transform: rotate(-90deg);";const n=document.createElementNS("http://www.w3.org/2000/svg","circle");return n.setAttribute("cx","18"),n.setAttribute("cy","18"),n.setAttribute("r","16"),n.setAttribute("fill","none"),n.setAttribute("stroke","var(--pc-surface-container-high)"),n.setAttribute("stroke-width","4"),t.appendChild(n),this.ringEl=document.createElementNS("http://www.w3.org/2000/svg","circle"),this.ringEl.setAttribute("cx","18"),this.ringEl.setAttribute("cy","18"),this.ringEl.setAttribute("r","16"),this.ringEl.setAttribute("fill","none"),this.ringEl.setAttribute("stroke","var(--pc-primary)"),this.ringEl.setAttribute("stroke-width","4"),this.ringEl.setAttribute("stroke-linecap","round"),this.ringEl.setAttribute("stroke-dasharray","100.53"),this.ringEl.setAttribute("stroke-dashoffset","100.53"),this.ringEl.style.cssText="transition: stroke-dashoffset 500ms ease-out;",t.appendChild(this.ringEl),e.appendChild(t),this.scoreEl=document.createElement("div"),this.scoreEl.style.cssText=`
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--pc-on-surface);
    `,this.scoreEl.textContent="—",e.appendChild(this.scoreEl),this.element.appendChild(e),this.element}setScore(e,t){this.score=e,this.description=t,this.scoreEl.textContent=Math.round(e);const i=100.53*(1-e/100);this.ringEl.setAttribute("stroke-dashoffset",i.toString()),e>=80?this.ringEl.setAttribute("stroke","#22C55E"):e>=60?this.ringEl.setAttribute("stroke","#F59E0B"):this.ringEl.setAttribute("stroke","#EF4444"),this.element.title=t||`Score: ${Math.round(e)}`}clear(){this.score=null,this.description=null,this.scoreEl.textContent="—",this.ringEl.setAttribute("stroke-dashoffset","100.53"),this.ringEl.setAttribute("stroke","var(--pc-primary)"),this.element.title="Not evaluated"}setOnClick(e){this.onClick=e}getScore(){return this.score}}const gn={prompt:"M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z",attach:"M720-330q0 104-73 177T470-80q-104 0-177-73t-73-177v-370q0-75 52.5-127.5T400-880q75 0 127.5 52.5T580-700v350q0 46-32 78t-78 32q-46 0-78-32t-32-78v-370h80v370q0 13 8.5 21.5T470-320q13 0 21.5-8.5T500-350v-350q-1-42-29.5-71T400-800q-42 0-71 29t-29 71v370q-1 71 49 120.5T470-160q70 0 119-49.5T640-330v-390h80v390Z",activity:"M280-600v-80h560v80H280Zm0 160v-80h560v80H280Zm0 160v-80h560v80H280ZM160-600q-17 0-28.5-11.5T120-640q0-17 11.5-28.5T160-680q17 0 28.5 11.5T200-640q0 17-11.5 28.5T160-600Zm0 160q-17 0-28.5-11.5T120-480q0-17 11.5-28.5T160-520q17 0 28.5 11.5T200-480q0 17-11.5 28.5T160-440Zm0 160q-17 0-28.5-11.5T120-320q0-17 11.5-28.5T160-360q17 0 28.5 11.5T200-320q0 17-11.5 28.5T160-280Z",coach:"M440-120v-80h320v-284q0-117-81.5-198.5T480-764q-117 0-198.5 81.5T200-484v244h-40q-33 0-56.5-23.5T80-320v-80q0-21 10.5-39.5T120-469l3-53q8-68 39.5-126t79-101q47.5-43 109-67T480-840q68 0 129 24t109 66.5Q766-707 797-649t40 126l3 52q19 9 29.5 27t10.5 38v92q0 20-10.5 38T840-249v49q0 33-23.5 56.5T760-120H440Zm-80-280q-17 0-28.5-11.5T320-440q0-17 11.5-28.5T360-480q17 0 28.5 11.5T400-440q0 17-11.5 28.5T360-400Zm240 0q-17 0-28.5-11.5T560-440q0-17 11.5-28.5T600-480q17 0 28.5 11.5T640-440q0 17-11.5 28.5T600-400Zm-359-62q-7-106 64-182t177-76q89 0 156.5 56.5T720-519q-91-1-167.5-49T435-698q-16 80-67.5 142.5T241-462Z",test:"M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z",newSession:"M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z",sessionHistory:"M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z",copyPrompt:"M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z",previewPrompt:"m640-360 120-120-42-43-48 48v-125h-60v125l-48-48-42 43 120 120ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm0 0v-480 480Zm60-120h60v-180h40v120h60v-120h40v180h60v-200q0-17-11.5-28.5T440-600H260q-17 0-28.5 11.5T220-560v200Z",editPrompt:"M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z",settings:"m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z",install:"M320-120v-80H160q-33 0-56.5-23.5T80-280v-480q0-33 23.5-56.5T160-840h320v80H160v480h640v-120h80v120q0 33-23.5 56.5T800-200H640v80H320Zm360-280L480-600l56-56 104 103v-287h80v287l104-103 56 56-200 200Z",noActivityYet:"M280-600v-80h560v80H280Zm0 160v-80h560v80H280Zm0 160v-80h560v80H280ZM160-600q-17 0-28.5-11.5T120-640q0-17 11.5-28.5T160-680q17 0 28.5 11.5T200-640q0 17-11.5 28.5T160-600Zm0 160q-17 0-28.5-11.5T120-480q0-17 11.5-28.5T160-520q17 0 28.5 11.5T200-480q0 17-11.5 28.5T160-440Zm0 160q-17 0-28.5-11.5T120-320q0-17 11.5-28.5T160-360q17 0 28.5 11.5T200-320q0 17-11.5 28.5T160-280Z",noAttachmentsYet:"M720-330q0 104-73 177T470-80q-104 0-177-73t-73-177v-370q0-75 52.5-127.5T400-880q75 0 127.5 52.5T580-700v350q0 46-32 78t-78 32q-46 0-78-32t-32-78v-370h80v370q0 13 8.5 21.5T470-320q13 0 21.5-8.5T500-350v-350q-1-42-29.5-71T400-800q-42 0-71 29t-29 71v370q-1 71 49 120.5T470-160q70 0 119-49.5T640-330v-390h80v390Z",noSessionsFound:"M480-120q-138 0-240.5-91.5T122-440h82q14 104 92.5 172T480-200q117 0 198.5-81.5T760-480q0-117-81.5-198.5T480-760q-69 0-129 32t-101 88h110v80H120v-240h80v94q51-64 124.5-99T480-840q75 0 140.5 28.5t114 77q48.5 48.5 77 114T840-480q0 75-28.5 140.5t-77 114q-48.5 48.5-114 77T480-120Zm112-192L440-464v-216h80v184l128 128-56 56Z",chevronDown:"M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z",chevronRight:"M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z",upload:"M260-160q-91 0-155.5-63T40-377q0-78 47-139t123-78q25-92 100-149t170-57q117 0 198.5 81.5T760-520q69 8 114.5 59.5T920-340q0 75-52.5 127.5T740-160H520q-33 0-56.5-23.5T440-240v-206l-64 62-56-56 160-160 160 160-56 56-64-62v206h220q42 0 71-29t29-71q0-42-29-71t-71-29h-60v-80q0-83-58.5-141.5T480-720q-83 0-141.5 58.5T280-520h-20q-58 0-99 41t-41 99q0 58 41 99t99 41h100v80H260Zm220-280Z",clearAll:"m376-300 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 180q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520Zm-400 0v520-520Z",deleteSession:"m376-300 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 180q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520Zm-400 0v520-520Z",delete:"m376-300 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56Zm-96 180q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520Zm-400 0v520-520Z",menu:"M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"};function q(s,e=24){const t=gn[s];return t?`<svg width="${e}" height="${e}" viewBox="0 -960 960 960" fill="currentColor"><path d="${t}"/></svg>`:(console.warn(`Icon "${s}" not found`),"")}function Ht(s){return gn[s]||""}class Yn{constructor(e={}){this.onMenuClick=e.onMenuClick||null,this.onScoreClick=e.onScoreClick||null,this.element=null,this.scoreBadge=null}render(){this.element=document.createElement("header"),this.element.className="ribbon",this.element.style.cssText=`
      display: flex;
      align-items: center;
      height: 56px;
      padding: 0 var(--pc-space-2);
      background-color: var(--pc-primary);
      color: var(--pc-on-primary);
      flex-shrink: 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      position: relative;
      z-index: 10;
    `;const e=document.createElement("button");e.setAttribute("aria-label","Open menu"),e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
      -webkit-tap-highlight-color: transparent;
    `,e.innerHTML=q("menu"),e.addEventListener("click",()=>{this.onMenuClick&&this.onMenuClick()}),this.element.appendChild(e);const t=document.createElement("h1");t.className="text-title-lg",t.style.cssText=`
      flex: 1;
      margin: 0 var(--pc-space-3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    `,t.textContent="Prompt Coach",this.element.appendChild(t),this.scoreBadge=new Vn,this.scoreBadge.setOnClick(()=>{this.onScoreClick&&this.onScoreClick()});const n=document.createElement("div");return n.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      margin-right: var(--pc-space-2);
      background-color: var(--pc-surface);
      border-radius: 50%;
      overflow: visible;
    `,n.appendChild(this.scoreBadge.render()),this.element.appendChild(n),this.loadPersistedScore(),this.element}async loadPersistedScore(){try{const e=await F();e.lastScore!==null&&e.lastScore!==void 0&&this.scoreBadge.setScore(e.lastScore,e.lastDescription||"")}catch(e){console.warn("Ribbon: Failed to load persisted score",e)}}updateScore(e,t){e===null?this.scoreBadge.clear():this.scoreBadge.setScore(e,t)}getScoreBadge(){return this.scoreBadge}}const Jn=[{id:"prompt",label:"Prompt",icon:"prompt"},{id:"attachments",label:"Attach",icon:"attach"},{id:"activity",label:"Activity",icon:"activity"}];class Xn{constructor(e={}){this.currentTab=e.currentTab||"prompt",this.onTabChange=e.onTabChange||null,this.element=null,this.tabButtons={}}render(){return this.element=document.createElement("nav"),this.element.className="tab-bar",this.element.setAttribute("role","tablist"),this.element.style.cssText=`
      display: flex;
      justify-content: center;
      gap: var(--pc-space-6);
      height: 64px;
      background-color: var(--pc-surface);
      border-top: 1px solid var(--pc-outline-variant);
      flex-shrink: 0;
    `,Jn.forEach(e=>{const t=this.createTabButton(e);this.tabButtons[e.id]=t,this.element.appendChild(t)}),this.updateActiveTab(),this.element}createTabButton(e){const t=document.createElement("button");t.className="tab-button",t.setAttribute("role","tab"),t.setAttribute("aria-selected",e.id===this.currentTab),t.setAttribute("aria-controls",`${e.id}-panel`),t.style.cssText=`
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: var(--pc-space-2) var(--pc-space-4);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--pc-on-surface-variant);
      transition: color var(--pc-duration-fast) var(--pc-easing);
      min-width: 64px;
      min-height: 44px;
      -webkit-tap-highlight-color: transparent;
    `;const n=document.createElement("span");n.className="tab-icon",n.innerHTML=q(e.icon);const i=document.createElement("span");return i.className="tab-label",i.style.cssText="font-size: 0.75rem; font-weight: 500;",i.textContent=e.label,t.appendChild(n),t.appendChild(i),t.addEventListener("click",()=>this.selectTab(e.id)),t}selectTab(e){this.currentTab!==e&&(this.currentTab=e,this.updateActiveTab(),this.onTabChange&&this.onTabChange(e))}updateActiveTab(){Object.entries(this.tabButtons).forEach(([e,t])=>{const n=e===this.currentTab;t.setAttribute("aria-selected",n),t.style.color=n?"var(--pc-primary)":"var(--pc-on-surface-variant)"})}setActiveTab(e){this.currentTab=e,this.updateActiveTab()}}let te=null;const Ie=3e3,Ot={info:Ie,success:2500,warning:4e3,error:5e3};function Qn(){return te||(te=document.createElement("div"),te.className="toast-container",te.setAttribute("role","status"),te.setAttribute("aria-live","polite"),document.body.appendChild(te)),te}function v(s,e=Ie){const t=Qn(),n=document.createElement("div");n.className="toast",n.textContent=s;let i="info",o=Ie;typeof e=="number"?o=Number.isFinite(e)&&e>=0?e:Ie:typeof e=="string"&&(i=e,Ot[i]&&(o=Ot[i])),i&&i!=="info"&&n.classList.add(`toast-${i}`),t.appendChild(n);const a=setTimeout(()=>{$t(n)},o);return n.addEventListener("click",()=>{clearTimeout(a),$t(n)}),n}function $t(s){s.classList.add("toast-exit"),s.addEventListener("animationend",()=>{s.parentNode&&s.parentNode.removeChild(s)})}function es(){v("Coming soon")}class We{constructor(e={}){this.title=e.title||"",this.onClose=e.onClose||null,this.element=null,this.overlay=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.previousActiveElement=null}render(){this.overlay=document.createElement("div"),this.overlay.className="overlay",this.overlay.addEventListener("click",n=>{n.target===this.overlay&&this.close()}),this.element=document.createElement("div"),this.element.className="dialog",this.element.setAttribute("role","dialog"),this.element.setAttribute("aria-modal","true"),this.element.setAttribute("aria-labelledby","dialog-title");const e=document.createElement("div");e.className="dialog-header",e.style.cssText="position: relative; transition: box-shadow var(--pc-duration-fast) var(--pc-easing);";const t=document.createElement("h2");return t.id="dialog-title",t.className="dialog-title",t.textContent=this.title,e.appendChild(t),this.content=document.createElement("div"),this.content.className="dialog-content",this.content.style.cssText="flex: 1; overflow-y: auto;",this.actions=document.createElement("div"),this.actions.className="dialog-actions",this.actions.style.cssText="position: relative; border-top: 1px solid var(--pc-outline-variant);",this.content.addEventListener("scroll",()=>{const n=this.content.scrollTop>0;e.style.boxShadow=n?"0 2px 4px rgba(0, 0, 0, 0.15)":"none"}),this.element.appendChild(e),this.element.appendChild(this.content),this.element.appendChild(this.actions),this.overlay.appendChild(this.element),this.overlay}setContent(e){typeof e=="string"?this.content.innerHTML=e:(this.content.innerHTML="",this.content.appendChild(e))}addAction(e,t,n="text"){const i=document.createElement("button");return i.className=`btn btn-${n}`,i.textContent=e,i.addEventListener("click",t),this.actions.appendChild(i),i}handleKeyDown(e){if(e.key==="Escape"){this.close();return}e.key==="Tab"&&this.handleTabKey(e)}handleTabKey(e){const t=this.element.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(t.length===0)return;const n=t[0],i=t[t.length-1];e.shiftKey?document.activeElement===n&&(e.preventDefault(),i.focus()):document.activeElement===i&&(e.preventDefault(),n.focus())}show(){this.overlay||this.render(),this.previousActiveElement=document.activeElement,document.body.appendChild(this.overlay),document.addEventListener("keydown",this.handleKeyDown);const e=this.element.querySelector("button, input, textarea, select");e&&e.focus()}close(){document.removeEventListener("keydown",this.handleKeyDown),this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.previousActiveElement&&this.previousActiveElement.focus&&this.previousActiveElement.focus(),this.onClose&&this.onClose()}}const ts={classify:{temperature:0,maxTokens:100,timeoutMs:5e3},score:{temperature:0,maxTokens:150,timeoutMs:5e3},feedback:{temperature:.2,maxTokens:1024,timeoutMs:8e3}},ve=class ve{static getModels(){return[]}static getDefaultModel(){const e=this.getModels();return e.length>0?e[0].id:""}static getRecommendedModels(){const e=this.getDefaultModel();return{classify:e,score:e,feedback:e}}constructor(e,t){if(new.target===ve)throw new Error("LLMProvider is abstract and cannot be instantiated directly");if(!e)throw new Error("API key is required");if(!t)throw new Error("Model is required");this.apiKey=e,this.model=t}getProviderName(){return this.constructor.displayName}getProviderId(){return this.constructor.id}getModelName(){return this.model}getModelDef(){return this.constructor.getModels().find(t=>t.id===this.model)||null}getContextWindow(){var e;return((e=this.getModelDef())==null?void 0:e.contextWindow)||0}getTaskConfig(e){var i,o;const t=ts[e];if(!t)throw new Error(`Unknown task: ${e}`);const n=((o=(i=this.getModelDef())==null?void 0:i.taskConfig)==null?void 0:o[e])||{};return{...t,...n}}async*streamCompletion(e,t={}){throw new Error("Must implement streamCompletion()")}};O(ve,"id","base"),O(ve,"displayName","Base Provider");let le=ve;const A={INVALID_API_KEY:"invalid_api_key",RATE_LIMITED:"rate_limited",NETWORK_ERROR:"network_error",SERVER_ERROR:"server_error",TIMEOUT:"timeout",STREAM_INTERRUPTED:"stream_interrupted",INVALID_RESPONSE:"invalid_response",UNKNOWN:"unknown",COACH_VALIDATION_FAILED:"coach_validation_failed",COACH_METHODOLOGY_MISSING:"coach_methodology_missing",COACH_EVALUATION_FAILED:"coach_evaluation_failed"},Dt={[A.INVALID_API_KEY]:"Invalid API key. Check Settings.",[A.RATE_LIMITED]:"Rate limit exceeded. Try again later.",[A.NETWORK_ERROR]:"Network error. Check connection.",[A.SERVER_ERROR]:"Server error. Try again later.",[A.TIMEOUT]:"Request timed out. Try again.",[A.STREAM_INTERRUPTED]:"Response interrupted.",[A.INVALID_RESPONSE]:"Invalid response from provider.",[A.UNKNOWN]:"An unexpected error occurred.",[A.COACH_VALIDATION_FAILED]:"Coach couldn't evaluate. Try again.",[A.COACH_METHODOLOGY_MISSING]:"Coaching methodology not configured.",[A.COACH_EVALUATION_FAILED]:"Coach couldn't evaluate. Try again."};class k extends Error{constructor(e,t=A.UNKNOWN,n=!1,i={}){super(e),this.name="LLMError",this.code=t,this.retryable=n,this.details=i,this.userMessage=Dt[t]||Dt[A.UNKNOWN]}static fromHttpStatus(e,t="",n=null){switch(e){case 401:return new k(`Authentication failed: ${t}`,A.INVALID_API_KEY,!1,{status:e,body:n});case 429:return new k(`Rate limit exceeded: ${t}`,A.RATE_LIMITED,!0,{status:e,body:n});case 500:case 502:case 503:case 504:return new k(`Server error: ${e} ${t}`,A.SERVER_ERROR,!0,{status:e,body:n});default:return new k(`HTTP error: ${e} ${t}`,A.UNKNOWN,!1,{status:e,body:n})}}static fromNetworkError(e){return e.name==="AbortError"?new k("Request was aborted",A.TIMEOUT,!0,{originalError:e.message}):new k(`Network error: ${e.message}`,A.NETWORK_ERROR,!0,{originalError:e.message})}static streamInterrupted(e="Unknown"){return new k(`Stream interrupted: ${e}`,A.STREAM_INTERRUPTED,!1,{reason:e})}}const zt="https://api.openai.com/v1/chat/completions";class dt extends le{static getModels(){const e={useMaxCompletionTokens:!0,supportsTemperature:!1,reasoningOverhead:25e3},t={useMaxCompletionTokens:!1,supportsTemperature:!0,reasoningOverhead:0},n={classify:{timeoutMs:3e4},score:{timeoutMs:3e4},feedback:{timeoutMs:45e3}};return[{id:"gpt-5.2",name:"GPT-5.2",description:"Flagship reasoning model",contextWindow:4e5,apiConfig:e,taskConfig:n},{id:"gpt-5.1",name:"GPT-5.1",description:"Previous flagship reasoning",contextWindow:4e5,apiConfig:e,taskConfig:n},{id:"gpt-5",name:"GPT-5",description:"Reasoning with configurable effort",contextWindow:4e5,apiConfig:e,taskConfig:n},{id:"gpt-5-mini",name:"GPT-5 Mini",description:"Affordable reasoning",contextWindow:4e5,apiConfig:e,taskConfig:n},{id:"gpt-5-nano",name:"GPT-5 Nano",description:"Fastest, cheapest reasoning",contextWindow:4e5,apiConfig:e,taskConfig:n},{id:"gpt-4.1",name:"GPT-4.1",description:"Smartest non-reasoning, 1M context",contextWindow:1047576,apiConfig:t},{id:"gpt-4.1-mini",name:"GPT-4.1 Mini",description:"Balanced, 1M context",contextWindow:1047576,apiConfig:t},{id:"gpt-4.1-nano",name:"GPT-4.1 Nano",description:"Fast non-reasoning, 1M context",contextWindow:1047576,apiConfig:t},{id:"o3",name:"o3",description:"Reasoning model, 200K context",contextWindow:2e5,apiConfig:e,taskConfig:n},{id:"o4-mini",name:"o4 Mini",description:"Fast reasoning, 200K context",contextWindow:2e5,apiConfig:e,taskConfig:n},{id:"gpt-4o",name:"GPT-4o",description:"Fast, flexible, multimodal",contextWindow:128e3,apiConfig:t},{id:"gpt-4o-mini",name:"GPT-4o Mini",description:"Budget multimodal",contextWindow:128e3,apiConfig:t}]}static getRecommendedModels(){return{classify:"gpt-4.1-nano",score:"gpt-4.1-mini",feedback:"gpt-4.1"}}constructor(e,t="gpt-4.1-mini"){super(e,t)}async*streamCompletion(e,t={}){var f,b;const{maxTokens:n=2048,temperature:i=.7,systemPrompt:o=null}=t,a=this.getModelDef(),r=(a==null?void 0:a.apiConfig)||{},l=[];o&&l.push({role:"system",content:o}),l.push({role:"user",content:e});const c={model:this.model,messages:l,stream:!0,stream_options:{include_usage:!0}};r.useMaxCompletionTokens?c.max_completion_tokens=n+(r.reasoningOverhead||0):c.max_tokens=n,r.supportsTemperature!==!1&&(c.temperature=i),console.log("OpenAI: Sending request to",zt,"with model:",this.model);let d;try{d=await fetch(zt,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(c)})}catch(y){throw console.error("OpenAI: Network error",y),k.fromNetworkError(y)}if(console.log("OpenAI: Response status",d.status),!d.ok){let y=null;try{y=await d.json(),console.error("OpenAI: Error response",y)}catch{}throw k.fromHttpStatus(d.status,d.statusText,y)}const p=d.body.getReader(),h=new TextDecoder;let u="",m=null;try{for(;;){const{done:y,value:g}=await p.read();if(y){yield{content:"",done:!0,usage:m};break}u+=h.decode(g,{stream:!0});const x=u.split(`
`);u=x.pop()||"";for(const S of x){const C=S.trim();if(!(!C||C==="data: [DONE]")&&C.startsWith("data: "))try{const T=JSON.parse(C.slice(6)),E=(b=(f=T.choices)==null?void 0:f[0])==null?void 0:b.delta;E!=null&&E.content&&(yield{content:E.content,done:!1,usage:null}),T.usage&&(m={prompt:T.usage.prompt_tokens,completion:T.usage.completion_tokens,total:T.usage.total_tokens})}catch(T){console.warn("OpenAI: Failed to parse chunk",T)}}}}catch(y){throw y instanceof k?y:k.streamInterrupted(y.message)}finally{p.releaseLock()}}}O(dt,"id","openai"),O(dt,"displayName","OpenAI");const jt="https://api.anthropic.com/v1/messages",ns="2023-06-01";class pt extends le{static getModels(){const e={useMaxCompletionTokens:!1,supportsTemperature:!0};return[{id:"claude-opus-4-6",name:"Claude Opus 4.6",description:"Most intelligent, coding and agents",contextWindow:2e5,apiConfig:e},{id:"claude-sonnet-4-5",name:"Claude Sonnet 4.5",description:"Best balance of capability and speed",contextWindow:2e5,apiConfig:e},{id:"claude-haiku-4-5",name:"Claude Haiku 4.5",description:"Fast and affordable",contextWindow:2e5,apiConfig:e},{id:"claude-opus-4-5",name:"Claude Opus 4.5",description:"Highly capable, computer use",contextWindow:2e5,apiConfig:e},{id:"claude-opus-4-1",name:"Claude Opus 4.1",description:"Agentic search, long context",contextWindow:2e5,apiConfig:e},{id:"claude-sonnet-4-20250514",name:"Claude Sonnet 4",description:"Balanced, fast",contextWindow:2e5,apiConfig:e},{id:"claude-3-5-sonnet-20241022",name:"Claude 3.5 Sonnet",description:"Previous gen, still supported",contextWindow:2e5,apiConfig:e},{id:"claude-3-5-haiku-20241022",name:"Claude 3.5 Haiku",description:"Fastest, low cost",contextWindow:2e5,apiConfig:e},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",description:"Legacy, ultra low cost",contextWindow:2e5,apiConfig:e}]}static getRecommendedModels(){return{classify:"claude-haiku-4-5",score:"claude-haiku-4-5",feedback:"claude-sonnet-4-5"}}constructor(e,t="claude-sonnet-4-5"){super(e,t)}async*streamCompletion(e,t={}){var h;const{maxTokens:n=2048,temperature:i=.7,systemPrompt:o=null}=t,a={model:this.model,max_tokens:n,stream:!0,messages:[{role:"user",content:e}]};o&&(a.system=o),this.model.includes("thinking")||(a.temperature=i),console.log("Anthropic: Sending request to",jt,"with model:",this.model);let r;try{r=await fetch(jt,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":ns,"anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify(a)})}catch(u){throw console.error("Anthropic: Network error",u),k.fromNetworkError(u)}if(console.log("Anthropic: Response status",r.status),!r.ok){let u=null;try{u=await r.json(),console.error("Anthropic: Error response",u)}catch{}throw k.fromHttpStatus(r.status,r.statusText,u)}const l=r.body.getReader(),c=new TextDecoder;let d="",p=null;try{for(;;){const{done:u,value:m}=await l.read();if(u){yield{content:"",done:!0,usage:p};break}d+=c.decode(m,{stream:!0});const f=d.split(`
`);d=f.pop()||"";for(const b of f){const y=b.trim();if(!(!y||!y.startsWith("data: ")))try{const g=JSON.parse(y.slice(6));if(g.type==="content_block_delta"){const x=g.delta;(x==null?void 0:x.type)==="text_delta"&&x.text&&(yield{content:x.text,done:!1,usage:null})}else g.type==="message_delta"?g.usage&&(p={prompt:g.usage.input_tokens||0,completion:g.usage.output_tokens||0,total:(g.usage.input_tokens||0)+(g.usage.output_tokens||0)}):g.type==="message_start"&&((h=g.message)!=null&&h.usage)&&(p={prompt:g.message.usage.input_tokens||0,completion:0,total:g.message.usage.input_tokens||0})}catch(g){console.warn("Anthropic: Failed to parse chunk",g)}}}}catch(u){throw u instanceof k?u:k.streamInterrupted(u.message)}finally{l.releaseLock()}}}O(pt,"id","anthropic"),O(pt,"displayName","Anthropic");const ss="https://generativelanguage.googleapis.com/v1beta/models";class ht extends le{static getModels(){const e={useMaxCompletionTokens:!1,supportsTemperature:!0};return[{id:"gemini-3-pro-preview",name:"Gemini 3 Pro",description:"Most capable, multimodal understanding",contextWindow:1048576,apiConfig:e},{id:"gemini-3-flash-preview",name:"Gemini 3 Flash",description:"Balanced speed and intelligence",contextWindow:1048576,apiConfig:e},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",description:"Advanced thinking and reasoning",contextWindow:1048576,apiConfig:e},{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",description:"Best price-performance",contextWindow:1048576,apiConfig:e},{id:"gemini-2.5-flash-lite",name:"Gemini 2.5 Flash-Lite",description:"Fastest, cost-efficient",contextWindow:1048576,apiConfig:e}]}static getRecommendedModels(){return{classify:"gemini-2.5-flash-lite",score:"gemini-2.5-flash",feedback:"gemini-3-pro-preview"}}constructor(e,t="gemini-2.5-flash"){super(e,t)}async*streamCompletion(e,t={}){var y;const{maxTokens:n=2048,temperature:i=.7,systemPrompt:o=null}=t,a=[],r=o?{parts:[{text:o}]}:void 0;a.push({role:"user",parts:[{text:e}]});const l={contents:a,generationConfig:{maxOutputTokens:n,temperature:i}};r&&(l.systemInstruction=r);const c=`${ss}/${this.model}:streamGenerateContent?alt=sse&key=${this.apiKey}`;console.log("Google: Sending request with model:",this.model);let d;try{d=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)})}catch(g){throw console.error("Google: Network error",g),k.fromNetworkError(g)}if(console.log("Google: Response status",d.status),!d.ok){let g=null;try{g=await d.json(),console.error("Google: Error response",g)}catch{}throw k.fromHttpStatus(d.status,d.statusText,g)}const p=d.body.getReader(),h=new TextDecoder;let u="",m=null,f=0,b=0;try{for(;;){const{done:g,value:x}=await p.read();if(g){m={prompt:f,completion:b,total:f+b},yield{content:"",done:!0,usage:m};break}u+=h.decode(x,{stream:!0});const S=u.split(`
`);u=S.pop()||"";for(const C of S){const T=C.trim();if(!(!T||!T.startsWith("data: ")))try{const E=JSON.parse(T.slice(6)),B=E.candidates||[];for(const N of B){const L=((y=N.content)==null?void 0:y.parts)||[];for(const _ of L)_.text&&(yield{content:_.text,done:!1,usage:null})}E.usageMetadata&&(f=E.usageMetadata.promptTokenCount||f,b=E.usageMetadata.candidatesTokenCount||b)}catch(E){console.warn("Google: Failed to parse chunk",E)}}}}catch(g){throw g instanceof k?g:k.streamInterrupted(g.message)}finally{p.releaseLock()}}}O(ht,"id","google"),O(ht,"displayName","Google");const Zt="https://api.x.ai/v1/chat/completions";class ut extends le{static getModels(){const e={useMaxCompletionTokens:!0,supportsTemperature:!0,reasoningOverhead:25e3},t={useMaxCompletionTokens:!0,supportsTemperature:!0,reasoningOverhead:0},n={useMaxCompletionTokens:!1,supportsTemperature:!0,reasoningOverhead:0},i={classify:{timeoutMs:3e4},score:{timeoutMs:3e4},feedback:{timeoutMs:45e3}};return[{id:"grok-4",name:"Grok 4",description:"Flagship reasoning model",contextWindow:256e3,apiConfig:e,taskConfig:i},{id:"grok-4-fast-reasoning",name:"Grok 4 Fast",description:"Cost-efficient reasoning",contextWindow:131072,apiConfig:e,taskConfig:i},{id:"grok-4-fast-non-reasoning",name:"Grok 4 Fast (non-reasoning)",description:"High throughput, no CoT",contextWindow:131072,apiConfig:t},{id:"grok-3",name:"Grok 3",description:"Legacy, general purpose",contextWindow:131072,apiConfig:n}]}static getRecommendedModels(){return{classify:"grok-3",score:"grok-4-fast-non-reasoning",feedback:"grok-4"}}constructor(e,t="grok-4"){super(e,t)}async*streamCompletion(e,t={}){var f,b;const{maxTokens:n=2048,temperature:i=.7,systemPrompt:o=null}=t,a=this.getModelDef(),r=(a==null?void 0:a.apiConfig)||{},l=[];o&&l.push({role:"system",content:o}),l.push({role:"user",content:e});const c={model:this.model,messages:l,stream:!0};r.useMaxCompletionTokens?c.max_completion_tokens=n+(r.reasoningOverhead||0):c.max_tokens=n,r.supportsTemperature!==!1&&(c.temperature=i),console.log("xAI: Sending request to",Zt,"with model:",this.model);let d;try{d=await fetch(Zt,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(c)})}catch(y){throw console.error("xAI: Network error",y),k.fromNetworkError(y)}if(console.log("xAI: Response status",d.status),!d.ok){let y=null;try{y=await d.json(),console.error("xAI: Error response",y)}catch{}throw k.fromHttpStatus(d.status,d.statusText,y)}const p=d.body.getReader(),h=new TextDecoder;let u="",m=null;try{for(;;){const{done:y,value:g}=await p.read();if(y){yield{content:"",done:!0,usage:m};break}u+=h.decode(g,{stream:!0});const x=u.split(`
`);u=x.pop()||"";for(const S of x){const C=S.trim();if(!(!C||C==="data: [DONE]")&&C.startsWith("data: "))try{const T=JSON.parse(C.slice(6)),E=(b=(f=T.choices)==null?void 0:f[0])==null?void 0:b.delta;E!=null&&E.content&&(yield{content:E.content,done:!1,usage:null}),T.usage&&(m={prompt:T.usage.prompt_tokens,completion:T.usage.completion_tokens,total:T.usage.total_tokens})}catch(T){console.warn("xAI: Failed to parse chunk",T)}}}}catch(y){throw y instanceof k?y:k.streamInterrupted(y.message)}finally{p.releaseLock()}}}O(ut,"id","x"),O(ut,"displayName","xAI");const Ee={OPENAI:"openai",ANTHROPIC:"anthropic",GOOGLE:"google",X:"x"},we={[Ee.OPENAI]:dt,[Ee.ANTHROPIC]:pt,[Ee.GOOGLE]:ht,[Ee.X]:ut};function is(){return Object.values(we).map(s=>({id:s.id,name:s.displayName,models:s.getModels(),defaultModel:s.getDefaultModel()}))}function os(s){return we[s==null?void 0:s.toLowerCase()]||null}function _e(s,e,t=null){const n=s==null?void 0:s.toLowerCase(),i=we[n];if(!i)throw new k(`Unknown provider type: ${s}`,A.UNKNOWN,!1);const o=t||i.getDefaultModel();return new i(e,o)}function wt(s){const e=we[s==null?void 0:s.toLowerCase()];return e?e.getModels():[]}function yn(s,e){const n=wt(s).find(i=>i.id===e);return(n==null?void 0:n.contextWindow)||0}function rs(s){const e=we[s==null?void 0:s.toLowerCase()];return e?e.getRecommendedModels():{classify:"",score:"",feedback:""}}function as(s){const e=rs(s),t=wt(s),n=Object.values(e).map(i=>{var o;return((o=t.find(a=>a.id===i))==null?void 0:o.contextWindow)||0}).filter(i=>i>0);return n.length>0?Math.min(...n):0}function vn(s,e=4096){if(!s||s<=0)return 5e4;const t=Math.max(0,s-e);return Math.floor(t*3.5)}const Kt=is();class cs extends We{constructor(){super({title:"Settings"}),this.settings=W(),this.apiKeyInputs={}}createContent(){const e=document.createElement("div");return e.style.cssText="display: flex; flex-direction: column; gap: var(--pc-space-6);",e.appendChild(this.createThemeSection()),e.appendChild(this.createAISection()),e.appendChild(this.createExportLogsSection()),e}createThemeSection(){const e=document.createElement("div"),t=document.createElement("h3");t.className="text-title",t.style.cssText="margin-bottom: var(--pc-space-3);",t.textContent="Theme",e.appendChild(t);const n=document.createElement("div");return n.style.cssText="display: flex; gap: var(--pc-space-3);",["system","light","dark"].forEach(i=>{const o=document.createElement("label");o.style.cssText=`
        display: flex;
        align-items: center;
        gap: var(--pc-space-2);
        cursor: pointer;
        padding: var(--pc-space-2);
      `;const a=document.createElement("input");a.type="radio",a.name="theme",a.value=i,a.checked=this.settings.theme===i,a.addEventListener("change",()=>{this.settings.theme=i,Kn(i)});const r=document.createElement("span");r.className="text-body",r.textContent=i.charAt(0).toUpperCase()+i.slice(1),o.appendChild(a),o.appendChild(r),n.appendChild(o)}),e.appendChild(n),e}createAISection(){const e=document.createElement("div"),t=document.createElement("h3");t.className="text-title",t.style.cssText="margin-bottom: var(--pc-space-3);",t.textContent="Artificial Intelligence",e.appendChild(t);const n=document.createElement("div");n.style.cssText="display: flex; flex-direction: column; gap: var(--pc-space-4);";const i=document.createElement("div"),o=document.createElement("label");o.className="text-label",o.style.cssText="display: block; margin-bottom: var(--pc-space-1); color: var(--pc-on-surface-variant);",o.textContent="Provider",i.appendChild(o),this.providerSelect=document.createElement("select"),this.providerSelect.className="input",this.providerSelect.style.cssText="width: 100%;",Kt.forEach(c=>{const d=document.createElement("option");d.value=c.id,d.textContent=c.name,this.providerSelect.appendChild(d)}),this.providerSelect.value=this.settings.provider||"openai",this.providerSelect.addEventListener("change",()=>{this.settings.provider=this.providerSelect.value,this.updateApiKeyField(),this.updateTestModelOptions()}),i.appendChild(this.providerSelect),n.appendChild(i),this.apiKeyGroup=document.createElement("div"),this.apiKeyLabel=document.createElement("label"),this.apiKeyLabel.className="text-label",this.apiKeyLabel.style.cssText="display: block; margin-bottom: var(--pc-space-1); color: var(--pc-on-surface-variant);",this.apiKeyGroup.appendChild(this.apiKeyLabel);const a=document.createElement("span");a.className="text-body",a.style.cssText="font-size: 0.75rem; color: var(--pc-on-surface-variant); margin-left: var(--pc-space-2);",a.textContent="(stored locally on your device)",this.apiKeyLabel.appendChild(a),this.apiKeyInput=document.createElement("input"),this.apiKeyInput.type="password",this.apiKeyInput.className="input",this.apiKeyInput.autocomplete="off",this.apiKeyInput.addEventListener("input",c=>{const d=this.providerSelect.value;this.settings.apiKeys[d]=c.target.value.trim()||null}),this.apiKeyGroup.appendChild(this.apiKeyInput),n.appendChild(this.apiKeyGroup);const r=document.createElement("div"),l=document.createElement("label");return l.className="text-label",l.style.cssText="display: block; margin-bottom: var(--pc-space-1); color: var(--pc-on-surface-variant);",l.textContent="LLM for Testing",r.appendChild(l),this.testModelSelect=document.createElement("select"),this.testModelSelect.className="input",this.testModelSelect.style.cssText="width: 100%;",this.testModelSelect.addEventListener("change",()=>{this.settings.testModel=this.testModelSelect.value}),r.appendChild(this.testModelSelect),n.appendChild(r),e.appendChild(n),this.updateApiKeyField(),this.updateTestModelOptions(),e}updateApiKeyField(){const e=this.providerSelect.value,t=Kt.find(i=>i.id===e),n=t?t.name:e;this.apiKeyLabel.firstChild.textContent=`${n} API Key `,this.apiKeyInput.placeholder=`Enter ${n} API key`,this.apiKeyInput.value=this.settings.apiKeys[e]||""}updateTestModelOptions(){const e=this.providerSelect.value,t=wt(e);this.testModelSelect.innerHTML="",t.forEach(i=>{const o=document.createElement("option");o.value=i.id,o.textContent=i.name,i.description&&(o.title=i.description),this.testModelSelect.appendChild(o)});const n=t.map(i=>i.id);this.settings.testModel&&n.includes(this.settings.testModel)?this.testModelSelect.value=this.settings.testModel:t.length>0&&(this.testModelSelect.value=t[0].id,this.settings.testModel=t[0].id)}createExportLogsSection(){const e=document.createElement("div"),t=document.createElement("h3");t.className="text-title",t.style.cssText="margin-bottom: var(--pc-space-3);",t.textContent="Data Export",e.appendChild(t);const n=document.createElement("p");n.className="text-body",n.style.cssText="color: var(--pc-on-surface-variant); margin-bottom: var(--pc-space-3); font-size: 0.85rem;",n.textContent="Export your session data for debugging, backup, or analysis.",e.appendChild(n);const i=document.createElement("div");i.style.cssText="display: flex; flex-direction: column; gap: var(--pc-space-3);";const o=document.createElement("div");o.style.cssText="display: flex; flex-direction: column; gap: var(--pc-space-2);";const a=document.createElement("div");a.className="text-body",a.style.cssText="font-weight: 500;",a.textContent="Complete Session Export",o.appendChild(a);const r=document.createElement("div");r.className="text-body",r.style.cssText="font-size: 0.8rem; color: var(--pc-on-surface-variant);",r.textContent="Includes Activity tab history, prompt evolution, settings, and performance metrics",o.appendChild(r);const l=document.createElement("div");l.style.cssText="display: flex; align-items: center; gap: var(--pc-space-3);";const c=document.createElement("button");c.className="btn btn-outlined",c.style.cssText="min-height: 40px;",c.innerHTML=`
      <svg width="18" height="18" viewBox="0 -960 960 960" fill="currentColor" style="margin-right: var(--pc-space-2);">
        <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
      </svg>
      Export Session
    `,c.addEventListener("click",async()=>{try{await qn(),v("Session data exported successfully")}catch(f){console.error("Export failed:",f),v("Failed to export session data")}}),l.appendChild(c),o.appendChild(l),i.appendChild(o);const d=document.createElement("div");d.style.cssText="display: flex; flex-direction: column; gap: var(--pc-space-2);";const p=document.createElement("div");p.className="text-body",p.style.cssText="font-weight: 500;",p.textContent="API Logs Only",d.appendChild(p);const h=document.createElement("div");h.className="text-body",h.style.cssText="font-size: 0.8rem; color: var(--pc-on-surface-variant);",h.textContent="Basic API request/response metadata for technical analysis",d.appendChild(h);const u=document.createElement("div");u.style.cssText="display: flex; align-items: center; gap: var(--pc-space-3);";const m=document.createElement("button");return m.className="btn btn-outlined",m.style.cssText="min-height: 40px;",m.innerHTML=`
      <svg width="18" height="18" viewBox="0 -960 960 960" fill="currentColor" style="margin-right: var(--pc-space-2);">
        <path d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z"/>
      </svg>
      Export Logs
    `,m.addEventListener("click",async()=>{const f=await Lt();if(f===0){v("No logs to export");return}await In(),v(`Exported ${f} log entries`)}),u.appendChild(m),this.logCountEl=document.createElement("span"),this.logCountEl.className="text-body",this.logCountEl.style.cssText="color: var(--pc-on-surface-variant); font-size: 0.85rem;",this.logCountEl.textContent="Loading...",u.appendChild(this.logCountEl),d.appendChild(u),i.appendChild(d),e.appendChild(i),e.style.marginBottom="var(--pc-space-6)",this.updateLogCount(),e}async updateLogCount(){const e=await Lt();this.logCountEl&&(e===0?this.logCountEl.textContent="No logs yet":this.logCountEl.textContent=`${e} log${e!==1?"s":""} stored`)}show(){this.render(),this.setContent(this.createContent()),this.addAction("Cancel",()=>this.close(),"text"),this.addAction("Save",()=>this.save(),"filled"),super.show()}save(){dn(this.settings),v("Settings saved"),this.close()}}let se=null,mt=[];function ls(){window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),se=s,mt.forEach(e=>e(!0))}),window.addEventListener("appinstalled",()=>{se=null,mt.forEach(s=>s(!1))})}function Ct(){return se!==null}async function ds(){if(!se)return!1;se.prompt();const{outcome:s}=await se.userChoice;return se=null,s==="accepted"}function ps(s){mt.push(s),s(Ct())}const ft={"text/plain":".txt","text/markdown":".md","application/json":".json",".txt":"text/plain",".md":"text/markdown",".json":"application/json"},hs=[".txt",".md",".json"],Tt=102400,us=5e4,ge={UNSUPPORTED_TYPE:"UNSUPPORTED_TYPE",SIZE_EXCEEDED:"SIZE_EXCEEDED",EMPTY_FILE:"EMPTY_FILE",READ_ERROR:"READ_ERROR"};function kt(s){if(!s)return"";const e=s.lastIndexOf(".");return e===-1?"":s.slice(e).toLowerCase()}function ms(s){if(s.type&&ft[s.type])return!0;const e=kt(s.name);return hs.includes(e)}function fs(s){if(s.type&&ft[s.type])return s.type;const e=kt(s.name);return ft[e]||e}function gs(s,e=Tt){if(!ms(s))return{valid:!1,error:`Unsupported file type: ${kt(s.name)||s.type||"unknown"}. Supported: .txt, .md, .json`,errorCode:ge.UNSUPPORTED_TYPE};if(s.size>e){const t=Math.round(e/1024);return{valid:!1,error:`Attachment is too large (${Math.round(s.size/1024)}KB). Maximum size is ${t}KB per file. Try uploading a shorter document or splitting it into multiple files.`,errorCode:ge.SIZE_EXCEEDED}}return s.size===0?{valid:!1,error:"File is empty",errorCode:ge.EMPTY_FILE}:{valid:!0}}function ys(s){return new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=()=>t(new Error(`Failed to read file: ${s.name}`)),n.readAsText(s)})}function ye(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`}class Re extends Error{constructor(e,t,n){super(e),this.name="AttachmentError",this.code=t,this.filename=n}}async function vs(s,e=Tt){const t=gs(s,e);if(!t.valid)throw new Re(t.error,t.errorCode,s.name);let n;try{n=await ys(s)}catch{throw new Re(`Failed to read file: ${s.name}`,ge.READ_ERROR,s.name)}if(!n||n.trim()==="")throw new Re("File is empty",ge.EMPTY_FILE,s.name);const i={id:crypto.randomUUID(),filename:s.name,content:n,size:s.size,type:fs(s),addedAt:new Date().toISOString()};return await M(),await D("attachments",i),i}async function ue(){return await M(),(await xe("attachments")).sort((e,t)=>new Date(t.addedAt).getTime()-new Date(e.addedAt).getTime())}async function bs(s){return await M(),await pe("attachments",s)?(await bt("attachments",s),!0):!1}async function Be(){await M();const e=(await xe("attachments")).length;return await Hn("attachments"),e}async function xs(){const s=await ue();if(s.length===0)return{summary:"",count:0,totalSize:0};const e=s.reduce((i,o)=>i+o.size,0),t=s.map(i=>`- ${i.filename} (${ye(i.size)}, ${i.type})`);return{summary:`[ATTACHMENTS: ${s.length} file(s), ${ye(e)} total]
${t.join(`
`)}`,count:s.length,totalSize:e}}async function ws(s=us){const e=await ue();if(e.length===0)return{context:"",truncated:!1,count:0};const t=[];let n=0,i=!1;for(const o of e){const a=`--- Attached File: ${o.filename} ---`,r=`--- End of ${o.filename} ---`,l=a.length+r.length+4;if(n+l+o.content.length>s){const c=s-n-l-50;if(c>100){const d=o.content.slice(0,c);t.push(`${a}
${d}
[... content truncated ...]
${r}`),i=!0}break}t.push(`${a}
${o.content}
${r}`),n+=l+o.content.length}return{context:t.join(`

`),truncated:i,count:e.length}}async function Cs(s){const e={id:s.id||crypto.randomUUID(),filename:s.filename,content:s.content,size:s.size||s.content.length,type:s.type||"text/plain",addedAt:s.addedAt||new Date().toISOString()};return await M(),await D("attachments",e),e}let gt=null,yt=null,be=null;function Ts(s){gt=s}function ks(s){yt=s}function Es(s){be=s}function Ut(){return crypto.randomUUID()}async function Et(){const s=await F(),e=await Ue(),t=await Ke(),n=await ue(),i=s.promptText&&s.promptText.trim().length>0,o=e.length>0,a=t.length>0,r=n.length>0;return i||o||a||r}async function Ss(){var r,l;const s=await F();if(!s.restoredFromId)return!0;const e=await xn(s.restoredFromId);if(!e)return!0;const t=await Ue(),n=await Ke(),i=(s.promptText||"")!==(e.prompt||""),o=t.length!==(((r=e.feedbackHistory)==null?void 0:r.length)||0),a=n.length!==(((l=e.results)==null?void 0:l.length)||0);return i||o||a}async function Ps(){const s=await F(),e=await Ue(),t=await Ke(),n=await ue(),i=s.promptText||"",o=i.substring(0,100).trim(),a=s.lastScore??null,r=s.lastDescription??null;return{id:s.id,createdAt:new Date(s.createdAt).getTime(),archivedAt:Date.now(),prompt:i,previewText:o||"(empty prompt)",feedbackHistory:e,results:t,attachments:n.map(l=>({id:l.id,filename:l.filename,content:l.content,size:l.size,type:l.type,addedAt:l.addedAt})),finalScore:a,finalDescription:r,starred:!1}}async function bn(){if(!await Et())return null;if(!await Ss())return console.log("Skipping archive: restored session has no modifications"),null;const t=await Ps();try{await D("sessions",t)}catch(n){throw n.name==="QuotaExceededError"||n.message&&n.message.includes("quota")?new Error("Storage quota exceeded. Please delete some old sessions from History to free up space."):n}return console.log(`Session archived: ${t.id}`),t.id}async function As(){await fn(),await mn(),await Be(),await un(),gt&&gt()}async function Ms(s={}){const{skipConfirmation:e=!1}=s,t=await Et();return t&&!e&&be&&!await be("Start New Session?","Your current session will be saved to history. You can restore it later from the History menu.")?!1:(t&&await bn(),await As(),!0)}async function Ns(s={}){const{starredOnly:e=!1,searchQuery:t="",limit:n=50}=s;await M();let o=(await xe("sessions")).filter(r=>r.archivedAt);if(e&&(o=o.filter(r=>r.starred)),t.trim()){const r=t.toLowerCase();o=o.filter(l=>l.previewText&&l.previewText.toLowerCase().includes(r)||l.prompt&&l.prompt.toLowerCase().includes(r))}o.sort((r,l)=>l.archivedAt-r.archivedAt),o=o.slice(0,n);const a=o.map(r=>{var l,c,d;return{id:r.id,archivedAt:r.archivedAt,previewText:r.previewText||"(empty prompt)",finalScore:r.finalScore,starred:r.starred||!1,feedbackCount:((l=r.feedbackHistory)==null?void 0:l.length)||0,resultCount:((c=r.results)==null?void 0:c.length)||0,attachmentCount:((d=r.attachments)==null?void 0:d.length)||0}});try{const r=await F(),l=await Ue(),c=await Ke(),d=await ue(),p=r.promptText&&r.promptText.trim().length>0,h=l.length>0,u=c.length>0,m=d.length>0;if(p||h||u||m){const f=r.promptText||"",b=f.substring(0,100).trim()||"(empty prompt)",y={id:r.id,archivedAt:null,updatedAt:new Date(r.updatedAt).getTime(),previewText:b,finalScore:r.lastScore??null,starred:!1,feedbackCount:l.length,resultCount:c.length,attachmentCount:d.length,isCurrent:!0};if(t.trim()){const g=t.toLowerCase();(b.toLowerCase().includes(g)||f.toLowerCase().includes(g))&&a.unshift(y)}else e||a.unshift(y)}}catch(r){console.warn("Failed to include current session in history:",r)}return a}async function xn(s){await M();const e=await pe("sessions",s);return e&&e.archivedAt?e:null}async function Ls(s){const e=await xn(s);if(!e)throw new Error(`Session not found: ${s}`);await Et()&&await bn(),await fn(),await mn(),await Be();const n={id:Ut(),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),promptText:e.prompt||"",promptHistory:[],results:[],totalTokens:0,lastScore:e.finalScore,lastDescription:e.finalDescription,feedbackCount:0,restoredFromId:s};if(await D("sessions",n),hn(n.id),e.feedbackHistory&&e.feedbackHistory.length>0){for(const i of e.feedbackHistory){const o={...i,id:Ut(),sessionId:n.id,type:"feedback"};await D("history",o)}await oe({feedbackCount:e.feedbackHistory.length,lastScore:e.finalScore,lastDescription:e.finalDescription})}if(e.results&&e.results.length>0&&await oe({results:e.results}),e.attachments&&e.attachments.length>0)for(const i of e.attachments)await Cs(i);yt&&yt({prompt:e.prompt,feedbackHistory:e.feedbackHistory,results:e.results,attachments:e.attachments,finalScore:e.finalScore,finalDescription:e.finalDescription})}async function Is(s){await M();const e=await pe("sessions",s);if(!e)throw new Error(`Session not found: ${s}`);return e.starred=!e.starred,await D("sessions",e),e.starred}async function _s(s,e={}){const{skipConfirmation:t=!1}=e;return!t&&be&&!await be("Delete Session?","This session will be permanently deleted. This action cannot be undone.")?!1:(await M(),await bt("sessions",s),console.log(`Session deleted: ${s}`),!0)}class Rs extends We{constructor(e={}){super(e),this.message=e.message||"",this.confirmLabel=e.confirmLabel||"Confirm",this.cancelLabel=e.cancelLabel||"Cancel",this.confirmVariant=e.confirmVariant||"filled",this.destructive=e.destructive||!1,this.resolvePromise=null}render(){super.render();const e=document.createElement("p");e.style.cssText=`
      color: var(--pc-on-surface-variant);
      line-height: 1.5;
      margin: 0 0 var(--pc-space-4) 0;
    `,e.textContent=this.message,this.setContent(e),this.addAction(this.cancelLabel,()=>{this.resolve(!1)},"text");const t=this.addAction(this.confirmLabel,()=>{this.resolve(!0)},this.confirmVariant);return this.destructive&&(t.style.backgroundColor="var(--pc-error, #EF4444)",t.style.color="white"),this.overlay}resolve(e){this.resolvePromise&&(this.resolvePromise(e),this.resolvePromise=null),this.close()}async prompt(){return new Promise(e=>{this.resolvePromise=e,this.show()})}close(){this.resolvePromise&&(this.resolvePromise(!1),this.resolvePromise=null),super.close()}}async function wn(s,e,t={}){return new Rs({title:s,message:e,...t}).prompt()}class qs{constructor(e={}){this.onClose=e.onClose||null,this.onNewSession=e.onNewSession||null,this.onShowHistory=e.onShowHistory||null,this.onCopyPrompt=e.onCopyPrompt||null,this.onTogglePreview=e.onTogglePreview||null,this.isPreviewMode=!1,this.element=null,this.backdrop=null,this.isOpen=!1,Es((t,n)=>wn(t,n))}render(){const e=document.createElement("div");e.className="menu-container",e.style.cssText="position: fixed; inset: 0; z-index: var(--pc-z-overlay); pointer-events: none;",this.backdrop=document.createElement("div"),this.backdrop.className="menu-backdrop",this.backdrop.style.cssText=`
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity var(--pc-duration-normal) var(--pc-easing);
      pointer-events: none;
    `,this.backdrop.addEventListener("click",()=>this.hide()),e.appendChild(this.backdrop),this.element=document.createElement("aside"),this.element.className="menu-panel",this.element.setAttribute("role","navigation"),this.element.setAttribute("aria-label","Main menu"),this.element.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-width: 80vw;
      background-color: var(--pc-surface);
      box-shadow: none;
      transform: translateX(-100%);
      transition: transform var(--pc-duration-normal) var(--pc-easing);
      display: flex;
      flex-direction: column;
      pointer-events: auto;
      overflow-y: auto; /* Add this line to enable scrolling */
    `;const t=document.createElement("div");t.style.cssText=`
      position: relative;
      aspect-ratio: 1 / 1;
      width: 100%;
      background-image: url('./assets/icons/PromptCoach.jpg');
      background-image: image-set(
        url('./assets/icons/PromptCoach.webp') type('image/webp'),
        url('./assets/icons/PromptCoach.jpg') type('image/jpeg')
      );
      background-size: cover;
      background-position: center;
      border-bottom: 1px solid var(--pc-outline);
      display: flex;
      align-items: flex-end;
      flex-shrink: 0;
      transition: box-shadow var(--pc-duration-fast) var(--pc-easing);
    `;const n=document.createElement("h2");n.textContent="Prompt Coach",n.style.cssText=`
      width: 100%;
      padding: var(--pc-space-3) var(--pc-space-6);
      color: #6750A4 !important;
      font-size: 0.875rem;
      text-align: center;
      margin: 0;
    `,t.appendChild(n),this.element.appendChild(t);const i=document.createElement("ul");return i.style.cssText="list-style: none; padding: var(--pc-space-2) 0; flex: 1; overflow-y: auto;",i.addEventListener("scroll",()=>{t.style.boxShadow=i.scrollTop>0?"0 2px 4px rgba(0, 0, 0, 0.15)":"none"}),[{label:"New Session",icon:"newSession",action:()=>this.handleNewSession()},{label:"Session History",icon:"sessionHistory",action:()=>this.handleShowHistory()},{separator:!0},{label:"Copy Prompt",icon:"copyPrompt",action:()=>this.handleCopyPrompt()},{label:"Markdown Preview",icon:"previewPrompt",action:()=>this.handleTogglePreview(),id:"preview-toggle-item",hasSwitch:!0,switchState:this.isPreviewMode},{separator:!0},{label:"Settings",icon:"settings",action:()=>this.openSettings()},{label:"Install App",icon:"install",action:()=>this.handleInstall(),id:"install-item",hidden:!Ct()}].forEach(a=>{if(a.separator){const c=document.createElement("li");c.style.cssText=`
          height: 1px;
          background-color: var(--pc-outline-variant);
          margin: var(--pc-space-2) var(--pc-space-6);
        `,i.appendChild(c);return}const r=document.createElement("li");a.id&&(r.id=a.id),a.hidden&&(r.style.display="none");const l=document.createElement("button");if(l.className="menu-item",l.style.cssText=`
        display: flex;
        align-items: center;
        gap: var(--pc-space-4);
        width: 100%;
        padding: var(--pc-space-3) var(--pc-space-6);
        background: none;
        border: none;
        cursor: pointer;
        color: var(--pc-on-surface);
        font-size: 0.875rem;
        text-align: left;
        min-height: 44px;
        transition: background-color var(--pc-duration-fast) var(--pc-easing);
      `,l.innerHTML=`${q(a.icon)}<span>${a.label}</span>`,a.hasSwitch){const c=document.createElement("div");c.className="menu-switch",c.style.cssText=`
          margin-left: auto;
          width: 36px;
          height: 20px;
        `;const d=document.createElement("input");d.type="checkbox",d.checked=a.switchState,d.style.cssText=`
          opacity: 0;
          width: 0;
          height: 0;
          position: absolute;
        `;const p=document.createElement("div");p.className="switch-slider",p.style.cssText=`
          position: relative;
          width: 100%;
          height: 100%;
          border-radius: 10px;
          background-color: var(--pc-outline-variant);
          transition: background-color 0.2s;
          cursor: pointer;
        `;const h=document.createElement("div");h.className="switch-thumb",h.style.cssText=`
          position: absolute;
          content: '';
          height: 16px;
          width: 16px;
          left: 2px;
          top: 2px;
          border-radius: 50%;
          background-color: var(--pc-surface);
          transition: transform 0.2s;
        `,d.addEventListener("change",()=>{a.switchState=d.checked,d.checked?(p.style.backgroundColor="var(--pc-primary)",h.style.transform="translateX(16px)"):(p.style.backgroundColor="var(--pc-outline-variant)",h.style.transform="translateX(0)"),a.action()}),d.checked&&(p.style.backgroundColor="var(--pc-primary)",h.style.transform="translateX(16px)"),p.appendChild(h),c.appendChild(d),c.appendChild(p),l.appendChild(c)}l.addEventListener("click",()=>{if(a.hasSwitch){const c=l.querySelector(".menu-switch input");c&&(c.checked=!c.checked,c.dispatchEvent(new Event("change")))}else a.action(),this.hide()}),l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--pc-surface-variant)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="transparent"}),r.appendChild(l),i.appendChild(r)}),ps(a=>{const r=document.getElementById("install-item");r&&(r.style.display=a?"block":"none")}),this.element.appendChild(i),e.appendChild(this.element),e}async handleNewSession(){try{await Ms()&&(v("New session started"),this.onNewSession&&this.onNewSession())}catch(e){console.error("Failed to start new session:",e),v(e.message||"Failed to start new session","error")}}handleShowHistory(){this.onShowHistory?this.onShowHistory():es()}handleCopyPrompt(){this.onCopyPrompt&&this.onCopyPrompt()}handleTogglePreview(){this.isPreviewMode=!this.isPreviewMode,this.updatePreviewToggleItem(),this.onTogglePreview&&this.onTogglePreview(this.isPreviewMode)}updatePreviewToggleItem(){const e=document.getElementById("preview-toggle-item");if(e){const t=e.querySelector(".menu-switch input");t&&(t.checked=this.isPreviewMode)}}setPreviewMode(e){this.isPreviewMode=e,this.updatePreviewToggleItem()}async handleInstall(){await ds()&&v("App installed successfully!")}openSettings(){new cs().show()}show(){this.isOpen=!0,this.backdrop.style.opacity="1",this.backdrop.style.pointerEvents="auto",this.element.style.transform="translateX(0)",this.element.style.boxShadow="var(--pc-shadow-lg)"}hide(){this.isOpen&&(this.isOpen=!1,this.backdrop.style.opacity="0",this.backdrop.style.pointerEvents="none",this.element.style.transform="translateX(-100%)",this.element.style.boxShadow="none")}toggle(){this.isOpen?this.hide():this.show()}}const U={maxRetries:1,timeoutMs:5e3,retryDelayMs:100};function Fs(s,e,t="operation"){return new Promise((n,i)=>{const o=setTimeout(()=>{i(new Error(`${t} timed out after ${e}ms`))},e);s.then(a=>{clearTimeout(o),n(a)}).catch(a=>{clearTimeout(o),i(a)})})}async function Bs(s,e={}){const{maxRetries:t=U.maxRetries,retryDelayMs:n=U.retryDelayMs,operationName:i="operation"}=e;let o;for(let a=0;a<=t;a++)try{return await s()}catch(r){o=r,a<t&&await new Promise(l=>setTimeout(l,n))}throw new Error(`${i} failed after ${t+1} attempts: ${o.message}`)}async function Hs(s,e={}){const{maxRetries:t=U.maxRetries,timeoutMs:n=U.timeoutMs,retryDelayMs:i=U.retryDelayMs,operationName:o="tool"}=e;return Bs(()=>Fs(s(),n,o),{maxRetries:t,retryDelayMs:i,operationName:o})}async function Os(s,e={}){const{maxRetries:t=U.maxRetries,timeoutMs:n=U.timeoutMs,retryDelayMs:i=U.retryDelayMs}=e,o=s.map(()=>performance.now()),a=s.map(({fn:r,name:l},c)=>Hs(r,{maxRetries:t,timeoutMs:n,retryDelayMs:i,operationName:l}).then(d=>({status:"fulfilled",value:d,durationMs:Math.round(performance.now()-o[c]),retryCount:0})).catch(d=>({status:"rejected",reason:d,durationMs:Math.round(performance.now()-o[c]),retryCount:t})));return Promise.all(a)}function Se(s,e){return{step:s,startTime:performance.now(),endTime:null,durationMs:null,inputs:e,outputs:null,error:null,retryCount:0}}function V(s,e=null,t=null,n=0){return s.endTime=performance.now(),s.durationMs=Math.round(s.endTime-s.startTime),s.outputs=e,s.error=t?t.message:null,s.retryCount=n,s}const Wt=["simple_query","complex_task","creative_task","high_stakes_task"],Gt="complex_task",$s=.5;function Ds(s){const e=[];return!s||typeof s!="object"?(e.push("Result must be an object"),{valid:!1,errors:e}):(s.type?Wt.includes(s.type)||e.push(`Invalid type: ${s.type}. Must be one of: ${Wt.join(", ")}`):e.push("Missing required field: type"),s.confidence===void 0||s.confidence===null?e.push("Missing required field: confidence"):typeof s.confidence!="number"?e.push("Confidence must be a number"):(s.confidence<0||s.confidence>1)&&e.push("Confidence must be between 0 and 1"),{valid:e.length===0,errors:e})}function zs(s){return s.confidence<$s?{type:Gt,confidence:s.confidence,reasoning:`Low confidence (${s.confidence}), defaulting to ${Gt}`}:{type:s.type,confidence:s.confidence,reasoning:s.reasoning||null}}function js(s){let e=s;const t=s.match(/```(?:json)?\s*([\s\S]*?)```/);t&&(e=t[1].trim());let n;try{n=JSON.parse(e)}catch(o){throw new Error(`Failed to parse classification response as JSON: ${o.message}`)}const i=Ds(n);if(!i.valid)throw new Error(`Invalid classification result: ${i.errors.join("; ")}`);return zs(n)}function Zs(s,e){return{system:e,user:`Classify this prompt:

${s}`}}const Vt=0,Yt=100,He=300;function Ks(s,e){const t=[],n=[];return!s||typeof s!="object"?(t.push("Result must be an object"),{valid:!1,errors:t,warnings:n}):(s.principleId?s.principleId!==e&&n.push(`principleId mismatch: expected ${e}, got ${s.principleId}`):t.push("Missing required field: principleId"),s.score===void 0||s.score===null?t.push("Missing required field: score"):typeof s.score!="number"?t.push("Score must be a number"):s.score<Vt||s.score>Yt?t.push(`Score must be between ${Vt} and ${Yt}`):Number.isInteger(s.score)||n.push("Score should be an integer, rounding"),s.reason?typeof s.reason!="string"?t.push("Reason must be a string"):s.reason.length>He&&n.push(`Reason exceeds ${He} characters, will be truncated`):t.push("Missing required field: reason"),s.applicable!==void 0&&typeof s.applicable!="boolean"&&n.push("applicable should be a boolean"),{valid:t.length===0,errors:t,warnings:n})}function Us(s,e,t){return t?{principleId:e,score:Math.round(s.score),reason:s.reason.length>He?s.reason.substring(0,He-3)+"...":s.reason,applicable:!0}:{principleId:e,score:null,reason:"Not applicable to this prompt type",applicable:!1}}function Ws(s,e,t){let n=s;const i=s.match(/```(?:json)?\s*([\s\S]*?)```/);i&&(n=i[1].trim());let o;try{o=JSON.parse(n)}catch(r){throw new Error(`Failed to parse scoring response as JSON: ${r.message}`)}const a=Ks(o,e);if(!a.valid)throw new Error(`Invalid scoring result: ${a.errors.join("; ")}`);return a.warnings.length>0&&console.warn(`Scoring warnings for ${e}:`,a.warnings),Us(o,e,t)}function Gs(s,e,t,n,i){var a,r;return{system:i.replace("{{PRINCIPLE_ID}}",e.id).replace("{{PRINCIPLE_NAME}}",e.name).replace("{{PRINCIPLE_DESCRIPTION}}",e.description).replace("{{PRINCIPLE_GOOD_EXAMPLE}}",((a=e.examples)==null?void 0:a.good)||"N/A").replace("{{PRINCIPLE_BAD_EXAMPLE}}",((r=e.examples)==null?void 0:r.bad)||"N/A").replace("{{PROMPT_TYPE}}",t).replace("{{IS_APPLICABLE}}",n?"Yes":"No - not applicable to this prompt type"),user:`Score this prompt:

${s}`}}const Oe=1500,$e=200,De=200,Vs=[/["'][^"']{20,}["']/,/(?:add|include|mention)\s+["'][A-Z][^"']+["']/i,/(?:add|include|mention)\s+\d{4,}/];function Ys(s){const e=[],t=[];if(!s||typeof s!="object")return e.push("Result must be an object"),{valid:!1,errors:e,warnings:t};if(!s.suggestedChange){const n=s.suggested_change||s.suggestion||s.suggestedchange;n&&(s.suggestedChange=n)}return s.feedback?typeof s.feedback!="string"?e.push("Feedback must be a string"):s.feedback.length>Oe&&t.push(`Feedback exceeds ${Oe} characters, will be truncated`):e.push("Missing required field: feedback"),s.suggestedChange?typeof s.suggestedChange!="string"?(t.push("suggestedChange must be a string"),s.suggestedChange=void 0):s.suggestedChange.length>$e&&t.push(`suggestedChange exceeds ${$e} characters, will be truncated`):t.push("Missing optional field: suggestedChange"),s.summary!==void 0&&(typeof s.summary!="string"?e.push("summary must be a string when provided"):s.summary.length>De&&t.push(`summary exceeds ${De} characters, will be truncated`)),{valid:e.length===0,errors:e,warnings:t}}function Js(s){for(const e of Vs)if(e.test(s))return{isStructural:!1,reason:"Suggestion appears to contain content-specific details"};return{isStructural:!0,reason:null}}function Xs(s){let e=s.feedback,t=s.suggestedChange||"Review the feedback above for improvement suggestions.",n=s.summary||null;e.length>Oe&&(e=e.substring(0,Oe-3)+"..."),t.length>$e&&(t=t.substring(0,$e-3)+"..."),n&&n.length>De&&(n=n.substring(0,De-3)+"...");const i=Js(t);return{feedback:e,suggestedChange:t,summary:n,isStructural:i.isStructural,structuralWarning:i.reason,acknowledgment:s.acknowledgment||null}}function Pe(s){let e=s;const t=s.match(/```(?:json)?\s*([\s\S]*?)```/);t&&(e=t[1].trim());let n;try{n=JSON.parse(e)}catch(o){throw new Error(`Failed to parse feedback response as JSON: ${o.message}`)}const i=Ys(n);if(!i.valid)throw new Error(`Invalid feedback result: ${i.errors.join("; ")}`);return i.warnings.length>0&&console.warn("Feedback warnings:",i.warnings),Xs(n)}function Jt(s,e,t,n,i,o){var r;i&&i.wasAddressed&&`${i.principle}${i.previousScore}${i.currentScore}`;let a=o.replace("{{PRINCIPLE_NAME}}",e.name).replace("{{PRINCIPLE_DESCRIPTION}}",e.description).replace("{{SCORE}}",t.toString()).replace("{{PRINCIPLE_GOOD_EXAMPLE}}",((r=e.examples)==null?void 0:r.good)||"N/A").replace("{{PROMPT_TYPE}}",n);return i&&i.wasAddressed?a=a.replace("{{#if PREVIOUS_CONTEXT}}","").replace("{{/if}}","").replace("{{PREVIOUS_PRINCIPLE}}",i.principle).replace("{{PREVIOUS_SCORE}}",i.previousScore.toString()).replace("{{CURRENT_SCORE}}",i.currentScore.toString()):a=a.replace(/\{\{#if PREVIOUS_CONTEXT\}\}[\s\S]*?\{\{\/if\}\}/g,""),{system:a,user:`Provide feedback for this prompt:

${s}`}}const St="promptcoach_iteration_context";function Qs(){return{previousScores:{},addressedPrinciples:[],skippedPrinciples:[],lastTarget:null,lastFeedback:null,lastPromptSnapshot:null,evaluationCount:0}}function G(){try{const s=sessionStorage.getItem(St);if(s)return JSON.parse(s)}catch(s){console.warn("Failed to load iteration context:",s)}return Qs()}function de(s){try{sessionStorage.setItem(St,JSON.stringify(s))}catch(e){console.error("Failed to save iteration context:",e)}}function vt(){try{sessionStorage.removeItem(St)}catch(s){console.warn("Failed to clear iteration context:",s)}}function Xe(s,e,t,n={}){var r;const i=G(),{actionableThreshold:o=null}=n,a=50;if(i.lastTarget&&i.previousScores[i.lastTarget]){const l=i.previousScores[i.lastTarget].score||0,c=((r=s[i.lastTarget])==null?void 0:r.score)||0,d=c>=l+10,p=o!==null&&c>=o;if(c>=a&&(d||p)){const u=Array.isArray(i.addressedPrinciples)?i.addressedPrinciples:[];u.includes(i.lastTarget)||u.push(i.lastTarget),i.addressedPrinciples=u}}return i.previousScores=s,i.lastTarget=e,i.lastFeedback=t,i.evaluationCount+=1,de(i),i}function Cn(s){const e=G(),t=Array.isArray(e.skippedPrinciples)?e.skippedPrinciples:[];return t.includes(s)||t.push(s),e.skippedPrinciples=t,de(e),e}function Tn(s){const e=G(),t=Array.isArray(e.skippedPrinciples)?e.skippedPrinciples:[];return e.skippedPrinciples=t.filter(n=>n!==s),de(e),e}function Xt(s,e=null){var r;const t=G();if(!t.lastTarget||!t.previousScores[t.lastTarget])return null;const n=t.previousScores[t.lastTarget].score||0,i=((r=s[t.lastTarget])==null?void 0:r.score)||0,o=i>=n+10,a=e!==null&&i>=e;return{principle:t.lastTarget,wasAddressed:o||a,previousScore:n,currentScore:i}}function qe(){return G()}function Qt(s){return s?s.trim().replace(/\s+/g," ").toLowerCase():""}function Qe(s){const e=G();return e.lastPromptSnapshot?Qt(e.lastPromptSnapshot)!==Qt(s):!0}function et(s){const e=G();e.lastPromptSnapshot=s,de(e)}let tt=null,nt=null,st=null,it=null,ot=null;const I=80;async function ei(){if(!tt)try{tt=(await Y(()=>import("./principles-Dvy7Q6Uu.js"),[],import.meta.url)).default}catch(s){throw console.error("Failed to load principles.json:",s),new Error("Coaching methodology not configured")}if(!nt)try{nt=(await Y(()=>import("./prompt-type-mapping-coQJC7RQ.js"),[],import.meta.url)).default}catch(s){throw console.error("Failed to load prompt-type-mapping.json:",s),new Error("Prompt type mapping not configured")}if(!st)try{st=(await Y(()=>import("./classify-CJInkw_M.js"),[],import.meta.url)).default}catch(s){throw console.error("Failed to load classify.md:",s),new Error("Classification prompt not configured")}if(!it)try{it=(await Y(()=>import("./score-DUP8EnJT.js"),[],import.meta.url)).default}catch(s){throw console.error("Failed to load score.md:",s),new Error("Scoring prompt not configured")}if(!ot)try{ot=(await Y(()=>import("./feedback-DmuSMAz8.js"),[],import.meta.url)).default}catch(s){throw console.error("Failed to load feedback.md:",s),new Error("Feedback prompt not configured")}return{principles:tt,promptTypeMapping:nt,templates:{classify:st,score:it,feedback:ot}}}class ti{constructor(e,t){this.providerType=e;const n=os(e);if(!n)throw new k(`Unknown provider type: ${e}`);const i=n.getRecommendedModels();this.providers={classify:_e(e,t,i.classify),score:_e(e,t,i.score),feedback:_e(e,t,i.feedback)},this.methodology=null,this.debugMode=!1}getProvider(e){return this.providers[e]||this.providers.feedback}setDebugMode(e){this.debugMode=e}async loadMethodology(){return this.methodology?this.methodology:(this.methodology=await ei(),this.methodology)}async classifyPrompt(e){const t=await this.loadMethodology(),n=Zs(e,t.templates.classify),i=Se("classify",{promptLength:e.length});try{const o=this.getProvider("classify"),a=o.getTaskConfig("classify");let r="";for await(const c of o.streamCompletion(n.user,{maxTokens:a.maxTokens,temperature:a.temperature,systemPrompt:n.system}))c.content&&(r+=c.content);const l=js(r);return V(i,l),{result:l,step:i}}catch(o){throw V(i,null,o),o}}async scorePrinciple(e,t,n,i){const o=await this.loadMethodology(),a=Gs(e,t,n,i,o.templates.score),r=this.getProvider("score"),l=r.getTaskConfig("score");let c="";for await(const d of r.streamCompletion(a.user,{maxTokens:l.maxTokens,temperature:l.temperature,systemPrompt:a.system}))d.content&&(c+=d.content);return Ws(c,t.id,i)}async scoreAllPrinciples(e,t){const n=await this.loadMethodology(),i=n.promptTypeMapping.mappings[t],o=[],a=n.principles.principles.map(p=>{const h=i.applicable.includes(p.id),u=Se(`score:${p.id}`,{principleId:p.id,isApplicable:h});return o.push(u),{fn:async()=>{const m=await this.scorePrinciple(e,p,t,h);return V(u,m),m},name:`score:${p.id}`}}),r=this.getProvider("score").getTaskConfig("score"),l=await Os(a,{maxRetries:U.maxRetries,timeoutMs:r.timeoutMs}),c={},d=[];return l.forEach((p,h)=>{const u=n.principles.principles[h];p.status==="fulfilled"?c[u.id]=p.value:(d.push(u.id),V(o[h],null,p.reason),c[u.id]={principleId:u.id,score:null,reason:"Scoring failed",applicable:!0,failed:!0})}),{scores:c,partialFailures:d,steps:o}}calculateOverallScore(e){const t=this.methodology;let n=0,i=0;return t.principles.principles.forEach(o=>{const a=e[o.id];a&&a.applicable!==!1&&!a.failed&&typeof a.score=="number"&&(i+=a.score*o.weight,n+=o.weight)}),n===0?0:Math.round(i/n)}getEligiblePrinciples(e,t){const n=this.methodology,i=[...t.addressedPrinciples,...t.skippedPrinciples];return n.principles.principles.filter(o=>!i.includes(o.id)).filter(o=>{var a;return((a=e[o.id])==null?void 0:a.applicable)!==!1}).filter(o=>{var a;return typeof((a=e[o.id])==null?void 0:a.score)=="number"}).map(o=>{var a;return{id:o.id,score:(a=e[o.id])==null?void 0:a.score,weight:o.weight}})}getActionablePrinciples(e,t){return e.filter(n=>n.score<t)}selectTargetPrinciple(e,t){var c,d,p;if(e.length===0)return null;const n=t&&((p=(d=(c=this.methodology)==null?void 0:c.promptTypeMapping)==null?void 0:d.mappings)==null?void 0:p[t]),i=(n==null?void 0:n.priority)||[],o=e.filter(h=>i.includes(h.id)),a=e.filter(h=>!i.includes(h.id)),r=(h,u)=>h.score!==u.score?h.score-u.score:u.weight-h.weight;return o.sort(r),a.sort(r),[...o,...a][0].id}async generateFeedback(e,t,n,i,o){const a=await this.loadMethodology(),r=a.principles.principles.find(p=>p.id===t);if(!r)throw new Error(`Unknown principle: ${t}`);const l=Xt(o,I),c=Jt(e,r,n,i,l,a.templates.feedback),d=Se("feedback",{targetPrinciple:t,score:n,hasPreviousContext:!!l});try{const p=this.getProvider("feedback"),h=p.getTaskConfig("feedback");let u="";for await(const f of p.streamCompletion(c.user,{maxTokens:h.maxTokens,temperature:h.temperature,systemPrompt:c.system}))f.content&&(u+=f.content);const m=Pe(u);return l!=null&&l.wasAddressed&&m.acknowledgment&&(m.feedback=`${m.acknowledgment}

${m.feedback}`),V(d,m),{result:m,step:d}}catch(p){throw V(d,null,p),p}}generateDescription(e,t){return t||(e>=80?"Great prompt — meets quality threshold.":e>=60?"Decent prompt — some improvements needed.":e>=40?"Fair prompt — significant room for improvement.":e>=20?"Weak prompt — fundamental improvements needed.":"Very weak prompt — needs substantial work.")}blendScores(e,t){const i=qe().previousScores;if(!i||Object.keys(i).length===0)return;const a=Qe(t)?.85:.7,r=1-a;Object.keys(e).forEach(l=>{const c=e[l],d=i[l];if(c&&typeof c.score=="number"&&c.applicable!==!1&&d&&typeof d.score=="number"){const p=Math.round(a*c.score+r*d.score);c.score=p}})}async evaluate(e,t={}){var a;const{debugMode:n=this.debugMode}=t,i=performance.now(),o=[];try{await this.loadMethodology();const{result:r,step:l}=await this.classifyPrompt(e);o.push(l);const c=r.type,{scores:d,partialFailures:p,steps:h}=await this.scoreAllPrinciples(e,c);o.push(...h);const u=Object.values(d).filter(P=>P.applicable!==!1);if(u.filter(P=>typeof P.score=="number"&&!P.failed).length===0&&u.length>0)throw new Error(`Scoring failed for all ${u.length} applicable principles. The coach model may not be returning valid responses.`);if(Qe(e)){const P=G();P.addressedPrinciples=[],P.skippedPrinciples=[],de(P)}this.blendScores(d,e);const f={};Object.entries(d).forEach(([P,Q])=>{f[P]={score:Q.score,reason:Q.reason}});const b=this.calculateOverallScore(d),y=qe(),g=this.getEligiblePrinciples(d,y),x=this.getActionablePrinciples(g,I),S=x.length>0,C=y.skippedPrinciples||[],T=!S&&C.length>0,E=b>=I?"overall_threshold":S?"needs_improvement":"no_actionable_items",B=E!=="needs_improvement";let N=null,L="",_=null,re=null;if(B)if(E==="no_actionable_items")if(T){const P=C.length;L=`All addressed principles meet the quality threshold. However, ${P} principle${P>1?"s were":" was"} skipped during coaching. You can reintroduce skipped items to continue improving your prompt and potentially raise the overall score.`}else L="All applicable principles have been addressed. No further changes are needed.";else L="**Congratulations!** Your prompt scores above 80 overall. You've applied the key prompting principles effectively. Feel free to continue refining or start a new prompt!";else if(N=this.selectTargetPrinciple(x,c),N){const P=((a=d[N])==null?void 0:a.score)||0,{result:Q,step:ae}=await this.generateFeedback(e,N,P,c,f);L=Q.feedback,_=Q.summary||null,re=ae,o.push(re)}let X=this.generateDescription(b,_);if(E==="no_actionable_items")if(T){const P=C.length;X=b>=I?`Good score, but ${P} skipped principle${P>1?"s":""} could improve it further.`:`Addressed principles look good. ${P} skipped — reintroduce to raise overall score.`}else X="All applicable principles addressed.";Xe(f,N,L,{actionableThreshold:I}),et(e);const R=Math.round(performance.now()-i),Z={promptType:c,scores:Object.values(d),overall:b,description:X,feedback:L,targetPrinciple:N,complete:B,completionReason:E,canReintroduceSkipped:T,skippedPrinciples:C,actionableThreshold:I,partialFailures:p.length>0?p:void 0};return n&&(Z._debug={steps:o,totalDurationMs:R,classification:r}),await Le(this.getProviderName(),this.getModelName(),JSON.stringify(Z).length,null,R),Z}catch(r){const l=Math.round(performance.now()-i);throw await fe(this.getProviderName(),this.getModelName(),r.message||"Unknown error",l),r}}async*evaluateStreaming(e,t={}){var l,c;const{debugMode:n=this.debugMode,attachmentContext:i="",attachmentsTruncated:o=!1}=t,a=performance.now(),r=[];try{let d=e;i&&(d=`[ATTACHED CONTEXT${o?" (truncated)":""}]
${i}
[END ATTACHED CONTEXT]

${e}`),await this.loadMethodology();const{result:p,step:h}=await this.classifyPrompt(d);r.push(h);const u=p.type,{scores:m,partialFailures:f,steps:b}=await this.scoreAllPrinciples(d,u);r.push(...b);const y=Object.values(m).filter(w=>w.applicable!==!1);if(y.filter(w=>typeof w.score=="number"&&!w.failed).length===0&&y.length>0)throw new Error(`Scoring failed for all ${y.length} applicable principles. The coach model may not be returning valid responses.`);if(Qe(e)){const w=G();w.addressedPrinciples=[],w.skippedPrinciples=[],de(w)}this.blendScores(m,e);const x={};Object.entries(m).forEach(([w,z])=>{x[w]={score:z.score,reason:z.reason}});const S=this.calculateOverallScore(m);let C=this.generateDescription(S);const T=qe(),E=this.getEligiblePrinciples(m,T),B=this.getActionablePrinciples(E,I),N=B.length>0,L=T.skippedPrinciples||[],_=!N&&L.length>0,re=S>=I?"overall_threshold":N?"needs_improvement":"no_actionable_items",X=re!=="needs_improvement",R=X?null:this.selectTargetPrinciple(B,u);if(X||!R){let w="";if(re==="no_actionable_items")if(_){const H=L.length;w=`All addressed principles meet the quality threshold. However, ${H} principle${H>1?"s were":" was"} skipped during coaching. You can reintroduce skipped items to continue improving your prompt and potentially raise the overall score.`,C=S>=I?`Good score, but ${H} skipped principle${H>1?"s":""} could improve it further.`:`Addressed principles look good. ${H} skipped — reintroduce to raise overall score.`}else w="All applicable principles have been addressed. No further changes are needed.",C="All applicable principles addressed.";else w="**Congratulations!** Your prompt scores above 80 overall. You have effectively applied the key prompting principles.";Xe(x,R,w,{actionableThreshold:I}),et(e);const z=Math.round(performance.now()-a),ee={promptType:u,scores:Object.values(m),overall:S,description:C,feedback:w,targetPrinciple:R,complete:X,completionReason:re,canReintroduceSkipped:_,skippedPrinciples:L,actionableThreshold:I,partialFailures:f.length>0?f:void 0};n&&(ee._debug={steps:r,totalDurationMs:z}),await Le(this.getProviderName(),this.getModelName(),JSON.stringify(ee).length,null,z),yield{type:"complete",result:ee};return}const Z=Xt(x,I),P=await this.loadMethodology(),Q=P.principles.principles.find(w=>w.id===R),ae=Jt(d,Q,((l=m[R])==null?void 0:l.score)||0,u,Z,P.templates.feedback),Ge=Se("feedback",{targetPrinciple:R,score:((c=m[R])==null?void 0:c.score)||0,hasPreviousContext:!!Z});r.push(Ge);const Ve=this.getProvider("feedback"),Ce=Ve.getTaskConfig("feedback");let Pt="";try{for await(const H of Ve.streamCompletion(ae.user,{maxTokens:Ce.maxTokens,temperature:Ce.temperature,systemPrompt:ae.system}))H.content&&(Pt+=H.content,yield{type:"chunk",content:H.content});let w;try{w=Pe(Pt)}catch(H){let At="";try{for await(const Te of Ve.streamCompletion(ae.user,{maxTokens:Ce.maxTokens,temperature:Ce.temperature,systemPrompt:ae.system}))Te.content&&(At+=Te.content);w=Pe(At)}catch(Te){console.warn("CoachAgent: feedback tool failed twice, using fallback message",H,Te);const En=JSON.stringify({feedback:"The coach had trouble formatting its suggestions this time. Try running Coach again or slightly rephrasing your prompt.",suggestedChange:"Retry the evaluation; if the issue persists, check your connection or API configuration.",summary:"Coach response formatting issue"});w=Pe(En)}}Z!=null&&Z.wasAddressed&&w.acknowledgment&&(w.feedback=`${w.acknowledgment}

${w.feedback}`),V(Ge,w),Xe(x,R,w.feedback,{actionableThreshold:I}),et(e),C=this.generateDescription(S,w.summary);const z=Math.round(performance.now()-a),ee={promptType:u,scores:Object.values(m),overall:S,description:C,feedback:w.feedback,targetPrinciple:R,complete:!1,completionReason:"needs_improvement",canReintroduceSkipped:!1,skippedPrinciples:L,actionableThreshold:I,partialFailures:f.length>0?f:void 0};n&&(ee._debug={steps:r,totalDurationMs:z}),await Le(this.getProviderName(),this.getModelName(),JSON.stringify(ee).length,null,z),yield{type:"complete",result:ee}}catch(w){V(Ge,null,w);const z=Math.round(performance.now()-a);throw await fe(this.getProviderName(),this.getModelName(),w.message||"Unknown error",z),w}}catch(d){const p=Math.round(performance.now()-a);throw await fe(this.getProviderName(),this.getModelName(),d.message||"Unknown error",p),d}}async evaluateWithRetry(e,t={}){try{return await this.evaluate(e,t)}catch(n){if(n instanceof k)throw n;console.warn("CoachV3: First attempt failed, retrying...",n.message);try{return await this.evaluate(e,t)}catch(i){throw console.error("CoachV3: Retry also failed",i.message),new Error("Coach couldn't evaluate. Try again.")}}}skipPrinciple(e){Cn(e)}unskipPrinciple(e){Tn(e)}clearContext(){vt()}getProviderName(){return this.getProvider("feedback").getProviderName()}getModelName(){return this.getProvider("feedback").getModelName()}getModelNames(){return{classify:this.getProvider("classify").getModelName(),score:this.getProvider("score").getModelName(),feedback:this.getProvider("feedback").getModelName()}}}function ie(s){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return s.replace(/[&<>"']/g,t=>e[t])}function Fe(s,e,t,n){const i=[];let o=e;for(;o<s.length;){const a=s[o];if(a.trim()==="")break;const r=a.match(/^(\s*)/);if((r?r[1].length:0)<t&&i.length>0)break;const c=a.match(/^(\s*)[\*\-]\s+(.+)$/),d=a.match(/^(\s*)\d+\.\s+(.+)$/);if(c&&c[1].length===t){const h={content:c[2],children:null,childType:null};if(o+1<s.length){const u=s[o+1],m=u.match(/^(\s*)/),f=m?m[1].length:0,b=u.match(/^(\s*)[\*\-]\s+/),y=u.match(/^(\s*)\d+\.\s+/);if((b||y)&&f>t){const g=b?"ul":"ol",x=Fe(s,o+1,f);h.children=x.items,h.childType=g,o=x.endIdx}else o++}else o++;i.push(h)}else if(d&&d[1].length===t){const h={content:d[2],children:null,childType:null};if(o+1<s.length){const u=s[o+1],m=u.match(/^(\s*)/),f=m?m[1].length:0,b=u.match(/^(\s*)[\*\-]\s+/),y=u.match(/^(\s*)\d+\.\s+/);if((b||y)&&f>t){const g=b?"ul":"ol",x=Fe(s,o+1,f);h.children=x.items,h.childType=g,o=x.endIdx}else o++}else o++;i.push(h)}else if((c||d)&&(c?c[1].length:d[1].length)>t){const p=c?c[1].length:d[1].length,h=c?"ul":"ol",u=Fe(s,o,p);i.length>0&&(i[i.length-1].children=u.items,i[i.length-1].childType=h),o=u.endIdx}else break}return{items:i,endIdx:o}}function kn(s,e){const t=e,n=s.map(i=>{let o=`<li>${ce(ie(i.content))}`;return i.children&&i.children.length>0&&(o+=kn(i.children,i.childType||e)),o+="</li>",o}).join("");return`<${t}>${n}</${t}>`}function ni(s,e){if(e>=s.length)return null;const t=s[e];if(!t.includes("|"))return null;const n=t.split("|").map(r=>r.trim()).filter(r=>r);if(e+1>=s.length||!s[e+1].match(/^\|?[\s\-:|]+\|?$/))return null;const o=[];let a=e+2;for(;a<s.length;){const r=s[a];if(!r.includes("|")||r.trim()==="")break;const l=r.split("|").map(c=>c.trim()).filter(c=>c!=="");o.push(l),a++}return{table:{headers:n,rows:o},endIdx:a}}function J(s){if(!s||typeof s!="string")return"";const e=s.split(`
`),t=[];let n=[],i=!1,o="",a=0,r=[];for(let c=0;c<e.length;c++){const d=e[c],p=d.trim();if(p.startsWith("```"))if(i)if(p.length>3){a++,n.push(d);continue}else if(a>0){a--,n.push(d);continue}else{t.push({type:"code",lang:o,content:n.join(`
`)}),n=[],i=!1,o="";continue}else{n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),r.length>0&&(t.push({type:"blockquote",content:r.join(`
`)}),r=[]),i=!0,o=p.slice(3).trim(),a=0;continue}if(i){n.push(d);continue}const u=d.match(/^(#{1,6})\s+(.+)$/);if(u){n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),r.length>0&&(t.push({type:"blockquote",content:r.join(`
`)}),r=[]),t.push({type:"header",level:u[1].length,content:u[2]});continue}if(d.includes("|")&&c+1<e.length&&e[c+1].match(/^\|?[\s\-:|]+\|?$/)){n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),r.length>0&&(t.push({type:"blockquote",content:r.join(`
`)}),r=[]);const y=ni(e,c);if(y){t.push({type:"table",...y.table}),c=y.endIdx-1;continue}}const m=d.match(/^(\s*)[\*\-]\s+(.+)$/),f=d.match(/^(\s*)\d+\.\s+(.+)$/);if(m||f){n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),r.length>0&&(t.push({type:"blockquote",content:r.join(`
`)}),r=[]);const y=m?m[1].length:f[1].length,g=m?"ul":"ol",x=Fe(e,c,y);t.push({type:"list",listType:g,items:x.items}),c=x.endIdx-1;continue}if(d.match(/^---+$/)){n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),r.length>0&&(t.push({type:"blockquote",content:r.join(`
`)}),r=[]),t.push({type:"hr"});continue}const b=d.match(/^>\s*(.*)$/);if(b){n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),r.push(b[1]);continue}if(r.length>0&&(t.push({type:"blockquote",content:r.join(`
`)}),r=[]),d.trim()===""){n.length>0&&(t.push({type:"paragraph",content:n.join(`
`)}),n=[]),t.push({type:"empty"});continue}n.push(d)}return r.length>0&&t.push({type:"blockquote",content:r.join(`
`)}),n.length>0&&t.push({type:"paragraph",content:n.join(`
`)}),t.map(c=>{switch(c.type){case"header":return`<h${c.level}>${ce(ie(c.content))}</h${c.level}>`;case"paragraph":const d=ce(ie(c.content));return d?`<p>${d}</p>`:"";case"empty":return'<p class="empty-line">&nbsp;</p>';case"list":return kn(c.items,c.listType);case"table":return si(c.headers,c.rows);case"code":return`<pre><code class="language-${c.lang}">${ie(c.content)}</code></pre>`;case"blockquote":return`<blockquote>${ce(ie(c.content))}</blockquote>`;case"hr":return"<hr>";default:return""}}).filter(Boolean).join("")}function si(s,e){const t=s.map(i=>`<th>${ce(ie(i))}</th>`).join(""),n=e.map(i=>`<tr>${i.map(a=>`<td>${ce(ie(a))}</td>`).join("")}</tr>`).join("");return`<table><thead><tr>${t}</tr></thead><tbody>${n}</tbody></table>`}function ce(s){let e=s;return e=e.replace(/`([^`]+)`/g,"<code>$1</code>"),e=e.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>"),e=e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.+?)\*/g,"<em>$1</em>"),e=e.replace(/___(.+?)___/g,"<strong><em>$1</em></strong>"),e=e.replace(/__(.+?)__/g,"<strong>$1</strong>"),e=e.replace(/_(.+?)_/g,"<em>$1</em>"),e=e.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1" style="max-width: 100%;">'),e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>'),e}let Ae=null;async function ii(){if(Ae)return Ae;try{return Ae=(await Y(()=>import("./principles-Dvy7Q6Uu.js"),[],import.meta.url)).default,Ae}catch(s){return console.warn("Could not load principles for tooltips:",s),null}}function oi(s){return s?s.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):""}class ri{constructor(e={}){this.element=null,this.backdrop=null,this.contentEl=null,this.feedbackEntry=null,this.isVisible=!1,this.isPinned=!1,this.isLoading=!1,this.isStreaming=!1,this.streamedText="",this.rawBuffer="",this.inFeedbackField=!1,this.feedbackFieldComplete=!1,this.ratio=.3,this.onClose=e.onClose||null,this.onPin=e.onPin||null,this.onSkipContinue=e.onSkipContinue||null,this.onReintroduceSkipped=e.onReintroduceSkipped||null,this.skipBtn=null,this.reintroduceBtn=null,this.gotItBtn=null,this.streamingContainer=null}render(){this.backdrop=document.createElement("div"),this.backdrop.className="feedback-backdrop",this.backdrop.style.cssText=`
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      pointer-events: none;
      transition: opacity 200ms ease;
      z-index: calc(var(--pc-z-overlay, 300) - 2);
    `,this.backdrop.addEventListener("click",()=>this.hide()),this.element=document.createElement("div"),this.element.className="feedback-panel",this.element.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      max-height: 60vh;
      background: var(--pc-surface);
      border-bottom: 1px solid var(--pc-outline-variant);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-100%);
      transition: transform 300ms ease-out;
      z-index: calc(var(--pc-z-overlay, 300) - 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    `;const e=this.createHeader();this.element.appendChild(e),this.contentEl=document.createElement("div"),this.contentEl.className="feedback-content",this.contentEl.style.cssText=`
      flex: 1;
      overflow-y: auto;
      padding: var(--pc-space-4);
    `,this.element.appendChild(this.contentEl);const t=this.createFooter();return this.element.appendChild(t),this.divider=this.createDivider(),this.element.appendChild(this.divider),this.loadPersistedState(),this.element}createDivider(){const e=document.createElement("div");e.className="feedback-divider",e.style.cssText=`
      display: none;
      position: absolute;
      bottom: -12px;
      left: 0;
      right: 0;
      height: 24px;
      cursor: ns-resize;
      background: transparent;
      z-index: 10;
    `;const t=document.createElement("div");t.style.cssText=`
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 64px;
      height: 6px;
      background: var(--pc-outline);
      border-radius: 3px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    `,e.appendChild(t);let n=!1,i=0,o=0;const a=c=>{n=!0,i=c.clientY,o=this.ratio,document.body.style.cursor="ns-resize",document.body.style.userSelect="none",c.preventDefault()},r=c=>{if(!n)return;const p=(c.clientY-i)/window.innerHeight;this.setRatio(o+p)},l=()=>{n&&(n=!1,document.body.style.cursor="",document.body.style.userSelect="")};return e.addEventListener("mousedown",a),document.addEventListener("mousemove",r),document.addEventListener("mouseup",l),e.addEventListener("touchstart",c=>{n=!0,i=c.touches[0].clientY,o=this.ratio,c.preventDefault()}),document.addEventListener("touchmove",c=>{if(!n)return;const p=(c.touches[0].clientY-i)/window.innerHeight;this.setRatio(o+p)}),document.addEventListener("touchend",()=>{n=!1}),e}createHeader(){const e=document.createElement("div");e.className="feedback-header",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--pc-space-3) var(--pc-space-4);
      border-bottom: 1px solid var(--pc-outline-variant);
      background: var(--pc-surface-container);
    `;const t=document.createElement("h3");t.className="text-title",t.style.cssText="margin: 0; font-size: 1rem;",t.textContent="Coach Feedback",e.appendChild(t);const n=document.createElement("div");n.style.cssText="display: flex; gap: var(--pc-space-2);",this.pinBtn=document.createElement("button"),this.pinBtn.className="icon-btn",this.pinBtn.setAttribute("aria-label","Pin panel"),this.pinBtn.style.cssText=`
      background: none;
      border: none;
      padding: var(--pc-space-2);
      cursor: pointer;
      color: var(--pc-on-surface-variant);
      border-radius: var(--pc-radius-full);
      transition: background 150ms ease;
    `,this.pinBtn.innerHTML=`
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M16 12V4h1V2H7v2h1v8l-2 2v2h5.2v6h1.6v-6H18v-2l-2-2z"/>
      </svg>
    `,this.pinBtn.addEventListener("click",()=>this.togglePin()),n.appendChild(this.pinBtn);const i=document.createElement("button");return i.className="icon-btn",i.setAttribute("aria-label","Close panel"),i.style.cssText=this.pinBtn.style.cssText,i.innerHTML=`
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    `,i.addEventListener("click",()=>this.hide(!0)),n.appendChild(i),e.appendChild(n),e}createFooter(){const e=document.createElement("div");return e.className="feedback-footer",e.style.cssText=`
      padding: var(--pc-space-3) var(--pc-space-4);
      border-top: 1px solid var(--pc-outline-variant);
      display: flex;
      justify-content: flex-end;
      gap: var(--pc-space-2);
    `,this.skipBtn=document.createElement("button"),this.skipBtn.className="btn btn-outlined skip-continue-btn",this.skipBtn.textContent="Skip & Continue",this.skipBtn.style.cssText=`
      padding: var(--pc-space-2) var(--pc-space-4);
      background: transparent;
      color: var(--pc-primary);
      border: 1px solid var(--pc-outline);
      border-radius: var(--pc-radius-md);
      font-weight: 500;
      cursor: pointer;
      transition: background 150ms ease, opacity 150ms ease;
    `,this.skipBtn.addEventListener("click",()=>this.handleSkipContinue()),e.appendChild(this.skipBtn),this.reintroduceBtn=document.createElement("button"),this.reintroduceBtn.className="btn btn-outlined reintroduce-skipped-btn",this.reintroduceBtn.textContent="Reintroduce Skipped Items",this.reintroduceBtn.style.cssText=`
      padding: var(--pc-space-2) var(--pc-space-4);
      background: transparent;
      color: var(--pc-primary);
      border: 1px solid var(--pc-outline);
      border-radius: var(--pc-radius-md);
      font-weight: 500;
      cursor: pointer;
      transition: background 150ms ease, opacity 150ms ease;
      display: none;
    `,this.reintroduceBtn.addEventListener("click",()=>this.handleReintroduceSkipped()),e.appendChild(this.reintroduceBtn),this.gotItBtn=document.createElement("button"),this.gotItBtn.className="btn btn-filled",this.gotItBtn.textContent="Got It",this.gotItBtn.style.cssText=`
      padding: var(--pc-space-2) var(--pc-space-4);
      background: var(--pc-primary);
      color: var(--pc-on-primary);
      border: none;
      border-radius: var(--pc-radius-md);
      font-weight: 500;
      cursor: pointer;
    `,this.gotItBtn.addEventListener("click",()=>this.handleGotItClick()),e.appendChild(this.gotItBtn),e}handleGotItClick(){this.hide(!0)}handleSkipContinue(){if(this.isLoading||!this.feedbackEntry)return;const e=this.feedbackEntry.targetPrinciple;if(!e){console.warn("No targetPrinciple to skip");return}this.skipPromptSnapshot=this.feedbackEntry.promptSnapshot,Cn(e),Nn(e),this.setLoading(!0),this.onSkipContinue&&this.onSkipContinue(e),this.element.dispatchEvent(new CustomEvent("skip-continue",{bubbles:!0,detail:{principleId:e}}))}handleReintroduceSkipped(){if(this.isLoading||!this.feedbackEntry)return;const e=this.feedbackEntry.skippedPrinciples||[];if(e.length===0){console.warn("No skipped principles to reintroduce");return}this.setLoading(!0),this.onReintroduceSkipped&&this.onReintroduceSkipped({skippedPrinciples:e,scores:this.feedbackEntry.scores||[]}),this.element.dispatchEvent(new CustomEvent("reintroduce-skipped",{bubbles:!0,detail:{skippedPrinciples:e}}))}hasPromptChangedDuringSkip(e){return this.isLoading&&this.skipPromptSnapshot&&this.skipPromptSnapshot!==e}cancelSkipIfPromptChanged(e){return this.hasPromptChangedDuringSkip(e)?(this.setLoading(!1),this.skipPromptSnapshot=null,!0):!1}setLoading(e){this.isLoading=e,this.skipBtn&&(this.skipBtn.disabled=e,this.skipBtn.textContent=e?"Loading...":"Skip & Continue",this.skipBtn.style.opacity=e?"0.6":"1"),this.reintroduceBtn&&(this.reintroduceBtn.disabled=e,this.reintroduceBtn.style.opacity=e?"0.6":"1"),this.gotItBtn&&(this.gotItBtn.disabled=e,this.gotItBtn.style.opacity=e?"0.6":"1")}showStreaming(e={}){this.isStreaming=!0,this.streamedText="",this.rawBuffer="",this.inFeedbackField=!1,this.feedbackFieldComplete=!1,this.feedbackEntry=e,this.isPinned&&(this.isPinned=!1,this.pinBtn.style.color="var(--pc-on-surface-variant)",ne("feedbackPanelPinned",!1),this.divider&&(this.divider.style.display="none"),this.onPin&&this.onPin(!1)),this.renderStreamingContent(),this.updateFooterForStreaming(!0),this.element.style.position="fixed",this.element.style.top="0",this.element.style.left="0",this.element.style.right="0",this.element.style.maxHeight="60vh",this.element.style.borderBottom="1px solid var(--pc-outline-variant)",this.element.style.transform="translateY(0)",this.backdrop.style.display="block",this.backdrop.style.opacity="1",this.backdrop.style.pointerEvents="auto",this.isVisible=!0}appendStreamingChunk(e){if(!this.isStreaming||this.feedbackFieldComplete)return;this.rawBuffer+=e;const t=this._extractFeedbackText();this.streamingContainer&&t&&(this.streamingContainer.textContent=t,this.streamingContainer.scrollTop=this.streamingContainer.scrollHeight)}_extractFeedbackText(){const e=this.rawBuffer;if(!this.inFeedbackField){const t=e.match(/"feedback"\s*:\s*"/);if(t){this.inFeedbackField=!0;const n=t.index+t[0].length;this.feedbackStartIndex=n}}if(this.inFeedbackField){let t=e.slice(this.feedbackStartIndex),n=-1,i=0;for(;i<t.length;){if(t[i]==="\\"&&i+1<t.length){i+=2;continue}if(t[i]==='"'){n=i,this.feedbackFieldComplete=!0;break}i++}n!==-1&&(t=t.slice(0,n));try{t=JSON.parse('"'+t.replace(/"/g,'\\"')+'"')}catch{t=t.replace(/\\n/g,`
`).replace(/\\t/g,"	").replace(/\\"/g,'"').replace(/\\\\/g,"\\")}return this.streamedText=t,t}return""}finalizeStreaming(e){this.isStreaming=!1,this.streamedText="",this.feedbackEntry=e,this.setLoading(!1),this.renderContent(e),this.updateFooterForComplete(e),this.updateFooterForStreaming(!1)}renderStreamingContent(){this.contentEl.innerHTML="";const e=document.createElement("div");e.className="feedback-summary",e.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-3);
      margin-bottom: var(--pc-space-4);
      padding: var(--pc-space-3);
      background: var(--pc-surface-container);
      border-radius: var(--pc-radius-md);
    `;const t=document.createElement("div");if(t.style.cssText=`
      min-width: 48px;
      width: 48px;
      height: 48px;
      flex-shrink: 0;
      border-radius: 50%;
      background: var(--pc-outline);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    `,!document.getElementById("feedback-spinner-styles")){const r=document.createElement("style");r.id="feedback-spinner-styles",r.textContent=`
        @keyframes feedback-spinner-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .feedback-spinner-ring {
          position: absolute;
          inset: -3px;
          border-radius: 50%;
          border: 2px solid var(--pc-outline-variant);
          border-top-color: var(--pc-primary);
          animation: feedback-spinner-rotate 0.8s linear infinite;
          pointer-events: none;
        }
      `,document.head.appendChild(r)}const n=document.createElement("div");n.className="feedback-spinner-ring",t.appendChild(n),e.appendChild(t);const i=document.createElement("div");i.style.cssText="flex: 1;";const o=document.createElement("div");o.className="text-label",o.style.cssText="color: var(--pc-on-surface-variant); margin-bottom: 2px;",o.textContent="Analyzing prompt...",i.appendChild(o);const a=document.createElement("div");a.className="text-body",a.style.cssText="color: var(--pc-on-surface-variant);",a.textContent="Evaluating against methodology principles",i.appendChild(a),e.appendChild(i),this.contentEl.appendChild(e),this.streamingContainer=document.createElement("div"),this.streamingContainer.className="feedback-streaming-text",this.streamingContainer.style.cssText=`
      line-height: 1.6;
      color: var(--pc-on-surface);
      white-space: pre-wrap;
      word-break: break-word;
    `,this.contentEl.appendChild(this.streamingContainer)}updateFooterForStreaming(e){this.skipBtn&&(this.skipBtn.disabled=e,this.skipBtn.style.opacity=e?"0.5":"1",e&&(this.skipBtn.style.display="none")),this.reintroduceBtn&&(this.reintroduceBtn.disabled=e,this.reintroduceBtn.style.opacity=e?"0.5":"1",e&&(this.reintroduceBtn.style.display="none")),this.gotItBtn&&(this.gotItBtn.disabled=e,this.gotItBtn.style.opacity=e?"0.5":"1",this.gotItBtn.textContent=e?"Analyzing...":"Got It")}show(e){this.feedbackEntry=e,this.isStreaming=!1,this.setLoading(!1),this.isPinned&&(this.isPinned=!1,this.pinBtn.style.color="var(--pc-on-surface-variant)",ne("feedbackPanelPinned",!1),this.divider&&(this.divider.style.display="none"),this.onPin&&this.onPin(!1)),this.renderContent(e),this.updateFooterForComplete(e),this.element.style.position="fixed",this.element.style.top="0",this.element.style.left="0",this.element.style.right="0",this.element.style.maxHeight="60vh",this.element.style.borderBottom="1px solid var(--pc-outline-variant)",this.element.style.transform="translateY(0)",this.backdrop.style.display="block",this.backdrop.style.opacity="1",this.backdrop.style.pointerEvents="auto",this.isVisible=!0}updateFooterForComplete(e){const t=(e==null?void 0:e.complete)===!0,n=(e==null?void 0:e.isHistorical)===!0,i=(e==null?void 0:e.canReintroduceSkipped)===!0,o=(e==null?void 0:e.completionReason)||null,a=!!(e!=null&&e.targetPrinciple);if(this.skipBtn&&(this.skipBtn.style.display=t||n||!a?"none":"block"),this.reintroduceBtn){const r=!n&&o==="no_actionable_items"&&i;this.reintroduceBtn.style.display=r?"block":"none"}this.gotItBtn&&(this.gotItBtn.textContent=t&&!n?"Continue Editing":"Got It")}hide(e=!1){this.isVisible&&(this.isPinned&&e&&(this.isPinned=!1,this.pinBtn.style.color="var(--pc-on-surface-variant)",ne("feedbackPanelPinned",!1),this.divider&&(this.divider.style.display="none"),this.element.style.position="fixed",this.element.style.top="0",this.element.style.left="0",this.element.style.right="0",this.element.style.maxHeight="60vh",this.element.style.borderBottom="1px solid var(--pc-outline-variant)",this.onPin&&this.onPin(!1)),this.backdrop.style.display="block",this.backdrop.style.opacity="0",this.backdrop.style.pointerEvents="none",(!this.isPinned||e)&&(this.element.style.transform="translateY(-100%)"),this.isVisible=!1,this.isStreaming=!1,this.streamedText="",this.rawBuffer="",this.inFeedbackField=!1,this.feedbackFieldComplete=!1,this.onClose&&this.onClose())}renderContent(e){this.contentEl.innerHTML="";const t=e.complete===!0,n=document.createElement("div");n.className="feedback-summary",n.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-3);
      margin-bottom: var(--pc-space-4);
      padding: var(--pc-space-3);
      background: ${t?"var(--pc-primary-container)":"var(--pc-surface-container)"};
      border-radius: var(--pc-radius-md);
      ${t?"border: 1px solid var(--pc-outline-variant);":""}
    `;const i=e.overall,o=i>=80?"#22C55E":i>=60?"#F59E0B":"#EF4444",a=document.createElement("div");a.style.cssText=`
      min-width: 48px;
      width: 48px;
      height: 48px;
      flex-shrink: 0;
      border-radius: 50%;
      background: ${o};
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    `,a.textContent=i,n.appendChild(a);const r=document.createElement("div");r.style.cssText="flex: 1;";const l=document.createElement("div");l.className="text-label",l.style.cssText=`color: ${t?"var(--pc-primary)":"var(--pc-on-surface-variant)"}; margin-bottom: 2px; font-weight: ${t?"600":"400"};`,l.textContent=t?"Coaching Complete":"Overall Assessment",r.appendChild(l);const c=document.createElement("div");c.className="text-body",c.textContent=e.description,r.appendChild(c),n.appendChild(r),this.contentEl.appendChild(n);const d=document.createElement("div");if(d.className="feedback-text markdown-content",d.style.cssText=`
      line-height: 1.6;
      color: var(--pc-on-surface);
    `,d.innerHTML=J(e.feedback),this._applyMarkdownStyles(d),this.contentEl.appendChild(d),e.scores&&e.scores.length>0){const p=document.createElement("div");p.style.cssText="margin-top: var(--pc-space-4);";const h=document.createElement("button");h.setAttribute("aria-expanded","false"),h.style.cssText=`
        display: flex;
        align-items: center;
        gap: var(--pc-space-2);
        width: 100%;
        padding: var(--pc-space-2) 0;
        background: transparent;
        border: none;
        cursor: pointer;
        text-align: left;
        font-family: inherit;
        font-size: inherit;
        color: var(--pc-primary);
        font-weight: 500;
      `;const u=document.createElement("span");u.textContent="View all principle scores",h.appendChild(u);const m=document.createElement("span");m.className="collapse-chevron",m.innerHTML=q("chevronDown",20),m.style.cssText="display:flex;transition:transform 0.2s ease;transform:rotate(-90deg);margin-left:auto;",h.appendChild(m),p.appendChild(h);const f=document.createElement("div");f.style.cssText=`
        display: none;
        flex-direction: column;
        gap: var(--pc-space-2);
        margin-top: var(--pc-space-2);
      `,h.addEventListener("click",()=>{const b=h.getAttribute("aria-expanded")==="true";h.setAttribute("aria-expanded",(!b).toString()),f.style.display=b?"none":"flex",m.style.transform=b?"rotate(-90deg)":"rotate(0deg)"}),ii().then(b=>{const y=b?Object.fromEntries(b.principles.map(g=>[g.id,g])):{};e.scores.forEach(g=>{const x=g.principle||g.principleId,S=y[x],C=document.createElement("div");C.style.cssText=`
            display: flex;
            flex-direction: column;
            padding: var(--pc-space-2);
            background: var(--pc-surface-container);
            border-radius: var(--pc-radius-sm);
            ${g.applicable===!1?"opacity: 0.6;":""}
          `,S&&(C.title=S.description);const T=document.createElement("div");T.style.cssText=`
            display: flex;
            justify-content: space-between;
            align-items: center;
          `;const E=document.createElement("span");E.style.cssText="font-weight: 500;",E.textContent=S?S.name:oi(x),T.appendChild(E);const B=document.createElement("span"),N=g.applicable===!1||g.score===null||g.score===void 0,L=N?"#9CA3AF":g.score>=80?"#22C55E":g.score>=60?"#F59E0B":"#EF4444";if(B.style.cssText=`
            font-weight: ${N?"400":"600"};
            color: ${L};
            min-width: 32px;
            text-align: right;
            ${N?"font-style: italic;":""}
          `,B.textContent=N?"N/A":g.score,T.appendChild(B),C.appendChild(T),g.reason){const _=document.createElement("div");_.style.cssText=`
              font-size: 0.8rem;
              color: var(--pc-on-surface-variant);
              margin-top: 4px;
            `,_.textContent=g.reason,C.appendChild(_)}f.appendChild(C)})}),p.appendChild(f),this.contentEl.appendChild(p)}}togglePin(){this.setPinned(!this.isPinned)}setPinned(e){this.isPinned=e,this.pinBtn.style.color=e?"var(--pc-primary)":"var(--pc-on-surface-variant)",e?(this.element.style.position="relative",this.element.style.transform="none",this.element.style.maxHeight=`${this.ratio*100}vh`,this.element.style.borderBottom="3px solid var(--pc-primary)",this.backdrop.style.display="none",this.divider&&(this.divider.style.display="block")):(this.element.style.position="fixed",this.element.style.transform=this.isVisible?"translateY(0)":"translateY(-100%)",this.element.style.maxHeight="60vh",this.element.style.borderBottom="1px solid var(--pc-outline-variant)",this.backdrop.style.display="block",this.divider&&(this.divider.style.display="none")),ne("feedbackPanelPinned",e),this.onPin&&this.onPin(e)}setRatio(e){this.ratio=Math.max(.15,Math.min(.7,e)),this.isPinned&&(this.element.style.maxHeight=`${this.ratio*100}vh`),ne("feedbackPanelRatio",this.ratio)}loadPersistedState(){const e=Ze();this.isPinned=e.feedbackPanelPinned||!1,this.ratio=e.feedbackPanelRatio||.3,this.isPinned&&(this.pinBtn.style.color="var(--pc-primary)")}getBackdrop(){return this.backdrop}_applyMarkdownStyles(e){e.querySelectorAll("p").forEach(t=>{t.style.cssText="margin: 0 0 var(--pc-space-2) 0;"}),e.querySelectorAll("ul, ol").forEach(t=>{t.style.cssText="margin: 0 0 var(--pc-space-2) 0; padding-left: 1.5em;"}),e.querySelectorAll("li").forEach(t=>{t.style.cssText="margin-bottom: var(--pc-space-1);"}),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(t=>{t.style.cssText="margin: var(--pc-space-3) 0 var(--pc-space-2) 0;"}),e.querySelectorAll("code").forEach(t=>{var n;((n=t.parentElement)==null?void 0:n.tagName)!=="PRE"&&(t.style.cssText="background: var(--pc-surface-container); padding: 2px 4px; border-radius: 2px; font-size: 0.875em;")}),e.querySelectorAll("pre").forEach(t=>{t.style.cssText="background: var(--pc-surface-container); padding: var(--pc-space-2); border-radius: var(--pc-radius-sm); overflow-x: auto; margin: var(--pc-space-2) 0;"})}}const ai=[{combo:"ctrl+enter",action:"test",enabled:!0},{combo:"ctrl+shift+enter",action:"coach",enabled:!0},{combo:"ctrl+z",action:"undo",enabled:!0},{combo:"ctrl+y",action:"redo",enabled:!0}];class ci{constructor(e=ai){this.shortcuts=new Map,e.forEach(t=>{t.enabled&&this.shortcuts.set(t.combo.toLowerCase(),t.action)}),this.enabled=!0,this.actionDispatcher=null,this.isActiveCheck=null,this.boundHandler=null}init(e,t){this.actionDispatcher=e,this.isActiveCheck=t,this.boundHandler=this.handleKeyDown.bind(this),document.addEventListener("keydown",this.boundHandler)}handleKeyDown(e){if(!this.enabled||!this.isActiveCheck||!this.isActiveCheck())return;const t=this.buildCombo(e),n=this.shortcuts.get(t);n&&(e.preventDefault(),e.stopPropagation(),this.actionDispatcher&&this.actionDispatcher(n))}buildCombo(e){const t=[];(e.ctrlKey||e.metaKey)&&t.push("ctrl"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt");let n=e.key.toLowerCase();return n===" "&&(n="space"),n==="escape"&&(n="esc"),t.push(n),t.join("+")}setEnabled(e){this.enabled=e}addShortcut(e,t){this.shortcuts.set(e.toLowerCase(),t)}removeShortcut(e){this.shortcuts.delete(e.toLowerCase())}getShortcuts(){return Array.from(this.shortcuts.entries()).map(([e,t])=>({combo:e,action:t}))}destroy(){this.boundHandler&&(document.removeEventListener("keydown",this.boundHandler),this.boundHandler=null),this.actionDispatcher=null,this.isActiveCheck=null}}class li{constructor(){this.element=null,this.textarea=null,this.preview=null,this.isPreviewMode=!1,this.promptText="",this.initialized=!1,this.isTestRunning=!1,this.isCoachRunning=!1,this.feedbackPanel=null,this.onShowFeedback=null,this.historyTab=null,this.onSwitchToHistory=null,this.keyboardHandler=null,this.promptHistory=new rn(50)}render(){if(this.element)return this.element;this.element=document.createElement("div"),this.element.className="prompt-tab",this.element.setAttribute("role","tabpanel"),this.element.setAttribute("id","prompt-panel"),this.element.style.cssText=`
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 0;
      overflow: hidden;
    `;const e=document.createElement("div");return e.style.cssText="flex: 1; position: relative; min-height: 0;",this.textarea=document.createElement("textarea"),this.textarea.className="input textarea",this.textarea.placeholder="Your prompt here...",this.textarea.style.cssText=`
      width: 100%;
      height: 100%;
      resize: none;
      font-family: inherit;
      font-size: 1rem;
      line-height: 1.5;
      border: none;
      border-radius: 0;
      padding: var(--pc-space-3) var(--pc-space-4);
      padding-bottom: 140px;
      outline: none;
    `,this.textarea.addEventListener("input",t=>{this.promptText=t.target.value,Je(this.promptText),this.promptHistory.pushDebounced(this.promptText,1e3)}),e.appendChild(this.textarea),this.preview=document.createElement("div"),this.preview.className="prompt-preview",this.preview.style.cssText=`
      position: absolute;
      inset: 0;
      padding: var(--pc-space-3) var(--pc-space-4);
      padding-bottom: 140px;
      background-color: var(--pc-surface);
      border: none;
      border-radius: 0;
      overflow-y: auto;
      display: none;
      font-size: 1rem;
      line-height: 1.5;
    `,e.appendChild(this.preview),this.element.appendChild(e),this.loadPrompt(),this.element}createToolbar(){const e=document.createElement("div");e.className="prompt-toolbar",e.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      margin-bottom: var(--pc-space-3);
      flex-wrap: wrap;
    `,this.toggleContainer=document.createElement("div"),this.toggleContainer.className="mode-toggle",this.toggleContainer.style.cssText=`
      display: flex;
      border: 1px solid var(--pc-outline);
      border-radius: var(--pc-radius-sm);
      overflow: hidden;
    `,this.editBtn=document.createElement("button"),this.editBtn.innerHTML=`
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM5.92 19H5v-.92l9.06-9.06.92.92L5.92 19zM20.71 5.63l-2.34-2.34c-.2-.2-.45-.29-.71-.29s-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41z"/>
      </svg>
    `,this.editBtn.title="Edit mode",this.editBtn.style.cssText=`
      padding: var(--pc-space-2);
      border: none;
      background: var(--pc-primary);
      color: var(--pc-on-primary);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      min-height: 36px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    `,this.editBtn.addEventListener("click",()=>this.setMode(!1)),this.previewBtn=document.createElement("button"),this.previewBtn.innerHTML=`
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z"/>
      </svg>
    `,this.previewBtn.title="Preview mode",this.previewBtn.style.cssText=`
      padding: var(--pc-space-2);
      border: none;
      background: transparent;
      color: var(--pc-on-surface);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      min-height: 36px;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    `,this.previewBtn.addEventListener("click",()=>this.setMode(!0)),this.toggleContainer.appendChild(this.editBtn),this.toggleContainer.appendChild(this.previewBtn),e.appendChild(this.toggleContainer);const t=document.createElement("div");t.style.flex="1",e.appendChild(t);const n=document.createElement("button");return n.className="btn btn-text-compact",n.title="Copy prompt",n.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
        <path d="M16 1H4a2 2 0 00-2 2v14h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"/>
      </svg>
      <span>Copy</span>
    `,n.addEventListener("click",()=>this.copyPrompt()),e.appendChild(n),this.testBtn=document.createElement("button"),this.testBtn.className="btn btn-text-compact",this.testBtn.title="Test prompt (Ctrl+Enter)",this.testBtn.innerHTML=`
      <span class="btn-text-icon-wrapper" style="position: relative; display: inline-flex;">
        <svg class="btn-text-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.23 20.23L8 22l10-10L8 2 6.23 3.77 14.46 12z"/>
        </svg>
      </span>
      <span>Test</span>
    `,this.testBtn.addEventListener("click",()=>this.runTest()),e.appendChild(this.testBtn),this.coachBtn=document.createElement("button"),this.coachBtn.className="btn btn-text-compact",this.coachBtn.title="Get coaching feedback (Ctrl+Shift+Enter)",this.coachBtn.innerHTML=`
      <span class="btn-text-icon-wrapper" style="position: relative; display: inline-flex;">
        <svg class="btn-text-icon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 11.75c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zm6 0c-.69 0-1.25.56-1.25 1.25s.56 1.25 1.25 1.25 1.25-.56 1.25-1.25-.56-1.25-1.25-1.25zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-.29.02-.58.05-.86 2.36-1.05 4.23-2.98 5.21-5.37C11.07 8.33 14.05 10 17.42 10c.78 0 1.53-.09 2.25-.26.21.71.33 1.47.33 2.26 0 4.41-3.59 8-8 8z"/>
        </svg>
      </span>
      <span>Review</span>
    `,this.coachBtn.addEventListener("click",()=>this.runCoach()),e.appendChild(this.coachBtn),e}setMode(e){this.isPreviewMode!==e&&(this.isPreviewMode=e,this.isPreviewMode?(this.textarea.style.display="none",this.preview.style.display="block",this.preview.innerHTML=J(this.promptText)||'<p style="color: var(--pc-on-surface-variant);">Nothing to preview</p>',this.applyMarkdownStyles(this.preview)):(this.textarea.style.display="block",this.preview.style.display="none",this.textarea.focus()))}async copyPrompt(){if(!this.promptText.trim())return v("Nothing to copy"),!1;try{return await navigator.clipboard.writeText(this.promptText),v("Prompt copied!"),!0}catch{return v("Failed to copy"),!1}}togglePreview(){this.setMode(!this.isPreviewMode)}async loadPrompt(){try{const e=await F();this.promptText=e.promptText||"",this.textarea&&(this.textarea.value=this.promptText),await this.promptHistory.load(),this.promptText&&this.promptHistory.push(this.promptText),this.initKeyboardHandler()}catch(e){console.error("Failed to load prompt:",e)}}initKeyboardHandler(){this.keyboardHandler||(this.keyboardHandler=new ci,this.keyboardHandler.init(e=>this.handleKeyboardAction(e),()=>this.isKeyboardActive()))}isKeyboardActive(){return this.element&&this.element.offsetParent!==null&&!this.isPreviewMode}handleKeyboardAction(e){switch(e){case"test":this.runTest();break;case"coach":this.runCoach();break;case"undo":this.handleUndo();break;case"redo":this.handleRedo();break;default:console.warn("Unknown keyboard action:",e)}}handleUndo(){const e=this.promptHistory.undo();e!==null&&(this.promptText=e,this.textarea&&(this.textarea.value=e),Je(e),v("Undo"))}handleRedo(){const e=this.promptHistory.redo();e!==null&&(this.promptText=e,this.textarea&&(this.textarea.value=e),Je(e),v("Redo"))}async runTest(){if(this.isTestRunning){v("Test already in progress");return}const e=this.promptText.trim();if(!e){v("Please enter a prompt first");return}if(!at()){v("Please configure an API key in Settings");return}const t=W(),n=t.provider||"openai",i=t.apiKeys[n],o=t.testModel||null;if(!i){v(`No API key configured for ${n}`);return}let a;try{a=_e(n,i,o)}catch(h){v(h.message||"Failed to create provider");return}let r=e,l=null;try{const h=yn(n,a.getModelName()),u=Math.ceil(e.length/3.5),m=vn(h,4096+u),{context:f,truncated:b,count:y}=await ws(m);f&&(r=`${f}

---

${e}`,l={count:y,truncated:b},b&&v("Attachments truncated to fit model context window","warning"))}catch(h){console.warn("Failed to get attachment context:",h)}this.isTestRunning=!0,this.testBtn&&(this.testBtn.disabled=!0,this.setButtonLoading(this.testBtn,!0)),await qt(e);const c=Dn({promptSnapshot:e,provider:a.getProviderName(),model:a.getModelName(),status:"streaming"});await ct(c),this.historyTab&&this.historyTab.addEntry(c),this.onSwitchToHistory&&this.onSwitchToHistory(),this.historyTab&&this.historyTab.expandItem(c.id);const d=performance.now();let p="";await Mn(a.getProviderName(),a.getModelName(),r.length);try{for await(const h of a.streamCompletion(r))if(h.content&&(p+=h.content,this.historyTab&&this.historyTab.updateExpandedEntry(c.id,{responseText:p})),h.done&&h.usage){const u=Math.round(performance.now()-d);await Rt(c.id,{responseText:p,tokens:h.usage,durationMs:u,status:"complete"}),this.historyTab&&this.historyTab.updateExpandedEntry(c.id,{responseText:p,tokens:h.usage,durationMs:u,status:"complete"}),await Le(a.getProviderName(),a.getModelName(),p.length,h.usage,u)}}catch(h){const u=Math.round(performance.now()-d),m=h instanceof k?h.userMessage:h.message||"Unknown error";await Rt(c.id,{responseText:p,error:m,durationMs:u,status:"error"}),this.historyTab&&this.historyTab.updateExpandedEntry(c.id,{responseText:p,error:m,durationMs:u,status:"error"}),await fe(a.getProviderName(),a.getModelName(),m,u),v(m)}finally{this.isTestRunning=!1,this.testBtn&&(this.testBtn.disabled=!1,this.setButtonLoading(this.testBtn,!1))}}setOnSwitchToResults(e){this.onSwitchToResults=e}setResultsTab(e){this.resultsTab=e}setOnShowFeedback(e){this.onShowFeedback=e}setHistoryTab(e){this.historyTab=e}setOnSwitchToHistory(e){this.onSwitchToHistory=e}async runCoach(){if(this.isCoachRunning){v("Coach evaluation in progress");return}const e=this.promptText.trim();if(!e){v("Please enter a prompt first");return}if(!at()){v("Please configure an API key in Settings");return}const t=W(),n=t.provider||"openai",i=t.apiKeys[n];if(!i){v(`No API key configured for ${n}`);return}let o="";try{const{summary:r}=await xs();o=r}catch(r){console.warn("Failed to get attachment summary:",r)}this.isCoachRunning=!0,this.coachBtn&&(this.coachBtn.disabled=!0,this.setButtonLoading(this.coachBtn,!0));const a=performance.now();try{const r=new ti(n,i);this.onShowFeedbackStreaming&&this.onShowFeedbackStreaming({provider:r.getProviderName(),model:r.getModelName()});let l=null;for await(const h of r.evaluateStreaming(e,{attachmentContext:o}))h.type==="chunk"?this.onFeedbackStreamChunk&&this.onFeedbackStreamChunk(h.content):h.type==="complete"&&(l=h.result);const c=Math.round(performance.now()-a);if(!l)throw new Error("No response received from coach");await qt(e);const d=l.scores.map(h=>({...h,principle:h.principle||h.principleId})),p=$n({promptSnapshot:e,scores:d,overall:l.overall,description:l.description,feedback:l.feedback,provider:r.getProviderName(),model:r.getModelName(),durationMs:c,targetPrinciple:l.targetPrinciple,complete:l.complete,completionReason:l.completionReason,canReintroduceSkipped:l.canReintroduceSkipped,skippedPrinciples:l.skippedPrinciples,actionableThreshold:l.actionableThreshold});await ct(p),this.historyTab&&this.historyTab.addEntry(p),this.onFinalizeFeedbackStreaming&&this.onFinalizeFeedbackStreaming(p),console.log("Coach: Evaluation complete",p)}catch(r){const l=r.message||"Coach evaluation failed";v(l),console.error("Coach: Error",r),this.onHideFeedbackPanel&&this.onHideFeedbackPanel(),await fe(t.provider||"openai","auto",l,Math.round(performance.now()-a))}finally{this.isCoachRunning=!1,this.coachBtn&&(this.coachBtn.disabled=!1,this.setButtonLoading(this.coachBtn,!1))}}setButtonLoading(e,t){if(!document.getElementById("btn-spinner-styles")){const o=document.createElement("style");o.id="btn-spinner-styles",o.textContent=`
        @keyframes btn-spinner-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        .btn-spinner-ring {
          position: absolute;
          inset: -3px;
          border-radius: 50%;
          border: 2px solid var(--pc-outline-variant);
          border-top-color: var(--pc-primary);
          animation: btn-spinner-rotate 0.8s linear infinite;
          pointer-events: none;
        }
      `,document.head.appendChild(o)}const n=e.querySelector(".btn-text-icon-wrapper");if(!n)return;const i=n.querySelector(".btn-spinner-ring");if(i&&i.remove(),t){const o=document.createElement("div");o.className="btn-spinner-ring",n.appendChild(o);const a=n.querySelector(".btn-text-icon");a&&(a.style.opacity="0.5")}else{const o=n.querySelector(".btn-text-icon");o&&(o.style.opacity="1")}}resetSession(){this.promptText="",this.textarea&&(this.textarea.value=""),this.preview&&(this.preview.innerHTML=""),this.promptHistory.clear(),this.isPreviewMode=!1,this.textarea&&(this.textarea.style.display="block"),this.preview&&(this.preview.style.display="none")}applyMarkdownStyles(e){e.querySelectorAll("p").forEach(r=>{r.style.cssText="margin: 0; line-height: 1.5;"}),e.querySelectorAll("ul, ol").forEach(r=>{r.style.cssText=`
        margin: 0;
        padding-left: 1.25em;
        list-style-position: outside;
      `}),e.querySelectorAll("li").forEach(r=>{r.style.cssText="margin: 0;"}),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(r=>{r.style.cssText="margin: 0; line-height: 1.5;"}),e.querySelectorAll("pre").forEach(r=>{r.style.cssText="margin: 0;"})}}const di={feedback:'<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M440-120v-80h320v-284q0-117-81.5-198.5T480-764q-117 0-198.5 81.5T200-484v244h-40q-33 0-56.5-23.5T80-320v-80q0-21 10.5-39.5T120-469l3-53q8-68 39.5-126t79-101q47.5-43 109-67T480-840q68 0 129 24t109 66.5Q766-707 797-649t40 126l3 52q19 9 29.5 27t10.5 38v92q0 20-10.5 38T840-249v49q0 33-23.5 56.5T760-120H440Zm-80-280q-17 0-28.5-11.5T320-440q0-17 11.5-28.5T360-480q17 0 28.5 11.5T400-440q0 17-11.5 28.5T360-400Zm240 0q-17 0-28.5-11.5T560-440q0-17 11.5-28.5T600-480q17 0 28.5 11.5T640-440q0 17-11.5 28.5T600-400Zm-359-62q-7-106 64-182t177-76q89 0 156.5 56.5T720-519q-91-1-167.5-49T435-698q-16 80-67.5 142.5T241-462Z"/></svg>',result:'<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z"/></svg>',"prompt-change":'<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>'},Me={feedback:"var(--pc-primary)",result:"var(--pc-secondary, #4caf50)","prompt-change":"var(--pc-tertiary, #ff9800)"};class en{constructor(e,t={}){this.entry=e,this.onClick=t.onClick||null,this.element=null}render(){return this.element=document.createElement("div"),this.element.className="history-item",this.element.dataset.entryId=this.entry.id,this.element.dataset.entryType=this.entry.type,this.element.setAttribute("role","button"),this.element.setAttribute("tabindex","0"),this.element.setAttribute("aria-label",this._getAriaLabel()),this._applyStyles(),this._buildContent(),this._attachEventListeners(),this.element}_applyStyles(){this.element.style.cssText=`
      padding: var(--pc-space-3) var(--pc-space-4);
      margin-bottom: var(--pc-space-2);
      background: var(--pc-surface-elevated);
      border-radius: 0 var(--pc-radius-md) var(--pc-radius-md) 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--pc-space-3);
      min-height: 64px;
      transition: background-color 0.15s ease, box-shadow 0.15s ease;
      border-left: 3px solid ${Me[this.entry.type]||"var(--pc-outline)"};
    `}_buildContent(){const e=this._createTypeIcon();this.element.appendChild(e);const t=this._createContentArea();this.element.appendChild(t);const n=this._createTimestamp();this.element.appendChild(n)}_createTypeIcon(){const e=document.createElement("span");return e.className="history-item-icon",e.style.cssText=`
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--pc-radius-sm);
      background: ${Me[this.entry.type]}20;
      color: ${Me[this.entry.type]};
      flex-shrink: 0;
    `,e.innerHTML=di[this.entry.type]||"",e}_createContentArea(){const e=document.createElement("div");e.className="history-item-content",e.style.cssText="flex:1;min-width:0;";const t=document.createElement("div");t.className="history-item-title",t.style.cssText="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";const n=document.createElement("div");switch(n.className="history-item-subtitle",n.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;",this.entry.type){case"feedback":this._renderFeedbackContent(t,n);break;case"result":this._renderResultContent(t,n);break;case"prompt-change":this._renderPromptChangeContent(t,n);break}return e.appendChild(t),e.appendChild(n),e}_renderFeedbackContent(e,t){const n=document.createElement("span");n.className="score-badge",n.style.cssText=`
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 20px;
      padding: 0 6px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 8px;
      background: ${this._getScoreColor(this.entry.overall)};
      color: white;
    `,n.textContent=`${this.entry.overall}%`,e.appendChild(n),e.appendChild(document.createTextNode(this.entry.description||"Coach Feedback")),t.textContent=`${this.entry.provider}/${this.entry.model}`}_renderResultContent(e,t){var a;const n=document.createElement("span");n.className="status-indicator",n.style.cssText=`
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background: ${this._getStatusColor(this.entry.status)};
    `,e.appendChild(n),e.appendChild(document.createTextNode(`${this.entry.provider}/${this.entry.model}`));const i=((a=this.entry.tokens)==null?void 0:a.total)||0,o=this.entry.durationMs?`${(this.entry.durationMs/1e3).toFixed(1)}s`:"";t.textContent=i>0?`${i} tokens${o?` • ${o}`:""}`:this.entry.status}_renderPromptChangeContent(e,t){var i;e.textContent="Prompt Updated";const n=((i=this.entry.newPromptText)==null?void 0:i.substring(0,60))||"";t.textContent=n+(n.length>=60?"...":"")}_createTimestamp(){const e=document.createElement("span");return e.className="history-item-time",e.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);flex-shrink:0;",e.textContent=this._formatTime(this.entry.timestamp),e}_getScoreColor(e){return e>=80?"#4caf50":e>=60?"#ff9800":"#f44336"}_getStatusColor(e){switch(e){case"complete":return"#4caf50";case"streaming":return"#2196f3";case"error":return"#f44336";default:return"#9e9e9e"}}_formatTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}_getAriaLabel(){switch(this.entry.type){case"feedback":return`Coach feedback: ${this.entry.description||"Score "+this.entry.overall+"%"}`;case"result":return`Test result: ${this.entry.provider}/${this.entry.model}, ${this.entry.status}`;case"prompt-change":return"Prompt change";default:return"History entry"}}_attachEventListeners(){this.element.addEventListener("click",()=>{this.onClick&&this.onClick(this.entry.id)}),this.element.addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),this.onClick&&this.onClick(this.entry.id))}),this.element.addEventListener("mouseenter",()=>{this.element.style.background="var(--pc-surface-hover)",this.element.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)"}),this.element.addEventListener("mouseleave",()=>{this.element.style.background="var(--pc-surface-elevated)",this.element.style.boxShadow="none"}),this.element.addEventListener("focus",()=>{this.element.style.outline=`2px solid ${Me[this.entry.type]}`,this.element.style.outlineOffset="2px"}),this.element.addEventListener("blur",()=>{this.element.style.outline="none"})}update(e){if(Object.assign(this.entry,e),!!this.element)if(this.entry.type==="result")this._updateResultContent();else{const t=this.element.parentNode,n=this.element,i=this.render();t&&t.contains(n)&&t.replaceChild(i,n)}}_updateResultContent(){var n;const e=this.element.querySelector(".status-indicator");e&&(e.style.background=this._getStatusColor(this.entry.status));const t=this.element.querySelector(".history-item-subtitle");if(t){const i=((n=this.entry.tokens)==null?void 0:n.total)||0,o=this.entry.durationMs?`${(this.entry.durationMs/1e3).toFixed(1)}s`:"";t.textContent=i>0?`${i} tokens${o?` • ${o}`:""}`:this.entry.status}}}const pi={feedback:"var(--pc-primary)",result:"var(--pc-secondary, #4caf50)","prompt-change":"var(--pc-tertiary, #ff9800)"},tn={feedback:"Coach Feedback",result:"Test Result","prompt-change":"Prompt Change"};class nn{constructor(e,t={}){this.entry=e,this.onClose=t.onClose||null,this.onNavigate=t.onNavigate||null,this.contentComponent=t.contentComponent||null,this.element=null,this.headerElement=null,this.contentArea=null}render(){return this.element=document.createElement("div"),this.element.className="history-expanded",this.element.style.cssText="display:flex;flex-direction:column;height:100%;",this.element.setAttribute("role","dialog"),this.element.setAttribute("aria-modal","true"),this.element.setAttribute("aria-label",tn[this.entry.type]||"History Entry"),this.headerElement=this._createHeader(),this.element.appendChild(this.headerElement),this.contentArea=document.createElement("div"),this.contentArea.className="expanded-content",this.contentArea.style.cssText="flex:1;overflow-y:auto;padding:var(--pc-space-4);",this.contentComponent&&this.contentArea.appendChild(this.contentComponent),this.element.appendChild(this.contentArea),this.element}_createHeader(){const e=document.createElement("div");e.className="expanded-header",e.style.cssText=`
      display: flex;
      align-items: center;
      padding: var(--pc-space-3) var(--pc-space-4);
      border-bottom: 1px solid var(--pc-border);
      gap: var(--pc-space-3);
      background: var(--pc-surface);
      border-left: 4px solid ${pi[this.entry.type]||"var(--pc-outline)"};
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: relative;
      z-index: 1;
      flex-shrink: 0;
    `;const t=document.createElement("button");t.className="close-btn",t.setAttribute("aria-label","Close"),t.style.cssText=`
      background: none;
      border: none;
      padding: var(--pc-space-2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--pc-radius-sm);
      color: var(--pc-text-primary);
      transition: background-color 0.15s ease;
    `,t.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',t.addEventListener("click",()=>{var a;return(a=this.onClose)==null?void 0:a.call(this)}),t.addEventListener("mouseenter",()=>{t.style.background="var(--pc-surface-hover)"}),t.addEventListener("mouseleave",()=>{t.style.background="none"}),e.appendChild(t);const n=document.createElement("span");n.className="expanded-title",n.style.cssText="font-weight:500;flex:1;",n.textContent=tn[this.entry.type]||"History Entry",e.appendChild(n);const i=this._createHeaderActions();i&&e.appendChild(i);const o=document.createElement("span");return o.className="expanded-timestamp",o.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",o.textContent=this._formatTimestamp(this.entry.timestamp),e.appendChild(o),e}_createHeaderActions(){var t;const e=document.createElement("div");if(e.className="expanded-actions",e.style.cssText="display:flex;align-items:center;gap:var(--pc-space-2);",this.entry.type==="feedback"){const n=document.createElement("span");if(n.className="score-badge",n.style.cssText=`
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 48px;
        height: 24px;
        padding: 0 8px;
        border-radius: 12px;
        font-size: 0.875rem;
        font-weight: 600;
        background: ${this._getScoreColor(this.entry.overall)};
        color: white;
      `,n.textContent=`${this.entry.overall}%`,e.appendChild(n),this.entry.durationMs){const i=document.createElement("span");i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",i.textContent=`${(this.entry.durationMs/1e3).toFixed(1)}s`,e.appendChild(i)}}else if(this.entry.type==="result"){const n=document.createElement("span");if(n.style.cssText=`
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: ${this._getStatusColor(this.entry.status)};
      `,e.appendChild(n),(t=this.entry.tokens)!=null&&t.total){const i=document.createElement("span");i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",i.textContent=`${this.entry.tokens.total} tokens`,e.appendChild(i)}if(this.entry.durationMs){const i=document.createElement("span");i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",i.textContent=`${(this.entry.durationMs/1e3).toFixed(1)}s`,e.appendChild(i)}}return e.children.length>0?e:null}_getScoreColor(e){return e>=80?"#4caf50":e>=60?"#ff9800":"#f44336"}_getStatusColor(e){switch(e){case"complete":return"#4caf50";case"streaming":return"#2196f3";case"error":return"#f44336";default:return"#9e9e9e"}}_formatTimestamp(e){return new Date(e).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}setContent(e){this.contentComponent=e,this.contentArea&&(this.contentArea.innerHTML="",e&&this.contentArea.appendChild(e))}updateEntry(e){if(this.entry=e,this.headerElement){const t=this._createHeader();this.headerElement.replaceWith(t),this.headerElement=t}}}let Ne=null;async function hi(){if(Ne)return Ne;try{return Ne=(await Y(()=>import("./principles-Dvy7Q6Uu.js"),[],import.meta.url)).default,Ne}catch(s){return console.warn("Could not load principles:",s),null}}function ui(s){return s?s.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):""}class mi{constructor(e){this.entry=e,this.element=null}render(){this.element=document.createElement("div"),this.element.className="feedback-expanded-content",this.element.style.cssText="display:flex;flex-direction:column;gap:var(--pc-space-4);";const e=this._createStatsRibbon();this.element.appendChild(e);const t=this._createFeedbackSection();if(this.element.appendChild(t),this.entry.scores&&this.entry.scores.length>0){const i=this._createScoresSection();this.element.appendChild(i)}const n=this._createPromptSection();return this.element.appendChild(n),this.element}_createStatsRibbon(){const e=document.createElement("div");if(e.className="feedback-stats-ribbon",e.style.cssText=`
      display: flex;
      flex-wrap: wrap;
      gap: var(--pc-space-3);
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      font-size: 0.875rem;
    `,this.entry.provider&&this.entry.model){const n=this._createStatItem("Model",`${this.entry.provider}/${this.entry.model}`);e.appendChild(n)}if(this.entry.durationMs){const n=this._createStatItem("Duration",`${(this.entry.durationMs/1e3).toFixed(1)}s`);e.appendChild(n)}const t=this._createStatItem("Score",`${this.entry.overall}%`);if(t.querySelector(".stat-value").style.color=this._getScoreColor(this.entry.overall),t.querySelector(".stat-value").style.fontWeight="600",e.appendChild(t),this.entry.description){const n=this._createStatItem("Quality",this.entry.description);e.appendChild(n)}if(this.entry.targetPrinciple){const n=this._createStatItem("Focus",this.entry.targetPrinciple);e.appendChild(n)}return e}_createStatItem(e,t){const n=document.createElement("div");n.className="stat-item",n.style.cssText="display:flex;flex-direction:column;";const i=document.createElement("span");i.className="stat-label",i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",i.textContent=e;const o=document.createElement("span");return o.className="stat-value",o.textContent=t,n.appendChild(i),n.appendChild(o),n}_createScoresSection(){const e=document.createElement("div");e.className="feedback-scores-section";let t={};const n=document.createElement("button");n.className="scores-collapse-header",n.setAttribute("aria-expanded","false"),n.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      width: 100%;
      padding: 0;
      margin: 0 0 var(--pc-space-3) 0;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      color: var(--pc-on-surface);
    `;const i=document.createElement("h3");i.style.cssText="font-size:1rem;font-weight:500;margin:0;color:var(--pc-on-surface);",i.textContent="Principle Scores";const o=document.createElement("span");o.style.cssText="font-size:0.875rem;color:#666;",o.textContent=`(${this.entry.scores.length})`;const a=document.createElement("span");a.className="collapse-chevron",a.innerHTML=q("chevronDown",20),a.style.cssText="display:flex;transition:transform 0.2s ease;transform:rotate(-90deg);margin-left:auto;",n.appendChild(i),n.appendChild(o),n.appendChild(a),e.appendChild(n);const r=document.createElement("div");r.className="scores-collapse-content",r.style.cssText="display:none;margin-top:var(--pc-space-2);";const l=document.createElement("div");return l.style.cssText="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--pc-space-2);",hi().then(c=>{t=c?Object.fromEntries(c.principles.map(d=>[d.id,d])):{},this.entry.scores.forEach(d=>{const p=d.principle||d.principleId,h=t[p],u=this._createScoreCard({...d,principle:p},h);l.appendChild(u)})}),r.appendChild(l),e.appendChild(r),n.addEventListener("click",()=>{const c=n.getAttribute("aria-expanded")==="true";n.setAttribute("aria-expanded",(!c).toString()),r.style.display=c?"none":"block",a.style.transform=c?"rotate(-90deg)":"rotate(0deg)"}),e}_createScoreCard(e,t){const n=e.applicable===!1||e.score===null||e.score===void 0,i=document.createElement("div");i.className="score-card",i.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      padding: var(--pc-space-2) var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: 0 var(--pc-radius-sm) var(--pc-radius-sm) 0;
      border-left: 3px solid ${n?"#9CA3AF":this._getScoreColor(e.score)};
      ${n?"opacity: 0.6;":""}
    `,t&&(i.title=t.description);const o=document.createElement("span");o.style.cssText="flex:1;font-size:0.875rem;",o.textContent=t?t.name:ui(e.principle);const a=document.createElement("span");return a.style.cssText=`font-weight:${n?"400":"600"};color:${n?"#9CA3AF":this._getScoreColor(e.score)};${n?"font-style:italic;":""}`,a.textContent=n?"N/A":`${e.score}%`,i.appendChild(o),i.appendChild(a),i}_createFeedbackSection(){const e=document.createElement("div");e.className="feedback-text-section";const t=document.createElement("h3");t.style.cssText="font-size:1rem;font-weight:500;margin:0 0 var(--pc-space-3) 0;",t.textContent="Feedback",e.appendChild(t);const n=document.createElement("div");return n.className="feedback-content markdown-content",n.style.cssText=`
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      line-height: 1.6;
    `,this.entry.feedback?(n.innerHTML=J(this.entry.feedback),this._applyMarkdownStyles(n)):(n.textContent="No feedback text available.",n.style.color="var(--pc-text-secondary)"),e.appendChild(n),e}_createPromptSection(){const e=document.createElement("div");e.className="feedback-prompt-section";const t=document.createElement("button");t.className="prompt-collapse-header",t.setAttribute("aria-expanded","false"),t.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      width: 100%;
      padding: 0;
      margin: 0 0 var(--pc-space-3) 0;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      color: var(--pc-on-surface);
    `;const n=document.createElement("h3");n.style.cssText="font-size:1rem;font-weight:500;margin:0;color:var(--pc-on-surface);",n.textContent="Prompt Snapshot";const i=document.createElement("span");i.className="collapse-chevron",i.innerHTML=q("chevronDown",20),i.style.cssText="display:flex;transition:transform 0.2s ease;transform:rotate(-90deg);margin-left:auto;",t.appendChild(n),t.appendChild(i),e.appendChild(t);const o=document.createElement("div");o.className="prompt-collapse-content",o.style.cssText="display:none;";const a=document.createElement("div");return a.className="prompt-snapshot markdown-content",a.style.cssText=`
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      line-height: 1.6;
    `,this.entry.promptSnapshot?(a.innerHTML=J(this.entry.promptSnapshot),this._applyMarkdownStyles(a)):(a.textContent="No prompt snapshot available.",a.style.color="var(--pc-text-secondary)"),o.appendChild(a),e.appendChild(o),t.addEventListener("click",()=>{const r=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",(!r).toString()),o.style.display=r?"none":"block",i.style.transform=r?"rotate(-90deg)":"rotate(0deg)"}),e}_getScoreColor(e){return e>=80?"#22C55E":e>=60?"#F59E0B":"#EF4444"}_applyMarkdownStyles(e){e.querySelectorAll("p").forEach(t=>{t.style.cssText="margin:0 0 var(--pc-space-2) 0;"}),e.querySelectorAll("ul, ol").forEach(t=>{t.style.cssText="margin:0 0 var(--pc-space-2) 0;padding-left:1.5em;"}),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(t=>{t.style.cssText="margin:var(--pc-space-3) 0 var(--pc-space-2) 0;"}),e.querySelectorAll("code").forEach(t=>{t.style.cssText="background:var(--pc-surface);padding:2px 4px;border-radius:2px;font-size:0.875em;"}),e.querySelectorAll("pre").forEach(t=>{t.style.cssText="background:var(--pc-surface);padding:var(--pc-space-2);border-radius:var(--pc-radius-sm);overflow-x:auto;"})}}class fi{constructor(e){this.entry=e,this.element=null,this.responseContainer=null}render(){this.element=document.createElement("div"),this.element.className="result-expanded-content",this.element.style.cssText="display:flex;flex-direction:column;gap:var(--pc-space-4);";const e=this._createStatsRibbon();this.element.appendChild(e);const t=this._createActionsBar();this.element.appendChild(t);const n=this._createResponseSection();this.element.appendChild(n);const i=this._createPromptSection();return this.element.appendChild(i),this.element}_createStatsRibbon(){const e=document.createElement("div");e.className="result-stats-ribbon",e.style.cssText=`
      display: flex;
      flex-wrap: wrap;
      gap: var(--pc-space-3);
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      font-size: 0.875rem;
    `;const t=this._createStatItem("Status",this.entry.status),n=t.querySelector(".stat-value");if(n.style.color=this._getStatusColor(this.entry.status),n.style.fontWeight="600",e.appendChild(t),this.entry.provider&&this.entry.model){const i=this._createStatItem("Model",`${this.entry.provider}/${this.entry.model}`);e.appendChild(i)}if(this.entry.tokens){if(this.entry.tokens.prompt){const i=this._createStatItem("Prompt Tokens",this.entry.tokens.prompt.toString());e.appendChild(i)}if(this.entry.tokens.completion){const i=this._createStatItem("Completion Tokens",this.entry.tokens.completion.toString());e.appendChild(i)}if(this.entry.tokens.total){const i=this._createStatItem("Total Tokens",this.entry.tokens.total.toString());i.querySelector(".stat-value").style.fontWeight="600",e.appendChild(i)}}if(this.entry.durationMs){const i=this._createStatItem("Duration",`${(this.entry.durationMs/1e3).toFixed(1)}s`);e.appendChild(i)}if(this.entry.error){const i=this._createStatItem("Error",this.entry.error);i.querySelector(".stat-value").style.color="#f44336",e.appendChild(i)}return e}_createStatItem(e,t){const n=document.createElement("div");n.className="stat-item",n.style.cssText="display:flex;flex-direction:column;";const i=document.createElement("span");i.className="stat-label",i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",i.textContent=e;const o=document.createElement("span");return o.className="stat-value",o.textContent=t,n.appendChild(i),n.appendChild(o),n}_createActionsBar(){const e=document.createElement("div");e.className="result-actions-bar",e.style.cssText="display:flex;gap:var(--pc-space-2);";const t=this._createActionButton("Copy Response","copy",()=>this._copyResponse());e.appendChild(t);const n=this._createActionButton("Download","download",()=>this._downloadResponse());return e.appendChild(n),e}_createActionButton(e,t,n){const i=document.createElement("button");i.className="action-btn",i.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      padding: var(--pc-space-2) var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border: 1px solid var(--pc-border);
      border-radius: var(--pc-radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--pc-text-primary);
      transition: background-color 0.15s ease;
    `;const o={copy:'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 00-2 2v14h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"/></svg>',download:'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>'};return i.innerHTML=`${o[t]||""}${e}`,i.addEventListener("click",n),i.addEventListener("mouseenter",()=>{i.style.background="var(--pc-surface-hover)"}),i.addEventListener("mouseleave",()=>{i.style.background="var(--pc-surface-elevated)"}),i}_createResponseSection(){const e=document.createElement("div");e.className="result-response-section";const t=document.createElement("h3");return t.style.cssText="font-size:1rem;font-weight:500;margin:0 0 var(--pc-space-3) 0;",t.textContent="Response",e.appendChild(t),this.responseContainer=document.createElement("div"),this.responseContainer.className="response-content markdown-content",this.responseContainer.style.cssText=`
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      line-height: 1.6;
      overflow-y: auto;
    `,this._renderResponse(),e.appendChild(this.responseContainer),e}_renderResponse(){if(this.responseContainer){if(!document.getElementById("streaming-pulse-style")){const e=document.createElement("style");e.id="streaming-pulse-style",e.textContent="@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}",document.head.appendChild(e)}if(this.entry.error)this.responseContainer.innerHTML=`
        <div style="color:#f44336;">
          <strong>Error:</strong> ${this.entry.error}
        </div>
      `;else if(this.entry.responseText){let e=J(this.entry.responseText);this.entry.status==="streaming"&&(e+='<span class="streaming-cursor" style="display:inline-block;width:8px;height:16px;background:#2196f3;animation:pulse 0.5s infinite;vertical-align:text-bottom;margin-left:2px;"></span>'),this.responseContainer.innerHTML=e,this._applyMarkdownStyles(this.responseContainer)}else this.entry.status==="streaming"?this.responseContainer.innerHTML=`
        <div style="display:flex;align-items:center;gap:var(--pc-space-2);color:var(--pc-text-secondary);">
          <span class="streaming-indicator" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#2196f3;animation:pulse 1s infinite;"></span>
          <span>Waiting for response...</span>
        </div>
      `:(this.responseContainer.textContent="No response available.",this.responseContainer.style.color="var(--pc-text-secondary)")}}_createPromptSection(){const e=document.createElement("div");e.className="result-prompt-section";const t=document.createElement("button");t.className="prompt-collapse-header",t.setAttribute("aria-expanded","false"),t.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      width: 100%;
      padding: 0;
      margin: 0 0 var(--pc-space-3) 0;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: left;
      font-family: inherit;
      color: var(--pc-on-surface);
    `;const n=document.createElement("h3");n.style.cssText="font-size:1rem;font-weight:500;margin:0;color:var(--pc-on-surface);",n.textContent="Prompt Snapshot";const i=document.createElement("span");i.className="collapse-chevron",i.innerHTML='<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/></svg>',i.style.cssText="display:flex;transition:transform 0.2s ease;transform:rotate(-90deg);margin-left:auto;",t.appendChild(n),t.appendChild(i),e.appendChild(t);const o=document.createElement("div");o.className="prompt-collapse-content",o.style.cssText="display:none;";const a=document.createElement("div");return a.className="prompt-snapshot markdown-content",a.style.cssText=`
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      line-height: 1.6;
    `,this.entry.promptSnapshot?(a.innerHTML=J(this.entry.promptSnapshot),this._applyMarkdownStyles(a)):(a.textContent="No prompt snapshot available.",a.style.color="var(--pc-text-secondary)"),o.appendChild(a),e.appendChild(o),t.addEventListener("click",()=>{const r=t.getAttribute("aria-expanded")==="true";t.setAttribute("aria-expanded",(!r).toString()),o.style.display=r?"none":"block",i.style.transform=r?"rotate(-90deg)":"rotate(0deg)"}),e}async _copyResponse(){const e=this.entry.responseText||"";if(!e){v("No response to copy");return}try{await navigator.clipboard.writeText(e),v("Response copied to clipboard")}catch{v("Failed to copy")}}_downloadResponse(){const e=this.entry.responseText||"";if(!e){v("No response to download");return}const t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`response-${this.entry.id.substring(0,8)}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n),v("Response downloaded")}_getStatusColor(e){switch(e){case"complete":return"#4caf50";case"streaming":return"#2196f3";case"error":return"#f44336";default:return"#9e9e9e"}}_applyMarkdownStyles(e){e.querySelectorAll("p").forEach(t=>{t.style.cssText="margin:0 0 var(--pc-space-2) 0;"}),e.querySelectorAll("ul, ol").forEach(t=>{t.style.cssText="margin:0 0 var(--pc-space-2) 0;padding-left:1.5em;"}),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(t=>{t.style.cssText="margin:var(--pc-space-3) 0 var(--pc-space-2) 0;"}),e.querySelectorAll("code").forEach(t=>{t.style.cssText="background:var(--pc-surface);padding:2px 4px;border-radius:2px;font-size:0.875em;"}),e.querySelectorAll("pre").forEach(t=>{t.style.cssText="background:var(--pc-surface);padding:var(--pc-space-2);border-radius:var(--pc-radius-sm);overflow-x:auto;"})}update(e){var t;if(Object.assign(this.entry,e),this._renderResponse(),e.status==="complete"||e.tokens||e.durationMs){const n=(t=this.element)==null?void 0:t.querySelector(".result-stats-ribbon");if(n){const i=this._createStatsRibbon();n.replaceWith(i)}}}appendChunk(e){this.entry.responseText||(this.entry.responseText=""),this.entry.responseText+=e,this.responseContainer&&this.entry.status==="streaming"&&(this.responseContainer.innerHTML=J(this.entry.responseText),this._applyMarkdownStyles(this.responseContainer))}}class gi{constructor(e){this.entry=e,this.element=null}render(){this.element=document.createElement("div"),this.element.className="prompt-change-expanded-content",this.element.style.cssText="display:flex;flex-direction:column;gap:var(--pc-space-4);";const e=this._createInfoRibbon();this.element.appendChild(e);const t=this._createActionsBar();this.element.appendChild(t);const n=this._createPromptSection();return this.element.appendChild(n),this.element}_createInfoRibbon(){var c,d,p;const e=document.createElement("div");e.className="prompt-change-info-ribbon",e.style.cssText=`
      display: flex;
      flex-wrap: wrap;
      gap: var(--pc-space-3);
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      font-size: 0.875rem;
    `;const t=this._createStatItem("Recorded At",this._formatTimestamp(this.entry.timestamp));e.appendChild(t);const n=((c=this.entry.newPromptText)==null?void 0:c.length)||0,i=this._createStatItem("Characters",n.toLocaleString());e.appendChild(i);const o=((d=this.entry.newPromptText)==null?void 0:d.split(/\s+/).filter(h=>h.length>0).length)||0,a=this._createStatItem("Words",o.toLocaleString());e.appendChild(a);const r=((p=this.entry.newPromptText)==null?void 0:p.split(`
`).length)||0,l=this._createStatItem("Lines",r.toLocaleString());return e.appendChild(l),e}_createStatItem(e,t){const n=document.createElement("div");n.className="stat-item",n.style.cssText="display:flex;flex-direction:column;";const i=document.createElement("span");i.className="stat-label",i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);",i.textContent=e;const o=document.createElement("span");return o.className="stat-value",o.textContent=t,n.appendChild(i),n.appendChild(o),n}_createActionsBar(){const e=document.createElement("div");e.className="prompt-change-actions-bar",e.style.cssText="display:flex;gap:var(--pc-space-2);";const t=this._createActionButton("Copy Prompt","copy",()=>this._copyPrompt());return e.appendChild(t),e}_createActionButton(e,t,n){const i=document.createElement("button");i.className="action-btn",i.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-2);
      padding: var(--pc-space-2) var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border: 1px solid var(--pc-border);
      border-radius: var(--pc-radius-sm);
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--pc-text-primary);
      transition: background-color 0.15s ease;
    `;const o={copy:'<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 00-2 2v14h2V3h12V1zm3 4H8a2 2 0 00-2 2v14a2 2 0 002 2h11a2 2 0 002-2V7a2 2 0 00-2-2zm0 16H8V7h11v14z"/></svg>'};return i.innerHTML=`${o[t]||""}${e}`,i.addEventListener("click",n),i.addEventListener("mouseenter",()=>{i.style.background="var(--pc-surface-hover)"}),i.addEventListener("mouseleave",()=>{i.style.background="var(--pc-surface-elevated)"}),i}_createPromptSection(){const e=document.createElement("div");e.className="prompt-change-text-section",e.style.cssText="flex:1;display:flex;flex-direction:column;";const t=document.createElement("h3");t.style.cssText="font-size:1rem;font-weight:500;margin:0 0 var(--pc-space-3) 0;",t.textContent="Prompt Text",e.appendChild(t);const n=document.createElement("div");return n.className="prompt-text-content markdown-content",n.style.cssText=`
      flex: 1;
      padding: var(--pc-space-3);
      background: var(--pc-surface-elevated);
      border-radius: var(--pc-radius-sm);
      line-height: 1.6;
    `,this.entry.newPromptText?(n.innerHTML=J(this.entry.newPromptText),this._applyMarkdownStyles(n)):(n.textContent="No prompt text available.",n.style.color="var(--pc-text-secondary)"),e.appendChild(n),e}async _copyPrompt(){const e=this.entry.newPromptText||"";if(!e){v("No prompt to copy");return}try{await navigator.clipboard.writeText(e),v("Prompt copied to clipboard")}catch{v("Failed to copy")}}_applyMarkdownStyles(e){e.querySelectorAll("p").forEach(t=>{t.style.cssText="margin:0 0 var(--pc-space-2) 0;"}),e.querySelectorAll("ul, ol").forEach(t=>{t.style.cssText="margin:0 0 var(--pc-space-2) 0;padding-left:1.5em;"}),e.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(t=>{t.style.cssText="margin:var(--pc-space-3) 0 var(--pc-space-2) 0;"}),e.querySelectorAll("code").forEach(t=>{t.style.cssText="background:var(--pc-surface);padding:2px 4px;border-radius:2px;font-size:0.875em;"}),e.querySelectorAll("pre").forEach(t=>{t.style.cssText="background:var(--pc-surface);padding:var(--pc-space-2);border-radius:var(--pc-radius-sm);overflow-x:auto;"})}_formatTimestamp(e){return new Date(e).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}}class yi{constructor(e={}){this.element=null,this.listContainer=null,this.emptyState=null,this.expandedOverlay=null,this.entries=[],this.expandedEntryId=null,this.onExpandEntry=e.onExpandEntry||null,this.itemComponents=new Map}render(){return this.element?(this.loadHistory(),this.element):(this.element=document.createElement("div"),this.element.className="history-tab",this.element.setAttribute("role","tabpanel"),this.element.setAttribute("id","history-panel"),this.element.style.cssText="display:flex;flex-direction:column;height:100%;position:relative;overflow:hidden;",this.listContainer=document.createElement("div"),this.listContainer.className="history-list",this.listContainer.style.cssText="flex:1;overflow-y:auto;padding:var(--pc-space-4);",this.element.appendChild(this.listContainer),this.emptyState=this._createEmptyState(),this.element.appendChild(this.emptyState),this.expandedOverlay=document.createElement("div"),this.expandedOverlay.className="history-expanded-overlay",this.expandedOverlay.style.cssText="position:absolute;top:0;left:0;right:0;bottom:0;background:var(--pc-surface);display:none;flex-direction:column;z-index:10;",this.element.appendChild(this.expandedOverlay),this.element.addEventListener("keydown",e=>this._handleKeyDown(e)),this.loadHistory(),this.element)}_createEmptyState(){const e=document.createElement("div");e.className="empty-state",e.style.cssText="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:var(--pc-space-8);text-align:center;color:var(--pc-text-secondary);";const t=document.createElement("div");t.className="empty-state-icon",t.style.cssText="margin-bottom:var(--pc-space-4);opacity:0.5;",t.innerHTML=q("noActivityYet",48);const n=document.createElement("div");n.className="empty-state-title",n.style.cssText="font-size:1.125rem;font-weight:500;margin-bottom:var(--pc-space-2);color:var(--pc-on-surface);",n.textContent="No activity yet";const i=document.createElement("div");return i.className="empty-state-description",i.style.cssText="font-size:0.875rem;",i.textContent="Run Coach to get feedback on your prompt",e.appendChild(t),e.appendChild(n),e.appendChild(i),e}async loadHistory(){this.entries=await xt(),this.listContainer.innerHTML="",this.itemComponents.clear(),this.entries.length===0?(this.emptyState.style.display="flex",this.listContainer.style.display="none"):(this.emptyState.style.display="none",this.listContainer.style.display="block",this.entries.forEach(e=>{const t=new en(e,{onClick:n=>this.expandItem(n)});this.itemComponents.set(e.id,t),this.listContainer.appendChild(t.render())}))}_createHistoryItem(e){const t=document.createElement("div");t.className="history-item",t.dataset.entryId=e.id,t.style.cssText="padding:var(--pc-space-3) var(--pc-space-4);margin-bottom:var(--pc-space-2);background:var(--pc-surface-elevated);border-radius:var(--pc-radius-md);cursor:pointer;display:flex;align-items:center;gap:var(--pc-space-3);min-height:64px;transition:background-color 0.15s ease;";const n=this._createTypeIcon(e.type);t.appendChild(n);const i=this._createItemContent(e);return t.appendChild(i),t.addEventListener("click",()=>this.expandItem(e.id)),t.addEventListener("mouseenter",()=>{t.style.background="var(--pc-surface-hover)"}),t.addEventListener("mouseleave",()=>{t.style.background="var(--pc-surface-elevated)"}),t}_createTypeIcon(e){const t=document.createElement("span");t.className="history-item-icon",t.style.cssText="width:24px;height:24px;display:flex;align-items:center;justify-content:center;opacity:0.7;";const n={feedback:'<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M440-120v-80h320v-284q0-117-81.5-198.5T480-764q-117 0-198.5 81.5T200-484v244h-40q-33 0-56.5-23.5T80-320v-80q0-21 10.5-39.5T120-469l3-53q8-68 39.5-126t79-101q47.5-43 109-67T480-840q68 0 129 24t109 66.5Q766-707 797-649t40 126l3 52q19 9 29.5 27t10.5 38v92q0 20-10.5 38T840-249v49q0 33-23.5 56.5T760-120H440Zm-80-280q-17 0-28.5-11.5T320-440q0-17 11.5-28.5T360-480q17 0 28.5 11.5T400-440q0 17-11.5 28.5T360-400Zm240 0q-17 0-28.5-11.5T560-440q0-17 11.5-28.5T600-480q17 0 28.5 11.5T640-440q0 17-11.5 28.5T600-400Zm-359-62q-7-106 64-182t177-76q89 0 156.5 56.5T720-519q-91-1-167.5-49T435-698q-16 80-67.5 142.5T241-462Z"/></svg>',result:'<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M320-200v-560l440 280-440 280Zm80-280Zm0 134 210-134-210-134v268Z"/></svg>',"prompt-change":'<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>'};return t.innerHTML=n[e]||"",t}_createItemContent(e){const t=document.createElement("div");t.className="history-item-content",t.style.cssText="flex:1;min-width:0;";const n=document.createElement("div");n.className="history-item-title",n.style.cssText="font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";const i=document.createElement("div");return i.className="history-item-subtitle",i.style.cssText="font-size:0.75rem;color:var(--pc-text-secondary);margin-top:2px;",e.type==="feedback"?(n.textContent=e.description||"Coach Feedback",i.textContent=`Score: ${e.overall}% • ${this._formatTime(e.timestamp)}`):e.type==="result"?(n.textContent=`${e.provider}/${e.model}`,i.textContent=`${e.status} • ${this._formatTime(e.timestamp)}`):e.type==="prompt-change"&&(n.textContent="Prompt Updated",i.textContent=this._formatTime(e.timestamp)),t.appendChild(n),t.appendChild(i),t}_formatTime(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}addEntry(e){if(this.entries.push(e),!this.emptyState||!this.listContainer)return;this.emptyState.style.display="none",this.listContainer.style.display="block";const t=new en(e,{onClick:n=>this.expandItem(n)});this.itemComponents.set(e.id,t),this.listContainer.appendChild(t.render())}expandItem(e){const t=this.entries.find(o=>o.id===e);if(!t)return;this.expandedEntryId=e,this.expandedOverlay.style.display="flex",this.expandedOverlay.innerHTML="";const n=this._createExpandedContent(t);this.currentExpandedComponent=n;const i=new nn(t,{onClose:()=>this.collapseItem(),onNavigate:o=>this.navigateExpanded(o),contentComponent:n==null?void 0:n.render()});this.expandedOverlay.appendChild(i.render()),this.expandedOverlay.setAttribute("tabindex","-1"),this.expandedOverlay.focus(),this.onExpandEntry&&this.onExpandEntry(t)}_createExpandedContent(e){switch(e.type){case"feedback":return new mi(e);case"result":return new fi(e);case"prompt-change":return new gi(e);default:return null}}_getEntryTitle(e){return{feedback:"Coach Feedback",result:"Test Result","prompt-change":"Prompt Change"}[e.type]||"History Entry"}collapseItem(){this.expandedEntryId=null,this.expandedOverlay.style.display="none",this.expandedOverlay.innerHTML="",this.currentExpandedComponent=null}updateExpandedEntry(e,t){const n=this.entries.find(o=>o.id===e);n&&Object.assign(n,t);const i=this.itemComponents.get(e);if(i&&i.update(t),this.expandedEntryId===e&&n)if(this.currentExpandedComponent&&typeof this.currentExpandedComponent.update=="function")this.currentExpandedComponent.update(t);else{this.expandedOverlay.innerHTML="";const o=this._createExpandedContent(n);this.currentExpandedComponent=o;const a=new nn(n,{onClose:()=>this.collapseItem(),onNavigate:r=>this.navigateExpanded(r),contentComponent:o==null?void 0:o.render()});this.expandedOverlay.appendChild(a.render())}}_handleKeyDown(e){this.expandedEntryId&&(e.key==="Escape"?(e.preventDefault(),this.collapseItem()):e.key==="ArrowDown"?(e.preventDefault(),this.navigateExpanded(1)):e.key==="ArrowUp"&&(e.preventDefault(),this.navigateExpanded(-1)))}navigateExpanded(e){if(!this.expandedEntryId)return;const t=this.entries.findIndex(i=>i.id===this.expandedEntryId);if(t===-1)return;const n=t+e;n<0||n>=this.entries.length||this.expandItem(this.entries[n].id)}clearAll(){this.entries=[],this.expandedEntryId=null,this.itemComponents.clear(),this.listContainer&&(this.listContainer.innerHTML="",this.listContainer.style.display="none"),this.emptyState&&(this.emptyState.style.display="flex"),this.expandedOverlay&&(this.expandedOverlay.style.display="none",this.expandedOverlay.innerHTML="")}scrollToLast(){this.listContainer&&this.listContainer.lastElementChild&&requestAnimationFrame(()=>{this.listContainer.lastElementChild.scrollIntoView({behavior:"smooth",block:"start"})})}expandLastFeedback(){for(let e=this.entries.length-1;e>=0;e--)if(this.entries[e].type==="feedback"){this.expandItem(this.entries[e].id);return}}getExpandedEntryId(){return this.expandedEntryId}}class vi{constructor(){this.element=null,this.dropZone=null,this.fileInput=null,this.attachmentsList=null,this.emptyState=null,this.clearAllBtn=null,this.attachments=[],this.isDragging=!1,this.sizeWarning=null}render(){if(this.element)return this.loadAttachments(),this.element;this.element=document.createElement("div"),this.element.className="attachments-tab",this.element.setAttribute("role","tabpanel"),this.element.setAttribute("id","attachments-panel"),this.element.style.cssText=`
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: var(--pc-space-4);
      gap: var(--pc-space-4);
    `;const e=this.createHeader();return this.element.appendChild(e),this.dropZone=this.createDropZone(),this.element.appendChild(this.dropZone),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".txt,.md,.json,text/plain,text/markdown,application/json",this.fileInput.multiple=!0,this.fileInput.style.display="none",this.fileInput.addEventListener("change",t=>this.handleFileSelect(t)),this.element.appendChild(this.fileInput),this.sizeWarning=document.createElement("div"),this.sizeWarning.className="attachments-size-warning",this.sizeWarning.style.cssText=`
      display: none;
      padding: var(--pc-space-2) var(--pc-space-3);
      background: #fff3e0;
      color: #e65100;
      border-radius: var(--pc-radius-sm);
      font-size: 0.8125rem;
      line-height: 1.4;
    `,this.element.appendChild(this.sizeWarning),this.attachmentsList=document.createElement("div"),this.attachmentsList.className="attachments-list",this.attachmentsList.style.cssText=`
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: var(--pc-space-2);
    `,this.element.appendChild(this.attachmentsList),this.emptyState=this.createEmptyState(),this.attachmentsList.appendChild(this.emptyState),this.loadAttachments(),this.element}createHeader(){const e=document.createElement("div");e.className="attachments-header",e.style.cssText=`
      display: flex;
      justify-content: space-between;
      align-items: center;
    `;const t=document.createElement("h2");return t.textContent="Attachments",t.style.cssText=`
      font-size: 1.125rem;
      font-weight: 500;
      margin: 0;
      color: var(--pc-on-surface);
    `,e.appendChild(t),this.clearAllBtn=document.createElement("button"),this.clearAllBtn.className="btn btn-text",this.clearAllBtn.innerHTML=`${q("clearAll",20)}<span>Clear All</span>`,this.clearAllBtn.style.cssText="display: none; align-items: center; gap: var(--pc-space-2);",this.clearAllBtn.addEventListener("click",()=>this.handleClearAll()),e.appendChild(this.clearAllBtn),e}createDropZone(){const e=document.createElement("div");e.className="drop-zone",e.style.cssText=`
      border: 2px dashed var(--pc-outline);
      border-radius: var(--pc-radius-md);
      padding: var(--pc-space-6);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: var(--pc-surface);
    `;const t=document.createElement("div");t.className="drop-zone-content";const n=ye(Tt);return t.innerHTML=`
      <div style="color: var(--pc-on-surface-variant); margin-bottom: var(--pc-space-2);">
        ${q("upload",32)}
      </div>
      <div style="color: var(--pc-on-surface); font-weight: 500; margin-bottom: var(--pc-space-1);">
        Drop files here
      </div>
      <div style="color: var(--pc-on-surface-variant); font-size: 0.875rem;">
        or tap to browse (.txt, .md, .json)<br/>
        Max size ${n} per file
      </div>
    `,e.appendChild(t),e.addEventListener("click",()=>this.fileInput.click()),e.addEventListener("dragenter",i=>this.handleDragEnter(i)),e.addEventListener("dragover",i=>this.handleDragOver(i)),e.addEventListener("dragleave",i=>this.handleDragLeave(i)),e.addEventListener("drop",i=>this.handleDrop(i)),e}createEmptyState(){const e=document.createElement("div");return e.className="empty-state",e.style.cssText=`
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--pc-on-surface-variant);
      padding: var(--pc-space-8);
    `,e.innerHTML=`
      <div style="opacity: 0.5; margin-bottom: var(--pc-space-4);">
        ${q("noAttachmentsYet",48)}
      </div>
      <div style="font-weight: 500; margin-bottom: var(--pc-space-1);">No attachments yet</div>
      <div style="font-size: 0.875rem;">Files you attach will appear here</div>
    `,e}handleDragEnter(e){e.preventDefault(),e.stopPropagation(),this.isDragging=!0,this.dropZone.style.borderColor="var(--pc-primary)",this.dropZone.style.backgroundColor="var(--pc-primary-container)"}handleDragOver(e){e.preventDefault(),e.stopPropagation()}handleDragLeave(e){e.preventDefault(),e.stopPropagation(),this.dropZone.contains(e.relatedTarget)||(this.isDragging=!1,this.dropZone.style.borderColor="var(--pc-outline)",this.dropZone.style.backgroundColor="var(--pc-surface)")}async handleDrop(e){e.preventDefault(),e.stopPropagation(),this.isDragging=!1,this.dropZone.style.borderColor="var(--pc-outline)",this.dropZone.style.backgroundColor="var(--pc-surface)";const t=Array.from(e.dataTransfer.files);await this.processFiles(t)}async handleFileSelect(e){const t=Array.from(e.target.files);await this.processFiles(t),e.target.value=""}async processFiles(e){let t=0;for(const n of e)try{await vs(n),t++}catch(i){i instanceof Re?v(i.message,"error"):(v(`Failed to add ${n.name}`,"error"),console.error("Attachment error:",i))}t>0&&(v(`Added ${t} file${t>1?"s":""}`,"success"),await this.loadAttachments())}async loadAttachments(){try{this.attachments=await ue(),this.attachmentsList&&this.emptyState&&this.clearAllBtn&&this.renderAttachmentsList()}catch(e){console.error("Failed to load attachments:",e),v("Failed to load attachments","error")}}renderAttachmentsList(){this.attachmentsList.querySelectorAll(".attachment-item").forEach(n=>n.remove());const t=this.attachments.length>0;this.emptyState.style.display=t?"none":"flex",this.clearAllBtn.style.display=t?"flex":"none";for(const n of this.attachments){const i=this.createAttachmentItem(n);this.attachmentsList.insertBefore(i,this.emptyState)}this._updateSizeWarning()}_updateSizeWarning(){if(!this.sizeWarning||this.attachments.length===0){this.sizeWarning&&(this.sizeWarning.style.display="none");return}const e=this.attachments.reduce((d,p)=>{var h;return d+(((h=p.content)==null?void 0:h.length)||p.size)},0),t=W(),n=t.provider||"openai",i=t.testModel||"gpt-4.1-mini",o=yn(n,i),a=as(n),r=Math.min(o||1/0,a||1/0);if(!r||r===1/0){this.sizeWarning.style.display="none";return}const l=vn(r,8192),c=e/l;c>1?(this.sizeWarning.style.display="block",this.sizeWarning.style.background="#ffebee",this.sizeWarning.style.color="#c62828",this.sizeWarning.textContent=`Combined attachments (${ye(e)}) exceed the context limit of your smallest configured model. Content will be truncated when sent.`):c>.8?(this.sizeWarning.style.display="block",this.sizeWarning.style.background="#fff3e0",this.sizeWarning.style.color="#e65100",this.sizeWarning.textContent=`Combined attachments use ${Math.round(c*100)}% of the available context for your smallest configured model. Consider removing files to avoid truncation.`):this.sizeWarning.style.display="none"}createAttachmentItem(e){const t=document.createElement("div");t.className="attachment-item",t.dataset.id=e.id,t.style.cssText=`
      display: flex;
      align-items: center;
      gap: var(--pc-space-3);
      padding: var(--pc-space-3);
      background-color: var(--pc-surface-container);
      border-radius: var(--pc-radius-sm);
      border: 1px solid var(--pc-outline-variant);
    `;const n=document.createElement("div");n.innerHTML=`
      <svg width="24" height="24" viewBox="0 -960 960 960" fill="currentColor" style="color: var(--pc-primary);">
        <path d="M320-440h320v-80H320v80Zm0 120h320v-80H320v80Zm0 120h200v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/>
      </svg>
    `,t.appendChild(n);const i=document.createElement("div");i.style.cssText="flex: 1; min-width: 0;",i.innerHTML=`
      <div style="font-weight: 500; color: var(--pc-on-surface); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
        ${this.escapeHtml(e.filename)}
      </div>
      <div style="font-size: 0.75rem; color: var(--pc-on-surface-variant);">
        ${ye(e.size)}
      </div>
    `,t.appendChild(i);const o=document.createElement("button");return o.className="btn btn-icon",o.title="Remove attachment",o.innerHTML='<svg width="20" height="20" viewBox="0 -960 960 960" fill="currentColor"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>',o.addEventListener("click",()=>this.handleDelete(e.id)),t.appendChild(o),t}async handleDelete(e){try{await bs(e),await this.loadAttachments(),v("Attachment removed","success")}catch(t){console.error("Failed to delete attachment:",t),v("Failed to remove attachment","error")}}async handleClearAll(){if(!(this.attachments.length===0||!confirm(`Remove all ${this.attachments.length} attachment${this.attachments.length>1?"s":""}?`)))try{const t=await Be();await this.loadAttachments(),v(`Removed ${t} attachment${t>1?"s":""}`,"success")}catch(t){console.error("Failed to clear attachments:",t),v("Failed to clear attachments","error")}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async clearAll(){try{await Be(),this.attachmentsList&&this.emptyState&&this.clearAllBtn?await this.loadAttachments():this.attachments=[]}catch(e){console.error("Failed to clear attachments:",e)}}}class sn{constructor(e={}){this.icon=e.icon||"",this.label=e.label||null,this.size=e.size||"default",this.onClick=e.onClick||null,this.ariaLabel=e.ariaLabel||"",this.id=e.id||null,this.element=null,this.disabled=!1,this.loading=!1}getSizeDimensions(){return this.size==="mini"?{diameter:40,iconSize:20,touchTarget:44}:{diameter:56,iconSize:24,touchTarget:56}}_injectStyles(){if(document.getElementById("fab-component-styles"))return;const e=document.createElement("style");e.id="fab-component-styles",e.textContent=`
      @keyframes fab-spinner-rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .fab-button {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }
      
      .fab-button:hover:not(:disabled) {
        transform: scale(1.05);
      }
      
      .fab-button:active:not(:disabled) {
        transform: scale(0.95);
      }
      
      .fab-button:disabled {
        opacity: 0.38;
        cursor: not-allowed;
      }
      
      .fab-button:focus-visible {
        outline: 2px solid var(--pc-primary);
        outline-offset: 2px;
      }
      
      .fab-spinner {
        position: absolute;
        border-radius: 50%;
        border: 2px solid var(--pc-outline-variant);
        border-top-color: var(--pc-on-primary);
        animation: fab-spinner-rotate 0.8s linear infinite;
        pointer-events: none;
      }
      
      .fab-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s ease;
      }
      
      .fab-icon.loading {
        opacity: 0.5;
      }
    `,document.head.appendChild(e)}render(){this._injectStyles();const e=this.getSizeDimensions();this.element=document.createElement("button"),this.element.className="fab-button",this.element.setAttribute("role","button"),this.element.setAttribute("aria-label",this.ariaLabel),this.element.setAttribute("tabindex","0"),this.id&&(this.element.id=this.id);const t="var(--pc-primary)",n="var(--pc-on-primary)";this.element.style.cssText=`
      width: ${e.diameter}px;
      height: ${e.diameter}px;
      min-width: ${e.touchTarget}px;
      min-height: ${e.touchTarget}px;
      background-color: ${t};
      color: ${n};
      box-shadow: var(--pc-shadow-md, 0 3px 5px -1px rgba(0,0,0,.2), 0 6px 10px 0 rgba(0,0,0,.14), 0 1px 18px 0 rgba(0,0,0,.12));
    `;const i=document.createElement("span");return i.className="fab-icon",i.innerHTML=`
      <svg width="${e.iconSize}" height="${e.iconSize}" viewBox="0 -960 960 960" fill="currentColor">
        ${this.icon}
      </svg>
    `,this.element.appendChild(i),this.onClick&&this.element.addEventListener("click",o=>{!this.disabled&&!this.loading&&this.onClick(o)}),this.element.addEventListener("keydown",o=>{(o.key==="Enter"||o.key===" ")&&!this.disabled&&!this.loading&&(o.preventDefault(),this.element.click())}),this.element}setDisabled(e){this.disabled=e,this.element&&(this.element.disabled=e,this.element.setAttribute("aria-disabled",e.toString()))}setLoading(e){if(this.loading=e,!this.element)return;const t=this.element.querySelector(".fab-icon"),n=this.element.querySelector(".fab-spinner");if(e){if(!n){const i=this.getSizeDimensions(),o=document.createElement("div");o.className="fab-spinner",o.style.cssText=`
          width: ${i.diameter-8}px;
          height: ${i.diameter-8}px;
        `,this.element.appendChild(o)}t&&t.classList.add("loading"),this.element.disabled=!0}else n&&n.remove(),t&&t.classList.remove("loading"),this.element.disabled=this.disabled}getElement(){return this.element}setIcon(e){if(this.icon=e,this.element){const t=this.element.querySelector(".fab-icon");if(t){const n=this.getSizeDimensions();t.innerHTML=`
          <svg width="${n.iconSize}" height="${n.iconSize}" viewBox="0 0 24 24" fill="currentColor">
            ${this.icon}
          </svg>
        `}}}}class bi extends We{constructor(e={}){super({title:"Session History",...e}),this.onRestoreCallback=e.onRestore||null,this.sessions=[],this.searchQuery="",this.starredOnly=!1,this.searchInput=null,this.listContainer=null,this.emptyState=null,this.filterAllBtn=null,this.filterStarredBtn=null,this.searchTimeout=null}render(){super.render(),this.element.style.maxWidth="90vw",this.element.style.width="400px",this.element.style.maxHeight="85vh";const e=document.createElement("div");e.style.cssText=`
      display: flex;
      flex-direction: column;
      gap: var(--pc-space-3);
      min-height: 300px;
      max-height: 70vh;
    `,this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search sessions...",this.searchInput.className="input",this.searchInput.style.cssText="width: 100%;",this.searchInput.addEventListener("input",n=>this.handleSearch(n.target.value)),e.appendChild(this.searchInput);const t=document.createElement("div");return t.style.cssText=`
      display: flex;
      gap: var(--pc-space-2);
    `,this.filterAllBtn=document.createElement("button"),this.filterAllBtn.className="btn btn-filled",this.filterAllBtn.textContent="All",this.filterAllBtn.style.cssText="flex: 1; min-height: 36px;",this.filterAllBtn.addEventListener("click",()=>this.setFilter(!1)),this.filterStarredBtn=document.createElement("button"),this.filterStarredBtn.className="btn btn-outlined",this.filterStarredBtn.textContent="★ Starred",this.filterStarredBtn.style.cssText="flex: 1; min-height: 36px;",this.filterStarredBtn.addEventListener("click",()=>this.setFilter(!0)),t.appendChild(this.filterAllBtn),t.appendChild(this.filterStarredBtn),e.appendChild(t),this.listContainer=document.createElement("div"),this.listContainer.className="history-list",this.listContainer.style.cssText=`
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: var(--pc-space-2);
    `,e.appendChild(this.listContainer),this.emptyState=document.createElement("div"),this.emptyState.className="empty-state",this.emptyState.style.cssText=`
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--pc-space-6);
      text-align: center;
      color: var(--pc-on-surface-variant);
    `,this.emptyState.innerHTML=`
      <div style="opacity: 0.5; margin-bottom: var(--pc-space-3);">
        ${q("noSessionsFound",48)}
      </div>
      <div style="font-weight: 500; margin-bottom: var(--pc-space-1);">No sessions found</div>
      <div style="font-size: 0.875rem;">Start coaching to create your first session.</div>
    `,e.appendChild(this.emptyState),this.setContent(e),this.addAction("Close",()=>this.close(),"text"),this.overlay}async show(){super.show(),await this.loadSessions(),this.searchInput&&this.searchInput.focus()}async loadSessions(){try{this.sessions=await Ns({starredOnly:this.starredOnly,searchQuery:this.searchQuery}),this.renderSessionList()}catch(e){console.error("Failed to load sessions:",e),v("Failed to load session history","error")}}renderSessionList(){if(this.listContainer.innerHTML="",this.sessions.length===0){this.listContainer.style.display="none",this.emptyState.style.display="flex";const e=this.emptyState.querySelector("div:last-child");this.searchQuery?e.textContent="No sessions match your search.":this.starredOnly?e.textContent="No starred sessions yet.":e.textContent="Start coaching to create your first session.";return}this.listContainer.style.display="flex",this.emptyState.style.display="none",this.sessions.forEach(e=>{const t=this.createSessionItem(e);this.listContainer.appendChild(t)})}createSessionItem(e){const t=e.isCurrent===!0,n=document.createElement("div");if(n.className="history-item",n.style.cssText=`
      display: flex;
      align-items: flex-start;
      gap: var(--pc-space-3);
      padding: var(--pc-space-3);
      background: var(--pc-surface-container);
      border-radius: var(--pc-radius-sm);
      cursor: ${t?"default":"pointer"};
      transition: background-color var(--pc-duration-fast) var(--pc-easing);
      ${t?"border-left: 3px solid var(--pc-primary);":""}
    `,!t){const l=document.createElement("button");l.className="btn-icon",l.setAttribute("aria-label",e.starred?"Unstar session":"Star session"),l.style.cssText=`
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--pc-space-1);
        color: ${e.starred?"#F59E0B":"var(--pc-on-surface-variant)"};
        flex-shrink: 0;
      `,l.innerHTML=e.starred?'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>':'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>',l.addEventListener("click",async c=>{c.stopPropagation(),await this.handleToggleStar(e.id,l)}),n.appendChild(l)}const i=document.createElement("div");i.style.cssText="flex: 1; min-width: 0;";const o=document.createElement("div");o.style.cssText=`
      font-size: 0.875rem;
      color: var(--pc-on-surface);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: var(--pc-space-1);
    `,o.textContent=e.previewText,i.appendChild(o);const a=document.createElement("div");a.style.cssText=`
      font-size: 0.75rem;
      color: var(--pc-on-surface-variant);
      display: flex;
      flex-wrap: wrap;
      gap: var(--pc-space-2);
    `;const r=[];if(t)r.push("Current session");else{const l=new Date(e.archivedAt),c=l.toLocaleDateString(void 0,{month:"short",day:"numeric",year:l.getFullYear()!==new Date().getFullYear()?"numeric":void 0});r.push(c)}if(e.feedbackCount>0&&r.push(`${e.feedbackCount} review${e.feedbackCount!==1?"s":""}`),e.resultCount>0&&r.push(`${e.resultCount} test${e.resultCount!==1?"s":""}`),a.textContent=r.join(" • "),i.appendChild(a),n.appendChild(i),e.finalScore!==null&&e.finalScore!==void 0){const l=document.createElement("div"),c=e.finalScore>=80?"var(--pc-primary)":e.finalScore>=60?"#F59E0B":"#EF4444";l.style.cssText=`
        min-width: 32px;
        height: 32px;
        border-radius: 50%;
        background: ${c};
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        flex-shrink: 0;
      `,l.textContent=e.finalScore,n.appendChild(l)}if(!t){const l=document.createElement("div");l.style.cssText=`
        display: flex;
        gap: var(--pc-space-1);
        flex-shrink: 0;
      `;const c=document.createElement("button");c.className="btn btn-text",c.textContent="Restore",c.style.cssText="min-height: 32px; padding: 0 var(--pc-space-2); font-size: 0.75rem;",c.addEventListener("click",async p=>{p.stopPropagation(),await this.handleRestore(e.id)}),l.appendChild(c);const d=document.createElement("button");d.className="btn-icon",d.setAttribute("aria-label","Delete session"),d.style.cssText=`
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--pc-space-1);
        color: var(--pc-on-surface-variant);
        min-width: 32px;
        min-height: 32px;
      `,d.innerHTML=q("deleteSession",18),d.addEventListener("click",async p=>{p.stopPropagation(),await this.handleDelete(e.id)}),l.appendChild(d),n.appendChild(l),n.addEventListener("click",()=>this.handleRestore(e.id))}return t||(n.addEventListener("mouseenter",()=>{n.style.backgroundColor="var(--pc-surface-variant)"}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor="var(--pc-surface-container)"})),n}handleSearch(e){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.searchQuery=e,this.loadSessions()},300)}setFilter(e){this.starredOnly=e,e?(this.filterAllBtn.className="btn btn-outlined",this.filterStarredBtn.className="btn btn-filled"):(this.filterAllBtn.className="btn btn-filled",this.filterStarredBtn.className="btn btn-outlined"),this.loadSessions()}async handleToggleStar(e,t){try{const n=await Is(e);t.style.color=n?"#F59E0B":"var(--pc-on-surface-variant)",t.innerHTML=n?'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>':'<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22 9.24l-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z"/></svg>',t.setAttribute("aria-label",n?"Unstar session":"Star session"),this.starredOnly&&!n&&await this.loadSessions()}catch(n){console.error("Failed to toggle star:",n),v("Failed to update session","error")}}async handleRestore(e){try{await Ls(e),v("Session restored"),this.close(),this.onRestoreCallback&&this.onRestoreCallback(e)}catch(t){console.error("Failed to restore session:",t),v("Failed to restore session","error")}}async handleDelete(e){if(await wn("Delete Session?","This session will be permanently deleted. This action cannot be undone.",{confirmLabel:"Delete",destructive:!0}))try{await _s(e,{skipConfirmation:!0}),v("Session deleted"),await this.loadSessions()}catch(n){console.error("Failed to delete session:",n),v("Failed to delete session","error")}}}class xi{constructor(){this.element=null,this.contentArea=null,this.currentTab=Ze().currentTab||"prompt",this.tabs={},this.menuPanel=null,this.feedbackPanel=null,this.ribbon=null,this.fabContainer=null,this.coachFab=null,this.testFab=null}render(){this.element=document.createElement("div"),this.element.className="app-shell",this.element.style.cssText=`
      display: flex;
      flex-direction: column;
      height: 100%;
    `,this.ribbon=new Yn({onMenuClick:()=>this.toggleMenu(),onScoreClick:()=>this.handleScoreClick()}),this.element.appendChild(this.ribbon.render()),this.contentArea=document.createElement("main"),this.contentArea.id="main-content",this.contentArea.className="app-content",this.contentArea.setAttribute("tabindex","-1"),this.contentArea.style.cssText=`
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    `,this.element.appendChild(this.contentArea),this.createFabContainer(),this.element.appendChild(this.fabContainer),this.tabBar=new Xn({currentTab:this.currentTab,onTabChange:t=>this.switchTab(t)}),this.element.appendChild(this.tabBar.render()),this.menuPanel=new qs({onClose:()=>this.closeMenu(),onNewSession:()=>this.handleNewSession(),onShowHistory:()=>this.handleShowHistory(),onCopyPrompt:()=>this.handleCopyPrompt(),onTogglePreview:t=>this.handleTogglePreview(t)}),this.element.appendChild(this.menuPanel.render()),Ts(()=>this.handleSessionClear()),ks(t=>this.handleSessionRestore(t)),this.feedbackPanel=new ri({onClose:()=>{},onPin:t=>this.handleFeedbackPinChange(t),onSkipContinue:()=>this.handleSkipContinue(),onReintroduceSkipped:t=>this.handleReintroduceSkipped(t)});const e=this.feedbackPanel.render();return this.element.appendChild(this.feedbackPanel.getBackdrop()),this.element.appendChild(e),this.initTabs(),this.showTab(this.currentTab),this.element}createFabContainer(){this.fabContainer=document.createElement("div"),this.fabContainer.className="fab-container",this.fabContainer.style.cssText=`
      position: fixed;
      bottom: 80px;
      right: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      z-index: var(--pc-z-fab, 100);
      pointer-events: none;
    `,this.testFab=new sn({icon:`<path d="${Ht("test")}"/>`,size:"mini",ariaLabel:"Test prompt",id:"test-fab",onClick:()=>this.handleTestFabClick()});const e=this.testFab.render();e.style.pointerEvents="auto",this.fabContainer.appendChild(e),this.coachFab=new sn({icon:`<path d="${Ht("coach")}"/>`,size:"default",ariaLabel:"Coach prompt",id:"coach-fab",onClick:()=>this.handleCoachFabClick()});const t=this.coachFab.render();t.style.pointerEvents="auto",this.fabContainer.appendChild(t)}handleCoachFabClick(){if(!this.tabs.prompt||!this.tabs.prompt.promptText.trim()){v("Please enter a prompt first");return}this.coachFab.setLoading(!0),this.tabs.prompt.runCoach().finally(()=>{this.coachFab.setLoading(!1)})}handleTestFabClick(){if(!this.tabs.prompt||!this.tabs.prompt.promptText.trim()){v("Please enter a prompt first");return}this.testFab.setLoading(!0),this.tabs.prompt.runTest().finally(()=>{this.testFab.setLoading(!1)})}updateFabVisibility(){this.fabContainer&&(this.fabContainer.style.display=this.currentTab==="prompt"?"flex":"none")}initTabs(){this.tabs={prompt:new li,activity:new yi,attachments:new vi},this.tabs.prompt.setHistoryTab(this.tabs.activity),this.tabs.prompt.setOnSwitchToHistory(()=>this.switchToActivityWithExpand()),this.tabs.prompt.onShowFeedbackStreaming=e=>this.showFeedbackStreaming(e),this.tabs.prompt.onFeedbackStreamChunk=e=>this.appendFeedbackChunk(e),this.tabs.prompt.onFinalizeFeedbackStreaming=e=>this.finalizeFeedbackStreaming(e),this.tabs.prompt.onHideFeedbackPanel=()=>this.hideFeedbackPanel(),this.tabs.prompt.setOnShowFeedback(e=>this.showFeedback(e))}switchToActivityWithExpand(){this.switchTab("activity"),requestAnimationFrame(()=>{if(this.tabs.activity&&this.tabs.activity.entries.length>0){const e=this.tabs.activity.entries[this.tabs.activity.entries.length-1];this.tabs.activity.expandItem(e.id)}})}switchTab(e){this.currentTab=e,ne("currentTab",e),this.showTab(e),this.tabBar&&this.tabBar.setActiveTab(e),this.updateFabVisibility()}showTab(e){this.contentArea.innerHTML="";const t=this.tabs[e];t&&this.contentArea.appendChild(t.render())}toggleMenu(){this.menuPanel&&this.menuPanel.toggle()}closeMenu(){this.menuPanel&&this.menuPanel.hide()}showFeedback(e){this.feedbackPanel&&this.feedbackPanel.show(e),this.ribbon&&e.overall!==void 0&&this.ribbon.updateScore(e.overall,e.description)}showFeedbackStreaming(e){this.feedbackPanel&&this.feedbackPanel.showStreaming(e)}appendFeedbackChunk(e){this.feedbackPanel&&this.feedbackPanel.appendStreamingChunk(e)}finalizeFeedbackStreaming(e){this.feedbackPanel&&this.feedbackPanel.finalizeStreaming(e),this.ribbon&&e.overall!==void 0&&this.ribbon.updateScore(e.overall,e.description)}hideFeedbackPanel(){this.feedbackPanel&&this.feedbackPanel.hide(!0)}handleFeedbackPinChange(e){if(e){const t=this.feedbackPanel.element;t&&this.contentArea&&this.element.insertBefore(t,this.contentArea)}else{const t=this.feedbackPanel.element;t&&this.element.appendChild(t)}}handleSkipContinue(){this.tabs.prompt&&this.tabs.prompt.runCoach()}async handleReintroduceSkipped(e={}){const t=e.skippedPrinciples||qe().skippedPrinciples||[];if(!t.length){v("No skipped items to reintroduce"),this.feedbackPanel&&this.feedbackPanel.setLoading(!1);return}const n=await this.selectReintroduceCandidate(t,e.scores||[]);if(!n){v("Unable to reintroduce skipped items"),this.feedbackPanel&&this.feedbackPanel.setLoading(!1);return}Tn(n),this.tabs.prompt&&this.tabs.prompt.runCoach()}async selectReintroduceCandidate(e,t){var a;const n=new Map(t.map(r=>[r.principle||r.principleId,r]));let i={};try{const r=await Y(()=>import("./principles-Dvy7Q6Uu.js"),[],import.meta.url);i=Object.fromEntries(r.default.principles.map(l=>[l.id,l.weight]))}catch(r){console.warn("AppShell: Failed to load principles for reintroduce selection",r)}const o=e.map(r=>{const l=n.get(r);return{id:r,score:typeof(l==null?void 0:l.score)=="number"?l.score:Number.MAX_SAFE_INTEGER,weight:i[r]??0}});return o.sort((r,l)=>r.score!==l.score?r.score-l.score:r.weight!==l.weight?l.weight-r.weight:r.id.localeCompare(l.id)),((a=o[0])==null?void 0:a.id)||null}handleScoreClick(){this.switchTab("activity");const e=this.tabs.activity;if(!e)return;const t=()=>e.entries&&e.entries.length>0?(e.expandLastFeedback(),!0):!1;t()||typeof e.loadHistory=="function"&&e.loadHistory().then(()=>{t()}).catch(n=>{console.warn("AppShell: Failed to load activity history for score click",n)})}handleNewSession(){this.switchTab("prompt")}handleCopyPrompt(){this.tabs.prompt&&this.tabs.prompt.copyPrompt()}handleTogglePreview(e){this.tabs.prompt&&this.tabs.prompt.setMode(e)}handleShowHistory(){new bi({onRestore:()=>{}}).show()}handleSessionClear(){this.tabs.prompt&&this.tabs.prompt.resetSession(),this.tabs.activity&&this.tabs.activity.clearAll(),this.tabs.attachments&&this.tabs.attachments.clearAll(),this.ribbon&&this.ribbon.updateScore(null,null),vt(),this.feedbackPanel&&this.feedbackPanel.hide(),this.switchTab("prompt")}handleSessionRestore(e){this.tabs.prompt&&e.prompt&&(this.tabs.prompt.promptText=e.prompt,this.tabs.prompt.textarea&&(this.tabs.prompt.textarea.value=e.prompt)),this.tabs.activity&&this.tabs.activity.loadHistory(),this.tabs.attachments&&this.tabs.attachments.loadAttachments(),vt(),this.ribbon&&e.finalScore!==void 0&&this.ribbon.updateScore(e.finalScore,e.finalDescription),this.switchTab("prompt")}}class wi{constructor(e={}){this.onDismiss=e.onDismiss||null,this.element=null}render(){this.element=document.createElement("div"),this.element.className="first-run-overlay",this.element.setAttribute("role","dialog"),this.element.setAttribute("aria-modal","true"),this.element.setAttribute("aria-labelledby","first-run-title");const e=document.createElement("h1");e.id="first-run-title",e.className="first-run-title",e.textContent="Welcome to Prompt Coach";const t=document.createElement("p");t.className="first-run-description",t.textContent="Improve your prompting skills with AI-powered coaching. Get feedback on your prompts and learn best practices.";const n=document.createElement("button");return n.className="first-run-btn",n.textContent="Get Started",n.addEventListener("click",()=>this.dismiss()),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(n),this.element}show(){this.element||this.render(),document.body.appendChild(this.element);const e=this.element.querySelector("button");e&&e.focus()}dismiss(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.onDismiss&&this.onDismiss()}}class Ci extends We{constructor(){super({title:"Configure API Key"}),this.inputs={}}createContent(){const e=document.createElement("div"),t=document.createElement("p");t.className="text-body",t.style.cssText="color: var(--pc-on-surface-variant); margin-bottom: var(--pc-space-4);",t.textContent="API keys are stored locally on your device. You can add more providers later in Settings.",e.appendChild(t);const n=document.createElement("div");n.style.cssText="margin-bottom: var(--pc-space-4);";const i=document.createElement("label");i.className="text-label",i.style.cssText="display: block; margin-bottom: var(--pc-space-2); color: var(--pc-on-surface-variant);",i.textContent="Provider";const o=document.createElement("select");o.className="input",o.innerHTML=`
      <option value="openai">OpenAI</option>
      <option value="anthropic">Anthropic</option>
      <option value="google">Google</option>
      <option value="x">xAI</option>
    `,this.providerSelect=o,n.appendChild(i),n.appendChild(o),e.appendChild(n);const a=document.createElement("div");a.style.cssText="margin-bottom: var(--pc-space-4);";const r=document.createElement("label");r.className="text-label",r.style.cssText="display: block; margin-bottom: var(--pc-space-2); color: var(--pc-on-surface-variant);",r.textContent="API Key";const l=document.createElement("input");return l.type="password",l.className="input",l.placeholder="Enter your API key",l.autocomplete="off",this.keyInput=l,a.appendChild(r),a.appendChild(l),e.appendChild(a),e}show(){this.render(),this.setContent(this.createContent()),this.addAction("Skip",()=>this.close(),"text"),this.addAction("Save",()=>this.save(),"filled"),super.show(),setTimeout(()=>{this.keyInput.focus()},100)}save(){const e=this.providerSelect.value,t=this.keyInput.value.trim();if(!t){v("Please enter an API key");return}pn("apiKeys",{[e]:t}),v("API key saved"),this.close()}}function Ti(){if(typeof window>"u"||typeof document>"u"||window.__promptCoachViewportInit)return;window.__promptCoachViewportInit=!0;const s=document.documentElement,e=()=>{let n;if(window.visualViewport&&typeof window.visualViewport.height=="number"?n=window.visualViewport.height:n=window.innerHeight||0,!n)return;const i=n*.01;s.style.setProperty("--pc-vh",`${i}px`)};e();const t=()=>e();window.addEventListener("resize",t),window.addEventListener("orientationchange",t),window.visualViewport&&typeof window.visualViewport.addEventListener=="function"&&window.visualViewport.addEventListener("resize",t)}Ti();function ki(){const s=document.getElementById("loader");if(!s)return;s.style.pointerEvents="none";const e=2e3,t=2e3,n=performance.now(),i=h=>h===1?1:1-Math.pow(2,-10*h),o=Math.random()*Math.PI*2,a=Math.random()*Math.PI*2,r=.25+Math.random()*.125,l=.1875+Math.random()*.125,c=60,d=48;function p(h){const u=h-n,m=Math.min(u/e,1),f=Math.min(u/t,1),b=u/2e3*Math.PI*2,y=50+Math.sin(b*r+o)*c*(1-f),g=50+Math.cos(b*l+a)*d*(1-f),x=1-f,C=20*(1-i(m));s.style.backdropFilter=`blur(${C}px)`,s.style.webkitBackdropFilter=`blur(${C}px)`,s.style.background=`radial-gradient(
      circle at ${y}% ${g}%,
      transparent 0%,
      rgba(28, 27, 31, ${x*.1}) 15%,
      rgba(28, 27, 31, ${x*.4}) 40%,
      rgba(28, 27, 31, ${x*.7}) 70%,
      rgba(28, 27, 31, ${x}) 100%
    )`,f<1?requestAnimationFrame(p):s.remove()}requestAnimationFrame(p)}async function on(){try{Un(),await M(),await F();const s=Ze(),e=document.getElementById("app"),t=new xi;e.appendChild(t.render()),ki(),s.firstRunCompleted||new wi({onDismiss:()=>{ne("firstRunCompleted",!0),at()||new Ci().show()}}).show(),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").catch(()=>{})}),ls(),window.canInstallPWA=Ct,Ei()}catch(s){console.error("Failed to initialize app:",s),document.getElementById("app").innerHTML=`
      <div class="empty-state" style="height: calc(var(--pc-vh, 1vh) * 100);">
        <div class="empty-state-icon">⚠️</div>
        <div class="empty-state-title">Something went wrong</div>
        <div class="empty-state-description">Please refresh the page to try again.</div>
      </div>
    `}}function Ei(){const s=document.createElement("div");s.id="offline-banner",s.style.cssText=`
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #EF4444;
    color: white;
    padding: 8px 16px;
    text-align: center;
    font-size: 0.875rem;
    font-weight: 500;
    z-index: 10000;
    transform: translateY(-100%);
    transition: transform 0.3s ease;
  `,s.innerHTML=`
    <span style="margin-right: 8px;">⚠️</span>
    You're offline. Some features may not work.
  `,document.body.appendChild(s);function e(){navigator.onLine?s.style.transform="translateY(-100%)":s.style.transform="translateY(0)"}window.addEventListener("online",e),window.addEventListener("offline",e),e()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",on):on();
